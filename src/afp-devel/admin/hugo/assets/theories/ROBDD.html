<div id="Bool_Func">
<div class="head">
<h1>Theory Bool_Func</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Boolean functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Bool_Func
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The end result of our implementation is verified against these functions:
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> boolfunc <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹if-then-else on boolean functions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_ite</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">l</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹if-then-else is interesting because we can, together with constant true and false, represent all binary boolean functions using maximally two applications of it.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_True</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_False</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A quick demonstration:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_and</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> bf_ite <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> bf_False"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_and <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">as</span> <span class="main">⟷</span> <span class="free">a</span> <span class="free">as</span> <span class="main">∧</span> <span class="free">b</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_and_def  bf_ite_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_not</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> bf_ite <span class="free"><span class="bound"><span class="entity">b</span></span></span> bf_False bf_True"</span></span>
<span class="keyword1" id="Bool_Func-bf_not_alt"><span class="command">lemma</span></span> bf_not_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_not <span class="free">a</span> <span class="free">as</span> <span class="main">⟷</span> <span class="main">¬</span><span class="free">a</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_not_def bf_ite_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For convenience, we want a few functions more:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_or</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> bf_ite <span class="free"><span class="bound"><span class="entity">a</span></span></span> bf_True <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_lit</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> bf_ite <span class="main">(</span>bf_lit <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1" id="Bool_Func-bf_if_alt"><span class="command">lemma</span></span> bf_if_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_if <span class="free">v</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="bound">l</span> <span class="keyword1">else</span> <span class="free">e</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_if_def bf_ite_def bf_lit_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_nand</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> bf_not <span class="main">(</span>bf_and <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_nor</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> bf_not <span class="main">(</span>bf_or <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_biimp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>bf_ite <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>bf_not <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1" id="Bool_Func-bf_biimp_alt"><span class="command">lemma</span></span> bf_biimp_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_biimp <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">a</span> <span class="bound">l</span> <span class="main">⟷</span> <span class="free">b</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_biimp_def bf_not_def bf_ite_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_xor</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> bf_not <span class="main">(</span>bf_biimp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="Bool_Func-bf_xor_alt"><span class="command">lemma</span></span> bf_xor_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_xor <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span>bf_ite <span class="free">a</span> <span class="main">(</span>bf_not <span class="free">b</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="comment1">(* two application version *)</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> bf_xor_def bf_biimp_def bf_not_def
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ite_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹All of these are implemented and had their implementation verified.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_imp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> bf_ite <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> bf_True"</span></span>
<span class="keyword1" id="Bool_Func-bf_imp_alt"><span class="command">lemma</span></span> bf_imp_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_imp <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> bf_or <span class="main">(</span>bf_not <span class="free">a</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_or_def bf_not_def bf_imp_def <span class="keyword1"><span class="command">unfolding</span></span> bf_ite_def <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">,</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bf_False <span class="main">=</span> bf_True <span class="main">⟹</span> False"</span></span> <span class="quoted"><span class="quoted">"bf_True <span class="main">=</span> bf_False <span class="main">⟹</span> False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="comment1">(* Occurs here and there as goal for sep_auto *)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bf_and_def bf_or_def bf_nand_def bf_biimp_def bf_xor_alt bf_nor_def bf_not_def 

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Shannon decomposition›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  A restriction of a boolean function on a variable is creating the boolean function that evaluates as if that variable was set to a fixed value:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_restrict</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">::</span>bool<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span><span class="tfree">'a</span> boolfunc<span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">v</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Restrictions are useful, because they remove variables from the set of significant variables:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bf_vars</span> <span class="free"><span class="bound"><span class="entity">bf</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">as</span><span class="main">.</span> bf_restrict <span class="bound">v</span> True <span class="free"><span class="bound"><span class="entity">bf</span></span></span> <span class="bound">as</span> <span class="main">≠</span> bf_restrict <span class="bound">v</span> False <span class="free"><span class="bound"><span class="entity">bf</span></span></span> <span class="bound">as</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">var</span> <span class="main">∉</span> bf_vars <span class="main">(</span>bf_restrict <span class="free">var</span> <span class="free">val</span> <span class="free">ex</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bf_vars_def bf_restrict_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  We can decompose calculating if-then-else into computing if-then-else of two triples of functions with one variable restricted to true / false.
  Given that the functions have finite arity, we can use this to construct a recursive definition.
›</span></span>
<span class="keyword1" id="Bool_Func-brace90shannon"><span class="command">lemma</span></span> brace90shannon<span class="main">:</span> <span class="quoted"><span class="quoted">"bf_ite <span class="free">F</span> <span class="free">G</span> <span class="free">H</span> <span class="free">ass</span> <span class="main">=</span>
  bf_ite <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="free">i</span><span class="main">)</span> 
         <span class="main">(</span>bf_ite <span class="main">(</span>bf_restrict <span class="free">i</span> True <span class="free">F</span><span class="main">)</span> <span class="main">(</span>bf_restrict <span class="free">i</span> True <span class="free">G</span><span class="main">)</span> <span class="main">(</span>bf_restrict <span class="free">i</span> True <span class="free">H</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>bf_ite <span class="main">(</span>bf_restrict <span class="free">i</span> False <span class="free">F</span><span class="main">)</span> <span class="main">(</span>bf_restrict <span class="free">i</span> False <span class="free">G</span><span class="main">)</span> <span class="main">(</span>bf_restrict <span class="free">i</span> False <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="free">ass</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bf_ite_def bf_restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_idem<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BDT">
<div class="head">
<h1>Theory BDT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Binary Decision Trees›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BDT
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Bool_Func">Bool_Func</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We first define all operations and properties on binary decision trees.
This has the advantage that we can use a simple, structurally defined type
and the disadvantage that we cannot represent sharing.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> ifex <span class="main">=</span> Trueif <span class="main">|</span> Falseif <span class="main">|</span> IF <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The type is the same as in Boolean Expression Checkers by Nipkow~\cite{Boolean_Expression_Checkers-AFP}.
Internally, Boolean Expression Checkers transforms the boolean expressions to reduced BDTs of this type.
Tests like being tautology testing are then trivial.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val_ifex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_ifex</span> Trueif <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">val_ifex</span> Falseif <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">val_ifex</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">val_ifex</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="free">val_ifex</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_vars</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free">ifex_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="free">ifex_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_vars</span> Trueif <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_vars</span> Falseif <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifex_var_set</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> set <span class="main">(</span>ifex_vars <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_ordered</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> ifex <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_ordered</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">tv</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> ifex_var_set <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">&lt;</span> <span class="bound">tv</span><span class="main">)</span>
                              <span class="main">∧</span> <span class="free">ifex_ordered</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">ifex_ordered</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_ordered</span> Trueif <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_ordered</span> Falseif <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_minimal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> ifex <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_minimal</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free">ifex_minimal</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">ifex_minimal</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_minimal</span> Trueif <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_minimal</span> Falseif <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ro_ifex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ro_ifex</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> ifex_ordered <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> ifex_minimal <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bf_ifex_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bf_ifex_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ass</span><span class="main">.</span> <span class="bound">a</span> <span class="bound">ass</span> <span class="main">⟷</span> val_ifex <span class="bound">b</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">∧</span> ro_ifex <span class="bound">b</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="BDT-ifex_var_noinfluence"><span class="command">lemma</span></span> ifex_var_noinfluence<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ifex_var_set <span class="free">b</span> <span class="main">⟹</span> val_ifex <span class="free">b</span> <span class="main">(</span><span class="free">ass</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="free">b</span> <span class="free">ass</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-roifex_var_not_in_subtree"><span class="command">lemma</span></span> roifex_var_not_in_subtree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-roifex_set_var_subtree"><span class="command">lemma</span></span> roifex_set_var_subtree<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_ifex <span class="free">b</span> <span class="main">(</span><span class="free">ass</span><span class="main">(</span><span class="free">v</span><span class="main">:=</span>True<span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="free">t</span> <span class="free">ass</span>"</span></span> 
        <span class="quoted"><span class="quoted">"val_ifex <span class="free">b</span> <span class="main">(</span><span class="free">ass</span><span class="main">(</span><span class="free">v</span><span class="main">:=</span>False<span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="free">e</span> <span class="free">ass</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ifex_var_noinfluence <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> roifex_var_not_in_subtree<span class="main">)</span>

<span class="keyword1" id="BDT-roifex_Trueif_unique"><span class="command">lemma</span></span> roifex_Trueif_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="free">b</span> <span class="bound">ass</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> Trueif"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> roifex_set_var_subtree<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹ro_ifex <span class="main"><span class="main">(</span></span>IF <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-roifex_Falseif_unique"><span class="command">lemma</span></span> roifex_Falseif_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">ass</span><span class="main">.</span> <span class="main">¬</span> val_ifex <span class="free">b</span> <span class="bound">ass</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> Falseif"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> roifex_set_var_subtree<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹ro_ifex <span class="main"><span class="main">(</span></span>IF <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b2</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>  <span class="free">b</span> <span class="main">=</span> Trueif <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">using</span></span> roifex_Trueif_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>  <span class="free">b</span> <span class="main">=</span> Falseif <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">using</span></span> roifex_Falseif_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-ifex_ordered_not_part"><span class="command">lemma</span></span> ifex_ordered_not_part<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered  <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> IF <span class="free">v</span> <span class="free">b1</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">&lt;</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∉</span> ifex_var_set <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BDT-ro_ifex_unique"><span class="command">lemma</span></span> ro_ifex_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">x</span> <span class="main">⟹</span> ro_ifex <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="free">x</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">y</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">xv</span> <span class="skolem">xb1</span> <span class="skolem">xb2</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IFind <span class="main">=</span> IF 
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹ro_ifex <span class="main">(</span>IF <span class="skolem">xv</span> <span class="skolem">xb1</span> <span class="skolem">xb2</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹ro_ifex <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="main">(</span>IF <span class="skolem">xv</span> <span class="skolem">xb1</span> <span class="skolem">xb2</span><span class="main">)</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">y</span> <span class="bound">ass</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">yv</span> <span class="skolem">yb1</span> <span class="skolem">yb2</span><span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> IF <span class="skolem">xv</span> <span class="skolem">xb1</span> <span class="skolem">xb2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> y'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> IF <span class="skolem">yv</span> <span class="skolem">yb1</span> <span class="skolem">yb2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> y'_def x_def IFind IF <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">xb1</span>"</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">xb2</span>"</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">yb1</span>"</span></span> 
                                               <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">yb2</span>"</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"ro_ifex <span class="skolem">y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> IF IFind x_def y'_def <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">y'</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xv</span> <span class="main">=</span> <span class="skolem">yv</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xb1</span> <span class="main">=</span> <span class="skolem">yb1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IFind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0 1 True roifex_set_var_subtree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ y'_def<span class="main"><span class="main">]</span></span>
                                        roifex_set_var_subtree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ x_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xb2</span> <span class="main">=</span> <span class="skolem">yb2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IFind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0 1 True roifex_set_var_subtree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ y'_def<span class="main"><span class="main">]</span></span>
                                        roifex_set_var_subtree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ x_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> uneq <span class="main">=</span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xv</span> <span class="main">&lt;</span> <span class="skolem">yv</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> ifex_ordered_not_part<span class="main">[</span><span class="operator">OF</span> _ y'_def True<span class="main">]</span> ifex_var_noinfluence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xv</span></span> <span class="quoted"><span class="skolem">y'</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"True"</span></span><span class="main">]</span>
               0<span class="main">(</span>6<span class="main">)</span> roifex_set_var_subtree<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> x_def<span class="main">]</span> 1
             <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="skolem">xb1</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">x</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>5<span class="main">)</span> ifex_var_noinfluence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xv</span></span> <span class="quoted"><span class="skolem">xb1</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"False"</span></span><span class="main">]</span> 
                    ifex_var_noinfluence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xv</span></span> <span class="quoted"><span class="skolem">xb2</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"False"</span></span><span class="main">]</span> 
               x_def
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="skolem">xb1</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">xv</span> <span class="main">:=</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="skolem">xb1</span> <span class="bound">ass</span>"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="skolem">xb2</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">xv</span> <span class="main">:=</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="skolem">xb2</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> 5 this roifex_set_var_subtree<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> x_def<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="skolem">xb1</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">xb2</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">from</span></span> IFind<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> this IFind<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">from</span></span> this uneq <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yv</span> <span class="main">&lt;</span> <span class="skolem">xv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> ifex_ordered_not_part<span class="main">[</span><span class="operator">OF</span> _ x_def this<span class="main">]</span>
                     ifex_var_noinfluence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">yv</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 0<span class="main">(</span>5<span class="main">)</span>
             <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">yv</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="skolem">x</span> <span class="bound">ass</span>"</span></span> 
                   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">yv</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  val_ifex <span class="skolem">x</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this roifex_set_var_subtree<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span> x_def<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">xv</span> <span class="main">:=</span> True<span class="main">,</span> <span class="skolem">yv</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="skolem">xb1</span> <span class="bound">ass</span>"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="main">(</span><span class="bound">ass</span><span class="main">(</span><span class="skolem">xv</span> <span class="main">:=</span> False<span class="main">,</span> <span class="skolem">yv</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="skolem">xb2</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">from</span></span> ifex_ordered_not_part<span class="main">[</span><span class="operator">OF</span> _ x_def 6<span class="main">]</span> 0<span class="main">(</span>5<span class="main">)</span> ifex_var_noinfluence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">yv</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 1
               roifex_set_var_subtree<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main"><span class="main">(</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span> y'_def<span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">yb1</span> <span class="bound">ass</span>"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ass</span> <span class="bound">val</span><span class="main">.</span> val_ifex <span class="skolem">x</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="skolem">yb2</span> <span class="bound">ass</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">from</span></span> this IF<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> x_def 0<span class="main">(</span>5<span class="main">)</span> y'_def 0<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">yb1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">yb2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yb1</span> <span class="main">=</span> <span class="skolem">yb2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>6<span class="main">)</span> y'_def this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> roifex_Falseif_unique roifex_Trueif_unique<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> roifex_Falseif_unique<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> roifex_Trueif_unique<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> bf_ifex_rel_single<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued bf_ifex_rel"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>bf_ifex_rel<span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> single_valued_def bf_ifex_rel_def <span class="keyword1"><span class="command">using</span></span> ro_ifex_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-bf_ifex_eq"><span class="command">lemma</span></span> bf_ifex_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">af</span><span class="main">,</span> <span class="free">at</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="main">(</span><span class="free">bf</span><span class="main">,</span> <span class="free">bt</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="main">(</span><span class="free">af</span> <span class="main">=</span> <span class="free">bf</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">at</span> <span class="main">=</span> <span class="free">bt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">using</span></span> ro_ifex_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-nonempty_if_var_set"><span class="command">lemma</span></span> nonempty_if_var_set<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_vars <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">restrict</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rt</span> <span class="main">=</span> <span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span> <span class="bound">re</span> <span class="main">=</span> <span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">in</span>
                   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">then</span> <span class="bound">rt</span> <span class="keyword1">else</span> <span class="bound">re</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">rt</span> <span class="bound">re</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="BDT-not_element_restrict"><span class="command">lemma</span></span> not_element_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">var</span> <span class="main">∉</span> ifex_var_set <span class="main">(</span>restrict <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_assignment"><span class="command">lemma</span></span> restrict_assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"val_ifex <span class="free">b</span> <span class="main">(</span><span class="free">ass</span><span class="main">(</span><span class="free">var</span> <span class="main">:=</span> <span class="free">val</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> val_ifex <span class="main">(</span>restrict <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="free">ass</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_variables_subset"><span class="command">lemma</span></span> restrict_variables_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_var_set <span class="main">(</span>restrict <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="main">⊆</span> ifex_var_set <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_ifex_ordered_invar"><span class="command">lemma</span></span> restrict_ifex_ordered_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">b</span> <span class="main">⟹</span> ifex_ordered <span class="main">(</span>restrict <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_variables_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BDT-restrict_val_invar"><span class="command">lemma</span></span> restrict_val_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ass</span><span class="main">.</span> <span class="free">a</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">b</span> <span class="bound">ass</span> <span class="main">⟹</span>
                           <span class="main">(</span>bf_restrict <span class="free">var</span> <span class="free">val</span> <span class="free">a</span><span class="main">)</span> <span class="free">ass</span> <span class="main">=</span> val_ifex <span class="main">(</span>restrict <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="free">ass</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bf_restrict_def <span class="keyword1"><span class="command">using</span></span> restrict_assignment <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BDT-restrict_untouched_id"><span class="command">lemma</span></span> restrict_untouched_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ifex_var_set <span class="free">t</span> <span class="main">⟹</span> restrict <span class="free">t</span> <span class="free">x</span> <span class="free">val</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="comment1">(* inversion should hold, too… *)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IF.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ifex_var_set <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ifex_var_set <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> IF.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> restrict.simps Let_def mIH  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_top_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_top_var</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_top_var</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">restrict_top</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> ifex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict_top</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict_top</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="comment1">(* the following four are might be useful eventually… *)</span>
<span class="keyword1" id="BDT-restrict_top_id"><span class="command">lemma</span></span> restrict_top_id<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">e</span> <span class="main">⟹</span> ifex_top_var <span class="free">e</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">&lt;</span> <span class="free">v</span> <span class="main">⟹</span> restrict_top <span class="free">e</span> <span class="free">v'</span> <span class="free">val</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_id"><span class="command">lemma</span></span> restrict_id<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">e</span> <span class="main">⟹</span> ifex_top_var <span class="free">e</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">&lt;</span> <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">e</span> <span class="free">v'</span> <span class="free">val</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">w</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">e2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-restrict_top_IF_id"><span class="command">lemma</span></span> restrict_top_IF_id<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">&lt;</span> <span class="free">v</span> <span class="main">⟹</span> restrict_top <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="free">v'</span> <span class="free">val</span> <span class="main">=</span> <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_top_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_IF_id"><span class="command">lemma</span></span> restrict_IF_id<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">&lt;</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="free">v'</span> <span class="free">val</span> <span class="main">=</span> <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_id<span class="main">[</span><span class="operator">OF</span> o<span class="main">,</span> <span class="operator">unfolded</span> ifex_top_var.simps<span class="main">,</span> <span class="operator">OF</span> refl le<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">val</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="BDT-restrict_top_eq"><span class="command">lemma</span></span> restrict_top_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> restrict <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="free">val</span> <span class="main">=</span> restrict_top <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="free">val</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_untouched_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_top_ifex_ordered_invar"><span class="command">lemma</span></span> restrict_top_ifex_ordered_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">b</span> <span class="main">⟹</span> ifex_ordered <span class="main">(</span>restrict_top <span class="free">b</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lowest_tops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex list <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lowest_tops</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lowest_tops</span> <span class="main">(</span><span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">case</span> <span class="free">lowest_tops</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> Some <span class="bound">u</span> <span class="main">⇒</span> <span class="main">(</span>min <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lowest_tops</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lowest_tops</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="BDT-lowest_tops_NoneD"><span class="command">lemma</span></span> lowest_tops_NoneD<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lowest_tops.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-lowest_tops_in"><span class="command">lemma</span></span> lowest_tops_in<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="free">k</span> <span class="main">=</span> Some <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="main">(</span>map ifex_vars <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lowest_tops.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">IFC</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">ifex_ite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_ite</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lowest_tops <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> 
                         <span class="main">(</span>IFC <span class="bound">x</span> <span class="main">(</span><span class="free">ifex_ite</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span> True<span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">ifex_ite</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Trueif <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> Falseif <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1" id="BDT-restrict_size_le"><span class="command">lemma</span></span> restrict_size_le<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>restrict_top <span class="free">k</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-restrict_size_less"><span class="command">lemma</span></span> restrict_size_less<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_top_var <span class="free">k</span> <span class="main">=</span> Some <span class="free">var</span> <span class="main">⟹</span> size <span class="main">(</span>restrict_top <span class="free">k</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-lowest_tops_cases"><span class="command">lemma</span></span> lowest_tops_cases<span class="main">:</span>
<span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="free">var</span> <span class="main">⟹</span> ifex_top_var <span class="free">i</span> <span class="main">=</span> Some <span class="free">var</span> <span class="main">∨</span> ifex_top_var <span class="free">t</span>
                                      <span class="main">=</span> Some <span class="free">var</span> <span class="main">∨</span> ifex_top_var <span class="free">e</span> <span class="main">=</span> Some <span class="free">var</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1" id="BDT-lowest_tops_lowest"><span class="command">lemma</span></span> lowest_tops_lowest<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="free">es</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span> <span class="main">⟹</span> ifex_ordered <span class="free">e</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> ifex_var_set <span class="free">e</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lowest_tops.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> IF <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def Ball_def less_imp_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> less_imp_le lowest_tops_NoneD order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BDT-termlemma2"><span class="command">lemma</span></span> termlemma2<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="free">xa</span> <span class="main">⟹</span>
  <span class="main">(</span>size <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">xa</span> <span class="free">val</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>restrict_top <span class="free">t</span> <span class="free">xa</span> <span class="free">val</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>restrict_top <span class="free">e</span> <span class="free">xa</span> <span class="free">val</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
  <span class="main">(</span>size <span class="free">i</span> <span class="main">+</span> size <span class="free">t</span> <span class="main">+</span> size <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_size_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xa</span></span> <span class="quoted"><span class="free">val</span></span><span class="main">]</span> restrict_size_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xa</span></span> <span class="quoted"><span class="free">val</span></span><span class="main">]</span>  restrict_size_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">xa</span></span> <span class="quoted"><span class="free">val</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lowest_tops_cases restrict_size_less<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">val</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="BDT-termlemma"><span class="command">lemma</span></span> termlemma<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="free">xa</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">xa</span> <span class="free">val</span><span class="main">,</span> restrict_top <span class="free">t</span> <span class="free">xa</span> <span class="free">val</span><span class="main">,</span> restrict_top <span class="free">e</span> <span class="free">xa</span> <span class="free">val</span><span class="main">)</span> <span class="keyword1">of</span> 
             <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> size <span class="bound">i</span> <span class="main">+</span> size <span class="bound">t</span> <span class="main">+</span> size <span class="bound">e</span><span class="main">)</span> <span class="main">&lt;</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> size <span class="bound">i</span> <span class="main">+</span> size <span class="bound">t</span> <span class="main">+</span> size <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> termlemma2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">ifex_ite</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">.</span> size <span class="bound">i</span> <span class="main">+</span> size <span class="bound">t</span> <span class="main">+</span> size <span class="bound">e</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> in_measure<span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> termlemma<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="comment1">(* inspired by Haskell *)</span>
<span class="keyword1"><span class="command">declare</span></span> const_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1" id="BDT-rel_true_false"><span class="command">lemma</span></span> rel_true_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> Trueif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> const True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> const False"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff const_def
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-rel_if"><span class="command">lemma</span></span> rel_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="main">(</span><span class="free">ta</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="main">(</span><span class="free">ea</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">as</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">ta</span> <span class="bound">as</span> <span class="keyword1">else</span> <span class="free">ea</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff const_def
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="BDT-ifex_ordered_implied"><span class="command">lemma</span></span> ifex_ordered_implied<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> ifex_ordered <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="BDT-ifex_minimal_implied"><span class="command">lemma</span></span> ifex_minimal_implied<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> ifex_minimal <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="BDT-ifex_ite_induct2"><span class="command">lemma</span></span> ifex_ite_induct2<span class="main">[</span><span class="operator">case_names</span> Trueif Falseif IF<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> Trueif <span class="main">⟹</span> <span class="free">sentence</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> Falseif <span class="main">⟹</span> <span class="free">sentence</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="free">sentence</span> <span class="main">(</span>restrict_top <span class="bound">i</span> <span class="bound">a</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">t</span> <span class="bound">a</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">e</span> <span class="bound">a</span> True<span class="main">)</span> <span class="main">⟹</span>
             <span class="free">sentence</span> <span class="main">(</span>restrict_top <span class="bound">i</span> <span class="bound">a</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">t</span> <span class="bound">a</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">e</span> <span class="bound">a</span> False<span class="main">)</span> <span class="main">⟹</span>
   lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="bound">a</span> <span class="main">⟹</span> <span class="free">sentence</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sentence</span> <span class="free">i</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BDT-ifex_ite_induct"><span class="command">lemma</span></span> ifex_ite_induct<span class="main">[</span><span class="operator">case_names</span> Trueif Falseif IF<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> Trueif <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> Falseif <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">val</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>restrict_top <span class="bound">i</span> <span class="bound">a</span> <span class="bound">val</span><span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">t</span> <span class="bound">a</span> <span class="bound">val</span><span class="main">)</span> <span class="main">(</span>restrict_top <span class="bound">e</span> <span class="bound">a</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
   lowest_tops <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="bound">a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">i</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="skolem">a</span> <span class="bound">val</span><span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="skolem">a</span> <span class="bound">val</span><span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="skolem">a</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">val</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IF<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> IF <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BDT-restrict_top_subset"><span class="command">lemma</span></span> restrict_top_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="BDT-ifex_vars_subset"><span class="command">lemma</span></span> ifex_vars_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="main">(</span>ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="free">t</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> ifex_var_set <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>ifex_ite <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="skolem">a</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="skolem">a</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="skolem">a</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>ifex_ite <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="skolem">a</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="skolem">a</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="skolem">a</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IF <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IFC_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span>
    <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="skolem">a</span> True <span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="skolem">a</span> True <span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="skolem">a</span> True <span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="skolem">a</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="skolem">a</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="skolem">a</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> IF <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> restrict_top_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> lowest_tops_in<span class="main">[</span><span class="operator">OF</span> IF<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_concat set_map set_simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-three_ins"><span class="command">lemma</span></span> three_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-hlp3"><span class="command">lemma</span></span> hlp3<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">(</span>IF <span class="free">v</span> <span class="free">uu</span> <span class="free">uv</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> lowest_tops <span class="free">r</span> <span class="main">⟹</span> lowest_tops <span class="main">(</span>IF <span class="free">v</span> <span class="free">uu</span> <span class="free">uv</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1" id="BDT-hlp2"><span class="command">lemma</span></span> hlp2<span class="main">:</span> <span class="quoted"><span class="quoted">"IF <span class="free">vi</span> <span class="free">vt</span> <span class="free">ve</span> <span class="main">∈</span> set <span class="free">is</span> <span class="main">⟹</span> lowest_tops <span class="free">is</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">vi</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vt</span></span> <span class="quoted"><span class="free">ve</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lowest_tops.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lowest_tops_NoneD<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_cases order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BDT-hlp1"><span class="command">lemma</span></span> hlp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">is</span> <span class="main">⟹</span> lowest_tops <span class="free">is</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> ifex_ordered <span class="free">i</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∉</span> <span class="main">(</span>ifex_var_set <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">a</span> <span class="free">val</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_not<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vi</span></span> <span class="skolem"><span class="skolem">vt</span></span> <span class="skolem"><span class="skolem">ve</span></span> <span class="keyword2"><span class="keyword">where</span></span> vi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> IF <span class="skolem">vi</span> <span class="skolem">vt</span> <span class="skolem">ve</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vi</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vi</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">-</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="skolem">vt</span><span class="main">)</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">(</span>ifex_var_set <span class="skolem">ve</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vi<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ifex_ordered <span class="free">i</span>›</span></span> vi <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">vi</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> vi <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> hlp2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BDT-order_ifex_ite_invar"><span class="command">lemma</span></span> order_ifex_ite_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">i</span> <span class="main">⟹</span> ifex_ordered <span class="free">t</span> <span class="main">⟹</span> ifex_ordered <span class="free">e</span> <span class="main">⟹</span> ifex_ordered <span class="main">(</span>ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal1 <span class="main">=</span> IF
  <span class="keyword1"><span class="command">note</span></span> l <span class="main">=</span> restrict_top_ifex_ordered_invar
  <span class="keyword1"><span class="command">note</span></span> l<span class="main">[</span><span class="operator">OF</span> goal1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> l<span class="main">[</span><span class="operator">OF</span> goal1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> l<span class="main">[</span><span class="operator">OF</span> goal1<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> goal1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> blubb <span class="main">=</span> lowest_tops_lowest<span class="main">[</span><span class="operator">OF</span> goal1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ restrict_top_subset<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> mIH 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ifex_ite.simps<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IFC_def goal1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hlp1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> hlp1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> hlp1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ifex_vars_subset blubb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> blubb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> blubb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> three_ins<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> goal1<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_neq_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-ifc_split"><span class="command">lemma</span></span> ifc_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>IFC <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span> <span class="main">=</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> <span class="free">e</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>IF <span class="free">v</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> IFC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BDT-restrict_top_ifex_minimal_invar"><span class="command">lemma</span></span> restrict_top_ifex_minimal_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_minimal <span class="free">i</span> <span class="main">⟹</span> ifex_minimal <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">a</span> <span class="free">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-minimal_ifex_ite_invar"><span class="command">lemma</span></span> minimal_ifex_ite_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_minimal <span class="free">i</span> <span class="main">⟹</span> ifex_minimal <span class="free">t</span> <span class="main">⟹</span> ifex_minimal <span class="free">e</span> <span class="main">⟹</span> ifex_minimal <span class="main">(</span>ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ifc_split option.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_top_ifex_minimal_invar<span class="main">)</span>

<span class="keyword1" id="BDT-restrict_top_bf"><span class="command">lemma</span></span> restrict_top_bf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">is</span> <span class="main">⟹</span> lowest_tops <span class="free">is</span> <span class="main">=</span> Some <span class="free">vr</span> <span class="main">⟹</span>
  ifex_ordered <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> <span class="free">fi</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">i</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⟹</span> val_ifex <span class="main">(</span>restrict_top <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span><span class="main">)</span> <span class="free">ass</span> <span class="main">=</span> bf_restrict <span class="free">vr</span> <span class="free">vl</span> <span class="free">fi</span> <span class="free">ass</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x31</span> <span class="skolem">x32</span> <span class="skolem">x33</span><span class="main">)</span>  <span class="keyword1"><span class="command">note</span></span> goal3 <span class="main">=</span> 3
  <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_top <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span> <span class="main">=</span> restrict <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x31</span> <span class="main">=</span> <span class="free">vr</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> uf <span class="main">=</span> restrict_top_eq<span class="main">[</span><span class="operator">OF</span> goal3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> goal3<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> goal3<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> True<span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_top <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False goal3<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vr</span> <span class="main">&lt;</span> <span class="skolem">x31</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_neq_trans<span class="main">[</span><span class="operator">OF</span> hlp2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> goal3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> goal3<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> goal3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> False<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> goal3<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">i</span> <span class="free">vr</span> <span class="free">vl</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> restrict_IF_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 2 <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rr <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> goal3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> restrict_val_invar<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_restrict_def<span class="main">)</span>

<span class="keyword1" id="BDT-val_ifex_ite"><span class="command">lemma</span></span> val_ifex_ite<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> <span class="free">fi</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">i</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> <span class="free">ft</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">t</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> <span class="free">fe</span> <span class="bound">ass</span> <span class="main">=</span> val_ifex <span class="free">e</span> <span class="bound">ass</span><span class="main">)</span> <span class="main">⟹</span>
  ifex_ordered <span class="free">i</span> <span class="main">⟹</span> ifex_ordered <span class="free">t</span> <span class="main">⟹</span> ifex_ordered <span class="free">e</span> <span class="main">⟹</span>
  <span class="main">(</span>bf_ite <span class="free">fi</span> <span class="free">ft</span> <span class="free">fe</span><span class="main">)</span> <span class="free">ass</span> <span class="main">=</span> val_ifex <span class="main">(</span>ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="free">ass</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fi</span></span> <span class="quoted"><span class="free">ft</span></span> <span class="quoted"><span class="free">fe</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> IF<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl refl refl
    restrict_top_ifex_ordered_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IF<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
    restrict_top_ifex_ordered_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IF<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
    restrict_top_ifex_ordered_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IF<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> uf1 <span class="main">=</span> restrict_top_bf<span class="main">[</span><span class="operator">OF</span> three_ins<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IF<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹ifex_ordered <span class="skolem">i</span>›</span></span>  IF<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
             restrict_top_bf<span class="main">[</span><span class="operator">OF</span> three_ins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> IF<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹ifex_ordered <span class="skolem">t</span>›</span></span>  IF<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
             restrict_top_bf<span class="main">[</span><span class="operator">OF</span> three_ins<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> IF<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹ifex_ordered <span class="skolem">e</span>›</span></span>  IF<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> brace90shannon<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_top_ifex_ordered_invar IF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>6-8<span class="main"><span class="main">)</span></span> uf1 mIH bf_ite_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ifc_split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ite_def bf_ifex_rel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ifex_ite_rel_bf<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="free">ft</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="free">fe</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span>bf_ite <span class="free">fi</span> <span class="free">ft</span> <span class="free">fe</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  bf_ifex_rel_def order_ifex_ite_invar minimal_ifex_ite_invar val_ifex_ite
         <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">param_opt</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">param_opt</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Trueif <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Falseif <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Trueif <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Falseif <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Trueif <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> Some Trueif <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Falseif <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some Falseif <span class="keyword1">else</span>
   None<span class="main">)</span>"</span></span>

<span class="keyword1" id="BDT-param_opt_ifex_ite_eq"><span class="command">lemma</span></span> param_opt_ifex_ite_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ro_ifex <span class="free">i</span> <span class="main">⟹</span> ro_ifex <span class="free">t</span> <span class="main">⟹</span> ro_ifex <span class="free">e</span> <span class="main">⟹</span>
       param_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ro_ifex_unique<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> param_opt_def<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> order_ifex_ite_invar minimal_ifex_ite_invar <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> val_ifex_ite<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ite_def param_opt_def val_ifex_ite<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">function</span></span> <span class="entity">ifex_ite_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="tfree">'a</span> ifex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_ite_opt</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> param_opt <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span> <span class="main">|</span> None <span class="main">⇒</span>
                        <span class="main">(</span><span class="keyword1">case</span> lowest_tops <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> 
                         <span class="main">(</span>IFC <span class="bound">x</span> <span class="main">(</span><span class="free">ifex_ite_opt</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> True<span class="main">)</span>
                                              <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span> True<span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span><span class="free">ifex_ite_opt</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span> False<span class="main">)</span>
                                              <span class="main">(</span>restrict_top <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Trueif <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> Falseif <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">ifex_ite_opt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">.</span> size <span class="bound">i</span> <span class="main">+</span> size <span class="bound">t</span> <span class="main">+</span> size <span class="bound">e</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_measure<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> in_measure<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> termlemma<span class="main">)</span>

<span class="keyword1" id="BDT-ifex_ite_opt_eq"><span class="command">lemma</span></span> ifex_ite_opt_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"
  ro_ifex <span class="free">i</span> <span class="main">⟹</span> ro_ifex <span class="free">t</span> <span class="main">⟹</span> ro_ifex <span class="free">e</span> <span class="main">⟹</span> ifex_ite_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ifex_ite_opt.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> i t e<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> param_opt <span class="improper">i</span> <span class="improper">t</span> <span class="improper">e</span> <span class="main">=</span> Some <span class="bound">r</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps restrict_top.simps lowest_tops.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> param_opt_ifex_ite_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i t e
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restrict_top.simps ifex_ite.simps ifex_ite_opt.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> restrict_top.simps ifex_ite.simps ifex_ite_opt.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ifex_ite.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> y<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ifex_ite_opt <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="improper">y</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="improper">y</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="improper">y</span> True<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                         <span class="main">(</span>ifex_ite <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="improper">y</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="improper">y</span> True<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="improper">y</span> True<span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ifex_ite_opt <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="improper">y</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="improper">y</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="improper">y</span> False<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                         <span class="main">(</span>ifex_ite <span class="main">(</span>restrict_top <span class="skolem">i</span> <span class="improper">y</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">t</span> <span class="improper">y</span> False<span class="main">)</span> <span class="main">(</span>restrict_top <span class="skolem">e</span> <span class="improper">y</span> False<span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> restrict_top_ifex_minimal_invar restrict_top_ifex_ordered_invar <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> restrict_top_ifex_minimal_invar restrict_top_ifex_ordered_invar <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BDT-ro_ifexI"><span class="command">lemma</span></span> ro_ifexI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> ro_ifex <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifex_minimal_implied ifex_ordered_implied<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ifex_ite_opt_rel_bf<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="free">ft</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="free">fe</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span>bf_ite <span class="free">fi</span> <span class="free">ft</span> <span class="free">fe</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>ifex_ite_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
<span class="keyword1"><span class="command">using</span></span> ifex_ite_rel_bf ifex_ite_opt_eq ro_ifexI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="keyword1" id="BDT-restrict_top_bf_ifex_rel"><span class="command">lemma</span></span> restrict_top_bf_ifex_rel<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="bound">f'</span><span class="main">,</span> restrict_top <span class="free">i</span> <span class="free">var</span> <span class="free">val</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bf_ifex_rel_def <span class="keyword1"><span class="command">using</span></span> restrict_top_ifex_minimal_invar restrict_top_ifex_ordered_invar
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="BDT-param_opt_lowest_tops_lem"><span class="command">lemma</span></span> param_opt_lowest_tops_lem<span class="main">:</span> <span class="quoted"><span class="quoted">"param_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> lowest_tops <span class="main">[</span><span class="free">i</span><span class="main">,</span><span class="free">t</span><span class="main">,</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> param_opt_def<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_sat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat</span> Trueif <span class="main">=</span> Some <span class="main">(</span>const False<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat</span> Falseif <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">ifex_sat</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> 
    Some <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">:=</span>False<span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ifex_sat</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
      Some <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">:=</span>True<span class="main">)</span><span class="main">)</span> <span class="main">|</span>
      None <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>
"</span></span>

<span class="keyword1" id="BDT-ifex_sat_untouched_False"><span class="command">lemma</span></span> ifex_sat_untouched_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="free">i</span> <span class="main">⟹</span> ifex_sat <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v1</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≠</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> au<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">(</span><span class="skolem">v1</span> <span class="main">:=</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ni<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="free">v</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> None IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> None <span class="keyword1"><span class="command">have</span></span> au<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">(</span><span class="skolem">v1</span> <span class="main">:=</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ni<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="free">v</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="comment1">(* this proof seems to complicated… *)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="BDT-ifex_upd_other"><span class="command">lemma</span></span> ifex_upd_other<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="free">i</span> <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">v</span><span class="main">:=</span><span class="free">any</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val_ifex <span class="free">i</span> <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v1</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">t</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> IF.prems <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≠</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> val_ifex.simps fun_upd_other<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ne<span class="main"><span class="main">]</span></span> ifex_vars.simps IF.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> IF.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="comment1">(* something weaker than ifex_ordered *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_no_twice</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_no_twice</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> <span class="main">(</span>ifex_var_set <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> ifex_var_set <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="free">ifex_no_twice</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">ifex_no_twice</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_no_twice</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>
<span class="keyword1" id="BDT-ordered_ifex_no_twiceI"><span class="command">lemma</span></span> ordered_ifex_no_twiceI<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_ordered <span class="free">i</span> <span class="main">⟹</span> ifex_no_twice <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="BDT-ifex_sat_NoneD"><span class="command">lemma</span></span> ifex_sat_NoneD<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat <span class="free">i</span> <span class="main">=</span> None <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="free">ass</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1" id="BDT-ifex_sat_SomeD"><span class="command">lemma</span></span> ifex_sat_SomeD<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="free">i</span> <span class="main">⟹</span> ifex_sat <span class="free">i</span> <span class="main">=</span> Some <span class="free">ass</span> <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="free">ass</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ass</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> IF.prems<span class="main">[</span><span class="operator">unfolded</span> ifex_sat.simps<span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> val_ifex.simps ifex_sat.simps option.simps fun_upd_same if_False ifex_upd_other<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ni<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IF.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> None IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> val_ifex.simps ifex_sat.simps option.simps fun_upd_same if_True None ifex_upd_other<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ni<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> IF.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1" id="BDT-ifex_sat_NoneI"><span class="command">lemma</span></span> ifex_sat_NoneI<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">ass</span><span class="main">.</span> val_ifex <span class="free">i</span> <span class="bound">ass</span> <span class="main">=</span> False<span class="main">)</span> <span class="main">⟹</span> ifex_sat <span class="free">i</span> <span class="main">=</span> None"</span></span> 
<span class="comment1">(* alternate proof: using ifex_sat_SomeD by fastforce *)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ifex_sat <span class="free">i</span> <span class="main">=</span> Some <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ifex_sat_SomeD<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_sat_list</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat_list</span> Trueif <span class="main">=</span> Some <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat_list</span> Falseif <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ifex_sat_list</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">ifex_sat_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> 
    Some <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span>False<span class="main">)</span><span class="main">#</span><span class="bound">a</span><span class="main">)</span> <span class="main">|</span>
    None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ifex_sat_list</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
      Some <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span>True<span class="main">)</span><span class="main">#</span><span class="bound">a</span><span class="main">)</span> <span class="main">|</span>
      None <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">update_assignment_alt</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">v</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">v</span> <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_assignment</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update_assignment</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">update_assignment</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">update_assignment</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1" id="BDT-update_assignment_notin"><span class="command">lemma</span></span> update_assignment_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">us</span> <span class="main">⟹</span> update_assignment <span class="free">us</span> <span class="free">as</span> <span class="free">a</span> <span class="main">=</span> <span class="free">as</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BDT-update_assignment_alt"><span class="command">lemma</span></span> update_assignment_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"update_assignment <span class="free">u</span> <span class="free">as</span> <span class="main">=</span> update_assignment_alt <span class="free">u</span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_assignment_alt_def fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BDT-update_assignment"><span class="command">lemma</span></span> update_assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span><span class="main">#</span><span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> update_assignment <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">u</span><span class="main">)</span><span class="main">#</span><span class="free">us</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> update_assignment <span class="free">us</span> <span class="main">(</span><span class="free">as</span><span class="main">(</span><span class="free">v</span><span class="main">:=</span><span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> update_assignment_alt update_assignment_alt_def
<span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">force</span> 

<span class="keyword1" id="BDT-ass_upd_same"><span class="command">lemma</span></span> ass_upd_same<span class="main">:</span> <span class="quoted"><span class="quoted">"update_assignment <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> <span class="free">a</span><span class="main">)</span> <span class="free">ass</span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BDT-ifex_sat_list_subset"><span class="command">lemma</span></span> ifex_sat_list_subset<span class="main">:</span>  <span class="quoted"><span class="quoted">"ifex_sat_list <span class="free">t</span> <span class="main">=</span> Some <span class="free">u</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">u</span> <span class="main">⊆</span> ifex_var_set <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ue</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">ue</span> <span class="main">⊆</span> ifex_var_set <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">u</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="skolem">ue</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">with</span></span> IF.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ut</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">ut</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">ut</span> <span class="main">⊆</span> ifex_var_set <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">u</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="skolem">ut</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems None Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-sat_list_distinct"><span class="command">lemma</span></span> sat_list_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="free">t</span> <span class="main">⟹</span> ifex_sat_list <span class="free">t</span> <span class="main">=</span> Some <span class="free">u</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IF.prems <span class="keyword1"><span class="command">have</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> mIH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems ifex_sat_list.simps Some ifex_sat_list_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">with</span></span> IF.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ut</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">ut</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> mIH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems ifex_sat_list.simps None Some ifex_sat_list_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-ifex_sat_list_NoneD"><span class="command">lemma</span></span> ifex_sat_list_NoneD<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="free">i</span> <span class="main">=</span> None <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="free">ass</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1" id="BDT-ifex_sat_list_SomeD"><span class="command">lemma</span></span> ifex_sat_list_SomeD<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="free">i</span> <span class="main">⟹</span> ifex_sat_list <span class="free">i</span> <span class="main">=</span> Some <span class="free">u</span> <span class="main">⟹</span> <span class="free">ass</span> <span class="main">=</span> update_assignment <span class="free">u</span> <span class="free">ass'</span> <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="free">ass</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ass</span></span> <span class="quoted"><span class="free">ass'</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"ifex_no_twice <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> ifex_var_set <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> IF.prems<span class="main">[</span><span class="operator">unfolded</span> ifex_sat.simps<span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> False<span class="main">)</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> IF.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> au<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="main">=</span> update_assignment <span class="skolem">a</span> <span class="main">(</span><span class="skolem">ass'</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> False<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">using</span></span> update_assignment<span class="main">[</span><span class="operator">OF</span> sat_list_distinct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> ef<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> avF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="skolem">v</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> nt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Some au<span class="main">]</span> Some IF.prems<span class="main">(</span>2<span class="main">)</span> avF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> None IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> ef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> True<span class="main">)</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> None Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> IF.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> au<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="main">=</span> update_assignment <span class="skolem">a</span> <span class="main">(</span><span class="skolem">ass'</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> True<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">using</span></span> update_assignment<span class="main">[</span><span class="operator">OF</span> sat_list_distinct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> ef<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> avT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="skolem">v</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> nt<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Some au<span class="main">]</span> Some IF.prems<span class="main">(</span>2<span class="main">)</span> avT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sat_list_to_bdt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sat_list_to_bdt</span> <span class="main">[]</span> <span class="main">=</span> Trueif"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sat_list_to_bdt</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span> IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">sat_list_to_bdt</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> Falseif <span class="keyword1">else</span> IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> Falseif <span class="main">(</span><span class="free">sat_list_to_bdt</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="free">i</span> <span class="main">=</span> Some <span class="free">u</span> <span class="main">⟹</span> val_ifex <span class="main">(</span>sat_list_to_bdt <span class="free">u</span><span class="main">)</span> <span class="free">as</span> <span class="main">⟹</span> val_ifex <span class="free">i</span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> IF.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> False<span class="main">)</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> avF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="skolem">v</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_ifex <span class="main">(</span>sat_list_to_bdt <span class="skolem">a</span><span class="main">)</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">using</span></span> avF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> mIH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> avF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"ifex_sat_list <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> None IF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> ef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> True<span class="main">)</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>1<span class="main">)</span> Some None <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> avT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="skolem">v</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_ifex <span class="main">(</span>sat_list_to_bdt <span class="skolem">a</span><span class="main">)</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IF.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ef <span class="keyword1"><span class="command">using</span></span> avT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> IF.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some this<span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> avT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="BDT-bf_ifex_rel_consts"><span class="command">lemma</span></span> bf_ifex_rel_consts<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_True<span class="main">,</span> Trueif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_False<span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1" id="BDT-bf_ifex_rel_lit"><span class="command">lemma</span></span> bf_ifex_rel_lit<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_lit <span class="free">v</span><span class="main">,</span> IFC <span class="free">v</span> Trueif Falseif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_def IFC_def bf_lit_def<span class="main">)</span>

<span class="keyword1" id="BDT-bf_ifex_rel_consts_ensured"><span class="command">lemma</span></span> bf_ifex_rel_consts_ensured<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_True<span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Trueif<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bf_False<span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Falseif<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> roifex_Trueif_unique roifex_Falseif_unique<span class="main">)</span>

<span class="comment1">(* reverse of the above *)</span>
<span class="keyword1" id="BDT-bf_ifex_rel_consts_ensured_rev"><span class="command">lemma</span></span> bf_ifex_rel_consts_ensured_rev<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span>Trueif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> bf_True<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span>Falseif<span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> bf_False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> ifex_ite_opt.simps restrict_top.simps lowest_tops.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Option_Helpers">
<div class="head">
<h1>Theory Option_Helpers</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Option Helpers›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹These definitions were contributed by Peter Lammich.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Option_Helpers
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="entity">oassert</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="quoted">"bool <span class="main"><span class="main">⇒</span></span> unit option"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">oassert</span></span> True <span class="main"><span class="main">=</span></span> Some <span class="main"><span class="main">()</span></span>"</span></span></span> <span class="main">|</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">oassert</span></span> False <span class="main"><span class="main">=</span></span> None"</span></span></span>

<span class="keyword1" id="Option_Helpers-oassert_iff"><span class="command">lemma</span></span> oassert_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"oassert <span class="free">Φ</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span> 
  <span class="quoted"><span class="quoted">"oassert <span class="free">Φ</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">¬</span><span class="free">Φ</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The idea is that we want the result of some computation to be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the contents of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to satisfy some property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ospec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ospec</span> None <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ospec</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> ospec_rules

<span class="keyword1" id="Option_Helpers-oreturn_rule"><span class="command">lemma</span></span> oreturn_rule<span class="main">[</span><span class="operator">ospec_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span>Some <span class="free">r</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_Helpers-obind_rule"><span class="command">lemma</span></span> obind_rule<span class="main">[</span><span class="operator">ospec_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ospec <span class="free">m</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">f</span> <span class="bound">r</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Option_Helpers-ospec_alt"><span class="command">lemma</span></span> ospec_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="free">m</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">m</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Option_Helpers-ospec_bind_simp"><span class="command">lemma</span></span> ospec_bind_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span>ospec <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> ospec <span class="main">(</span><span class="free">f</span> <span class="bound">r</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Option_Helpers-ospec_cons"><span class="command">lemma</span></span> ospec_cons<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ospec <span class="free">m</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ospec <span class="free">m</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Option_Helpers-oreturn_synth"><span class="command">lemma</span></span> oreturn_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_Helpers-ospecD"><span class="command">lemma</span></span> ospecD<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="free">x</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Option_Helpers-ospecD2"><span class="command">lemma</span></span> ospecD2<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="free">x</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Impl">
<div class="head">
<h1>Theory Abstract_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Abstract ITE Implementation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Abstract_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#BDT">BDT</a>
        <a href="../../automatic_refinement/theories/#Refine_Lib">Automatic_Refinement.Refine_Lib</a>
        <a href="#Option_Helpers">Option_Helpers</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ni</span><span class="main">)</span> IFEXD <span class="main">=</span> TD <span class="main">|</span> FD <span class="main">|</span> IFD <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'ni</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'ni</span></span></span> 

<span class="keyword1"><span class="command">locale</span></span> bdd_impl_pre <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ni</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">les</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">les</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">ni</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">ni</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">ni</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bdd_impl <span class="main">=</span> bdd_impl_pre <span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ni</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> ifex<span class="main">)</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Timpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'ni</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Fimpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'ni</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">IFimpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'ni</span> <span class="main">⇒</span> <span class="tfree">'ni</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'ni</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">DESTRimpl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ni</span>  <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'ni</span><span class="main">)</span> IFEXD"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> Timpl_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">Timpl</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ni</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ni</span><span class="main">,</span> Trueif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Fimpl_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">Fimpl</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ni</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ni</span><span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IFimpl_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">I</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">ni1</span><span class="main">,</span><span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span><span class="main">;</span><span class="main">(</span><span class="free">ni2</span><span class="main">,</span><span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span><span class="main">⟧</span>
                        <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">IFimpl</span> <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ni</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ni</span><span class="main">,</span> IFC <span class="free">v</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> DESTRimpl_rule1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> Trueif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> TD<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> DESTRimpl_rule2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> FD<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> DESTRimpl_rule3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> IF <span class="free">v</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span>
                            ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span>
                                  <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ni1</span> <span class="bound">ni2</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>IFD <span class="free">v</span> <span class="bound">ni1</span> <span class="bound">ni2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ni1</span><span class="main">,</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ni2</span><span class="main">,</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Impl-les_refl"><span class="command">lemma</span></span> les_refl<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"les <span class="free">s</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main">)</span>
<span class="keyword1" id="Abstract_Impl-les_trans"><span class="command">lemma</span></span> les_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"les <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> les <span class="free">s2</span> <span class="free">s3</span> <span class="main">⟹</span> les <span class="free">s1</span> <span class="free">s3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> DESTRimpl_rules <span class="main">=</span> DESTRimpl_rule1 DESTRimpl_rule2 DESTRimpl_rule3

<span class="keyword1" id="Abstract_Impl-DESTRimpl_rule_useless"><span class="command">lemma</span></span> DESTRimpl_rule_useless<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span>
    TD <span class="main">⇒</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> Trueif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">|</span>
    FD <span class="main">⇒</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">|</span>
    IFD <span class="bound">v</span> <span class="bound">nt</span> <span class="bound">ne</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> DESTRimpl_rules<span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> ospecD2<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1" id="Abstract_Impl-DESTRimpl_rule"><span class="command">lemma</span></span> DESTRimpl_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">n</span> <span class="keyword1">of</span>
    Trueif <span class="main">⇒</span> <span class="bound">r</span> <span class="main">=</span> TD <span class="main">|</span>
    Falseif <span class="main">⇒</span> <span class="bound">r</span> <span class="main">=</span> FD <span class="main">|</span>
    IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tn</span> <span class="bound">en</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> IFD <span class="bound">v</span> <span class="bound">tn</span> <span class="bound">en</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">tn</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">en</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> DESTRimpl_rules<span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> ospecD2<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_ifexi</span> <span class="free"><span class="bound"><span class="entity">fti</span></span></span> <span class="free"><span class="bound"><span class="entity">ffi</span></span></span> <span class="free"><span class="bound"><span class="entity">fii</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">dest</span> <span class="main">←</span> <span class="free">DESTRimpl</span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="bound">dest</span> <span class="keyword1">of</span>
    TD <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">fti</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">|</span> FD <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ffi</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">|</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">fii</span></span></span> <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Impl-case_ifexi_rule"><span class="command">lemma</span></span> case_ifexi_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> NI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FTI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">n</span> <span class="main">=</span> Trueif <span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">fti</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="free">ft</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FFI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">n</span> <span class="main">=</span> Falseif <span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">ffi</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="free">ff</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FII<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ti</span> <span class="bound">ei</span> <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">n</span> <span class="main">=</span> IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">;</span> <span class="main">(</span><span class="bound">ti</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">fii</span> <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="free">fi</span> <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span>case_ifexi <span class="free">fti</span> <span class="free">ffi</span> <span class="free">fii</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span>case_ifex <span class="free">ft</span> <span class="free">ff</span> <span class="free">fi</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">I'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> case_ifexi_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> NI FTI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> NI FFI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> NI FII <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lowest_tops_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_tops_impl</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="main">(</span>None<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_tops_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    case_ifexi
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">lowest_tops_impl</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">s</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">lowest_tops_impl</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">s</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">rec</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">lowest_tops_impl</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">s</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">rec</span> <span class="keyword1">of</span>
          Some <span class="bound">u</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span>min <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> 
          None <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
       <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> lowest_tops_impl.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lowest_tops_alt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_tops_alt</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_tops_alt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">rec</span> <span class="main">=</span> <span class="free">lowest_tops_alt</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="keyword1">in</span>
    case_ifex
      <span class="bound">rec</span>
      <span class="bound">rec</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">rec</span> <span class="keyword1">of</span> 
          Some <span class="bound">u</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span>min <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> 
          None <span class="main">⇒</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
       <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Impl-lowest_tops_alt"><span class="command">lemma</span></span> lowest_tops_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="free">l</span> <span class="main">=</span> lowest_tops_alt <span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lowest_tops.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lowest_tops.simps<span class="main">)</span>

<span class="keyword1" id="Abstract_Impl-lowest_tops_impl_R"><span class="command">lemma</span></span> lowest_tops_impl_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">li</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span>lowest_tops_impl <span class="free">li</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> lowest_tops <span class="free">l</span> <span class="main">∧</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lowest_tops_alt
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowest_tops_impl.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lowest_tops_impl.simps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Id"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> pair_in_Id_conv<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict_top_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">restrict_top_impl</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">vr</span></span></span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
  case_ifexi
    <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
    <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">te</span> <span class="bound">ee</span><span class="main">.</span> return <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vr</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="keyword1">then</span> <span class="bound">te</span> <span class="keyword1">else</span> <span class="bound">ee</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  "</span></span>

<span class="keyword1" id="Abstract_Impl-restrict_top_alt"><span class="command">lemma</span></span> restrict_top_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_top <span class="free">n</span> <span class="free">var</span> <span class="free">val</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">n</span> <span class="keyword1">of</span> 
  <span class="main">(</span>IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">var</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">val</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>IF <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">var</span></span> <span class="quoted"><span class="free">val</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> restrict_top.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Abstract_Impl-restrict_top_impl_spec"><span class="command">lemma</span></span> restrict_top_impl_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span>restrict_top_impl <span class="free">ni</span> <span class="free">vr</span> <span class="free">vl</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">res</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> restrict_top <span class="free">n</span> <span class="free">vr</span> <span class="free">vl</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_top_impl_def restrict_top_alt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>option<span class="main">)</span> <span class="entity">ite_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ite_impl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">lt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> lowest_tops_impl <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lt</span> <span class="keyword1">of</span>
    Some <span class="bound">a</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">ti</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">te</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fi</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">ft</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fe</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s</span><span class="main">;</span>
      <span class="free">IFimpl</span> <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s</span><span class="main">}</span>
  <span class="main">|</span> None <span class="main">⇒</span> case_ifexi <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Impl-ite_impl_R"><span class="command">lemma</span></span> ite_impl_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>
       <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ii</span> <span class="free">i</span> <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ti</span> <span class="free">t</span> <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ei</span> <span class="free">e</span>
       <span class="main">⟹</span> ospec <span class="main">(</span>ite_impl <span class="free">ii</span> <span class="free">ti</span> <span class="free">ei</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> ifex_ite <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quoted"><span class="free">ei</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="skolem">ti</span> <span class="skolem">ei</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal1 <span class="main">=</span> 1
  <span class="keyword1"><span class="command">have</span></span> la2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>in_rel <span class="main">(</span><span class="free">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">,</span><span class="skolem">ti</span><span class="main">,</span><span class="skolem">ei</span><span class="main">]</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal1<span class="main">(</span>4-6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ite_impl.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">s'</span><span class="main">=</span><span class="skolem">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lowest_tops_impl_R<span class="main"><span class="main">[</span></span><span class="operator">OF</span> la2<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> None <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="skolem">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> None <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits ifex.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lowest_tops.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">lv</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> goal1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ite_impl.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lowest_tops_impl_R<span class="main"><span class="main">[</span></span><span class="operator">OF</span> la2<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="comment1">(* take care of all those restrict_tops *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> restrict_top_impl_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IFimpl_rule<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command">using</span></span> les_def les_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Impl-case_ifexi_mono"><span class="command">lemma</span></span> case_ifexi_mono<span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">F</span><span class="main">.</span> <span class="free">fti</span> <span class="bound">F</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">F</span><span class="main">.</span> <span class="free">ffi</span> <span class="bound">F</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x31</span> <span class="bound">x32</span> <span class="bound">x33</span><span class="main">.</span> mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">F</span><span class="main">.</span> <span class="free">fii</span> <span class="bound">F</span> <span class="bound">x31</span> <span class="bound">x32</span> <span class="bound">x33</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">F</span><span class="main">.</span> case_ifexi <span class="main">(</span><span class="free">fti</span> <span class="bound">F</span><span class="main">)</span> <span class="main">(</span><span class="free">ffi</span> <span class="bound">F</span><span class="main">)</span> <span class="main">(</span><span class="free">fii</span> <span class="bound">F</span><span class="main">)</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> case_ifexi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹<span class="entity">Partial_Function.mono_tac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>option<span class="main">)</span> <span class="entity">val_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ni</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span>bool<span class="main">×</span><span class="tfree">'s</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">val_impl</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ass</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> case_ifexi
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Some <span class="main">(</span>True<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Some <span class="main">(</span>False<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> <span class="free">val_impl</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ass</span></span></span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="bound">t</span> <span class="keyword1">else</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ass</span></span></span> <span class="bound">s</span><span class="main">)</span>
  <span class="free"><span class="bound"><span class="entity">e</span></span></span>  <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span>val_impl <span class="free">ni</span> <span class="free">ass</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>val_ifex <span class="free">n</span> <span class="free">ass</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ni</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> val_impl.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Id"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> val_impl.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Id"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> val_impl.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> val_ifex.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> impI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Id"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rprems</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> case_ifexi_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Id"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rprems</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bdd_impl_cmp_pre <span class="main">=</span> bdd_impl_pre
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_invar_impl</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">ii</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="bound">ri</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="bound">ii</span><span class="main">,</span><span class="bound">ti</span><span class="main">,</span><span class="bound">ei</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">ri</span> <span class="main">⟶</span> 
  <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">ri</span><span class="main">,</span>ifex_ite_opt <span class="bound">i</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ii</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ti</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Impl-map_invar_impl_les"><span class="command">lemma</span></span> map_invar_impl_les<span class="main">:</span> <span class="quoted"><span class="quoted">"map_invar_impl <span class="free">m</span> <span class="free">s</span> <span class="main">⟹</span> les <span class="free">s</span> <span class="free">s'</span> <span class="main">⟹</span> map_invar_impl <span class="free">m</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_invar_impl_def bdd_impl_pre.les_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Abstract_Impl-map_invar_impl_update"><span class="command">lemma</span></span> map_invar_impl_update<span class="main">:</span> <span class="quoted"><span class="quoted">"map_invar_impl <span class="free">m</span> <span class="free">s</span> <span class="main">⟹</span> 
       <span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ti</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="free">ri</span><span class="main">,</span> ifex_ite_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> map_invar_impl <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">ti</span><span class="main">,</span><span class="free">ei</span><span class="main">)</span> <span class="main">↦</span> <span class="free">ri</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_invar_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> bdd_impl_cmp <span class="main">=</span> bdd_impl <span class="main">+</span> bdd_impl_cmp_pre <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cmp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cmp_rule1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">cmp</span> <span class="free">ni</span> <span class="free">ni'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cmp_rule2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">cmp</span> <span class="free">ni</span> <span class="free">ni'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> map_invar_rule1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> map_invar_impl <span class="main">(</span><span class="free">M</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> map_invar_rule2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">it</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ti</span><span class="main">,</span><span class="free">tt</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">et</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span>
                            <span class="main">(</span><span class="free">ri</span><span class="main">,</span> ifex_ite_opt <span class="free">it</span> <span class="free">tt</span> <span class="free">et</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">U</span> <span class="free">s</span> <span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">ti</span><span class="main">,</span><span class="free">ei</span><span class="main">)</span> <span class="free">ri</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span>
                            <span class="free">I</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> map_invar_rule3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="free">U</span> <span class="free">s</span> <span class="main">(</span><span class="free">ii</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">ei</span><span class="main">)</span> <span class="free">ri</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Impl-cmp_rule_eq"><span class="command">lemma</span></span> cmp_rule_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span>  <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">cmp</span> <span class="free">ni</span> <span class="free">ni'</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cmp_rule1 cmp_rule2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Abstract_Impl-DESTRimpl_Some"><span class="command">lemma</span></span> DESTRimpl_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> ospec <span class="main">(</span><span class="free">DESTRimpl</span> <span class="free">ni</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ospec_cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> DESTRimpl_rules<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">param_opt_impl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">param_opt_impl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ii</span> <span class="main">←</span> <span class="free">DESTRimpl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
    <span class="bound">ti</span> <span class="main">←</span> <span class="free">DESTRimpl</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
    <span class="bound">ei</span> <span class="main">←</span> <span class="free">DESTRimpl</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">tn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">Timpl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">fn</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">Fimpl</span> <span class="bound">s</span><span class="main">;</span>
    Some <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> TD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> FD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="bound">ti</span> <span class="main">=</span> TD <span class="main">∧</span> <span class="bound">ei</span> <span class="main">=</span> FD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="free">cmp</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="bound">ei</span> <span class="main">=</span> TD <span class="main">∧</span> <span class="free">cmp</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> Some <span class="bound">tn</span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="bound">ti</span> <span class="main">=</span> FD <span class="main">∧</span> <span class="free">cmp</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="bound">fn</span> <span class="keyword1">else</span>
    None<span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> param_opt_impl.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Abstract_Impl-param_opt_impl_lesI"><span class="command">lemma</span></span> param_opt_impl_lesI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ti</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span>param_opt_impl <span class="free">ii</span> <span class="free">ti</span> <span class="free">ei</span> <span class="free">s</span><span class="main">)</span> 
               <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> param_opt_impl.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> param_opt_def les_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> obind_rule
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> DESTRimpl_Some Timpl_rule Fimpl_rule<span class="main">)</span>

<span class="keyword1" id="Abstract_Impl-param_opt_impl_R"><span class="command">lemma</span></span> param_opt_impl_R<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ti</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ospec <span class="main">(</span>param_opt_impl <span class="free">ii</span> <span class="free">ti</span> <span class="free">ei</span> <span class="free">s</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> param_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> None
                                 <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> param_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span>  <span class="main">=</span> Some <span class="bound">r'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> param_opt_impl.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> DESTRimpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Timpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Fimpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> param_opt_def les_def cmp_rule_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ifex.splits<span class="main">)</span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>option<span class="main">)</span> <span class="entity">ite_impl_opt</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ite_impl_opt</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">ld</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span>  param_opt_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ld</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span>
  None <span class="main">⇒</span>
  <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">lt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> lowest_tops_impl <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lt</span> <span class="keyword1">of</span>
    Some <span class="bound">a</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">ti</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">te</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fi</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">ft</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fe</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl_opt</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl_opt</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s</span><span class="main">;</span>
      <span class="free">IFimpl</span> <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s</span><span class="main">}</span>
  <span class="main">|</span> None <span class="main">⇒</span> case_ifexi <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">s</span> 
<span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Impl-ospec_and"><span class="command">lemma</span></span> ospec_and<span class="main">:</span> <span class="quoted"><span class="quoted">"ospec <span class="free">f</span> <span class="free">P</span> <span class="main">⟹</span> ospec <span class="free">f</span> <span class="free">Q</span> <span class="main">⟹</span> ospec <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ospecD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Abstract_Impl-ite_impl_opt_R"><span class="command">lemma</span></span> ite_impl_opt_R<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">I</span> <span class="free">s</span>
  <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ii</span> <span class="free">i</span> <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ti</span> <span class="free">t</span> <span class="main">⟹</span> in_rel <span class="main">(</span><span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="free">ei</span> <span class="free">e</span>
  <span class="main">⟹</span> ospec <span class="main">(</span>ite_impl_opt <span class="free">ii</span> <span class="free">ti</span> <span class="free">ei</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> ifex_ite_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quoted"><span class="free">ei</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ifex_ite_opt.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> restrict_top.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="skolem">ti</span> <span class="skolem">ei</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal1 <span class="main">=</span> 1
  <span class="keyword1"><span class="command">have</span></span> la2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>in_rel <span class="main">(</span><span class="free">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">,</span><span class="skolem">ti</span><span class="main">,</span><span class="skolem">ei</span><span class="main">]</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal1<span class="main">(</span>4-6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> goal1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"param_opt <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ite_impl_opt.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_and<span class="main"><span class="main">[</span></span><span class="operator">OF</span> param_opt_impl_R param_opt_impl_lesI<span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def ifex_ite_opt.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>9<span class="main"><span class="keyword3">]</span></span>
    <span class="comment1">(* param_opt i t e = None *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> param_opt_lowest_tops_lem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ite_impl_opt.simps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_and<span class="main"><span class="main">[</span></span><span class="operator">OF</span> param_opt_impl_R param_opt_impl_lesI<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>8<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lowest_tops_impl_R<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> les_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> BDT.param_opt_lowest_tops_lem <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="comment1">(* take care of all those restrict_tops *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> restrict_top_impl_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IFimpl_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>option<span class="main">)</span> <span class="entity">ite_impl_lu</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ite_impl_lu</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">M</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">ld</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span>  param_opt_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ld</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span>
  None <span class="main">⇒</span>
  <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">lt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> lowest_tops_impl <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lt</span> <span class="keyword1">of</span>
    Some <span class="bound">a</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">ti</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tt</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">te</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fi</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">ft</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fe</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> restrict_top_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl_lu</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">ite_impl_lu</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">IFimpl</span> <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">U</span> <span class="bound">s</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
      Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span>
      <span class="main">}</span> <span class="main">|</span>
    None <span class="main">⇒</span> None
<span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> ifex_ite_opt.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Abstract_Impl-ite_impl_lu_R"><span class="command">lemma</span></span> ite_impl_lu_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>
       <span class="main">⟹</span> <span class="main">(</span><span class="free">ii</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ti</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">s</span>
       <span class="main">⟹</span> ospec <span class="main">(</span>ite_impl_lu <span class="free">ii</span> <span class="free">ti</span> <span class="free">ei</span> <span class="free">s</span><span class="main">)</span> 
                 <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> ifex_ite_opt <span class="free">i</span> <span class="free">t</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> les <span class="free">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quoted"><span class="free">ei</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> restrict_top.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">s</span> <span class="skolem">ii</span> <span class="skolem">ti</span> <span class="skolem">ei</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal1 <span class="main">=</span> 1
  <span class="keyword1"><span class="command">have</span></span> la2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>in_rel <span class="main">(</span><span class="free">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">,</span><span class="skolem">ti</span><span class="main">,</span><span class="skolem">ei</span><span class="main">]</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal1<span class="main">(</span>4-6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> goal1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ite_impl_lu.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ii</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">ei</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="comment1">(* M s (ii, ti, ei) = Some a *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> map_invar_rule1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> option.simps ospec.simps prod.simps simp_thms les_refl<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> map_invar_impl_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">ii</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">ti</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">ei</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> a<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> cmp_rule_eq<span class="main">)</span>
    <span class="comment1">(* M s (ii, ti, ei) = Some a *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"param_opt <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="comment1">(* param_opt i t e = Some a *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_and<span class="main"><span class="main">[</span></span><span class="operator">OF</span> param_opt_impl_R param_opt_impl_lesI<span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_invar_impl_les ifex_ite_opt.simps  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>9<span class="main"><span class="keyword3">]</span></span>
    <span class="comment1">(* param_opt i t e = None *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> param_opt_lowest_tops_lem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_and<span class="main"><span class="main">[</span></span><span class="operator">OF</span> param_opt_impl_R param_opt_impl_lesI<span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>8<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> obind_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> lowest_tops <span class="main">[</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ospec_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lowest_tops_impl_R<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> les_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> BDT.param_opt_lowest_tops_lem <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> restrict_top_impl_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_invar_impl_les les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mIH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_invar_impl_les les_def<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obind_rule<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> IFimpl_rule<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> les_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> map_invar_rule3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">presburger</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> map_invar_rule2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 6 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> map_invar_rule3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pointer_Map">
<div class="head">
<h1>Theory Pointer_Map</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Pointermap›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pointer_Map
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  We need a datastructure that supports the following two operations:
  \begin{itemize}
    \item Given an element, it can construct a pointer (i.e., a small representation) of that element. It will always construct the same pointer for equal elements.
    \item Given a pointer, we can retrieve the element
  \end{itemize}
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> pointermap <span class="main">=</span> 
  entries <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  getentry <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat option"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pointermap_sane</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span>distinct <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">.</span> getentry <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> getentry <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">⟶</span> entries <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_pointermap</span> <span class="main">≡</span> <span class="main">⦇</span>entries <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> getentry <span class="main">=</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> None <span class="main">⦈</span>"</span></span>
<span class="keyword1" id="Pointer_Map-pointermap_empty_sane"><span class="command">lemma</span></span> pointermap_empty_sane<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane empty_pointermap"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> empty_pointermap_def pointermap_sane_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pointermap_insert</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>entries <span class="main">=</span> <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> <span class="main">(</span>getentry <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pm_pth</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> entries <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pointermap_p_valid</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pointermap_getmk</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> getentry <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> pointermap_insert <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>the <span class="main">(</span>getentry <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1" id="Pointer_Map-pointermap_sane_appendD"><span class="command">lemma</span></span> pointermap_sane_appendD<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">s</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> pointermap_sane <span class="main">(</span>pointermap_insert <span class="free">m</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pointermap_sane_def pointermap_insert_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">⟦</span>distinct <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span> getentry <span class="free">s</span> <span class="main">(</span>entries <span class="free">s</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> getentry <span class="free">s</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">⟶</span> entries <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">;</span>
          <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span>entries <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">⟧</span>
         <span class="main">⟹</span> getentry <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">(</span>entries <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">⟦</span>distinct <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span> getentry <span class="free">s</span> <span class="main">(</span>entries <span class="free">s</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> getentry <span class="free">s</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">⟶</span> entries <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">;</span>
          <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span>entries <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="main">¬</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">⟧</span>
         <span class="main">⟹</span> getentry <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">(</span>entries <span class="main">⦇</span>entries <span class="main">=</span> entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">,</span> getentry <span class="main">=</span> getentry <span class="free">s</span><span class="main">(</span><span class="free">m</span> <span class="main">↦</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">note</span></span> goal1 <span class="main">=</span> 1
        <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>entries <span class="free">s</span> <span class="main">@</span> <span class="bound">a</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> entries <span class="free">s</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"getentry <span class="free">s</span> <span class="main">(</span>entries <span class="free">s</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> goal1<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"entries <span class="free">s</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> sa ih ne <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">note</span></span> goal2 <span class="main">=</span> 2
        <span class="keyword1"><span class="command">from</span></span> goal2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>entries <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> sa ln <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> h <span class="main">=</span> this
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="comment1">(*apply(unfold Ball_def) 
    apply(rule)
    apply(rule)
    apply(rename_tac n)
    apply(case_tac "n &lt; length (entries s)")
  by(fact h)+*)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append fun_upd_same Ball_def<span class="main">)</span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pointer_Map-luentries_noneD"><span class="command">lemma</span></span> luentries_noneD<span class="main">:</span> <span class="quoted"><span class="quoted">"getentry <span class="free">s</span> <span class="free">a</span> <span class="main">=</span> None <span class="main">⟹</span> pointermap_sane <span class="free">s</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pointermap_sane_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>entries <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"entries <span class="free">s</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pointer_Map-pm_pth_append"><span class="command">lemma</span></span> pm_pth_append<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">m</span> <span class="main">⟹</span> pm_pth <span class="main">(</span>pointermap_insert <span class="free">a</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> pm_pth <span class="free">m</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pointermap_p_valid_def pm_pth_def pointermap_insert_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_insert_in"><span class="command">lemma</span></span> pointermap_insert_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">(</span>pointermap_insert <span class="free">a</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> pm_pth <span class="free">u</span> <span class="main">(</span>the <span class="main">(</span>getentry <span class="free">u</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pointermap_insert_def pm_pth_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_insert_p_validI"><span class="command">lemma</span></span> pointermap_insert_p_validI<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">m</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p</span> <span class="main">(</span>pointermap_insert <span class="free">a</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pointermap_insert_def pointermap_p_valid_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> nth_eq_iff_index_eq
<span class="keyword1" id="Pointer_Map-pth_eq_iff_index_eq"><span class="command">lemma</span></span> pth_eq_iff_index_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p1</span> <span class="free">m</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p2</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span>pm_pth <span class="free">m</span> <span class="free">p1</span> <span class="main">=</span> pm_pth <span class="free">m</span> <span class="free">p2</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">p1</span> <span class="main">=</span> <span class="free">p2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pointermap_sane_def pointermap_p_valid_def pm_pth_def
  <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1" id="Pointer_Map-pointermap_p_valid_updateI"><span class="command">lemma</span></span> pointermap_p_valid_updateI<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span> <span class="main">⟹</span> getentry <span class="free">m</span> <span class="free">a</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> pointermap_insert <span class="free">a</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> the <span class="main">(</span>getentry <span class="free">u</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointermap_sane_def pointermap_p_valid_def pointermap_insert_def<span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_get_validI"><span class="command">lemma</span></span> pointermap_get_validI<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span> <span class="main">⟹</span> getentry <span class="free">m</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointermap_sane_def pointermap_p_valid_def<span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_sane_getmkD"><span class="command">lemma</span></span> pointermap_sane_getmkD<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">u</span> <span class="main">∧</span> pointermap_p_valid <span class="free">p</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sn res<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"getentry <span class="free">m</span> <span class="free">a</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointermap_getmk_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pointermap_sane_appendD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> luentries_noneD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pointermap_p_valid_updateI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ refl refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pointermap_get_validI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pointer_Map-pointermap_update_pthI"><span class="command">lemma</span></span> pointermap_update_pthI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pm_pth <span class="free">u</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointermap_getmk_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">meson</span> pointermap_insert_in<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointermap_sane_def pm_pth_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pointer_Map-pointermap_p_valid_inv"><span class="command">lemma</span></span> pointermap_p_valid_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointermap_getmk_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> pointermap_insert_p_validI<span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_p_pth_inv"><span class="command">lemma</span></span> pointermap_p_pth_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pv<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pm_pth <span class="free">u</span> <span class="free">p</span> <span class="main">=</span> pm_pth <span class="free">m</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pm_pth_append<span class="main">[</span><span class="operator">OF</span> pv<span class="main">]</span> u
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointermap_getmk_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Pointer_Map-pointermap_backward_valid"><span class="command">lemma</span></span> pointermap_backward_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> puv<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="free">p</span> <span class="free">m</span>"</span></span>
<span class="comment1">(*using u
unfolding pointermap_getmk_def
apply(simp add: Let_def split: option.splits)
prefer 2 using puv apply(simp)
apply(clarify)
apply(simp add: pointermap_insert_def)
using puv apply(clarify)
apply(simp add: pointermap_p_valid_def)
using ne by linarith
*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def pointermap_getmk_def pointermap_p_valid_def pointermap_insert_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Middle_Impl">
<div class="head">
<h1>Theory Middle_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Functional interpretation for the abstract implementation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Middle_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Abstract_Impl">Abstract_Impl</a> <a href="#Pointer_Map">Pointer_Map</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For the lack of a better name, the suffix mi stands for middle-implementation. 
This relects that this ``implementation'' is neither entirely abstract,
nor has it been made fully concrete: the data structures are decided, but not their implementations.›</span></span>

<span class="keyword1"><span class="command">record</span></span> bdd <span class="main">=</span>
  dpm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> pointermap"</span></span>
  dcl <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">,</span>nat<span class="main">)</span> map"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">emptymi</span> <span class="main">≡</span> <span class="main">⦇</span>dpm <span class="main">=</span> empty_pointermap<span class="main">,</span> dcl <span class="main">=</span> Map.empty<span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">destrmi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bdd <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> IFEXD"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">destrmi</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> FD"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">destrmi</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> TD"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">destrmi</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> pm_pth <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tmi</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tmi</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fmi</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fmi</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifmi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bdd <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> bdd<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ifmi</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> 
  <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> 
  <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">pm</span><span class="main">)</span> <span class="main">=</span> pointermap_getmk <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
  <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">,</span> dpm_update <span class="main">(</span>const <span class="bound">pm</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Rmi_g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat ifex <span class="main">⇒</span> bdd <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Rmi_g</span> <span class="main">0</span> Falseif <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Rmi_g</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> Trueif <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Rmi_g</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IF <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="main">(</span>pointermap_p_valid <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> pm_pth <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">nv</span><span class="main">,</span> <span class="bound">nt</span><span class="main">,</span> <span class="bound">ne</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">nv</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> <span class="free">Rmi_g</span> <span class="bound">nt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">∧</span> <span class="free">Rmi_g</span> <span class="bound">ne</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Rmi_g</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rmi</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">|</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> Rmi_g <span class="bound">a</span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> mi_pre<span class="main">:</span> bdd_impl_cmp_pre <span class="quoted">Rmi</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bdd_node_valid</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> Domain <span class="main">(</span>Rmi <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">bdd</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">bdd</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_node_valid_def Rmi_def<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> Rmi_g.simps<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifexd_valid</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> IFD <span class="main"><span class="bound">_</span></span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> bdd_node_valid <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="bound">t</span> <span class="main">∧</span> bdd_node_valid <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="bound">e</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bdd_sane</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> pointermap_sane <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="main">∧</span> mi_pre.map_invar_impl <span class="main">(</span>dcl <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane emptymi"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> emptymi_def bdd_sane_def bdd.simps 
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi_pre.map_invar_impl_def<span class="main">)</span>

<span class="keyword1" id="Middle_Impl-prod_split3"><span class="command">lemma</span></span> prod_split3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">,</span> <span class="bound">xaa</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x1</span><span class="main">,</span> <span class="bound">x2</span><span class="main">,</span> <span class="bound">x3</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Middle_Impl-IfI"><span class="command">lemma</span></span> IfI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Middle_Impl-fstsndI"><span class="command">lemma</span></span> fstsndI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> snd <span class="free">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">thm</span></span> nat.split
<span class="keyword1" id="Middle_Impl-Rmi_g_2_split"><span class="command">lemma</span></span> Rmi_g_2_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Rmi_g <span class="free">n</span> <span class="free">x</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> Falseif <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Rmi_g <span class="free">n</span> <span class="free">x</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Trueif <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Rmi_g <span class="free">n</span> <span class="free">x</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">vs</span> <span class="bound">ts</span> <span class="bound">es</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> IF <span class="bound">vs</span> <span class="bound">ts</span> <span class="bound">es</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Rmi_g <span class="free">n</span> <span class="free">x</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Middle_Impl-rmigeq"><span class="command">lemma</span></span> rmigeq<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="free">ni1</span> <span class="free">n1</span> <span class="free">s</span> <span class="main">⟹</span> Rmi_g <span class="free">ni2</span> <span class="free">n2</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">ni1</span> <span class="main">=</span> <span class="free">ni2</span> <span class="main">⟹</span> <span class="free">n1</span> <span class="main">=</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ni1</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n2</span></span> <span class="quoted"><span class="free">ni2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">bdd</span> <span class="skolem">n2</span> <span class="skolem">ni2</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal3 <span class="main">=</span> 3
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> goal3<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">bdd</span>"</span></span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span> <span class="skolem">bdd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ refl<span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ refl<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> IF <span class="skolem">v2</span> <span class="skolem">t2</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Rmi_g.simps<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> goal3<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n2</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v2 goal3<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mIH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rename_tac</span> n2 ni2<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Middle_Impl-rmigneq"><span class="command">lemma</span></span> rmigneq<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span> <span class="main">⟹</span> Rmi_g <span class="free">ni1</span> <span class="free">n1</span> <span class="free">s</span> <span class="main">⟹</span> Rmi_g <span class="free">ni2</span> <span class="free">n2</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">ni1</span> <span class="main">≠</span> <span class="free">ni2</span> <span class="main">⟹</span> <span class="free">n1</span> <span class="main">≠</span> <span class="free">n2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ni1</span></span> <span class="quoted"><span class="free">n1</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n2</span></span> <span class="quoted"><span class="free">ni2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rmi_g.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> old.nat.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rmi_g.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span> old.nat.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">bdd</span> <span class="skolem">n2</span> <span class="skolem">ni2</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal3 <span class="main">=</span> 3
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bddpth</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> goal3<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prod.collapse prod.collapse<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">bdd</span>"</span></span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span> <span class="skolem">bdd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> goal3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> goal3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ni2</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">ni2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ni2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> Falseif"</span></span> <span class="keyword1"><span class="command">using</span></span> rmigeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* honestly, I'm puzzled how this works… *)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">ni2</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ni2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> Trueif"</span></span> <span class="keyword1"><span class="command">using</span></span> rmigeq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">ni2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ni2s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ni2</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">ni2s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> One_nat_def <span class="keyword1"><span class="command">using</span></span> less_imp_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> IF <span class="skolem">v2</span> <span class="skolem">t2</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ni2</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">,</span> <span class="skolem">bdd</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.cases<span class="main">)</span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t2</span> <span class="skolem">bdd</span>"</span></span> <span class="quoted"><span class="quoted">"Rmi_g <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e2</span> <span class="skolem">bdd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> v2
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="var">?bddpth</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ni2s</span> <span class="main">≠</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="skolem">n</span> <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"pointermap_p_valid <span class="skolem">ni2s</span> <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Rmi_g.simps<span class="main">(</span>3<span class="main">)</span> goal3<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">assume</span></span> goal1<span class="main">:</span>
        <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">ni2s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bddpth</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?bddpth</span> <span class="skolem">ni2s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_eq_iff <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>4<span class="main">)</span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> goal3<span class="main">(</span>3<span class="main">)</span> ne <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_sane_def <span class="keyword1"><span class="command">using</span></span> pth_eq_iff_index_eq<span class="main">[</span><span class="operator">OF</span> _ ib<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"IF <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="main">≠</span> IF <span class="skolem">v2</span> <span class="skolem">t2</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mIH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> 4<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> mIH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> 4<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Middle_Impl-ifmi_les_hlp"><span class="command">lemma</span></span> ifmi_les_hlp<span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="main">(</span>dpm <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> pointermap_getmk <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">ni1</span><span class="main">,</span> <span class="free">ni2</span><span class="main">)</span> <span class="main">(</span>dpm <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x1</span><span class="main">,</span> dpm <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> Rmi_g <span class="free">nia</span> <span class="free">n</span> <span class="free">s</span> <span class="main">⟹</span> Rmi_g <span class="free">nia</span> <span class="free">n</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nia</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">e</span> <span class="skolem">bdd</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal3 <span class="main">=</span> 3
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1a</span></span> <span class="skolem"><span class="skolem">x2a</span></span> <span class="keyword2"><span class="keyword">where</span></span> pth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pm_pth <span class="main">(</span>dpm <span class="skolem">bdd</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">x1a</span><span class="main">,</span> <span class="skolem">x2a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> pth'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pm_pth <span class="main">(</span>dpm <span class="free">s'</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">x1a</span><span class="main">,</span> <span class="skolem">x2a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pth<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> goal3<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Rmi_g.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> pointermap_p_pth_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mIH <span class="main">=</span> goal3<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> pth<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> refl goal3<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> goal3<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Rmi_g.simps
    <span class="keyword1"><span class="command">using</span></span> pointermap_p_valid_inv<span class="main">[</span><span class="operator">OF</span> _ goal3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> mIH
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1" id="Middle_Impl-ifmi_les"><span class="command">lemma</span></span> ifmi_les<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mi_pre.les <span class="free">s</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_sane_def comp_def apfst_def map_prod_def mi_pre.les_def Rmi_def ifmi_les_hlp <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1" id="Middle_Impl-ifmi_notouch_dcl"><span class="command">lemma</span></span> ifmi_notouch_dcl<span class="main">:</span> <span class="quoted"><span class="quoted">"ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> dcl <span class="free">s'</span> <span class="main">=</span> dcl <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1" id="Middle_Impl-ifmi_saneI"><span class="command">lemma</span></span> ifmi_saneI<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span> <span class="main">⟹</span> ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> bdd_sane <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bdd_sane_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def apfst_def map_prod_def bdd_sane_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointermap_sane_getmkD<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"dpm <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">ni1</span><span class="main">,</span> <span class="free">ni2</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ifmi_les<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_sane_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> mi_pre.map_invar_impl_les<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ifmi_notouch_dcl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Middle_Impl-rmigif"><span class="command">lemma</span></span> rmigif<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="free">ni</span> <span class="main">(</span>IF <span class="free">v</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">ni</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ni</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> nis<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">nis</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Middle_Impl-in_lesI"><span class="command">lemma</span></span> in_lesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mi_pre.les <span class="free">s</span> <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni1</span><span class="main">,</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni2</span><span class="main">,</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni1</span><span class="main">,</span> <span class="free">n1</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni2</span><span class="main">,</span> <span class="free">n2</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms mi_pre.les_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="Middle_Impl-ifmi_modification_validI"><span class="command">lemma</span></span> ifmi_modification_validI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sane<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ifm<span class="main">:</span> <span class="quoted"><span class="quoted">"ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vld<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">s</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">s'</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ni1</span> <span class="main">=</span> <span class="free">ni2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> ifm vld <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">from</span></span> ifm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="main">_</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pointermap_p_pth_inv pointermap_p_valid_inv <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apfst_def map_prod_def False Rmi_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> vld <span class="keyword1"><span class="command">unfolding</span></span> bdd_node_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tmi'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>oassert <span class="main">(</span>bdd_sane <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span> Some <span class="main">(</span>tmi <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fmi'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>oassert <span class="main">(</span>bdd_sane <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span> Some <span class="main">(</span>fmi <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifmi'</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ni1</span></span></span> <span class="free"><span class="bound"><span class="entity">ni2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>oassert <span class="main">(</span>bdd_sane <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> bdd_node_valid <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ni1</span></span></span> <span class="main">∧</span> bdd_node_valid <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ni2</span></span></span><span class="main">)</span><span class="main">;</span> Some <span class="main">(</span>ifmi <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ni1</span></span></span> <span class="free"><span class="bound"><span class="entity">ni2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Middle_Impl-ifmi'_spec"><span class="command">lemma</span></span> ifmi'_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bdd_sane <span class="free">s</span><span class="main">;</span> bdd_node_valid <span class="free">s</span> <span class="free">ni1</span><span class="main">;</span> bdd_node_valid <span class="free">s</span> <span class="free">ni2</span><span class="main">⟧</span> <span class="main">⟹</span> ospec <span class="main">(</span>ifmi' <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ifmi'_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>
<span class="keyword1" id="Middle_Impl-ifmi'_ifmi"><span class="command">lemma</span></span> ifmi'_ifmi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bdd_sane <span class="free">s</span><span class="main">;</span> bdd_node_valid <span class="free">s</span> <span class="free">ni1</span><span class="main">;</span> bdd_node_valid <span class="free">s</span> <span class="free">ni2</span><span class="main">⟧</span> <span class="main">⟹</span> ifmi' <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span>ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ifmi'_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">destrmi'</span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>oassert <span class="main">(</span>bdd_sane <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> bdd_node_valid <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span><span class="main">)</span><span class="main">;</span> Some <span class="main">(</span>destrmi <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Middle_Impl-destrmi_someD"><span class="command">lemma</span></span> destrmi_someD<span class="main">:</span> <span class="quoted"><span class="quoted">"destrmi' <span class="free">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> bdd_sane <span class="free">bdd</span> <span class="main">∧</span> bdd_node_valid <span class="free">bdd</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> destrmi'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>

<span class="keyword1" id="Middle_Impl-Rmi_sv"><span class="command">lemma</span></span> Rmi_sv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ni</span><span class="main">=</span><span class="free">ni'</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">=</span><span class="free">n'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ni</span><span class="main">≠</span><span class="free">ni'</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">≠</span><span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rmi_def<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> rmigeq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rmigneq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>

<span class="keyword1" id="Middle_Impl-True_rep"><span class="command">lemma</span></span> True_rep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span>Trueif<span class="main">)</span><span class="main">∈</span>Rmi <span class="free">s</span> <span class="main">⟷</span> <span class="free">ni</span><span class="main">=</span>Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rmi_def Rmi_g.simps<span class="main">(</span>2<span class="main">)</span> Rmi_sv<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Middle_Impl-False_rep"><span class="command">lemma</span></span> False_rep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span>Falseif<span class="main">)</span><span class="main">∈</span>Rmi <span class="free">s</span> <span class="main">⟷</span> <span class="free">ni</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rmi_def Rmi_g.simps<span class="main">(</span>1<span class="main">)</span> Rmi_sv<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">updS</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> dcl_update <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">thm</span></span> Rmi_g.induct

<span class="keyword1" id="Middle_Impl-updS_dpm"><span class="command">lemma</span></span> updS_dpm<span class="main">:</span> <span class="quoted"><span class="quoted">"dpm <span class="main">(</span>updS <span class="free">s</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> dpm <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> updS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Middle_Impl-updS_Rmi_g"><span class="command">lemma</span></span> updS_Rmi_g<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi_g <span class="free">n</span> <span class="free">i</span> <span class="main">(</span>updS <span class="free">s</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Rmi_g <span class="free">n</span> <span class="free">i</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Rmi_g.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> updS_dpm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Middle_Impl-updS_Rmi"><span class="command">lemma</span></span> updS_Rmi<span class="main">:</span> <span class="quoted"><span class="quoted">"Rmi <span class="main">(</span>updS <span class="free">s</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Rmi <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Rmi_def updS_Rmi_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">interpretation</span></span> mi<span class="main">:</span> bdd_impl_cmp <span class="quoted">bdd_sane</span> <span class="quoted">Rmi</span> <span class="quoted">tmi'</span> <span class="quoted">fmi'</span> <span class="quoted">ifmi'</span> <span class="quoted">destrmi'</span> <span class="quoted">dcl</span> <span class="quoted">updS</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>  <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> mi_pre.les_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Rmi_def

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> tmi'_def fmi'_def ifmi'_def destrmi'_def apfst_def map_prod_def

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bdd_impl_cmp bdd_sane Rmi tmi' fmi' ifmi' destrmi' dcl updS <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rmi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rmi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">ni1</span> <span class="skolem">n1</span> <span class="skolem">ni2</span> <span class="skolem">n2</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> goal3 <span class="main">=</span> 3
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Rmi_sv<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> <span class="skolem">n2</span> <span class="main">⟹</span> <span class="skolem">ni1</span> <span class="main">=</span> <span class="skolem">ni2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ni</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ifmi' <span class="skolem">v</span> <span class="skolem">ni1</span> <span class="skolem">ni2</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ni</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ifmi'_def bdd_node_valid_def <span class="keyword1"><span class="command">using</span></span> goal3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DomainI <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifmi.simps<span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> ifm<span class="main">:</span> <span class="quoted"><span class="quoted">"ifmi <span class="skolem">v</span> <span class="skolem">ni1</span> <span class="skolem">ni2</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ni</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> goal3 <span class="keyword1"><span class="command">unfolding</span></span> ifmi'_def bdd_node_valid_def  
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DomainI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ifmi'_ospec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ospec <span class="main">(</span>ifmi' <span class="skolem">v</span> <span class="skolem">ni1</span> <span class="skolem">ni2</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">P</span> <span class="main">⟷</span> <span class="bound">P</span> <span class="main">(</span>ifmi <span class="skolem">v</span> <span class="skolem">ni1</span> <span class="skolem">ni2</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifmi'_def ifmi.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> goal3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ifmi'_ospec
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">split</span> prod.splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="comment1">(* for the first thing, we don't have a helper lemma *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rmi_def IFC_def bdd_sane_def ifmi_les_hlp pointermap_sane_getmkD pointermap_update_pthI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
      <span class="comment1">(* for the rest, we do *)</span>
      <span class="keyword1"><span class="command">using</span></span> ifmi_les<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bdd_sane <span class="skolem">s</span>›</span></span> ifm<span class="main">]</span> ifmi_saneI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bdd_sane <span class="skolem">s</span>›</span></span> ifm<span class="main">]</span> ifm <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_node_valid_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rmi_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Rmi_g.elims<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Rmi_sv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 8 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Rmi_sv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 9 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_sane_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_sane_def mi_pre.map_invar_impl_def <span class="keyword1"><span class="command">using</span></span> updS_Rmi
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> updS_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite_opt.simps<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 11 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> updS_Rmi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Middle_Impl-p_valid_RmiI"><span class="command">lemma</span></span> p_valid_RmiI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">na</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">bdd</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">na</span> <span class="main">(</span>dpm <span class="free">bdd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Rmi_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Middle_Impl-n_valid_RmiI"><span class="command">lemma</span></span> n_valid_RmiI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">na</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">bdd</span> <span class="main">⟹</span> bdd_node_valid <span class="free">bdd</span> <span class="free">na</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bdd_node_valid_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> DomainI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1" id="Middle_Impl-n_valid_Rmi_alt"><span class="command">lemma</span></span> n_valid_Rmi_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">bdd</span> <span class="free">na</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">na</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">bdd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bdd_node_valid_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  
<span class="keyword1" id="Middle_Impl-ifmi_result_validI"><span class="command">lemma</span></span> ifmi_result_validI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sane<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_sane <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vld<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">s</span> <span class="free">ni1</span>"</span></span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">s</span> <span class="free">ni2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ifm<span class="main">:</span> <span class="quoted"><span class="quoted">"ifmi <span class="free">v</span> <span class="free">ni1</span> <span class="free">ni2</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">ni</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_node_valid <span class="free">s'</span> <span class="free">ni</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vld <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni1</span><span class="main">,</span> <span class="skolem">n1</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ni2</span><span class="main">,</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_node_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> mi.IFimpl_rule<span class="main">[</span><span class="operator">OF</span> sane this<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">unfolded</span> ifmi'_ifmi<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sane vld<span class="main"><span class="main">]</span></span> ospec.simps<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">,</span> <span class="operator">unfolded</span> ifm<span class="main">,</span> <span class="operator">unfolded</span> prod.simps<span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_node_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Array_List">
<div class="head">
<h1>Theory Array_List</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Array List›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Most of this has been contributed by Peter Lammich.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Array_List
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../separation_logic_imperative_hol/theories/#Array_Blit">Separation_Logic_Imperative_HOL.Array_Blit</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
    This implements a datastructure that efficiently supports two operations: appending an element and looking up the nth element. 
  The implementation is straightforward.
›</span></span>
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
    As underlying data structure an array is used.
  Since changing the length of an array requires copying, we double the size whenever the array needs to be expanded.
  We use a counter for the current length to track which elements are used and which are spares.
›</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> array_list <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array <span class="main">×</span> nat"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_array_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">l'</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n</span> <span class="main">≤</span> length <span class="bound">l'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> take <span class="bound">n</span> <span class="bound">l'</span> <span class="main">∧</span> length <span class="bound">l'</span><span class="main">&gt;</span><span class="main">0</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">initial_capacity</span> <span class="main">≡</span> <span class="numeral">16</span><span class="main">::</span>nat"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">arl_empty</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">←</span> Array.new initial_capacity default<span class="main">;</span>
    return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="keyword1">emp</span> <span class="main">&gt;</span> arl_empty <span class="main">&lt;</span>is_array_list <span class="main">[]</span><span class="main">&gt;</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arl_empty_def is_array_list_def initial_capacity_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">arl_nth</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    Array.nth <span class="bound">a</span> <span class="bound">i</span>
  <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span> <span class="main">&lt;</span> is_array_list <span class="free">l</span> <span class="free">a</span> <span class="main">&gt;</span> arl_nth <span class="free">a</span> <span class="free">i</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> is_array_list <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arl_nth_def is_array_list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">arl_append</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">len</span> <span class="main">←</span> Array.len <span class="bound">a</span><span class="main">;</span>

    <span class="keyword1">if</span> <span class="bound">n</span><span class="main">&lt;</span><span class="bound">len</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">←</span> Array.upd <span class="bound">n</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">newcap</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">len</span><span class="main">;</span>
      <span class="bound">a</span> <span class="main">←</span> array_grow <span class="bound">a</span> <span class="bound">newcap</span> default<span class="main">;</span>
      <span class="bound">a</span> <span class="main">←</span> Array.upd <span class="bound">n</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">&lt;</span> is_array_list <span class="free">l</span> <span class="free">a</span> <span class="main">&gt;</span> 
      arl_append <span class="free">a</span> <span class="free">x</span> 
    <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> is_array_list <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">a</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arl_append_def is_array_list_def take_update_last neq_Nil_conv
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.split<span class="main">)</span>
    
  <span class="keyword1" id="Array_List-is_array_list_prec"><span class="command">lemma</span></span> is_array_list_prec<span class="main">:</span> <span class="quoted"><span class="quoted">"precise is_array_list"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_array_list_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> preciseI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> preciseD snga_prec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    
  <span class="keyword1" id="Array_List-is_array_list_lengthIA"><span class="command">lemma</span></span> is_array_list_lengthIA<span class="main">:</span> <span class="quoted"><span class="quoted">"is_array_list <span class="free">l</span> <span class="free">li</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">↑</span><span class="main">(</span>snd <span class="free">li</span> <span class="main">=</span> length <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">true</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_array_list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">find_consts</span></span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword1" id="Array_List-is_array_list_lengthI"><span class="command">lemma</span></span> is_array_list_lengthI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊨</span> is_array_list <span class="free">l</span> <span class="free">li</span> <span class="main">⟹</span> snd <span class="free">li</span> <span class="main">=</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_array_list_lengthIA <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ent_pure_post_iff star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pointer_Map_Impl">
<div class="head">
<h1>Theory Pointer_Map_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Imparative implementation for Pointermap›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pointer_Map_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Array_List">Array_List</a> 
  <a href="../../separation_logic_imperative_hol/theories/#Sep_Main">Separation_Logic_Imperative_HOL.Sep_Main</a>
  <a href="../../separation_logic_imperative_hol/theories/#Hash_Map_Impl">Separation_Logic_Imperative_HOL.Hash_Map_Impl</a>
  <a href="#Pointer_Map">Pointer_Map</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> pointermap_impl <span class="main">=</span>
    entriesi <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array_list"</span></span>
    getentryi <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span>nat<span class="main">)</span> hashtable"</span></span>
  <span class="keyword1" id="Pointer_Map_Impl-pointermapieq_exhaust"><span class="command">lemma</span></span> pointermapieq_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"entries <span class="free">a</span> <span class="main">=</span> entries <span class="free">b</span> <span class="main">⟹</span> getentry <span class="free">a</span> <span class="main">=</span> getentry <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> pointermap<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_pointermap_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>hashable<span class="main">,</span>heap<span class="main">}</span><span class="main">)</span> pointermap <span class="main">⇒</span> <span class="tfree">'a</span> pointermap_impl <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_pointermap_impl</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bi</span></span></span> <span class="main">≡</span> 
      is_array_list <span class="main">(</span>entries <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>entriesi <span class="free"><span class="bound"><span class="entity">bi</span></span></span><span class="main">)</span> 
    <span class="main">*</span> is_hashmap <span class="main">(</span>getentry <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>getentryi <span class="free"><span class="bound"><span class="entity">bi</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Pointer_Map_Impl-is_pointermap_impl_prec"><span class="command">lemma</span></span> is_pointermap_impl_prec<span class="main">:</span> <span class="quoted"><span class="quoted">"precise is_pointermap_impl"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_pointermap_impl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> preciseI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> a a' x y p F F'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pointermapieq_exhaust<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"entriesi <span class="improper">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> preciseD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_array_list_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> star_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"getentryi <span class="improper">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> preciseD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_hashmap_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* black unfold magic *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointermap_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pointermap_empty</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">hm</span> <span class="main">←</span> hm_new<span class="main">;</span>
      <span class="bound">arl</span> <span class="main">←</span> arl_empty<span class="main">;</span>
      return <span class="main">⦇</span>entriesi <span class="main">=</span> <span class="bound">arl</span><span class="main">,</span> getentryi <span class="main">=</span> <span class="bound">hm</span> <span class="main">⦈</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="keyword1">emp</span> <span class="main">&gt;</span> pointermap_empty <span class="main">&lt;</span>is_pointermap_impl empty_pointermap<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_pointermap_impl_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointermap_empty_def empty_pointermap_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">pm_pthi</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pm_pthi</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> arl_nth <span class="main">(</span>entriesi <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span> <span class="main">⟹</span> pointermap_p_valid <span class="free">p</span> <span class="free">m</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pointermap_impl <span class="free">m</span> <span class="free">mi</span> <span class="main">&gt;</span> pm_pthi <span class="free">mi</span> <span class="free">p</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">ai</span><span class="main">.</span> is_pointermap_impl <span class="free">m</span> <span class="free">mi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">ai</span> <span class="main">=</span> pm_pth <span class="free">m</span> <span class="free">p</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pm_pthi_def pm_pth_def is_pointermap_impl_def pointermap_p_valid_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointermap_getmki</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pointermap_getmki</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">lo</span> <span class="main">←</span> ht_lookup <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>getentryi <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lo</span> <span class="keyword1">of</span> 
          Some <span class="bound">l</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">|</span> 
          None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">p</span> <span class="main">←</span> return <span class="main">(</span>snd <span class="main">(</span>entriesi <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">ent</span> <span class="main">←</span> arl_append <span class="main">(</span>entriesi <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
        <span class="bound">lut</span> <span class="main">←</span> hm_update <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span> <span class="main">(</span>getentryi <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="bound">u</span> <span class="main">←</span> return <span class="main">⦇</span>entriesi <span class="main">=</span> <span class="bound">ent</span><span class="main">,</span> getentryi <span class="main">=</span> <span class="bound">lut</span><span class="main">⦈</span><span class="main">;</span>
        return <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span>
          <span class="main">}</span>
        <span class="main">)</span>
    <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> pointermap_getmki_defs <span class="main">=</span> pointermap_getmki_def pointermap_getmk_def pointermap_insert_def is_pointermap_impl_def
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pointermap_sane <span class="free">m</span> <span class="main">⟹</span> pointermap_getmk <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">u</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pointermap_impl <span class="free">m</span> <span class="free">mi</span> <span class="main">&gt;</span>
      pointermap_getmki <span class="free">a</span> <span class="free">mi</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span><span class="main">.</span> is_pointermap_impl <span class="free">u</span> <span class="bound">ui</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"getentry <span class="free">m</span> <span class="free">a</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> pointermap_getmki_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> return_bind<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bind_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pointermap_impl <span class="free">m</span> <span class="free">mi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>entriesi <span class="free">mi</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">true</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointermap_getmki_defs is_array_list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pointermap_getmki_defs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Conc_Impl">
<div class="head">
<h1>Theory Conc_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Imparative implementation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Conc_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Pointer_Map_Impl">Pointer_Map_Impl</a> <a href="#Middle_Impl">Middle_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">record</span></span> bddi <span class="main">=</span>
  dpmi <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> pointermap_impl"</span></span>
  dcli <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">,</span>nat<span class="main">)</span> hashtable"</span></span>
<span class="keyword1" id="Conc_Impl-bdd_exhaust"><span class="command">lemma</span></span> bdd_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"dpm <span class="free">a</span> <span class="main">=</span> dpm <span class="free">b</span> <span class="main">⟹</span> dcl <span class="free">a</span> <span class="main">=</span> dcl <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> bdd<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">default</span><span class="main">,</span> <span class="quoted">default</span><span class="main">)</span> <span class="quoted">default</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">default_prod</span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span>default<span class="main">,</span> default<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(* can be found in "~~/src/HOL/Proofs/Extraction/Greatest_Common_Divisor" or "~~/src/HOL/Proofs/Lambda/WeakNorm" *)</span>
<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">default</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">default_nat</span></span> <span class="main">≡</span> <span class="main">0</span> <span class="main">::</span> nat"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_bdd_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">::</span>bdd<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bddi</span></span></span><span class="main">::</span>bddi<span class="main">)</span> <span class="main">=</span> is_pointermap_impl <span class="main">(</span>dpm <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="main">(</span>dpmi <span class="free"><span class="bound"><span class="entity">bddi</span></span></span><span class="main">)</span> <span class="main">*</span> is_hashmap <span class="main">(</span>dcl <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="main">(</span>dcli <span class="free"><span class="bound"><span class="entity">bddi</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Conc_Impl-is_bdd_impl_prec"><span class="command">lemma</span></span> is_bdd_impl_prec<span class="main">:</span> <span class="quoted"><span class="quoted">"precise is_bdd_impl"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> preciseI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> is_bdd_impl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> a a' x y p F F'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bdd_exhaust<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dpmi <span class="improper">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> preciseD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_pointermap_impl_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> star_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"dcli <span class="improper">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">x</span><span class="main">,</span><span class="improper">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> preciseD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_hashmap_prec<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* black unfold magic *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">(* This proof is exactly the same as for pointermap. One could make a rule from it. *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">emptyci</span> <span class="main">::</span> bddi Heap <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">ep</span> <span class="main">←</span> pointermap_empty<span class="main">;</span> <span class="bound">ehm</span> <span class="main">←</span> hm_new<span class="main">;</span> return <span class="main">⦇</span>dpmi<span class="main">=</span><span class="bound">ep</span><span class="main">,</span> dcli<span class="main">=</span><span class="bound">ehm</span><span class="main">⦈</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tci</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> return <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">::</span>bddi<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fci</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> return <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">::</span>bddi<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifci</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                              <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">←</span> pointermap_getmki <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>dpmi <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span><span class="main">;</span>
                              return <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">p</span><span class="main">)</span><span class="main">,</span> dpmi_update <span class="main">(</span>const <span class="bound">u</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>
<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">destrci</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bddi <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> IFEXD Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">destrci</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
  <span class="main">0</span> <span class="main">⇒</span> return FD <span class="main">|</span>
  Suc <span class="main">0</span> <span class="main">⇒</span> return TD <span class="main">|</span>
  Suc <span class="main">(</span>Suc <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span> pm_pthi <span class="main">(</span>dpmi <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span>IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"mi.les"</span></span>

<span class="keyword1" id="Conc_Impl-emptyci_rule"><span class="command">lemma</span></span> emptyci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> emptyci <span class="main">&lt;</span>is_bdd_impl emptymi<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bdd_impl_def emptyci_def emptymi_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tmi' <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span>
        tci <span class="free">bddi</span>
      <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tci_def tmi'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmi' <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span>
        fci <span class="free">bddi</span>
      <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fci_def fmi'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ifmi' <span class="free">v</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">bdd'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> ifci <span class="free">v</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bddi</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_bdd_impl_def ifmi'_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifmi.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ifci_def apfst_def map_prod_def is_bdd_impl_def bdd_sane_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits Option.bind_splits<span class="main">)</span>

<span class="keyword1" id="Conc_Impl-destrci_rule"><span class="command">lemma</span></span> destrci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  destrmi' <span class="free">n</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> destrci <span class="free">n</span> <span class="free">bddi</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r'</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> destrmi'_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">bdd</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> destrmi.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> destrci_def bdd_node_valid_def is_bdd_impl_def ifexd_valid_def bdd_sane_def
                 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> p_valid_RmiI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">mi.restrict_top_impl</span>

<span class="keyword1"><span class="command">thm</span></span> mi.case_ifexi_def

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_ifexici</span> <span class="free"><span class="bound"><span class="entity">fti</span></span></span> <span class="free"><span class="bound"><span class="entity">ffi</span></span></span> <span class="free"><span class="bound"><span class="entity">fii</span></span></span> <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">bddi</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">dest</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">ni</span></span></span> <span class="free"><span class="bound"><span class="entity">bddi</span></span></span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="bound">dest</span> <span class="keyword1">of</span> TD <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">fti</span></span></span> <span class="main">|</span> FD <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ffi</span></span></span> <span class="main">|</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">fii</span></span></span> <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_decon_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"mi.case_ifexi <span class="free">fti</span> <span class="free">ffi</span> <span class="free">fii</span> <span class="free">ni</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"destrmi' <span class="free">ni</span> <span class="free">bdd</span> <span class="main">=</span> Some TD <span class="main">⟹</span> <span class="free">fti</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> <span class="free">ftci</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"destrmi' <span class="free">ni</span> <span class="free">bdd</span> <span class="main">=</span> Some FD <span class="main">⟹</span> <span class="free">ffi</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> <span class="free">ffci</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> destrmi' <span class="free">ni</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span>IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">fii</span> <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="free">r</span>
     <span class="main">⟹</span> <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> <span class="free">fici</span> <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> case_ifexici <span class="free">ftci</span> <span class="free">ffci</span> <span class="free">fici</span> <span class="free">ni</span> <span class="free">bddi</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">unfolding</span></span> mi.case_ifexi_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits IFEXD.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_ifexici_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict_topci</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">vr</span></span></span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> 
  case_ifexici
    <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
    <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">te</span> <span class="bound">ee</span><span class="main">.</span> return <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vr</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="keyword1">then</span> <span class="bound">te</span> <span class="keyword1">else</span> <span class="bound">ee</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mi.restrict_top_impl <span class="free">p</span> <span class="free">var</span> <span class="free">val</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> restrict_topci <span class="free">p</span> <span class="free">var</span> <span class="free">val</span> <span class="free">bddi</span>
          <span class="main">&lt;</span><span class="main">λ</span><span class="bound">ri</span><span class="main">.</span> is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">ri</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mi.restrict_top_impl_def restrict_topci_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lowest_topsci</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_topsci</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> return None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lowest_topsci</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
    case_ifexici 
      <span class="main">(</span><span class="free">lowest_topsci</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
      <span class="main">(</span><span class="free">lowest_topsci</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">rec</span><span class="main">)</span> <span class="main">←</span> <span class="free">lowest_topsci</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">rec</span> <span class="keyword1">of</span> 
          Some <span class="bound">u</span> <span class="main">⇒</span> return <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span>min <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> 
          None <span class="main">⇒</span> return <span class="main">(</span><span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> lowest_topsci.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mi.lowest_tops_impl <span class="free">es</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> lowest_topsci <span class="free">es</span> <span class="free">bddi</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">ri</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">ri</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">bdd'</span><span class="main">=</span><span class="free">bdd</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> lowest_topsci.simps mi.lowest_tops_impl.simps
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">bdd'</span></span> <span class="quoted"><span class="free">bddi</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span> 
    <span class="comment1">(* Unfortunately, we have to split on destrmi'-cases manually, else sep-aut introduces schematic before case-split is done *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mi.case_ifexi_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits IFEXD.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mi.case_ifexi_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mi.case_ifexi_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mi.case_ifexi_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>heap<span class="main">)</span> <span class="entity">iteci</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">iteci</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">lt</span><span class="main">)</span> <span class="main">←</span> lowest_topsci <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="bound">lt</span> <span class="keyword1">of</span>
    Some <span class="bound">a</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ti</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">tt</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">te</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> True <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">fi</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">ft</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">fe</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> False <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tb</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">fb</span><span class="main">,</span><span class="bound">s''</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s'</span><span class="main">;</span>
      <span class="main">(</span>ifci <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s''</span><span class="main">)</span>
     <span class="main">}</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
    case_ifexici <span class="main">(</span>return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Cannot happen''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">}</span>
  <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> iteci.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Conc_Impl-iteci_rule"><span class="command">lemma</span></span> iteci_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span> mi.ite_impl <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟶</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span>
    iteci <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bddi</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span><span class="main">=</span><span class="free">p</span> <span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">bddi</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">bdd'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mi.ite_impl.fixp_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  <span class="comment1">(* Warning: Dragons ahead! *)</span>
      <span class="keyword1"><span class="command">using</span></span> option_admissible<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span>
             <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">x1</span><span class="main">,</span><span class="bound">x2</span><span class="main">)</span><span class="main">,</span><span class="bound">x3</span><span class="main">)</span><span class="main">,</span><span class="bound">x4</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bddi</span><span class="main">.</span> 
              <span class="main">&lt;</span>is_bdd_impl <span class="bound">x4</span> <span class="bound">bddi</span><span class="main">&gt;</span> 
                iteci <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">bddi</span>  
              <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="bound">bddi'</span><span class="main">)</span> <span class="main">⇒</span> is_bdd_impl <span class="bound">r2</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="bound">r1</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> subst<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits Option.bind_splits prod.splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iteci.simps<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iteci.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">unfolding</span></span> imp_to_meta <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fi_rule<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rprems</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">frame_inference</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> iteci_rule<span class="main">[</span><span class="operator">THEN</span> mp<span class="main">,</span> <span class="operator">sep_heap_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">param_optci</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">param_optci</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">tr</span><span class="main">,</span> <span class="bound">bdd</span><span class="main">)</span> <span class="main">←</span> tci <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">fl</span><span class="main">,</span> <span class="bound">bdd</span><span class="main">)</span> <span class="main">←</span> fci <span class="bound">bdd</span><span class="main">;</span>
    <span class="bound">id</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">bdd</span><span class="main">;</span>
    <span class="bound">td</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">bdd</span><span class="main">;</span>
    <span class="bound">ed</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">bdd</span><span class="main">;</span>
              return <span class="main">(</span>
              <span class="keyword1">if</span> <span class="bound">id</span> <span class="main">=</span> TD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
                        <span class="keyword1">if</span> <span class="bound">id</span> <span class="main">=</span> FD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span>
                        <span class="keyword1">if</span> <span class="bound">td</span> <span class="main">=</span> TD <span class="main">∧</span> <span class="bound">ed</span> <span class="main">=</span> FD <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span>
                        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
                        <span class="keyword1">if</span> <span class="bound">ed</span> <span class="main">=</span> TD <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> Some <span class="bound">tr</span> <span class="keyword1">else</span>
                        <span class="keyword1">if</span> <span class="bound">td</span> <span class="main">=</span> FD <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="bound">fl</span> <span class="keyword1">else</span>
                        None<span class="main">,</span> <span class="bound">bdd</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Conc_Impl-param_optci_rule"><span class="command">lemma</span></span> param_optci_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span> mi.param_opt_impl <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟹</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> 
    param_optci <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bddi</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span><span class="main">=</span><span class="free">p</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi.param_opt_impl.simps param_optci_def tmi'_def fmi'_def
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Option.bind_splits<span class="main">)</span>

<span class="keyword1" id="Conc_Impl-bdd_hm_lookup_rule"><span class="command">lemma</span></span> bdd_hm_lookup_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span>dcl <span class="free">bdd</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">t</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> 
    hm_lookup <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">t</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>dcli <span class="free">bddi</span><span class="main">)</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_bdd_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>

<span class="keyword1" id="Conc_Impl-bdd_hm_update_rule'"><span class="command">lemma</span></span> bdd_hm_update_rule'<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> 
    hm_update <span class="free">k</span> <span class="free">v</span> <span class="main">(</span>dcli <span class="free">bddi</span><span class="main">)</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_bdd_impl <span class="main">(</span>updS <span class="free">bdd</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>dcli_update <span class="main">(</span>const <span class="bound">r</span><span class="main">)</span> <span class="free">bddi</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_bdd_impl_def updS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>heap<span class="main">)</span> <span class="entity">iteci_lu</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">iteci_lu</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">lu</span> <span class="main">←</span> ht_lookup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>dcli <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lu</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">po</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> param_optci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">po</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        return <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">}</span>
      <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">lt</span><span class="main">)</span> <span class="main">←</span> lowest_topsci <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="bound">s</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lt</span> <span class="keyword1">of</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">ti</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
        <span class="bound">tt</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
        <span class="bound">te</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> True <span class="bound">s</span><span class="main">;</span>
        <span class="bound">fi</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
        <span class="bound">ft</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
        <span class="bound">fe</span> <span class="main">←</span> restrict_topci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">a</span> False <span class="bound">s</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">tb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci_lu</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="bound">s</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">fb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci_lu</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> ifci <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s</span><span class="main">;</span>
        <span class="bound">cl</span> <span class="main">←</span> hm_update <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>dcli <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="bound">r</span><span class="main">,</span>dcli_update <span class="main">(</span>const <span class="bound">cl</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
       <span class="main">}</span> 
         <span class="main">|</span> None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Cannot happen''</span> <span class="main">)</span><span class="main">}</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">ht_lookup</span>
<span class="keyword1"><span class="command">declare</span></span> iteci_lu.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">thm</span></span> iteci_lu.simps<span class="main">[</span><span class="operator">unfolded</span> restrict_topci_def case_ifexici_def  param_optci_def lowest_topsci.simps<span class="main">]</span>
<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>heap<span class="main">)</span> <span class="entity">iteci_lu_code</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iteci_lu_code</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">lu</span> <span class="main">←</span> hm_lookup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>dcli <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="bound">lu</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">po</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span>
                              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> None
                     <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">po</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
                                       <span class="bound">id</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
                                       <span class="bound">td</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
                                       <span class="bound">ed</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">id</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">td</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> min <span class="bound">a</span> <span class="bound">v</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ed</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> min <span class="bound">a</span> <span class="bound">v</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">ti</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">id</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ti</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">tt</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">td</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ti</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">te</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ed</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ti</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">id</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ei</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">ft</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">td</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ei</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="keyword1">let</span> <span class="bound">fe</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ed</span> <span class="keyword1">of</span> IFD <span class="bound">v</span> <span class="bound">ti</span> <span class="bound">ei</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="bound">ei</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span>
                                       <span class="main">(</span><span class="bound">tb</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci_lu_code</span> <span class="bound">ti</span> <span class="bound">tt</span> <span class="bound">te</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
                                       <span class="main">(</span><span class="bound">fb</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="free">iteci_lu_code</span> <span class="bound">fi</span> <span class="bound">ft</span> <span class="bound">fe</span> <span class="bound">s</span><span class="main">;</span>
                                       <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> ifci <span class="bound">a</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">s</span><span class="main">;</span>
                                       <span class="bound">cl</span> <span class="main">←</span> hm_update <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>dcli <span class="bound">s</span><span class="main">)</span><span class="main">;</span>
                                       return <span class="main">(</span><span class="bound">r</span><span class="main">,</span> dcli_update <span class="main">(</span>const <span class="bound">cl</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
                                     <span class="main">}</span>
                        <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
  <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> iteci_lu_code.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="comment1">(* reduced the run-time of our examples by around 30%.
  But we would need some efficient automated machinery to show this,
  and I'm not even sure how to correctly use induction correctly for this.
  Thus: Future work.*)</span>
<span class="keyword1" id="Conc_Impl-iteci_lu_code"><span class="command">lemma</span></span> iteci_lu_code<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iteci_lu <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> iteci_lu_code <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="comment1">(* Proof by copy-paste *)</span>
<span class="keyword1" id="Conc_Impl-iteci_lu_rule"><span class="command">lemma</span></span> iteci_lu_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span> mi.ite_impl_lu <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bdd</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">bdd'</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟶</span>
  <span class="main">&lt;</span>is_bdd_impl <span class="free">bdd</span> <span class="free">bddi</span><span class="main">&gt;</span> 
    iteci_lu <span class="free">i</span> <span class="free">t</span> <span class="free">e</span> <span class="free">bddi</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">pi</span><span class="main">,</span><span class="bound">bddi'</span><span class="main">)</span><span class="main">.</span> is_bdd_impl <span class="free">bdd'</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">pi</span><span class="main">=</span><span class="free">p</span> <span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">bddi</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">bdd'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mi.ite_impl_lu.fixp_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  <span class="comment1">(* More Dragons *)</span>
      <span class="keyword1"><span class="command">using</span></span> option_admissible<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span>
             <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">x1</span><span class="main">,</span><span class="bound">x2</span><span class="main">)</span><span class="main">,</span><span class="bound">x3</span><span class="main">)</span><span class="main">,</span><span class="bound">x4</span><span class="main">)</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bddi</span><span class="main">.</span>
              <span class="main">&lt;</span>is_bdd_impl <span class="bound">x4</span> <span class="bound">bddi</span><span class="main">&gt;</span>
                iteci_lu <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span> <span class="bound">bddi</span>  
              <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="bound">bddi'</span><span class="main">)</span> <span class="main">⇒</span> is_bdd_impl <span class="bound">r2</span> <span class="bound">bddi'</span> <span class="main">*</span> <span class="main">↑</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="bound">r1</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> subst<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits Option.bind_splits prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> updS_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iteci_lu.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> bdd_hm_lookup_rule <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fi_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> param_optci_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command">unfolding</span></span> imp_to_meta
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fi_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rprems</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fi_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rprems</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> updS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> iteci_lu.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> bdd_hm_lookup_rule <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fi_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> param_optci_rule<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> iteci_lu.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> bdd_hm_lookup_rule <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹A standard library of functions›</span></span>

<span class="keyword1"><span class="command">declare</span></span> iteci_rule<span class="main">[</span><span class="operator">THEN</span> mp<span class="main">,</span> <span class="operator">sep_heap_rules</span><span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">notci</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> fci <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> tci <span class="bound">s</span><span class="main">;</span>
  iteci_lu <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">f</span> <span class="bound">t</span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">orci</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> tci <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  iteci_lu <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">andci</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> fci <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  iteci_lu <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">f</span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">norci</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> orci <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  notci <span class="bound">r</span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nandci</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> andci <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  notci <span class="bound">r</span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">biimpci</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">nb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> notci <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  iteci_lu <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">nb</span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">xorci</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">nb</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> notci <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  iteci_lu <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">nb</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">litci</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">bdd</span><span class="main">)</span> <span class="main">←</span> tci <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">bdd</span><span class="main">)</span> <span class="main">←</span> fci <span class="bound">bdd</span><span class="main">;</span>
  ifci <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">t</span> <span class="bound">f</span> <span class="bound">bdd</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tautci</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">d</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">d</span> <span class="main">=</span> TD<span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Printing›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following functions are exported unverified. They are intended for BDD debugging purposes.›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>heap<span class="main">)</span> <span class="entity">serializeci</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bddi <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> nat<span class="main">)</span> list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">serializeci</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">d</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">d</span> <span class="keyword1">of</span> 
    IFD <span class="bound">v</span> <span class="bound">t</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">r</span> <span class="main">←</span> <span class="free">serializeci</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">l</span> <span class="main">←</span> <span class="free">serializeci</span> <span class="bound">e</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      return <span class="main">(</span>remdups <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="bound">r</span> <span class="main">@</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span> <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return <span class="main">[]</span>
  <span class="main">)</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> serializeci.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="comment1">(* This snaps to heap as a Monad, which is not intended, but irrelevant. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mapM</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">r</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  <span class="bound">rs</span> <span class="main">←</span> <span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">r</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span>
<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">liftM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">a</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span><span class="main">;</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sequence</span> <span class="main">=</span> mapM id"</span></span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"liftM <span class="main">(</span>map <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"liftM <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>sequence <span class="free">l</span><span class="main">)</span> <span class="main">=</span> sequence <span class="main">(</span>map <span class="main">(</span>liftM <span class="free">f</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sequence_def liftM_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="comment1">(*http://stackoverflow.com/questions/23864965/string-of-nat-in-isabelle*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">string_of_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">string_of_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">10</span> <span class="keyword1">then</span> <span class="main">[</span>char_of_nat <span class="main">(</span><span class="numeral">48</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span>
                                <span class="keyword1">else</span> <span class="free">string_of_nat</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>char_of_nat <span class="main">(</span><span class="numeral">48</span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">10</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">labelci</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bddi <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> string <span class="main">×</span> string<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">labelci</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">d</span> <span class="main">←</span> destrci <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
   <span class="keyword1">let</span> <span class="bound">son</span> <span class="main">=</span> string_of_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
   <span class="keyword1">let</span> <span class="bound">label</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">d</span> <span class="keyword1">of</span>
     TD <span class="main">⇒</span> <span class="inner_quoted">''T''</span> <span class="main">|</span>
     FD <span class="main">⇒</span> <span class="inner_quoted">''F''</span> <span class="main">|</span>
     <span class="main">(</span>IFD <span class="bound">v</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> string_of_nat <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
   return <span class="main">(</span><span class="bound">label</span><span class="main">,</span> <span class="bound">son</span><span class="main">,</span> <span class="bound">son</span> <span class="main">@</span> <span class="inner_quoted">''[label=''</span> <span class="main">@</span> <span class="bound">label</span> <span class="main">@</span> <span class="inner_quoted">''];\010''</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">graphifyci1</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">(</span>string_of_nat <span class="bound">f</span> <span class="main">@</span> <span class="inner_quoted">'' -&gt; ''</span> <span class="main">@</span> string_of_nat <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">c</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="inner_quoted">'' [style=dotted]''</span> <span class="main">|</span> Suc <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="inner_quoted">''''</span><span class="main">)</span> <span class="main">@</span> <span class="inner_quoted">'';\010''</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trd</span> <span class="main">=</span> snd <span class="main">∘</span> snd"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fstp</span> <span class="main">=</span> apsnd fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_thing_By</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
  <span class="bound">nub</span> <span class="main">=</span> remdups <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
  map <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span> <span class="main">(</span>fst <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">nub</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_thing</span> <span class="main">=</span> the_thing_By <span class="main">(=)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">graphifyci</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> nat <span class="main">⇒</span> bddi <span class="main">⇒</span> string Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">graphifyci</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ep</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">s</span> <span class="main">←</span> serializeci <span class="free"><span class="bound"><span class="entity">ep</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> map fst <span class="bound">s</span><span class="main">;</span>
  <span class="bound">l</span> <span class="main">←</span> mapM <span class="main">(</span>labelci <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>remdups <span class="main">(</span>map fst <span class="bound">e</span> <span class="main">@</span> map snd <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">grp</span> <span class="main">=</span>  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">@</span> <span class="bound">a</span> <span class="main">@</span> <span class="inner_quoted">'';''</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">l</span><span class="main">)</span> <span class="inner_quoted">''{rank=same;''</span> <span class="main">@</span> <span class="inner_quoted">''}\010''</span><span class="main">)</span> <span class="main">(</span>the_thing <span class="main">(</span>map fstp <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">e</span> <span class="main">←</span> mapM <span class="main">(</span>graphifyci1 <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">emptyhlp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ep</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="inner_quoted">''F;\010''</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="inner_quoted">''T;\010''</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">;</span>  
  return <span class="main">(</span><span class="inner_quoted">''digraph ''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' {\010''</span> <span class="main">@</span> concat <span class="main">(</span>map trd <span class="bound">l</span><span class="main">)</span> <span class="main">@</span> concat <span class="bound">grp</span> <span class="main">@</span> concat <span class="bound">e</span> <span class="main">@</span> <span class="bound">emptyhlp</span> <span class="main">@</span> <span class="inner_quoted">''}''</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Level_Collapse">
<div class="head">
<h1>Theory Level_Collapse</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Collapsing the levels›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Level_Collapse
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Conc_Impl">Conc_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The theory up to this point is implemented in a way that separated the different aspects into different levels.
This is highly beneficial for us, since it allows us to tackle the difficulties arising in small chunks.
However, exporting this to the user would be highly impractical.
Thus, this theory collapses all the different levels (i.e. refinement steps) and relates the computations in the heap monad to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> boolfunc<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bddmi_rel</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">|</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> bf_ifex_rel <span class="main">∧</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> Rmi <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bdd_relator</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat boolfunc <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bddi <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bdd_relator</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">cs</span><span class="main">.</span> is_bdd_impl <span class="bound">cs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊆</span> <span class="main">(</span>bddmi_rel <span class="bound">cs</span><span class="main">)</span> <span class="main">∧</span> bdd_sane <span class="bound">cs</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">true</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> assn<span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bdd_relator</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the interface that is exposed to the user.
(The contents of the definition are not exposed.)
›</span></span>

<span class="keyword1" id="Level_Collapse-bdd_relator_mono"><span class="command">lemma</span></span> bdd_relator_mono<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">⟹</span> bdd_relator <span class="free">p</span> <span class="free">s</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> bdd_relator <span class="free">q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_relator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1" id="Level_Collapse-bdd_relator_absorb_true"><span class="command">lemma</span></span> bdd_relator_absorb_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_relator <span class="free">p</span> <span class="free">s</span> <span class="main">*</span> <span class="keyword1">true</span> <span class="main">=</span> bdd_relator <span class="free">p</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bdd_relator_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> bdd_relator_def<span class="main">[</span><span class="operator">unfolded</span> bddmi_rel_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1" id="Level_Collapse-join_hlp1"><span class="command">lemma</span></span> join_hlp1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bdd_impl <span class="free">a</span> <span class="free">s</span> <span class="main">*</span> is_bdd_impl <span class="free">b</span> <span class="free">s</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> is_bdd_impl <span class="free">a</span> <span class="free">s</span> <span class="main">*</span> is_bdd_impl <span class="free">b</span> <span class="free">s</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> preciseD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"is_bdd_impl"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"is_bdd_impl <span class="free">b</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> F'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"is_bdd_impl <span class="free">a</span> <span class="free">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> is_bdd_impl_prec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> mod_and_dist<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-join_hlp"><span class="command">lemma</span></span> join_hlp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bdd_impl <span class="free">a</span> <span class="free">s</span> <span class="main">*</span> is_bdd_impl <span class="free">b</span> <span class="free">s</span> <span class="main">=</span> is_bdd_impl <span class="free">b</span> <span class="free">s</span> <span class="main">*</span> is_bdd_impl <span class="free">a</span> <span class="free">s</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_iffI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> join_hlp1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-add_true_asm"><span class="command">lemma</span></span> add_true_asm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="free">a</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="free">a</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> cons_pre_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ent_true_drop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-add_anything"><span class="command">lemma</span></span> add_anything<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span> <span class="main">*</span> <span class="free">x</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="bound">r</span> <span class="main">*</span> <span class="free">x</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span> <span class="main">=</span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Level_Collapse-add_true"><span class="command">lemma</span></span> add_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="free">a</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">b</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">&lt;</span><span class="free">a</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms add_anything<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="keyword1">true</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">node_relator</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">node_relator</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_auto›</span></span></span></span> behaves sub-optimal when having <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">bf</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">bdd</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">computed_pointer_relation</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as assumption in our cases. Using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> node_relator<span class="antiquote"><span class="antiquote">}</span></span></span></span> instead fixes this behavior with a custom solver for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>simp›</span></span></span></span>.›</span></span>

<span class="keyword1" id="Level_Collapse-node_relatorI"><span class="command">lemma</span></span> node_relatorI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">y</span> <span class="main">⟹</span> node_relator <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> node_relator_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Level_Collapse-node_relatorD"><span class="command">lemma</span></span> node_relatorD<span class="main">:</span> <span class="quoted"><span class="quoted">"node_relator <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> node_relator_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY'</span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">tac</span> ORELSE' K all_tac›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹map_theory_simpset <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
  <span class="entity">ctxt</span> addSolver <span class="main">(</span>Simplifier.mk_solver <span class="inner_quoted">"node_relator"</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span>
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> node_relatorI<span class="antiquote">}</span></span></span> THEN'
          REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Set.insertI1 Set.insertI2<span class="antiquote">}</span></span></span><span class="main">)</span> THEN'
          <span class="entity">TRY'</span> <span class="main">(</span>dresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> node_relatorD<span class="antiquote">}</span></span></span> THEN' assume_tac <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        SOLVED' <span class="entity">tac</span> <span class="entity">n</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span>›</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This is the general form one wants to work with:
if a function on the bdd is called with a set of already existing and valid pointers, the arguments to the function have to be in that set.
The result is that one more pointer is the set of existing and valid pointers.
›</span></span>

<span class="keyword1"><span class="command">thm</span></span> iteci_rule<span class="main">[</span><span class="operator">THEN</span> mp<span class="main">]</span> mi.ite_impl_R ifex_ite_rel_bf

<span class="keyword1" id="Level_Collapse-iteci_rule"><span class="command">lemma</span></span> iteci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
<span class="main">⟦</span>node_relator <span class="main">(</span><span class="free">ib</span><span class="main">,</span> <span class="free">ic</span><span class="main">)</span>  <span class="free">rp</span><span class="main">;</span> node_relator <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="free">rp</span><span class="main">;</span> node_relator <span class="main">(</span><span class="free">eb</span><span class="main">,</span> <span class="free">ec</span><span class="main">)</span> <span class="free">rp</span><span class="main">⟧</span> <span class="main">⟹</span>
<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> 
  iteci_lu <span class="free">ic</span> <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_ite <span class="free">ib</span> <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def node_relator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mi.ite_impl_lu_R<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ii<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ic</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ti<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">tc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ei<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ec</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> in_rel_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ospecD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> cons_post_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> cons_pre_rule<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iteci_lu_rule<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> mp<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> add_true<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ent_pure_post_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ifex_ite.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi.les_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ifex_ite_opt_rel_bf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> in_rel_def<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-tci_rule"><span class="command">lemma</span></span> tci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> 
  tci <span class="free">s</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_True<span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> mi.Timpl_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ospecD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi.les_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-fci_rule"><span class="command">lemma</span></span> fci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> 
  fci <span class="free">s</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_False<span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> mi.Fimpl_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ospecD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi.les_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹IFC/ifmi/ifci require that the variable order is ensured by the user. 
Instead of using ifci, a combination of litci and iteci has to be used.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rp</span><span class="main">;</span> <span class="main">(</span><span class="free">eb</span><span class="main">,</span> <span class="free">ec</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rp</span><span class="main">⟧</span> <span class="main">⟹</span>
<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> 
  ifci <span class="free">v</span> <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_if <span class="free">v</span> <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This probably doesn't hold.›</span></span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Level_Collapse-notci_rule"><span class="command">lemma</span></span> notci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> notci <span class="free">tc</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_not <span class="free">tb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notci_def<span class="main">)</span>

<span class="keyword1" id="Level_Collapse-cirules1"><span class="command">lemma</span></span> cirules1<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="free">rp</span>"</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">eb</span><span class="main">,</span> <span class="free">ec</span><span class="main">)</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> andci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_and <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> orci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_or <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> biimpci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_biimp <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> xorci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_xor <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
<span class="comment1">(* actually, these functions would allow for more insert. I think that would be inconvenient though. *)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> andci_def orci_def biimpci_def xorci_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Level_Collapse-cirules2"><span class="command">lemma</span></span> cirules2<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="free">rp</span>"</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">eb</span><span class="main">,</span> <span class="free">ec</span><span class="main">)</span> <span class="free">rp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> nandci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_nand <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> norci <span class="free">tc</span> <span class="free">ec</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_nor <span class="free">tb</span> <span class="free">eb</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nandci_def norci_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Level_Collapse-litci_rule"><span class="command">lemma</span></span> litci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> litci <span class="free">v</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_lit <span class="free">v</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">s'</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> litci_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span> <span class="bound">ab</span> <span class="bound">bb</span><span class="main">.</span> <span class="comment1">― ‹introducing some vars \dots›</span>
         <span class="main">&lt;</span>bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_False<span class="main">,</span> <span class="bound">ab</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>bf_True<span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span><span class="main">)</span> <span class="bound">bb</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> 
           ifci <span class="free">v</span> <span class="bound">t</span> <span class="bound">ab</span> <span class="bound">bb</span>
         <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> bdd_relator <span class="main">(</span>insert <span class="main">(</span>bf_lit <span class="free">v</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="free">rp</span><span class="main">)</span> <span class="bound">x</span><span class="main">&gt;</span>›</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> tc fc sc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bf_ifex_rel_consts_ensured<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> mi.IFimpl_rule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> tc fc sc sm a aa b ba fm tm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">fm</span><span class="main">,</span> Falseif<span class="main">)</span> <span class="main">∈</span> Rmi <span class="improper">sm</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span> <span class="comment1">(* hack: instantiate the first premise of mi.IFimpl_rule with the second assumption that matches. The other way around would be fine, too. *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ospecD2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mi.les_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-tautci_rule"><span class="command">lemma</span></span> tautci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"node_relator <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">tc</span><span class="main">)</span> <span class="free">rp</span> <span class="main">⟹</span> <span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span> tautci <span class="free">tc</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> bdd_relator <span class="free">rp</span> <span class="free">s</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">tb</span> <span class="main">=</span> bf_True<span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> node_relator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> tautci_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> sm ti<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mi.DESTRimpl_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> ospecD2<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ifex.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Level_Collapse-emptyci_rule"><span class="command">lemma</span></span> emptyci_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> emptyci <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> bdd_relator <span class="main">{}</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_relator_def<span class="main">)</span>

<span class="comment1">(* TODO: make sure that emptyci_rule and firends don't appear duplicate, once concrete-impl style, once level-collapsed. *)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> bf_ite_def

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Efficient comparison of two nodes.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eqci</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="comment1">(* wrapping definition so sep_auto does not run into nowhere *)</span>

<span class="keyword1" id="Level_Collapse-iteeq_rule"><span class="command">lemma</span></span> iteeq_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
<span class="main">⟦</span>node_relator <span class="main">(</span><span class="free">xb</span><span class="main">,</span> <span class="free">xc</span><span class="main">)</span>  <span class="free">rp</span><span class="main">;</span> node_relator <span class="main">(</span><span class="free">yb</span><span class="main">,</span> <span class="free">yc</span><span class="main">)</span> <span class="free">rp</span><span class="main">⟧</span> <span class="main">⟹</span>
<span class="main">&lt;</span>bdd_relator <span class="free">rp</span> <span class="free">s</span><span class="main">&gt;</span>
  eqci <span class="free">xc</span> <span class="free">yc</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">xb</span> <span class="main">=</span> <span class="free">yb</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bdd_relator_def node_relator_def eqci_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> norm_pre_ex_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> bddmi_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> return_cons_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> bf_ifex_eq mi.cmp_rule_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> bf_ifex_eq mi.cmp_rule_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BDD_Examples">
<div class="head">
<h1>Theory BDD_Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Tests and examples›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BDD_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Level_Collapse">Level_Collapse</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Just two simple examples:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">s</span> <span class="main">←</span> emptyci<span class="main">;</span>
  <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> tci <span class="bound">s</span><span class="main">;</span>
  tautci <span class="bound">t</span> <span class="bound">s</span>
<span class="main">}</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> True<span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">s</span> <span class="main">←</span> emptyci<span class="main">;</span>
  <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> litci <span class="main">0</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> litci <span class="main">1</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> litci <span class="numeral">2</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t1i</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> orci <span class="bound">a</span> <span class="bound">b</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> andci <span class="bound">t1i</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t2i1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> andci <span class="bound">a</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t2i2</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> andci <span class="bound">b</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">t2</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> orci <span class="bound">t2i1</span> <span class="bound">t2i2</span> <span class="bound">s</span><span class="main">;</span>
  eqci <span class="bound">t1</span> <span class="bound">t2</span>
<span class="main">}</span> <span class="main">&lt;</span><span class="main">↑</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BDD_Code">
<div class="head">
<h1>Theory BDD_Code</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Code export›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BDD_Code
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Level_Collapse">Level_Collapse</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For convenience reasons, the code export is in a separate theory. For Haskell, we only have to reactivate the original equation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">blit</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Other languages might need an implementation for it.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"blit <span class="free">src</span> <span class="free">si</span> <span class="free">dst</span> <span class="free">di</span> <span class="free">len</span>
      <span class="main">=</span> blit' <span class="free">src</span> <span class="main">(</span>integer_of_nat <span class="free">si</span><span class="main">)</span> <span class="free">dst</span> <span class="main">(</span>integer_of_nat <span class="free">di</span><span class="main">)</span>
          <span class="main">(</span>integer_of_nat <span class="free">len</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blit'_def<span class="main">)</span>
<span class="keyword1"><span class="command">declare</span></span> blit_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="keyword2"><span class="keyword">open</span></span> <span class="quoted"><span class="quoted">iteci_lu</span></span> <span class="quoted"><span class="quoted">notci</span></span> <span class="quoted"><span class="quoted">andci</span></span> <span class="quoted"><span class="quoted">orci</span></span> <span class="quoted"><span class="quoted">nandci</span></span> <span class="quoted"><span class="quoted">norci</span></span> <span class="quoted"><span class="quoted">biimpci</span></span> <span class="quoted"><span class="quoted">xorci</span></span> <span class="quoted"><span class="quoted">ifci</span></span> <span class="quoted"><span class="quoted">tci</span></span> <span class="quoted"><span class="quoted">fci</span></span> <span class="quoted"><span class="quoted">tautci</span></span> <span class="quoted"><span class="quoted">emptyci</span></span> <span class="quoted"><span class="quoted">graphifyci</span></span> <span class="quoted"><span class="quoted">litci</span></span> <span class="quoted"><span class="quoted">eqci</span></span> <span class="keyword2"><span class="keyword">checking</span></span> Haskell

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>