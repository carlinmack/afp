<div id="BTree">
<div class="head">
<h1>Theory BTree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree                 
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Sorted_Less.html">HOL-Data_Structures.Sorted_Less</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Cmp.html">HOL-Data_Structures.Cmp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* some setup to cover up the redefinition of sorted in Sorted_Less
   but keep the lemmas *)</span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Sorted_Less.sorted
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sorted_less</span> <span class="main">≡</span> Sorted_Less.sorted"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Definition of the B-Tree"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Datatype definition"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"B-trees can be considered to have all data stored interleaved
as child nodes and separating elements (also keys or indices).
We define them to either be a Node that holds a list of pairs of children
and indices or be a completely empty Leaf."</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> btree <span class="main">=</span> Leaf <span class="main">|</span> Node <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> btree_list <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> btree_pair <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subtrees</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subtrees</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">separators</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">separators</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Inorder and Set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The set of B-tree elements is defined automatically."</span></span>

<span class="keyword1"><span class="command">thm</span></span> btree.set
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"set_btree <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">100</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The inorder view is defined with the help of the concat function."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inorder</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inorder</span> Leaf <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">inorder</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span><span class="main">.</span> <span class="free">inorder</span> <span class="bound">sub</span> <span class="main">@</span> <span class="main">[</span><span class="bound">sep</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="free">inorder</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inorder_pair</span>  <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">.</span> inorder <span class="bound">sub</span> <span class="main">@</span> <span class="main">[</span><span class="bound">sep</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inorder_list</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≡</span> concat <span class="main">(</span>map inorder_pair <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* this abbreviation makes handling the list much nicer *)</span>
<span class="keyword1"><span class="command">thm</span></span> inorder.simps

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">100</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Height and Balancedness"</span></span>

<span class="keyword1"><span class="command">class</span></span> height <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">height</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> btree <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">height</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">height_btree</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"height Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="main">(</span>height <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Balancedness is defined is close accordance to the definition by Ernst"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bal</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bal</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> height <span class="bound">sub</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">bal</span> <span class="bound">sub</span><span class="main">)</span> <span class="main">∧</span> <span class="free">bal</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">100</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Order"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The order of a B-tree is defined just as in the original paper by Bayer."</span></span>

<span class="comment1">(* alt1: following knuths definition to allow for any
   natural number as order and resolve ambiguity *)</span>
<span class="comment1">(* alt2: use range [k,2*k] allowing for valid btrees
   from k=1 onwards NOTE this is what I ended up implementing *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">order</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> btree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>  <span class="main">∧</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">sub</span><span class="main">)</span> <span class="main">∧</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The special condition for the root is called \textit{root\_order}›</span></span>

<span class="comment1">(* the invariant for the root of the btree *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">root_order</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> btree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">root_order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Lemmas"</span></span>

<span class="comment1">(* auxiliary lemmas when handling sets *)</span>
<span class="keyword1" id="BTree-separators_split"><span class="command">lemma</span></span> separators_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>separators <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>separators <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>separators <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree-subtrees_split"><span class="command">lemma</span></span> subtrees_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>subtrees <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>subtrees <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>subtrees <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* height and set lemmas *)</span>


<span class="keyword1" id="BTree-finite_set_ins_swap"><span class="command">lemma</span></span> finite_set_ins_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max <span class="free">a</span> <span class="main">(</span>Max <span class="main">(</span>Set.insert <span class="free">b</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> max <span class="free">b</span> <span class="main">(</span>Max <span class="main">(</span>Set.insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_insert assms max.commute max.left_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BTree-finite_set_in_idem"><span class="command">lemma</span></span> finite_set_in_idem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max <span class="free">a</span> <span class="main">(</span>Max <span class="main">(</span>Set.insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>Set.insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_insert assms max.commute max.left_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BTree-height_Leaf"><span class="command">lemma</span></span> height_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BTree-height_btree_order"><span class="command">lemma</span></span> height_btree_order<span class="main">:</span>
  <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree-height_btree_sub"><span class="command">lemma</span></span> height_btree_sub<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="main">(</span>Node <span class="free">ls</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree-height_btree_last"><span class="command">lemma</span></span> height_btree_last<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">ts</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="main">(</span>Node <span class="free">ts</span> <span class="free">sub</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>height <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1" id="BTree-set_btree_inorder"><span class="command">lemma</span></span> set_btree_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_btree <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="BTree-child_subset"><span class="command">lemma</span></span> child_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">⟹</span> set_btree <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> set_btree <span class="main">(</span>Node <span class="free">t</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree-some_child_sub"><span class="command">lemma</span></span> some_child_sub<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">∈</span> set <span class="main">(</span>separators <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> 

<span class="comment1">(* balancedness lemmas *)</span>


<span class="keyword1" id="BTree-bal_all_subtrees_equal"><span class="command">lemma</span></span> bal_all_subtrees_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s1</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s2</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> height <span class="bound">s1</span> <span class="main">=</span> height <span class="bound">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> BTree.bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1" id="BTree-fold_max_set"><span class="command">lemma</span></span> fold_max_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⟹</span> fold max <span class="free">t</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def_raw<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree-height_bal_tree"><span class="command">lemma</span></span> height_bal_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> height <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1" id="BTree-bal_split_last"><span class="command">lemma</span></span> bal_split_last<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="BTree-bal_split_right"><span class="command">lemma</span></span> bal_split_right<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="free">rs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_constant_conv<span class="main">)</span>

<span class="keyword1" id="BTree-bal_split_left"><span class="command">lemma</span></span> bal_split_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">ls</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="free">ls</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_constant_conv<span class="main">)</span>


<span class="keyword1" id="BTree-bal_substitute"><span class="command">lemma</span></span> bal_substitute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> height <span class="free">t</span> <span class="main">=</span> height <span class="free">c</span><span class="main">;</span> bal <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bal.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree-bal_substitute_subtree"><span class="command">lemma</span></span> bal_substitute_subtree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> height <span class="free">a</span> <span class="main">=</span> height <span class="free">c</span><span class="main">;</span> bal <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bal_substitute
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree-bal_substitute_separator"><span class="command">lemma</span></span> bal_substitute_separator<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bal.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* order lemmas *)</span>

<span class="keyword1" id="BTree-order_impl_root_order"><span class="command">lemma</span></span> order_impl_root_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> order <span class="free">k</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* sorted inorder implies that some sublists are sorted. This can be followed directly *)</span>

<span class="keyword1" id="BTree-sorted_inorder_list_separators"><span class="command">lemma</span></span> sorted_inorder_list_separators<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_lems<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> sorted_inorder_separators<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_inorder_list_separators sorted_wrt_append
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="BTree-sorted_inorder_list_subtrees"><span class="command">lemma</span></span> sorted_inorder_list_subtrees<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> sorted_less <span class="main">(</span>inorder <span class="bound">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_lems<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> sorted_inorder_subtrees<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">sub</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> sorted_less <span class="main">(</span>inorder <span class="bound">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_inorder_list_subtrees sorted_wrt_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree-sorted_inorder_list_induct_subtree"><span class="command">lemma</span></span> sorted_inorder_list_induct_subtree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> sorted_less <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> sorted_inorder_induct_subtree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> sorted_less <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>

<span class="keyword1" id="BTree-sorted_inorder_induct_last"><span class="command">lemma</span></span> sorted_inorder_induct_last<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BTree_Height">
<div class="head">
<h1>Theory BTree_Height</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_Height
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BTree">BTree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Maximum and minimum height"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Textbooks usually provide some proofs relating the maxmimum and minimum height of the BTree
for a given number of nodes. We therefore introduce this counting and show the respective proofs."</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definition of node/size"</span></span>

<span class="keyword1"><span class="command">thm</span></span> BTree.btree.size
  <span class="comment1">(* the automatically derived size is a bit weird for our purposes *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">100</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The default size function does not suit our needs as it regards the length of the list in each node.
 We would like to count the number of nodes in the tree only, not regarding the number of keys."</span></span>

<span class="comment1">(* we want a different counting method,
  namely only the number of nodes in a tree *)</span>

<span class="comment1">(* TODO what if we count Leafs as nodes? *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodes</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span><span class="main">←</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="free">nodes</span> <span class="bound">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">nodes</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">30</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">100</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span>"</span></span>


<span class="comment1">(* maximum number of nodes for given height *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Maximum number of nodes for a given height"</span></span>


<span class="keyword1" id="BTree_Height-sum_list_replicate"><span class="command">lemma</span></span> sum_list_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>replicate <span class="free">n</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span><span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_class.ring_distribs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bound</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BTree_Height-nodes_height_upper_bound"><span class="command">lemma</span></span> nodes_height_upper_bound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>order <span class="free">k</span> <span class="free">t</span><span class="main">;</span> bal <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> bound <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nodes.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span>
        sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_mult_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="var">?sub_height</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2
    <span class="keyword1"><span class="command">using</span></span> sum_list_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bound <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_replicate_const<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> length_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_replicate <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?sub_height</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="skolem">t</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> 
         <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>
        <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>
        <span class="main">+</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nodes.simps add_mult_distrib
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_mult_distrib2 mult.assoc mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>Suc<span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_bal_tree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"To verify our lower bound is sharp, we compare it to the height of artificially constructed
full trees."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">full_node</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> btree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">full_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> Leaf"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">full_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Node <span class="main">(</span>replicate <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">full_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">full_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">in</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nodes <span class="bound">x</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>full_node <span class="bound">k</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">in</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="BTree_Height-compow_comp_id"><span class="command">lemma</span></span> compow_comp_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* required only for the fold definition of height *)</span>
<span class="keyword1" id="BTree_Height-compow_id_point"><span class="command">lemma</span></span> compow_id_point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">c</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-height_full_node"><span class="command">lemma</span></span> height_full_node<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>full_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_replicate_conv_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-bal_full_node"><span class="command">lemma</span></span> bal_full_node<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>full_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-order_full_node"><span class="command">lemma</span></span> order_full_node<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="main">(</span>full_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-full_btrees_sharp"><span class="command">lemma</span></span> full_btrees_sharp<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>full_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> bound <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_full_node <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-upper_bound_sharp_node"><span class="command">lemma</span></span> upper_bound_sharp_node<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> full_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span> <span class="main">⟹</span> height <span class="free">t</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> order <span class="free">k</span> <span class="free">t</span> <span class="main">∧</span> bal <span class="free">t</span> <span class="main">∧</span> bound <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_full_node height_full_node order_full_node full_btrees_sharp<span class="main">)</span>


<span class="comment1">(* maximum number of nodes *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Maximum height for a given number of nodes"</span></span>


<span class="keyword1" id="BTree_Height-nodes_height_lower_bound"><span class="command">lemma</span></span> nodes_height_lower_bound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>order <span class="free">k</span> <span class="free">t</span><span class="main">;</span> bal <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> bound <span class="free">k</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nodes.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="main">(</span><span class="var">?sub_height</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_replicate <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="var">?sub_height</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_replicate_const<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> length_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 
    <span class="keyword1"><span class="command">using</span></span> sum_list_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bound <span class="free">k</span> <span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="free">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_mult_const<span class="main">[</span><span class="operator">of</span> <span class="quoted">nodes</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> <span class="var">?sub_height</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="skolem">t</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> 
        <span class="free">k</span>
        <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">*</span> <span class="free">k</span>
        <span class="main">+</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nodes.simps add_mult_distrib
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">=</span> 
     <span class="free">k</span> <span class="main">+</span> <span class="free">k</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_mult_distrib2 mult.assoc mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>Suc<span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_bal_tree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"To verify our upper bound is sharp, we compare it to the height of artificially constructed
minimally filled (=slim) trees."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">slim_node</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> btree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slim_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> Leaf"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">slim_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Node <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">slim_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">slim_node</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">in</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nodes <span class="bound">x</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>slim_node <span class="bound">k</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">in</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">]</span>"</span></span>


<span class="keyword1" id="BTree_Height-height_slim_node"><span class="command">lemma</span></span> height_slim_node<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>slim_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_replicate_conv_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-bal_slim_node"><span class="command">lemma</span></span> bal_slim_node<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>slim_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-order_slim_node"><span class="command">lemma</span></span> order_slim_node<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="main">(</span>slim_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> full_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-slim_nodes_sharp"><span class="command">lemma</span></span> slim_nodes_sharp<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>slim_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span> <span class="main">=</span> bound <span class="free">k</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> slim_node.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_slim_node <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_replicate compow_id_point<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-lower_bound_sharp_node"><span class="command">lemma</span></span> lower_bound_sharp_node<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> slim_node <span class="free">k</span> <span class="free">a</span> <span class="free">h</span> <span class="main">⟹</span> height <span class="free">t</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> order <span class="free">k</span> <span class="free">t</span> <span class="main">∧</span> bal <span class="free">t</span> <span class="main">∧</span> bound <span class="free">k</span> <span class="free">h</span> <span class="main">=</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_slim_node height_slim_node order_slim_node slim_nodes_sharp<span class="main">)</span>

<span class="comment1">(* TODO results for root_order/bal *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Since BTrees have special roots, we need to show the overall nodes seperately"</span></span>

<span class="keyword1" id="BTree_Height-nodes_root_height_lower_bound"><span class="command">lemma</span></span> nodes_root_height_lower_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>of_bool <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span>  <span class="main">≤</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sub_height</span> <span class="main">≤</span> length <span class="skolem">ts</span> <span class="main">*</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_replicate
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?sub_height</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_replicate_const<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> length_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node
      sum_list_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nodes <span class="bound">x</span> <span class="main">*</span> <span class="free">k</span>"</span></span><span class="main">]</span>
      nodes_height_lower_bound assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_mult_const<span class="main">[</span><span class="operator">of</span> <span class="quoted">nodes</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="skolem">t</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node assms nodes_height_lower_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">≥</span> 
        <span class="var">?sub_height</span>
        <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nodes.simps add_mult_distrib
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Node assms<span class="main">(</span>2<span class="main">)</span> height_bal_tree <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Height-nodes_root_height_upper_bound"><span class="command">lemma</span></span> nodes_root_height_upper_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nodes <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span>
        sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> nodes <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_mult_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="var">?sub_height</span><span class="main">)</span> <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node
      sum_list_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nodes <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      nodes_height_upper_bound assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span> <span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_replicate_const<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sub_height</span></span></span> <span class="quoted"><span class="quoted">"subtrees <span class="skolem">ts</span>"</span></span><span class="main">]</span> length_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">ts</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?sub_height</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_replicate <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Node
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map nodes <span class="main">(</span>subtrees <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?sub_height</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="skolem">t</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node assms nodes_height_upper_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> 
         <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>
        <span class="main">+</span> <span class="var">?sub_height</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>
        <span class="main">+</span> <span class="var">?sub_height</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nodes.simps add_mult_distrib
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_mult_distrib2 mult.assoc mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> height <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>Suc<span class="main">(</span>height <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Node assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_bal_tree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Height-root_order_imp_divmuleq"><span class="command">lemma</span></span> root_order_imp_divmuleq<span class="main">:</span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span>nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span> <span class="main">=</span> nodes <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_order.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BTree_Height-nodes_root_height_lower_bound_simp"><span class="command">lemma</span></span> nodes_root_height_lower_bound_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span>of_bool <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> nodes <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Node
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span>of_bool <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>of_bool <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node assms
    <span class="keyword1"><span class="command">using</span></span> div_plus_div_distrib_dvd_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="free">k</span> <span class="main">^</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> height_btree.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nodes_root_height_lower_bound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> div_le_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nodes <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root_order_imp_divmuleq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Height-nodes_root_height_upper_bound_simp"><span class="command">lemma</span></span> nodes_root_height_upper_bound_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nodes <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nodes <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>nodes <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> root_order_imp_divmuleq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> div_le_mono nodes_root_height_upper_bound<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">full_tree</span> <span class="main">=</span> full_node"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">slim_tree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slim_tree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">slim_tree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="main">[</span><span class="main">(</span>slim_node <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>slim_node <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BTree_Height-lower_bound_sharp"><span class="command">lemma</span></span> lower_bound_sharp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> slim_tree <span class="free">k</span> <span class="free">a</span> <span class="free">h</span> <span class="main">⟹</span> height <span class="free">t</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> root_order <span class="free">k</span> <span class="free">t</span> <span class="main">∧</span> bal <span class="free">t</span> <span class="main">∧</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="free">k</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>of_bool <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> slim_nodes_sharp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> bal_slim_node height_slim_node order_slim_node<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Height-upper_bound_sharp"><span class="command">lemma</span></span> upper_bound_sharp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> full_tree <span class="free">k</span> <span class="free">a</span> <span class="free">h</span> <span class="main">⟹</span> height <span class="free">t</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∧</span> root_order <span class="free">k</span> <span class="free">t</span> <span class="main">∧</span> bal <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> nodes <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> full_tree_def
  <span class="keyword1"><span class="command">using</span></span> order_impl_root_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_full_node height_full_node order_full_node full_btrees_sharp<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BTree_Set">
<div class="head">
<h1>Theory BTree_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_Set
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BTree">BTree</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Set_Specs.html">HOL-Data_Structures.Set_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Set interpretation"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary functions"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_half</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_half</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="BTree_Set-drop_not_empty"><span class="command">lemma</span></span> drop_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> drop <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-split_half_not_empty"><span class="command">lemma</span></span> split_half_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ls</span> <span class="bound">sub</span> <span class="bound">sep</span> <span class="bound">rs</span><span class="main">.</span> split_half <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> drop_not_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> drop0 drop_eq_Nil eq_snd_iff hd_Cons_tl le_trans not_one_le_zero split_half.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The split function locale"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Here, we abstract away the inner workings of the split function
      for B-tree operations."</span></span>

<span class="comment1">(* TODO what if we define a function "list_split" that returns
 a split list for mapping arbitrary f (separators) and g (subtrees)
s.th. f :: 'a ⇒ ('b::linorder) and g :: 'a ⇒ 'a btree
this would allow for key,pointer pairs to be inserted into the tree *)</span>
<span class="comment1">(* TODO what if the keys are the pointers? *)</span>
<span class="keyword1"><span class="command">locale</span></span> split <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">split</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> btree<span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split_req<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">split</span> <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">@</span> <span class="free">rs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">split</span> <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span><span class="main">;</span> sorted_less <span class="main">(</span>separators <span class="free">xs</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">sep</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">split</span> <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span><span class="main">;</span> sorted_less <span class="main">(</span>separators <span class="free">xs</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">sep</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> split_conc <span class="main">=</span> split_req<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> split_sorted <span class="main">=</span> split_req<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">sep</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="free">split</span> <span class="free">ts</span> <span class="free">y</span> <span class="main">⟹</span>
      size <span class="free">sub</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span>  <span class="main">+</span> size <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> split_conc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invar_inorder</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar_inorder</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>bal <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> root_order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_btree</span> <span class="main">=</span> Leaf"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Membership"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isin</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="main">(</span>Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">case</span> <span class="free">split</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="bound">sep</span> <span class="keyword1">then</span>
             True
          <span class="keyword1">else</span>
             <span class="free">isin</span> <span class="bound">sub</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
      <span class="main">)</span>
   <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">isin</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Insertion"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The insert function requires an auxiliary data structure
and auxiliary invariant functions."</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'b</span> up<span class="hidden">⇩</span><sub>i</sub> <span class="main">=</span> T<span class="hidden">⇩</span><sub>i</sub> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btree"</span></span> <span class="main">|</span> Up<span class="hidden">⇩</span><sub>i</sub> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btree"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btree"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">=</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">root_order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">=</span> root_order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">root_order_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">height_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">height_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">height_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bal_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> bal <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> bal <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> bal <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inorder_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inorder_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> inorder <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">inorder_up<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> inorder <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@</span> inorder <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The following function merges two nodes and returns separately split nodes
   if an overflow occurs"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node<span class="hidden">⇩</span><sub>i</sub></span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> btree <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> up<span class="hidden">⇩</span><sub>i</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span>
    <span class="keyword1">case</span> split_half <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span>
      Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="bound">ls</span> <span class="bound">sub</span><span class="main">)</span> <span class="bound">sep</span> <span class="main">(</span>Node <span class="bound">rs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> up<span class="hidden">⇩</span><sub>i</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">case</span> <span class="free">split</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">sep</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">sub</span> <span class="keyword1">of</span>
          Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
             node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="bound">ls</span> <span class="main">@</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span>
          T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">a</span> <span class="main">⇒</span>
            T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="main">(</span><span class="bound">ls</span> <span class="main">@</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
         Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
           node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="bound">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span> <span class="main">|</span>
         T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">a</span> <span class="main">⇒</span>
           T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="bound">ls</span> <span class="bound">a</span><span class="main">)</span>
  <span class="main">)</span>
<span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree<span class="hidden">⇩</span><sub>i</sub></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> up<span class="hidden">⇩</span><sub>i</sub> <span class="main">⇒</span> <span class="tfree">'a</span> btree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">tree<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> btree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> tree<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Deletion"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The following deletion method is inspired by Bayer (70) and Fielding (??).
Rather than stealing only a single node from the neighbour,
the neighbour is fully merged with the potentially underflowing node.
If the resulting node is still larger than allowed, the merged node is split
again, using the rules known from insertion splits.
If the resulting node has admissable size, it is simply kept in the tree."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rebalance_middle_tree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rebalance_middle_tree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> Leaf <span class="free"><span class="bound"><span class="entity">sep</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> Leaf <span class="main">=</span> <span class="main">(</span>
  Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="main">(</span>Leaf<span class="main">,</span><span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> Leaf
<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rebalance_middle_tree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">mts</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sep</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">tts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">mts</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">tts</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span>
    Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">mts</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">tts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span>
      <span class="keyword1">case</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mts</span></span></span><span class="main">@</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">tts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="keyword1">of</span>
       T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">u</span> <span class="main">⇒</span>
        Node <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="bound">u</span> <span class="main">|</span>
       Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
        Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span>
    <span class="main">(</span>Node <span class="bound">rts</span> <span class="bound">rt</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span> <span class="main">⇒</span> <span class="main">(</span>
      <span class="keyword1">case</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mts</span></span></span><span class="main">@</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="bound">rts</span><span class="main">)</span> <span class="bound">rt</span> <span class="keyword1">of</span>
      T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">u</span> <span class="main">⇒</span>
        Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">tts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">)</span> <span class="main">|</span>
      Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
        Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">tts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Deletion"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"All trees are merged with the right neighbour on underflow.
Obviously for the last tree this would not work since it has no right neighbour.
Therefore this tree, as the only exception, is merged with the left neighbour.
However since we it does not make a difference, we treat the situation
as if the second to last tree underflowed."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rebalance_last_tree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rebalance_last_tree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
<span class="keyword1">case</span> last <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">⇒</span>
   rebalance_middle_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="bound">sub</span> <span class="bound">sep</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Rather than deleting the minimal key from the right subtree,
we remove the maximal key of the left subtree.
This is due to the fact that the last tree can easily be accessed
and the left neighbour is way easier to access than the right neighbour,
it resides in the same pair as the separating element to be removed."</span></span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_max</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_max</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">=</span> last <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span>Node <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="bound">sub</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span>
<span class="main">)</span><span class="main">|</span>
<span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
<span class="keyword1">case</span> <span class="free">split_max</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span>rebalance_last_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">sub</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">case</span> <span class="free">split</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span>
     rebalance_last_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">ls</span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="bound">sep</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        rebalance_middle_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">ls</span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">sub</span><span class="main">)</span> <span class="bound">sep</span> <span class="bound">rs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">sub</span> <span class="main">=</span> Leaf <span class="keyword1">then</span>
        Node <span class="main">(</span><span class="bound">ls</span><span class="main">@</span><span class="bound">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub_s</span><span class="main">,</span> <span class="bound">max_s</span><span class="main">)</span> <span class="main">=</span> split_max <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">sub</span> <span class="keyword1">in</span>
        rebalance_middle_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">ls</span> <span class="bound">sub_s</span> <span class="bound">max_s</span> <span class="bound">rs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reduce_root</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_root</span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_root</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
   <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span>
   <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> reduce_root <span class="main">(</span>del <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"An invariant for intermediate states at deletion.
In particular we allow for an underflow to 0 subtrees."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">almost_order</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">almost_order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">almost_order</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
   order <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"A recursive property of the \"spine\" we want to walk along for splitting
    off the maximum of the left subtree."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nonempty_lasttreebal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonempty_lasttreebal</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nonempty_lasttreebal</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ls</span> <span class="bound">tsub</span> <span class="bound">tsep</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="bound">tsub</span><span class="main">,</span><span class="bound">tsep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> height <span class="bound">tsub</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="free">nonempty_lasttreebal</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Proofs of functional correctness"</span></span>

<span class="keyword1" id="BTree_Set-split_set"><span class="command">lemma</span></span> split_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ls</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ls</span> <span class="main">∪</span> set <span class="free">rs</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> <span class="free">b</span> <span class="main">∈</span> Basic_BNFs.snds <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> split_conc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BTree_Set-split_length"><span class="command">lemma</span></span> split_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">ls</span> <span class="main">+</span> length <span class="free">rs</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_conc<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Isin proof"</span></span>

<span class="keyword1"><span class="command">thm</span></span> isin_simps
  <span class="comment1">(* copied from comment in List_Ins_Del *)</span>
<span class="keyword1" id="BTree_Set-sorted_ConsD"><span class="command">lemma</span></span> sorted_ConsD<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_Cons_iff<span class="main">)</span>

<span class="keyword1" id="BTree_Set-sorted_snocD"><span class="command">lemma</span></span> sorted_snocD<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_snoc_iff<span class="main">)</span>


<span class="keyword1"><span class="command">lemmas</span></span> isin_simps2 <span class="main">=</span> sorted_lems sorted_ConsD sorted_snocD
  <span class="comment1">(*-----------------------------*)</span>

<span class="keyword1" id="BTree_Set-isin_sorted"><span class="command">lemma</span></span> isin_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">a</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">a</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isin_simps2<span class="main">)</span>

<span class="comment1">(* lift to split *)</span>


<span class="keyword1" id="BTree_Set-isin_sorted_split"><span class="command">lemma</span></span> isin_sorted_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_conc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ls_tail_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="skolem">ls'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rev_exhaust surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ls'</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_inorder_separators<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> split_conc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> ls_tail_split
    <span class="keyword1"><span class="command">using</span></span> isin_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder_list <span class="skolem">ls'</span> <span class="main">@</span> inorder <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="quoted">"inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_Set-isin_sorted_split_right"><span class="command">lemma</span></span> isin_sorted_split_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder_list <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">sep</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_inorder_separators<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append split_conc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> isin_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder <span class="free">sub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span>"</span></span> <span class="quoted"><span class="quoted">"inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> isin_set_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> isin <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> isin.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ts</span> <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">@</span> <span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isin <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> isin <span class="skolem">t</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span> list_split Nil
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_induct_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> isin_sorted_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> list_split list_conc Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> list_conc Cons a_split list_split
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isin <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> isin <span class="skolem">sub</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split Cons a_split False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> False a_split list_conc list_split local.Cons sorted_inorder_induct_subtree <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> isin_sorted_split<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"2.prems"</span> list_split<span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> isin_sorted_split_right <span class="quoted">"2.prems"</span> list_split Cons a_split False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>




<span class="comment1">(* TODO way to use this for custom case distinction? *)</span>
<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ls</span> <span class="bound">sub</span> <span class="bound">sep</span> <span class="bound">rs</span><span class="main">.</span> split_half <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_not_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BTree_Set-root_order_tree"><span class="command">lemma</span></span> root_order_tree<span class="hidden">⇩</span><sub>i</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"root_order_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> root_order <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">(</span>tree<span class="hidden">⇩</span><sub>i</sub> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_root_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_half_ts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="skolem">ls</span>"</span></span>
    <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> length <span class="free">ts</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_drop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def add_diff_cancel_right' list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">≥</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False length_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split_half_ts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_drop_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> o_r<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="main">(</span>Node <span class="skolem">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_ts assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≥</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_take assms split_half_ts False
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_half_ts
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> o_l<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_take_subset assms split_half_ts
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> o_r o_l <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps False split_half_ts<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_order_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">of</span> T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">t</span> <span class="main">⇒</span> order <span class="free">k</span> <span class="bound">t</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">ts</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_root_order node<span class="hidden">⇩</span><sub>i</sub>_order_helper assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> node<span class="hidden">⇩</span><sub>i</sub>_root_order assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> le0 length_greater_0_conv
      list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps order_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> root_order_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> up<span class="hidden">⇩</span><sub>i</sub>.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* explicit proof *)</span>
<span class="keyword1" id="BTree_Set-ins_order"><span class="command">lemma</span></span> ins_order<span class="main">:</span>
  <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span> <span class="main">⟹</span> order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_conc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">k</span> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 split_res
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil 2 split_app split_res Nil node<span class="hidden">⇩</span><sub>i</sub>_order
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up<span class="hidden">⇩</span><sub>i</sub>.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>  <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 a_prod Cons split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">k</span> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2.prems"</span> a_prod local.Cons split_app split_res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 split_app Cons length_append node<span class="hidden">⇩</span><sub>i</sub>_order a_prod split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up<span class="hidden">⇩</span><sub>i</sub>.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="comment1">(* notice this is almost a duplicate of ins_order *)</span>
<span class="keyword1" id="BTree_Set-ins_root_order"><span class="command">lemma</span></span> ins_root_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_conc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node assms split_res
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_order<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil Node split_app split_res assms node<span class="hidden">⇩</span><sub>i</sub>_root_order
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up<span class="hidden">⇩</span><sub>i</sub>.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>  <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Node a_prod Cons split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node a_prod assms ins_order local.Cons split_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms split_app Cons length_append Node node<span class="hidden">⇩</span><sub>i</sub>_root_order a_prod split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up<span class="hidden">⇩</span><sub>i</sub>.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>



<span class="keyword1" id="BTree_Set-height_list_split"><span class="command">lemma</span></span> height_list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free">ls</span> <span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">rs</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max.commute<span class="main">)</span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    split_half_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"split_half <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> node<span class="hidden">⇩</span><sub>i</sub>_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sep</span> <span class="main">(</span>Node <span class="skolem">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_ts
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id fst_conv height_list_split snd_conv split_half.elims<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>



<span class="keyword1" id="BTree_Set-bal_up"><span class="command">lemma</span></span> bal_up<span class="hidden">⇩</span><sub>i</sub>_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">t</span> <span class="main">=</span> bal <span class="main">(</span>tree<span class="hidden">⇩</span><sub>i</sub> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-bal_list_split"><span class="command">lemma</span></span> bal_list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free">ls</span> <span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">rs</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_constant_conv<span class="main">)</span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    split_half_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"split_half <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> node<span class="hidden">⇩</span><sub>i</sub>_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms append_take_drop_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split_half_ts assms False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bal.simps bal_up<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bal_list_split<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-height_up"><span class="command">lemma</span></span> height_up<span class="hidden">⇩</span><sub>i</sub>_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">⟹</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">tt</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">tt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-ins_height"><span class="command">lemma</span></span> ins_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_conc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> height_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> height_sub
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>i</sub> Nil split_list split_append
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> height_btree_order height_sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ls</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 Nil split_list Up<span class="hidden">⇩</span><sub>i</sub> split_append
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons a_split 2 split_list
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> height_btree.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> height_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">sub</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> a_split Cons split_list<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">a</span> <span class="main">=</span> height <span class="skolem">sub</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> height_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>i</sub> height_sub False Cons 2 split_list a_split split_append
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un max.commute finite_set_ins_swap<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">list</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">list</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> height_up<span class="hidden">⇩</span><sub>i</sub>_merge height_sub
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Up<span class="hidden">⇩</span><sub>i</sub> False Cons 2 split_list a_split split_append
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height image_Un max.commute finite_set_ins_swap<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="comment1">(* the below proof is overly complicated as a number of lemmas regarding height are missing *)</span>
<span class="keyword1" id="BTree_Set-ins_bal"><span class="command">lemma</span></span> ins_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span> <span class="main">⟹</span> bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_conc
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bal.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span> append_Nil2 bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bal_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ins_height local.Nil split_app split_res<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Nil T<span class="hidden">⇩</span><sub>i</sub> 2 split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>subtrees <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> bal <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>subtrees <span class="skolem">ls</span><span class="main">)</span><span class="main">.</span> height <span class="skolem">r</span> <span class="main">=</span> height <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 Up<span class="hidden">⇩</span><sub>i</sub> Nil split_res split_app
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">metis</span> height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ins_height max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ins.simps
        <span class="keyword1"><span class="command">using</span></span> Up<span class="hidden">⇩</span><sub>i</sub> Nil 2 split_res
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>  <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> a_prod 2 split_res Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 split_res
        <span class="keyword1"><span class="command">using</span></span> a_prod local.Cons split_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">x1</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"height <span class="skolem">x1</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span> a_prod add_diff_cancel_left' bal_split_left<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bal_split_left<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_bal_tree height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ins_height local.Cons plus_1_eq_Suc split_app<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> split_app Cons T<span class="hidden">⇩</span><sub>i</sub> 2 split_res a_prod
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
          <span class="comment1">(* The only case where explicit reasoning is required - likely due to the insertion of 2 elements in the list *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">list</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> bal <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Up<span class="hidden">⇩</span><sub>i</sub> split_app Cons 2 <span class="quoted"><span class="quoted">‹bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">list</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> height <span class="bound">x</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False Up<span class="hidden">⇩</span><sub>i</sub> split_app Cons 2 <span class="quoted"><span class="quoted">‹bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>›</span></span> ins_height split_res a_prod
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sup.idem sup_nat_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Up<span class="hidden">⇩</span><sub>i</sub> Cons 2 split_res a_prod
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(* ins acts as ins_list wrt inorder *)</span>

<span class="comment1">(* "simple enough" to be automatically solved *)</span>
<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="comment1">(* we want to only transform in one direction here.. *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> R <span class="main">=</span> sym<span class="main">[</span><span class="operator">OF</span> append_take_drop_id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">_</span> <span class="free">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> R
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> R<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_take_drop_id <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map drop_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>i</sub> <span class="free">t'</span> <span class="main">⟹</span> inorder <span class="free">t'</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> Up<span class="hidden">⇩</span><sub>i</sub> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> inorder_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons inorder_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder self_append_conv2<span class="main">)</span>


<span class="keyword1" id="BTree_Set-ins_sorted_inorder"><span class="command">lemma</span></span> ins_sorted_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="free">k</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> split_axioms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits list.splits up<span class="hidden">⇩</span><sub>i</sub>.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  node<span class="hidden">⇩</span><sub>i</sub>_inorder node<span class="hidden">⇩</span><sub>i</sub>_inorder_simps<span class="main">)</span>
    <span class="comment1">(* from here on we prefer an explicit proof, showing how to apply the IH  *)</span>
  <span class="keyword1"><span class="command">oops</span></span>


<span class="comment1">(* specialize ins_list_sorted since it is cumbersome to express
 "inorder_list ts" as "xs @ [a]" and always having to use the implicit properties of split*)</span>

<span class="keyword1" id="BTree_Set-ins_list_split"><span class="command">lemma</span></span> ins_list_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="free">ls</span> <span class="main">@</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_conc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ls_tail_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="skolem">ls'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_exhaust surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ls'</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_inorder_separators
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> ls_tail_split
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="free">ls</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_conc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> ins_list_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder_list <span class="skolem">ls'</span> <span class="main">@</span> inorder <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">sep</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_Set-ins_list_split_right_general"><span class="command">lemma</span></span> ins_list_split_right_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins_list <span class="free">x</span> <span class="main">(</span>inorder_list <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span> <span class="main">@</span> <span class="free">sep</span> <span class="main">#</span> inorder_list <span class="free">rs</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">sep</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_inorder_list_separators<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_pair <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> concat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> concat_append list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> map_append sorted_wrt_append split_conc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ins_list_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder <span class="free">sub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* this fits the actual use cases better *)</span>
<span class="keyword1"><span class="command">corollary</span></span> ins_list_split_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins_list <span class="free">x</span> <span class="main">(</span>inorder_list <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span> <span class="main">@</span> <span class="free">sep</span> <span class="main">#</span> inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append split.ins_list_split_right_general split_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="comment1">(* a simple lemma, missing from the standard as of now *)</span>
<span class="keyword1" id="BTree_Set-ins_list_idem_eq_isin"><span class="command">lemma</span></span> ins_list_idem_eq_isin<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span>ins_list <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-ins_list_contains_idem"><span class="command">lemma</span></span> ins_list_contains_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted_less <span class="free">xs</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>ins_list <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ins_list_idem_eq_isin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">declare</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>

<span class="keyword1" id="BTree_Set-ins_inorder"><span class="command">lemma</span></span> ins_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split.split_conc split_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"inorder <span class="skolem">a</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.prems"</span> list_split local.Nil sorted_inorder_induct_last
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split T<span class="hidden">⇩</span><sub>i</sub> Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_conc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> <span class="main">(</span>ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ins_list_split
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> list_split Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.prems"</span> list_split local.Nil sorted_inorder_induct_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split Up<span class="hidden">⇩</span><sub>i</sub> Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_conc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ins_list_split
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> list_split local.Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">list</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> h_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_inorder_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> list_conc local.Cons sorted_inorder_induct_subtree
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_conc h_split Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> ins_list_contains_idem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split h_split Cons True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"inorder <span class="skolem">a</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2.prems"</span> list_split Cons sorted_inorder_sub h_split False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder <span class="skolem">a</span> <span class="main">@</span> <span class="skolem">sep</span> <span class="main">#</span> inorder_list <span class="skolem">list</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> h_split False list_split T<span class="hidden">⇩</span><sub>i</sub> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">sep</span> <span class="main">#</span> inorder_list <span class="skolem">list</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ins_list_split ins_list_split_right
          <span class="keyword1"><span class="command">using</span></span> list_split <span class="quoted">"2.prems"</span> Cons h_split False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span> False h_split list_split local.Cons sorted_inorder_sub
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder <span class="skolem">l</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> inorder <span class="skolem">r</span>  <span class="main">@</span> <span class="skolem">sep</span> <span class="main">#</span> inorder_list <span class="skolem">list</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> h_split False list_split Up<span class="hidden">⇩</span><sub>i</sub> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">sep</span> <span class="main">#</span> inorder_list <span class="skolem">list</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ins_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ins_list_split ins_list_split_right
          <span class="keyword1"><span class="command">using</span></span> list_split <span class="quoted">"2.prems"</span> Cons h_split False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">thm</span></span> ins.induct
<span class="keyword1"><span class="command">thm</span></span> btree.induct

<span class="comment1">(* wrapped up insert invariants *)</span>

<span class="keyword1" id="BTree_Set-tree"><span class="command">lemma</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">u</span> <span class="main">⟹</span> bal <span class="main">(</span>tree<span class="hidden">⇩</span><sub>i</sub> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-tree"><span class="command">lemma</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> root_order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">u</span><span class="main">⟧</span> <span class="main">⟹</span> root_order <span class="free">k</span> <span class="main">(</span>tree<span class="hidden">⇩</span><sub>i</sub> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-tree"><span class="command">lemma</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">u</span> <span class="main">=</span> inorder <span class="main">(</span>tree<span class="hidden">⇩</span><sub>i</sub> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-insert_bal"><span class="command">lemma</span></span> insert_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span> <span class="main">⟹</span> bal <span class="main">(</span>insert <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ins_bal
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_bal<span class="main">)</span>

<span class="keyword1" id="BTree_Set-insert_order"><span class="command">lemma</span></span> insert_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> root_order <span class="free">k</span> <span class="main">(</span>insert <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ins_root_order
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">)</span>


<span class="keyword1" id="BTree_Set-insert_inorder"><span class="command">lemma</span></span> insert_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder <span class="main">(</span>insert <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ins_inorder
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>i</sub>_inorder<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Deletion proofs"</span></span>

<span class="keyword1"><span class="command">thm</span></span> list.simps



<span class="keyword1" id="BTree_Set-rebalance_middle_tree_height"><span class="command">lemma</span></span> rebalance_middle_tree_height<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height <span class="free">sub</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">rs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>rebalance_middle_tree <span class="free">k</span> <span class="free">ls</span> <span class="free">sub</span> <span class="free">sep</span> <span class="free">rs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> height_Leaf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tts</span></span> <span class="skolem"><span class="skolem">tt</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="skolem">tts</span> <span class="skolem">tt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> height_Leaf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mts</span></span> <span class="skolem"><span class="skolem">mt</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Node <span class="skolem">mts</span> <span class="skolem">mt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sub</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">mts</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">∧</span> length <span class="skolem">tts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> max <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_list_split sub_node t_node<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> height_max<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">mt</span><span class="main">,</span> <span class="free">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">u</span> <span class="main">=</span> max <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> height_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="free">ls</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil False T<span class="hidden">⇩</span><sub>i</sub>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_node t_node<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>  height <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> height_max <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Up<span class="hidden">⇩</span><sub>i</sub> Nil sub_node t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rsub</span></span> <span class="skolem"><span class="skolem">rsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rsub</span><span class="main">,</span> <span class="skolem">rsep</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rts</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rsub</span> <span class="main">=</span> Node <span class="skolem">rts</span> <span class="skolem">rt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> Cons height_Leaf Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rsub</span></span><span class="main">)</span> <span class="operator">simp_all</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> max <span class="main">(</span>height <span class="skolem">rsub</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r_node height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_list_split max.commute sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> height_max<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">mt</span><span class="main">,</span> <span class="free">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="skolem">rsub</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">u</span> <span class="main">=</span> max <span class="main">(</span>height <span class="skolem">rsub</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> height_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>i</sub> False Cons r_node a_split sub_node t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> height_max<span class="main">:</span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>height <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="skolem">rsub</span><span class="main">)</span> <span class="main">(</span>height <span class="free">sub</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> height_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons a_split r_node Up<span class="hidden">⇩</span><sub>i</sub> sub_node t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_node t_node<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BTree_Set-rebalance_last_tree_height"><span class="command">lemma</span></span> rebalance_last_tree_height<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height <span class="free">sub</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">list</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>rebalance_last_tree <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_height assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_Set-split_max_height"><span class="command">lemma</span></span> split_max_height<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"split_max <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_lasttreebal <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">sub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">sub</span></span> <span class="quoted"><span class="free">sep</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Node1<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">tsub</span></span> <span class="skolem"><span class="skolem">tsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> tts_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tts</span> <span class="main">=</span> <span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">tsub</span><span class="main">,</span><span class="skolem">tsep</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tt</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">tsub</span><span class="main">,</span><span class="skolem">tsep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">tsub</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>height <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> height_btree_last height_btree_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">tsub</span><span class="main">,</span> <span class="skolem">tsep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Leaf Node1 tts_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Leaf Node1 height_Leaf max_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Node2<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">subsub</span></span> <span class="skolem"><span class="skolem">subsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">tt</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">subsub</span><span class="main">,</span><span class="skolem">subsep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">tt</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">subsub</span> <span class="main">=</span> height <span class="skolem">tt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node1 Node2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">tts</span> <span class="skolem">subsub</span><span class="main">,</span> <span class="skolem">subsep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node1 Node2 tts_split sub_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_height Node1 Node2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_Set-order_bal_nonempty_lasttreebal"><span class="command">lemma</span></span> order_bal_nonempty_lasttreebal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">;</span> bal <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> nonempty_lasttreebal <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> order.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">tsub</span></span> <span class="skolem"><span class="skolem">tsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">tsub</span><span class="main">,</span><span class="skolem">tsep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_fst_iff length_greater_0_conv snoc_eq_iff_butlast<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">tsub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> ts_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonempty_lasttreebal <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 order_impl_root_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-bal_sub_height"><span class="command">lemma</span></span> bal_sub_height<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">a</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> height <span class="bound">sub</span> <span class="main">=</span> height <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="BTree_Set-del_height"><span class="command">lemma</span></span> del_height<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">;</span> bal <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> height <span class="main">(</span>del <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">list</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">list</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">list</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 list_split order_bal_nonempty_lasttreebal
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">lls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_conc 2 list_split Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_bal_nonempty_lasttreebal<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Node <span class="skolem">ls</span> <span class="skolem">t</span> <span class="main">=</span> Node <span class="skolem">ts</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_conc Nil list_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_height 2 list_split Nil split_conc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max.assoc sup_nat_def max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rs_height<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span> <span class="comment1">(* notice the difference if rsub and t are switched *)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> bal_sub_height list_split split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>sep_n_x<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Leaf<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Node<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">sub</span> <span class="main">=</span> Node <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> btree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> sep_n_x
      <span class="keyword1"><span class="command">have</span></span> height_t_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> height <span class="skolem">sub</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> a_split list_split local.Cons split.split_set<span class="main">(</span>1<span class="main">)</span> split_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> height_t_del<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> a_split bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split local.Cons order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sep_n_x some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">sep</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rs_height rebalance_middle_tree_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> height_t_sub <span class="quoted">"2.prems"</span> height_t_del
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 a_split sep_n_x list_split Cons split_set<span class="main">(</span>1<span class="main">)</span> split_conc
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> sep_n_x Cons a_split list_split 2
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Leaf
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_split_last<span class="main">(</span>2<span class="main">)</span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> a_split list_split Cons split_conc
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> a_split list_split Cons sep_x_Leaf 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Node
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sts</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sub</span> <span class="main">=</span> Node <span class="skolem">sts</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub_s</span></span> <span class="skolem"><span class="skolem">max_s</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span> <span class="skolem">max_s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub_s</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> a_split bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_split Cons order_bal_nonempty_lasttreebal order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_max_height sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="skolem">sub_s</span> <span class="skolem">max_s</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rs_height rebalance_middle_tree_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 a_split sep_x_Node list_split Cons split_set<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹height <span class="skolem">sub_s</span> <span class="main">=</span> height <span class="skolem">t</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_conc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sep_x_Node Cons a_split list_split 2 sub_node sub_split
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(* proof for inorders *)</span>

<span class="comment1">(* note: this works (as it should, since there is not even recursion involved)
  automatically. *yay* *)</span>
<span class="keyword1" id="BTree_Set-rebalance_middle_tree_inorder"><span class="command">lemma</span></span> rebalance_middle_tree_inorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height <span class="free">sub</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">rs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>rebalance_middle_tree <span class="free">k</span> <span class="free">ls</span> <span class="free">sub</span> <span class="free">sep</span> <span class="free">rs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sub</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> btree.splits up<span class="hidden">⇩</span><sub>i</sub>.splits list.splits
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_inorder_simps
      <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-rebalance_last_tree_inorder"><span class="command">lemma</span></span> rebalance_last_tree_inorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height <span class="free">sub</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">list</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>rebalance_last_tree <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_inorder assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_Set-butlast_inorder_app_id"><span class="command">lemma</span></span> butlast_inorder_app_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span> <span class="main">⟹</span> inorder_list <span class="free">xs'</span> <span class="main">@</span> inorder <span class="free">sub</span> <span class="main">@</span> <span class="main">[</span><span class="free">sep</span><span class="main">]</span> <span class="main">=</span> inorder_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-split_max_inorder"><span class="command">lemma</span></span> split_max_inorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonempty_lasttreebal <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inorder_pair <span class="main">(</span>split_max <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> butlast <span class="skolem">ts</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">ts</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Leaf
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits btree.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_inorder_app_id<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder_pair <span class="main">(</span>split_max <span class="skolem">k</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_sub_sep<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> height_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Node btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split_max_height<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder_pair <span class="main">(</span>split_max <span class="skolem">k</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">sep</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node 1 split_sub_sep <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ts</span> <span class="main">@</span> inorder <span class="skolem">sub</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">sep</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_inorder height_sub <span class="quoted">"1.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rebalance_last_tree.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH split_sub_sep <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1" id="BTree_Set-height_bal_subtrees_merge"><span class="command">lemma</span></span> height_bal_subtrees_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>height <span class="main">(</span>Node <span class="free">as</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="free">bs</span> <span class="free">b</span><span class="main">)</span><span class="main">;</span> bal <span class="main">(</span>Node <span class="free">as</span> <span class="free">a</span><span class="main">)</span><span class="main">;</span> bal <span class="main">(</span>Node <span class="free">bs</span> <span class="free">b</span><span class="main">)</span><span class="main">⟧</span>
 <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="free">as</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">.</span> height <span class="bound">x</span> <span class="main">=</span> height <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_inject Un_iff bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_bal_tree singletonD<span class="main">)</span>

<span class="keyword1" id="BTree_Set-bal_list_merge"><span class="command">lemma</span></span> bal_list_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free">as</span> <span class="free">a</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>Node <span class="free">bs</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>subtrees <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> bal <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subtrees_split assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>subtrees <span class="free">as</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>subtrees <span class="free">bs</span><span class="main">)</span><span class="main">.</span> height <span class="bound">x</span> <span class="main">=</span> height <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms height_bal_subtrees_merge
    <span class="keyword1"><span class="command">unfolding</span></span> bal_up<span class="hidden">⇩</span><sub>i</sub>.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal_up<span class="hidden">⇩</span><sub>i</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_list<span class="main">:</span> <span class="quoted"><span class="quoted">"split_half <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">sep</span> <span class="main">(</span>Node <span class="skolem">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id fst_conv local.split_list snd_conv split_half.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bal_list_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bal.simps bal_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal node<span class="hidden">⇩</span><sub>i</sub>_bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="BTree_Set-rebalance_middle_tree_bal"><span class="command">lemma</span></span> rebalance_middle_tree_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> bal <span class="main">(</span>rebalance_middle_tree <span class="free">k</span> <span class="free">ls</span> <span class="free">sub</span> <span class="free">sep</span> <span class="free">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> t_node<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span> <span class="free">sep</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mts</span></span> <span class="skolem"><span class="skolem">mt</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Node <span class="skolem">mts</span> <span class="skolem">mt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sub</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_node<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sub_heights<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">sub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">sub</span>"</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">mts</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">∧</span> length <span class="skolem">tts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> t_node sub_node assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bal.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>height <span class="skolem">tt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> height_bal_tree height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_list_split max.idem sub_heights<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sub_node t_node<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> height_bal_tree sub_heights<span class="main">(</span>3<span class="main">)</span> t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bal_list_merge bal_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal sub_heights<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sub_node t_node<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms Nil sub_node t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rsub</span></span> <span class="skolem"><span class="skolem">rsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rsub</span><span class="main">,</span><span class="skolem">rsep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rsub_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">rsub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">rsub</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rts</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rsub</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">rts</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rsub</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>Node <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_height <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>height <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff  <span class="quoted"><span class="quoted">‹height <span class="skolem">rsub</span> <span class="main">=</span> height <span class="free">t</span>›</span></span> assms bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bal_split_last<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> height_bal_tree height_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> height_list_split list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons max.idem r_node r_split set_append some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height <span class="skolem">rsub</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> height_bal_tree r_node rsub_height<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"height_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">rsub</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bal_list_merge bal_up<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> node<span class="hidden">⇩</span><sub>i</sub>_bal r_node rsub_height<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rsub_height<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_heights<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">u</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">rsep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 Cons assms t_node subtrees_split sub_heights r_split rsub_height
          <span class="keyword1"><span class="command">unfolding</span></span> bal.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> height_btree.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons assms t_node sub_node r_split r_node False T<span class="hidden">⇩</span><sub>i</sub>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps bal.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">rsep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 Cons assms t_node subtrees_split sub_heights r_split rsub_height
          <span class="keyword1"><span class="command">unfolding</span></span> bal.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> height_btree.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons assms t_node sub_node r_split r_node False Up<span class="hidden">⇩</span><sub>i</sub>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps bal.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_Leaf<span class="main">)</span>


<span class="keyword1" id="BTree_Set-rebalance_last_tree_bal"><span class="command">lemma</span></span> rebalance_last_tree_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bal <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> <span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> bal <span class="main">(</span>rebalance_last_tree <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_bal append_butlast_last_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"last <span class="free">ts</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bal.simps rebalance_middle_tree.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="BTree_Set-split_max_bal"><span class="command">lemma</span></span> split_max_bal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_lasttreebal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>fst <span class="main">(</span>split_max <span class="free">k</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> last_split<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 last_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 Leaf last_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 Node
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split_max_height<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">sub</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> Node t_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 t_split Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_bal t_split Node 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bal.simps rebalance_middle_tree.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="BTree_Set-del_bal"><span class="command">lemma</span></span> del_bal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>del <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 list_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 del_height <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ts</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 Nil order_bal_nonempty_lasttreebal rebalance_last_tree_bal
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_split split_conc Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 list_split Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sub_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">sub</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 Cons list_split split_set<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>sep_n_x<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Leaf<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Node<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">sub</span> <span class="main">=</span> Node <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> btree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> sep_n_x
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">sub</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub_height
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split local.Cons order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split Cons order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> del_height split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_height<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> list_split Cons r_split split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_substitute_subtree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">sep</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_bal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="quoted">"del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 list_split Cons r_split sep_n_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Leaf
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_split_last<span class="main">(</span>1<span class="main">)</span> list_split split_conc r_split
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 list_split Cons r_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Node
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sts</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sub</span> <span class="main">=</span> Node <span class="skolem">sts</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub_s</span></span> <span class="skolem"><span class="skolem">max_s</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span> <span class="skolem">max_s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub_s</span> <span class="main">=</span> height <span class="skolem">sub</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_max_height
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_split Cons order_bal_nonempty_lasttreebal order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_height<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">sub_s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_max_bal
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv list_split local.Cons order_bal_nonempty_lasttreebal order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_height<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub_node sub_split<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> list_split Cons r_split split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_substitute_subtree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sub_s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span><span class="skolem">max_s</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_substitute_separator <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="skolem">sub_s</span> <span class="skolem">max_s</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_bal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub_s</span></span> <span class="quoted"><span class="skolem">max_s</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 list_split Cons r_split sep_x_Node sub_node sub_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1" id="BTree_Set-rebalance_middle_tree_order"><span class="command">lemma</span></span> rebalance_middle_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="free">sub</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">rs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> True"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">sub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="main">(</span>rebalance_middle_tree <span class="free">k</span> <span class="free">ls</span> <span class="free">sub</span> <span class="free">sep</span> <span class="free">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> height_Leaf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Leaf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> t_node<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mts</span></span> <span class="skolem"><span class="skolem">mt</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Node <span class="skolem">mts</span> <span class="skolem">mt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sub</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">mts</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">∧</span> length <span class="skolem">tts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">sub</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_node<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True t_node sub_node assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span>"</span></span> <span class="quoted"><span class="skolem">tt</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> t_node sub_node
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> order_up<span class="hidden">⇩</span><sub>i</sub>.simps node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms t_node sub_node False Nil <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rsub</span></span> <span class="skolem"><span class="skolem">rsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rsub</span><span class="main">,</span><span class="skolem">rsep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rsub_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">rsub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rts</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rsub</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">rts</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rsub</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> t_node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span>"</span></span> <span class="quoted"><span class="skolem">rt</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> t_node sub_node r_node r_split Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> order_up<span class="hidden">⇩</span><sub>i</sub>.simps node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rts</span><span class="main">)</span> <span class="skolem">rt</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms t_node sub_node False Cons r_split r_node <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* we have to proof the order invariant once for an underflowing last tree *)</span>
<span class="keyword1" id="BTree_Set-rebalance_middle_tree_last_order"><span class="command">lemma</span></span> rebalance_middle_tree_last_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">sub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="main">(</span>rebalance_middle_tree <span class="free">k</span> <span class="free">ls</span> <span class="free">sub</span> <span class="free">sep</span> <span class="free">rs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> height_Leaf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Leaf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> t_node<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">tts</span> <span class="skolem">tt</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mts</span></span> <span class="skolem"><span class="skolem">mt</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">=</span> Node <span class="skolem">mts</span> <span class="skolem">mt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sub</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">mts</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">∧</span> length <span class="skolem">tts</span> <span class="main">≥</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">sub</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_node<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True t_node sub_node assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order_up<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span>node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> node<span class="hidden">⇩</span><sub>i</sub>_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span>"</span></span> <span class="quoted"><span class="skolem">tt</span></span><span class="main">]</span> assms t_node sub_node
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> order_up<span class="hidden">⇩</span><sub>i</sub>.simps node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="skolem">mts</span><span class="main">@</span><span class="main">(</span><span class="skolem">mt</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">tts</span><span class="main">)</span> <span class="skolem">tt</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms t_node sub_node False Nil <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_Set-rebalance_last_tree_order"><span class="command">lemma</span></span> rebalance_last_tree_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>subtrees <span class="main">(</span><span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> order <span class="free">k</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">sub</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="main">(</span>rebalance_last_tree <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_last_order assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_Set-split_max_order"><span class="command">lemma</span></span> split_max_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_lasttreebal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="main">(</span>fst <span class="main">(</span>split_max <span class="free">k</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ts_not_empty 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_sub</span></span> <span class="skolem"><span class="skolem">s_max</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s_sub</span><span class="main">,</span> <span class="skolem">s_max</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">s_sub</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Node Pair_inject append1_eq_conv btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split_max_height sub_split ts_not_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ts</span> <span class="skolem">s_sub</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">s_sub</span></span><span class="main">]</span>
        1 ts_not_empty Node sub_split
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Node 1 sub_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1" id="BTree_Set-del_order"><span class="command">lemma</span></span> del_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="free">k</span> <span class="main">(</span>del <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">list</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">list</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">list</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 list_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lls</span></span> <span class="skolem"><span class="skolem">lsub</span></span> <span class="skolem"><span class="skolem">lsep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ls_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> <span class="skolem">lls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="skolem">lsub</span><span class="main">,</span><span class="skolem">lsep</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 Nil list_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_bal_nonempty_lasttreebal split_conc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> del_height 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil list_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">lls</span></span> <span class="quoted"><span class="skolem">lsub</span></span> <span class="quoted"><span class="skolem">lsep</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Un_iff append_Nil2 bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split Nil root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> singletonI split_conc subtrees_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 list_split Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> inductive_help<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="main">(</span>subtrees <span class="main">(</span><span class="skolem">ls</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> order <span class="skolem">k</span> <span class="bound">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="main">(</span><span class="skolem">ls</span> <span class="main">@</span> <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
      <span class="quoted"><span class="quoted">"order <span class="skolem">k</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons r_split <span class="quoted">"2.prems"</span> list_split split_set
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_conc <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>sep_n_x<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Leaf<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
      <span class="main">(</span>sep_x_Node<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">sub</span> <span class="main">=</span> Node <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> btree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> sep_n_x
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 list_split Cons r_split order_impl_root_order
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split Cons order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> del_height split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">sep</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">sep</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> inductive_help
        <span class="keyword1"><span class="command">using</span></span> Cons r_split sep_n_x list_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 Cons r_split sep_n_x list_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Leaf
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inductive_help <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 Cons r_split sep_x_Leaf list_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Node
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sts</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sub</span> <span class="main">=</span> Node <span class="skolem">sts</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub_s</span></span> <span class="skolem"><span class="skolem">max_s</span></span> <span class="keyword2"><span class="keyword">where</span></span> sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub_s</span><span class="main">,</span> <span class="skolem">max_s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub_s</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_max_height
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_split Cons order_bal_nonempty_lasttreebal order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sub_node<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="skolem">sub_s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_max_order
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv list_split local.Cons order_bal_nonempty_lasttreebal order_impl_root_order r_split root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  sub_node sub_split<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_order <span class="skolem">k</span> <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="skolem">sub_s</span> <span class="skolem">max_s</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">sub_s</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">max_s</span></span><span class="main">]</span> inductive_help
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 Cons r_split list_split sep_x_Node sub_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(* sortedness of delete by inorder *)</span>
<span class="comment1">(* generalize del_list_sorted since its cumbersome to express inorder_list ts as xs @ [a]
note that the proof scheme is almost identical to ins_list_sorted
 *)</span>
<span class="keyword1"><span class="command">thm</span></span> del_list_sorted

<span class="keyword1" id="BTree_Set-del_list_split"><span class="command">lemma</span></span> del_list_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="free">ls</span> <span class="main">@</span> del_list <span class="free">x</span> <span class="main">(</span>inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_conc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ls_tail_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="skolem">ls'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_exhaust surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ls'</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> ls_tail_split sorted_inorder_separators
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder_list <span class="free">ls</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append split_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> split_conc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> del_list_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder_list <span class="skolem">ls'</span> <span class="main">@</span> inorder <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">sep</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* del sorted requires sortedness of the full list so we need to change the right specialization a bit *)</span>

<span class="keyword1" id="BTree_Set-del_list_split_right"><span class="command">lemma</span></span> del_list_split_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="free">ts</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"del_list <span class="free">x</span> <span class="main">(</span>inorder_list <span class="main">(</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">sub</span><span class="main">)</span> <span class="main">@</span> <span class="free">sep</span> <span class="main">#</span> inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">sep</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_inorder_separators <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> split_req<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">sub</span> <span class="main">@</span> <span class="free">sep</span> <span class="main">#</span> inorder_list <span class="free">rs</span> <span class="main">@</span> inorder <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"inorder_list <span class="free">ls</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> split_conc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> del_list_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder <span class="free">sub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> del_list_idem

<span class="keyword1" id="BTree_Set-del_inorder"><span class="command">lemma</span></span> del_inorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"root_order <span class="free">k</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>del <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">@</span> <span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split.split_conc split_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_split order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sorted_inorder_induct_last<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>rebalance_last_tree <span class="skolem">k</span> <span class="skolem">ts</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_split Nil list_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ts</span> <span class="main">@</span> inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ts'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nonempty_lasttreebal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_bal_nonempty_lasttreebal<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">sub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> del_height order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> rebalance_last_tree_inorder
        <span class="keyword1"><span class="command">using</span></span> ts_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ts</span> <span class="main">@</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>4<span class="main">)</span> list_conc list_split Nil del_list_split
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> h_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> node_sorted_split<span class="main">:</span>
      <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"root_order <span class="skolem">k</span> <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"bal <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> h_split list_conc Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>sep_n_x<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="main">(</span>sep_x_Leaf<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">sub</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>  <span class="main">(</span>sep_x_Node<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">sub</span> <span class="main">=</span> Node <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> btree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> sep_n_x
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">=</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bal_split_left<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h_split list_split local.Cons node_sorted_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> node_sorted_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sorted_inorder_induct_subtree split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sep_n_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">sep</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split Cons h_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> height <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> del_height
          <span class="keyword1"><span class="command">using</span></span> order_impl_root_order <span class="quoted">"2.prems"</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order Cons list_conc h_split<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span> <span class="bound">rsep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> bal_sub_height list_conc Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_inorder
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">sep</span> <span class="main">#</span> inorder_list <span class="skolem">rs</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> del_list_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> del_list_split_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> list_split list_conc h_split Cons <span class="quoted">"2.prems"</span><span class="main">(</span>4<span class="main">)</span> sep_n_x
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Leaf
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder <span class="main">(</span>Node <span class="main">(</span><span class="skolem">ls</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_conc h_split Cons
        <span class="keyword1"><span class="command">using</span></span> del_list_split<span class="main">[</span><span class="operator">OF</span> list_split <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split sep_x_Leaf list_conc h_split Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sep_x_Node
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ssub</span></span> <span class="skolem"><span class="skolem">ssep</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_max <span class="skolem">k</span> <span class="skolem">sub</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ssub</span><span class="main">,</span> <span class="skolem">ssep</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> sep_x_Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"del_list <span class="skolem">x</span> <span class="main">(</span>inorder <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder <span class="skolem">sub</span> <span class="main">@</span> inorder_list <span class="skolem">rs</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split list_conc h_split Cons <span class="quoted">"2.prems"</span><span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> del_list_split<span class="main">[</span><span class="operator">OF</span> list_split <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> del_list_sorted1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inorder <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">sep</span></span> <span class="quoted"><span class="quoted">"inorder_list <span class="skolem">rs</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
          sorted_wrt_append
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder_pair <span class="main">(</span>split_max <span class="skolem">k</span> <span class="skolem">sub</span><span class="main">)</span> <span class="main">@</span> inorder_list <span class="skolem">rs</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sym<span class="main">[</span><span class="operator">OF</span> split_max_inorder<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> order_bal_nonempty_lasttreebal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">sub</span></span><span class="main">]</span> <span class="quoted">"2.prems"</span>
          list_conc h_split Cons sep_x_Node
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_max.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder_list <span class="skolem">ls</span> <span class="main">@</span> inorder <span class="skolem">ssub</span> <span class="main">@</span> <span class="skolem">ssep</span> <span class="main">#</span> inorder_list <span class="skolem">rs</span> <span class="main">@</span> inorder <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="main">(</span>rebalance_middle_tree <span class="skolem">k</span> <span class="skolem">ls</span> <span class="skolem">ssub</span> <span class="skolem">ssep</span> <span class="skolem">rs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> height <span class="skolem">ssub</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> split_max_height
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> bal.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> btree.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> h_split list_split local.Cons order_bal_nonempty_lasttreebal order_impl_root_order root_order.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sep_x_Node some_child_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_split<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">rsub</span><span class="main">,</span> <span class="bound">rsep</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span> height <span class="bound">rsub</span> <span class="main">=</span> height <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>3<span class="main">)</span> bal_sub_height list_conc local.Cons
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> rebalance_middle_tree_inorder
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inorder <span class="main">(</span>del <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_split sep_x_Node list_conc h_split Cons split_split
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_Set-reduce_root_order"><span class="command">lemma</span></span> reduce_root_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> almost_order <span class="free">k</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> root_order <span class="free">k</span> <span class="main">(</span>reduce_root <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_impl_root_order<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_Set-reduce_root_bal"><span class="command">lemma</span></span> reduce_root_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>reduce_root <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bal <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="BTree_Set-reduce_root_inorder"><span class="command">lemma</span></span> reduce_root_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>reduce_root <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="BTree_Set-delete_order"><span class="command">lemma</span></span> delete_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> bal <span class="free">t</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> root_order <span class="free">k</span> <span class="main">(</span>delete <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_order
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_root_order<span class="main">)</span>

<span class="keyword1" id="BTree_Set-delete_bal"><span class="command">lemma</span></span> delete_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> bal <span class="free">t</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> bal <span class="main">(</span>delete <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_bal
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_root_bal<span class="main">)</span>

<span class="keyword1" id="BTree_Set-delete_inorder"><span class="command">lemma</span></span> delete_inorder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> bal <span class="free">t</span><span class="main">;</span> root_order <span class="free">k</span> <span class="free">t</span><span class="main">;</span> sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> inorder <span class="main">(</span>delete <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> del_inorder
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reduce_root_inorder<span class="main">)</span>

<span class="comment1">(* TODO (opt) runtime wrt runtime of split *)</span>

<span class="comment1">(* we are interested in a) number of comparisons b) number of fetches c) number of writes *)</span>
<span class="comment1">(* a) is dependent on t_split, the remainder is not (we assume the number of fetches and writes
for split fun is 0 *)</span>


<span class="comment1">(* TODO simpler induction schemes /less boilerplate isabelle/src/HOL/ex/Induction_Schema *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Set specification by inorder"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> S_ordered<span class="main">:</span> Set_by_Ordered <span class="keyword2"><span class="keyword">where</span></span>
  empty <span class="main">=</span> <span class="quoted">empty_btree</span> <span class="keyword2"><span class="keyword">and</span></span>
  insert <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  delete <span class="main">=</span> <span class="quoted"><span class="quoted">"delete <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  isin <span class="main">=</span> <span class="quoted"><span class="quoted">"isin"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  inorder <span class="main">=</span> <span class="quoted"><span class="quoted">"inorder"</span></span>   <span class="keyword2"><span class="keyword">and</span></span>
  inv <span class="main">=</span> <span class="quoted"><span class="quoted">"invar_inorder <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isin_set_inorder<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_inorder
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> delete_inorder
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_order insert_bal
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> delete_order delete_bal
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_btree_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="comment1">(* if we remove this, it is not possible to remove the simp rules in subsequent contexts... *)</span>
<span class="keyword1"><span class="command">declare</span></span> node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BTree_Split">
<div class="head">
<h1>Theory BTree_Split</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_Split
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#BTree_Set">BTree_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Abstract split functions"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Linear split"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Finally we show that the split axioms are feasible
       by providing an example split function"</span></span>

<span class="comment1">(*TODO: at some point this better be replaced with something binary search like *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">linear_split_help</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list <span class="main">⇒</span>  <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linear_split_help</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">prev</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">prev</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">linear_split_help</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">prev</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">sep</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">linear_split_help</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">prev</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">prev</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">sep</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">linear_split</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linear_split</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> linear_split_help <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Linear split is similar to well known functions, therefore a quick proof can be done."</span></span>

<span class="keyword1" id="BTree_Split-linear_split_alt"><span class="command">lemma</span></span> linear_split_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_split <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">&lt;</span><span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">,</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">&lt;</span><span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear_split_help <span class="free">xs</span> <span class="free">x</span> <span class="skolem">prev</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">prev</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">,</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">prev</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">prev</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> btree_linear_search<span class="main">:</span> split <span class="quoted">linear_split</span>
  <span class="comment1">(* the below definitions are required to be set here for evaluating example code... *)</span>
  <span class="keyword2"><span class="keyword">defines</span></span> btree_ls_isin <span class="main">=</span> <span class="quoted">btree_linear_search.isin</span> 
    <span class="keyword2"><span class="keyword">and</span></span> btree_ls_ins <span class="main">=</span> <span class="quoted">btree_linear_search.ins</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_ls_insert <span class="main">=</span> <span class="quoted">btree_linear_search.insert</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_ls_del <span class="main">=</span> <span class="quoted">btree_linear_search.del</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_ls_delete <span class="main">=</span> <span class="quoted">btree_linear_search.delete</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">unfolding</span></span> linear_split_alt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodD in_set_conv_decomp takeWhile_eq_all_conv takeWhile_idem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv hd_dropWhile le_less_linear list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Some examples follow to show that the implementation works
      and the above lemmas make sense. The examples are visualized in the thesis."</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">btree<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≡</span> btree_ls_insert"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">btree<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">≡</span> btree_ls_delete"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      root_order <span class="bound">k</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      bal <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      sorted_less <span class="main">(</span>inorder <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="numeral">9</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="main">1</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="numeral">9</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      btree<span class="hidden">⇩</span><sub>d</sub> <span class="bound">k</span> <span class="numeral">10</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="main">1</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="numeral">9</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span><span class="main">=</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">;</span> <span class="bound">x</span><span class="main">::</span>nat btree <span class="main">=</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">6</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">,</span> <span class="numeral">10</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>Node <span class="main">[</span><span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">14</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="numeral">20</span><span class="main">)</span><span class="main">]</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      btree<span class="hidden">⇩</span><sub>d</sub> <span class="bound">k</span> <span class="numeral">3</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>d</sub> <span class="bound">k</span> <span class="numeral">10</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="main">1</span> <span class="main">(</span>btree<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="numeral">9</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"For completeness, we also proved an explicit proof of the locale
requirements."</span></span>

<span class="keyword1" id="BTree_Split-some_child_sm"><span class="command">lemma</span></span> some_child_sm<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_split_help <span class="free">t</span> <span class="free">y</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">sep</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_split_help.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject le_less_linear list.inject<span class="main">)</span>



<span class="keyword1" id="BTree_Split-linear_split_append"><span class="command">lemma</span></span> linear_split_append<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_split_help <span class="free">xs</span> <span class="free">p</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ls</span><span class="main">@</span><span class="free">rs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">@</span><span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_split_help.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>

<span class="keyword1" id="BTree_Split-linear_split_sm"><span class="command">lemma</span></span> linear_split_sm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>linear_split_help <span class="free">xs</span> <span class="free">p</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span><span class="main">;</span> sorted_less <span class="main">(</span>separators <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">sep</span> <span class="main">∈</span> set <span class="main">(</span>separators <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="bound">sep</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">sep</span> <span class="main">∈</span> set <span class="main">(</span>separators <span class="free">ls</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="bound">sep</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_split_help.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"linear_split <span class="main">[</span><span class="main">(</span><span class="main">(</span>Leaf<span class="main">::</span>nat btree<span class="main">)</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>

<span class="comment1">(* TODO still has format for older proof *)</span>
<span class="keyword1" id="BTree_Split-linear_split_gr"><span class="command">lemma</span></span> linear_split_gr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>linear_split_help <span class="free">xs</span> <span class="free">p</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span><span class="main">;</span> sorted_less <span class="main">(</span>separators <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="bound">sep</span><span class="main">⟧</span> <span class="main">⟹</span> 
<span class="main">(</span><span class="keyword1">case</span> <span class="free">rs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">p</span> <span class="main">≤</span> <span class="bound">sep</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_child_sm<span class="main">)</span>


<span class="keyword1" id="BTree_Split-linear_split_req"><span class="command">lemma</span></span> linear_split_req<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"linear_split <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">#</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">sep</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms linear_split_gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="BTree_Split-linear_split_req2"><span class="command">lemma</span></span> linear_split_req2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"linear_split <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">sep</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linear_split_sm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">sub</span><span class="main">,</span><span class="free">sep</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv Un_iff append_self_conv2 empty_iff empty_set linear_split.elims prod_set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> separators_split snd_eqD snds.intros<span class="main">)</span>


<span class="keyword1"><span class="command">interpretation</span></span> split <span class="quoted">linear_split</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linear_split_req linear_split_req2 linear_split_append split_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Binary split"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"It is possible to define a binary split predicate.
      However, even proving that it terminates is uncomfortable."</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">binary_split_help</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span>  <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">_</span><span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">binary_split_help</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">binary_split_help</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mls</span><span class="main">,</span> <span class="bound">mrs</span><span class="main">)</span> <span class="main">=</span> split_half <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>
  <span class="keyword1">case</span> <span class="bound">mrs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">#</span><span class="bound">mrrs</span> <span class="main">⇒</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="bound">sep</span> <span class="keyword1">then</span> <span class="free">binary_split_help</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="bound">mls</span> <span class="main">(</span><span class="bound">mrs</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="bound">sep</span> <span class="keyword1">then</span> <span class="free">binary_split_help</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="bound">mls</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">mrrs</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">@</span><span class="bound">mls</span><span class="main">,</span> <span class="bound">mrs</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>
    <span class="main">)</span>
  <span class="main">)</span>
<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ls</span><span class="main">,</span><span class="bound">xs</span><span class="main">,</span><span class="bound">rs</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id length_Cons length_append lessI trans_less_add2<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">binary_split</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">binary_split</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> binary_split_help <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We can show that it will return sublists that concatenate to
      the original list again but will not show that it fulfils sortedness properties."</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"binary_split_help <span class="free">as</span> <span class="free">bs</span> <span class="free">cs</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> binary_split_help.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_not_empty <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ls a b va rs  x lsa rsa aa ba x22
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cmp <span class="skolem">x</span> <span class="skolem">ba</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI append_eq_appendI append_take_drop_id<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI append_eq_appendI append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted_less <span class="main">(</span>separators <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> binary_split_help <span class="free">as</span> <span class="free">bs</span> <span class="free">cs</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>separators <span class="free">as</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">⟧</span>
<span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>separators <span class="free">ls</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">oops</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Array_SBlit">
<div class="head">
<h1>Theory Array_SBlit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Array_SBlit
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../separation_logic_imperative_hol/theories/#Array_Blit">Separation_Logic_Imperative_HOL.Array_Blit</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Same array Blit"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The standard framework already provides a function to copy array
      elements."</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">blit</span>
<span class="keyword1"><span class="command">thm</span></span> blit_rule
<span class="keyword1"><span class="command">thm</span></span> blit.simps
  <span class="comment1">(* Same array BLIT *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sblit</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> blit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"When copying values within arrays,
      blit only works for moving elements to the left."</span></span>

<span class="keyword1" id="Array_SBlit-sblit_rule"><span class="command">lemma</span></span> sblit_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">si</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">lsrc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> DST_SM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">di</span> <span class="main">≤</span> <span class="free">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    sblit <span class="free">src</span> <span class="free">si</span> <span class="free">di</span> <span class="free">len</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="free">di</span> <span class="free">lsrc</span> <span class="main">@</span> take <span class="free">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">lsrc</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sblit_def
  <span class="keyword1"><span class="command">using</span></span> LEN DST_SM
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">len</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lsrc</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="free">di</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span> <span class="main">=</span> Suc.IH      

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">lsrc</span> <span class="main">!</span> <span class="skolem">si</span> <span class="main">#</span> take <span class="skolem">len</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">si</span><span class="main">)</span> <span class="skolem">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="bound">x</span>
      <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_Suc_right Cons_nth_drop_Suc
        less_Suc_eq_le add.commute not_less_eq take_Suc_Cons 
        Nat.trans_le_add2<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_update_last drop_upd_irrelevant<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"A reverse blit"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The function rblit may be used to copy elements a defined offset to the right"</span></span>

<span class="comment1">(* Right BLIT or Reverse BLIT *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rblit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">_</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rblit</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main">=</span> return <span class="main">()</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rblit</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">;</span>
      Array.upd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">di</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">;</span>
      <span class="free">rblit</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"For separated arrays it is equivalent to normal blit.
      The proof follows similarly to the corresponding proof for blit."</span></span>

<span class="keyword1" id="Array_SBlit-rblit_rule"><span class="command">lemma</span></span> rblit_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">lsrc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">di</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">ldst</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span> 
      <span class="main">*</span> <span class="free">dst</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ldst</span> <span class="main">&gt;</span>
    rblit <span class="free">src</span> <span class="free">si</span> <span class="free">dst</span> <span class="free">di</span> <span class="free">len</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span> 
      <span class="main">*</span> <span class="free">dst</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="free">di</span> <span class="free">ldst</span> <span class="main">@</span> take <span class="free">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">ldst</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LEN
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">len</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ldst</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span> <span class="main">=</span> Suc.IH

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">di</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ldst</span><span class="main">[</span><span class="free">di</span> <span class="main">+</span> <span class="skolem">len</span> <span class="main">:=</span> <span class="free">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
      <span class="main">=</span> <span class="free">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">#</span>  drop <span class="main">(</span>Suc <span class="main">(</span><span class="free">di</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ldst</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_le_eq add_Suc_right drop_upd_irrelevant length_list_update lessI nth_list_update_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">len</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_leD1 nth_drop take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> take <span class="skolem">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span>
     <span class="free">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="free">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_update_last drop_upd_irrelevant<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">srblit</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> rblit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"However, within arrays we can now copy to the right."</span></span>

<span class="keyword1" id="Array_SBlit-srblit_rule"><span class="command">lemma</span></span> srblit_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">di</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">lsrc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> DST_GR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">di</span> <span class="main">≥</span> <span class="free">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    srblit <span class="free">src</span> <span class="free">si</span> <span class="free">di</span> <span class="free">len</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="free">di</span> <span class="free">lsrc</span> <span class="main">@</span> take <span class="free">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">lsrc</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> srblit_def
  <span class="keyword1"><span class="command">using</span></span> LEN DST_GR
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">len</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">lsrc</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="free">di</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span> <span class="main">=</span> Suc.IH

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">len</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="main">(</span><span class="skolem">lsrc</span><span class="main">[</span><span class="skolem">di</span> <span class="main">+</span> <span class="skolem">len</span> <span class="main">:=</span> <span class="skolem">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> take <span class="skolem">len</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">sledgehammer</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ab_semigroup_add_class.add.commute add_le_cancel_right take_drop take_update_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">di</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lsrc</span><span class="main">[</span><span class="skolem">di</span> <span class="main">+</span> <span class="skolem">len</span> <span class="main">:=</span> <span class="skolem">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
         <span class="main">=</span> <span class="skolem">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">si</span><span class="main">+</span><span class="skolem">len</span><span class="main">)</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">di</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">lsrc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_Suc_right add_Suc_shift add_less_cancel_left append_take_drop_id le_imp_less_Suc le_refl plus_1_eq_Suc same_append_eq take_update_cancel upd_conv_take_nth_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">len</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span> <span class="main">@</span>
     <span class="main">[</span><span class="skolem">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">len</span> <span class="main">&lt;</span> length <span class="skolem">lsrc</span> <span class="main">-</span> <span class="skolem">si</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_leD1 le_add_diff_inverse length_drop nth_drop take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> take <span class="skolem">len</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span> <span class="main">@</span>
     <span class="skolem">lsrc</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">si</span> <span class="main">+</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">si</span> <span class="skolem">lsrc</span><span class="main">)</span> <span class="main">@</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_update_last drop_upd_irrelevant<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Modeling target language blit"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"For convenience, a function that is oblivious to the direction of the shift
      is defined."</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">safe_sblit</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">then</span>
      sblit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
    <span class="keyword1">else</span>
      srblit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We obtain a heap rule similar to the one of blit,
      but for copying within one array."</span></span>

<span class="keyword1" id="Array_SBlit-safe_sblit_rule"><span class="command">lemma</span></span> safe_sblit_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">di</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">lsrc</span> <span class="main">∧</span> <span class="free">si</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> length <span class="free">lsrc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    safe_sblit <span class="free">src</span> <span class="free">si</span> <span class="free">di</span> <span class="free">len</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="free">di</span> <span class="free">lsrc</span> <span class="main">@</span> take <span class="free">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">lsrc</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_sblit_def
  <span class="keyword1"><span class="command">using</span></span> LEN
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">len</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sblit_def srblit_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Compare this to blit_rule *)</span>
<span class="keyword1"><span class="command">thm</span></span> blit_rule
<span class="keyword1"><span class="command">thm</span></span> safe_sblit_rule

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Code Generator Setup"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Note that the requirement for correctness
      is even weaker here than in SML.
      We therefore manually handle the case where length is 0 (in which case nothing happens at all)."</span></span>

<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"array_sblit"</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span>
  <span class="quoted">‹
   fun array_sblit src si di len = (
      if len &gt; 0 then
        ArraySlice.copy {
          di = IntInf.toInt di,
          src = ArraySlice.slice (src,IntInf.toInt si,SOME (IntInf.toInt len)),
          dst = src}
      else ()
    )
›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_sblit'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">safe_sblit'</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> 
      <span class="main">=</span> safe_sblit <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">(</span>nat_of_integer <span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">)</span> <span class="main">(</span>nat_of_integer <span class="free"><span class="bound"><span class="entity">di</span></span></span><span class="main">)</span> 
          <span class="main">(</span>nat_of_integer <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_sblit <span class="free">src</span> <span class="free">si</span> <span class="free">di</span> <span class="free">len</span> 
      <span class="main">=</span> safe_sblit' <span class="free">src</span> <span class="main">(</span>integer_of_nat <span class="free">si</span><span class="main">)</span> <span class="main">(</span>integer_of_nat <span class="free">di</span><span class="main">)</span> 
          <span class="main">(</span>integer_of_nat <span class="free">len</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_sblit'_def<span class="main">)</span>

<span class="comment1">(* TODO: Export to other languages: OCaml, Haskell *)</span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">safe_sblit'</span> <span class="main">⇀</span>
  <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"(fn/ ()/ =&gt; /array'_sblit _ _ _ _)"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"{ ('_: Unit)/=&gt;/
      def safescopy(src: Array['_], srci: Int, dsti: Int, len: Int) = {
       if (len &gt; 0)
          System.arraycopy(src, srci, src, dsti, len)
        else
          ()
      }
      safescopy(_.array,_.toInt,_.toInt,_.toInt)
    }"</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">safe_sblit</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML Scala


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Derived operations"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_shr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_shr</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  safe_sblit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"Array.len"</span></span>

<span class="keyword1" id="Array_SBlit-array_shr_rule"><span class="command">lemma</span></span> array_shr_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    array_shr <span class="free">src</span> <span class="free">i</span> <span class="free">k</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">lsrc</span> <span class="main">@</span> take <span class="main">(</span>length <span class="free">lsrc</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">lsrc</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_shr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1" id="Array_SBlit-array_shr_rule_alt"><span class="command">lemma</span></span> array_shr_rule_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    array_shr <span class="free">src</span> <span class="free">i</span> <span class="free">k</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">lsrc</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">lsrc</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">lsrc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_shl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_shl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  safe_sblit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
<span class="main">}</span>
"</span></span>

<span class="keyword1" id="Array_SBlit-array_shl_rule"><span class="command">lemma</span></span> array_shl_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"
    <span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    array_shl <span class="free">src</span> <span class="free">i</span> <span class="free">k</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">k</span><span class="main">)</span> <span class="free">lsrc</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">lsrc</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">lsrc</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_shl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>


<span class="keyword1" id="Array_SBlit-array_shl_rule_alt"><span class="command">lemma</span></span> array_shl_rule_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"
    <span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> length <span class="free">lsrc</span><span class="main">;</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">lsrc</span>  <span class="main">&gt;</span>
    array_shl <span class="free">src</span> <span class="free">i</span> <span class="free">k</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">src</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">k</span><span class="main">)</span> <span class="free">lsrc</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">lsrc</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="free">lsrc</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="free">lsrc</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Partially_Filled_Array">
<div class="head">
<h1>Theory Partially_Filled_Array</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Partially_Filled_Array
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#IICF_Array_List">Refine_Imperative_HOL.IICF_Array_List</a>"</span>
    <a href="#Array_SBlit">Array_SBlit</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Partially Filled Arrays"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An array that is only partially filled.
The number of actual elements contained is kept in a second element.
This represents a weakened version of the array\_list from IICF.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pfarray <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array_list"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Operations on Partly Filled Arrays"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_pfa</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_pfa</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">l'</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l'</span> <span class="main">*</span>  <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> length <span class="bound">l'</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>take <span class="bound">n</span> <span class="bound">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Partially_Filled_Array-is_pfa_prec"><span class="command">lemma</span></span> is_pfa_prec<span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"precise <span class="main">(</span>is_pfa <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_pfa_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> preciseI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> preciseD snga_prec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_init</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a</span> <span class="main">←</span> Array.new <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_init_rule"><span class="command">lemma</span></span> pfa_init_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">&lt;</span> <span class="keyword1">emp</span> <span class="main">&gt;</span> pfa_init <span class="free">N</span> <span class="free">x</span> <span class="free">n</span> <span class="main">&lt;</span>is_pfa <span class="free">N</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_init_def is_pfa_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_empty</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">≡</span> pfa_init <span class="free"><span class="bound"><span class="entity">cap</span></span></span> default <span class="main">0</span>"</span></span>



<span class="keyword1" id="Partially_Filled_Array-pfa_empty_rule"><span class="command">lemma</span></span> pfa_empty_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="keyword1">emp</span> <span class="main">&gt;</span> pfa_empty <span class="free">N</span> <span class="main">&lt;</span>is_pfa <span class="free">N</span> <span class="main">[]</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_empty_def is_pfa_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_length</span> <span class="main">≡</span> arl_length"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_length_rule"><span class="command">lemma</span></span> pfa_length_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
    pfa_length <span class="free">a</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span><span class="main">=</span>length <span class="free">l</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_length_def arl_length_def is_pfa_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_capacity</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> Array.len <span class="bound">a</span>
"</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_capacity_rule"><span class="command">lemma</span></span> pfa_capacity_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
    pfa_capacity <span class="free">a</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">c</span><span class="main">=</span><span class="bound">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_capacity_def arl_length_def is_pfa_def<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_is_empty</span> <span class="main">≡</span> arl_is_empty"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_is_empty_rule"><span class="command">lemma</span></span> pfa_is_empty_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
    pfa_is_empty <span class="free">a</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span><span class="main">⟷</span><span class="main">(</span><span class="free">l</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_is_empty_def arl_is_empty_def is_pfa_def<span class="main">)</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_append</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  Array.upd <span class="bound">n</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_append_rule"><span class="command">lemma</span></span> pfa_append_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
   <span class="free">n</span> <span class="main">&lt;</span> <span class="free">c</span>  <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> 
      pfa_append <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">x</span> 
    <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_append_def arl_append_def is_pfa_def take_update_last neq_Nil_conv
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.split<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_last</span> <span class="main">≡</span> arl_last"</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_last_rule"><span class="command">lemma</span></span> pfa_last_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">l</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
    pfa_last <span class="free">a</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span><span class="main">=</span>last <span class="free">l</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_last_def arl_last_def is_pfa_def last_take_nth_conv<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_butlast</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap pfarray <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_butlast</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span>
    return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>
  "</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_butlast_rule"><span class="command">lemma</span></span> pfa_butlast_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span> 
    pfa_butlast <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span>butlast <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_butlast_def is_pfa_def butlast_take<span class="main">)</span>  


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_get</span> <span class="main">≡</span> arl_get"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_get_rule"><span class="command">lemma</span></span> pfa_get_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span>
  <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
    pfa_get <span class="free">a</span> <span class="free">i</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pfa_def pfa_get_def arl_get_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_set</span> <span class="main">≡</span> arl_set"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_set_rule"><span class="command">lemma</span></span> pfa_set_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">i</span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">⟹</span>
    <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span><span class="main">&gt;</span> 
      pfa_set <span class="free">a</span> <span class="free">i</span> <span class="free">x</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_set_def arl_set_def is_pfa_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>





<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_shrink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap pfarray <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_shrink</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span>
  return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
"</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_shrink_rule"><span class="command">lemma</span></span> pfa_shrink_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
   <span class="free">k</span> <span class="main">≤</span> length <span class="free">l</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> 
      pfa_shrink <span class="free">k</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">a'</span><span class="main">=</span><span class="free">a</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_shrink_def is_pfa_def min.absorb1
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.split<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_shrink_cap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap pfarray <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_shrink_cap</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> array_shrink <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a'</span><span class="main">,</span>min <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">n</span><span class="main">)</span>
<span class="main">}</span>
"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_shrink_cap_rule_preserve"><span class="command">lemma</span></span> pfa_shrink_cap_rule_preserve<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
   <span class="main">⟦</span><span class="free">n</span> <span class="main">≤</span> <span class="free">k</span><span class="main">;</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> 
      pfa_shrink_cap <span class="free">k</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> is_pfa <span class="free">k</span> <span class="free">l</span> <span class="bound">a'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_shrink_cap_def is_pfa_def min.absorb1 min.absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.split<span class="main">)</span>



<span class="keyword1" id="Partially_Filled_Array-pfa_shrink_cap_rule"><span class="command">lemma</span></span> pfa_shrink_cap_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
   <span class="main">⟦</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">&gt;</span> 
      pfa_shrink_cap <span class="free">k</span> <span class="free">a</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> is_pfa <span class="free">k</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">l</span><span class="main">)</span> <span class="bound">a'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_shrink_cap_def is_pfa_def min.absorb1 min.absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mod_starD<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">array_ensure</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">l</span><span class="main">←</span>Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">l</span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> 
      return <span class="free"><span class="bound"><span class="entity">a</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a'</span><span class="main">←</span>Array.new <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
      blit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="bound">a'</span> <span class="main">0</span> <span class="bound">l</span><span class="main">;</span>
      return <span class="bound">a'</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-array_ensure_rule"><span class="command">lemma</span></span> array_ensure_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
      <span class="main">&lt;</span> <span class="free">a</span><span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span><span class="free">la</span> <span class="main">&gt;</span> 
        array_ensure <span class="free">a</span> <span class="free">s</span> <span class="free">x</span> 
      <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span><span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span><span class="free">la</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">s</span><span class="main">-</span>length <span class="free">la</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_ensure_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="comment1">(* Ensure a certain capacity *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_ensure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">}</span> pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_ensure</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">k</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> array_ensure <span class="bound">a</span> <span class="bound">k</span> default<span class="main">;</span>
  return <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span>
<span class="main">}</span>
"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_ensure_rule"><span class="command">lemma</span></span> pfa_ensure_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> 
      pfa_ensure <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">k</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span>max <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_ensure_def is_pfa_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_copy</span> <span class="main">≡</span> arl_copy"</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_copy_rule"><span class="command">lemma</span></span> pfa_copy_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">&gt;</span>
   pfa_copy <span class="free">a</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">*</span> is_pfa <span class="free">c</span> <span class="free">l</span> <span class="bound">r</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pfa_copy_def arl_copy_def is_pfa_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_blit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_blit</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">src</span><span class="main">,</span><span class="bound">sn</span><span class="main">)</span> <span class="bound">si</span> <span class="main">(</span><span class="bound">dst</span><span class="main">,</span><span class="bound">dn</span><span class="main">)</span> <span class="bound">di</span> <span class="bound">l</span><span class="main">.</span> blit <span class="bound">src</span> <span class="bound">si</span> <span class="bound">dst</span> <span class="bound">di</span> <span class="bound">l</span>"</span></span>


<span class="keyword1" id="Partially_Filled_Array-min_nat"><span class="command">lemma</span></span> min_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">a</span> <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Partially_Filled_Array-pfa_blit_rule"><span class="command">lemma</span></span> pfa_blit_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> <span class="free">sn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">di</span> <span class="main">≤</span> <span class="free">dn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">di</span><span class="main">+</span><span class="free">len</span> <span class="main">≤</span> <span class="free">dc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> is_pfa <span class="free">sc</span> <span class="free">src</span> <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span>
      <span class="main">*</span> is_pfa <span class="free">dc</span> <span class="free">dst</span> <span class="main">(</span><span class="free">dsti</span><span class="main">,</span><span class="free">dn</span><span class="main">)</span> <span class="main">&gt;</span>
    pfa_blit <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span> <span class="free">si</span> <span class="main">(</span><span class="free">dsti</span><span class="main">,</span><span class="free">dn</span><span class="main">)</span> <span class="free">di</span> <span class="free">len</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> is_pfa <span class="free">sc</span> <span class="free">src</span> <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span>
      <span class="main">*</span> is_pfa <span class="free">dc</span> <span class="main">(</span>take <span class="free">di</span> <span class="free">dst</span> <span class="main">@</span> take <span class="free">len</span> <span class="main">(</span>drop <span class="free">si</span> <span class="free">src</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">dst</span><span class="main">)</span> <span class="main">(</span><span class="free">dsti</span><span class="main">,</span>max <span class="main">(</span><span class="free">di</span><span class="main">+</span><span class="free">len</span><span class="main">)</span> <span class="free">dn</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LEN <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_nat is_pfa_def pfa_blit_def min.commute min.absorb1 <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> blit_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min.absorb1 take_drop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_take max_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_drop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> pfarray <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_drop</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">src</span><span class="main">,</span><span class="bound">sn</span><span class="main">)</span> <span class="bound">si</span> <span class="main">(</span><span class="bound">dst</span><span class="main">,</span><span class="bound">dn</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
   blit <span class="bound">src</span> <span class="bound">si</span> <span class="bound">dst</span> <span class="main">0</span> <span class="main">(</span><span class="bound">sn</span><span class="main">-</span><span class="bound">si</span><span class="main">)</span><span class="main">;</span>
   return <span class="main">(</span><span class="bound">dst</span><span class="main">,</span><span class="main">(</span><span class="bound">sn</span><span class="main">-</span><span class="bound">si</span><span class="main">)</span><span class="main">)</span>
<span class="main">}</span>
"</span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_drop_rule"><span class="command">lemma</span></span> pfa_drop_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">sn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sn</span><span class="main">-</span><span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">dc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> is_pfa <span class="free">sc</span> <span class="free">src</span> <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span>
      <span class="main">*</span> is_pfa <span class="free">dc</span> <span class="free">dst</span> <span class="main">(</span><span class="free">dsti</span><span class="main">,</span><span class="free">dn</span><span class="main">)</span> <span class="main">&gt;</span>
    pfa_drop <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span><span class="free">dsti</span><span class="main">,</span><span class="free">dn</span><span class="main">)</span>
    <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">dsti'</span><span class="main">,</span><span class="bound">dn'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">sc</span> <span class="free">src</span> <span class="main">(</span><span class="free">srci</span><span class="main">,</span><span class="free">sn</span><span class="main">)</span>
      <span class="main">*</span> is_pfa <span class="free">dc</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">src</span><span class="main">)</span> <span class="main">(</span><span class="bound">dsti'</span><span class="main">,</span><span class="bound">dn'</span><span class="main">)</span>
      <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">dsti'</span> <span class="main">=</span> <span class="free">dsti</span><span class="main">)</span>
    <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LEN <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_take is_pfa_def pfa_drop_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> pfa_blit_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_append_grow</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span> <span class="main">←</span> pfa_capacity <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">a'</span> <span class="main">←</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">n</span> 
  <span class="keyword1">then</span> array_grow <span class="bound">a</span> <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span>
  <span class="keyword1">else</span> Array.upd <span class="bound">n</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
<span class="main">}</span>"</span></span>



<span class="keyword1" id="Partially_Filled_Array-pfa_append_grow_full_rule"><span class="command">lemma</span></span> pfa_append_grow_full_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span>
     <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  array_grow <span class="free">a</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span>
      <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> is_pfa <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def 
      <span class="quasi_keyword">heap</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> array_grow_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">vcg</span> <span class="quasi_keyword">heap</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> array_grow_rule <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> array_grow_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">(</span>length <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Partially_Filled_Array-pfa_append_grow_less_rule"><span class="command">lemma</span></span> pfa_append_grow_less_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">⟹</span>
 <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
    Array.upd <span class="free">n</span> <span class="free">x</span> <span class="free">a</span>
<span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def take_update_last<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_append_grow_rule"><span class="command">lemma</span></span> pfa_append_grow_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_append_grow <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">x</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="free">c</span><span class="main">+</span><span class="main">1</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> pfa_append_grow_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span>
      <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfa_append_grow_full_rule pfa_append_grow_less_rule<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* This definition has only one access to the array length *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_append_grow'</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> pfa_ensure <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">a''</span> <span class="main">←</span> pfa_append <span class="bound">a'</span> <span class="bound">x</span><span class="main">;</span>
  return <span class="bound">a''</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_append_grow'_rule"><span class="command">lemma</span></span> pfa_append_grow'_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_append_grow' <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">x</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span>max <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_append_grow'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_insert</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> array_shr <span class="bound">a</span> <span class="bound">i</span> <span class="main">1</span><span class="main">;</span>
  <span class="bound">a''</span> <span class="main">←</span> Array.upd <span class="bound">i</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a''</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
<span class="main">}</span>"</span></span>


<span class="keyword1" id="Partially_Filled_Array-list_update_last"><span class="command">lemma</span></span> list_update_last<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">=</span> Suc <span class="free">i</span> <span class="main">⟹</span> <span class="free">ls</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ls</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj length_Suc_rev_conv list_update_length<span class="main">)</span>

<span class="keyword1" id="Partially_Filled_Array-pfa_insert_rule"><span class="command">lemma</span></span> pfa_insert_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_insert <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">l</span><span class="main">@</span><span class="free">x</span><span class="main">#</span>drop <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="free">a</span><span class="main">=</span><span class="bound">a'</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_insert_def is_pfa_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_append1 list_update_last
      Suc_diff_le drop_take min_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_insert_grow</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">}</span> pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> pfarray Heap"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_insert_grow</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> pfa_ensure <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">a''</span> <span class="main">←</span> pfa_insert <span class="bound">a'</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">;</span>
  return <span class="bound">a''</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_insert_grow_rule"><span class="command">lemma</span></span> pfa_insert_grow_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_insert_grow <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span>max <span class="free">c</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">l</span><span class="main">@</span><span class="free">x</span><span class="main">#</span>drop <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_insert_grow_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfa_insert_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"max <span class="free">c</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_extend</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_extend</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
  blit <span class="bound">b</span> <span class="main">0</span> <span class="bound">a</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="bound">m</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_extend_rule"><span class="command">lemma</span></span> pfa_extend_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">+</span><span class="free">m</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l1</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_extend <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_extend_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def min.absorb1 min.absorb2 <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blit_rule<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_extend_grow</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_extend_grow</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> array_ensure <span class="bound">a</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="bound">m</span><span class="main">)</span> default<span class="main">;</span>
  blit <span class="bound">b</span> <span class="main">0</span> <span class="bound">a'</span> <span class="bound">n</span> <span class="bound">m</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="bound">m</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_extend_grow_rule"><span class="command">lemma</span></span> pfa_extend_grow_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l1</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_extend_grow <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span>max <span class="free">c</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="free">m</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_extend_grow_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def min.absorb1 min.absorb2 <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blit_rule<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfa_append_extend_grow</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pfa_append_extend_grow</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span><span class="main">{</span>
  <span class="bound">a'</span> <span class="main">←</span> array_ensure <span class="bound">a</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="bound">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> default<span class="main">;</span>
  <span class="bound">a''</span> <span class="main">←</span> Array.upd <span class="bound">n</span> <span class="bound">x</span> <span class="bound">a'</span><span class="main">;</span>
  blit <span class="bound">b</span> <span class="main">0</span> <span class="bound">a''</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">m</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a''</span><span class="main">,</span><span class="bound">n</span><span class="main">+</span><span class="bound">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_append_extend_grow_rule"><span class="command">lemma</span></span> pfa_append_extend_grow_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l1</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_append_extend_grow <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="main">(</span>max <span class="free">c</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span><span class="main">=</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≥</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> is_pfa <span class="free">d</span> <span class="free">l2</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">m</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_append_extend_grow_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_last is_pfa_def min.absorb1 min.absorb2 <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blit_rule<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfa_delete</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  array_shl <span class="bound">a</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">1</span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Partially_Filled_Array-pfa_delete_rule"><span class="command">lemma</span></span> pfa_delete_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
  pfa_delete <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">i</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">l</span><span class="main">@</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">n'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span> <span class="main">∧</span> <span class="free">a</span><span class="main">=</span><span class="bound">a'</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pfa_delete_def is_pfa_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_take min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc diff_zero dual_order.strict_trans2 le_less_Suc_eq zero_le<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Basic_Assn">
<div class="head">
<h1>Theory Basic_Assn</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Basic_Assn
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#Sepref_HOL_Bindings">Refine_Imperative_HOL.Sepref_HOL_Bindings</a>"</span>
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#Sepref_Basic">Refine_Imperative_HOL.Sepref_Basic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Auxilary imperative assumptions"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The following auxiliary assertion types and lemmas were provided by Peter Lammich"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List-Assn›</span></span>



<span class="keyword1" id="Basic_Assn-list_assn_cong"><span class="command">lemma</span></span> list_assn_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span><span class="main">=</span><span class="free">xs'</span><span class="main">;</span> <span class="free">ys</span><span class="main">=</span><span class="free">ys'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">;</span> <span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">A'</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟧</span> <span class="main">⟹</span> list_assn <span class="free">A</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> list_assn <span class="free">A'</span> <span class="free">xs'</span> <span class="free">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_assn.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1" id="Basic_Assn-list_assn_app_one"><span class="command">lemma</span></span> list_assn_app_one<span class="main">:</span> <span class="quoted"><span class="quoted">"list_assn <span class="free">P</span> <span class="main">(</span><span class="free">l1</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">l1'</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> list_assn <span class="free">P</span> <span class="free">l1</span> <span class="free">l1'</span> <span class="main">*</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* ------------------ ADDED by NM in course of btree_imp -------- *)</span>


<span class="keyword1" id="Basic_Assn-list_assn_len"><span class="command">lemma</span></span> list_assn_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> list_assn <span class="free">A</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_assn_aux_ineq_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1" id="Basic_Assn-list_assn_append_Cons_left"><span class="command">lemma</span></span> list_assn_append_Cons_left<span class="main">:</span> <span class="quoted"><span class="quoted">"list_assn <span class="free">A</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">zs1</span> <span class="bound">z</span> <span class="bound">zs2</span><span class="main">.</span> list_assn <span class="free">A</span> <span class="free">xs</span> <span class="bound">zs1</span> <span class="main">*</span> <span class="free">A</span> <span class="free">x</span> <span class="bound">z</span> <span class="main">*</span> list_assn <span class="free">A</span> <span class="free">ys</span> <span class="bound">zs2</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">zs1</span><span class="main">@</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs2</span> <span class="main">=</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_aux_cons_conv list_assn_aux_append_conv1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ent_iffI<span class="main">)</span>


<span class="keyword1" id="Basic_Assn-list_assn_aux_append_Cons"><span class="command">lemma</span></span> list_assn_aux_append_Cons<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">zsl</span> <span class="main">⟹</span> list_assn <span class="free">A</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">zsl</span><span class="main">@</span><span class="free">z</span><span class="main">#</span><span class="free">zsr</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>list_assn <span class="free">A</span> <span class="free">xs</span> <span class="free">zsl</span> <span class="main">*</span> <span class="free">A</span> <span class="free">x</span> <span class="free">z</span> <span class="main">*</span> list_assn <span class="free">A</span> <span class="free">ys</span> <span class="free">zsr</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>


<span class="comment1">(* -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prod-Assn›</span></span>


<span class="keyword1" id="Basic_Assn-prod_assn_cong"><span class="command">lemma</span></span> prod_assn_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span><span class="main">;</span> <span class="free">pi</span><span class="main">=</span><span class="free">pi'</span><span class="main">;</span> <span class="free">A</span> <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">pi</span><span class="main">)</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">pi</span><span class="main">)</span><span class="main">;</span> <span class="free">B</span> <span class="main">(</span>snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">pi</span><span class="main">)</span> <span class="main">=</span> <span class="free">B'</span> <span class="main">(</span>snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">pi</span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span><span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span><span class="free">B</span><span class="main">)</span> <span class="free">p</span> <span class="free">pi</span> <span class="main">=</span> <span class="main">(</span><span class="free">A'</span><span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span><span class="free">B'</span><span class="main">)</span> <span class="free">p'</span> <span class="free">pi'</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">pi</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BTree_Imp">
<div class="head">
<h1>Theory BTree_Imp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_Imp
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#BTree">BTree</a>
    <a href="#Partially_Filled_Array">Partially_Filled_Array</a>
    <a href="#Basic_Assn">Basic_Assn</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Imperative B-tree Definition"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The heap data type definition. Anything stored on the heap always contains data,
leafs are represented as None."</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> btnode <span class="main">=</span>
  Btnode <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btnode ref option<span class="main">*</span><span class="tfree">'a</span><span class="main">)</span> pfarray"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btnode ref option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Selector Functions›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">kvs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap btnode <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> btnode ref option<span class="main">*</span><span class="tfree">'a</span><span class="main">)</span> pfarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">sep_dflt_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">kvs</span> <span class="main">(</span>Btnode <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap btnode <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">sep_dflt_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">last</span> <span class="main">(</span>Btnode <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">arrays_update</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Encoding to natural numbers, as required by Imperative/HOL›</span></span>
  <span class="comment1">(* Note: should also work using the package "Deriving" *)</span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">btnode_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap btnode <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">btnode_encode</span> <span class="main">(</span>Btnode <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> btnode <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"btnode_encode"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> btnode_encode.elims from_nat_to_nat fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The refinement relationship to abstract B-trees."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">btree_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap btree <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Leaf None <span class="main">=</span> <span class="keyword1">emp</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> 
 <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">tsi</span> <span class="bound">ti</span> <span class="bound">tsi'</span><span class="main">.</span>
      <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Btnode <span class="bound">tsi</span> <span class="bound">ti</span>
    <span class="main">*</span> <span class="free">btree_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">ti</span>
    <span class="main">*</span> is_pfa <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">tsi'</span> <span class="bound">tsi</span>
    <span class="main">*</span> list_assn <span class="main">(</span><span class="main">(</span><span class="free">btree_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">tsi'</span>
    <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"With the current definition of deletion, we would
also need to directly reason on nodes and not only on references
to them."</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">btnode_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap btree <span class="main">⇒</span> <span class="tfree">'a</span> btnode <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btnode_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Btnode <span class="free"><span class="bound"><span class="entity">tsi</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span><span class="main">)</span> <span class="main">=</span> 
 <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">tsi'</span><span class="main">.</span>
      btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span>
    <span class="main">*</span> is_pfa <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">tsi'</span> <span class="free"><span class="bound"><span class="entity">tsi</span></span></span>
    <span class="main">*</span> list_assn <span class="main">(</span><span class="main">(</span>btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">tsi'</span>
    <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">btnode_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">blist_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> list_assn <span class="main">(</span><span class="main">(</span>btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="BTree_ImpSet">
<div class="head">
<h1>Theory BTree_ImpSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_ImpSet
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#BTree_Imp">BTree_Imp</a>
    <a href="#BTree_Set">BTree_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Imperative Set operations"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary operations"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">split_relation</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
   <span class="main">λ</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">bs</span> <span class="main">=</span> drop <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="BTree_ImpSet-split_relation_alt"><span class="command">lemma</span></span> split_relation_alt<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"split_relation <span class="free">as</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">as</span> <span class="main">=</span> <span class="free">ls</span><span class="main">@</span><span class="free">rs</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def<span class="main">)</span>


<span class="keyword1" id="BTree_ImpSet-split_relation_length"><span class="command">lemma</span></span> split_relation_length<span class="main">:</span> <span class="quoted"><span class="quoted">"split_relation <span class="free">xs</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ls</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">rs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def<span class="main">)</span>

<span class="comment1">(* auxiliary lemmas on assns *)</span>
<span class="comment1">(* simp? not sure if it always makes things more easy *)</span>
<span class="keyword1" id="BTree_ImpSet-list_assn_prod_map"><span class="command">lemma</span></span> list_assn_prod_map<span class="main">:</span> <span class="quoted"><span class="quoted">"list_assn <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">B</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> list_assn <span class="free">B</span> <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">ys</span><span class="main">)</span> <span class="main">*</span> list_assn <span class="free">A</span> <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_assn.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_mult_class.mult.left_commute ent_star_mono star_aci<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> star_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* concrete *)</span>
<span class="keyword1" id="BTree_ImpSet-id_assn_list"><span class="command">lemma</span></span> id_assn_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> list_assn id_assn <span class="main">(</span><span class="free">xs</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"id_assn<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> assn<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_assn.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_0_disj pure_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="BTree_ImpSet-snd_map_help"><span class="command">lemma</span></span> snd_map_help<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> length <span class="free">tsi</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">tsi</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map snd <span class="free">tsi</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">tsi</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">tsi</span><span class="main">!</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map snd <span class="free">tsi</span><span class="main">)</span><span class="main">!</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="BTree_ImpSet-split_ismeq"><span class="command">lemma</span></span> split_ismeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BTree_ImpSet-split_relation_map"><span class="command">lemma</span></span> split_relation_map<span class="main">:</span> <span class="quoted"><span class="quoted">"split_relation <span class="free">as</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="free">i</span> <span class="main">⟹</span> split_relation <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ls</span><span class="main">,</span> map <span class="free">f</span> <span class="free">rs</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ls</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def take_map drop_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> take_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="BTree_ImpSet-split_relation_access"><span class="command">lemma</span></span> split_relation_access<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>split_relation <span class="free">as</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span><span class="free">rs</span><span class="main">)</span> <span class="free">i</span><span class="main">;</span> <span class="free">rs</span> <span class="main">=</span> <span class="free">r</span><span class="main">#</span><span class="free">rrs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">as</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt<span class="main">)</span>



<span class="keyword1" id="BTree_ImpSet-index_to_elem_all"><span class="command">lemma</span></span> index_to_elem_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="BTree_ImpSet-index_to_elem"><span class="command">lemma</span></span> index_to_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_set_conv_nth<span class="main">)</span>
    <span class="comment1">(* ----------------- *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">split_half</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>heap<span class="main">}</span><span class="main">)</span> pfarray <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">split_half</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span> <span class="main">←</span> pfa_length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  return <span class="main">(</span><span class="bound">l</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="BTree_ImpSet-split_half_rule"><span class="command">lemma</span></span> split_half_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>
    is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="free">a</span>
  <span class="main">*</span> list_assn <span class="free">R</span> <span class="free">ts</span> <span class="free">tsi</span><span class="main">&gt;</span> 
    split_half <span class="free">a</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 
      is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="free">a</span>
    <span class="main">*</span> list_assn <span class="free">R</span> <span class="free">ts</span> <span class="free">tsi</span>
    <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">i</span> <span class="main">=</span> length <span class="free">ts</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span>  split_relation <span class="free">ts</span> <span class="main">(</span>BTree_Set.split_half <span class="free">ts</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> split_half_def split_relation_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_assn_len mod_starD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The imperative split locale"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"This locale extends the abstract split locale,
assuming that we are provided with an imperative program
that refines the abstract split function."</span></span>


<span class="keyword1"><span class="command">locale</span></span> imp_split <span class="main">=</span> abs_split<span class="main">:</span> BTree_Set.split <span class="quoted"><span class="free">split</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">split</span><span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btree <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span>
       <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> btree <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> btree <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">imp_split</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> pfarray <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> imp_split_rule <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
  <span class="main">*</span> blist_assn <span class="free">k</span> <span class="free">ts</span> <span class="free">tsi</span><span class="main">&gt;</span> 
    <span class="free">imp_split</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 
    is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
    <span class="main">*</span> blist_assn <span class="free">k</span> <span class="free">ts</span> <span class="free">tsi</span>
    <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>split_relation <span class="free">ts</span> <span class="main">(</span><span class="free">split</span> <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Membership"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">isin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span>  bool Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return False <span class="main">|</span>
     <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">node</span> <span class="main">←</span> <span class="main">!</span><span class="bound">a</span><span class="main">;</span>
       <span class="bound">i</span> <span class="main">←</span> <span class="free">imp_split</span> <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
       <span class="bound">tsl</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">tsl</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">s</span> <span class="main">←</span> pfa_get <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span> <span class="keyword1">in</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">sep</span> <span class="keyword1">then</span>
           return True
         <span class="keyword1">else</span>
           <span class="free">isin</span> <span class="bound">sub</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
       <span class="main">}</span> <span class="keyword1">else</span>
           <span class="free">isin</span> <span class="main">(</span>last <span class="bound">node</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="main">}</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Insertion"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'b</span> btupi <span class="main">=</span> 
  T<span class="hidden">⇩</span><sub>i</sub> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btnode ref option"</span></span> <span class="main">|</span>
  Up<span class="hidden">⇩</span><sub>i</sub> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btnode ref option"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> btnode ref option"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">btupi_assn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btupi_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>abs_split.T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">li</span></span></span><span class="main">)</span> <span class="main">=</span>
   btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">li</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">btupi_assn</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>abs_split.Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">li</span></span></span> <span class="free"><span class="bound"><span class="entity">ai</span></span></span> <span class="free"><span class="bound"><span class="entity">ri</span></span></span><span class="main">)</span> <span class="main">=</span>
   btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">li</span></span></span> <span class="main">*</span> id_assn <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ai</span></span></span> <span class="main">*</span> btree_assn <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ri</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">btupi_assn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="entity">node<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pfarray <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btupi Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">n</span> <span class="main">←</span> pfa_length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a'</span> <span class="main">←</span> pfa_shrink_cap <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
      <span class="bound">l</span> <span class="main">←</span> ref <span class="main">(</span>Btnode <span class="bound">a'</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span><span class="main">)</span><span class="main">;</span>
      return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">←</span> <span class="main">(</span>pfa_empty <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pfarray Heap<span class="main">)</span><span class="main">;</span>
      <span class="bound">i</span> <span class="main">←</span> split_half <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
      <span class="bound">m</span> <span class="main">←</span> pfa_get <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span><span class="main">;</span>
      <span class="bound">b'</span> <span class="main">←</span> pfa_drop <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">b</span><span class="main">;</span>
      <span class="bound">a'</span> <span class="main">←</span> pfa_shrink <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
      <span class="bound">a''</span> <span class="main">←</span> pfa_shrink_cap <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">a'</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">l</span> <span class="main">←</span> ref <span class="main">(</span>Btnode <span class="bound">a''</span> <span class="bound">sub</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">r</span> <span class="main">←</span> ref <span class="main">(</span>Btnode <span class="bound">b'</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="bound">sep</span> <span class="main">(</span>Some <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span>
    <span class="main">}</span>
<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btupi Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">apo</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">apo</span></span></span> <span class="keyword1">of</span>
  None <span class="main">⇒</span> 
    return <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> None <span class="free"><span class="bound"><span class="entity">x</span></span></span> None<span class="main">)</span> <span class="main">|</span>
  <span class="main">(</span>Some <span class="bound">ap</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">←</span> <span class="main">!</span><span class="bound">ap</span><span class="main">;</span>
    <span class="bound">i</span> <span class="main">←</span> <span class="free">imp_split</span> <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">tsl</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">tsl</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">s</span> <span class="main">←</span> pfa_get <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">sep</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">apo</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">r</span> <span class="main">←</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">sub</span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> 
          <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">lp</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            pfa_set <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">lp</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">;</span>
            return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">apo</span></span></span><span class="main">)</span>
          <span class="main">}</span> <span class="main">|</span>
          <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">lp</span> <span class="bound">x'</span> <span class="bound">rp</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            pfa_set <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">rp</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">;</span>
            <span class="keyword1">if</span> <span class="bound">tsl</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">kvs'</span> <span class="main">←</span> pfa_insert <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">lp</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">;</span>
                <span class="bound">ap</span> <span class="main">:=</span> <span class="main">(</span>Btnode <span class="bound">kvs'</span> <span class="main">(</span>last <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">apo</span></span></span><span class="main">)</span>
            <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">kvs'</span> <span class="main">←</span> pfa_insert_grow <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">lp</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">;</span>
              node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">kvs'</span> <span class="main">(</span>last <span class="bound">a</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">}</span>
        <span class="main">}</span>
      <span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">r</span> <span class="main">←</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>last <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> 
        <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">lp</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">ap</span> <span class="main">:=</span> <span class="main">(</span>Btnode <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="bound">lp</span><span class="main">)</span><span class="main">;</span>
          return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">apo</span></span></span><span class="main">)</span>
        <span class="main">}</span> <span class="main">|</span>
        <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">lp</span> <span class="bound">x'</span> <span class="bound">rp</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="keyword1">if</span> <span class="bound">tsl</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">kvs'</span> <span class="main">←</span> pfa_append <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">lp</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">;</span>
            <span class="bound">ap</span> <span class="main">:=</span> <span class="main">(</span>Btnode <span class="bound">kvs'</span> <span class="bound">rp</span><span class="main">)</span><span class="main">;</span>
            return <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">apo</span></span></span><span class="main">)</span>
          <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">kvs'</span> <span class="main">←</span> pfa_append_grow' <span class="main">(</span>kvs <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">lp</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">;</span>
            node<span class="hidden">⇩</span><sub>i</sub> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">kvs'</span> <span class="bound">rp</span>
        <span class="main">}</span>
    <span class="main">}</span>
  <span class="main">}</span>
<span class="main">)</span>"</span></span>


<span class="comment1">(*fun tree<span class="hidden">⇩</span><sub>i</sub>::"'a up<span class="hidden">⇩</span><sub>i</sub> ⇒ 'a btree" where
  "tree<span class="hidden">⇩</span><sub>i</sub> (T<span class="hidden">⇩</span><sub>i</sub> sub) = sub" |
  "tree<span class="hidden">⇩</span><sub>i</sub> (Up<span class="hidden">⇩</span><sub>i</sub> l a r) = (Node [(l,a)] r)" 

fun insert::"nat ⇒ 'a ⇒ 'a btree ⇒ 'a btree" where
  "insert k x t = tree<span class="hidden">⇩</span><sub>i</sub> (ins k x t)"
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span> <span class="bound">ti</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">ti'</span> <span class="main">←</span> ins <span class="bound">k</span> <span class="bound">x</span> <span class="bound">ti</span><span class="main">;</span>
  <span class="keyword1">case</span> <span class="bound">ti'</span> <span class="keyword1">of</span>
     T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">sub</span> <span class="main">⇒</span> return <span class="bound">sub</span> <span class="main">|</span>
     Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">kvs</span> <span class="main">←</span> pfa_init <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">1</span><span class="main">;</span>
        <span class="bound">t'</span> <span class="main">←</span> ref <span class="main">(</span>Btnode <span class="bound">kvs</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span>Some <span class="bound">t'</span><span class="main">)</span>
      <span class="main">}</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Deletion"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Note that the below operations have not been verified to
refine the abstract set operations."</span></span>


<span class="comment1">(* rebalance middle tree gets a list of trees, an index pointing to
the position of sub/sep and a last tree *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rebalance_middle_tree</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pfarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rebalance_middle_tree</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">k</span> <span class="bound">tsi</span> <span class="bound">i</span> <span class="bound">r_ti</span><span class="main">.</span> <span class="main">(</span>
  <span class="keyword1">case</span> <span class="bound">r_ti</span> <span class="keyword1">of</span>
  None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
    return <span class="main">(</span>Btnode <span class="bound">tsi</span> <span class="bound">r_ti</span><span class="main">)</span>
  <span class="main">}</span> <span class="main">|</span>
  Some <span class="bound">p_t</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ti</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p_t</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">r_sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">←</span> pfa_get <span class="bound">tsi</span> <span class="bound">i</span><span class="main">;</span>
      <span class="keyword1">case</span> <span class="bound">r_sub</span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="bound">p_sub</span><span class="main">)</span> <span class="main">⇒</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">sub</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p_sub</span><span class="main">;</span>
      <span class="bound">l_sub</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">sub</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">l_tts</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">ti</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">l_sub</span> <span class="main">≥</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">l_tts</span> <span class="main">≥</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        return <span class="main">(</span>Btnode <span class="bound">tsi</span> <span class="bound">r_ti</span><span class="main">)</span>
      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">l_tsi</span> <span class="main">←</span> pfa_length <span class="bound">tsi</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">l_tsi</span> <span class="main">=</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">mts'</span> <span class="main">←</span> pfa_append_extend_grow <span class="main">(</span>kvs <span class="bound">sub</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">(</span>kvs <span class="bound">ti</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">res_node<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">←</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="bound">mts'</span> <span class="main">(</span>last <span class="bound">ti</span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1">case</span> <span class="bound">res_node<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">of</span>
            T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">u</span> <span class="main">⇒</span> return <span class="main">(</span>Btnode <span class="bound">tsi</span> <span class="bound">u</span><span class="main">)</span> <span class="main">|</span>
            Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">tsi'</span> <span class="main">←</span> pfa_append <span class="bound">tsi</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">;</span>
              return <span class="main">(</span>Btnode <span class="bound">tsi'</span> <span class="bound">r</span><span class="main">)</span>
            <span class="main">}</span>
        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">r_rsub</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span> <span class="main">←</span> pfa_get <span class="bound">tsi</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1">case</span> <span class="bound">r_rsub</span> <span class="keyword1">of</span> Some <span class="bound">p_rsub</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">rsub</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p_rsub</span><span class="main">;</span>
            <span class="bound">mts'</span> <span class="main">←</span> pfa_append_extend_grow <span class="main">(</span>kvs <span class="bound">sub</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">(</span>kvs <span class="bound">rsub</span><span class="main">)</span><span class="main">;</span>
            <span class="bound">res_node<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">←</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="bound">k</span> <span class="bound">mts'</span> <span class="main">(</span>last <span class="bound">rsub</span><span class="main">)</span><span class="main">;</span>
            <span class="keyword1">case</span> <span class="bound">res_node<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">of</span>
             T<span class="hidden">⇩</span><sub>i</sub> <span class="bound">u</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">tsi'</span> <span class="main">←</span> pfa_set <span class="bound">tsi</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">;</span>              
              <span class="bound">tsi''</span> <span class="main">←</span> pfa_delete <span class="bound">tsi'</span> <span class="bound">i</span><span class="main">;</span>
              return <span class="main">(</span>Btnode <span class="bound">tsi''</span> <span class="bound">r_ti</span><span class="main">)</span>
            <span class="main">}</span> <span class="main">|</span>
             Up<span class="hidden">⇩</span><sub>i</sub> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="bound">tsi'</span> <span class="main">←</span> pfa_set <span class="bound">tsi</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">tsi''</span> <span class="main">←</span> pfa_set <span class="bound">tsi'</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">rsep</span><span class="main">)</span><span class="main">;</span>
              return <span class="main">(</span>Btnode <span class="bound">tsi''</span> <span class="bound">r_ti</span><span class="main">)</span>
            <span class="main">}</span>
          <span class="main">}</span>
        <span class="main">}</span>
      <span class="main">}</span>
  <span class="main">}</span>
<span class="main">}</span><span class="main">)</span>
"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rebalance_last_tree</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> pfarray <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rebalance_last_tree</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span> <span class="bound">tsi</span> <span class="bound">ti</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">l_tsi</span> <span class="main">←</span> pfa_length <span class="bound">tsi</span><span class="main">;</span>
   rebalance_middle_tree <span class="bound">k</span> <span class="bound">tsi</span> <span class="main">(</span><span class="bound">l_tsi</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="bound">ti</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">split_max</span> <span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">split_max</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r_t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r_t</span></span></span> <span class="keyword1">of</span> Some <span class="bound">p_t</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p_t</span><span class="main">;</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Btnode <span class="bound">tsi</span> <span class="bound">r_ti</span> <span class="main">⇒</span>
     <span class="keyword1">case</span> <span class="bound">r_ti</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">←</span> pfa_last <span class="bound">tsi</span><span class="main">;</span>
      <span class="bound">tsi'</span> <span class="main">←</span> pfa_butlast <span class="bound">tsi</span><span class="main">;</span>
      <span class="bound">p_t</span> <span class="main">:=</span> Btnode <span class="bound">tsi'</span> <span class="bound">sub</span><span class="main">;</span>
      return <span class="main">(</span>Some <span class="bound">p_t</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span>
  <span class="main">}</span> <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">←</span> <span class="free">split_max</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">r_ti</span><span class="main">;</span>
      <span class="bound">p_t'</span> <span class="main">←</span> rebalance_last_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">tsi</span> <span class="bound">sub</span><span class="main">;</span>
      <span class="bound">p_t</span> <span class="main">:=</span> <span class="bound">p_t'</span><span class="main">;</span>
      return <span class="main">(</span>Some <span class="bound">p_t</span><span class="main">,</span> <span class="bound">sep</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span>
<span class="main">}</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">del</span> <span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> return None <span class="main">|</span>
   Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">node</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
   <span class="bound">i</span> <span class="main">←</span> <span class="free">imp_split</span> <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
   <span class="bound">tsl</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
   <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">tsl</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">s</span> <span class="main">←</span> pfa_get <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sub</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span> <span class="keyword1">in</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="bound">sep</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">sub'</span> <span class="main">←</span> <span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">sub</span><span class="main">;</span>
       <span class="bound">kvs'</span> <span class="main">←</span> pfa_set <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">sub'</span><span class="main">,</span><span class="bound">sep</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">node'</span> <span class="main">←</span> rebalance_middle_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">kvs'</span> <span class="bound">i</span> <span class="main">(</span>last <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">ti'</span> <span class="main">←</span> ref <span class="bound">node'</span><span class="main">;</span>
       return <span class="main">(</span>Some <span class="bound">ti'</span><span class="main">)</span>
      <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">sub</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="keyword1">do</span><span class="main">{</span>
       pfa_delete <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
       return <span class="free"><span class="bound"><span class="entity">ti</span></span></span>
     <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">sm</span> <span class="main">←</span> split_max <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">sub</span><span class="main">;</span>
        <span class="bound">kvs'</span> <span class="main">←</span> pfa_set <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">sm</span><span class="main">;</span>
        <span class="bound">node'</span> <span class="main">←</span> rebalance_middle_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">kvs'</span> <span class="bound">i</span> <span class="main">(</span>last <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">ti'</span> <span class="main">←</span> ref <span class="bound">node'</span><span class="main">;</span>
        return <span class="main">(</span>Some <span class="bound">ti'</span><span class="main">)</span>
     <span class="main">}</span>
   <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">t'</span> <span class="main">←</span> <span class="free">del</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>last <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">node'</span> <span class="main">←</span> rebalance_last_tree <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span> <span class="bound">t'</span><span class="main">;</span>
       <span class="bound">ti'</span> <span class="main">←</span> ref <span class="bound">node'</span><span class="main">;</span>
       return <span class="main">(</span>Some <span class="bound">ti'</span><span class="main">)</span>
    <span class="main">}</span>
<span class="main">}</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">reduce_root</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">reduce_root</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="keyword1">of</span>
  None <span class="main">⇒</span> return None <span class="main">|</span>
  Some <span class="bound">p_t</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">node</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p_t</span><span class="main">;</span>
    <span class="bound">tsl</span> <span class="main">←</span> pfa_length <span class="main">(</span>kvs <span class="bound">node</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">case</span> <span class="bound">tsl</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> return <span class="main">(</span>last <span class="bound">node</span><span class="main">)</span> <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">ti</span></span></span>
<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">delete</span> <span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option <span class="main">⇒</span> <span class="tfree">'a</span> btnode ref option Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">ti'</span> <span class="main">←</span> del <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span><span class="main">;</span>
  reduce_root <span class="bound">ti'</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Refinement of the abstract B-tree operations"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>default<span class="main">,</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> btnode ref option Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> return None"</span></span>


<span class="keyword1" id="BTree_ImpSet-P_imp_Q_implies_P"><span class="command">lemma</span></span> P_imp_Q_implies_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span>  <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span>
     isin <span class="free">ti</span> <span class="free">x</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>abs_split.isin <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">r</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> abs_split.isin.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> isin.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ti</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_cons_rule<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ts</span> <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
    <span class="comment1">(* NOTE: induction condition trivial here *)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> isin.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_separators <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">rrs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> h_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sep</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="comment1">(* NOTE: no induction required here, only vacuous counter cases generated *)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> isin.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_separators <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt list_assn_append_Cons_left <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> isin.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_separators 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
          <span class="comment1">(*eliminate vacuous case*)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt list_assn_append_Cons_left <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
          <span class="comment1">(* simplify towards induction step *)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt list_assn_append_Cons_left <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

<span class="comment1">(* NOTE show that z = (suba, sepa) *)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> norm_pre_ex_rule<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsi n ti xsi suba sepa zs1 z zs2 _
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">suba</span><span class="main">,</span> <span class="skolem">sepa</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span>
              <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span><span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">h</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> list_split Cons h_split <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
            <span class="comment1">(* proof that previous assumptions hold later *)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> P_imp_Q_implies_P<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsi</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">ti</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">suba</span><span class="main">,</span> <span class="skolem">sepa</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs2</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">z</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="comment1">(* prove subgoal_tac assumption *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list_assn_aux_ineq_len list_assn_len nth_append_length star_false_left star_false_right<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="comment1">(* eliminate last vacuous case *)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">declare</span></span> abs_split.node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>
<span class="keyword1" id="BTree_ImpSet-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> c_cap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> list_assn <span class="main">(</span><span class="main">(</span>btree_assn <span class="free">k</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span> <span class="free">ts</span> <span class="free">tsi</span> <span class="main">*</span> btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span>
  node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">ti</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btupi_assn <span class="free">k</span> <span class="main">(</span>abs_split.node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="bound">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> node<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_cap <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    split_half_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"BTree_Set.split_half <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs_split.node<span class="hidden">⇩</span><sub>i</sub>_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> node<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  split_relation_alt split_relation_length is_pfa_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>

    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt <span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> False  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def split_relation_alt<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_cap <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_cap <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_cap <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">vcg</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span>  _ _ _ _ rsa subi ba rn lsi al ar _
      <span class="keyword1"><span class="command">thm</span></span> ent_ex_postI
      <span class="keyword1"><span class="command">thm</span></span> ent_ex_postI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">tsi</span>"</span></span><span class="main">]</span>
        <span class="comment1">(* instantiate right hand side *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rsa</span><span class="main">,</span><span class="skolem">rn</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">ti</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free">tsi</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">lsi</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">subi</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">tsi</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="comment1">(* introduce equality between equality of split tsi/ts and original lists *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">tsi</span> <span class="main">=</span>
            take <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">tsi</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">subi</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free">tsi</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> back_subst<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"blist_assn <span class="free">k</span> <span class="free">ts</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">tsi</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">subi</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="free">tsi</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"blist_assn <span class="free">k</span> <span class="free">ts</span> <span class="free">tsi</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> back_subst<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"blist_assn <span class="free">k</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">ts</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"blist_assn <span class="free">k</span> <span class="free">ts</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> list_assn_aux_append_Cons<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> back_subst<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">tsi</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">tsi</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">subi</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> id_take_nth_drop<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">declare</span></span> abs_split.node<span class="hidden">⇩</span><sub>i</sub>.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1" id="BTree_ImpSet-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_no_split<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">⟹</span> abs_split.node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> abs_split.T<span class="hidden">⇩</span><sub>i</sub> <span class="main">(</span>Node <span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_split.node<span class="hidden">⇩</span><sub>i</sub>.simps<span class="main">)</span>


<span class="keyword1" id="BTree_ImpSet-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">⟧</span> <span class="main">⟹</span>
<span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">tsi'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span> <span class="main">*</span>
   blist_assn <span class="free">k</span> <span class="free">ls</span> <span class="free">tsi'</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">l</span> <span class="free">li</span> <span class="main">*</span>
   id_assn <span class="free">a</span> <span class="free">ai</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">r</span> <span class="free">ri</span><span class="main">&gt;</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span> <span class="free">ri</span>
 <span class="main">&lt;</span>btupi_assn <span class="free">k</span> <span class="main">(</span>abs_split.node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tsi'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">aa</span></span> <span class="quoted"><span class="free">al</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">ri</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.left_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_ImpSet-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule_ins2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">;</span> length <span class="free">ls</span> <span class="main">=</span> length <span class="free">lsi</span><span class="main">⟧</span> <span class="main">⟹</span>
 <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">lsi</span> <span class="main">@</span> <span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">ri</span><span class="main">,</span><span class="free">a'i</span><span class="main">)</span> <span class="main">#</span> <span class="free">rsi</span><span class="main">)</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span> <span class="main">*</span>
   blist_assn <span class="free">k</span> <span class="free">ls</span> <span class="free">lsi</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">l</span> <span class="free">li</span> <span class="main">*</span>
   id_assn <span class="free">a</span> <span class="free">ai</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">r</span> <span class="free">ri</span> <span class="main">*</span>
   id_assn <span class="free">a'</span> <span class="free">a'i</span> <span class="main">*</span>
   blist_assn <span class="free">k</span> <span class="free">rs</span> <span class="free">rsi</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span>
          <span class="free">ti</span> <span class="main">&lt;</span>btupi_assn <span class="free">k</span> <span class="main">(</span>abs_split.node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">=</span> length <span class="free">lsi</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lsi</span> <span class="main">@</span> <span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">ri</span><span class="main">,</span><span class="free">a'i</span><span class="main">)</span> <span class="main">#</span> <span class="free">rsi</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">aa</span></span> <span class="quoted"><span class="free">al</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">a'</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">ti</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.left_assoc list_assn_aux_append_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BTree_ImpSet-ins_rule"><span class="command">lemma</span></span> ins_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">&lt;</span>btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span>
  ins <span class="free">k</span> <span class="free">x</span> <span class="free">ti</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btupi_assn <span class="free">k</span> <span class="main">(</span>abs_split.ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="bound">r</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> abs_split.ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_app_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rrs</span></span> <span class="keyword2"><span class="keyword">where</span></span> list_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ls</span><span class="main">,</span><span class="skolem">rrs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="skolem">ts</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_separators <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> sorted_inorder_induct_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rrs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"abs_split.ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti
          <span class="keyword1"><span class="command">using</span></span> Nil list_split
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_aux_ineq_len split_relation_alt<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi' i tsin' _ sub sep
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Nil list_split
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_aux_ineq_len split_relation_alt<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi'
          <span class="keyword1"><span class="command">thm</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">tti</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> Nil list_split T<span class="hidden">⇩</span><sub>i</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt
              <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">tti</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ai
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ai</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti
          <span class="keyword1"><span class="command">using</span></span> Nil list_split
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_aux_ineq_len split_relation_alt<span class="main">)</span>                 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi' i tsin' _ sub sep
          <span class="keyword1"><span class="command">using</span></span> Nil list_split 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_aux_ineq_len split_relation_alt<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi' i tsin'
          <span class="keyword1"><span class="command">thm</span></span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">tti</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> Nil list_split Up<span class="hidden">⇩</span><sub>i</sub> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.splits 
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt
              <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">tti</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ai
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ai</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> li ai ri <span class="comment1">(* no split case *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">ls</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span>"</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_no_split<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsil</span><span class="main">,</span>Suc <span class="skolem">tsin</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">ri</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tsi'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">li</span><span class="main">,</span> <span class="skolem">ai</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="comment1">(* split case*)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule_app<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">rs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sub</span></span> <span class="skolem"><span class="skolem">sep</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sub</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="skolem">sub</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> abs_split.split_axioms list_split Cons sorted_inorder_induct_subtree split_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi j subi
          <span class="keyword1"><span class="command">using</span></span> Cons list_split a_split True
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi j _ _ subi sepi
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Cons list_split a_split True
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">sepi</span> <span class="main">=</span> <span class="skolem">sep</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_prod_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD id_assn_list<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map snd_conv snd_map_help<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split_relation_access<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin tti tsi j
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Cons list_split
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"abs_split.ins <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sub</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">a'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons list_split a_split False<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> norm_pre_ex_rule<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="comment1">(* at this point, we want to introduce the split, and after that tease the
  hoare triple assumptions out of the bracket, s.t. we don't split twice *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
          <span class="keyword1"><span class="command">using</span></span> list_split Cons
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt list_assn_append_Cons_left<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> norm_pre_ex_rule<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="comment1">(* discard wrong branch *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ suba
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">sepi</span>  <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> list_split Cons a_split
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD <span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="comment1">(* actual induction branch *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ n z suba sepa
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">subi</span> <span class="main">=</span> <span class="skolem">suba</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> list_split a_split T<span class="hidden">⇩</span><sub>i</sub> False
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vcg</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> btupi.splits<span class="main">)</span>
              <span class="comment1">(* careful progression for manual value insertion *)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a'i q r
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_append_Cons_left<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsil</span><span class="main">,</span><span class="skolem">tsin</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">ti</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">a'i</span><span class="main">,</span> <span class="skolem">sepi</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs2</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a'i</span><span class="main">,</span><span class="skolem">sep</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_app_eq<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list_assn_aux_ineq_len Pair_inject list_assn_len nth_append_length star_false_left star_false_right<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ suba
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up<span class="hidden">⇩</span><sub>i</sub> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons list_split a_split False<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins.simps<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> norm_pre_ex_rule<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="comment1">(* at this point, we want to introduce the split, and after that tease the
  hoare triple assumptions out of the bracket, s.t. we don't split twice *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
          <span class="keyword1"><span class="command">using</span></span> list_split Cons
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_relation_alt list_assn_append_Cons_left<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> norm_pre_ex_rule<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
            <span class="comment1">(* discard wrong branch *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ suba
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">sepi</span>  <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> list_split Cons a_split
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD <span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="comment1">(* actual induction branch *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ n z suba sepa
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">subi</span> <span class="main">=</span> <span class="skolem">suba</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">thm</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quoted"><span class="skolem">rrs</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="skolem">sep</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> list_split a_split Cons Up<span class="hidden">⇩</span><sub>i</sub> False
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> btupi.splits<span class="main">)</span>
              <span class="comment1">(* careful progression for manual value insertion *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> li wi ri u <span class="comment1">(* no split case *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> pfa_insert_grow_rule<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear length_append length_take less_not_refl min.absorb2 trans_less_add1<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right length_Cons length_append length_take min.absorb2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
                <span class="comment1">(* no split case *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">ls</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span>"</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_no_split<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsil</span><span class="main">,</span>Suc <span class="skolem">tsin</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">ti</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">li</span><span class="main">,</span> <span class="skolem">wi</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">ri</span><span class="main">,</span> <span class="skolem">sep</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs2</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x21 x22 x23 u <span class="comment1">(* split case *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command">thm</span></span> pfa_insert_grow_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?l</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">zs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">suba</span><span class="main">,</span> <span class="skolem">sepi</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs2</span><span class="main">)</span><span class="main">[</span>length <span class="skolem">ls</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">x23</span><span class="main">,</span> <span class="skolem">sepa</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> pfa_insert_grow_rule<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear length_append length_take less_not_refl min.absorb2 trans_less_add1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vcg</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule_ins2<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tsil tsin ti zs1 subi sepi zs2 _ _ suba
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  mod_starD list_assn_len<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The imperative insert refines the abstract insert."</span></span>

<span class="keyword1" id="BTree_ImpSet-insert_rule"><span class="command">lemma</span></span> insert_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span>
  insert <span class="free">k</span> <span class="free">x</span> <span class="free">ti</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree_assn <span class="free">k</span> <span class="main">(</span>abs_split.insert <span class="free">k</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="bound">r</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> insert_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"abs_split.ins <span class="free">k</span> <span class="free">x</span> <span class="free">t</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> btupi.splits <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> ins_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">vcg</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> ins_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> btupi.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">vcg</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l a r li ai ri tsa tsn ti
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tsa</span><span class="main">,</span><span class="skolem">tsn</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">ri</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ent_ex_postI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">li</span><span class="main">,</span> <span class="skolem">ai</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The \"pure\" resulting rule follows automatically."</span></span>
<span class="keyword1" id="BTree_ImpSet-insert_rule'"><span class="command">lemma</span></span> insert_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree_assn <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">t</span> <span class="free">ti</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>abs_split.invar_inorder <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">t</span> <span class="main">∧</span> sorted_less <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>
  insert <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">x</span> <span class="free">ti</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">ri</span><span class="main">.</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">r</span><span class="main">.</span> btree_assn <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="bound">r</span> <span class="bound">ri</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>abs_split.invar_inorder <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span> sorted_less <span class="main">(</span>inorder <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> inorder <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span>ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> abs_split.insert_bal abs_split.insert_order abs_split.insert_inorder 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> insert_rule <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_ins_list<span class="main">)</span>


<span class="keyword1" id="BTree_ImpSet-node"><span class="command">lemma</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">;</span> length <span class="free">ls</span> <span class="main">=</span> length <span class="free">lsi</span><span class="main">⟧</span> <span class="main">⟹</span>
 <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="main">(</span><span class="free">lsi</span> <span class="main">@</span> <span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span> <span class="main">#</span> <span class="free">rsi</span><span class="main">)</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span> <span class="main">*</span>
   blist_assn <span class="free">k</span> <span class="free">ls</span> <span class="free">lsi</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">l</span> <span class="free">li</span> <span class="main">*</span>
   id_assn <span class="free">a</span> <span class="free">ai</span> <span class="main">*</span>
   blist_assn <span class="free">k</span> <span class="free">rs</span> <span class="free">rsi</span> <span class="main">*</span>
   btree_assn <span class="free">k</span> <span class="free">t</span> <span class="free">ti</span><span class="main">&gt;</span> node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span>
          <span class="free">ti</span> <span class="main">&lt;</span>btupi_assn <span class="free">k</span> <span class="main">(</span>abs_split.node<span class="hidden">⇩</span><sub>i</sub> <span class="free">k</span> <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">k</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">=</span> length <span class="free">lsi</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> node<span class="hidden">⇩</span><sub>i</sub>_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lsi</span> <span class="main">@</span> <span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">ai</span><span class="main">)</span> <span class="main">#</span> <span class="free">rsi</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">aa</span></span> <span class="quoted"><span class="free">al</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">ti</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.left_assoc list_assn_aux_append_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="BTree_ImpSet-empty_rule"><span class="command">lemma</span></span> empty_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
  empty
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree_assn <span class="free">k</span> <span class="main">(</span>abs_split.empty_btree<span class="main">)</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> empty_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_split.empty_btree_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Imperative_Loops">
<div class="head">
<h1>Theory Imperative_Loops</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Imperative_Loops
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#Sepref_HOL_Bindings">Refine_Imperative_HOL.Sepref_HOL_Bindings</a>"</span>
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#Pf_Mono_Prover">Refine_Imperative_HOL.Pf_Mono_Prover</a>"</span>
    <span class="quoted">"<a href="../../refine_imperative_hol/theories/#Pf_Add">Refine_Imperative_HOL.Pf_Add</a>"</span>


<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Imperative Loops›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"An auxiliary while rule provided by Peter Lammich."</span></span>

<span class="keyword1" id="Imperative_Loops-heap_WHILET_rule"><span class="command">lemma</span></span> heap_WHILET_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">bi</span> <span class="bound">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> heap_WHILET <span class="free">bi</span> <span class="free">f</span> <span class="free">s</span> <span class="main">&lt;</span><span class="free">Q</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">I</span> <span class="free">s</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> heap_WHILET <span class="free">bi</span> <span class="free">f</span> <span class="free">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="bound">s'</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> heap_WHILET_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> less<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> heap_WHILET_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cons_rule<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ent_star_mono assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ent_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ent_star_mono assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> ent_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Imperative_Loops-heap_WHILET_rule'"><span class="command">lemma</span></span> heap_WHILET_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">I</span> <span class="free">s</span> <span class="free">si</span> <span class="main">*</span> <span class="free">F</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="bound">si</span> <span class="main">*</span> <span class="free">F</span><span class="main">&gt;</span> <span class="free">bi</span> <span class="bound">si</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="bound">si</span> <span class="main">*</span> <span class="free">F</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="bound">si</span> <span class="main">*</span> <span class="free">F</span><span class="main">&gt;</span> <span class="free">f</span> <span class="bound">si</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">si'</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="bound">si'</span> <span class="main">*</span> <span class="free">F</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span> <span class="bound">si</span> <span class="main">*</span> <span class="free">F</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">si</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> heap_WHILET <span class="free">bi</span> <span class="free">f</span> <span class="free">si</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">si</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">si</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">I</span> <span class="free">s</span> <span class="free">si</span> <span class="main">*</span> <span class="free">F</span><span class="main">&gt;</span> heap_WHILET <span class="free">bi</span> <span class="free">f</span> <span class="free">si</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">si'</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="bound">si'</span> <span class="main">*</span> <span class="free">F</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="bound">s'</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">si</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> heap_WHILET_unfold<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> less<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> heap_WHILET_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cons_rule<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ent_star_mono assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ent_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ent_frame_fwd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">frame_inference</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Added by NM, just a technicality since this rule fits our use case better *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"I derived my own version,
simply because it was a better fit to my use case."</span></span>

<span class="keyword1"><span class="command">corollary</span></span> heap_WHILET_rule''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">bi</span> <span class="bound">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">I</span> <span class="bound">s</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> heap_WHILET <span class="free">bi</span> <span class="free">f</span> <span class="free">s</span> <span class="main">&lt;</span><span class="free">Q</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> R <span class="main">=</span> heap_WHILET_rule'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">si</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">s</span> <span class="main">=</span> <span class="bound">si</span><span class="main">)</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="main">_</span> <span class="quoted"><span class="keyword1">true</span></span> <span class="quoted"><span class="free">bi</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">si</span><span class="main">.</span><span class="main">↑</span><span class="main">(</span><span class="bound">s</span> <span class="main">=</span> <span class="bound">si</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">*</span> <span class="keyword1">true</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> R
  <span class="keyword1"><span class="command">using</span></span> assms ent_true_drop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> R assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="comment1">(*
explicit proof:

proof -
  have "&lt;I s * true&gt; heap_WHILET bi f s &lt;λs'. I s' * ↑(¬ b s')&gt;<span class="hidden">⇩</span><sub>t</sub>"
    using assms(1)
  proof (induction arbitrary:)
    case (less s)
    show ?case
    proof (cases "b s")
      case True
      then show ?thesis
        by (subst heap_WHILET_unfold) (sep_auto heap: assms(3,4) less)
    next
      case False
      then show ?thesis
        by (subst heap_WHILET_unfold) (sep_auto heap: assms(3))
    qed
  qed
  then show ?thesis
    apply (rule cons_rule[rotated 2])
     apply (intro ent_true_drop assms(2) ent_refl)
    apply clarsimp
    apply(intro ent_star_mono assms(5) ent_refl)
    .
qed
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BTree_ImpSplit">
<div class="head">
<h1>Theory BTree_ImpSplit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BTree_ImpSplit
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#BTree_ImpSet">BTree_ImpSet</a>
    <a href="#BTree_Split">BTree_Split</a>
    <a href="#Imperative_Loops">Imperative_Loops</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Imperative split operations"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"So far, we have only given a functional specification of a possible split.
      We will now provide imperative split functions that refine the functional specification.
      However, rather than tracing the execution of the abstract specification,
      the imperative versions are implemented using while-loops."</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Linear split"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The linear split is the most simple split function for binary trees.
      It serves a good example on how to use while-loops in Imperative/HOL
      and how to prove Hoare-Triples about its application using loop invariants."</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lin_split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> pfarray <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lin_split</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  
  <span class="bound">i</span> <span class="main">←</span> heap_WHILET 
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> Array.nth <span class="bound">a</span> <span class="bound">i</span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">s</span><span class="main">&lt;</span><span class="bound">p</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> return False<span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> return <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">0</span><span class="main">;</span>
       
  return <span class="bound">i</span>
<span class="main">}</span>"</span></span>


<span class="keyword1" id="BTree_ImpSplit-lin_split_rule"><span class="command">lemma</span></span> lin_split_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
<span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
 lin_split <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span>
 <span class="main">&lt;</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lin_split_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> R <span class="main">=</span> heap_WHILET_rule''<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
      R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> R

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span>  <span class="quasi_keyword">decon</span><span class="main"><span class="main">:</span></span> R <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq is_pfa_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_take snd_eqD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_take snd_eqD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pfa_def less_Suc_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_take<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_Suc_eq less_le_trans nth_take<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Binary split"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"To obtain an efficient B-Tree implementation, we prefer a binary split
function.
To explore the searching procedure
and the resulting proof, we first implement the split on singleton arrays."</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bin'_split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> array_list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bin'_split</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">low'</span><span class="main">,</span><span class="bound">high'</span><span class="main">)</span> <span class="main">←</span> heap_WHILET 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">low</span><span class="main">,</span><span class="bound">high</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">low</span> <span class="main">&lt;</span> <span class="bound">high</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">low</span><span class="main">,</span><span class="bound">high</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mid</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">low</span>  <span class="main">+</span> <span class="bound">high</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">s</span> <span class="main">←</span> Array.nth <span class="bound">a</span> <span class="bound">mid</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="keyword1">then</span>
         return <span class="main">(</span><span class="bound">low</span><span class="main">,</span> <span class="bound">mid</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">&gt;</span> <span class="bound">s</span> <span class="keyword1">then</span>
         return <span class="main">(</span><span class="bound">mid</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">high</span><span class="main">)</span>
      <span class="keyword1">else</span> return <span class="main">(</span><span class="bound">mid</span><span class="main">,</span><span class="bound">mid</span><span class="main">)</span>
     <span class="main">}</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span>
  return <span class="bound">low'</span>
<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">thm</span></span> sorted_wrt_nth_less

<span class="comment1">(* alternative: replace (∀j&lt;l. xs!j &lt; p) by (l &gt; 0 ⟶ xs!(l-1) &lt; p)*)</span>
<span class="keyword1" id="BTree_ImpSplit-bin'_split_rule"><span class="command">lemma</span></span> bin'_split_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
sorted_less <span class="free">xs</span> <span class="main">⟹</span>
<span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
 bin'_split <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span>
 <span class="main">&lt;</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> <span class="free">xs</span><span class="main">!</span><span class="bound">l</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bin'_split_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> R <span class="main">=</span> heap_WHILET_rule''<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
      R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> <span class="bound">h</span><span class="main">-</span><span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span><span class="main">≤</span><span class="bound">h</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">h</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> <span class="free">xs</span><span class="main">!</span><span class="bound">h</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="bound">h</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> <span class="free">xs</span><span class="main">!</span><span class="bound">l</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> R

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">decon</span><span class="main"><span class="main">:</span></span> R <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq is_pfa_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l' aa l'a aaa ba j
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="skolem">l'a</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'a</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>
        sorted_wrt_nth_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?j</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
        a b <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'a</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> b
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">n</span> <span class="skolem">l'a</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l' aa b l'a aaa ba j
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> t0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="skolem">l'a</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'a</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="skolem">b</span><span class="main">)</span><span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="skolem">b</span><span class="main">)</span><span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>
        sorted_wrt_nth_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?j</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
        a b t0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'a</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t0 b
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">n</span> <span class="skolem">l'a</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less nth_take<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less nth_take<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l' aa l'a aaa ba j
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> t0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">n</span> <span class="main">≤</span> length <span class="skolem">l'a</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t0 sorted_wrt_nth_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">l'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?j</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
        t1 t4 t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l' aa b l'a aaa ba j
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> t0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">n</span> <span class="main">≤</span> length <span class="skolem">l'a</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">aa</span><span class="main">+</span><span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t3 t0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'a</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t0 sorted_wrt_nth_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">l'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?j</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
        t1 t4 t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">aa</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> t5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_take order_mono_setup.refl<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Then, using the same loop invariant, a binary split for B-tree-like arrays
is derived in a straightforward manner."</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bin_split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> pfarray <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bin_split</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">low'</span><span class="main">,</span><span class="bound">high'</span><span class="main">)</span> <span class="main">←</span> heap_WHILET 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">low</span><span class="main">,</span><span class="bound">high</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span><span class="bound">low</span> <span class="main">&lt;</span> <span class="bound">high</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">low</span><span class="main">,</span><span class="bound">high</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mid</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">low</span>  <span class="main">+</span> <span class="bound">high</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">←</span> Array.nth <span class="bound">a</span> <span class="bound">mid</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="keyword1">then</span>
         return <span class="main">(</span><span class="bound">low</span><span class="main">,</span> <span class="bound">mid</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">&gt;</span> <span class="bound">s</span> <span class="keyword1">then</span>
         return <span class="main">(</span><span class="bound">mid</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="bound">high</span><span class="main">)</span>
      <span class="keyword1">else</span> return <span class="main">(</span><span class="bound">mid</span><span class="main">,</span><span class="bound">mid</span><span class="main">)</span>
     <span class="main">}</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span>
  return <span class="bound">low'</span>
<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">thm</span></span> nth_take

<span class="keyword1" id="BTree_ImpSplit-nth_take_eq"><span class="command">lemma</span></span> nth_take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">ls</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">ls'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">ls</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">ls'</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_take<span class="main">)</span>

<span class="keyword1" id="BTree_ImpSplit-map_snd_sorted_less"><span class="command">lemma</span></span> map_snd_sorted_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted_less <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">⟧</span>
       <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> length_map less_trans nth_map sorted_wrt_iff_nth_less<span class="main">)</span>

<span class="keyword1" id="BTree_ImpSplit-map_snd_sorted_lesseq"><span class="command">lemma</span></span> map_snd_sorted_lesseq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted_less <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">⟧</span>
       <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff less_imp_le map_snd_sorted_less order.not_eq_order_implies_strict<span class="main">)</span>

<span class="keyword1" id="BTree_ImpSplit-bin_split_rule"><span class="command">lemma</span></span> bin_split_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"
sorted_less <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">&lt;</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
 bin_split <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span>
 <span class="main">&lt;</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> snd<span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> snd<span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">l</span><span class="main">)</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="comment1">(* this works in principle, as demonstrated above *)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> bin_split_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> R <span class="main">=</span> heap_WHILET_rule''<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
      R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> <span class="bound">h</span><span class="main">-</span><span class="bound">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span><span class="main">≤</span><span class="bound">h</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">h</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">h</span><span class="main">)</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="bound">h</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">l</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">l</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">l</span><span class="main">)</span><span class="main">≥</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> R

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">decon</span><span class="main"><span class="main">:</span></span> R <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq is_pfa_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sndI nth_take_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">+</span> <span class="main">_</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sndI nth_take_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">+</span> <span class="main">_</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sndI <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ls i ls' _ _ j
    <span class="keyword1"><span class="command">using</span></span> map_snd_sorted_lesseq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> 
      less_mult_imp_div_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ls i j ls' _ _ j'
    <span class="keyword1"><span class="command">using</span></span> map_snd_sorted_lesseq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="skolem">j'</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> 
      less_mult_imp_div_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ls i ls' _ _ j
    <span class="keyword1"><span class="command">using</span></span> map_snd_sorted_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> 
      less_mult_imp_div_less
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ls i j ls' _ _ j'
    <span class="keyword1"><span class="command">using</span></span> map_snd_sorted_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="skolem">j'</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> 
      less_mult_imp_div_less
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less nth_take_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Refinement of an abstract split"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We provide a certain abstract split function
that is particularly easy to analyse. The idea of this function is due to Peter Lammich."</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">abs_split</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> btree_abs_search<span class="main">:</span> split <span class="quoted">abs_split</span>
  <span class="keyword1"><span class="command">unfolding</span></span> abs_split_def sym<span class="main">[</span><span class="operator">OF</span> linear_split_alt<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any function that yields the heap rule
we have obtained for bin\_split and lin\_split also
refines this abstract split.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> imp_split_smeq <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">split_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>default<span class="main">,</span>linorder<span class="main">}</span> btnode ref option <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> array <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat Heap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">&lt;</span>is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>
   <span class="free">split_fun</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_pfa <span class="free">c</span> <span class="free">xs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span>
                 <span class="main">↑</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span>
                   <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">r</span><span class="main">.</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span>
                   <span class="main">(</span><span class="bound">r</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">p</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="BTree_ImpSplit-abs_split_full"><span class="command">lemma</span></span> abs_split_full<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> abs_split <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_split_def<span class="main">)</span>


<span class="keyword1" id="BTree_ImpSplit-abs_split_split"><span class="command">lemma</span></span> abs_split_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span><span class="main">(</span><span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs_split <span class="free">xs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">,</span> drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_split_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> id_take_nth_drop old.prod.case takeWhile_eq_all_conv takeWhile_tail<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc case_prod_conv dropWhile.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dropWhile_append2 id_take_nth_drop<span class="main">)</span>


<span class="keyword1" id="BTree_ImpSplit-split_rule_abs_split"><span class="command">lemma</span></span> split_rule_abs_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"sorted_less <span class="main">(</span>separators <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">&lt;</span>
    is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
  <span class="main">*</span> list_assn <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span> <span class="free">ts</span> <span class="free">tsi</span><span class="main">&gt;</span> 
    <span class="free">split_fun</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span> 
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 
    is_pfa <span class="free">c</span> <span class="free">tsi</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>
    <span class="main">*</span> list_assn <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> id_assn<span class="main">)</span> <span class="free">ts</span> <span class="free">tsi</span>
    <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> hoare_triple_preI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> split_rule <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mod_starD id_assn_list
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_assn_prod_map split_ismeq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_pfa_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">l'</span> <span class="keyword3"><span class="command">assume</span></span> heap_init<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊨</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">l'</span>"</span></span>
    <span class="quoted"><span class="quoted">"map snd <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="skolem">l'</span>"</span></span>


  <span class="keyword3"><span class="command">show</span></span> full_thm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span>
       split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> sm_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="main">(</span>map snd <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map snd <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="main">(</span>map snd <span class="free">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map snd <span class="free">ts</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> heap_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_unfold in_set_conv_nth length_map nth_map<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs_split <span class="free">ts</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> abs_split_full<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_relation_length
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> heap_init<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> heap_init<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_map length_take min.absorb2<span class="main">)</span>

  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span>
       <span class="free">p</span> <span class="main">≤</span> snd <span class="main">(</span>take <span class="free">n</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
       split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> part_thm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span>
       <span class="free">p</span> <span class="main">≤</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x_sm_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> sm_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map snd <span class="skolem">l'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> heap_init
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map snd <span class="free">ts</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> heap_init  x_sm_len
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x_sm_len_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> heap_init x_sm_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">x</span> <span class="free">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth  min.absorb2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> snd <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">l'</span><span class="main">!</span><span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span><span class="main">(</span><span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">ts</span><span class="main">!</span><span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span><span class="main">(</span><span class="bound">s</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> heap_init x_sm_len x_sm_len_ts
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold length_map length_take min.absorb2 nth_take snd_map_help<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs_split <span class="free">ts</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">x</span> <span class="free">ts</span><span class="main">,</span> drop <span class="skolem">x</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_sm_len_ts abs_split_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> heap_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map length_take min.absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"split_relation <span class="free">ts</span> <span class="main">(</span>abs_split <span class="free">ts</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_sm_len_ts 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id heap_init<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> heap_init<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_map length_take less_imp_le_nat min.absorb2 split_relation_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> imp_split <span class="quoted">abs_split</span> <span class="quoted"><span class="free">split_fun</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> split_rule_abs_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Obtaining executable code"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"In order to obtain fully defined functions,
we need to plug our split function implementations
into the locales we introduced previously."</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> btree_imp_linear_split<span class="main">:</span> imp_split_smeq <span class="quoted">lin_split</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> lin_split_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Obtaining actual code turns out to be slightly more difficult
  due to the use of locales. However, we successfully obtain
the B-tree insertion and membership query with binary search splitting."</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> btree_imp_binary_split<span class="main">:</span> imp_split_smeq <span class="quoted">bin_split</span>
  <span class="keyword2"><span class="keyword">defines</span></span> btree_isin <span class="main">=</span> <span class="quoted">btree_imp_binary_split.isin</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_ins <span class="main">=</span> <span class="quoted">btree_imp_binary_split.ins</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_insert <span class="main">=</span> <span class="quoted">btree_imp_binary_split.insert</span>
    <span class="keyword2"><span class="keyword">and</span></span> btree_empty <span class="main">=</span> <span class="quoted">btree_imp_binary_split.empty</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span> bin_split_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">thm</span></span> btree_imp_binary_split.ins.simps
<span class="keyword1"><span class="command">declare</span></span> btree_imp_binary_split.ins.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span> btree_imp_binary_split.isin.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">btree_empty</span></span> <span class="quoted"><span class="quoted">btree_isin</span></span> <span class="quoted"><span class="quoted">btree_insert</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML Scala
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">btree_empty</span></span> <span class="quoted"><span class="quoted">btree_isin</span></span> <span class="quoted"><span class="quoted">btree_insert</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> BTreeInsert
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">btree_empty</span></span> <span class="quoted"><span class="quoted">btree_isin</span></span> <span class="quoted"><span class="quoted">btree_insert</span></span> <span class="keyword2"><span class="keyword">in</span></span> Scala <span class="keyword2"><span class="keyword">module_name</span></span> BTreeInsert

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>