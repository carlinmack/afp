<div id="SpecCheck_Base">
<div class="head">
<h1>Theory SpecCheck_Base</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SpecCheck Base›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Base
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/Pure/Pure/Pure.html">Pure</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic setup for SpecCheck.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹util.ML›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹speccheck_base.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹property.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹configuration.ML›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹random.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/util.ML">
<div class="head">
<h1>File ‹util.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/util.ML
    Author:     Kevin Kappelmann

General utility functions for SpecCheck.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">val</span></span> spaces <span class="main">:</span> string list <span class="main">-&gt;</span> string

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Util</span> <span class="main">:</span> <span class="entity">SPECCHECK_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">spaces</span> <span class="main">=</span> space_implode <span class="inner_quoted">" "</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/speccheck_base.ML">
<div class="head">
<h1>File ‹speccheck_base.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/speccheck_base.ML
    Author:     Kevin Kappelmann

Types returned by single tests and complete test runs as well as simple utility methods on them.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">result_single</span> <span class="main">=</span> <span class="entity">Result</span> <span class="keyword2"><span class="keyword">of</span></span> bool <span class="main">|</span> <span class="entity">Discard</span> <span class="main">|</span> <span class="entity">Exception</span> <span class="keyword2"><span class="keyword">of</span></span> exn

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">stats</span> <span class="main">=</span> <span class="main">{</span>
    num_success_tests <span class="main">:</span> int<span class="main">,</span>
    num_failed_tests <span class="main">:</span> int<span class="main">,</span>
    num_discarded_tests <span class="main">:</span> int<span class="main">,</span>
    num_recently_discarded_tests <span class="main">:</span> int<span class="main">,</span>
    num_success_shrinks <span class="main">:</span> int<span class="main">,</span>
    num_failed_shrinks <span class="main">:</span> int<span class="main">,</span>
    timing <span class="main">:</span> Timing.timing
  <span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> add_timing <span class="main">:</span> Timing.timing <span class="main">-&gt;</span> Timing.timing <span class="main">-&gt;</span> Timing.timing

  <span class="keyword1"><span class="keyword">val</span></span> empty_stats <span class="main">:</span> <span class="entity">stats</span>
  <span class="keyword1"><span class="keyword">val</span></span> num_tests <span class="main">:</span> <span class="entity">stats</span> <span class="main">-&gt;</span> int
  <span class="keyword1"><span class="keyword">val</span></span> num_shrinks <span class="main">:</span> <span class="entity">stats</span> <span class="main">-&gt;</span> int

  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">failure_data</span> <span class="main">=</span> <span class="main">{</span>
    counterexamples <span class="main">:</span> 'a list<span class="main">,</span>
    the_exception <span class="main">:</span> exn option
  <span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> failure_data <span class="main">:</span> 'a list <span class="main">-&gt;</span> 'a <span class="entity">failure_data</span>
  <span class="keyword1"><span class="keyword">val</span></span> failure_data_exn <span class="main">:</span> 'a list <span class="main">-&gt;</span> exn <span class="main">-&gt;</span> 'a <span class="entity">failure_data</span>

  <span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">result</span> <span class="main">=</span>
    <span class="entity">Success</span> <span class="keyword2"><span class="keyword">of</span></span> stats <span class="main">|</span>
    <span class="entity">Gave_Up</span> <span class="keyword2"><span class="keyword">of</span></span> stats <span class="main">|</span>
    <span class="entity">Failure</span> <span class="keyword2"><span class="keyword">of</span></span> stats * 'a failure_data

  <span class="keyword1"><span class="keyword">val</span></span> stats_of_result <span class="main">:</span> 'a <span class="entity">result</span> <span class="main">-&gt;</span> <span class="entity">stats</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Base</span> <span class="main">:</span> <span class="entity">SPECCHECK_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">result_single</span> <span class="main">=</span> <span class="entity">Result</span> <span class="keyword2"><span class="keyword">of</span></span> bool <span class="main">|</span> <span class="entity">Discard</span> <span class="main">|</span> <span class="entity">Exception</span> <span class="keyword2"><span class="keyword">of</span></span> exn

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">stats</span> <span class="main">=</span> <span class="main">{</span>
  num_success_tests <span class="main">:</span> int<span class="main">,</span>
  num_failed_tests <span class="main">:</span> int<span class="main">,</span>
  num_discarded_tests <span class="main">:</span> int<span class="main">,</span>
  num_recently_discarded_tests <span class="main">:</span> int<span class="main">,</span>
  num_success_shrinks <span class="main">:</span> int<span class="main">,</span>
  num_failed_shrinks <span class="main">:</span> int<span class="main">,</span>
  timing <span class="main">:</span> Timing.timing
<span class="main">}</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty_stats</span> <span class="main">=</span> <span class="main">{</span>
  num_success_tests <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  num_failed_tests <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  num_discarded_tests <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  num_recently_discarded_tests <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  num_success_shrinks <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  num_failed_shrinks <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span>
  timing <span class="main">=</span> <span class="main">{</span>
    cpu <span class="main">=</span> Time.zeroTime<span class="main">,</span>
    elapsed <span class="main">=</span> Time.zeroTime<span class="main">,</span>
    gc <span class="main">=</span> Time.zeroTime
  <span class="main">}</span>
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_timing</span> <span class="main">{</span>elapsed <span class="main">=</span> <span class="entity">elapsed1</span><span class="main">,</span> cpu <span class="main">=</span> <span class="entity">cpu1</span><span class="main">,</span> gc <span class="main">=</span> <span class="entity">gc1</span><span class="main">}</span>
  <span class="main">{</span>elapsed <span class="main">=</span> <span class="entity">elapsed2</span><span class="main">,</span> cpu <span class="main">=</span> <span class="entity">cpu2</span><span class="main">,</span> gc <span class="main">=</span> <span class="entity">gc2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>
  elapsed <span class="main">=</span> <span class="entity">elapsed1</span> + <span class="entity">elapsed2</span><span class="main">,</span>
  cpu <span class="main">=</span> <span class="entity">cpu1</span> + <span class="entity">cpu2</span><span class="main">,</span>
  gc <span class="main">=</span> <span class="entity">gc1</span> + <span class="entity">gc2</span>
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">num_tests</span> <span class="main">{</span><span class="entity">num_success_tests</span><span class="main">,</span> <span class="entity">num_failed_tests</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span>
  <span class="entity">num_success_tests</span> + <span class="entity">num_failed_tests</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">num_shrinks</span> <span class="main">{</span><span class="entity">num_success_shrinks</span><span class="main">,</span> <span class="entity">num_failed_shrinks</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span>
  <span class="entity">num_success_shrinks</span> + <span class="entity">num_failed_shrinks</span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">failure_data</span> <span class="main">=</span> <span class="main">{</span>
  counterexamples <span class="main">:</span> 'a list<span class="main">,</span>
  the_exception <span class="main">:</span> exn option
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">failure_data</span> <span class="entity">counterexamples</span> <span class="main">=</span> <span class="main">{</span>
  counterexamples <span class="main">=</span> <span class="entity">counterexamples</span><span class="main">,</span>
  the_exception <span class="main">=</span> NONE
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">failure_data_exn</span> <span class="entity">counterexamples</span> <span class="entity">exn</span> <span class="main">=</span> <span class="main">{</span>
  counterexamples <span class="main">=</span> <span class="entity">counterexamples</span><span class="main">,</span>
  the_exception <span class="main">=</span> SOME <span class="entity">exn</span>
<span class="main">}</span>

<span class="keyword1"><span class="keyword">datatype</span></span> 'a <span class="entity">result</span> <span class="main">=</span>
  <span class="entity">Success</span> <span class="keyword2"><span class="keyword">of</span></span> stats <span class="main">|</span>
  <span class="entity">Gave_Up</span> <span class="keyword2"><span class="keyword">of</span></span> stats <span class="main">|</span>
  <span class="entity">Failure</span> <span class="keyword2"><span class="keyword">of</span></span> stats * 'a failure_data

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">stats_of_result</span> <span class="main">(</span><span class="entity">Success</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=</span> <span class="entity">stats</span>
  <span class="main">|</span> <span class="entity">stats_of_result</span> <span class="main">(</span><span class="entity">Gave_Up</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=</span> <span class="entity">stats</span>
  <span class="main">|</span> <span class="entity">stats_of_result</span> <span class="main">(</span><span class="entity">Failure</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">stats</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/property.ML">
<div class="head">
<h1>File ‹property.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/property.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

The base module of testable properties.
A property is the type of values that SpecCheck knows how to test.
Properties not only test whether a given predicate holds, but, for example, can also have
preconditions.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_PROPERTY</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">pred</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> bool
  <span class="comment1">(*the type of values testable by SpecCheck*)</span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">prop</span>
  <span class="comment1">(*transforms a predicate into a testable property*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> prop <span class="main">:</span> 'a <span class="entity">pred</span> <span class="main">-&gt;</span> 'a <span class="entity">prop</span>
  <span class="comment1">(*implication for properties: if the first argument evaluates to false, the test case is
    discarded*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> implies <span class="main">:</span> 'a <span class="entity">pred</span> <span class="main">-&gt;</span> 'a <span class="entity">prop</span> <span class="main">-&gt;</span> 'a <span class="entity">prop</span>
  <span class="comment1">(*convenient notation for `implies` working on predicates*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> ==&gt; <span class="main">:</span> 'a <span class="entity">pred</span> * 'a <span class="entity">pred</span> <span class="main">-&gt;</span> 'a <span class="entity">prop</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Property</span> <span class="main">:</span> <span class="entity">SPECCHECK_PROPERTY</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">pred</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">prop</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> <span class="entity">SpecCheck_Base.result_single</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">SpecCheck_Base.Result</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span>
  <span class="comment1">(*testcode may throw arbitrary exceptions; interrupts must not be caught!*)</span>
  <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">exn</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> Exn.is_interrupt <span class="entity">exn</span> <span class="keyword2"><span class="keyword">then</span></span> Exn.reraise <span class="entity">exn</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">SpecCheck_Base.Exception</span> <span class="entity">exn</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prop</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">apply</span> <span class="entity">f</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">implies</span> <span class="entity">cond</span> <span class="entity">prop</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">cond</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">prop</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">SpecCheck_Base.Discard</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">==&gt;</span> <span class="main">(</span><span class="entity">p1</span><span class="main">,</span> <span class="entity">p2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">implies</span> <span class="entity">p1</span> <span class="main">(</span><span class="entity">prop</span> <span class="entity">p2</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/configuration.ML">
<div class="head">
<h1>File ‹configuration.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/configuration.ML
    Author:     Kevin Kappelmann

Configuration options for SpecCheck.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_CONFIGURATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

  <span class="comment1">(*maximum number of successful tests before succeeding*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> max_success <span class="main">:</span> int Config.T
  <span class="comment1">(*maximum number of discarded tests per successful test before giving up*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> max_discard_ratio <span class="main">:</span> int Config.T
  <span class="comment1">(*maximum number of shrinks per counterexample*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> max_shrinks <span class="main">:</span> int Config.T
  <span class="comment1">(*number of counterexamples shown*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> num_counterexamples <span class="main">:</span> int Config.T
  <span class="comment1">(*sort counterexamples by size*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> sort_counterexamples <span class="main">:</span> bool Config.T
  <span class="comment1">(*print timing etc. depending on style*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> show_stats <span class="main">:</span> bool Config.T

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Configuration</span> <span class="main">:</span> <span class="entity">SPECCHECK_CONFIGURATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_success</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_int</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_max_success›</span></span> <span class="main">(</span>K <span class="inner_numeral">100</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_discard_ratio</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_int</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_max_discard_ratio›</span></span> <span class="main">(</span>K <span class="inner_numeral">10</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_shrinks</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_int</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_max_shrinks›</span></span> <span class="main">(</span>K <span class="inner_numeral">10000</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_counterexamples</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_int</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_num_counterexamples›</span></span> <span class="main">(</span>K <span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort_counterexamples</span> <span class="main">=</span>
  <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_sort_counterexamples›</span></span> <span class="main">(</span>K true<span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">show_stats</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹speccheck_show_stats›</span></span> <span class="main">(</span>K true<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/random.ML">
<div class="head">
<h1>File ‹random.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/random.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

A Lehmer random number generator:
https://en.wikipedia.org/wiki/Lehmer_random_number_generator
We use int to avoid any float imprecision problems (and the seed is an int anyway).
The parameters "a" and "m" are selected according to the recommendation in above article;
they are an an improved version of the so-called "minimal standard" (MINSTD) generator.

This file only contains those functions that rely on the internal integer representation of rand.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_RANDOM</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rand</span>
  <span class="comment1">(*creates a new random seed*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> new <span class="main">:</span> unit <span class="main">-&gt;</span> <span class="entity">rand</span>
  <span class="comment1">(*creates a new random seed from a given one*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> next <span class="main">:</span> <span class="entity">rand</span> <span class="main">-&gt;</span> <span class="entity">rand</span>
  <span class="comment1">(*use this function for reproducible randomness; inputs ≤ 0 are mapped to 1*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> deterministic_seed <span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">rand</span>

  <span class="comment1">(*returns a real in the unit interval [0;1]; theoretically, with 2^31-2 equidistant discrete
    values*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> real_unit <span class="main">:</span> <span class="entity">rand</span> <span class="main">-&gt;</span> real * <span class="entity">rand</span>

  <span class="comment1">(*splits a seed into two new independent seeds*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> split <span class="main">:</span> <span class="entity">rand</span> <span class="main">-&gt;</span> <span class="entity">rand</span> * <span class="entity">rand</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Random</span> <span class="main">:</span> <span class="entity">SPECCHECK_RANDOM</span>  <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rand</span> <span class="main">=</span> int

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> <span class="inner_numeral">48271</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">m</span> <span class="main">=</span> <span class="inner_numeral">2147483647</span> <span class="comment1">(* 2^31 - 1 *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">next</span> <span class="entity">seed</span> <span class="main">=</span> <span class="main">(</span><span class="entity">seed</span> * <span class="entity">a</span><span class="main">)</span> mod <span class="entity">m</span>

<span class="comment1">(*TODO: Time is not sufficiently random when polled rapidly!*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  Time.now <span class="main">(</span><span class="main">)</span>
  |&gt; Time.toMicroseconds
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Int.max <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">x</span> mod <span class="entity">m</span><span class="main">)</span><span class="main">)</span> <span class="comment1">(*The seed must be within [1;m)*)</span>
  |&gt; <span class="entity">next</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">deterministic_seed</span> <span class="entity">r</span> <span class="main">=</span> Int.max <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">r</span> mod <span class="entity">m</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">real_unit</span> <span class="entity">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Real.fromInt <span class="main">(</span><span class="entity">r</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> / <span class="main">(</span>Real.fromInt <span class="main">(</span><span class="entity">m</span> - <span class="inner_numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">next</span> <span class="entity">r</span><span class="main">)</span>

<span class="comment1">(*TODO: In theory, the current implementation could return two seeds directly adjacent in the
sequence of the pseudorandom number generator. Practically, however, it should be good enough.*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r0</span> <span class="main">=</span> <span class="entity">next</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r1</span> <span class="main">=</span> <span class="entity">r</span> - <span class="entity">r0</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">next</span> <span class="entity">r0</span><span class="main">,</span> <span class="entity">next</span> <span class="entity">r1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck_Generators">
<div class="head">
<h1>Theory SpecCheck_Generators</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generators›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Generators
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SpecCheck_Base">SpecCheck_Base</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generators for SpecCheck take a state and return a pair consisting of a generated value and
a new state. Refer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> "gen_base.ML"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for the most basic combinators.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_types.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_base.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_text.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_int.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_real.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_function.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen_term.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹gen.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_types.ML">
<div class="head">
<h1>File ‹gen_types.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_types.ML
    Author:     Kevin Kappelmann

Shared type definitions for SpecCheck generators.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

  <span class="comment1">(*consumes a state and returns a new state along with a generated value*)</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">=</span> 's <span class="main">-&gt;</span> 'a * 's
  <span class="comment1">(*consumes a random seed and returns an unused one along with a generated value*)</span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">gen</span> <span class="main">=</span> <span class="main">(</span>'a<span class="main">,</span> <span class="entity">SpecCheck_Random.rand</span><span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*a cogenerator produces new generators depending on an input element and an existing generator.*)</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">cogen_state</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*a cogenerator produces new generators depending on an input element and an existing generator.*)</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span> <span class="main">=</span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">,</span> <span class="entity">SpecCheck_Random.rand</span><span class="main">)</span> <span class="entity">cogen_state</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Types</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">=</span> 's <span class="main">-&gt;</span> 'a * 's

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">gen</span> <span class="main">=</span> <span class="main">(</span>'a<span class="main">,</span> <span class="entity">SpecCheck_Random.rand</span><span class="main">)</span> <span class="entity">gen_state</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">cogen_state</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span> <span class="main">=</span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">,</span> <span class="entity">SpecCheck_Random.rand</span><span class="main">)</span> <span class="entity">cogen_state</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_base.ML">
<div class="head">
<h1>File ‹gen_base.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_base.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Basic utility functions to create and combine generators.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">SPECCHECK_GEN_TYPES</span>

  <span class="comment1">(*generator that always returns the passed value*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> return <span class="main">:</span> 'a <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> join <span class="main">:</span> <span class="main">(</span><span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span><span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="keyword1"><span class="keyword">val</span></span> zip <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> zip3 <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a * 'b * 'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> zip4 <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'d<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a * 'b * 'c * 'd<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> map <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> map2 <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> map3 <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c <span class="main">-&gt;</span> 'd<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'d<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> map4 <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 'b <span class="main">-&gt;</span> 'c <span class="main">-&gt;</span> 'd <span class="main">-&gt;</span> 'e<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'b<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'c<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'d<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'e<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*ensures that all generated values fulfill the predicate; loops if the predicate is never
    satisfied by the generated values.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> filter <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> filter_bounded <span class="main">:</span> int <span class="main">-&gt;</span> <span class="main">(</span>'a <span class="main">-&gt;</span> bool<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*bernoulli random variable with parameter p ∈ [0,1]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> bernoulli <span class="main">:</span> real <span class="main">-&gt;</span> bool <span class="entity">gen</span>

  <span class="comment1">(*random variable following a binomial distribution with parameters p ∈ [0,1] and n ≥ 0*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> binom_dist <span class="main">:</span> real <span class="main">-&gt;</span> int <span class="main">-&gt;</span> int <span class="entity">gen</span>

  <span class="comment1">(*range_int (x,y) r returns a value in [x;y]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> range_int <span class="main">:</span> int * int <span class="main">-&gt;</span> int <span class="entity">gen</span>

  <span class="comment1">(*randomly generates one of the given values*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> elements <span class="main">:</span> 'a vector <span class="main">-&gt;</span> 'a <span class="entity">gen</span>
  <span class="comment1">(*randomly uses one of the given generators*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> one_of <span class="main">:</span> 'a <span class="entity">gen</span> vector <span class="main">-&gt;</span> 'a <span class="entity">gen</span>

  <span class="comment1">(*randomly generates one of the given values*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> elementsL <span class="main">:</span> 'a list <span class="main">-&gt;</span> 'a <span class="entity">gen</span>
  <span class="comment1">(*randomly uses one of the given generators*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> one_ofL <span class="main">:</span> 'a <span class="entity">gen</span> list <span class="main">-&gt;</span> 'a <span class="entity">gen</span>

  <span class="comment1">(*chooses one of the given generators with a weighted random distribution.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> one_ofW <span class="main">:</span> <span class="main">(</span>int * 'a <span class="entity">gen</span><span class="main">)</span> vector <span class="main">-&gt;</span> 'a <span class="entity">gen</span>
  <span class="comment1">(*chooses one of the given values with a weighted random distribution.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> elementsW <span class="main">:</span> <span class="main">(</span>int * 'a<span class="main">)</span> vector <span class="main">-&gt;</span> 'a <span class="entity">gen</span>

  <span class="comment1">(*chooses one of the given generators with a weighted random distribution.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> one_ofWL <span class="main">:</span> <span class="main">(</span>int * 'a <span class="entity">gen</span><span class="main">)</span> list <span class="main">-&gt;</span> 'a <span class="entity">gen</span>
  <span class="comment1">(*chooses one of the given values with a weighted random distribution.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> elementsWL <span class="main">:</span> <span class="main">(</span>int * 'a<span class="main">)</span> list <span class="main">-&gt;</span> 'a <span class="entity">gen</span>

  <span class="comment1">(*creates a vector of length as returned by the passed int generator*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> vector <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a vector<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*creates a list of length as returned by the passed int generator*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> list <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a list<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*generates elements until the passed (generator) predicate fails;
    returns a list of all values that satisfied the predicate*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> unfold_while <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> <span class="main">(</span>bool<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a list<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="comment1">(*generates a random permutation of the given list*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> shuffle <span class="main">:</span> 'a list <span class="main">-&gt;</span> 'a list <span class="entity">gen</span>

  <span class="comment1">(*generates SOME value if passed bool generator returns true and NONE otherwise*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> option <span class="main">:</span> <span class="main">(</span>bool<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*seq gen init_state creates a sequence where gen takes a state and returns the next element and
    an updated state. The sequence stops when the first NONE value is returned by the generator.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> seq <span class="main">:</span> <span class="main">(</span>'a option<span class="main">,</span> 's * <span class="entity">SpecCheck_Random.rand</span><span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> <span class="main">(</span>'a Seq.seq<span class="main">)</span> <span class="entity">gen</span>

  <span class="comment1">(*creates a generator that returns all elements of the sequence in order*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> of_seq <span class="main">:</span> <span class="main">(</span>'a option<span class="main">,</span> 'a Seq.seq<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="keyword1"><span class="keyword">val</span></span> unit <span class="main">:</span> <span class="main">(</span>unit<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> ref_gen <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>'a Unsynchronized.ref<span class="main">,</span> 's<span class="main">)</span> <span class="entity">gen_state</span>

  <span class="comment1">(*variant i g creates the ith variant of a given generator. It raises an error if i is negative.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> variant <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span>
  <span class="keyword1"><span class="keyword">val</span></span> cobool <span class="main">:</span> <span class="main">(</span>bool<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span>
  <span class="keyword1"><span class="keyword">val</span></span> colist <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span> <span class="main">-&gt;</span> <span class="main">(</span>'a list<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span>
  <span class="keyword1"><span class="keyword">val</span></span> cooption <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">cogen</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Base</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Types

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">return</span> <span class="main">=</span> pair
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">join</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">g</span> #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">g'</span><span class="main">,</span> <span class="entity">r'</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">g'</span> <span class="entity">r'</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip</span> <span class="entity">g1</span> <span class="entity">g2</span> <span class="main">=</span>
  <span class="entity">g1</span> #-&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x1</span> <span class="main">=&gt;</span> <span class="entity">g2</span> #-&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x2</span> <span class="main">=&gt;</span> pair <span class="main">(</span><span class="entity">x1</span><span class="main">,</span> <span class="entity">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip3</span> <span class="entity">g1</span> <span class="entity">g2</span> <span class="entity">g3</span> <span class="main">=</span>
  <span class="entity">zip</span> <span class="entity">g1</span> <span class="main">(</span><span class="entity">zip</span> <span class="entity">g2</span> <span class="entity">g3</span><span class="main">)</span> #-&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x1</span><span class="main">,</span> <span class="main">(</span><span class="entity">x2</span><span class="main">,</span> <span class="entity">x3</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> pair <span class="main">(</span><span class="entity">x1</span><span class="main">,</span> <span class="entity">x2</span><span class="main">,</span> <span class="entity">x3</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip4</span> <span class="entity">g1</span> <span class="entity">g2</span> <span class="entity">g3</span> <span class="entity">g4</span> <span class="main">=</span>
  <span class="entity">zip</span> <span class="main">(</span><span class="entity">zip</span> <span class="entity">g1</span> <span class="entity">g2</span><span class="main">)</span> <span class="main">(</span><span class="entity">zip</span> <span class="entity">g3</span> <span class="entity">g4</span><span class="main">)</span> #-&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x1</span><span class="main">,</span> <span class="entity">x2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">x3</span><span class="main">,</span> <span class="entity">x4</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> pair <span class="main">(</span><span class="entity">x1</span><span class="main">,</span> <span class="entity">x2</span><span class="main">,</span> <span class="entity">x3</span><span class="main">,</span> <span class="entity">x4</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map</span> <span class="entity">f</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">g</span> #&gt;&gt; <span class="entity">f</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map2</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map</span> <span class="main">(</span>uncurry <span class="entity">f</span><span class="main">)</span> oo <span class="entity">zip</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map3</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">c</span><span class="main">)</span> ooo <span class="entity">zip3</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map4</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">b</span> <span class="entity">c</span> <span class="entity">d</span><span class="main">)</span> oooo <span class="entity">zip4</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filter</span> <span class="entity">p</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">loop</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">loop</span> <span class="main">(</span><span class="entity">gen</span> <span class="entity">r</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">loop</span> <span class="main">(</span><span class="entity">gen</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filter_bounded</span> <span class="entity">bound</span> <span class="entity">p</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">loop</span> <span class="inner_numeral">0</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Generator failed to satisfy predicate"</span>
        <span class="main">|</span> <span class="entity">loop</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">loop</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">gen</span> <span class="entity">r</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">loop</span> <span class="entity">bound</span> <span class="main">(</span><span class="entity">gen</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bernoulli</span> <span class="entity">p</span> <span class="entity">r</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">SpecCheck_Random.real_unit</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">x</span> &lt;= <span class="entity">p</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">binom_dist</span> <span class="entity">p</span> <span class="entity">n</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">binom_dist_unchecked</span> <span class="main">_</span> <span class="inner_numeral">0</span> <span class="entity">r</span> <span class="main">=</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">binom_dist_unchecked</span> <span class="entity">p</span> <span class="entity">n</span> <span class="entity">r</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">int_of_bool</span> <span class="entity">b</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">bernoulli</span> <span class="entity">p</span> <span class="entity">r</span>
          |&gt;&gt; <span class="entity">int_of_bool</span>
          ||&gt; <span class="entity">binom_dist_unchecked</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span>
          |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="main">(</span><span class="entity">acc</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">acc</span> + <span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Domain <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">binom_dist_unchecked</span> <span class="entity">p</span> <span class="entity">n</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">range_int</span> <span class="main">(</span><span class="entity">min</span><span class="main">,</span> <span class="entity">max</span><span class="main">)</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">min</span> &gt; <span class="entity">max</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">"Range_Int:"</span><span class="main">,</span> string_of_int <span class="entity">min</span><span class="main">,</span> <span class="inner_quoted">"&gt;"</span><span class="main">,</span> string_of_int <span class="entity">max</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span>
    <span class="entity">SpecCheck_Random.real_unit</span> <span class="entity">r</span>
    |&gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> Int.min <span class="main">(</span><span class="entity">min</span> + Real.floor <span class="main">(</span><span class="entity">s</span> * Real.fromInt <span class="main">(</span><span class="entity">max</span> - <span class="entity">min</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">max</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">one_of</span> <span class="entity">v</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> Vector.length <span class="entity">v</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">r</span>
  <span class="keyword2"><span class="keyword">in</span></span> Vector.sub <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">local</span></span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="main">(</span>'a<span class="main">,</span>'b<span class="main">)</span> <span class="entity">either</span> <span class="main">=</span> <span class="entity">Left</span> <span class="keyword2"><span class="keyword">of</span></span> 'a <span class="main">|</span> <span class="entity">Right</span> <span class="keyword2"><span class="keyword">of</span></span> 'b
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">one_ofW</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> <span class="main">(</span>int * 'a <span class="entity">gen</span><span class="main">)</span> vector<span class="main">)</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">weight_total</span> <span class="main">=</span> Vector.foldl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">freq</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">freq</span> + <span class="entity">acc</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="entity">v</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">selectGen</span> <span class="main">_</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">Right</span> <span class="entity">gen</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Right</span> <span class="entity">gen</span>
      <span class="main">|</span> <span class="entity">selectGen</span> <span class="entity">rand</span> <span class="main">(</span><span class="main">(</span><span class="entity">weight</span><span class="main">,</span> <span class="entity">gen</span><span class="main">)</span><span class="main">,</span> <span class="entity">Left</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">acc</span> <span class="main">=</span> <span class="entity">acc</span> + <span class="entity">weight</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">acc</span> &lt; <span class="entity">rand</span>
         <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">Left</span> <span class="entity">acc</span>
         <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Right</span> <span class="entity">gen</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">threshhold</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">weight_total</span><span class="main">)</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">gen</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Vector.foldl <span class="main">(</span><span class="entity">selectGen</span> <span class="entity">threshhold</span><span class="main">)</span> <span class="main">(</span><span class="entity">Left</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">Right</span> <span class="entity">gen</span> <span class="main">=&gt;</span> <span class="entity">gen</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"Error in one_ofW - did you pass an empty vector or invalid frequencies?"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">gen</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elements</span> <span class="entity">v</span> <span class="main">=</span> <span class="entity">one_of</span> <span class="main">(</span>Vector.map <span class="entity">return</span> <span class="entity">v</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elementsW</span> <span class="entity">v</span> <span class="main">=</span> <span class="entity">one_ofW</span> <span class="main">(</span>Vector.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">p</span> ||&gt; <span class="entity">return</span><span class="main">)</span> <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">one_ofL</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">one_of</span> <span class="main">(</span>Vector.fromList <span class="entity">l</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">one_ofWL</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">one_ofW</span> <span class="main">(</span>Vector.fromList <span class="entity">l</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elementsL</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">elements</span> <span class="main">(</span>Vector.fromList <span class="entity">l</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elementsWL</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">elementsW</span> <span class="main">(</span>Vector.fromList <span class="entity">l</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list</span> <span class="entity">length_g</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">length_g</span> <span class="entity">r</span>
  <span class="keyword2"><span class="keyword">in</span></span> fold_map <span class="main">(</span>K <span class="entity">g</span><span class="main">)</span> <span class="main">(</span>map_range I <span class="entity">l</span><span class="main">)</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unfold_while</span> <span class="entity">bool_g_of_elem</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unfold_while_accum</span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">g</span> <span class="entity">r</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">continue</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">bool_g_of_elem</span> <span class="entity">x</span> <span class="entity">r</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">continue</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">unfold_while_accum</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">unfold_while_accum</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> |&gt;&gt; rev <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shuffle</span> <span class="entity">xs</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ns</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">list</span> <span class="main">(</span><span class="entity">return</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="entity">SpecCheck_Random.real_unit</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_ord</span> <span class="main">=</span> make_ord <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> &lt;=<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xs</span> <span class="main">=</span> ListPair.zip <span class="main">(</span><span class="entity">ns</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> |&gt; sort <span class="main">(</span><span class="entity">real_ord</span> o apply2 fst<span class="main">)</span> |&gt; List.map snd
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vector</span> <span class="entity">length_g</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">list</span> <span class="entity">length_g</span> <span class="entity">g</span> #&gt;&gt; Vector.fromList

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">option</span> <span class="entity">bool_g</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">bool_g</span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span>false<span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>true<span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">map</span> SOME <span class="entity">g</span> <span class="entity">r</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq</span> <span class="entity">gen</span> <span class="entity">xq</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r1</span><span class="main">,</span> <span class="entity">r2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">SpecCheck_Random.split</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_next</span> <span class="entity">p</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">gen</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span>NONE<span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> NONE
    <span class="main">|</span> <span class="main">(</span>SOME <span class="entity">v</span><span class="main">,</span> <span class="entity">p</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">v</span><span class="main">,</span> Seq.make <span class="main">(</span><span class="entity">gen_next</span> <span class="entity">p</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Seq.make <span class="main">(</span><span class="entity">gen_next</span> <span class="main">(</span><span class="entity">xq</span><span class="main">,</span> <span class="entity">r1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">r2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">of_seq</span> <span class="entity">xq</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">xq</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xq</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">,</span> <span class="entity">xq</span><span class="main">)</span>
  <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> Seq.empty<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unit</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">return</span> <span class="main">(</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ref_gen</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">value</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">gen</span> <span class="entity">r</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Unsynchronized.ref <span class="entity">value</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">variant</span> <span class="entity">i</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> Subscript
  <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nth</span> <span class="entity">i</span> <span class="entity">r</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r1</span><span class="main">,</span> <span class="entity">r2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">SpecCheck_Random.split</span> <span class="entity">r</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">r1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">nth</span> <span class="main">(</span><span class="entity">i</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">r2</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">g</span> <span class="main">(</span><span class="entity">nth</span> <span class="entity">i</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cobool</span> false <span class="main">=</span> <span class="entity">variant</span> <span class="inner_numeral">0</span>
  <span class="main">|</span> <span class="entity">cobool</span> true <span class="main">=</span> <span class="entity">variant</span> <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">colist</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">variant</span> <span class="inner_numeral">0</span>
  <span class="main">|</span> <span class="entity">colist</span> <span class="entity">co</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">colist</span> <span class="entity">co</span> <span class="entity">xs</span> o <span class="entity">co</span> <span class="entity">x</span> o <span class="entity">variant</span> <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cooption</span> <span class="main">_</span> NONE <span class="main">=</span> <span class="entity">variant</span> <span class="inner_numeral">0</span>
  <span class="main">|</span> <span class="entity">cooption</span> <span class="entity">co</span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="entity">co</span> <span class="entity">x</span> o <span class="entity">variant</span> <span class="inner_numeral">1</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_text.ML">
<div class="head">
<h1>File ‹gen_text.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_text.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Random generators for chars and strings.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_TEXT</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> range_char <span class="main">:</span> char * char <span class="main">-&gt;</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> char <span class="main">:</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> char_of <span class="main">:</span> string <span class="main">-&gt;</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> string <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> char <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    string <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> substring <span class="main">:</span> string <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> substring <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> cochar <span class="main">:</span> <span class="main">(</span>char<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.cogen</span>
  <span class="keyword1"><span class="keyword">val</span></span> costring <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.cogen</span>
  <span class="keyword1"><span class="keyword">val</span></span> cosubstring <span class="main">:</span> <span class="main">(</span>substring<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.cogen</span>

  <span class="keyword1"><span class="keyword">val</span></span> digit <span class="main">:</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> lowercase_letter <span class="main">:</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> uppercase_letter <span class="main">:</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> letter <span class="main">:</span> char <span class="entity">SpecCheck_Gen_Types.gen</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Text</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_TEXT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Base

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">char</span> <span class="main">=</span> Char.char
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">string</span> <span class="main">=</span> String.string
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">substring</span> <span class="main">=</span> Substring.substring

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">range_char</span> <span class="main">(</span><span class="entity">lo</span><span class="main">,</span> <span class="entity">hi</span><span class="main">)</span> <span class="main">=</span> <span class="entity">map</span> Char.chr <span class="main">(</span><span class="entity">range_int</span> <span class="main">(</span>Char.ord <span class="entity">lo</span><span class="main">,</span> Char.ord <span class="entity">hi</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">char</span> <span class="main">=</span> <span class="entity">range_char</span> <span class="main">(</span>Char.minChar<span class="main">,</span> Char.maxChar<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">char_of</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="entity">one_of</span> <span class="main">(</span>Vector.tabulate <span class="main">(</span>String.size <span class="entity">s</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">return</span> <span class="main">(</span>String.sub <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string</span> <span class="entity">length_g</span> <span class="entity">g</span> <span class="main">=</span> <span class="entity">list</span> <span class="entity">length_g</span> <span class="entity">g</span> #&gt;&gt; CharVector.fromList

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">substring</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">gen</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> String.size <span class="entity">s</span><span class="main">)</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">j</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> String.size <span class="entity">s</span> - <span class="entity">i</span><span class="main">)</span> <span class="entity">r</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span>Substring.substring <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cochar</span> <span class="entity">c</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Char.ord <span class="entity">c</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">variant</span> <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">cochar</span> <span class="main">(</span>Char.chr <span class="main">(</span>Char.ord <span class="entity">c</span> div <span class="inner_numeral">2</span><span class="main">)</span><span class="main">)</span> o <span class="entity">variant</span> <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cosubstring</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">colist</span> <span class="entity">cochar</span> <span class="main">(</span>Substring.explode <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">costring</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">cosubstring</span> <span class="main">(</span>Substring.full <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">digit</span> <span class="main">=</span> <span class="entity">range_char</span> <span class="main">(</span><span class="inner_quoted">#"0"</span><span class="main">,</span> <span class="inner_quoted">#"9"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lowercase_letter</span> <span class="main">=</span> <span class="entity">range_char</span> <span class="main">(</span><span class="inner_quoted">#"a"</span><span class="main">,</span> <span class="inner_quoted">#"z"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">uppercase_letter</span> <span class="main">=</span> <span class="entity">range_char</span> <span class="main">(</span><span class="inner_quoted">#"A"</span><span class="main">,</span> <span class="inner_quoted">#"Z"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">letter</span> <span class="main">=</span> <span class="entity">one_ofL</span> <span class="main">[</span><span class="entity">lowercase_letter</span><span class="main">,</span> <span class="entity">uppercase_letter</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_int.ML">
<div class="head">
<h1>File ‹gen_int.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_int.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Random generators for ints.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_INT</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>

  <span class="comment1">(*pos m generates an integer in [1, m]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> pos <span class="main">:</span> int <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*neg m generates an integer in [m, 1]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> neg <span class="main">:</span> int <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*nonneg m generates an integer in [0, m]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> nonneg <span class="main">:</span> int <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*nonpos m generates an integer in [m, 0]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> nonpos <span class="main">:</span> int <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> coint <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.cogen</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Int</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_INT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Base

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pos</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">m</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">neg</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span> <span class="inner_numeral">~1</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nonneg</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="entity">m</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nonpos</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="entity">m</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">coint</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">variant</span> <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">coint</span> <span class="main">(</span>~<span class="entity">n</span><span class="main">)</span> o <span class="entity">variant</span> <span class="inner_numeral">1</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">coint</span> <span class="main">(</span><span class="entity">n</span> div <span class="inner_numeral">2</span><span class="main">)</span> o <span class="entity">variant</span> <span class="inner_numeral">2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_real.ML">
<div class="head">
<h1>File ‹gen_real.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_real.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Random generators for reals.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_REAL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>

  <span class="comment1">(*range_real (x,y) r returns a value in [x, y]*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> range_real <span class="main">:</span> real * real <span class="main">-&gt;</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> real <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> real_pos <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> real_neg <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> real_nonneg <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> real_nonpos <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> real_finite <span class="main">:</span> real <span class="entity">SpecCheck_Gen_Types.gen</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Real</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_REAL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Base
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Text

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">range_real</span> <span class="main">(</span><span class="entity">min</span><span class="main">,</span> <span class="entity">max</span><span class="main">)</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">min</span> &gt; <span class="entity">max</span>
  <span class="keyword2"><span class="keyword">then</span></span>
    <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="main">(</span><span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">"Range_Real:"</span><span class="main">,</span> string_of_real <span class="entity">min</span><span class="main">,</span> <span class="inner_quoted">"&gt;"</span><span class="main">,</span> string_of_real <span class="entity">max</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">SpecCheck_Random.real_unit</span> <span class="entity">r</span> |&gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">min</span> + <span class="main">(</span><span class="entity">s</span> * <span class="entity">max</span> - <span class="entity">s</span> * <span class="entity">min</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">digits</span> <span class="main">=</span> <span class="entity">string</span> <span class="main">(</span><span class="entity">range_int</span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> Real.precision<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">range_char</span> <span class="main">(</span><span class="inner_quoted">#"0"</span><span class="main">,</span> <span class="inner_quoted">#"9"</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>exp<span class="main">=</span><span class="entity">minExp</span><span class="main">,</span><span class="main">...</span><span class="main">}</span> <span class="main">=</span> Real.toManExp Real.minPos
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>exp<span class="main">=</span><span class="entity">maxExp</span><span class="main">,</span><span class="main">...</span><span class="main">}</span> <span class="main">=</span> Real.toManExp Real.posInf

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ratio</span> <span class="main">=</span> <span class="inner_numeral">99</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">digits</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">digits</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">e</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">range_int</span> <span class="main">(</span><span class="entity">minExp</span> div <span class="inner_numeral">4</span><span class="main">,</span> <span class="entity">maxExp</span> div <span class="inner_numeral">4</span><span class="main">)</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> String.concat <span class="main">[</span><span class="entity">a</span><span class="main">,</span> <span class="inner_quoted">"."</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="inner_quoted">"E"</span><span class="main">,</span> Int.toString <span class="entity">e</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span>the <span class="main">(</span>Real.fromString <span class="entity">x</span><span class="main">)</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_pos</span> <span class="main">=</span> <span class="entity">one_ofWL</span> <span class="main">(</span><span class="main">(</span><span class="entity">ratio</span><span class="main">,</span> <span class="entity">mk</span><span class="main">)</span> ::
  List.map <span class="main">(</span><span class="main">(</span>pair <span class="inner_numeral">1</span><span class="main">)</span> o <span class="entity">return</span><span class="main">)</span> <span class="main">[</span>Real.posInf<span class="main">,</span> Real.maxFinite<span class="main">,</span> Real.minPos<span class="main">,</span> Real.minNormalPos<span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_neg</span> <span class="main">=</span> <span class="entity">map</span> Real.~ <span class="entity">real_pos</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_nonneg</span> <span class="main">=</span> <span class="entity">one_ofWL</span> <span class="main">[</span><span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">return</span> <span class="inner_numeral">0.0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">ratio</span><span class="main">,</span> <span class="entity">real_pos</span><span class="main">)</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_nonpos</span> <span class="main">=</span> <span class="entity">one_ofWL</span> <span class="main">[</span><span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">return</span> <span class="inner_numeral">0.0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">ratio</span><span class="main">,</span> <span class="entity">real_neg</span><span class="main">)</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real</span> <span class="main">=</span> <span class="entity">one_ofL</span> <span class="main">[</span><span class="entity">real_nonneg</span><span class="main">,</span> <span class="entity">real_nonpos</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real_finite</span> <span class="main">=</span> <span class="entity">filter</span> Real.isFinite <span class="entity">real</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_function.ML">
<div class="head">
<h1>File ‹gen_function.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_function.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Random generators for functions.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_FUNCTION</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> function <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.cogen</span> <span class="main">-&gt;</span> 'b <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="keyword1"><span class="keyword">val</span></span> function' <span class="main">:</span> 'b <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>''a <span class="main">-&gt;</span> 'b<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Function</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_FUNCTION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function</span> <span class="entity">cogen</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r1</span><span class="main">,</span> <span class="entity">r2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">SpecCheck_Random.split</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">g</span> <span class="entity">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="entity">cogen</span> <span class="entity">x</span> <span class="entity">gen</span> <span class="entity">r1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">g</span><span class="main">,</span> <span class="entity">r2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">function'</span> <span class="entity">gen</span> <span class="entity">r</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">internal</span><span class="main">,</span> <span class="entity">external</span><span class="main">)</span> <span class="main">=</span> <span class="entity">SpecCheck_Random.split</span> <span class="entity">r</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">seed</span> <span class="main">=</span> Unsynchronized.ref <span class="entity">internal</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">table</span> <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_entry</span> <span class="entity">k</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">new_val</span><span class="main">,</span> <span class="entity">new_seed</span><span class="main">)</span> <span class="main">=</span> <span class="entity">gen</span> <span class="main">(</span>!<span class="entity">seed</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>  <span class="entity">seed</span> := <span class="entity">new_seed</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">table</span> := AList.update <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">new_val</span><span class="main">)</span> <span class="main">(</span>!<span class="entity">table</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">new_val</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">v1</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span>!<span class="entity">table</span><span class="main">)</span> <span class="entity">v1</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">new_entry</span> <span class="entity">v1</span>
      <span class="main">|</span> SOME <span class="entity">v2</span> <span class="main">=&gt;</span> <span class="entity">v2</span><span class="main">,</span> <span class="entity">external</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen_term.ML">
<div class="head">
<h1>File ‹gen_term.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen_term.ML
    Author:     Sebastian Willenbrink and Kevin Kappelmann TU Muenchen

Generators for terms and types.
*)</span>
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_GEN_TERM</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="comment1">(* sort generators *)</span>

  <span class="comment1">(*first parameter determines the number of classes to pick*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> sort <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>class<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
    <span class="main">-&gt;</span> <span class="main">(</span>sort<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="keyword1"><span class="keyword">val</span></span> dummyS <span class="main">:</span> <span class="main">(</span>sort<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

  <span class="comment1">(* name generators *)</span>
  <span class="comment1">(*parameters: a base name and a generator for the number of variants to choose from based on then
    passed base name*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> basic_name <span class="main">:</span> string <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> string <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> indexname <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>indexname<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

  <span class="comment1">(*a variant with base name "k"*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> type_name <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> string <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*creates a free type variable name from a passed basic name generator*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tfree_name <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*chooses a variant with base name "'a"*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tfree_name' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> string <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*creates a type variable name from a passed basic name (e.g. "a") generator*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tvar_name <span class="main">:</span> <span class="main">(</span>indexname<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>indexname<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*chooses a variant with base name "'a"*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tvar_name' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    indexname <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*chooses a variant with base name "c"*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> const_name <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> string <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*chooses a variant with base name "f"*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> free_name <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> string <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*chooses a variant with base name "v*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> var_name <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    indexname <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(* typ  generators *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> tfree <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>sort<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*uses tfree_name' and dummyS to create a free type variable*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tfree' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> tvar <span class="main">:</span> <span class="main">(</span>indexname<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>sort<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*uses tvar' and dummyS to create a type variable*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> tvar' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*atyp tfree_gen tvar_gen (weight_tfree, weight_tvar)*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> atyp <span class="main">:</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int<span class="main">)</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*uses tfree' and tvar' to create an atomic type*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> atyp' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int<span class="main">)</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*type' type_name_gen arity_gen tfree_gen tvar_gen (weight_type, weight_tfree, weight_tvar)*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> type' <span class="main">:</span> string <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    <span class="main">(</span>int * int * int<span class="main">)</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*uses type_name to generate a type*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> type'' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int * int<span class="main">)</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*typ type_gen tfree_gen tvar_gen (wtype, wtfree, wtvar)*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> typ <span class="main">:</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int * int<span class="main">)</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*uses type'' for its type generator*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> typ' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int * int<span class="main">)</span> <span class="main">-&gt;</span>
    typ <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*uses typ' with tfree' and tvar' parameters*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> typ'' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int * int<span class="main">)</span> <span class="main">-&gt;</span> typ <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> dummyT <span class="main">:</span> <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

  <span class="comment1">(* term generators *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> const <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*uses const_name and dummyT to create a constant*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> const' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> term <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> free <span class="main">:</span> <span class="main">(</span>string<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*uses free_name and dummyT to create a free variable*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> free' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> term <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> var <span class="main">:</span> <span class="main">(</span>indexname<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span>
    <span class="main">(</span>typ<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>
  <span class="comment1">(*uses var_name and dummyT to create a variable*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> var' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    term <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="keyword1"><span class="keyword">val</span></span> bound <span class="main">:</span> <span class="main">(</span>int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span> <span class="main">-&gt;</span> <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

  <span class="comment1">(*aterm const_gen free_gen var_gen bound_gen
    (weight_const, weight_free, weight_var, weight_bound*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> aterm <span class="main">:</span> term <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> term <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    term <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> term <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> <span class="main">(</span>int * int * int * int<span class="main">)</span> <span class="main">-&gt;</span>
    term <span class="entity">SpecCheck_Gen_Types.gen</span>
  <span class="comment1">(*uses const', free', and var' to create an atomic term*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> aterm' <span class="main">:</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span> int <span class="entity">SpecCheck_Gen_Types.gen</span> <span class="main">-&gt;</span>
    <span class="main">(</span>int * int * int * int<span class="main">)</span> <span class="main">-&gt;</span> term <span class="entity">SpecCheck_Gen_Types.gen</span>

  <span class="comment1">(*term_tree f init_state - where "f height index state" returns "((term, num_args), new_state)" -
    generates a term by applying f to every node and expanding that node depending
    on num_args returned by f.
    Traversal order: function → first argument → ... → last argument
    The tree is returned in its applicative term form: (...((root $ child1) $ child2) .. $ childn).

    Arguments of f:
    - height describes the distance from the root (starts at 0)
    - index describes the global index in that tree layer, left to right (0 ≤ index &lt; width)
    - state is passed along according to above traversal order

    Return value of f:
    - term is the term whose arguments will be generated next.
    - num_args specifies how many arguments should be passed to the term.
    - new_state is passed along according to the traversal above.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> term_tree <span class="main">:</span> <span class="main">(</span>int <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="main">(</span>term * int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span><span class="main">)</span> <span class="main">-&gt;</span>
    <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

  <span class="comment1">(*In contrast to term_tree, f now takes a (term, index_of_argument) list which specifies the path
    from the root to the current node.*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> term_tree_path <span class="main">:</span> <span class="main">(</span><span class="main">(</span>term * int<span class="main">)</span> list <span class="main">-&gt;</span> <span class="main">(</span>term * int<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span><span class="main">)</span> <span class="main">-&gt;</span>
    <span class="main">(</span>term<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Gen_Types.gen_state</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Gen_Term</span> <span class="main">:</span> <span class="entity">SPECCHECK_GEN_TERM</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Gen</span> <span class="main">=</span> SpecCheck_Gen_Base

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sort</span> <span class="entity">size_gen</span> <span class="main">=</span> <span class="entity">Gen.list</span> <span class="entity">size_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dummyS</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">Gen.return</span> Term.dummyS <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">basic_name</span> <span class="entity">name</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">num_variants_gen</span>
  #&gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="entity">name</span> ^ <span class="inner_quoted">"_"</span> ^ string_of_int <span class="entity">i</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">indexname</span> <span class="entity">basic_name_gen</span> <span class="main">=</span> <span class="entity">Gen.zip</span> <span class="entity">basic_name_gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">type_name</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">basic_name</span> <span class="inner_quoted">"k"</span> <span class="entity">num_variants_gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tfree_name</span> <span class="entity">basic_name_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span>^<span class="inner_quoted">"'"</span><span class="main">)</span> <span class="entity">basic_name_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tfree_name'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">tfree_name</span> <span class="main">(</span><span class="entity">basic_name</span> <span class="inner_quoted">"a"</span> <span class="entity">num_variants_gen</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tvar_name</span> <span class="entity">indexname_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span>^<span class="inner_quoted">"'"</span> |&gt; apfst<span class="main">)</span> <span class="entity">indexname_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tvar_name'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">tvar_name</span> o <span class="entity">indexname</span> <span class="main">(</span><span class="entity">basic_name</span> <span class="inner_quoted">"a"</span> <span class="entity">num_variants_gen</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">const_name</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">basic_name</span> <span class="inner_quoted">"c"</span> <span class="entity">num_variants_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">free_name</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">basic_name</span> <span class="inner_quoted">"v"</span> <span class="entity">num_variants_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var_name</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">indexname</span> <span class="main">(</span><span class="entity">free_name</span> <span class="entity">num_variants_gen</span><span class="main">)</span>

<span class="comment1">(* types *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tfree</span> <span class="entity">name_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> TFree o <span class="entity">Gen.zip</span> <span class="entity">name_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tfree'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">tfree_name'</span> <span class="entity">num_variants_gen</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name_gen</span> <span class="main">=&gt;</span> <span class="entity">tfree</span> <span class="entity">name_gen</span> <span class="entity">dummyS</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tvar</span> <span class="entity">idx_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> TVar o <span class="entity">Gen.zip</span> <span class="entity">idx_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tvar'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">tvar_name'</span> <span class="entity">num_variants_gen</span>
  #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name_gen</span> <span class="main">=&gt;</span> <span class="entity">tvar</span> <span class="entity">name_gen</span> <span class="entity">dummyS</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">atyp</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="main">(</span><span class="entity">wtfree</span><span class="main">,</span> <span class="entity">wtvar</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Gen.one_ofWL</span> <span class="main">[</span><span class="main">(</span><span class="entity">wtfree</span><span class="main">,</span> <span class="entity">tfree_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wtvar</span><span class="main">,</span> <span class="entity">tvar_gen</span><span class="main">)</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">atyp'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">atyp</span> <span class="main">(</span><span class="entity">tfree'</span> <span class="entity">num_variants_gen</span><span class="main">)</span> o <span class="entity">tvar'</span> <span class="entity">num_variants_gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">type'</span> <span class="entity">type_name_gen</span> <span class="entity">arity_gen</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="main">(</span><span class="entity">weights</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">wtype</span><span class="main">,</span> <span class="entity">wtfree</span><span class="main">,</span> <span class="entity">wtvar</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="comment1">(*eta-abstract to avoid strict evaluation, causing an infinite loop*)</span>
  <span class="main">[</span><span class="main">(</span><span class="entity">wtype</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">type'</span> <span class="entity">type_name_gen</span> <span class="entity">arity_gen</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="entity">weights</span> <span class="entity">r</span><span class="main">)</span><span class="main">,</span>
   <span class="main">(</span><span class="entity">wtfree</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">tfree_gen</span> <span class="entity">r</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wtvar</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">tvar_gen</span> <span class="entity">r</span><span class="main">)</span><span class="main">]</span>
  |&gt; <span class="entity">Gen.one_ofWL</span>
  |&gt; <span class="entity">Gen.list</span> <span class="entity">arity_gen</span>
  |&gt; <span class="entity">Gen.zip</span> <span class="entity">type_name_gen</span>
  |&gt; <span class="entity">Gen.map</span> Type

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">type''</span> <span class="entity">num_variants_gen</span> <span class="main">=</span> <span class="entity">type_name</span> <span class="entity">num_variants_gen</span> |&gt; <span class="entity">type'</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ</span> <span class="entity">type_gen</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="main">(</span><span class="entity">wtype</span><span class="main">,</span> <span class="entity">wtfree</span><span class="main">,</span> <span class="entity">wtvar</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Gen.one_ofWL</span> <span class="main">[</span><span class="main">(</span><span class="entity">wtype</span><span class="main">,</span> <span class="entity">type_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wtfree</span><span class="main">,</span> <span class="entity">tfree_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wtvar</span><span class="main">,</span> <span class="entity">tvar_gen</span><span class="main">)</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ'</span> <span class="entity">num_variants_gen</span> <span class="entity">arity_gen</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="entity">weights</span> <span class="main">=</span>
  <span class="entity">typ</span> <span class="main">(</span><span class="entity">type''</span> <span class="entity">num_variants_gen</span> <span class="entity">arity_gen</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="entity">weights</span><span class="main">)</span> <span class="entity">tfree_gen</span> <span class="entity">tvar_gen</span> <span class="entity">weights</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">typ''</span> <span class="entity">num_variants_gen</span> <span class="entity">arity_gen</span> <span class="main">=</span>
  <span class="entity">typ'</span> <span class="entity">num_variants_gen</span> <span class="entity">arity_gen</span> <span class="main">(</span><span class="entity">tfree'</span> <span class="entity">num_variants_gen</span><span class="main">)</span> o <span class="entity">tvar'</span> <span class="entity">num_variants_gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dummyT</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">Gen.return</span> Term.dummyT <span class="entity">s</span>

<span class="comment1">(* terms *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">const</span> <span class="entity">name_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> Const o <span class="entity">Gen.zip</span> <span class="entity">name_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">const'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">const_name</span> <span class="entity">num_variants_gen</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name_gen</span> <span class="main">=&gt;</span> <span class="entity">const</span> <span class="entity">name_gen</span> <span class="entity">dummyT</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">free</span> <span class="entity">name_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> Free o <span class="entity">Gen.zip</span> <span class="entity">name_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">free'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">free_name</span> <span class="entity">num_variants_gen</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name_gen</span> <span class="main">=&gt;</span> <span class="entity">free</span> <span class="entity">name_gen</span> <span class="entity">dummyT</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var</span> <span class="entity">idx_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> Var o <span class="entity">Gen.zip</span> <span class="entity">idx_gen</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var'</span> <span class="entity">num_variants_gen</span> <span class="main">=</span>
  <span class="entity">var_name</span> <span class="entity">num_variants_gen</span>
  #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">name_gen</span> <span class="main">=&gt;</span> <span class="entity">var</span> <span class="entity">name_gen</span> <span class="entity">dummyT</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bound</span> <span class="entity">int_gen</span> <span class="main">=</span> <span class="entity">Gen.map</span> Bound <span class="entity">int_gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aterm</span> <span class="entity">const_gen</span> <span class="entity">free_gen</span> <span class="entity">var_gen</span> <span class="entity">bound_gen</span> <span class="main">(</span><span class="entity">wconst</span><span class="main">,</span> <span class="entity">wfree</span><span class="main">,</span> <span class="entity">wvar</span><span class="main">,</span> <span class="entity">wbound</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">Gen.one_ofWL</span> <span class="main">[</span><span class="main">(</span><span class="entity">wconst</span><span class="main">,</span> <span class="entity">const_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wfree</span><span class="main">,</span> <span class="entity">free_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wvar</span><span class="main">,</span> <span class="entity">var_gen</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">wbound</span><span class="main">,</span> <span class="entity">bound_gen</span><span class="main">)</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aterm'</span> <span class="entity">num_variants_gen</span> <span class="entity">index_gen</span> <span class="main">=</span>
  <span class="entity">aterm</span> <span class="main">(</span><span class="entity">const'</span> <span class="entity">num_variants_gen</span><span class="main">)</span> <span class="main">(</span><span class="entity">free'</span> <span class="entity">num_variants_gen</span><span class="main">)</span> <span class="main">(</span><span class="entity">var'</span> <span class="entity">num_variants_gen</span> <span class="entity">index_gen</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">bound</span> <span class="entity">num_variants_gen</span><span class="main">)</span>

<span class="comment1">(*nth_map has no default*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nth_map_default</span> <span class="inner_numeral">0</span> <span class="entity">f</span> <span class="main">_</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> :: <span class="entity">xs</span>
  <span class="main">|</span> <span class="entity">nth_map_default</span> <span class="inner_numeral">0</span> <span class="entity">f</span> <span class="entity">d</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="entity">f</span> <span class="entity">d</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">nth_map_default</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">d</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> replicate <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">d</span> @ <span class="main">[</span><span class="entity">f</span> <span class="entity">d</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">nth_map_default</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">d</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">x</span> :: <span class="entity">nth_map_default</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">f</span> <span class="entity">d</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_tree</span> <span class="entity">term_gen</span> <span class="entity">state</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nth_incr</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">nth_map_default</span> <span class="entity">n</span> <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span>+ <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">~1</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_tree</span> <span class="entity">indices</span> <span class="entity">height</span> <span class="entity">state</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(*indices stores the number of nodes visited so far at each height*)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">indices</span> <span class="main">=</span> <span class="entity">nth_incr</span> <span class="entity">height</span> <span class="entity">indices</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">index</span> <span class="main">=</span> nth <span class="entity">indices</span> <span class="entity">height</span>
        <span class="comment1">(*generate the term for the current node*)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="entity">num_args</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span> <span class="entity">term_gen</span> <span class="entity">height</span> <span class="entity">index</span> <span class="entity">state</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_child</span> <span class="main">(</span><span class="entity">children</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">build_tree</span> <span class="entity">indices</span> <span class="main">(</span><span class="entity">height</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">state</span>
          |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">child</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">child</span> :: <span class="entity">children</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span><span class="main">)</span>
        <span class="comment1">(*generate the subtrees for each argument*)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">children</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span>K <span class="entity">build_child</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">num_args</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Term.list_comb <span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="main">(</span>rev <span class="entity">children</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">indices</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">build_tree</span> <span class="main">[</span><span class="main">]</span> <span class="inner_numeral">0</span> <span class="entity">state</span>
    |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term_tree_path</span> <span class="entity">f</span> <span class="entity">init_state</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_tree</span> <span class="entity">path</span> <span class="entity">state</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="entity">num_args</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">path</span> <span class="entity">state</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_children</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">args</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">build_tree</span> <span class="main">(</span><span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> :: <span class="entity">path</span><span class="main">)</span> <span class="entity">state</span>
          |&gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> :: <span class="entity">args</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">children</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span> fold <span class="entity">build_children</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="entity">num_args</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>Term.list_comb <span class="main">(</span><span class="entity">term</span><span class="main">,</span> <span class="main">(</span>rev <span class="entity">children</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">build_tree</span> <span class="main">[</span><span class="main">]</span> <span class="entity">init_state</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/gen.ML">
<div class="head">
<h1>File ‹gen.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/generators/gen.ML
    Author:     Kevin Kappelmann, TU Muenchen

Structure containing all generators.
*)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Generator</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Types
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Base
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Text
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Real
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Int
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Function
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Gen_Term
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck_Show">
<div class="head">
<h1>Theory SpecCheck_Show</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Show›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Show
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/Pure/Pure/Pure.html">Pure</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show functions (pretty-printers) for SpecCheck take a value and return a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">ML_type</span></span> Pretty.T<span class="antiquote"><span class="antiquote">}</span></span></span></span>
representation of the value. Refer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> "show_base.ML"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for some basic examples.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹show_types.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹show_base.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹show.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/show_types.ML">
<div class="head">
<h1>File ‹show_types.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/show/show_types.ML
    Author:     Kevin Kappelmann

Shared type definitions for SpecCheck showable types.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_SHOW_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">show</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> Pretty.T
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Show_Types</span> <span class="main">:</span> <span class="entity">SPECCHECK_SHOW_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">show</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> Pretty.T

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/show_base.ML">
<div class="head">
<h1>File ‹show_base.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/show/show_base.ML
    Author:     Kevin Kappelmann

Basic utility functions to create and combine show functions.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_SHOW_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">SPECCHECK_SHOW_TYPES</span>

  <span class="keyword1"><span class="keyword">val</span></span> none <span class="main">:</span> 'a <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> char <span class="main">:</span> char <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> string <span class="main">:</span> string <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> int <span class="main">:</span> int <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> real <span class="main">:</span> real <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> bool <span class="main">:</span> bool <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> list <span class="main">:</span> 'a <span class="entity">show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a list<span class="main">)</span> <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> option <span class="main">:</span> 'a <span class="entity">show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a option<span class="main">)</span> <span class="entity">show</span>

  <span class="keyword1"><span class="keyword">val</span></span> zip <span class="main">:</span> 'a <span class="entity">show</span> <span class="main">-&gt;</span> 'b <span class="entity">show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> zip3 <span class="main">:</span> 'a <span class="entity">show</span> <span class="main">-&gt;</span> 'b <span class="entity">show</span> <span class="main">-&gt;</span> 'c <span class="entity">show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b * 'c<span class="main">)</span> <span class="entity">show</span>
  <span class="keyword1"><span class="keyword">val</span></span> zip4 <span class="main">:</span> 'a <span class="entity">show</span> <span class="main">-&gt;</span> 'b <span class="entity">show</span> <span class="main">-&gt;</span> 'c <span class="entity">show</span> <span class="main">-&gt;</span> 'd <span class="entity">show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b * 'c * 'd<span class="main">)</span> <span class="entity">show</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Show_Base</span> <span class="main">:</span> <span class="entity">SPECCHECK_SHOW_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Show_Types

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">none</span> <span class="main">_</span> <span class="main">=</span> Pretty.str <span class="inner_quoted">"&lt;NO_SHOW&gt;"</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">char</span> <span class="main">=</span> Pretty.enclose <span class="inner_quoted">"'"</span> <span class="inner_quoted">"'"</span> o single o Pretty.str o Char.toString
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">string</span> <span class="main">=</span> Pretty.quote o Pretty.str
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">int</span> <span class="main">=</span> Pretty.str o string_of_int
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">real</span> <span class="main">=</span> Pretty.str o string_of_real
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bool</span> <span class="entity">b</span> <span class="main">=</span> Pretty.str <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"true"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"false"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list</span> <span class="entity">show</span> <span class="main">=</span> Pretty.list <span class="inner_quoted">"["</span> <span class="inner_quoted">"]"</span> o map <span class="entity">show</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">option</span> <span class="main">_</span> NONE <span class="main">=</span> Pretty.str <span class="inner_quoted">"NONE"</span>
  <span class="main">|</span> <span class="entity">option</span> <span class="entity">show</span> <span class="main">(</span>SOME <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> Pretty.block <span class="main">[</span>Pretty.str <span class="inner_quoted">"SOME "</span><span class="main">,</span> <span class="entity">show</span> <span class="entity">v</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_tuple</span> <span class="entity">ps</span> <span class="main">=</span> <span class="entity">ps</span> |&gt; Pretty.commas |&gt; Pretty.enclose <span class="inner_quoted">"("</span> <span class="inner_quoted">")"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip</span> <span class="entity">showA</span> <span class="entity">showB</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pretty_tuple</span> <span class="main">[</span><span class="entity">showA</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">showB</span> <span class="entity">b</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip3</span> <span class="entity">showA</span> <span class="entity">showB</span> <span class="entity">showC</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pretty_tuple</span> <span class="main">[</span><span class="entity">showA</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">showB</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">showC</span> <span class="entity">c</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip4</span> <span class="entity">showA</span> <span class="entity">showB</span> <span class="entity">showC</span> <span class="entity">showD</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pretty_tuple</span> <span class="main">[</span><span class="entity">showA</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">showB</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">showC</span> <span class="entity">c</span><span class="main">,</span> <span class="entity">showD</span> <span class="entity">d</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/show.ML">
<div class="head">
<h1>File ‹show.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/show/show.ML
    Author:     Kevin Kappelmann, TU Muenchen

Structure containing all show functions.
*)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Show</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Show_Base
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck_Output_Style">
<div class="head">
<h1>Theory SpecCheck_Output_Style</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Output Styles›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Output_Style
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#SpecCheck_Base">SpecCheck_Base</a>
  <a href="#SpecCheck_Show">SpecCheck_Show</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Output styles for SpecCheck take the result of a test run and process it accordingly,
e.g. by printing it or storing it to a file.›</span></span>


<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹output_style_types.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹output_style_perl.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹output_style_custom.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹output_style.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/output_style_types.ML">
<div class="head">
<h1>File ‹output_style_types.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/output_styles/output_style_types.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Shared types for SpecCheck output styles.
*)</span>
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_OUTPUT_STYLE_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">output_style</span> <span class="main">=</span> 'a <span class="entity">SpecCheck_Show.show</span> option <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span>
    Timing.timing <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Base.result</span> <span class="main">-&gt;</span> unit
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Output_Style_Types</span> <span class="main">:</span> <span class="entity">SPECCHECK_OUTPUT_STYLE_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">output_style</span> <span class="main">=</span> 'a <span class="entity">SpecCheck_Show.show</span> option <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> Timing.timing <span class="main">-&gt;</span>
  'a <span class="entity">SpecCheck_Base.result</span> <span class="main">-&gt;</span> unit

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_OUTPUT_STYLE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> style <span class="main">:</span> 'a <span class="entity">SpecCheck_Output_Style_Types.output_style</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/output_style_perl.ML">
<div class="head">
<h1>File ‹output_style_perl.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/output_styles/output_style_perl.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Perl output styles for SpecCheck.
*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Output_Style_Perl</span> <span class="main">:</span> <span class="entity">SPECCHECK_OUTPUT_STYLE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Configuration
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Base

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">style</span> <span class="entity">show_opt</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">timing</span> <span class="entity">result</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort_counterexamples</span> <span class="main">=</span>  Config.get <span class="entity">ctxt</span> <span class="entity">sort_counterexamples</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">maybe_sort</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">sort_counterexamples</span> <span class="keyword2"><span class="keyword">then</span></span> sort <span class="main">(</span>int_ord o apply2 size<span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> I

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stats</span> <span class="main">=</span> <span class="entity">stats_of_result</span> <span class="entity">result</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_failed_tests</span> <span class="main">=</span> <span class="main">#</span>num_failed_tests <span class="entity">stats</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">code</span> <span class="main">(</span><span class="entity">Success</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"ok"</span>
      <span class="main">|</span> <span class="entity">code</span> <span class="main">(</span><span class="entity">Gave_Up</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"Gave up!"</span>
      <span class="main">|</span> <span class="entity">code</span> <span class="main">(</span><span class="entity">Failure</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"FAILED"</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ratio</span> <span class="entity">stats</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_success_tests</span> <span class="main">=</span> <span class="main">#</span>num_success_tests <span class="entity">stats</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">num_failed_tests</span> <span class="main">=</span> <span class="inner_numeral">0</span>
        <span class="keyword2"><span class="keyword">then</span></span> implode <span class="main">[</span><span class="inner_quoted">"("</span><span class="main">,</span> string_of_int <span class="entity">num_success_tests</span><span class="main">,</span> <span class="inner_quoted">" passed)"</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">else</span></span> implode <span class="main">[</span><span class="inner_quoted">"("</span><span class="main">,</span> string_of_int <span class="entity">num_success_tests</span><span class="main">,</span> <span class="inner_quoted">"/"</span><span class="main">,</span>
          string_of_int <span class="main">(</span><span class="entity">num_success_tests</span> + <span class="entity">num_failed_tests</span><span class="main">)</span><span class="main">,</span>  <span class="inner_quoted">" passed)"</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result_string</span> <span class="main">=</span> <span class="entity">name</span> ^ <span class="inner_quoted">".\n"</span> ^ <span class="entity">code</span> <span class="entity">result</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">ratio</span> <span class="entity">stats</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">show_counterexamples</span> <span class="entity">counterexamples</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">show_opt</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">show</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">maybe_sort</span> <span class="main">(</span>map <span class="main">(</span>Pretty.string_of o <span class="entity">show</span><span class="main">)</span> <span class="entity">counterexamples</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">es</span> <span class="main">=&gt;</span> <span class="main">(</span>warning <span class="inner_quoted">"Counterexamples:"</span><span class="main">;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> warning <span class="entity">x</span><span class="main">)</span> <span class="entity">es</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>

  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">Success</span> <span class="main">_</span> <span class="main">=&gt;</span> writeln <span class="entity">result_string</span>
    <span class="main">|</span> <span class="entity">Gave_Up</span> <span class="main">_</span> <span class="main">=&gt;</span> warning <span class="entity">result_string</span>
    <span class="main">|</span> <span class="entity">Failure</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">failure_data</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span>warning <span class="entity">result_string</span><span class="main">;</span> <span class="entity">show_counterexamples</span> <span class="main">(</span><span class="main">#</span>counterexamples <span class="entity">failure_data</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/output_style_custom.ML">
<div class="head">
<h1>File ‹output_style_custom.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/output_style/output_style_custom.ML
    Author:     Lukas Bulwahn, Nicolai Schaffroth, Kevin Kappelmann TU Muenchen
    Author:     Christopher League

Custom-made, QuickCheck-inspired output style for SpecCheck.
*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Output_Style_Custom</span> <span class="main">:</span> <span class="entity">SPECCHECK_OUTPUT_STYLE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Base

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_success</span> <span class="entity">stats</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_success_tests</span> <span class="main">=</span> string_of_int <span class="main">(</span><span class="main">#</span>num_success_tests <span class="entity">stats</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_discarded_tests</span> <span class="main">=</span> <span class="main">#</span>num_discarded_tests <span class="entity">stats</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">discarded_str</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">num_discarded_tests</span> <span class="main">=</span> <span class="inner_numeral">0</span>
      <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"."</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">";"</span><span class="main">,</span> string_of_int <span class="entity">num_discarded_tests</span><span class="main">,</span>  <span class="inner_quoted">"discarded."</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    implode <span class="main">[</span><span class="inner_quoted">"OK, passed "</span><span class="main">,</span> <span class="entity">num_success_tests</span><span class="main">,</span> <span class="inner_quoted">" tests"</span><span class="main">,</span> <span class="entity">discarded_str</span><span class="main">]</span>
    |&gt; writeln
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_gave_up</span> <span class="entity">stats</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_success_tests</span> <span class="main">=</span> string_of_int <span class="main">(</span><span class="main">#</span>num_success_tests <span class="entity">stats</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_discarded_tests</span> <span class="main">=</span> string_of_int <span class="main">(</span><span class="main">#</span>num_discarded_tests <span class="entity">stats</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">"Gave up! Passed only"</span><span class="main">,</span> <span class="entity">num_success_tests</span><span class="main">,</span> <span class="inner_quoted">"test(s);"</span><span class="main">,</span> <span class="entity">num_discarded_tests</span><span class="main">,</span>
      <span class="inner_quoted">"discarded test(s)."</span><span class="main">]</span>
    |&gt; warning
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_failure_data</span> <span class="entity">ctxt</span> <span class="entity">show_opt</span> <span class="entity">failure_data</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">#</span>the_exception <span class="entity">failure_data</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="entity">exn</span> <span class="main">=&gt;</span>
      cat_lines <span class="main">[</span><span class="inner_quoted">"Exception during test run:"</span><span class="main">,</span> exnMessage <span class="entity">exn</span><span class="main">]</span>
      |&gt; warning
  <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">show_opt</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
    <span class="main">|</span> SOME <span class="entity">show</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sort_counterexamples</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.sort_counterexamples</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">maybe_sort</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">sort_counterexamples</span> <span class="keyword2"><span class="keyword">then</span></span> sort <span class="main">(</span>int_ord o apply2 size<span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> I
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">counterexamples</span> <span class="main">=</span>
          <span class="main">#</span>counterexamples <span class="entity">failure_data</span>
          |&gt; map <span class="main">(</span>Pretty.string_of o <span class="entity">show</span><span class="main">)</span>
          |&gt; <span class="entity">maybe_sort</span>
      <span class="keyword2"><span class="keyword">in</span></span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> warning <span class="entity">x</span><span class="main">)</span> <span class="entity">counterexamples</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_failure</span> <span class="entity">ctxt</span> <span class="entity">show_opt</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="entity">failure_data</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">"Failed! Falsified (after"</span><span class="main">,</span> string_of_int <span class="main">(</span><span class="entity">num_tests</span> <span class="entity">stats</span><span class="main">)</span><span class="main">,</span> <span class="inner_quoted">"test(s) and "</span><span class="main">,</span>
    string_of_int <span class="main">(</span><span class="entity">num_shrinks</span> <span class="entity">stats</span><span class="main">)</span><span class="main">,</span> <span class="inner_quoted">"shrink(s)):"</span><span class="main">]</span> |&gt; warning<span class="main">)</span><span class="main">;</span>
  <span class="entity">print_failure_data</span> <span class="entity">ctxt</span> <span class="entity">show_opt</span> <span class="entity">failure_data</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_stats</span> <span class="entity">ctxt</span> <span class="entity">stats</span> <span class="entity">total_time</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">show_stats</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.show_stats</span>
    <span class="comment1">(*the time spent in the test function in relation to the total time spent;
      the latter includes generating test cases and overhead from the framework*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">show_time</span> <span class="main">{</span><span class="entity">elapsed</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span>
      implode <span class="main">[</span><span class="inner_quoted">"Time: "</span><span class="main">,</span> Time.toString <span class="entity">elapsed</span><span class="main">,</span> <span class="inner_quoted">"s (run) / "</span><span class="main">,</span> Time.toString <span class="main">(</span><span class="main">#</span>elapsed <span class="entity">total_time</span><span class="main">)</span><span class="main">,</span>
        <span class="inner_quoted">"s (total)"</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="entity">show_stats</span>
    <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> writeln <span class="main">(</span><span class="entity">show_time</span> <span class="main">(</span><span class="main">#</span>timing <span class="entity">stats</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">style</span> <span class="entity">show_opt</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">total_time</span> <span class="entity">result</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stats</span> <span class="main">=</span> <span class="entity">stats_of_result</span> <span class="entity">result</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    writeln <span class="main">(</span><span class="entity">SpecCheck_Util.spaces</span> <span class="main">[</span><span class="inner_quoted">"Testing:"</span><span class="main">,</span> <span class="entity">name</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="entity">Success</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">print_success</span> <span class="entity">stats</span>
    <span class="main">|</span> <span class="entity">Gave_Up</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">print_gave_up</span> <span class="entity">stats</span>
    <span class="main">|</span> <span class="entity">Failure</span> <span class="entity">data</span> <span class="main">=&gt;</span> <span class="entity">print_failure</span> <span class="entity">ctxt</span> <span class="entity">show_opt</span> <span class="entity">data</span><span class="main">)</span><span class="main">;</span>
    <span class="entity">print_stats</span> <span class="entity">ctxt</span> <span class="entity">stats</span> <span class="entity">total_time</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/output_style.ML">
<div class="head">
<h1>File ‹output_style.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/output_styles/output_style.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen
    Author:     Christopher League

Output styles for presenting SpecCheck results.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_DEFAULT_OUTPUT_STYLE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">SPECCHECK_OUTPUT_STYLE_TYPES</span>
  <span class="keyword1"><span class="keyword">val</span></span> default <span class="main">:</span> 'a <span class="entity">output_style</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Default_Output_Style</span> <span class="main">:</span> <span class="entity">SPECCHECK_DEFAULT_OUTPUT_STYLE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Output_Style_Types
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default</span> <span class="main">=</span> <span class="entity">SpecCheck_Output_Style_Custom.style</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck_Shrink">
<div class="head">
<h1>Theory SpecCheck_Shrink</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shrinkers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Shrink
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SpecCheck_Generators">SpecCheck_Generators</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Shrinkers for SpecCheck take a value and return a sequence of smaller values derived from it.
Refer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> "shrink_base.ML"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for some basic examples.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹shrink_types.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹shrink_base.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹shrink.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/shrink_types.ML">
<div class="head">
<h1>File ‹shrink_types.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/shrink/shrink_types.ML
    Author:     Kevin Kappelmann

Shared type definitions for SpecCheck shrinkable types.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_SHRINK_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">shrink</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> 'a Seq.seq
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Shrink_Types</span> <span class="main">:</span> <span class="entity">SPECCHECK_SHRINK_TYPES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">shrink</span> <span class="main">=</span> 'a <span class="main">-&gt;</span> 'a Seq.seq

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/shrink_base.ML">
<div class="head">
<h1>File ‹shrink_base.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/shrink/shrink_base.ML
    Author:     Kevin Kappelmann

Basic utility functions to create and combine shrink functions.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_SHRINK_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">include</span></span> <span class="entity">SPECCHECK_SHRINK_TYPES</span>

  <span class="keyword1"><span class="keyword">val</span></span> none <span class="main">:</span> 'a <span class="entity">shrink</span>

  <span class="keyword1"><span class="keyword">val</span></span> product <span class="main">:</span> 'a <span class="entity">shrink</span> <span class="main">-&gt;</span> 'b <span class="entity">shrink</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b<span class="main">)</span> <span class="entity">shrink</span>
  <span class="keyword1"><span class="keyword">val</span></span> product3 <span class="main">:</span> 'a <span class="entity">shrink</span> <span class="main">-&gt;</span> 'b <span class="entity">shrink</span> <span class="main">-&gt;</span> 'c <span class="entity">shrink</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b * 'c<span class="main">)</span> <span class="entity">shrink</span>
  <span class="keyword1"><span class="keyword">val</span></span> product4 <span class="main">:</span> 'a <span class="entity">shrink</span> <span class="main">-&gt;</span> 'b <span class="entity">shrink</span> <span class="main">-&gt;</span> 'c <span class="entity">shrink</span> <span class="main">-&gt;</span> 'd <span class="entity">shrink</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * 'b * 'c * 'd<span class="main">)</span> <span class="entity">shrink</span>

  <span class="keyword1"><span class="keyword">val</span></span> int <span class="main">:</span> int <span class="entity">shrink</span>

  <span class="keyword1"><span class="keyword">val</span></span> list <span class="main">:</span> 'a <span class="entity">shrink</span> <span class="main">-&gt;</span> <span class="main">(</span>'a list <span class="entity">shrink</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> list' <span class="main">:</span> <span class="main">(</span>'a list<span class="main">)</span> <span class="entity">shrink</span>

  <span class="keyword1"><span class="keyword">val</span></span> term <span class="main">:</span> term <span class="entity">shrink</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Shrink_Base</span> <span class="main">:</span> <span class="entity">SPECCHECK_SHRINK_BASE</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Shrink_Types

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">none</span> <span class="main">_</span> <span class="main">=</span> Seq.empty

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">product_seq</span> <span class="entity">xq</span> <span class="entity">yq</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">yqy</span> <span class="main">=</span> Seq.append <span class="entity">yq</span> <span class="main">(</span>Seq.single <span class="entity">y</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">zq1</span> <span class="main">=</span> Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> Seq.map <span class="main">(</span>pair <span class="entity">x</span><span class="main">)</span> <span class="entity">yqy</span><span class="main">)</span> <span class="entity">xq</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">zq2</span> <span class="main">=</span> Seq.map <span class="main">(</span>pair <span class="entity">x</span><span class="main">)</span> <span class="entity">yq</span>
  <span class="keyword2"><span class="keyword">in</span></span> Seq.append <span class="entity">zq1</span> <span class="entity">zq2</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">product</span> <span class="entity">shrinkA</span> <span class="entity">shrinkB</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">product_seq</span> <span class="main">(</span><span class="entity">shrinkA</span> <span class="entity">a</span><span class="main">)</span> <span class="main">(</span><span class="entity">shrinkB</span> <span class="entity">b</span><span class="main">)</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">product3</span> <span class="entity">shrinkA</span> <span class="entity">shrinkB</span> <span class="entity">shrinkC</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">product</span> <span class="entity">shrinkA</span> <span class="entity">shrinkB</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">abq</span> <span class="main">=&gt;</span> <span class="entity">product_seq</span> <span class="entity">abq</span> <span class="main">(</span><span class="entity">shrinkC</span> <span class="entity">c</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">)</span>
  |&gt; Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">product4</span> <span class="entity">shrinkA</span> <span class="entity">shrinkB</span> <span class="entity">shrinkC</span> <span class="entity">shrinkD</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="entity">d</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">product3</span> <span class="entity">shrinkA</span> <span class="entity">shrinkB</span> <span class="entity">shrinkC</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span>
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">abcq</span> <span class="main">=&gt;</span> <span class="entity">product_seq</span> <span class="entity">abcq</span> <span class="main">(</span><span class="entity">shrinkD</span> <span class="entity">d</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span><span class="main">)</span>
  |&gt; Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">c</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span><span class="main">)</span>

<span class="comment1">(*bit-shift right until it hits zero (some special care needs to be taken for negative numbers*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">int</span> <span class="inner_numeral">0</span> <span class="main">=</span> Seq.empty
  <span class="main">|</span> <span class="entity">int</span> <span class="entity">i</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">absi</span> <span class="main">=</span> abs <span class="entity">i</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">signi</span> <span class="main">=</span> Int.sign <span class="entity">i</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq</span> <span class="inner_numeral">0w0</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> NONE
        <span class="main">|</span> <span class="entity">seq</span> <span class="entity">w</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">next_value</span> <span class="main">=</span> <span class="entity">signi</span> * IntInf.~&gt;&gt; <span class="main">(</span><span class="entity">absi</span><span class="main">,</span> <span class="entity">w</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">next_word</span> <span class="main">=</span> Word.- <span class="main">(</span><span class="entity">w</span><span class="main">,</span> <span class="inner_numeral">0w1</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> SOME <span class="main">(</span><span class="entity">next_value</span><span class="main">,</span> Seq.make <span class="main">(</span><span class="entity">seq</span> <span class="entity">next_word</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">w</span> <span class="main">=</span> Word.fromInt <span class="main">(</span>IntInf.log2 <span class="main">(</span>abs <span class="entity">i</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> Seq.cons <span class="inner_numeral">0</span> <span class="main">(</span>Seq.make <span class="main">(</span><span class="entity">seq</span> <span class="entity">w</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list</span> <span class="main">_</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> Seq.single <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">list</span> <span class="entity">elem_shrink</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> Seq.cons <span class="main">[</span><span class="main">]</span> <span class="main">(</span>Seq.map single <span class="main">(</span><span class="entity">elem_shrink</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">list</span> <span class="entity">elem_shrink</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">elems</span> <span class="main">=</span> Seq.append <span class="main">(</span><span class="entity">elem_shrink</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span>Seq.single <span class="entity">x</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">seq</span> <span class="main">=</span> Seq.maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="entity">elems</span><span class="main">)</span> <span class="main">(</span><span class="entity">list</span> <span class="entity">elem_shrink</span> <span class="entity">xs</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> Seq.cons <span class="main">[</span><span class="main">]</span> <span class="entity">seq</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list'</span> <span class="entity">xs</span> <span class="main">=</span> <span class="entity">list</span> <span class="entity">none</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">term</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s1</span> <span class="main">=</span> Seq.append <span class="main">(</span><span class="entity">term</span> <span class="entity">t1</span><span class="main">)</span> <span class="main">(</span>Seq.single <span class="entity">t1</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s2</span> <span class="main">=</span> Seq.append <span class="main">(</span><span class="entity">term</span> <span class="entity">t2</span><span class="main">)</span> <span class="main">(</span>Seq.single <span class="entity">t2</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s3</span> <span class="main">=</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span>$<span class="main">)</span> <span class="main">(</span><span class="entity">product</span> <span class="entity">term</span> <span class="entity">term</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> Seq.append <span class="entity">s1</span> <span class="main">(</span>Seq.append <span class="entity">s2</span> <span class="entity">s3</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">term</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s1</span> <span class="main">=</span> Seq.append <span class="main">(</span><span class="entity">term</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span>Seq.single <span class="entity">t</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s2</span> <span class="main">=</span> Seq.map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">term</span> <span class="entity">t</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> Seq.append <span class="entity">s1</span> <span class="entity">s2</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">term</span> <span class="main">_</span> <span class="main">=</span> Seq.empty

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/shrink.ML">
<div class="head">
<h1>File ‹shrink.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/shrink/shrink.ML
    Author:     Kevin Kappelmann, TU Muenchen

Structure containing all shrink functions.
*)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Shrink</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Shrink_Base

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck">
<div class="head">
<h1>Theory SpecCheck</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SpecCheck›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#SpecCheck_Generators">SpecCheck_Generators</a>
  <a href="#SpecCheck_Show">SpecCheck_Show</a>
  <a href="#SpecCheck_Shrink">SpecCheck_Shrink</a>
  <a href="#SpecCheck_Output_Style">SpecCheck_Output_Style</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The SpecCheck (specification based) testing environment and Lecker testing framework.›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹speccheck.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹lecker.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/speccheck.ML">
<div class="head">
<h1>File ‹speccheck.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/speccheck.ML
    Author:     Lukas Bulwahn, Nicolai Schaffroth, and Kevin Kappelmann TU Muenchen
    Author:     Christopher League

Specification-based testing of ML programs.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

  <span class="comment1">(*tries to shrink a given (failing) input to a smaller, failing input*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> try_shrink <span class="main">:</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Shrink.shrink</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> int <span class="main">-&gt;</span>
    <span class="entity">SpecCheck_Base.stats</span> <span class="main">-&gt;</span> <span class="main">(</span>'a * <span class="entity">SpecCheck_Base.stats</span><span class="main">)</span>

  <span class="comment1">(*runs a property for a given test case and returns the result and the updated the statistics*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> run_a_test <span class="main">:</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> 'a <span class="main">-&gt;</span> <span class="entity">SpecCheck_Base.stats</span> <span class="main">-&gt;</span>
    <span class="entity">SpecCheck_Base.result_single</span> * <span class="entity">SpecCheck_Base.stats</span>

  <span class="comment1">(*returns the new state after executing the test*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> check_style <span class="main">:</span> 'a <span class="entity">SpecCheck_Output_Style_Types.output_style</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a <span class="entity">SpecCheck_Show.show</span><span class="main">)</span> option <span class="main">-&gt;</span>  'a <span class="entity">SpecCheck_Shrink.shrink</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Generator.gen_state</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> 's
  <span class="keyword1"><span class="keyword">val</span></span> check_shrink <span class="main">:</span> 'a <span class="entity">SpecCheck_Show.show</span> <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Shrink.shrink</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Generator.gen_state</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> 's
  <span class="keyword1"><span class="keyword">val</span></span> check <span class="main">:</span> 'a <span class="entity">SpecCheck_Show.show</span> <span class="main">-&gt;</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Generator.gen_state</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span>
    'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> 's
  <span class="keyword1"><span class="keyword">val</span></span> check_base <span class="main">:</span> <span class="main">(</span>'a<span class="main">,</span> 's<span class="main">)</span> <span class="entity">SpecCheck_Generator.gen_state</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span>
    'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> 's

  <span class="comment1">(*returns all unprocessed elements of the sequence*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> check_seq_style <span class="main">:</span> 'a <span class="entity">SpecCheck_Output_Style_Types.output_style</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a <span class="entity">SpecCheck_Show.show</span><span class="main">)</span> option <span class="main">-&gt;</span> 'a Seq.seq <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 'a Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> check_seq <span class="main">:</span> 'a <span class="entity">SpecCheck_Show.show</span> <span class="main">-&gt;</span> 'a Seq.seq <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 'a Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> check_seq_base <span class="main">:</span> 'a Seq.seq <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span>
    'a Seq.seq

  <span class="comment1">(*returns all unused elements of the list*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> check_list_style <span class="main">:</span> 'a <span class="entity">SpecCheck_Output_Style_Types.output_style</span> <span class="main">-&gt;</span>
    <span class="main">(</span>'a <span class="entity">SpecCheck_Show.show</span><span class="main">)</span> option <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 'a Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> check_list <span class="main">:</span> 'a <span class="entity">SpecCheck_Show.show</span> <span class="main">-&gt;</span> 'a list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> 'a Seq.seq
  <span class="keyword1"><span class="keyword">val</span></span> check_list_base <span class="main">:</span> 'a list <span class="main">-&gt;</span> string <span class="main">-&gt;</span> 'a <span class="entity">SpecCheck_Property.prop</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span>
    'a Seq.seq

<span class="keyword2"><span class="keyword">end</span></span>
                                                                   
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck</span> <span class="main">:</span> <span class="entity">SPECCHECK</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Base

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">run_a_test</span> <span class="entity">prop</span> <span class="entity">input</span> <span class="main">{</span>
    <span class="entity">num_success_tests</span><span class="main">,</span>
    <span class="entity">num_failed_tests</span><span class="main">,</span>
    <span class="entity">num_discarded_tests</span><span class="main">,</span>
    <span class="entity">num_recently_discarded_tests</span><span class="main">,</span>
    <span class="entity">num_success_shrinks</span><span class="main">,</span>
    <span class="entity">num_failed_shrinks</span><span class="main">,</span>
    <span class="entity">timing</span>
  <span class="main">}</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">time</span><span class="main">,</span> <span class="entity">result</span><span class="main">)</span> <span class="main">=</span> Timing.timing <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">prop</span> <span class="entity">input</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_success</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Result</span> <span class="entity">is_success</span> <span class="main">=&gt;</span> <span class="entity">is_success</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_discard</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Discard</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_failure</span> <span class="main">=</span> not <span class="entity">is_discard</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="entity">is_success</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_success_tests</span> <span class="main">=</span> <span class="entity">num_success_tests</span> + <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_success</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_failed_tests</span> <span class="main">=</span> <span class="entity">num_failed_tests</span> + <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_failure</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_discarded_tests</span> <span class="main">=</span> <span class="entity">num_discarded_tests</span> + <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_discard</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_recently_discarded_tests</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_discard</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">num_recently_discarded_tests</span> + <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timing</span> <span class="main">=</span> <span class="entity">add_timing</span> <span class="entity">timing</span> <span class="entity">time</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stats</span> <span class="main">=</span> <span class="main">{</span>
      num_success_tests <span class="main">=</span> <span class="entity">num_success_tests</span><span class="main">,</span>
      num_failed_tests <span class="main">=</span> <span class="entity">num_failed_tests</span><span class="main">,</span>
      num_discarded_tests <span class="main">=</span> <span class="entity">num_discarded_tests</span><span class="main">,</span>
      num_recently_discarded_tests <span class="main">=</span> <span class="entity">num_recently_discarded_tests</span><span class="main">,</span>
      num_success_shrinks <span class="main">=</span> <span class="entity">num_success_shrinks</span><span class="main">,</span>
      num_failed_shrinks <span class="main">=</span> <span class="entity">num_failed_shrinks</span><span class="main">,</span>
      timing <span class="main">=</span> <span class="entity">timing</span>
    <span class="main">}</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">result</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_num_success_shrinks</span> <span class="entity">stats</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">{</span>
  num_success_tests <span class="main">=</span> <span class="main">#</span>num_success_tests <span class="entity">stats</span><span class="main">,</span>
  num_failed_tests <span class="main">=</span> <span class="main">#</span>num_failed_tests <span class="entity">stats</span><span class="main">,</span>
  num_discarded_tests <span class="main">=</span> <span class="main">#</span>num_discarded_tests <span class="entity">stats</span><span class="main">,</span>
  num_recently_discarded_tests <span class="main">=</span> <span class="main">#</span>num_recently_discarded_tests <span class="entity">stats</span><span class="main">,</span>
  num_success_shrinks <span class="main">=</span> <span class="main">#</span>num_success_shrinks <span class="entity">stats</span> + <span class="entity">n</span><span class="main">,</span>
  num_failed_shrinks <span class="main">=</span> <span class="main">#</span>num_failed_shrinks <span class="entity">stats</span><span class="main">,</span>
  timing <span class="main">=</span> <span class="main">#</span>timing <span class="entity">stats</span>
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_num_failed_shrinks</span> <span class="entity">stats</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">{</span>
  num_success_tests <span class="main">=</span> <span class="main">#</span>num_success_tests <span class="entity">stats</span><span class="main">,</span>
  num_failed_tests <span class="main">=</span> <span class="main">#</span>num_failed_tests <span class="entity">stats</span><span class="main">,</span>
  num_discarded_tests <span class="main">=</span> <span class="main">#</span>num_discarded_tests <span class="entity">stats</span><span class="main">,</span>
  num_recently_discarded_tests <span class="main">=</span> <span class="main">#</span>num_recently_discarded_tests <span class="entity">stats</span><span class="main">,</span>
  num_success_shrinks <span class="main">=</span> <span class="main">#</span>num_success_shrinks <span class="entity">stats</span><span class="main">,</span>
  num_failed_shrinks <span class="main">=</span> <span class="main">#</span>num_failed_shrinks <span class="entity">stats</span> + <span class="entity">n</span><span class="main">,</span>
  timing <span class="main">=</span> <span class="main">#</span>timing <span class="entity">stats</span>
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_shrink</span> <span class="entity">prop</span> <span class="entity">shrink</span> <span class="entity">input</span> <span class="entity">max_shrinks</span> <span class="entity">stats</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_failure</span> <span class="entity">input</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">run_a_test</span> <span class="entity">prop</span> <span class="entity">input</span> <span class="entity">empty_stats</span> |&gt; fst <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">Result</span> <span class="entity">is_success</span> <span class="main">=&gt;</span> not <span class="entity">is_success</span>
      <span class="main">|</span> <span class="entity">Discard</span> <span class="main">=&gt;</span> false
      <span class="main">|</span> <span class="entity">Exception</span> <span class="main">_</span> <span class="main">=&gt;</span> false <span class="comment1">(*do not count exceptions as a failure because the shrinker might
                               just have broken some invariant of the function*)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_first_failure</span> <span class="entity">xq</span> <span class="entity">pulls_left</span> <span class="entity">stats</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">pulls_left</span> &lt;= <span class="inner_numeral">0</span>
      <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">pulls_left</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">xq</span> <span class="keyword2"><span class="keyword">of</span></span>
          NONE <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">pulls_left</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span>
        <span class="main">|</span> SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xq</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_failure</span> <span class="entity">x</span>
          <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>SOME <span class="entity">x</span><span class="main">,</span> <span class="entity">pulls_left</span> - <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">add_num_success_shrinks</span> <span class="entity">stats</span> <span class="inner_numeral">1</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">find_first_failure</span> <span class="entity">xq</span> <span class="main">(</span><span class="entity">pulls_left</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">add_num_failed_shrinks</span> <span class="entity">stats</span> <span class="inner_numeral">1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="comment1">(*always try the first successful branch and abort without backtracking once no further
      shrink is possible.*)</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">find_first_failure</span> <span class="main">(</span><span class="entity">shrink</span> <span class="entity">input</span><span class="main">)</span> <span class="entity">max_shrinks</span> <span class="entity">stats</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="comment1">(*recursively shrink*)</span>
      <span class="main">(</span>SOME <span class="entity">input</span><span class="main">,</span> <span class="entity">shrinks_left</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">try_shrink</span> <span class="entity">prop</span> <span class="entity">shrink</span> <span class="entity">input</span> <span class="entity">shrinks_left</span> <span class="entity">stats</span>
    <span class="main">|</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">input</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">test</span> <span class="entity">output_style</span> <span class="entity">init_stats</span> <span class="entity">show_opt</span> <span class="entity">shrink</span> <span class="entity">opt_gen</span> <span class="entity">name</span> <span class="entity">prop</span> <span class="entity">ctxt</span> <span class="entity">state</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_discard_ratio</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.max_discard_ratio</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_success</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.max_success</span>
    <span class="comment1">(*number of counterexamples to generate before stopping the test*)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_counterexamples</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conf_num_counterexamples</span> <span class="main">=</span>
        Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.num_counterexamples</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">conf_num_counterexamples</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">conf_num_counterexamples</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">~1</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_shrinks</span> <span class="main">=</span> Config.get <span class="entity">ctxt</span> <span class="entity">SpecCheck_Configuration.max_shrinks</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">run_tests</span> <span class="entity">opt_gen</span> <span class="entity">state</span> <span class="entity">stats</span> <span class="entity">counterexamples</span> <span class="main">=</span>
      <span class="comment1">(*stop the test run if enough (successful) tests were run or counterexamples were found*)</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>num_success_tests <span class="entity">stats</span> &gt;= <span class="entity">max_success</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">Success</span> <span class="entity">stats</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">num_tests</span> <span class="entity">stats</span> &gt;= <span class="entity">max_success</span> <span class="keyword1"><span class="keyword">orelse</span></span>
              <span class="main">#</span>num_failed_tests <span class="entity">stats</span> <span class="main">=</span> <span class="entity">num_counterexamples</span>
      <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">Failure</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="entity">failure_data</span> <span class="entity">counterexamples</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="comment1">(*test input and attempt to shrink on failure*)</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">input_opt</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span> <span class="main">=</span> <span class="entity">opt_gen</span> <span class="entity">state</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">input_opt</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>num_failed_tests <span class="entity">stats</span> &gt; <span class="inner_numeral">0</span>
              <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">Failure</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="entity">failure_data</span> <span class="entity">counterexamples</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">Success</span> <span class="entity">stats</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
          <span class="main">|</span> SOME <span class="entity">input</span> <span class="main">=&gt;</span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">result</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=</span> <span class="entity">run_a_test</span> <span class="entity">prop</span> <span class="entity">input</span> <span class="entity">stats</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="entity">Result</span> true <span class="main">=&gt;</span> <span class="entity">run_tests</span> <span class="entity">opt_gen</span> <span class="entity">state</span> <span class="entity">stats</span> <span class="entity">counterexamples</span>
              <span class="main">|</span> <span class="entity">Result</span> false <span class="main">=&gt;</span>
                  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">counterexample</span><span class="main">,</span> <span class="entity">stats</span><span class="main">)</span> <span class="main">=</span> <span class="entity">try_shrink</span> <span class="entity">prop</span> <span class="entity">shrink</span> <span class="entity">input</span> <span class="entity">max_shrinks</span> <span class="entity">stats</span>
                  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">run_tests</span> <span class="entity">opt_gen</span> <span class="entity">state</span> <span class="entity">stats</span> <span class="main">(</span><span class="entity">counterexample</span> :: <span class="entity">counterexamples</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
              <span class="main">|</span> <span class="entity">Discard</span> <span class="main">=&gt;</span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>num_recently_discarded_tests <span class="entity">stats</span> &gt; <span class="entity">max_discard_ratio</span>
                  <span class="keyword2"><span class="keyword">then</span></span>
                    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>num_failed_tests <span class="entity">stats</span> &gt; <span class="inner_numeral">0</span>
                    <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">Failure</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="entity">failure_data</span> <span class="entity">counterexamples</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
                    <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">Gave_Up</span> <span class="entity">stats</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">run_tests</span> <span class="entity">opt_gen</span> <span class="entity">state</span> <span class="entity">stats</span> <span class="entity">counterexamples</span>
              <span class="main">|</span> <span class="entity">Exception</span> <span class="entity">exn</span> <span class="main">=&gt;</span>
                  <span class="main">(</span><span class="entity">Failure</span> <span class="main">(</span><span class="entity">stats</span><span class="main">,</span> <span class="entity">failure_data_exn</span> <span class="main">(</span><span class="entity">input</span> :: <span class="entity">counterexamples</span><span class="main">)</span> <span class="entity">exn</span><span class="main">)</span><span class="main">,</span> <span class="entity">state</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Timing.timing <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">run_tests</span> <span class="entity">opt_gen</span> <span class="entity">state</span> <span class="entity">init_stats</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span>
    |&gt; uncurry <span class="main">(</span>apfst o <span class="entity">output_style</span> <span class="entity">show_opt</span> <span class="entity">ctxt</span> <span class="entity">name</span><span class="main">)</span>
    |&gt; snd
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_style</span> <span class="entity">style</span> <span class="entity">show_opt</span> <span class="entity">shrink</span> <span class="main">=</span>
  <span class="entity">test</span> <span class="entity">style</span> <span class="entity">empty_stats</span> <span class="entity">show_opt</span> <span class="entity">shrink</span> o <span class="entity">SpecCheck_Generator.map</span> SOME

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_shrink</span> <span class="entity">show</span> <span class="main">=</span> <span class="entity">check_style</span> <span class="entity">SpecCheck_Default_Output_Style.default</span> <span class="main">(</span>SOME <span class="entity">show</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check</span> <span class="entity">show</span> <span class="main">=</span> <span class="entity">check_shrink</span> <span class="entity">show</span> <span class="entity">SpecCheck_Shrink.none</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_base</span> <span class="entity">gen</span> <span class="main">=</span>
  <span class="entity">check_style</span> <span class="entity">SpecCheck_Default_Output_Style.default</span> NONE <span class="entity">SpecCheck_Shrink.none</span> <span class="entity">gen</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_seq_style</span> <span class="entity">style</span> <span class="entity">show_opt</span> <span class="entity">xq</span> <span class="entity">name</span> <span class="entity">prop</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="entity">test</span> <span class="entity">style</span> <span class="entity">empty_stats</span> <span class="entity">show_opt</span> <span class="entity">SpecCheck_Shrink.none</span> <span class="entity">SpecCheck_Generator.of_seq</span> <span class="entity">name</span> <span class="entity">prop</span> <span class="entity">ctxt</span>
    <span class="entity">xq</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_seq</span> <span class="entity">show</span> <span class="main">=</span> <span class="entity">check_seq_style</span> <span class="entity">SpecCheck_Default_Output_Style.default</span> <span class="main">(</span>SOME <span class="entity">show</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_seq_base</span> <span class="entity">xq</span> <span class="main">=</span> <span class="entity">check_seq_style</span> <span class="entity">SpecCheck_Default_Output_Style.default</span> NONE <span class="entity">xq</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_list_style</span> <span class="entity">style</span> <span class="entity">show</span> <span class="main">=</span> <span class="entity">check_seq_style</span> <span class="entity">style</span> <span class="entity">show</span> o Seq.of_list
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_list</span> <span class="entity">show</span> <span class="main">=</span> <span class="entity">check_seq</span> <span class="entity">show</span> o Seq.of_list
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_list_base</span> <span class="entity">xs</span> <span class="main">=</span> <span class="entity">check_seq_base</span> <span class="main">(</span>Seq.of_list <span class="entity">xs</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/lecker.ML">
<div class="head">
<h1>File ‹lecker.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/lecker.ML
    Author:     Kevin Kappelmann

Testing framework that lets you combine SpecCheck tests into test suites.

TODO: this file can be largely extended to become a pendant of Haskell's tasty:
https://hackage.haskell.org/package/tasty
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">LECKER</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="comment1">(*the first parameter to test_group will usually be a context*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> test_group <span class="main">:</span> 'a <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> <span class="main">(</span>'a <span class="main">-&gt;</span> 's <span class="main">-&gt;</span> 's<span class="main">)</span> list <span class="main">-&gt;</span> 's
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Lecker</span> <span class="main">:</span> <span class="entity">LECKER</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">test_group</span> <span class="main">_</span> <span class="entity">s</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">s</span>
  <span class="main">|</span> <span class="entity">test_group</span> <span class="entity">fixed_param</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">t</span>::<span class="entity">ts</span><span class="main">)</span> <span class="main">=</span>
      fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span>Pretty.writeln <span class="main">(</span>Pretty.para <span class="inner_quoted">""</span><span class="main">)</span><span class="main">;</span> <span class="entity">t</span> <span class="entity">fixed_param</span><span class="main">)</span><span class="main">)</span> <span class="entity">ts</span> <span class="main">(</span><span class="entity">t</span> <span class="entity">fixed_param</span> <span class="entity">s</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SpecCheck_Dynamic">
<div class="head">
<h1>Theory SpecCheck_Dynamic</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Dynamic Generators›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Dynamic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SpecCheck">SpecCheck</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Summary›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generators and show functions for SpecCheck that are dynamically derived from a given ML input
string. This approach can be handy to quickly test a function during development, but it lacks
customisability and is very brittle. See <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">file</span></span> "../examples/SpecCheck_Examples.thy"<span class="antiquote"><span class="antiquote">}</span></span></span></span> for some
examples contrasting this approach to the standard one (specifying generators as ML code).›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹dynamic_construct.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹speccheck_dynamic.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/dynamic_construct.ML">
<div class="head">
<h1>File ‹dynamic_construct.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/dynamic/dynamic_construct.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen

Dynamic construction of generators and show functions (returned as strings that need to be compiled)
from a given string representing ML code to be tested as a SpecCheck test.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_DYNAMIC_CONSTRUCT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> register <span class="main">:</span> string * <span class="main">(</span>string * string<span class="main">)</span> <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">mltype</span>
  <span class="keyword1"><span class="keyword">val</span></span> parse_pred <span class="main">:</span> string <span class="main">-&gt;</span> string * <span class="entity">mltype</span>
  <span class="keyword1"><span class="keyword">val</span></span> build_check <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> <span class="entity">mltype</span> * string <span class="main">-&gt;</span> string
  <span class="comment1">(*val safe_check : string -&gt; mltype * string -&gt; string*)</span>
  <span class="keyword1"><span class="keyword">val</span></span> string_of_bool <span class="main">:</span> bool <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> string_of_ref <span class="main">:</span> <span class="main">(</span>'a <span class="main">-&gt;</span> string<span class="main">)</span> <span class="main">-&gt;</span> 'a Unsynchronized.ref <span class="main">-&gt;</span> string
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Dynamic_Construct</span> <span class="main">:</span> <span class="entity">SPECCHECK_DYNAMIC_CONSTRUCT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* Parsing ML types *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">mltype</span> <span class="main">=</span> <span class="entity">Var</span> <span class="main">|</span> <span class="entity">Con</span> <span class="keyword2"><span class="keyword">of</span></span> string * mltype list <span class="main">|</span> <span class="entity">Tuple</span> <span class="keyword2"><span class="keyword">of</span></span> mltype list<span class="main">;</span>

<span class="comment1">(*Split string into tokens for parsing*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">split_symbol</span> <span class="inner_quoted">#"("</span> <span class="main">=</span> <span class="inner_quoted">"( "</span>
      <span class="main">|</span> <span class="entity">split_symbol</span> <span class="inner_quoted">#")"</span> <span class="main">=</span> <span class="inner_quoted">" )"</span>
      <span class="main">|</span> <span class="entity">split_symbol</span> <span class="inner_quoted">#","</span> <span class="main">=</span> <span class="inner_quoted">" ,"</span>
      <span class="main">|</span> <span class="entity">split_symbol</span> <span class="inner_quoted">#":"</span> <span class="main">=</span> <span class="inner_quoted">" :"</span>
      <span class="main">|</span> <span class="entity">split_symbol</span> <span class="entity">c</span> <span class="main">=</span> Char.toString <span class="entity">c</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_space</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#" "</span>
  <span class="keyword2"><span class="keyword">in</span></span> String.tokens <span class="entity">is_space</span> <span class="main">(</span>String.translate <span class="entity">split_symbol</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(*Accept anything that is not a recognized symbol*)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">scan_name</span> <span class="main">=</span> Scan.one <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> not <span class="main">(</span>String.isSubstring <span class="entity">s</span> <span class="inner_quoted">"(),*-&gt;;"</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(*Turn a type list into a nested Con*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_con</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Empty
  <span class="main">|</span> <span class="entity">make_con</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> <span class="main">=</span> <span class="entity">c</span>
  <span class="main">|</span> <span class="entity">make_con</span> <span class="main">(</span><span class="entity">Con</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="entity">cl</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">[</span><span class="entity">make_con</span> <span class="entity">cl</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(*Parse a type*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_type</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_fun</span> || <span class="entity">parse_tuple</span> || <span class="entity">parse_type_single</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_type_arg</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_tuple</span> || <span class="entity">parse_type_single</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_type_single</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_con</span> || <span class="entity">parse_type_basic</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_type_basic</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_var</span> || $$ <span class="inner_quoted">"("</span> |-- <span class="entity">parse_type</span> --| $$ <span class="inner_quoted">")"</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_list</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="main">(</span>$$ <span class="inner_quoted">"("</span> |-- <span class="entity">parse_type</span> -- Scan.repeat1 <span class="main">(</span>$$ <span class="inner_quoted">","</span> |-- <span class="entity">parse_type</span><span class="main">)</span> --| $$ <span class="inner_quoted">")"</span> &gt;&gt; <span class="keyword1"><span class="keyword">op</span></span>::<span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_var</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span>Scan.one <span class="main">(</span>String.isPrefix <span class="inner_quoted">"'"</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Var</span><span class="main">)</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_con</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="entity">parse_con_nest</span>
  || <span class="entity">parse_type_basic</span> -- <span class="entity">parse_con_nest</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="entity">tl</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">[</span><span class="entity">b</span><span class="main">]</span><span class="main">)</span> :: <span class="entity">tl</span><span class="main">)</span>
  || <span class="entity">parse_list</span> -- <span class="entity">parse_con_nest</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="entity">tl</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">l</span><span class="main">)</span> :: <span class="entity">tl</span><span class="main">)</span><span class="main">)</span>
  &gt;&gt; <span class="main">(</span><span class="entity">make_con</span> o rev<span class="main">)</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_con_nest</span> <span class="entity">s</span> <span class="main">=</span> Scan.unless <span class="entity">parse_var</span> <span class="main">(</span>Scan.repeat1 <span class="main">(</span><span class="entity">scan_name</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_fun</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_type_arg</span> -- $$ <span class="inner_quoted">"-&gt;"</span> -- <span class="entity">parse_type</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">f</span><span class="main">)</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Con</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="main">[</span><span class="entity">a</span><span class="main">,</span> <span class="entity">r</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">s</span>

<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_tuple</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_type_single</span> -- Scan.repeat1 <span class="main">(</span>$$ <span class="inner_quoted">"*"</span> |-- <span class="entity">parse_type_single</span><span class="main">)</span>
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">tl</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Tuple</span> <span class="main">(</span><span class="entity">t</span> :: <span class="entity">tl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">s</span><span class="main">;</span>

<span class="comment1">(*Parse entire type + name*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_function</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> $$ <span class="inner_quoted">"val"</span> |-- <span class="entity">scan_name</span> --| <span class="main">(</span>$$ <span class="inner_quoted">"="</span> -- $$ <span class="inner_quoted">"fn"</span> -- $$ <span class="inner_quoted">":"</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">split</span> <span class="entity">s</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stop</span> <span class="main">=</span> Scan.stopper <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_quoted">";"</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_quoted">";"</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">typ</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Scan.finite <span class="entity">stop</span> <span class="entity">parse_type</span> <span class="entity">ty</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(*Create desired output*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_pred</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">Con</span> <span class="main">(</span><span class="inner_quoted">"-&gt;"</span><span class="main">,</span> <span class="entity">t</span> :: <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">parse_function</span> <span class="entity">s</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* Construct Generators and Pretty Printers *)</span>

<span class="comment1">(*copied from smt_config.ML *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string_of_bool</span> <span class="entity">b</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"true"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"false"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string_of_ref</span> <span class="entity">f</span> <span class="entity">r</span> <span class="main">=</span> <span class="entity">f</span> <span class="main">(</span>!<span class="entity">r</span><span class="main">)</span> ^ <span class="inner_quoted">" ref"</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">initial_content</span> <span class="main">=</span> Symtab.make <span class="main">[</span>
  <span class="main">(</span><span class="inner_quoted">"bool"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.bernoulli 0.5"</span><span class="main">,</span> <span class="inner_quoted">"Gen_Construction.string_of_bool"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"option"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.option (SpecCheck_Generator.bernoulli (2.0 / 3.0))"</span><span class="main">,</span>
              <span class="inner_quoted">"ML_Syntax.print_option"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"list"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.unfold_while (K (SpecCheck_Generator.bernoulli (2.0 / 3.0)))"</span><span class="main">,</span>
            <span class="inner_quoted">" ML_Syntax.print_list"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"unit"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"gen_unit"</span><span class="main">,</span> <span class="inner_quoted">"fn () =&gt; \"()\""</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"int"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.range_int (~2147483647,2147483647)"</span><span class="main">,</span> <span class="inner_quoted">"string_of_int"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"real"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.real"</span><span class="main">,</span> <span class="inner_quoted">"string_of_real"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"char"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.char"</span><span class="main">,</span> <span class="inner_quoted">"fn c =&gt; \"#'\" ^ (Char.toString c) ^ \"'\""</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"string"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.string (SpecCheck_Generator.nonneg 100) SpecCheck_Generator.char"</span><span class="main">,</span>
              <span class="inner_quoted">"ML_Syntax.print_string"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"-&gt;"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.function' o snd"</span><span class="main">,</span> <span class="inner_quoted">"fn (_, _) =&gt; fn _ =&gt; \"fn\""</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"typ"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.typ'' (SpecCheck_Generator.return 8) (SpecCheck_Generator.nonneg 4) (SpecCheck_Generator.nonneg 4) (1,1,1)"</span><span class="main">,</span>
           <span class="inner_quoted">"Pretty.string_of o Syntax.pretty_typ (Context.the_local_context ())"</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="inner_quoted">"term"</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"SpecCheck_Generator.term_tree (fn h =&gt; fn _ =&gt; "</span>
            ^ <span class="inner_quoted">"let val ngen = SpecCheck_Generator.nonneg (Int.max (0, 4-h))\n"</span>
            ^ <span class="inner_quoted">"    val aterm_gen = SpecCheck_Generator.aterm' (SpecCheck_Generator.return 8) ngen (1,1,1,0)\n"</span>
            ^ <span class="inner_quoted">"in SpecCheck_Generator.zip aterm_gen ngen end)"</span><span class="main">,</span>
            <span class="inner_quoted">"Pretty.string_of o Syntax.pretty_term (Context.the_local_context ())"</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Theory_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span>string * string<span class="main">)</span> Symtab.table
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="entity">initial_content</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="entity">data</span> <span class="main">:</span> <span class="entity">T</span> <span class="main">=</span> Symtab.merge <span class="main">(</span>K true<span class="main">)</span> <span class="entity">data</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">data_of</span> <span class="entity">ctxt</span> <span class="entity">tycon</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Symtab.lookup <span class="main">(</span>Data.get <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">tycon</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="entity">data</span> <span class="main">=&gt;</span> <span class="entity">data</span>
  <span class="main">|</span> NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"No generator and printer defined for ML type constructor "</span> ^ quote <span class="entity">tycon</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">generator_of</span> <span class="main">=</span> fst oo <span class="entity">data_of</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">printer_of</span> <span class="main">=</span> snd oo <span class="entity">data_of</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register</span> <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">data</span><span class="main">)</span> <span class="main">=</span> Data.map <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">data</span><span class="main">)</span><span class="main">)</span>

<span class="comment1">(*
fun remove_gen ty = gen_table := AList.delete (op =) ty (!gen_table);
*)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">combine</span> <span class="entity">dict</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">dict</span>
  <span class="main">|</span> <span class="entity">combine</span> <span class="entity">dict</span> <span class="entity">dicts</span> <span class="main">=</span> enclose <span class="inner_quoted">"("</span> <span class="inner_quoted">")"</span> <span class="entity">dict</span> ^ <span class="inner_quoted">" "</span> ^ enclose <span class="inner_quoted">"("</span> <span class="inner_quoted">")"</span> <span class="main">(</span>commas <span class="entity">dicts</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compose_generator</span> <span class="main">_</span> <span class="entity">Var</span> <span class="main">=</span> <span class="inner_quoted">"SpecCheck_Generator.range_int (~2147483647, 2147483647)"</span>
  <span class="main">|</span> <span class="entity">compose_generator</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Con</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">types</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">combine</span> <span class="main">(</span><span class="entity">generator_of</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">compose_generator</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">types</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">compose_generator</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Tuple</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tuple_body</span> <span class="entity">t</span> <span class="main">=</span> space_implode <span class="inner_quoted">""</span>
          <span class="main">(</span>map
            <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span> <span class="main">=&gt;</span> implode <span class="main">[</span><span class="inner_quoted">"val (x"</span><span class="main">,</span> string_of_int <span class="entity">n</span><span class="main">,</span> <span class="inner_quoted">", r"</span><span class="main">,</span> string_of_int <span class="entity">n</span><span class="main">,</span> <span class="inner_quoted">") = "</span><span class="main">,</span>
              <span class="entity">compose_generator</span> <span class="entity">ctxt</span> <span class="entity">ty</span><span class="main">,</span> <span class="inner_quoted">" r"</span><span class="main">,</span> string_of_int <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="inner_quoted">" "</span><span class="main">]</span><span class="main">)</span>
            <span class="main">(</span><span class="entity">t</span> ~~ <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="main">(</span>length <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tuple_ret</span> <span class="entity">a</span> <span class="main">=</span> commas <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="inner_quoted">"x"</span> ^ string_of_int <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">a</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="inner_quoted">"fn r0 =&gt; let "</span> ^ <span class="entity">tuple_body</span> <span class="entity">t</span> ^
        <span class="inner_quoted">"in (("</span> ^ <span class="entity">tuple_ret</span> <span class="main">(</span>length <span class="entity">t</span><span class="main">)</span> ^ <span class="inner_quoted">"), r"</span> ^ string_of_int <span class="main">(</span>length <span class="entity">t</span><span class="main">)</span> ^ <span class="inner_quoted">") end"</span>
      <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compose_printer</span> <span class="main">_</span> <span class="entity">Var</span> <span class="main">=</span> <span class="inner_quoted">"Int.toString"</span>
  <span class="main">|</span> <span class="entity">compose_printer</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Con</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="entity">types</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">combine</span> <span class="main">(</span><span class="entity">printer_of</span> <span class="entity">ctxt</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">compose_printer</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">types</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">compose_printer</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Tuple</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tuple_head</span> <span class="entity">a</span> <span class="main">=</span> commas <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="inner_quoted">"x"</span> ^ string_of_int <span class="entity">n</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">a</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tuple_body</span> <span class="entity">t</span> <span class="main">=</span> space_implode <span class="inner_quoted">" ^ \", \" ^ "</span>
          <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_quoted">"("</span> ^ <span class="entity">compose_printer</span> <span class="entity">ctxt</span> <span class="entity">ty</span> ^ <span class="inner_quoted">") x"</span> ^ string_of_int <span class="entity">n</span><span class="main">)</span>
          <span class="main">(</span><span class="entity">t</span> ~~ <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="main">(</span>length <span class="entity">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> implode <span class="main">[</span><span class="inner_quoted">"fn ("</span><span class="main">,</span> <span class="entity">tuple_head</span> <span class="main">(</span>length <span class="entity">t</span><span class="main">)</span><span class="main">,</span> <span class="inner_quoted">") =&gt; \"(\" ^ "</span><span class="main">,</span> <span class="entity">tuple_body</span> <span class="entity">t</span><span class="main">,</span> <span class="inner_quoted">" ^ \")\""</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*produce compilable string*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">build_check</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">spec</span><span class="main">)</span> <span class="main">=</span> implode <span class="main">[</span><span class="inner_quoted">"SpecCheck.check (Pretty.str o ("</span><span class="main">,</span>
  <span class="entity">compose_printer</span> <span class="entity">ctxt</span> <span class="entity">ty</span><span class="main">,</span> <span class="inner_quoted">")) ("</span><span class="main">,</span> <span class="entity">compose_generator</span> <span class="entity">ctxt</span> <span class="entity">ty</span><span class="main">,</span> <span class="inner_quoted">")  \""</span><span class="main">,</span> <span class="entity">name</span><span class="main">,</span>
  <span class="inner_quoted">"\" (SpecCheck_Property.prop ("</span><span class="main">,</span> <span class="entity">spec</span><span class="main">,</span>
  <span class="inner_quoted">")) (Context.the_local_context ()) (SpecCheck_Random.new ());"</span><span class="main">]</span>

<span class="comment1">(*produce compilable string - non-eqtype functions*)</span>
<span class="comment1">(*
fun safe_check name (ty, spec) =
  let
    val default =
      (case AList.lookup (op =) (!gen_table) "-&gt;" of
        NONE =&gt; ("gen_function_rand", "fn (_, _) =&gt; fn _ =&gt; \"fn\"")
      | SOME entry =&gt; entry)
  in
   (gen_table :=
     AList.update (op =) ("-&gt;", ("gen_function_safe", "fn (_, _) =&gt; fn _ =&gt; \"fn\"")) (!gen_table);
    build_check name (ty, spec) before
    gen_table := AList.update (op =) ("-&gt;", default) (!gen_table))
  end;
*)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="files/speccheck_dynamic.ML">
<div class="head">
<h1>File ‹speccheck_dynamic.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      SpecCheck/dynamic/speccheck_dynamic.ML
    Author:     Lukas Bulwahn and Nicolai Schaffroth, TU Muenchen

This file allows to run SpecCheck tests specified as a string representing ML code.

TODO: this module is not very well tested.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SPECCHECK_DYNAMIC</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> check_dynamic <span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> unit
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SpecCheck_Dynamic</span> <span class="main">:</span> <span class="entity">SPECCHECK_DYNAMIC</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(*call the compiler and pass resulting type string to the parser*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">determine_type</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">return</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_quoted">"return"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">context</span> <span class="main">:</span> ML_Compiler0.context <span class="main">=</span>
     <span class="main">{</span>name_space <span class="main">=</span> <span class="main">#</span>name_space ML_Env.context<span class="main">,</span>
      print_depth <span class="main">=</span> SOME <span class="inner_numeral">1000000</span><span class="main">,</span>
      here <span class="main">=</span> <span class="main">#</span>here ML_Env.context<span class="main">,</span>
      print <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">return</span> := <span class="entity">r</span><span class="main">,</span>
      error <span class="main">=</span> <span class="main">#</span>error ML_Env.context<span class="main">}</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
      Context.setmp_generic_context <span class="main">(</span>SOME <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
          ML_Compiler0.ML <span class="entity">context</span>
            <span class="main">{</span>line <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span> file <span class="main">=</span> <span class="inner_quoted">"generated code"</span><span class="main">,</span> verbose <span class="main">=</span> true<span class="main">,</span> debug <span class="main">=</span> false<span class="main">}</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">SpecCheck_Dynamic_Construct.parse_pred</span> <span class="main">(</span>! <span class="entity">return</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(*call the compiler and run the test*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">run_test</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="main">=</span>
  Context.setmp_generic_context <span class="main">(</span>SOME <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
      ML_Compiler0.ML ML_Env.context
        <span class="main">{</span>line <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">,</span> file <span class="main">=</span> <span class="inner_quoted">"generated code"</span><span class="main">,</span> verbose <span class="main">=</span> false<span class="main">,</span> debug <span class="main">=</span> false<span class="main">}</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(*split input into tokens*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">input_split</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dot</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"."</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">space</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#" "</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">head</span><span class="main">,</span> <span class="entity">code</span><span class="main">)</span> <span class="main">=</span> Substring.splitl <span class="main">(</span>not o <span class="entity">dot</span><span class="main">)</span> <span class="main">(</span>Substring.full <span class="entity">s</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
   <span class="main">(</span>String.tokens <span class="entity">space</span> <span class="main">(</span>Substring.string <span class="entity">head</span><span class="main">)</span><span class="main">,</span>
    Substring.string <span class="main">(</span>Substring.dropl <span class="entity">dot</span> <span class="entity">code</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(*create the function from the input*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_fun</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">scan_param</span> <span class="main">=</span> Scan.one <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> &lt;&gt; <span class="inner_quoted">";"</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parameters</span> <span class="entity">s</span> <span class="main">=</span> Scan.repeat1 <span class="entity">scan_param</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> $$ <span class="inner_quoted">"ALL"</span> |-- <span class="entity">parameters</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">split</span><span class="main">,</span> <span class="entity">code</span><span class="main">)</span> <span class="main">=</span> <span class="entity">input_split</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stop</span> <span class="main">=</span> Scan.stopper <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_quoted">";"</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_quoted">";"</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">params</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Scan.finite <span class="entity">stop</span> <span class="entity">p</span> <span class="entity">split</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="inner_quoted">"fn ("</span> ^ commas <span class="entity">params</span> ^ <span class="inner_quoted">") =&gt; "</span> ^ <span class="entity">code</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(*read input and perform the test*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_check_property</span> <span class="entity">check</span> <span class="entity">ctxt</span> <span class="entity">s</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">func</span> <span class="main">=</span> <span class="entity">make_fun</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ty</span><span class="main">)</span> <span class="main">=</span> <span class="entity">determine_type</span> <span class="entity">ctxt</span> <span class="entity">func</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">run_test</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">check</span> <span class="entity">ctxt</span> <span class="inner_quoted">"Dynamic Test"</span> <span class="main">(</span><span class="entity">ty</span><span class="main">,</span> <span class="entity">func</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">check_dynamic</span> <span class="main">=</span> <span class="entity">gen_check_property</span> <span class="entity">SpecCheck_Dynamic_Construct.build_check</span>
<span class="comment1">(*val check_property_safe = gen_check_property Construct_Gen.safe_check*)</span>

<span class="comment1">(*perform test for specification function*)</span>
<span class="comment1">(*fun gen_check_property_f check ctxt s =
  let
    val (name, ty) = determine_type ctxt s
  in run_test ctxt (check ctxt name (ty, s)) end;

val check_property_f = gen_check_property_f Gen_Dynamic.build_check*)</span>
<span class="comment1">(*val check_property_safe_f_ = gen_check_property_f Construct_Gen.safe_check*)</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="SpecCheck_Examples">
<div class="head">
<h1>Theory SpecCheck_Examples</h1>
</div>
<pre class="source"><span class="comment1">✐‹creator "Kevin Kappelmann"›</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>
<span class="keyword1"><span class="command">theory</span></span> SpecCheck_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#SpecCheck_Dynamic">SpecCheck_Dynamic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List examples›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck
<span class="keyword3"><span class="keyword">open</span></span> SpecCheck_Dynamic
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Gen</span> <span class="main">=</span> SpecCheck_Generator
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Prop</span> <span class="main">=</span> SpecCheck_Property
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Show</span> <span class="main">=</span> SpecCheck_Show
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Shrink</span> <span class="main">=</span> SpecCheck_Shrink
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Random</span> <span class="main">=</span> SpecCheck_Random
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">int_gen</span> <span class="main">=</span> <span class="entity">Gen.range_int</span> <span class="main">(</span><span class="inner_numeral">~10000000</span><span class="main">,</span> <span class="inner_numeral">10000000</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">size_gen</span> <span class="main">=</span> <span class="entity">Gen.nonneg</span> <span class="inner_numeral">10</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">check_list</span> <span class="main">=</span> <span class="entity">check_shrink</span> <span class="main">(</span><span class="entity">Show.list</span> <span class="entity">Show.int</span><span class="main">)</span> <span class="main">(</span><span class="entity">Shrink.list</span> <span class="entity">Shrink.int</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">Gen.list</span> <span class="entity">size_gen</span> <span class="entity">int_gen</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_test</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">f</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
    AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span><span class="main">)</span> <span class="main">(</span>AList.map_entry <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span><span class="main">)</span> <span class="entity">k</span> <span class="entity">f</span> <span class="entity">xs</span><span class="main">)</span> <span class="entity">k</span> <span class="main">=</span> Option.map <span class="entity">f</span> <span class="main">(</span>AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span><span class="main">)</span> <span class="entity">xs</span> <span class="entity">k</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_test_show</span> <span class="main">=</span> <span class="entity">Show.zip3</span> <span class="entity">Show.int</span> <span class="entity">Show.none</span> <span class="main">(</span><span class="entity">Show.list</span> <span class="main">(</span><span class="entity">Show.zip</span> <span class="entity">Show.int</span> <span class="entity">Show.int</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_test_gen</span> <span class="main">=</span> <span class="entity">Gen.zip3</span> <span class="entity">int_gen</span> <span class="main">(</span><span class="entity">Gen.function'</span> <span class="entity">int_gen</span><span class="main">)</span>
    <span class="main">(</span><span class="entity">Gen.list</span> <span class="entity">size_gen</span> <span class="main">(</span><span class="entity">Gen.zip</span> <span class="entity">int_gen</span> <span class="entity">int_gen</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Lecker.test_group</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="entity">Random.new</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>
    <span class="entity">Prop.prop</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> rev <span class="entity">xs</span> <span class="main">=</span> <span class="entity">xs</span><span class="main">)</span> |&gt; <span class="entity">check_list</span> <span class="inner_quoted">"rev = I"</span><span class="main">,</span>
    <span class="entity">Prop.prop</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">xs</span> <span class="main">=&gt;</span> rev <span class="main">(</span>rev <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">xs</span><span class="main">)</span> |&gt; <span class="entity">check_list</span> <span class="inner_quoted">"rev o rev = I"</span><span class="main">,</span>
    <span class="entity">Prop.prop</span> <span class="entity">list_test</span> |&gt; <span class="entity">check</span> <span class="entity">list_test_show</span> <span class="entity">list_test_gen</span> <span class="inner_quoted">"lookup map equiv map lookup"</span>
  <span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next three examples roughly correspond to the above test group (except that there's no
shrinking). Compared to the string-based method, the method above is more flexible - you can change
your generators, shrinking methods, and show instances - and robust - you are not reflecting strings
(which might contain typos) but entering type-checked code. In exchange, it is a bit more work to
set up the generators. However, in practice, one shouldn't rely on default generators in most cases
anyway.›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL xs. rev xs = xs"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL xs. rev (rev xs) = xs"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹AList Specification›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*map_entry applies the function to the element*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span>implode
  <span class="main">[</span><span class="inner_quoted">"ALL k f xs. AList.lookup (op =) (AList.map_entry (op =) k f xs) k = "</span><span class="main">,</span>
   <span class="inner_quoted">"Option.map f (AList.lookup (op =) xs k)"</span><span class="main">]</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*update always results in an entry*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL k v xs. AList.defined (op =) (AList.update (op =) (k, v) xs) k"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*update always writes the value*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="inner_quoted">"ALL k v xs. AList.lookup (op =) (AList.update (op =) (k, v) xs) k = SOME v"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*default always results in an entry*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL k v xs. AList.defined (op =) (AList.default (op =) (k, v) xs) k"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*delete always removes the entry*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL k xs. not (AList.defined (op =) (AList.delete (op =) k xs) k)"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="comment1">(*default writes the entry iff it didn't exist*)</span>
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">(</span>implode
  <span class="main">[</span><span class="inner_quoted">"ALL k v xs. (AList.lookup (op =) (AList.default (op =) (k, v) xs) k = "</span><span class="main">,</span>
   <span class="inner_quoted">"(if AList.defined (op =) xs k then AList.lookup (op =) xs k else SOME v))"</span><span class="main">]</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples on Types and Terms›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL f g t. map_types (g o f) t = (map_types f o map_types g) t"</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL f g t. map_types (f o g) t = (map_types f o map_types g) t"</span><span class="main">;</span>
›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One would think this holds:›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL t ts. strip_comb (list_comb (t, ts)) = (t, ts)"</span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹But it only holds with this precondition:›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="inner_quoted">"ALL t ts. case t of _ $ _ =&gt; true | _ =&gt; strip_comb (list_comb (t, ts)) = (t, ts)"</span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some surprises›</span></span>

<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="entity">check_dynamic</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"ALL Ts t. type_of1 (Ts, t) = fastype_of1 (Ts, t)"</span>
›</span>


<span class="keyword1"><span class="command">ML_command</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> <span class="antiquoted"><span class="operator"><span class="entity"><span class="hidden">\&lt;^</span><span class="control">theory</span><span class="hidden">&gt;</span></span></span></span><span class="main">;</span>
<span class="entity">check_dynamic</span> <span class="main">(</span>Context.the_local_context <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  <span class="inner_quoted">"ALL t u. if Pattern.matches thy (t, u) then Term.could_unify (t, u) else true"</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>