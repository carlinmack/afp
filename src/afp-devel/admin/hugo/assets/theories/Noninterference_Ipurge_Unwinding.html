<div id="IpurgeUnwinding">
<div class="head">
<h1>Theory IpurgeUnwinding</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Ipurge Unwinding Theorem for CSP Noninterference Security
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Ipurge Unwinding Theorem in its general form"</span></span>

<span class="keyword1"><span class="command">theory</span></span> IpurgeUnwinding
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../noninterference_csp/theories/#CSPNoninterference">Noninterference_CSP.CSPNoninterference</a> <a href="../../list_interleaving/theories/#ListInterleaving">List_Interleaving.ListInterleaving</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The definition of noninterference security for Communicating Sequential Processes given in \cite{R1}
requires to consider any possible future, i.e. any indefinitely long sequence of subsequent events
and any indefinitely large set of refused events associated to that sequence, for each process
trace. In order to render the verification of the security of a process more straightforward, there
is a need of some sufficient condition for security such that just individual accepted and refused
events, rather than unbounded sequences and sets of events, have to be considered.

Of course, if such a sufficient condition were necessary as well, it would be even more valuable,
since it would permit to prove not only that a process is secure by verifying that the condition
holds, but also that a process is not secure by verifying that the condition fails to hold.

This section provides a necessary and sufficient condition for CSP noninterference security, which
indeed requires to just consider individual accepted and refused events and applies to the general
case of a possibly intransitive policy. This condition follows Rushby's output consistency for
deterministic state machines with outputs \cite{R4}, and has to be satisfied by a specific function
mapping security domains into equivalence relations over process traces. The definition of this
function makes use of an intransitive purge function following Rushby's one; hence the name given to
the condition, \emph{Ipurge Unwinding Theorem}.

The contents of this paper are based on those of \cite{R1}. The salient points of definitions and
proofs are commented; for additional information, cf. Isabelle documentation, particularly
\cite{R5}, \cite{R6}, \cite{R7}, and \cite{R8}.

For the sake of brevity, given a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F›</span></span></span></span> of type
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a<span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>m</sub> ⇒ 'a<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>n</sub> ⇒ 'b›</span></span></span></span>, the explanatory text may discuss of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F›</span></span></span></span>
using attributes that would more exactly apply to a term of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>n</sub> ⇒ 'b›</span></span></span></span>.
In this case, it shall be understood that strictly speaking, such attributes apply to a term
matching pattern <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F a<span class="hidden">⇩</span><sub>1</sub> … a<span class="hidden">⇩</span><sub>m</sub>›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Propaedeutic definitions and lemmas"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The definition of CSP noninterference security formulated in \cite{R1} requires that some sets of
events be refusals, i.e. sets of refused events, for some traces. Therefore, a sufficient condition
for security just involving individual refused events will require that some single events be
refused, viz. form singleton refusals, after the occurrence of some traces. However, such a
statement may actually be a sufficient condition for security just in the case of a process such
that the union of any set of singleton refusals for a given trace is itself a refusal for that
trace.

This turns out to be true if and only if the union of any set \emph{A} of refusals, not necessarily
singletons, is still a refusal. The direct implication is trivial. As regards the converse one, let
\emph{A'} be the set of the singletons included in some element of \emph{A}. Then, each element of
\emph{A'} is a singleton refusal by virtue of rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> process_rule_3<span class="antiquote"><span class="antiquote">}</span></span></span></span>, so that the union of the
elements of \emph{A'}, which is equal to the union of the elements of \emph{A}, is a refusal by
hypothesis.

This property, henceforth referred to as \emph{refusals union closure} and formalized in what
follows, clearly holds for any process admitting a meaningful interpretation, as it would be a
nonsense, in the case of a process modeling a real system, to say that some sets of events are
refused after the occurrence of a trace, but their union is not. Thus, taking the refusals union
closure of the process as an assumption for the equivalence between process security and a given
condition, as will be done in the Ipurge Unwinding Theorem, does not give rise to any actual
limitation on the applicability of such a result.

As for predicates \emph{view partition} and \emph{future consistent}, defined here below as well,
they translate Rushby's predicates \emph{view-partitioned} and \emph{output consistent} \cite{R4},
applying to deterministic state machines with outputs, into Hoare's Communicating Sequential
Processes model of computation \cite{R3}. The reason for the verbal difference between the active
form of predicate \emph{view partition} and the passive form of predicate \emph{view-partitioned} is
that the implied subject of the former is a domain-relation map rather than a process, whose
homologous in \cite{R4}, viz. a machine, is the implied subject of the latter predicate instead.

More remarkably, the formal differences with respect to Rushby's original predicates are the
following ones:

\begin{itemize}

\item
The relations in the range of the domain-relation map hold between event lists rather than machine
states.

\item
The domains appearing as inputs of the domain-relation map do not unnecessarily encompass all the
possible values of the data type of domains, but just the domains in the range of the event-domain
map.

\item
The equality of the outputs in domain \emph{u} produced by machine states equivalent for \emph{u},
as required by output consistency, is replaced by the equality of the events in domain \emph{u}
accepted or refused after the occurrence of event lists equivalent for \emph{u}; hence the name of
the property, \emph{future consistency}.

\end{itemize}

An additional predicate, \emph{weakly future consistent}, renders future consistency less strict by
requiring the equality of subsequent accepted and refused events to hold only for event domains not
allowed to be affected by some event domain.

\null
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> domset_rel_map <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ref_union_closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ref_union_closed</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">xs</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">view_partition</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">view_partition</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_dom_events</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">next_dom_events</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ref_dom_events</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ref_dom_events</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">future_consistent</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">future_consistent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_future_consistent</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">weakly_future_consistent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">``</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below are some lemmas propaedeutic for the proof of the Ipurge Unwinding Theorem, just
involving constants defined in \cite{R1}.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-process_rule_2_traces"><span class="command">lemma</span></span> process_rule_2_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">xs'</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-process_rule_4"><span class="command">lemma</span></span> process_rule_4 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> insert <span class="free">x</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> insert <span class="bound">x</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_4_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> insert <span class="free">x</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-failures_traces"><span class="command">lemma</span></span> failures_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-traces_failures"><span class="command">lemma</span></span> traces_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> process_rule_3<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sinks_interference"><span class="command">lemma</span></span> sinks_interference <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x'</span> <span class="main">∨</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> bexE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> bexE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-sinks_interference_eq"><span class="command">lemma</span></span> sinks_interference_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> contrapos_nn<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sinks_interference<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, some lemmas concerning the constants defined above are proven.

In the definition of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ref_union_closed</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the conclusion that the union of a set of
refusals is itself a refusal for the same trace is subordinated to the condition that the set of
refusals be nonempty. The first lemma shows that in the absence of this condition, the predicate
could only be satisfied by a process admitting any event list as a trace, which proves that the
condition must be present for the definition to be correct.

The subsequent lemmas prove that, for each domain \emph{u} in the ranges respectively taken into
consideration, the image of \emph{u} under a future consistent or weakly future consistent
domain-relation map may only correlate a pair of event lists such that either both are traces, or
both are not traces. Finally, it is demonstrated that future consistency implies weak future
consistency.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-traces_dom_events"><span class="command">lemma</span></span> traces_dom_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="free">D</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>                                                    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ex_in_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ex_in_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-fc_traces"><span class="command">lemma</span></span> fc_traces<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"future_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_dom_events<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_dom_events<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-wfc_traces"><span class="command">lemma</span></span> wfc_traces<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="bound">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="free">u</span> <span class="main">⟶</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_dom_events<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span>next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">∪</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_dom_events<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-fc_implies_wfc"><span class="command">lemma</span></span> fc_implies_wfc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"future_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span> weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> future_consistent_def weakly_future_consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, the definition is given of an auxiliary function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>singleton_set›</span></span></span></span>, whose output is the
set of the singleton subsets of a set taken as input, and then some basic properties of this
function are proven.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">singleton_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">singleton_set</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="IpurgeUnwinding-singleton_set_some"><span class="command">lemma</span></span> singleton_set_some<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> singleton_set <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-singleton_set_union"><span class="command">lemma</span></span> singleton_set_union<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">Y</span> <span class="main">∈</span> singleton_set <span class="free">X</span><span class="main">.</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">Y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">Y'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="bound">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> UN_E <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">Y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">Y'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x'</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="bound">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> UN_I <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Additional intransitive purge functions and their properties"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks_aux›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_aux›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_ref_aux›</span></span></span></span>, defined here below,
are auxiliary versions of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sinks</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> taking
as input a set of domains rather than a single domain. As shown below, these functions are useful
for the study of single domain ones, involved in the definition of CSP noninterference security
\cite{R1}, since they distribute over list concatenation, while being susceptible to be expressed in
terms of the corresponding single domain functions in case the input set of domains is a singleton.

A further function, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unaffected_domains›</span></span></span></span>, takes as inputs a set of domains <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span> and an
event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>, and outputs the set of the event domains not allowed to be affected by
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span> after the occurrence of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">sinks_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sinks_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sinks_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">sinks_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sinks_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">sinks_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">ipurge_tr_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> <span class="free">ipurge_tr_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">ipurge_tr_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipurge_ref_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_ref_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unaffected_domains</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unaffected_domains</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_rev›</span></span></span></span>, defined here below in terms of function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span>, is the
reverse of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with regard to both the order in which events are considered,
and the criterion by which they are purged.

In some detail, both functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_rev›</span></span></span></span> take as inputs a domain
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> and an event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>, whose recursive decomposition is performed by item
prepending rather than appending. Then:

\begin{itemize}

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span> outputs the set of the domains of the events in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> allowed to affect
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span>;

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_rev›</span></span></span></span> outputs the sublist of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> obtained by recursively deleting the events
not allowed to affect <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span>, as detected via function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span>.

\end{itemize}

In other words, these functions follow Rushby's ones \emph{sources} and \emph{ipurge} \cite{R4},
formalized in \cite{R1} as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_sources›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_ipurge›</span></span></span></span>. The only difference consists of
dropping the implicit supposition that the noninterference policy be reflexive, as done in the
definition of CPS noninterference security \cite{R1}. This goal is achieved by defining the output
of function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span>, when it is applied to the empty list, as being the empty set rather
than the singleton comprised of the input domain.

As for functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources_aux›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_rev_aux›</span></span></span></span>, they are auxiliary versions of
functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sources›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_rev›</span></span></span></span> taking as input a set of domains rather than a
single domain. As shown below, these functions distribute over list concatenation, while being
susceptible to be expressed in terms of the corresponding single domain functions in case the input
set of domains is a singleton.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sources</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sources</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ipurge_tr_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_rev</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_rev</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> sources <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">ipurge_tr_rev</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">ipurge_tr_rev</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sources_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sources_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ipurge_tr_rev_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_rev_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_rev_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">ipurge_tr_rev_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">ipurge_tr_rev_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below are some lemmas on functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sinks_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">unaffected_domains</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As anticipated above, these lemmas
essentially concern distributivity over list concatenation and expressions in terms of single domain
functions in the degenerate case of a singleton set of domains.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-sinks_aux_subset"><span class="command">lemma</span></span> sinks_aux_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI2<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sinks_aux_single_dom"><span class="command">lemma</span></span> sinks_aux_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="main">=</span> insert <span class="free">u</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sinks_aux_single_event"><span class="command">lemma</span></span> sinks_aux_single_event<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>
   <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span>
   <span class="keyword1">else</span> <span class="free">U</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-sinks_aux_cons"><span class="command">lemma</span></span> sinks_aux_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>
   <span class="keyword1">then</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="free">xs</span>
   <span class="keyword1">else</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">v</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">U</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_event <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?S'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_aux_single_dom"><span class="command">lemma</span></span> ipurge_tr_aux_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps if_True if_False<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_interference_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_ref_aux_single_dom"><span class="command">lemma</span></span> ipurge_ref_aux_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="free">X</span> <span class="main">=</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_def ipurge_ref_def sinks_aux_single_dom<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_ref_aux_all"><span class="command">lemma</span></span> ipurge_ref_aux_all <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_def sinks_aux_cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_ref_all"><span class="command">lemma</span></span> ipurge_ref_all<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟹</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_ref_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_ref_aux_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-unaffected_domains_single_dom"><span class="command">lemma</span></span> unaffected_domains_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span><span class="main">}</span> <span class="main">=</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def unaffected_domains_def sinks_aux_single_dom<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below are some lemmas on functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sources</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sources_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As anticipated above, the lemmas on the last two functions basically
concern distributivity over list concatenation and expressions in terms of single domain functions
in the degenerate case of a singleton set of domains.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-sources_sinks"><span class="command">lemma</span></span> sources_sinks<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> sinks <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sources_sinks_aux"><span class="command">lemma</span></span> sources_sinks_aux<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> sinks_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sources_aux_subset"><span class="command">lemma</span></span> sources_aux_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sources_sinks_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sources_aux_append"><span class="command">lemma</span></span> sources_aux_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-sources_aux_append_nil"><span class="command">lemma</span></span> sources_aux_append_nil <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">U</span> <span class="main">⟶</span>
  sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_append"><span class="command">lemma</span></span> ipurge_tr_rev_aux_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sources_aux_append<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_nil_1"><span class="command">lemma</span></span> ipurge_tr_rev_aux_nil_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_nil_2"><span class="command">lemma</span></span> ipurge_tr_rev_aux_nil_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_nil"><span class="command">lemma</span></span> ipurge_tr_rev_aux_nil<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ipurge_tr_rev_aux_nil_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_nil_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bspec<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_nil_sources"><span class="command">lemma</span></span> ipurge_tr_rev_aux_nil_sources <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_append_nil_1"><span class="command">lemma</span></span> ipurge_tr_rev_aux_append_nil_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_nil_sources sources_aux_append_nil<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_first"><span class="command">lemma</span></span> ipurge_tr_rev_aux_first <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ws</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ws</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ws</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ws</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sources_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sources_aux.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_last_1"><span class="command">lemma</span></span> ipurge_tr_rev_aux_last_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_last_2"><span class="command">lemma</span></span> ipurge_tr_rev_aux_last_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_all"><span class="command">lemma</span></span> ipurge_tr_rev_aux_all <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sources_aux_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below, further properties of the functions defined above are investigated thanks to the
introduction of function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>offset›</span></span></span></span>, which searches a list for a given item and returns the
offset of its first occurrence, if any, from the first item of the list.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">offset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offset</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">offset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free">offset</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IpurgeUnwinding-offset_not_none_1"><span class="command">lemma</span></span> offset_not_none_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"offset <span class="free">k</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">xs</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> offset <span class="bound">k</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offset <span class="skolem">k</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="skolem">k</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-offset_not_none_2"><span class="command">lemma</span></span> offset_not_none_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">⟶</span> offset <span class="free">k</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> not_None_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys'</span> <span class="bound">k'</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">⟶</span> offset <span class="bound">k'</span> <span class="free">x</span> <span class="main">(</span><span class="bound">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offset <span class="skolem">k</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> not_None_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span> <span class="skolem">ys'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">⟶</span> offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-offset_not_none"><span class="command">lemma</span></span> offset_not_none<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>offset <span class="free">k</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> offset_not_none_1<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> offset_not_none_2<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-offset_addition"><span class="command">lemma</span></span> offset_addition <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"offset <span class="free">k</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> None <span class="main">⟶</span> offset <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>offset <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">xs</span> <span class="skolem">k</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> offset <span class="bound">k</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None <span class="main">⟶</span>
      offset <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>offset <span class="bound">n</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offset <span class="skolem">k</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>offset <span class="skolem">n</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="skolem">k</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None <span class="main">⟶</span>
      offset <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>offset <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">=</span>
      Some <span class="main">(</span>the <span class="main">(</span>offset <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-offset_suc"><span class="command">lemma</span></span> offset_suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"offset <span class="free">k</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span>offset <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> offset <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>offset <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offset_addition<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span>offset <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_first_offset"><span class="command">lemma</span></span> ipurge_tr_rev_aux_first_offset <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="free">ys</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">ys</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys'</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span>
      J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sources_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span> <span class="main">⊆</span>
        sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sources_aux_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> L <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">0</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> offset <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offset <span class="main">0</span> <span class="free">x</span> <span class="skolem">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offset_not_none<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offset_suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">x'</span> <span class="main">#</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="free">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_append_nil_2"><span class="command">lemma</span></span> ipurge_tr_rev_aux_append_nil_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="free">xs</span> <span class="main">⟶</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">x</span> <span class="main">#</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span> <span class="bound">ws</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">vs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">ws</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="bound">ws</span><span class="main">)</span><span class="main">)</span> <span class="bound">vs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="bound">ws</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_first<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ws</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">ws</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_first_offset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        <span class="skolem">x</span> <span class="main">#</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span> <span class="bound">ws</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">vs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">ws</span> <span class="main">∧</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="bound">ws</span><span class="main">)</span><span class="main">)</span> <span class="bound">vs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="bound">ws</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_first<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ws</span> <span class="main">∧</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">ws</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> take <span class="main">(</span>the <span class="main">(</span>offset <span class="main">0</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_first_offset<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">V</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_append_nil"><span class="command">lemma</span></span> ipurge_tr_rev_aux_append_nil<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ipurge_tr_rev_aux_append_nil_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_tr_rev_aux_append_nil_1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, it is proven by induction that the lists output by functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as well as those output by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, satisfy predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Interleaves</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (cf. \cite{R2}), in correspondence
with suitable input predicates expressed in terms of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sinks</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sinks_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
respectively. Then, some lemmas on the aforesaid functions are demonstrated without induction, using
previous lemmas along with the properties of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Interleaves</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-Interleaves_ipurge_tr"><span class="command">lemma</span></span> Interleaves_ipurge_tr<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">D</span> <span class="bound">y</span> <span class="main">∈</span> sinks <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rev.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">D</span> <span class="bound">y</span> <span class="main">∈</span> sinks <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span>
    <span class="main">{</span>ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sources_sinks <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">#</span> <span class="var">?ys</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-Interleaves_ipurge_tr_aux"><span class="command">lemma</span></span> Interleaves_ipurge_tr_aux<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rev.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">,</span>
    rev <span class="main">(</span>ipurge_tr_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span>
    <span class="main">{</span>ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">,</span>
    rev <span class="main">(</span>ipurge_tr_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sources_sinks_aux<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">#</span> <span class="var">?ys</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_aux_all"><span class="command">lemma</span></span> ipurge_tr_aux_all<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">,</span>
    rev <span class="main">(</span>ipurge_tr_aux <span class="main">(</span><span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="main">(</span><span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≅</span> <span class="main">{</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_ipurge_tr_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span>ipurge_tr_rev_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">,</span> rev <span class="free">xs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≃</span> <span class="main">{</span>ipurge_tr_rev_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">,</span> rev <span class="free">xs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_interleaves<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≃</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> rev <span class="free">xs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleaves_nil_all<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleaves_equal_fst<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≃</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_interleaves<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≃</span> <span class="main">{</span>rev <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">λ</span><span class="bound">w</span> <span class="bound">ws</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">w</span> <span class="bound">ws</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> interleaves_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">≃</span> <span class="main">{</span>rev <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">λ</span><span class="bound">w</span> <span class="bound">ws</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">w</span> <span class="bound">ws</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleaves_all_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> rev <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interleaves_equal_fst<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_aux_single_dom"><span class="command">lemma</span></span> ipurge_tr_rev_aux_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="main">=</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">=</span> <span class="var">?ys'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span>rev <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_ipurge_tr_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">¯</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">¯</span><span class="main">)</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom sinks_aux_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys</span><span class="main">,</span> rev <span class="main">(</span>ipurge_tr <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">D</span> <span class="bound">y</span> <span class="main">∈</span> sinks <span class="main">(</span><span class="free">I</span><span class="main">¯</span><span class="main">)</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>rev <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≅</span> <span class="main">{</span><span class="main">_</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_interference_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≅</span> <span class="main">{</span><span class="var">?ys'</span><span class="main">,</span> <span class="var">?zs</span><span class="main">,</span> <span class="var">?P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_ipurge_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Interleaves_equal_fst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_all"><span class="command">lemma</span></span> ipurge_tr_all<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_all<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_all"><span class="command">lemma</span></span> ipurge_tr_rev_all<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_tr_rev_aux_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"A domain-relation map based on intransitive purge"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In what follows, constant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge›</span></span></span></span> is defined as the domain-relation map that associates
each domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> to the relation comprised of the pairs of traces whose images under function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are equal, viz. whose events affecting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> are the same.

An auxiliary domain set-relation map, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge_aux›</span></span></span></span>, is also defined by replacing
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so as to exploit the distributivity of the
latter function over list concatenation. Unsurprisingly, since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> degenerates
into <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for a singleton set of domains, the same happens for
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge_aux›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge›</span></span></span></span>.

Subsequently, some basic properties of domain-relation map <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge›</span></span></span></span> are proven, namely
that it is a view partition, and is future consistent if and only if it is weakly future consistent.
The nontrivial implication, viz. the direct one, derives from the fact that for each domain
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> allowed to be affected by any event domain, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> matches
the identity function, so that two traces are correlated by the image of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_ipurge›</span></span></span></span> under
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> just in case they are equal.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_ipurge</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_ipurge</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
  ipurge_tr_rev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">xs</span> <span class="main">=</span> ipurge_tr_rev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">ys</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_ipurge_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> domset_rel_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_ipurge_aux</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
  ipurge_tr_rev_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">xs</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">ys</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="IpurgeUnwinding-rel_ipurge_aux_single_dom"><span class="command">lemma</span></span> rel_ipurge_aux_single_dom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"rel_ipurge_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def rel_ipurge_aux_def ipurge_tr_rev_aux_single_dom<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-view_partition_rel_ipurge"><span class="command">lemma</span></span> view_partition_rel_ipurge<span class="main">:</span>
 <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> view_partition_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equivI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> refl_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-fc_equals_wfc_rel_ipurge"><span class="command">lemma</span></span> fc_equals_wfc_rel_ipurge<span class="main">:</span>
 <span class="quoted"><span class="quoted">"future_consistent <span class="free">P</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
  weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fc_implies_wfc<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> future_consistent_def weakly_future_consistent_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span> <span class="main">∧</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">zs</span><span class="main">.</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">zs</span> <span class="main">=</span> <span class="bound">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_tr_rev_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> imageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">-</span><span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The Ipurge Unwinding Theorem: proof of condition sufficiency"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The Ipurge Unwinding Theorem, formalized in what follows as theorem <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_unwinding›</span></span></span></span>, states
that a necessary and sufficient condition for the CSP noninterference security \cite{R1} of a
process being refusals union closed is that domain-relation map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rel_ipurge</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be weakly future
consistent. Notwithstanding the equivalence of future consistency and weak future consistency for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rel_ipurge</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (cf. above), expressing the theorem in terms of the latter reduces the range of
the domains to be considered in order to prove or disprove the security of a process, and then is
more convenient.

According to the definition of CSP noninterference security formulated in \cite{R1}, a process is
regarded as being secure just in case the occurrence of an event \emph{e} may only affect future
events allowed to be affected by \emph{e}. Identifying security with the weak future consistency of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rel_ipurge</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means reversing the view of the problem with respect to the direction of time. In
fact, from this view, a process is secure just in case the occurrence of an event \emph{e} may only
be affected by past events allowed to affect \emph{e}. Therefore, what the Ipurge Unwinding Theorem
proves is that ultimately, opposite perspectives with regard to the direction of time give rise to
equivalent definitions of the noninterference security of a process.

Here below, it is proven that the condition expressed by the Ipurge Unwinding Theorem is sufficient
for security.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_ipurge_tr_aux_1"><span class="command">lemma</span></span> ipurge_tr_rev_ipurge_tr_aux_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">⟶</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_nil<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="free">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append_nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">U</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟶</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> F <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_ipurge_tr_aux_2"><span class="command">lemma</span></span> ipurge_tr_rev_ipurge_tr_aux_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">⟶</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
  ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="free">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append_nil<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="free">xs</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">U</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟶</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">⟶</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> F <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span>
        <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
        <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
        <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ipurge_tr_rev_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_ipurge_tr_1"><span class="command">lemma</span></span> ipurge_tr_rev_ipurge_tr_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_aux_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom ipurge_tr_rev_aux_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-ipurge_tr_rev_ipurge_tr_2"><span class="command">lemma</span></span> ipurge_tr_rev_ipurge_tr_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_aux_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom ipurge_tr_rev_aux_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-iu_condition_imply_secure_aux_1"><span class="command">lemma</span></span> iu_condition_imply_secure_aux_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IU<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"singleton_set <span class="main">(</span>ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_some<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> IU <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">⟶</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">y'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="main">{</span><span class="skolem">y'</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="main">{</span><span class="skolem">y'</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> singleton_set_union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-iu_condition_imply_secure_aux_2"><span class="command">lemma</span></span> iu_condition_imply_secure_aux_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IU<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"singleton_set <span class="main">(</span>ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_some<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> IU <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z'</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">⟶</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z'</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">z'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">z'</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z'</span><span class="main">)</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">z'</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> singleton_set_union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-iu_condition_imply_secure_1"><span class="command">lemma</span></span> iu_condition_imply_secure_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IU<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y'</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">Y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span> <span class="skolem">ys</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="var">?Y'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> IU <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_interference_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">⟶</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_interference_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-iu_condition_imply_secure_2"><span class="command">lemma</span></span> iu_condition_imply_secure_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IU<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> <span class="bound">z'</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">Z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">[]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_aux_2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="var">?Z'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> IU <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_interference_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">⟶</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_interference_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_ipurge_tr_2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def next_events_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span>
    <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_aux_2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> iu_condition_imply_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    IU<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def futures_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">Y</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∧</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> IU <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iu_condition_imply_secure_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The Ipurge Unwinding Theorem: proof of condition necessity"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below, it is proven that the condition expressed by the Ipurge Unwinding Theorem is necessary
for security. Finally, the lemmas concerning condition sufficiency and necessity are gathered in the
main theorem.

\null
›</span></span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_failure_consistency_aux"><span class="command">lemma</span></span> secure_implies_failure_consistency_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">X</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_all<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_all<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_failure_consistency"><span class="command">lemma</span></span> secure_implies_failure_consistency <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_aux_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">zs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> secure_implies_failure_consistency_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">xs</span> <span class="skolem">zs</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs'</span> <span class="bound">zs'</span><span class="main">.</span> <span class="bound">xs'</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="bound">zs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs'</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="bound">zs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs'</span> <span class="main">@</span> <span class="bound">zs'</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="bound">zs'</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span> <span class="bound">ws</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="bound">ws</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="bound">ws</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_last_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ws</span> <span class="main">∧</span> ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_rev_aux_last_1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ws</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> secure_implies_failure_consistency_aux<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_rev_aux_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
      ipurge_tr_rev_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> set <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff futures_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_all<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_all<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_trace_consistency"><span class="command">lemma</span></span> secure_implies_trace_consistency<span class="main">:</span>
 <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> set <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> secure_implies_failure_consistency<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> process_rule_3<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_next_event_consistency"><span class="command">lemma</span></span> secure_implies_next_event_consistency<span class="main">:</span>
 <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def rel_ipurge_aux_single_dom <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> secure_implies_trace_consistency<span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_refusal_consistency"><span class="command">lemma</span></span> secure_implies_refusal_consistency<span class="main">:</span>
 <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_Nil2 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> secure_implies_failure_consistency<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="IpurgeUnwinding-secure_implies_ref_event_consistency"><span class="command">lemma</span></span> secure_implies_ref_event_consistency<span class="main">:</span>
 <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> secure_implies_refusal_consistency<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_aux_single_dom<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> secure_implies_iu_condition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"future_consistent <span class="free">P</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_consistent_def next_dom_events_def ref_dom_events_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> secure_implies_next_event_consistency<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> view_partition_rel_ipurge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> secure_implies_next_event_consistency<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> secure_implies_ref_event_consistency<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> view_partition_rel_ipurge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> secure_implies_ref_event_consistency<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ipurge_unwinding<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span> <span class="main">⟹</span>
  secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">=</span> weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> fc_equals_wfc_rel_ipurge <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> secure_implies_iu_condition<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iu_condition_imply_secure<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DeterministicProcesses">
<div class="head">
<h1>Theory DeterministicProcesses</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Ipurge Unwinding Theorem for CSP Noninterference Security
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Ipurge Unwinding Theorem for deterministic and trace set processes"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DeterministicProcesses
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#IpurgeUnwinding">IpurgeUnwinding</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In accordance with Hoare's formal definition of deterministic processes \cite{R3}, this section
shows that a process is deterministic just in case it is a \emph{trace set process}, i.e. it may be
identified by means of a trace set alone, matching the set of its traces, in place of a
failures-divergences pair. Then, variants of the Ipurge Unwinding Theorem are proven for
deterministic processes and trace set processes.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Deterministic processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below are the definitions of predicates <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d_future_consistent›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d_weakly_future_consistent›</span></span></span></span>, which are variants of predicates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">future_consistent</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">weakly_future_consistent</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> meant for applying to deterministic processes. In some detail,
being deterministic processes such that refused events are completely specified by accepted events
(cf. \cite{R3}, \cite{R1}), the new predicates are such that their truth values can be determined
by just considering the accepted events of the process taken as input.

Then, it is proven that these predicates are characterized by the same connection as that of their
general-purpose counterparts, viz. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d_future_consistent›</span></span></span></span> implies
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d_weakly_future_consistent›</span></span></span></span>, and they are equivalent for domain-relation map
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rel_ipurge</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Finally, the predicates are shown to be equivalent to their general-purpose
counterparts in the case of a deterministic process.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d_future_consistent</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">d_future_consistent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d_weakly_future_consistent</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">d_weakly_future_consistent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">``</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>

<span class="keyword1" id="DeterministicProcesses-dfc_implies_dwfc"><span class="command">lemma</span></span> dfc_implies_dwfc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"d_future_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span> d_weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> d_future_consistent_def d_weakly_future_consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-dfc_equals_dwfc_rel_ipurge"><span class="command">lemma</span></span> dfc_equals_dwfc_rel_ipurge<span class="main">:</span>
 <span class="quoted"><span class="quoted">"d_future_consistent <span class="free">P</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
  d_weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> dfc_implies_dwfc<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> d_future_consistent_def d_weakly_future_consistent_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="bound">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">zs</span><span class="main">.</span> ipurge_tr_rev <span class="free">I</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">zs</span> <span class="main">=</span> <span class="bound">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_tr_rev_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> imageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">-</span><span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-d_fc_equals_dfc"><span class="command">lemma</span></span> d_fc_equals_dfc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"future_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span> <span class="main">=</span> d_future_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> d_future_consistent_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fc_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_consistent_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ball_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span>
        A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-d_wfc_equals_dwfc"><span class="command">lemma</span></span> d_wfc_equals_dwfc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span> <span class="main">=</span> d_weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> d_weakly_future_consistent_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wfc_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ball_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">∧</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">D</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span>
        <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="skolem">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"refusals <span class="free">P</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below is the proof of a variant of the Ipurge Unwinding Theorem applying to deterministic
processes. Unsurprisingly, its enunciation contains predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">d_weakly_future_consistent</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in
place of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">weakly_future_consistent</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Furthermore, the assumption that the process be refusals
union closed is replaced by the assumption that it be deterministic, since the former property is
shown to be entailed by the latter.

\null
›</span></span>

<span class="keyword1" id="DeterministicProcesses-d_implies_ruc"><span class="command">lemma</span></span> d_implies_ruc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> ref_union_closed_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">A</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssubst <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> IntE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UN_E<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ex_in_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> d_ipurge_unwinding<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">=</span> d_weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> d_wfc_equals_dwfc <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_ipurge <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> d_implies_ruc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ipurge_unwinding<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Trace set processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In \cite{R3}, section 2.8, Hoare formulates a simplified definition of a deterministic process,
identified with a \emph{trace set}, i.e. a set of event lists containing the empty list and any
prefix of each of its elements. Of course, this is consistent with the definition of determinism
applying to processes identified with failures-divergences pairs, which implies that their refusals
are completely specified by their traces (cf. \cite{R3}, \cite{R1}).

Here below are the definitions of a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts_process›</span></span></span></span>, converting the input set of lists
into a process, and a predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>trace_set›</span></span></span></span>, returning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in case the input set
of lists has the aforesaid properties. An analysis is then conducted about the output of the
functions defined in \cite{R1}, section 1.1, when acting on a \emph{trace set process}, i.e. a
process that may be expressed as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts_process T›</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>trace_set T›</span></span></span></span> matches
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_process</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> process"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ts_process</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> Abs_process <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">trace_set</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DeterministicProcesses-ts_process_rep"><span class="command">lemma</span></span> ts_process_rep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> ts_process_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Abs_process_inverse<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 process_prop_1_def
 process_prop_2_def
 process_prop_3_def
 process_prop_4_def
 process_prop_5_def
 process_prop_6_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x'</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟶</span> <span class="skolem">xs</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">X</span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-ts_process_failures"><span class="command">lemma</span></span> ts_process_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span>
  failures <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ts_process_rep<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def<span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-ts_process_futures"><span class="command">lemma</span></span> ts_process_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span>
  futures <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
  <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def ts_process_failures<span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-ts_process_traces"><span class="command">lemma</span></span> ts_process_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span> traces <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">drule</span> ts_process_failures<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-ts_process_refusals"><span class="command">lemma</span></span> ts_process_refusals<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span>
  refusals <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ts_process_failures<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-ts_process_next_events"><span class="command">lemma</span></span> ts_process_next_events<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> next_events <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ts_process_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, the proof is given of two results which provide a connection between the notions of
deterministic and trace set processes: any trace set process is deterministic, and any process is
deterministic just in case it is equal to the trace set process corresponding to the set of its
traces.

\null
›</span></span>

<span class="keyword1" id="DeterministicProcesses-ts_process_d"><span class="command">lemma</span></span> ts_process_d<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span> deterministic <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">frule</span> ts_process_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> ts_process_refusals<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> IntE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">T</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equals0D<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divergences</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">divergences</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>Rep_process <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DeterministicProcesses-d_divergences"><span class="command">lemma</span></span> d_divergences<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"divergences <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> divergences_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equals0I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_5_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-trace_set_traces"><span class="command">lemma</span></span> trace_set_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> trace_set_def traces_def failures_def Domain_iff<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-d_implies_ts_process_traces"><span class="command">lemma</span></span> d_implies_ts_process_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span> <span class="main">⟹</span> ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_process_inject <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod_eq_iff failures_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">insert</span> trace_set_traces <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> ts_process_rep<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> d_divergences<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divergences_def deterministic_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_set <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"traces <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_process_traces<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"failures <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"refusals <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> traces <span class="free">P</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_process_refusals<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> refusals <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> equals0I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> IntE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> refusals <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> traces <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equals0D<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"refusals <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∉</span> traces <span class="free">P</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_process_refusals<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> refusals <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DeterministicProcesses-ts_process_traces_implies_d"><span class="command">lemma</span></span> ts_process_traces_implies_d<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">⟹</span> deterministic <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> trace_set_traces <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> ts_process_d<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="DeterministicProcesses-d_equals_ts_process_traces"><span class="command">lemma</span></span> d_equals_ts_process_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>ts_process <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> d_implies_ts_process_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ts_process_traces_implies_d<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, a variant of the Ipurge Unwinding Theorem applying to trace set processes is derived from
the variant for deterministic processes. Particularly, the assumption that the process be
deterministic is replaced by the assumption that it be a trace set process,
since the former property is entailed by the latter (cf. above).

\null
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ts_ipurge_unwinding<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span>
  secure <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span> <span class="main">=</span>
  d_weakly_future_consistent <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>rel_ipurge <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> d_ipurge_unwinding<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ts_process_d<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>