<div id="Fresh">
<div class="head">
<h1>Theory Fresh</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The type class <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fresh›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A type in this class comes with a mechanism to generate fresh
items. The fresh operator takes a list of items to be avoided, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>, and
a preferred element to be generated, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.

It is required that
implementations of fresh for specific types produce <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> if possible
(i.e., if not in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>).

While not required, it is also expected that, if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is not possible,
then implementation produces an element that is as close to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> as
possible, given a notion of distance.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> fresh <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">fresh</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh_notIn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> finite <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">fresh</span> <span class="bound">xs</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fresh_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">fresh</span> <span class="bound">xs</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type class <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">class</span><span class="hidden">&gt;</span></span></span>‹fresh›</span></span> is essentially the same as
the type class <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>infinite›</span></span></span></span> but with an emphasis on fresh item generation.›</span></span>

<span class="keyword1"><span class="command">class</span></span> infinite <span class="main">=</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infinite_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can subclass <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">class</span><span class="hidden">&gt;</span></span></span>‹fresh›</span></span> to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">class</span><span class="hidden">&gt;</span></span></span>‹infinite›</span></span> since the latter
has no associated operators (in particular, no additional operators w.r.t.
the former).›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fresh<span class="main">)</span> infinite
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> finite_list local.fresh_notIn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fresh_Nat">
<div class="head">
<h1>Theory Fresh_Nat</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fresh identifier generation for natural numbers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh_Nat
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Fresh">Fresh</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assuming <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ≤ y›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fresh2 xs x y›</span></span></span></span> returns an element
outside the interval <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x,y)›</span></span></span></span> that is fresh for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> and closest to this interval,
favoring smaller elements: ›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">fresh2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fresh2</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∨</span> infinite <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">else</span>
  <span class="free">fresh2</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Max <span class="bound">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le<span class="main">)</span>

<span class="keyword1" id="Fresh_Nat-fresh2_notIn"><span class="command">lemma</span></span> fresh2_notIn<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">xs</span> <span class="main">⟹</span> fresh2 <span class="free">xs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fresh2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Fresh_Nat-fresh2_eq"><span class="command">lemma</span></span> fresh2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">xs</span> <span class="main">⟹</span> fresh2 <span class="free">xs</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> fresh2.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">fresh</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fresh xs x y›</span></span></span></span> returns an element
that is fresh for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> and closest to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, favoring smaller elements: ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">fresh_nat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fresh_nat</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> fresh2 <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> fresh2_notIn fresh2_eq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> fresh_nat_def›</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Code generation›</span></span>

<span class="keyword1" id="Fresh_Nat-fresh2_list"><span class="command">lemma</span></span> fresh2_list<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh2 <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span>
      <span class="keyword1">if</span> <span class="free">y</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="keyword1">else</span>
      fresh2 <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh2.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some tests: ›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fresh <span class="main">{}</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fresh_String">
<div class="head">
<h1>Theory Fresh_String</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fresh identifier generation for strings›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh_String
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Fresh">Fresh</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A partial order on strings›</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹The first criterion is the length, and the second the encoding of last character. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ordst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ordst</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span>
 <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> of_char <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>of_char<span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ordstNS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ordstNS</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∨</span> ordst <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="keyword1" id="Fresh_String-ordst_antirefl"><span class="command">lemma</span></span> ordst_antirefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ordst <span class="free">X</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ordst_def<span class="main">)</span>

<span class="keyword1" id="Fresh_String-ordst_trans"><span class="command">lemma</span></span> ordst_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> As1<span class="main">:</span> <span class="quoted"><span class="quoted">"ordst <span class="free">X</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> As2<span class="main">:</span> <span class="quoted"><span class="quoted">"ordst <span class="free">Y</span> <span class="free">Z</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ordst <span class="free">X</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>length <span class="free">Y</span> <span class="main">&lt;</span> length <span class="free">Z</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>length <span class="free">Y</span> <span class="main">&lt;</span> length <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Y</span>"</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Y</span> <span class="main">≤</span> length <span class="free">Z</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> As2 ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Y</span> <span class="main">&lt;</span> length <span class="free">Z</span>"</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">X</span> <span class="main">≤</span> length <span class="free">Y</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> As1 ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Y</span> <span class="main">∨</span> length <span class="free">Y</span> <span class="main">&lt;</span> length <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Ft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="free">X</span> <span class="main">&lt;</span> length <span class="free">Y</span>  <span class="main">∧</span> <span class="main">¬</span> length <span class="free">Y</span> <span class="main">&lt;</span> length <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_char<span class="main">(</span>last <span class="free">X</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span>of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char<span class="main">(</span>last <span class="free">Z</span><span class="main">)</span> <span class="main">∧</span>
         length <span class="free">X</span> <span class="main">≤</span> length <span class="free">Y</span> <span class="main">∧</span> length <span class="free">Y</span> <span class="main">≤</span> length <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> As1 As2 ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_char<span class="main">(</span>last <span class="free">X</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char<span class="main">(</span>last <span class="free">Z</span><span class="main">)</span> <span class="main">∧</span>
         length <span class="free">X</span> <span class="main">≤</span> length <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">Z</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> As1 As2 Ft ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ordst_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fresh_String-ordstNS_refl"><span class="command">lemma</span></span> ordstNS_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"ordstNS <span class="free">X</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ordstNS_def<span class="main">)</span>

<span class="keyword1" id="Fresh_String-ordstNS_trans"><span class="command">lemma</span></span> ordstNS_trans<span class="main">:</span>
<span class="quoted"><span class="quoted">"ordstNS <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> ordstNS <span class="free">Y</span> <span class="free">Z</span> <span class="main">⟹</span> ordstNS <span class="free">X</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ordstNS_def ordst_trans<span class="main">)</span>

<span class="keyword1" id="Fresh_String-ordst_ordstNS_trans"><span class="command">lemma</span></span> ordst_ordstNS_trans<span class="main">:</span>
<span class="quoted"><span class="quoted">"ordst <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> ordstNS <span class="free">Y</span> <span class="free">Z</span> <span class="main">⟹</span> ordst <span class="free">X</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ordstNS_def ordst_trans<span class="main">)</span>

<span class="keyword1" id="Fresh_String-ordstNS_ordst_trans"><span class="command">lemma</span></span> ordstNS_ordst_trans<span class="main">:</span>
<span class="quoted"><span class="quoted">"ordstNS <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> ordst <span class="free">Y</span> <span class="free">Z</span> <span class="main">⟹</span> ordst <span class="free">X</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ordstNS_def ordst_trans<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Incrementing a string ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the last character is $\geq$ 'a' and $&lt;$ 'z',
   then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>upChar›</span></span></span></span> increments this last character;
   otherwise <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>upChar›</span></span></span></span> appends an 'a'.  ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upChar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">upChar</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> of_char<span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">97</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">∧</span>
               of_char<span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">122</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">@</span>
         <span class="main">[</span>char_of<span class="main">(</span>of_char<span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">@</span> <span class="inner_quoted">''a''</span>
 <span class="main">)</span>"</span></span>

<span class="keyword1" id="Fresh_String-upChar_ordst"><span class="command">lemma</span></span> upChar_ordst<span class="main">:</span> <span class="quoted"><span class="quoted">"ordst <span class="free">Y</span> <span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">Y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">97</span> <span class="main">::</span> nat<span class="main">)</span>
                       <span class="main">∧</span> of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">122</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"upChar <span class="free">Y</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">@</span> <span class="inner_quoted">''a''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> As<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">97</span> <span class="main">::</span> nat<span class="main">)</span>
                       <span class="main">∧</span> of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">122</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> Ft<span class="main">:</span> <span class="quoted"><span class="quoted">"upChar <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="free">Y</span><span class="main">)</span> <span class="main">@</span>
                     <span class="main">[</span>char_of<span class="main">(</span>of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">hence</span></span> Ft'<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> char_of<span class="main">(</span>of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"of_char<span class="main">(</span>last <span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">256</span> <span class="main">::</span> nat<span class="main">)</span>  <span class="main">=</span>
          <span class="main">(</span>of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">256</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_char<span class="main">(</span>last<span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span><span class="main">)</span>  <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">256</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">∧</span>
         of_char<span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">256</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> As Ft' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">ultimately</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_char <span class="main">(</span>last <span class="free">Y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>of_char <span class="main">(</span>last<span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">from</span></span> Ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Y</span> <span class="main">≤</span> length <span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ordst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The fresh-identifier operator›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fresh Xs Y›</span></span></span></span> changes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Y›</span></span></span></span> as little as possible so that
   it becomes disjoint from all strings in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Xs›</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">fresh_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string set <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
Up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">⟹</span> finite <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">⟹</span> <span class="free">fresh_string</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="free">fresh_string</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>
Fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">∨</span> infinite <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">⟹</span> <span class="free">fresh_string</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Xs</span><span class="main">,</span><span class="bound">Y</span><span class="main">)</span><span class="main">.</span> card <span class="bound">Xs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_gt_0_iff diff_Suc_less empty_iff<span class="main">)</span>

<span class="keyword1" id="Fresh_String-fresh_string_ordstNS"><span class="command">lemma</span></span> fresh_string_ordstNS<span class="main">:</span> <span class="quoted"><span class="quoted">"ordstNS <span class="free">Y</span> <span class="main">(</span>fresh_string <span class="free">Xs</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Xs</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fresh_string.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Up Fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up <span class="skolem">Y</span> <span class="skolem">Xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ordst <span class="skolem">Y</span> <span class="main">(</span>fresh_string <span class="main">(</span><span class="skolem">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upChar_ordst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> ordst_ordstNS_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ordstNS <span class="skolem">Y</span> <span class="main">(</span>fresh_string <span class="main">(</span><span class="skolem">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ordstNS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Up.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fresh <span class="skolem">Y</span> <span class="skolem">Xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ordstNS_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fresh_String-fresh_string_set"><span class="command">lemma</span></span> fresh_string_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Xs</span> <span class="main">⟹</span> fresh_string <span class="free">Xs</span> <span class="free">Y</span> <span class="main">∉</span> <span class="free">Xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Xs</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fresh_string.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Up Fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up <span class="skolem">Y</span> <span class="skolem">Xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fresh_string <span class="skolem">Xs</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">Xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fresh_string <span class="main">(</span><span class="skolem">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Up.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fresh_string <span class="main">(</span><span class="skolem">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="skolem">Y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Up.IH <span class="quoted"><span class="quoted">‹finite <span class="skolem">Xs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordst <span class="skolem">Y</span> <span class="main">(</span>fresh_string <span class="main">(</span><span class="skolem">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> upChar_ordst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> fresh_string_ordstNS ordst_ordstNS_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> ordst_antirefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Code generation:›</span></span>

<span class="keyword1" id="Fresh_String-fresh_string_if"><span class="command">lemma</span></span> fresh_string_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_string <span class="free">Xs</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free">Y</span> <span class="main">∈</span> <span class="free">Xs</span> <span class="main">∧</span> finite <span class="free">Xs</span> <span class="keyword1">then</span> fresh_string <span class="main">(</span><span class="free">Xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar <span class="free">Y</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> fresh_string_list<span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> fresh_string_if<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Xs</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some tests: ›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fresh_string <span class="main">{}</span> <span class="inner_quoted">''Abc''</span><span class="main">,</span>
        fresh_string <span class="main">{</span><span class="inner_quoted">''X''</span><span class="main">,</span> <span class="inner_quoted">''Abc''</span><span class="main">}</span> <span class="inner_quoted">''Abd''</span><span class="main">,</span>
        fresh_string <span class="main">{</span><span class="inner_quoted">''X''</span><span class="main">,</span> <span class="inner_quoted">''Y''</span><span class="main">}</span> <span class="inner_quoted">''Y''</span><span class="main">,</span>
        fresh_string <span class="main">{</span><span class="inner_quoted">''X''</span><span class="main">,</span> <span class="inner_quoted">''Yaa''</span><span class="main">,</span> <span class="inner_quoted">''Ya''</span><span class="main">,</span> <span class="inner_quoted">''Yaa''</span><span class="main">}</span> <span class="inner_quoted">''Ya''</span><span class="main">,</span>
        fresh_string <span class="main">{</span><span class="inner_quoted">''X''</span><span class="main">,</span> <span class="inner_quoted">''Yaa''</span><span class="main">,</span> <span class="inner_quoted">''Yz''</span><span class="main">,</span> <span class="inner_quoted">''Yza''</span><span class="main">}</span> <span class="inner_quoted">''Yz''</span><span class="main">,</span>
        fresh_string <span class="main">{</span><span class="inner_quoted">''X''</span><span class="main">,</span> <span class="inner_quoted">''Y''</span><span class="main">,</span> <span class="inner_quoted">''Yab''</span><span class="main">,</span> <span class="inner_quoted">''Y''</span><span class="main">}</span> <span class="inner_quoted">''Y''</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we do locale interpretation rather than class instantiation,
since <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹string›</span></span></span></span> is a type synonym for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹char list›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> fresh_string<span class="main">:</span> fresh <span class="keyword2"><span class="keyword">where</span></span> fresh <span class="main">=</span> <span class="quoted">fresh_string</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> fresh_string_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting to string literals›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_ascii</span> <span class="free"><span class="bound"><span class="entity">str</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">str</span></span></span><span class="main">.</span> <span class="main">¬</span>digit7 <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fresh_String-map_ascii_of_idem"><span class="command">lemma</span></span> map_ascii_of_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ascii <span class="free">str</span> <span class="main">⟹</span> map String.ascii_of <span class="free">str</span> <span class="main">=</span> <span class="free">str</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">str</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> String.ascii_of_idem<span class="main">)</span>

<span class="keyword1" id="Fresh_String-is_ascii_butlast"><span class="command">lemma</span></span> is_ascii_butlast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ascii <span class="free">str</span> <span class="main">⟹</span> is_ascii <span class="main">(</span>butlast <span class="free">str</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_butlastD<span class="main">)</span>

<span class="keyword1" id="Fresh_String-ascii_char_of"><span class="command">lemma</span></span> ascii_char_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="numeral">128</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>digit7 <span class="main">(</span>char_of <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> char_of_def bit_iff_odd<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ascii_of_char_of_idem <span class="main">=</span> ascii_char_of<span class="main">[</span><span class="operator">THEN</span> String.ascii_of_idem<span class="main">]</span>

<span class="keyword1" id="Fresh_String-is_ascii_upChar"><span class="command">lemma</span></span> is_ascii_upChar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ascii <span class="free">str</span> <span class="main">⟹</span> is_ascii <span class="main">(</span>upChar <span class="free">str</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascii_char_of is_ascii_butlast<span class="main">)</span>

<span class="keyword1" id="Fresh_String-is_ascii_fresh_string"><span class="command">lemma</span></span> is_ascii_fresh_string<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ascii <span class="free">Y</span> <span class="main">⟹</span> is_ascii <span class="main">(</span>fresh_string <span class="free">Xs</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Xs</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fresh_string.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Up Fresh<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Up <span class="skolem">Y</span> <span class="skolem">Xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Up.IH<span class="main">[</span><span class="operator">OF</span> is_ascii_upChar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_ascii <span class="skolem">Y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> Up.hyps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For string literals we can properly instantiate the class.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> String.literal <span class="main">::</span> <span class="quoted">fresh</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> literal.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">fresh_literal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal set <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fresh_string</span>
  <span class="keyword1"><span class="command">using</span></span> is_ascii_fresh_string
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fresh_string_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Code generation:›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> literal.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upChar_literal <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">upChar</span>
  <span class="keyword1"><span class="command">using</span></span> is_ascii_upChar
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Fresh_String-upChar_literal_upChar"><span class="command">lemma</span></span> upChar_literal_upChar<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"upChar_literal <span class="free">s</span> <span class="main">=</span> String.implode <span class="main">(</span>upChar <span class="main">(</span>String.explode <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_ascii_of_idem is_ascii_butlast ascii_of_char_of_idem<span class="main">)</span>

<span class="keyword1" id="Fresh_String-fresh_literal_if"><span class="command">lemma</span></span> fresh_literal_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh <span class="free">xs</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">∧</span> finite <span class="free">xs</span> <span class="keyword1">then</span> fresh <span class="main">(</span><span class="free">xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>upChar_literal <span class="free">y</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">intro</span> fresh_string_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fresh_literal_list<span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> fresh_literal_if<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">xs</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some tests: ›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fresh <span class="main">{}</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Abc''</span><span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''X''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Abc''</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Abd''</span><span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''X''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Y''</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">STR</span>  <span class="inner_quoted">''Y''</span><span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''X''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yaa''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Ya''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yaa''</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Ya''</span><span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''X''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yaa''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yz''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yza''</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Yz''</span><span class="main">)</span><span class="main">,</span>
        fresh <span class="main">{</span><span class="keyword1">STR</span> <span class="inner_quoted">''X''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Y''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Yab''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Y''</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Y''</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fresh_Infinite">
<div class="head">
<h1>Theory Fresh_Infinite</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fresh identifier generation for infinite types›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh_Infinite
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Fresh">Fresh</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a default fresh operator for infinite types
for which more specific (smarter) alternatives are not (yet) available. ›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> infinite<span class="main">)</span> <span class="entity">fresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fresh</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∨</span> infinite <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> infinite <span class="main">&lt;</span> fresh <span class="keyword2"><span class="keyword">where</span></span> fresh <span class="main">=</span> <span class="quoted">fresh</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_new_if_finite local.infinite_UNIV someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>