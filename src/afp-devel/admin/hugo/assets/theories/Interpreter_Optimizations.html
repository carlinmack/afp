<div id="Env">
<div class="head">
<h1>Theory Env</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Env
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Environment›</span></span>

<span class="keyword1"><span class="command">locale</span></span> env <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">empty</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'env</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'val</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'env</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">to_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    get_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="free">empty</span> <span class="free">x</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    get_add_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="main">(</span><span class="free">add</span> <span class="free">e</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    get_add_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">get</span> <span class="main">(</span><span class="free">add</span> <span class="free">e</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">get</span> <span class="free">e</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    to_list_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">to_list</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">get</span> <span class="free">e</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> get_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> get_add_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> get_add_neq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">singleton</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">singleton</span> <span class="main">≡</span> <span class="free">add</span> <span class="free">empty</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'env</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add</span> <span class="main">(</span><span class="free">add_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">from_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'env</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_list</span> <span class="main">≡</span> add_list <span class="free">empty</span>"</span></span>

<span class="keyword1" id="Env-from_list_correct"><span class="command">lemma</span></span> from_list_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">k</span> <span class="main">=</span> <span class="free">get</span> <span class="main">(</span>from_list <span class="free">xs</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> get_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> from_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> get_add_eq get_add_neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> from_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Env-from_list_Nil"><span class="command">lemma</span></span> from_list_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_list <span class="main">[]</span> <span class="main">=</span> <span class="free">empty</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> from_list_def<span class="main">)</span>

<span class="keyword1" id="Env-get_from_list_to_list"><span class="command">lemma</span></span> get_from_list_to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="main">(</span>from_list <span class="main">(</span><span class="free">to_list</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">get</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="main">(</span>from_list <span class="main">(</span><span class="free">to_list</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">get</span> <span class="free">e</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> to_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Env_list">
<div class="head">
<h1>Theory Env_list</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Env_list
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Env">Env</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List-based implementation of environment›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t <span class="main">=</span> T <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">≡</span> T <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t <span class="main">⇒</span> <span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'val</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Map.map_of <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t <span class="main">⇒</span> <span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> T <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">to_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_list</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Env_list-get_empty"><span class="command">lemma</span></span> get_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"get empty <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>

<span class="keyword1" id="Env_list-get_add_eq"><span class="command">lemma</span></span> get_add_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"get <span class="main">(</span>add <span class="free">e</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Env_list-get_add_neq"><span class="command">lemma</span></span> get_add_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> get <span class="main">(</span>add <span class="free">e</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> get <span class="free">e</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Env_list-to_list_correct"><span class="command">lemma</span></span> to_list_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>to_list <span class="free">e</span><span class="main">)</span> <span class="main">=</span> get <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> T <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>to_list <span class="free">e</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> get <span class="free">e</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> T <span class="skolem">xs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">global_interpretation</span></span> env_list<span class="main">:</span>
  env <span class="quoted">Env_list.empty</span> <span class="quoted">Env_list.get</span> <span class="quoted">Env_list.add</span> <span class="quoted">Env_list.to_list</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
    singleton <span class="main">=</span> <span class="quoted">env_list.singleton</span> <span class="keyword2"><span class="keyword">and</span></span>
    add_list <span class="main">=</span> <span class="quoted">env_list.add_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    from_list <span class="main">=</span> <span class="quoted">env_list.from_list</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_empty get_add_eq get_add_neq to_list_correct<span class="main">)</span>


<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">Env_list.empty</span></span> <span class="quoted"><span class="quoted">Env_list.get</span></span> <span class="quoted"><span class="quoted">Env_list.add</span></span> <span class="quoted"><span class="quoted">Env_list.to_list</span></span> <span class="quoted"><span class="quoted">singleton</span></span> <span class="quoted"><span class="quoted">add_list</span></span> <span class="quoted"><span class="quoted">from_list</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Env

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="List_util">
<div class="head">
<h1>Theory List_util</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> List_util
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">same_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  same_length_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">same_length</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  same_length_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">same_length</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">same_length</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">same_length</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="List_util-same_length_iff_eq_lengths"><span class="command">lemma</span></span> same_length_iff_eq_lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"same_length <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"same_length <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> same_length.induct<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"same_length <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_length_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv same_length_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List_util-same_length_Cons"><span class="command">lemma</span></span> same_length_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"same_length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="bound">ys'</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys'</span>"</span></span>
  <span class="quoted"><span class="quoted">"same_length <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">xs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"same_length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="bound">ys'</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> same_length.induct<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"same_length <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">xs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> same_length.induct<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">for_all2</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">where</span></span>
  for_all2_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">for_all2</span> <span class="free">r</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  for_all2_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">for_all2</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">for_all2</span> <span class="free">r</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">for_all2</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> for_all2_Nil<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> for_all2_Cons<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1" id="List_util-for_all2_refl"><span class="command">lemma</span></span> for_all2_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> for_all2 <span class="free">r</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="List_util-for_all2_same_length"><span class="command">lemma</span></span> for_all2_same_length<span class="main">:</span> <span class="quoted"><span class="quoted">"for_all2 <span class="free">r</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> same_length <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> for_all2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> same_length.intros<span class="main">)</span>

<span class="keyword1" id="List_util-for_all2_ConsD"><span class="command">lemma</span></span> for_all2_ConsD<span class="main">:</span> <span class="quoted"><span class="quoted">"for_all2 <span class="free">r</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> for_all2 <span class="free">r</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> for_all2.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹nth\_opt›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nth_opt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_opt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_opt</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nth_opt</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_opt</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="List_util-nth_opt_eq_Some_conv"><span class="command">lemma</span></span> nth_opt_eq_Some_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_opt <span class="free">xs</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nth_opt.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> nth_opt_eq_SomeD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> nth_opt_eq_Some_conv<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic lemmas›</span></span>

<span class="keyword1" id="List_util-map_list_update_id"><span class="command">lemma</span></span> map_list_update_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">instr</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">pc</span> <span class="main">:=</span> <span class="free">instr</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_update_id map_update <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="List_util-list_all_eq_const_imp_replicate"><span class="command">lemma</span></span> list_all_eq_const_imp_replicate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="List_util-list_all_eq_const_replicate_lhs"><span class="command">lemma</span></span> list_all_eq_const_replicate_lhs<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>

<span class="keyword1" id="List_util-list_all_eq_const_replicate_rhs"><span class="command">lemma</span></span> list_all_eq_const_replicate_rhs<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>

<span class="keyword1" id="List_util-replicate_eq_map"><span class="command">lemma</span></span> replicate_eq_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">g</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Option_applicative">
<div class="head">
<h1>Theory Option_applicative</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Option_applicative
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹
  Local_Theory.map_background_naming <span class="main">(</span>Name_Space.add_path <span class="inner_quoted">"Option"</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pure</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pure</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;*&gt;</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"Some <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">&lt;*&gt;</span></span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="free">&lt;*&gt;</span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Option_applicative-identity"><span class="command">lemma</span></span> identity<span class="main">:</span> <span class="quoted"><span class="quoted">"pure id <span class="main">&lt;*&gt;</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Option_applicative-homomorphism"><span class="command">lemma</span></span> homomorphism<span class="main">:</span> <span class="quoted"><span class="quoted">"pure <span class="free">f</span> <span class="main">&lt;*&gt;</span> pure <span class="free">x</span> <span class="main">=</span> pure <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_applicative-interchange"><span class="command">lemma</span></span> interchange<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">&lt;*&gt;</span> pure <span class="free">x</span> <span class="main">=</span> pure <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;*&gt;</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Option_applicative-composition"><span class="command">lemma</span></span> composition<span class="main">:</span> <span class="quoted"><span class="quoted">"pure <span class="main">(∘)</span> <span class="main">&lt;*&gt;</span> <span class="free">u</span> <span class="main">&lt;*&gt;</span> <span class="free">v</span> <span class="main">&lt;*&gt;</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">&lt;*&gt;</span> <span class="main">(</span><span class="free">v</span> <span class="main">&lt;*&gt;</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Result">
<div class="head">
<h1>Theory Result</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Result
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'err</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> result <span class="main">=</span>
  <span class="entity">is_err</span><span class="main">:</span> Error <span class="tfree"><span class="quoted"><span class="tfree">'err</span></span></span> <span class="main">|</span>
  <span class="entity">is_ok</span><span class="main">:</span> Ok <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Monadic bind›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> result<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span>Error <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Error <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span>Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  bind <span class="quoted">Result.bind</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-bind_Ok"><span class="command">lemma</span></span> bind_Ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⤜</span> Ok <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-bind_eq_Ok_conv"><span class="command">lemma</span></span> bind_eq_Ok_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> Ok <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Ok <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> Ok <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_OkD<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> bind_eq_Ok_conv<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_OkE <span class="main">=</span> bind_eq_OkD<span class="main">[</span><span class="operator">THEN</span> exE<span class="main">]</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_OkI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> conjI<span class="main">[</span><span class="operator">THEN</span> exI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> bind_eq_Ok_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-bind_eq_Error_conv"><span class="command">lemma</span></span> bind_eq_Error_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> Error <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Error <span class="free">z</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Ok <span class="bound">y</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> Error <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_ErrorD<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> bind_eq_Error_conv<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_ErrorE <span class="main">=</span> bind_eq_ErrorD<span class="main">[</span><span class="operator">THEN</span> disjE<span class="main">]</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> bind_eq_ErrorI <span class="main">=</span>
  disjI1<span class="main">[</span><span class="operator">THEN</span> bind_eq_Error_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">]</span>
  conjI<span class="main">[</span><span class="operator">THEN</span> exI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> disjI2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> bind_eq_Error_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1" id="Result-if_then_else_Ok"><span class="command">lemma</span></span> if_then_else_Ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> Error <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Ok <span class="free">d</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Ok <span class="free">d</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> Error <span class="free">c</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Ok <span class="free">d</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> Ok <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-if_then_else_Error"><span class="command">lemma</span></span> if_then_else_Error<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> Ok <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Error <span class="free">d</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> Error <span class="free">d</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">c</span> <span class="keyword1">else</span> Ok <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Error <span class="free">d</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> Error <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-map_eq_Ok_conv"><span class="command">lemma</span></span> map_eq_Ok_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map_result <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Ok <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Ok <span class="bound">x'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-map_eq_Error_conv"><span class="command">lemma</span></span> map_eq_Error_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map_result <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Error <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Error <span class="bound">x'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> map_eq_OkD<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> iffD1<span class="main">[</span><span class="operator">OF</span> map_eq_Ok_conv<span class="main">]</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemmas</span></span> map_eq_ErrorD<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> iffD1<span class="main">[</span><span class="operator">OF</span> map_eq_Error_conv<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Conversion functions›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_option</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_option</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None <span class="main">=</span> Error <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">of_option</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-of_option_injective"><span class="command">lemma</span></span> of_option_injective<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_option <span class="free">e</span> <span class="free">x</span> <span class="main">=</span> of_option <span class="free">e</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-of_option_eq_Ok"><span class="command">lemma</span></span> of_option_eq_Ok<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_option <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> Ok <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">to_option</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_option</span> <span class="main">(</span>Error <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">to_option</span> <span class="main">(</span>Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-to_option_Some"><span class="command">lemma</span></span> to_option_Some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_option <span class="free">r</span> <span class="main">=</span> Some <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> Ok <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">those</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'err</span><span class="main">,</span> <span class="tfree">'ok</span><span class="main">)</span> result list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'err</span><span class="main">,</span> <span class="tfree">'ok</span> list<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">those</span> <span class="main">[]</span> <span class="main">=</span> Ok <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">those</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">ys</span> <span class="main">←</span> <span class="free">those</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
    Ok <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Result-those_Cons_OkD"><span class="command">lemma</span></span> those_Cons_OkD<span class="main">:</span> <span class="quoted"><span class="quoted">"those <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Ok <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="bound">ys'</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Ok <span class="bound">y</span> <span class="main">∧</span> those <span class="free">xs</span> <span class="main">=</span> Ok <span class="bound">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Global">
<div class="head">
<h1>Theory Global</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Global
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <a href="#Result">Result</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sledgehammer_params</span></span> <span class="main">[</span>timeout <span class="main">=</span> 30<span class="main">]</span>
<span class="keyword1"><span class="command">sledgehammer_params</span></span> <span class="main">[</span>provers <span class="main">=</span> <span class="quoted">"cvc4 e spass vampire z3"</span><span class="main">]</span>

<span class="keyword1" id="Global-if_then_Some_else_None_eq"><span class="command">lemma</span></span> if_then_Some_else_None_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> Some <span class="free">b</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> Some <span class="free">b</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">¬</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Global-if_then_else_distributive"><span class="command">lemma</span></span> if_then_else_distributive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">traverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">traverse</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> Some <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">traverse</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x'</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">xs'</span> <span class="main">←</span> <span class="free">traverse</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
    Some <span class="main">(</span><span class="bound">x'</span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Global-traverse_length"><span class="command">lemma</span></span> traverse_length<span class="main">:</span> <span class="quoted"><span class="quoted">"traverse <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span> <span class="main">⟹</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Option.bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'instr</span> fundef <span class="main">=</span>
  Fundef <span class="main">(</span><span class="free"><span class="entity">body</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'instr</span> list"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">arity</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>

<span class="keyword1" id="Global-rel_fundef_arities"><span class="command">lemma</span></span> rel_fundef_arities<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef <span class="free">r</span> <span class="free">gd1</span> <span class="free">gd2</span> <span class="main">⟹</span> arity <span class="free">gd1</span> <span class="main">=</span> arity <span class="free">gd2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fundef.rel_sel<span class="main">)</span>

<span class="keyword1" id="Global-rel_fundef_body_length"><span class="command">lemma</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_fundef <span class="free">r</span> <span class="free">fd1</span> <span class="free">fd2</span> <span class="main">⟹</span> length <span class="main">(</span>body <span class="free">fd1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>body <span class="free">fd2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_lengthD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fundef.rel_sel<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">)</span> prog <span class="main">=</span>
  Prog <span class="main">(</span><span class="free"><span class="entity">fun_env</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'fenv</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">heap</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'henv</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">main_fun</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'fun</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'operand</span><span class="main">)</span> frame <span class="main">=</span>
  Frame <span class="tfree"><span class="quoted"><span class="tfree">'fun</span></span></span> <span class="main">(</span><span class="free"><span class="entity">prog_counter</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">operand_stack</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'operand</span> list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="tfree">'frame</span><span class="main">)</span> state <span class="main">=</span>
  State <span class="main">(</span><span class="free"><span class="entity">fun_env</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'fenv</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">heap</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'henv</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">callstack</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'frame</span> list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'instr</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'instr</span> <span class="main">⇒</span> <span class="tfree">'instr</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rewrite</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> list_update <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rewrite_fundef_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'instr</span> fundef <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'instr</span> <span class="main">⇒</span> <span class="tfree">'instr</span> fundef"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rewrite_fundef_body</span> <span class="main">(</span>Fundef <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Fundef <span class="main">(</span>rewrite <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> length_rewrite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> length_list_update<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> nth_rewrite_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> nth_list_update_eq<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> nth_rewrite_neq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> nth_list_update_neq<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> take_rewrite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> take_update_cancel<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> take_rewrite_swap <span class="main">=</span> take_update_swap<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> map_rewrite <span class="main">=</span> map_update<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> list_all2_rewrite_cong<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> list_all2_update_cong<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>

<span class="keyword1" id="Global-body_rewrite_fundef_body"><span class="command">lemma</span></span> body_rewrite_fundef_body<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>rewrite_fundef_body <span class="free">fd</span> <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> rewrite <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span> <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Global-arity_rewrite_fundef_body"><span class="command">lemma</span></span> arity_rewrite_fundef_body<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>rewrite_fundef_body <span class="free">fd</span> <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">fd</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Global-if_eq_const_conv"><span class="command">lemma</span></span> if_eq_const_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">w</span> <span class="main">∨</span> <span class="main">¬</span><span class="free">x</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Op">
<div class="head">
<h1>Theory Op</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Op
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹n-ary operations›</span></span>

<span class="keyword1"><span class="command">locale</span></span> nary_operations <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    𝔒𝔭_𝔄𝔯𝔦𝔱𝔶_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free">op</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">𝔒𝔭</span> <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="OpInl">
<div class="head">
<h1>Theory OpInl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> OpInl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Op">Op</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹n-ary operations›</span></span>

<span class="keyword1"><span class="command">locale</span></span> nary_operations_inl <span class="main">=</span>
  nary_operations <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'opinl</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'op</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ℑ𝔫𝔩_invertible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">opinl</span> <span class="main">⟹</span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free">opinl</span> <span class="main">=</span> <span class="free">op</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ℑ𝔫𝔩𝔒𝔭_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free">opinl</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free">opinl</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">𝔒𝔭</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free">opinl</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ℑ𝔫𝔩_ℑ𝔰ℑ𝔫𝔩<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">opinl</span> <span class="main">⟹</span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="free">opinl</span> <span class="free">xs</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="OpInl-ℑ𝔫𝔩_inj_on"><span class="command">lemma</span></span> ℑ𝔫𝔩_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">ℑ𝔫𝔩</span> <span class="main">{</span> <span class="bound">op</span> <span class="main">|</span> <span class="bound">op</span> <span class="bound">args</span><span class="main">.</span> <span class="free">ℑ𝔫𝔩</span> <span class="bound">op</span> <span class="bound">args</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">op<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">op<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">opinl<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">opinl<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="skolem">op<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ℑ𝔫𝔩</span> <span class="skolem">op<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="skolem">op<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">opinl<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="skolem">op<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">opinl<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">op<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">op<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ℑ𝔫𝔩_invertible<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">op<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ℑ𝔫𝔩_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩_dom</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">op</span> <span class="main">|</span> <span class="bound">op</span> <span class="bound">args</span><span class="main">.</span> <span class="free">ℑ𝔫𝔩</span> <span class="bound">op</span> <span class="bound">args</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">ℑ𝔫𝔩</span> ℑ𝔫𝔩_dom <span class="main">{</span> <span class="free">ℑ𝔫𝔩</span> <span class="bound">op</span> <span class="main">|</span> <span class="bound">op</span><span class="main">.</span> <span class="bound">op</span> <span class="main">∈</span> ℑ𝔫𝔩_dom<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_def
  <span class="keyword1"><span class="command">unfolding</span></span> image_def
  <span class="keyword1"><span class="command">using</span></span> ℑ𝔫𝔩_inj_on
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Dynamic">
<div class="head">
<h1>Theory Dynamic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Dynamic
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> dynval <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">is_false</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    not_true_and_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">is_true</span> <span class="free">d</span> <span class="main">∧</span> <span class="free">is_false</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Dynamic-false_not_true"><span class="command">lemma</span></span> false_not_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_false</span> <span class="free">d</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">is_true</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_true_and_false <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Dynamic-true_not_false"><span class="command">lemma</span></span> true_not_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_true</span> <span class="free">d</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">is_false</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_true_and_false <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Dynamic-is_true_and_is_false_implies_False"><span class="command">lemma</span></span> is_true_and_is_false_implies_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_true</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">is_false</span> <span class="free">d</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> true_not_false false_not_true <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Inca">
<div class="head">
<h1>Theory Inca</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Inca
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Global">Global</a> <a href="#OpInl">OpInl</a> <a href="#Env">Env</a> <a href="#Dynamic">Dynamic</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Language">VeriComp.Language</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Inline caching›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Static representation›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">)</span> instr <span class="main">=</span>
  IPush <span class="tfree"><span class="quoted"><span class="tfree">'dyn</span></span></span> <span class="main">|</span>
  IPop <span class="main">|</span>
  ILoad <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IStore <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IOp <span class="tfree"><span class="quoted"><span class="tfree">'op</span></span></span> <span class="main">|</span>
  IOpInl <span class="tfree"><span class="quoted"><span class="tfree">'opinl</span></span></span> <span class="main">|</span>
  ICJump <span class="quoted">nat</span> <span class="main">|</span>
  ICall <span class="tfree"><span class="quoted"><span class="tfree">'fun</span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dynamic representation›</span></span>

<span class="keyword1"><span class="command">locale</span></span> inca <span class="main">=</span>
  Fenv<span class="main">:</span> env <span class="quoted"><span class="free">F_empty</span></span> <span class="quoted"><span class="free">F_get</span></span> <span class="quoted"><span class="free">F_add</span></span> <span class="quoted"><span class="free">F_to_list</span></span> <span class="main">+</span>
  Henv<span class="main">:</span> env <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span> <span class="main">+</span>
  dynval <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="main">+</span>
  nary_operations_inl <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">F_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">)</span> instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'henv</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> list <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'op</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'dyn</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">final</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'dyn</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'dyn</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  
  step_push<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_pop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPop <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_load<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">heap_get</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_store<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">heap_add</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span>
    <span class="free">𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">F_add</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>rewrite_fundef_body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl_hit<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl_miss<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">F_add</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>rewrite_fundef_body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_true<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">is_true</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_false<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">is_false</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_call<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICall <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
    <span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_end<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inca-step_deterministic"><span class="command">lemma</span></span> step_deterministic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">→</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">→</span> <span class="free">s3</span> <span class="main">⟹</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">s3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.cases<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_true_and_is_false_implies_False<span class="main">)</span>

<span class="keyword1" id="Inca-final_finished"><span class="command">lemma</span></span> final_finished<span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="free">s</span> <span class="main">⟹</span> finished step <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finished_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"final <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> step <span class="free">s</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"step <span class="free">s</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹final <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases final.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_sem<span class="main">:</span> semantics <span class="quoted">step</span> <span class="quoted">final</span>
  <span class="keyword1"><span class="command">using</span></span> final_finished step_deterministic
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">load</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">)</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="free">load</span> <span class="main">(</span>Prog <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span><span class="main">)</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_lang<span class="main">:</span> language <span class="quoted">step</span> <span class="quoted">final</span> <span class="quoted">load</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Unboxed">
<div class="head">
<h1>Theory Unboxed</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Unboxed
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Global">Global</a> <a href="#Dynamic">Dynamic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span> Ubx1 <span class="main">|</span> Ubx2

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> unboxed <span class="main">=</span>
  <span class="entity">is_dyn_operand</span><span class="main">:</span> OpDyn <span class="tfree"><span class="quoted"><span class="tfree">'dyn</span></span></span> <span class="main">|</span>
  OpUbx1 <span class="tfree"><span class="quoted"><span class="tfree">'ubx1</span></span></span> <span class="main">|</span>
  OpUbx2 <span class="tfree"><span class="quoted"><span class="tfree">'ubx2</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">typeof</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">typeof</span> <span class="main">(</span>OpDyn <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">typeof</span> <span class="main">(</span>OpUbx1 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Some Ubx1"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">typeof</span> <span class="main">(</span>OpUbx2 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Some Ubx2"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cast_Dyn</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Dyn</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Dyn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cast_Ubx1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Ubx1</span> <span class="main">(</span>OpUbx1 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Ubx1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cast_Ubx2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Ubx2</span> <span class="main">(</span>OpUbx2 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_Ubx2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">locale</span></span> unboxedval <span class="main">=</span> dynval <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">box_ubx1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ubx1</span> <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'ubx1</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ubx2</span> <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'ubx2</span> option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    box_unbox_inverse<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">unbox_ubx1</span> <span class="free">d</span> <span class="main">=</span> Some <span class="free">u1</span> <span class="main">⟹</span> <span class="free">box_ubx1</span> <span class="free">u1</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">unbox_ubx2</span> <span class="free">d</span> <span class="main">=</span> Some <span class="free">u2</span> <span class="main">⟹</span> <span class="free">box_ubx2</span> <span class="free">u2</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unbox</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> unboxed option"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unbox</span> Ubx1 <span class="main">=</span> map_option OpUbx1 <span class="main">∘</span> <span class="free">unbox_ubx1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unbox</span> Ubx2 <span class="main">=</span> map_option OpUbx2 <span class="main">∘</span> <span class="free">unbox_ubx2</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cast_and_box</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_and_box</span> Ubx1 <span class="main">=</span> map_option <span class="free">box_ubx1</span> <span class="main">∘</span> cast_Ubx1"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cast_and_box</span> Ubx2 <span class="main">=</span> map_option <span class="free">box_ubx2</span> <span class="main">∘</span> cast_Ubx2"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm_unboxed</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_unboxed</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_unboxed</span> <span class="main">(</span>OpUbx1 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">box_ubx1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_unboxed</span> <span class="main">(</span>OpUbx2 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">box_ubx2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">box_operand</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">box_operand</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">box_operand</span> <span class="main">(</span>OpUbx1 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> OpDyn <span class="main">(</span><span class="free">box_ubx1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">box_operand</span> <span class="main">(</span>OpUbx2 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> OpDyn <span class="main">(</span><span class="free">box_ubx2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">box_frame</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">box_frame</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">then</span> map box_operand <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">box_stack</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">box_stack</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> map <span class="main">(</span>box_frame <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="OpUbx">
<div class="head">
<h1>Theory OpUbx</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> OpUbx
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#OpInl">OpInl</a> <a href="#Unboxed">Unboxed</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹n-ary operations›</span></span>

<span class="keyword1"><span class="command">locale</span></span> nary_operations_ubx <span class="main">=</span>
  nary_operations_inl <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span> <span class="main">+</span>
  unboxedval <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="quoted"><span class="free">box_ubx1</span></span> <span class="quoted"><span class="free">unbox_ubx1</span></span> <span class="quoted"><span class="free">box_ubx2</span></span> <span class="quoted"><span class="free">unbox_ubx2</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> list <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'op</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ubx1</span> <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ubx2</span> <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx2</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opubx</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> unboxed list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> unboxed option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔘𝔟𝔵</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> type option list <span class="main">⇒</span> <span class="tfree">'opubx</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔅𝔬𝔵</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opubx</span> <span class="main">⇒</span> <span class="tfree">'opinl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opubx</span> <span class="main">⇒</span> type option list <span class="main">×</span> type option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    𝔘𝔟𝔵_invertible<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵</span> <span class="free">opinl</span> <span class="free">ts</span> <span class="main">=</span> Some <span class="free">opubx</span> <span class="main">⟹</span> <span class="free">𝔅𝔬𝔵</span> <span class="free">opubx</span> <span class="main">=</span> <span class="free">opinl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝔘𝔟𝔵𝔒𝔭_correct<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="free">opubx</span> <span class="free">Σ</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free">opubx</span><span class="main">)</span> <span class="main">(</span>map norm_unboxed <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> norm_unboxed <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝔘𝔟𝔵𝔒𝔭_to_ℑ𝔫𝔩<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="free">opubx</span> <span class="free">Σ</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map norm_unboxed <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free">opubx</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    
    𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_𝔄𝔯𝔦𝔱𝔶<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="main">(</span><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free">opubx</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝔘𝔟𝔵_opubx_type<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵</span> <span class="free">opinl</span> <span class="free">ts</span> <span class="main">=</span> Some <span class="free">opubx</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free">opubx</span><span class="main">)</span> <span class="main">=</span> <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_correct<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free">opubx</span> <span class="main">=</span> <span class="main">(</span>map typeof <span class="free">xs</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="free">opubx</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> typeof <span class="bound">y</span> <span class="main">=</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_complete<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="free">opubx</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free">opubx</span> <span class="main">=</span> <span class="main">(</span>map typeof <span class="free">xs</span><span class="main">,</span> typeof <span class="free">y</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Ubx">
<div class="head">
<h1>Theory Ubx</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Ubx
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Global">Global</a> <a href="#OpUbx">OpUbx</a> <a href="#Env">Env</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Language">VeriComp.Language</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unboxed caching›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">,</span> <span class="tfree">'opubx</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> instr <span class="main">=</span>
  IPush <span class="tfree"><span class="quoted"><span class="tfree">'dyn</span></span></span> <span class="main">|</span> IPushUbx1 <span class="tfree"><span class="quoted"><span class="tfree">'num</span></span></span> <span class="main">|</span> IPushUbx2 <span class="tfree"><span class="quoted"><span class="tfree">'bool</span></span></span> <span class="main">|</span>
  IPop <span class="main">|</span>
  ILoad <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span> ILoadUbx <span class="quoted">type</span> <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IStore <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span> IStoreUbx <span class="quoted">type</span> <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IOp <span class="tfree"><span class="quoted"><span class="tfree">'op</span></span></span> <span class="main">|</span>
  IOpInl <span class="tfree"><span class="quoted"><span class="tfree">'opinl</span></span></span> <span class="main">|</span>
  IOpUbx <span class="tfree"><span class="quoted"><span class="tfree">'opubx</span></span></span> <span class="main">|</span>
  <span class="entity">is_jump</span><span class="main">:</span> ICJump <span class="quoted">nat</span> <span class="main">|</span>
  <span class="entity">is_fun_call</span><span class="main">:</span> ICall <span class="tfree"><span class="quoted"><span class="tfree">'fun</span></span></span>

<span class="keyword1"><span class="command">locale</span></span> ubx <span class="main">=</span>
  Fenv<span class="main">:</span> env <span class="quoted"><span class="free">F_empty</span></span> <span class="quoted"><span class="free">F_get</span></span> <span class="quoted"><span class="free">F_add</span></span> <span class="quoted"><span class="free">F_to_list</span></span> <span class="main">+</span>
  Henv<span class="main">:</span> env <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span> <span class="main">+</span>
  nary_operations_ubx
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span>
    <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="quoted"><span class="free">box_ubx1</span></span> <span class="quoted"><span class="free">unbox_ubx1</span></span> <span class="quoted"><span class="free">box_ubx2</span></span> <span class="quoted"><span class="free">unbox_ubx2</span></span>
    <span class="quoted"><span class="free">𝔘𝔟𝔵𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔘𝔟𝔵</span></span> <span class="quoted"><span class="free">𝔅𝔬𝔵</span></span> <span class="quoted"><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="comment1">― ‹Functions environment›</span>
    <span class="free">F_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">,</span> <span class="tfree">'opubx</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Memory heap›</span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'henv</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Unboxed values›</span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹n-ary operations›</span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> list <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'op</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opubx</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> unboxed list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> unboxed option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔘𝔟𝔵</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> type option list <span class="main">⇒</span> <span class="tfree">'opubx</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔅𝔬𝔵</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opubx</span> <span class="main">⇒</span> <span class="tfree">'opinl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">generalize_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="main">(</span>IPushUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> IPush <span class="main">(</span><span class="free">box_ubx1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="main">(</span>IPushUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> IPush <span class="main">(</span><span class="free">box_ubx2</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="main">(</span>ILoadUbx <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="main">(</span>IStoreUbx <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="main">(</span>IOpUbx <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="main">=</span> IOpInl <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_instr</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">generalize_fundef</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalize_fundef</span> <span class="main">(</span>Fundef <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span> Fundef <span class="main">(</span>map generalize_instr <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span>"</span></span>

<span class="keyword1" id="Ubx-generalize_instr_idempotent"><span class="command">lemma</span></span> generalize_instr_idempotent<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"generalize_instr <span class="main">(</span>generalize_instr <span class="free">x</span><span class="main">)</span> <span class="main">=</span> generalize_instr <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Ubx-generalize_instr_idempotent_comp"><span class="command">lemma</span></span> generalize_instr_idempotent_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"generalize_instr <span class="main">∘</span> generalize_instr <span class="main">=</span> generalize_instr"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Ubx-generalize_fundef_length"><span class="command">lemma</span></span> generalize_fundef_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>body <span class="main">(</span>generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Ubx-body_generalize_fundef"><span class="command">lemma</span></span> body_generalize_fundef<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="main">(</span>generalize_fundef <span class="free">fd</span><span class="main">)</span> <span class="main">=</span> map generalize_instr <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Ubx-arity_generalize_fundef"><span class="command">lemma</span></span> arity_generalize_fundef<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>generalize_fundef <span class="free">fd2</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">fd2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd2</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">final</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">final</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  step_push<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_push_ubx1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPushUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_push_ubx2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPushUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_pop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPop <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_load<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">⟹</span> <span class="free">heap_get</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_load_ubx_hit<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ILoadUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">⟹</span> <span class="free">heap_get</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> unbox <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">blob</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">blob</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_load_ubx_miss<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ILoadUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">⟹</span> <span class="free">heap_get</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> unbox <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> None <span class="main">⟹</span>
    <span class="free">F_add</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>generalize_fundef <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>box_stack <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_store<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">⟹</span> cast_Dyn <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">heap_add</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_store_ubx<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IStoreUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">⟹</span> cast_and_box <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">blob</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">heap_add</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">blob</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    traverse cast_Dyn <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span>
    <span class="free">ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    traverse cast_Dyn <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span>
    <span class="free">ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">F_add</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>rewrite_fundef_body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl_hit<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    traverse cast_Dyn <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span>
    <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_inl_miss<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    traverse cast_Dyn <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span>
    <span class="main">¬</span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">⟹</span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">F_add</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>rewrite_fundef_body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F'</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op_ubx<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOpUbx <span class="free"><span class="bound"><span class="entity">opubx</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opubx</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_true<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">is_true</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_false<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    cast_Dyn <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">is_false</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_call<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICall <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
    <span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> list_all is_dyn_operand <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">0</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_end<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> step_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">→</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">→</span> <span class="free">s3</span> <span class="main">⟹</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">s3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">erule</span> step.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_true_and_is_false_implies_False<span class="main">)</span>

<span class="keyword1" id="Ubx-final_finished"><span class="command">lemma</span></span> final_finished<span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="free">s</span> <span class="main">⟹</span> finished step <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finished_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"final <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> step <span class="free">s</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"step <span class="free">s</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹final <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases final.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ubx_sem<span class="main">:</span> semantics <span class="quoted">step</span> <span class="quoted">final</span>
  <span class="keyword1"><span class="command">using</span></span> final_finished step_deterministic
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">load</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">)</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="free">load</span> <span class="main">(</span>Prog <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span><span class="main">)</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_lang<span class="main">:</span> language <span class="quoted">step</span> <span class="quoted">final</span> <span class="quoted">load</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Ubx_type_inference">
<div class="head">
<h1>Theory Ubx_type_inference</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Ubx_type_inference  
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Result">Result</a> <a href="#Ubx">Ubx</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Type of operations›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ubx_sp <span class="main">=</span>
  ubx
    <span class="quoted"><span class="free">F_empty</span></span> <span class="quoted"><span class="free">F_get</span></span> <span class="quoted"><span class="free">F_add</span></span> <span class="quoted"><span class="free">F_to_list</span></span>
    <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="quoted"><span class="free">box_ubx1</span></span> <span class="quoted"><span class="free">unbox_ubx1</span></span> <span class="quoted"><span class="free">box_ubx2</span></span> <span class="quoted"><span class="free">unbox_ubx2</span></span>
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔘𝔟𝔵𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔘𝔟𝔵</span></span> <span class="quoted"><span class="free">𝔅𝔬𝔵</span></span> <span class="quoted"><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="comment1">― ‹Functions environment›</span>
    <span class="free">F_empty</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_get</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Memory heap›</span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_get</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Unboxed values›</span>
    <span class="free">is_true</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹n-ary operations›</span>
    <span class="free">𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔘𝔟𝔵</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔅𝔬𝔵</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Strongest postcondition of instructions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sp_gen_pop_push</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_gen_pop_push</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">domain</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">codom</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ar</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">domain</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">ar</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">∧</span> take <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domain</span></span></span> <span class="keyword1">then</span>
      Ok <span class="main">(</span><span class="free"><span class="bound"><span class="entity">codom</span></span></span> <span class="main">#</span> drop <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      Error <span class="main">()</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sp_instr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">_</span> fundef option<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> type option list <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> type option list<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPush <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPushUbx1 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>Some Ubx1 <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPushUbx2 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>Some Ubx2 <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> IPop <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>ILoad <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>ILoadUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IStore <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IStoreUbx <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> Some <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">then</span> Ok <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="keyword1">else</span> Error <span class="main">()</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> sp_gen_pop_push <span class="main">(</span>replicate <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> sp_gen_pop_push <span class="main">(</span>replicate <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOpUbx <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> sp_gen_pop_push <span class="main">(</span><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">fd</span> <span class="main">←</span> Result.of_option <span class="main">()</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    sp_gen_pop_push <span class="main">(</span>replicate <span class="main">(</span>arity <span class="bound">fd</span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>
  <span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Error <span class="main">()</span>"</span></span>

<span class="keyword1" id="Ubx_type_inference-sp_instr_no_jump"><span class="command">lemma</span></span> sp_instr_no_jump<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="free">instr</span> <span class="free">Σ</span> <span class="main">=</span> Ok <span class="free">type</span> <span class="main">⟹</span> <span class="main">¬</span> is_jump <span class="free">instr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">instr</span></span> <span class="quoted"><span class="free">Σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sp_instr.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Ubx_type_inference-map_constant"><span class="command">lemma</span></span> map_constant<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">y</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1" id="Ubx_type_inference-sp_generalize_instr"><span class="command">lemma</span></span> sp_generalize_instr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="free">x</span> <span class="free">Σ</span> <span class="main">=</span> Ok <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="main">(</span>generalize_instr <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sp_instr.induct<span class="main"><span class="keyword3">;</span></span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def take_map drop_map<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ opubx
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def take_map drop_map map_replicate_const 𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_𝔄𝔯𝔦𝔱𝔶<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Ubx_type_inference-map_typeof_box"><span class="command">lemma</span></span> map_typeof_box<span class="main">:</span> <span class="quoted"><span class="quoted">"map typeof <span class="main">(</span>map box_operand <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">Σ</span><span class="main">)</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Strongest postcondition of function definitions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">_</span> fundef option<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span> list <span class="main">⇒</span> type option list <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> type option list<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sp</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">Σ'</span> <span class="main">←</span> sp_instr <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">;</span>
    <span class="free">sp</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">Σ'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Ubx_type_inference-sp_no_jump"><span class="command">lemma</span></span> sp_no_jump<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="free">Σ</span> <span class="main">=</span> Ok <span class="free">type</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> is_jump <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sp_instr_no_jump<span class="main">)</span>

<span class="keyword1" id="Ubx_type_inference-sp_append"><span class="command">lemma</span></span> sp_append<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">Σ</span> <span class="main">=</span> sp <span class="free">F</span> <span class="free">xs</span> <span class="free">Σ</span> <span class="main">⤜</span> sp <span class="free">F</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="skolem">x</span> <span class="skolem">Σ</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sp_eq_bind_take_drop <span class="main">=</span>
  sp_append<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">n</span> <span class="free">xs</span><span class="main">,</span> <span class="operator">unfolded</span> append_take_drop_id<span class="main">]</span>

<span class="keyword1" id="Ubx_type_inference-sp_generalize"><span class="command">lemma</span></span> sp_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="free">Σ</span> <span class="main">=</span> Ok <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span>map generalize_instr <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">Σ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="skolem">x</span> <span class="skolem">Σ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Error <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ok <span class="skolem">Σ''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons sp_generalize_instr<span class="main">[</span><span class="operator">OF</span> Ok<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ok<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ubx_type_inference-sp_generalize2"><span class="command">lemma</span></span> sp_generalize2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="main">(</span>replicate <span class="free">n</span> None<span class="main">)</span> <span class="main">=</span> Ok <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span>map generalize_instr <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> None<span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> sp_generalize <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Ubx_type_inference-comp_K"><span class="command">lemma</span></span> comp_K<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">x</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ubx_type_inference-is_ok_sp_generalize"><span class="command">lemma</span></span> is_ok_sp_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="free">xs</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="main">(</span>map generalize_instr <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Ok <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ok_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sp_generalize<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ubx_type_inference-is_ok_sp_generalize2"><span class="command">lemma</span></span> is_ok_sp_generalize2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="free">xs</span> <span class="main">(</span>replicate <span class="free">n</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="main">(</span>map generalize_instr <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms is_ok_sp_generalize
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ex_list_of_length map_replicate_const<span class="main">)</span>

<span class="keyword1" id="Ubx_type_inference-sp_instr_op"><span class="command">lemma</span></span> sp_instr_op<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free">opinl</span> <span class="main">=</span> <span class="free">op</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_instr <span class="free">F</span> <span class="main">(</span>IOp <span class="free">op</span><span class="main">)</span> <span class="free">Σ</span> <span class="main">=</span> sp_instr <span class="free">F</span> <span class="main">(</span>IOpInl <span class="free">opinl</span><span class="main">)</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sp_instr.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">F</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>IOp <span class="free"><span class="free"><span class="free">op</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">Σ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def assms<span class="main">)</span>

<span class="keyword1" id="Ubx_type_inference-sp_list_update"><span class="command">lemma</span></span> sp_list_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Σ</span><span class="main">.</span> sp_instr <span class="free">F</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="bound">Σ</span> <span class="main">=</span> sp_instr <span class="free">F</span> <span class="free">x</span> <span class="bound">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sp <span class="free">F</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> sp <span class="free">F</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sp_append
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> sp <span class="free">F</span> <span class="free">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_conv_take_nth_drop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ubx_type_inference-sp_list_update_eq_Ok"><span class="command">lemma</span></span> sp_list_update_eq_Ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Σ</span><span class="main">.</span> sp_instr <span class="free">F</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="bound">Σ</span> <span class="main">=</span> sp_instr <span class="free">F</span> <span class="free">x</span> <span class="bound">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Ok <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> Ok <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_list_update<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

<span class="keyword1" id="Ubx_type_inference-is_ok_sp_list_update"><span class="command">lemma</span></span> is_ok_sp_list_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="free">xs</span> <span class="free">types</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Σ</span><span class="main">.</span> sp_instr <span class="free">F</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="bound">Σ</span> <span class="main">=</span> sp_instr <span class="free">F</span> <span class="free">instr</span> <span class="bound">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ok <span class="main">(</span>sp <span class="free">F</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">pc</span> <span class="main">:=</span> <span class="free">instr</span><span class="main">]</span><span class="main">)</span> <span class="free">types</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">types'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sp <span class="free">F</span> <span class="free">xs</span> <span class="free">types</span> <span class="main">=</span> Ok <span class="skolem">types'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_ok_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sp_list_update<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sp_rewrite <span class="main">=</span> sp_list_update<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> sp_rewrite_eq_Ok <span class="main">=</span> sp_list_update_eq_Ok<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> is_ok_sp_rewrite <span class="main">=</span> is_ok_sp_list_update<span class="main">[</span><span class="operator">folded</span> rewrite_def<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Unboxed_lemmas">
<div class="head">
<h1>Theory Unboxed_lemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Unboxed_lemmas
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Unboxed">Unboxed</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Unboxed_lemmas-typeof_bind_OpDyn"><span class="command">lemma</span></span> typeof_bind_OpDyn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typeof <span class="main">∘</span> OpDyn <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Unboxed_lemmas-is_dyn_operand_eq_typeof"><span class="command">lemma</span></span> is_dyn_operand_eq_typeof<span class="main">:</span> <span class="quoted"><span class="quoted">"is_dyn_operand <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> typeof <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_dyn_operand <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>typeof <span class="skolem">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unboxed_lemmas-is_dyn_operand_eq_typeof_Dyn"><span class="command">lemma</span></span> is_dyn_operand_eq_typeof_Dyn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_dyn_operand <span class="free">x</span> <span class="main">⟷</span> typeof <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-typeof_unboxed_eq_const"><span class="command">lemma</span></span> typeof_unboxed_eq_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"typeof <span class="free">x</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> OpDyn <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"typeof <span class="free">x</span> <span class="main">=</span> Some Ubx1 <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> OpUbx1 <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"typeof <span class="free">x</span> <span class="main">=</span> Some Ubx2 <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> OpUbx2 <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> typeof_unboxed_inversion <span class="main">=</span> typeof_unboxed_eq_const<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>

<span class="keyword1" id="Unboxed_lemmas-cast_inversions"><span class="command">lemma</span></span> cast_inversions<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cast_Dyn <span class="free">x</span> <span class="main">=</span> Some <span class="free">d</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> OpDyn <span class="free">d</span>"</span></span>
  <span class="quoted"><span class="quoted">"cast_Ubx1 <span class="free">x</span> <span class="main">=</span> Some <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> OpUbx1 <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"cast_Ubx2 <span class="free">x</span> <span class="main">=</span> Some <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> OpUbx2 <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Unboxed_lemmas-traverse_cast_Dyn_replicate"><span class="command">lemma</span></span> traverse_cast_Dyn_replicate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"traverse cast_Dyn <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map typeof <span class="free">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> unboxedval <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Unboxed_lemmas-unbox_typeof"><span class="command">lemma</span></span> unbox_typeof<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unbox <span class="free">τ</span> <span class="free">d</span> <span class="main">=</span> Some <span class="free">blob</span> <span class="main">⟹</span> typeof <span class="free">blob</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">τ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-cast_and_box_imp_typeof"><span class="command">lemma</span></span> cast_and_box_imp_typeof<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cast_and_box <span class="free">τ</span> <span class="free">blob</span> <span class="main">=</span> Some <span class="free">d</span> <span class="main">⟹</span> typeof <span class="free">blob</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cast_inversions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">blob</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">blob</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-norm_unbox_inverse"><span class="command">lemma</span></span> norm_unbox_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unbox <span class="free">τ</span> <span class="free">d</span> <span class="main">=</span> Some <span class="free">blob</span> <span class="main">⟹</span> norm_unboxed <span class="free">blob</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> box_unbox_inverse
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">τ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-norm_cast_and_box_inverse"><span class="command">lemma</span></span> norm_cast_and_box_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cast_and_box <span class="free">τ</span> <span class="free">blob</span> <span class="main">=</span> Some <span class="free">d</span> <span class="main">⟹</span> norm_unboxed <span class="free">blob</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cast_Dyn.elims cast_Ubx1.elims cast_Ubx2.elims<span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-typeof_and_norm_unboxed_imp_cast_and_box"><span class="command">lemma</span></span> typeof_and_norm_unboxed_imp_cast_and_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"typeof <span class="free">x'</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"norm_unboxed <span class="free">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cast_and_box <span class="free">τ</span> <span class="free">x'</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">x'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-norm_unboxed_bind_OpDyn"><span class="command">lemma</span></span> norm_unboxed_bind_OpDyn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm_unboxed <span class="main">∘</span> OpDyn <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> box_stack_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> list.map<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"box_frame <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">f</span><span class="main">,</span> <span class="operator">folded</span> box_stack_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> box_stack_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> list.map<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"box_frame <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">f</span><span class="main">,</span> <span class="operator">folded</span> box_stack_def<span class="main">]</span>

<span class="keyword1" id="Unboxed_lemmas-typeof_box_operand"><span class="command">lemma</span></span> typeof_box_operand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typeof <span class="main">(</span>box_operand <span class="free">x</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Unboxed_lemmas-is_dyn_box_operand"><span class="command">lemma</span></span> is_dyn_box_operand<span class="main">:</span> <span class="quoted"><span class="quoted">"is_dyn_operand <span class="main">(</span>box_operand <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Unboxed_lemmas-is_dyn_operand_comp_box_operand"><span class="command">lemma</span></span> is_dyn_operand_comp_box_operand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_dyn_operand <span class="main">∘</span> box_operand <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_dyn_box_operand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Unboxed_lemmas-norm_box_operand"><span class="command">lemma</span></span> norm_box_operand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm_unboxed <span class="main">(</span>box_operand <span class="free">x</span><span class="main">)</span> <span class="main">=</span> norm_unboxed <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Inca_to_Ubx_simulation">
<div class="head">
<h1>Theory Inca_to_Ubx_simulation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Inca_to_Ubx_simulation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#List_util">List_util</a> <a href="#Option_applicative">Option_applicative</a> <a href="#Result">Result</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Simulation">VeriComp.Simulation</a>"</span>
    <a href="#Inca">Inca</a> <a href="#Ubx">Ubx</a> <a href="#Ubx_type_inference">Ubx_type_inference</a> <a href="#Unboxed_lemmas">Unboxed_lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Locale imports›</span></span>

<span class="keyword1"><span class="command">locale</span></span> inca_to_ubx_simulation <span class="main">=</span>
  Sinca<span class="main">:</span> inca
    <span class="quoted"><span class="free">Finca_empty</span></span> <span class="quoted"><span class="free">Finca_get</span></span> <span class="quoted"><span class="free">Finca_add</span></span> <span class="quoted"><span class="free">Finca_to_list</span></span>
    <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span>
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span> <span class="main">+</span>
  Subx<span class="main">:</span> ubx_sp
    <span class="quoted"><span class="free">Fubx_empty</span></span> <span class="quoted"><span class="free">Fubx_get</span></span> <span class="quoted"><span class="free">Fubx_add</span></span> <span class="quoted"><span class="free">Fubx_to_list</span></span>
    <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="quoted"><span class="free">box_ubx1</span></span> <span class="quoted"><span class="free">unbox_ubx1</span></span> <span class="quoted"><span class="free">box_ubx2</span></span> <span class="quoted"><span class="free">unbox_ubx2</span></span>
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔘𝔟𝔵𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔘𝔟𝔵</span></span> <span class="quoted"><span class="free">𝔅𝔬𝔵</span></span> <span class="quoted"><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="comment1">― ‹Functions environments›</span>
    <span class="free">Finca_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Finca_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv_inca</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">)</span> Inca.instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Finca_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Finca_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="free">Fubx_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Fubx_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv_ubx</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">,</span> <span class="tfree">'opubx</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> Ubx.instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Fubx_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Fubx_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Memory heap›</span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'henv</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Unboxed values›</span>
    <span class="free">is_true</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx1</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">box_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">unbox_ubx2</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹n-ary operations›</span>
    <span class="free">𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔘𝔟𝔵</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔅𝔬𝔵</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> Subx.sp_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Strongest postcondition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sp_fundef</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_fundef</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> Subx.sp <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>replicate <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sp_fundef_generalize <span class="main">=</span>
  Subx.sp_generalize<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Σ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>arity <span class="free">fd</span><span class="main">)</span> None"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">fd</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> sp_fundef_def<span class="main">]</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-eq_sp_to_eq_sp_fundef"><span class="command">lemma</span></span> eq_sp_to_eq_sp_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F1</span> <span class="main">=</span> <span class="main">(</span>Subx.sp <span class="free">F2</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'id</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> Ubx.instr list <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="free">F1</span> <span class="main">=</span> <span class="main">(</span>sp_fundef <span class="free">F2</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'id</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="tfree">'num</span><span class="main">,</span> <span class="tfree">'bool</span><span class="main">)</span> Ubx.instr list <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundef_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sp_fundefs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_fundefs</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">f</span> <span class="bound">fd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">f</span> <span class="main">=</span> Some <span class="bound">fd</span> <span class="main">⟶</span> sp_fundef <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">fd</span> <span class="main">(</span>body <span class="bound">fd</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Normalization›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IPushUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IPush <span class="main">(</span><span class="free">box_ubx1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IPushUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IPush <span class="main">(</span><span class="free">box_ubx2</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> Ubx.IPop <span class="main">=</span> Inca.IPop"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.ILoadUbx <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IStoreUbx <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IOpInl <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IOpInl <span class="free"><span class="bound"><span class="entity">op</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.IOpUbx <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IOpInl <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Ubx.ICall <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ICall <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_fundefs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_fundefs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span>rel_fundef <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> norm_instr <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">norm_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_eq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> norm_instr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-norm_generalize_instr"><span class="command">lemma</span></span> norm_generalize_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>Subx.generalize_instr <span class="free">instr</span><span class="main">)</span> <span class="main">=</span> norm_instr <span class="free">instr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">instr</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundef_body_nth"><span class="command">lemma</span></span> rel_fundef_body_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free">fd1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="free">fd1</span> <span class="main">!</span> <span class="free">pc</span> <span class="main">=</span> norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_nthD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fundef.rel_sel<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundef_rewrite_body"><span class="command">lemma</span></span> rel_fundef_rewrite_body<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> norm_instr <span class="free">instr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fundef.rel_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar'</span> <span class="skolem">ys</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 norm_eq <span class="skolem">xs</span> <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> list_all2_all_nthI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> norm_instr <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_nthD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹list_all2 norm_eq <span class="skolem">xs</span> <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> Fundef<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Fundef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundef_generalize"><span class="command">lemma</span></span> rel_fundef_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fundef.rel_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar'</span> <span class="skolem">ys</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> norm_instr <span class="bound">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>map Subx.generalize_instr <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map norm_generalize_instr<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Fundef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_empty"><span class="command">lemma</span></span> rel_fundefs_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fundefs_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_None1"><span class="command">lemma</span></span> rel_fundefs_None1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms rel_fundefs_def rel_option_None1<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_None2"><span class="command">lemma</span></span> rel_fundefs_None2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms rel_fundefs_def rel_option_None2<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_Some1"><span class="command">lemma</span></span> rel_fundefs_Some1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> rel_fundef norm_eq <span class="free">y</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_Some1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_Some2"><span class="command">lemma</span></span> rel_fundefs_Some2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> rel_fundef norm_eq <span class="bound">z</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_Some2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_rel_option"><span class="command">lemma</span></span> rel_fundefs_rel_option<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> rel_fundef norm_eq <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">h</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> rel_fundefs_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_option_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Equivalence of call stacks›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">norm_stack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'ubx1</span><span class="main">,</span> <span class="tfree">'ubx2</span><span class="main">)</span> unboxed list <span class="main">⇒</span> <span class="tfree">'dyn</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_stack</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">≡</span> List.map Subx.norm_unboxed <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-norm_stack_Nil"><span class="command">lemma</span></span> norm_stack_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm_stack <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-norm_stack_Cons"><span class="command">lemma</span></span> norm_stack_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm_stack <span class="main">(</span><span class="free">d</span> <span class="main">#</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Subx.norm_unboxed <span class="free">d</span> <span class="main">#</span> norm_stack <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-norm_stack_append"><span class="command">lemma</span></span> norm_stack_append<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_stack <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> norm_stack <span class="free">xs</span> <span class="main">@</span> norm_stack <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> drop_norm_stack <span class="main">=</span> drop_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">Subx.norm_unboxed</span><span class="main">,</span> <span class="operator">folded</span> norm_stack_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> take_norm_stack <span class="main">=</span> take_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">Subx.norm_unboxed</span><span class="main">,</span> <span class="operator">folded</span> norm_stack_def<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> norm_stack_map <span class="main">=</span> map_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted">Subx.norm_unboxed</span><span class="main">,</span> <span class="operator">folded</span> norm_stack_def<span class="main">]</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-norm_box_stack"><span class="command">lemma</span></span> norm_box_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm_stack <span class="main">(</span>map Subx.box_operand <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> norm_stack <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_stack_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-length_norm_stack"><span class="command">lemma</span></span> length_norm_stack<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>norm_stack <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_valid_fun_call</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_valid_fun_call</span> <span class="free"><span class="bound"><span class="entity">get</span></span></span> <span class="free"><span class="bound"><span class="entity">fd2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd2</span></span></span><span class="main">)</span> <span class="main">∧</span> body <span class="free"><span class="bound"><span class="entity">fd2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> ICall <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">gd</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">get</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="bound">gd</span> <span class="main">∧</span> list_all is_dyn_operand <span class="main">(</span>take <span class="main">(</span>arity <span class="bound">gd</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rel_stacktraces</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">get</span> <span class="keyword2"><span class="keyword">where</span></span>
  rel_stacktraces_Nil<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">rel_stacktraces</span> <span class="free">get</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span>"</span></span> <span class="main">|</span>

  rel_stacktraces_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">rel_stacktraces</span> <span class="free">get</span> <span class="free"><span class="bound"><span class="entity">st1</span></span></span> <span class="free"><span class="bound"><span class="entity">st2</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Σ1</span></span></span> <span class="main">=</span> norm_stack <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span> <span class="main">⟹</span>
    <span class="free">get</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd2</span></span></span> <span class="main">⟹</span>
    sp_fundef <span class="free">get</span> <span class="free"><span class="bound"><span class="entity">fd2</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    pred_option <span class="main">(</span>is_valid_fun_call <span class="free">get</span> <span class="free"><span class="bound"><span class="entity">fd2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="main">⟹</span>
    <span class="free">rel_stacktraces</span> <span class="free">get</span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st1</span></span></span><span class="main">)</span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_same_arities</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_same_arities</span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">f</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span> <span class="bound">gd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> arity <span class="bound">gd</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-all_same_arities_commutative"><span class="command">lemma</span></span> all_same_arities_commutative<span class="main">:</span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span> <span class="main">=</span> all_same_arities <span class="free">F2</span> <span class="free">F1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F2</span> <span class="free">F1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_same_arities_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_option_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F2</span> <span class="free">F1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_same_arities_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_option_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-sp_instr_same_arities"><span class="command">lemma</span></span> sp_instr_same_arities<span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span> <span class="main">⟹</span> Subx.sp_instr <span class="free">F1</span> <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> Subx.sp_instr <span class="free">F2</span> <span class="free">x</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">F1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Subx.sp_instr.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="skolem">Σ</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"all_same_arities <span class="skolem">F1</span> <span class="free">F2</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Subx.sp_instr <span class="skolem">F1</span> <span class="main">(</span>Ubx.ICall <span class="skolem">f</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">=</span> Subx.sp_instr <span class="free">F2</span> <span class="main">(</span>Ubx.ICall <span class="skolem">f</span><span class="main">)</span> <span class="skolem">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F1</span> <span class="skolem">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="skolem">f</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> HOL.spec<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> all_same_arities_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">a</span> <span class="main">=</span> arity <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> HOL.spec<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> all_same_arities_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_Some1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-sp_same_arities"><span class="command">lemma</span></span> sp_same_arities<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F1</span> <span class="main">=</span> Subx.sp <span class="free">F2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F1</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">=</span> Subx.sp <span class="free">F2</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Subx.sp_instr.cases<span class="main"><span class="keyword3">;</span></span>
          <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> opubx
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons.IH Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">fd</span></span> <span class="bound"><span class="bound">gd</span></span><span class="main"><span class="main">.</span></span> arity <span class="bound"><span class="bound">fd</span></span> <span class="main"><span class="main">=</span></span> arity <span class="bound"><span class="bound">gd</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">F1</span></span> <span class="skolem"><span class="skolem">f</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">F2</span></span> <span class="skolem"><span class="skolem">f</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> all_same_arities_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sp_fundef_same_arities <span class="main">=</span> sp_same_arities<span class="main">[</span><span class="operator">THEN</span> eq_sp_to_eq_sp_fundef<span class="main">]</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-all_same_arities_add"><span class="command">lemma</span></span> all_same_arities_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">fd1</span> <span class="main">=</span> arity <span class="free">fd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  all_same_arities_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span> <span class="bound">gd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> arity <span class="bound">gd</span><span class="main">)</span>
           <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span> <span class="skolem">g</span><span class="main">)</span>
           <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd2</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.rel_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-all_same_arities_generalize_fundef"><span class="command">lemma</span></span> all_same_arities_generalize_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_same_arities_add<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> ubx.arity_generalize_fundef
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_stacktraces_box"><span class="command">lemma</span></span> rel_stacktraces_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rel_stacktraces <span class="free">F1</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">opt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="free">f</span> <span class="main">=</span> map_option Subx.generalize_fundef <span class="main">(</span><span class="free">F1</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> <span class="free">f</span> <span class="main">≠</span> <span class="bound">g</span> <span class="main">⟹</span> <span class="free">F2</span> <span class="bound">g</span> <span class="main">=</span> <span class="free">F1</span> <span class="bound">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"all_same_arities <span class="free">F1</span> <span class="free">F2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="free">F2</span> <span class="free">xs</span> <span class="main">(</span>Subx.box_stack <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="free">opt</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">opt</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_stacktraces.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> rel_stacktraces_Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rel_stacktraces_Cons <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">g</span> <span class="skolem">Σ1</span> <span class="skolem">Σ2</span> <span class="skolem">gd</span> <span class="skolem">n</span> <span class="skolem">opt</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sp_F1_eq_sp_F2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> sp_same_arities<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> sp_fundef_F1_eq_sp_fundef_F2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> eq_sp_to_eq_sp_fundef<span class="main">[</span><span class="operator">OF</span> sp_F1_eq_sp_F2<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> get2_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="main">(</span>Subx.generalize_fundef <span class="skolem">gd</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="free">F2</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
      <span class="main">(</span>Frame <span class="skolem">g</span> <span class="skolem">n</span> <span class="main">(</span>map Subx.box_operand <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> Subx.box_stack <span class="skolem">g</span> <span class="skolem">st2</span><span class="main">)</span> <span class="skolem">opt</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_stacktraces.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="free">F2</span> <span class="skolem">st1</span> <span class="main">(</span>Subx.box_stack <span class="skolem">g</span> <span class="skolem">st2</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons.IH
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="main">(</span>map Subx.box_operand <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="main">(</span>Subx.generalize_fundef <span class="skolem">gd</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> get2_g <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="free">F2</span> <span class="main">(</span>Subx.generalize_fundef <span class="skolem">gd</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>body <span class="main">(</span>Subx.generalize_fundef <span class="skolem">gd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Ok <span class="main">(</span>map typeof <span class="main">(</span>map Subx.box_operand <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sp_fundef_generalize<span class="main">[</span><span class="operator">OF</span> rel_stacktraces_Cons.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map sp_fundef_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_option
        <span class="main">(</span>is_valid_fun_call <span class="free">F2</span> <span class="main">(</span>Subx.generalize_fundef <span class="skolem">gd</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">(</span>map Subx.box_operand <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">opt</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">opt</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">h</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons.hyps<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map list.pred_map list.pred_True is_valid_fun_call_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> get2_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="free">F2</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">Σ2</span> <span class="main">#</span> Subx.box_stack <span class="free">f</span> <span class="skolem">st2</span><span class="main">)</span> <span class="skolem">opt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">≠</span> <span class="skolem">g</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros<span class="main"><span class="keyword3">;</span></span>
          <span class="operator">cases</span> <span class="quoted"><span class="skolem">opt</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundef_def is_valid_fun_call_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> h
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_stacktraces_generalize"><span class="command">lemma</span></span> rel_stacktraces_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="free">st1</span> <span class="free">st2</span> <span class="main">(</span>Some <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd</span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sp_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="free">fd</span> <span class="main">(</span>take <span class="free">pc</span> <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>None <span class="main">#</span> map typeof <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    norm_stacks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ1</span> <span class="main">=</span> norm_stack <span class="free">Σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sp_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp_instr <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span>Subx.generalize_instr <span class="main">(</span>body <span class="free">fd</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>None <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="free">Σ2</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>None <span class="main">#</span> map <span class="main">(</span>typeof <span class="main">∘</span> Subx.box_operand<span class="main">)</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>Frame <span class="free">f</span> <span class="main">(</span>Suc <span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">d</span> <span class="main">#</span> <span class="free">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="free">st1</span><span class="main">)</span>
          <span class="main">(</span>Frame <span class="free">f</span> <span class="main">(</span>Suc <span class="free">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="free">d</span> <span class="main">#</span> map Subx.box_operand <span class="free">Σ2</span><span class="main">)</span> <span class="main">#</span> Subx.box_stack <span class="free">f</span> <span class="free">st2</span><span class="main">)</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Subx.generalize_fundef <span class="free">fd</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="var">?fd'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_stacktraces_Cons<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F'</span><span class="main">)</span> <span class="free">st1</span> <span class="main">(</span>Subx.box_stack <span class="free">f</span> <span class="free">st2</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> all_same_arities_generalize_fundef
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces_box<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">#</span> <span class="free">Σ1</span> <span class="main">=</span> norm_stack <span class="main">(</span>OpDyn <span class="free">d</span> <span class="main">#</span> map Subx.box_operand <span class="free">Σ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> norm_stacks <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="var">?F'</span> <span class="free">f</span> <span class="main">=</span> Some <span class="var">?fd'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F'</span><span class="main">)</span> <span class="var">?fd'</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">pc</span><span class="main">)</span> <span class="main">(</span>body <span class="var">?fd'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Ok <span class="main">(</span>map typeof <span class="main">(</span>OpDyn <span class="free">d</span> <span class="main">#</span> map Subx.box_operand <span class="free">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_same_arities_generalize_fundef<span class="main">[</span><span class="operator">THEN</span> sp_fundef_same_arities<span class="main">,</span>
          <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> sp_fundef_generalize<span class="main">[</span><span class="operator">OF</span> sp_prefix<span class="main">]</span> sp_instr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundef_def take_map take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pc_in_range<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_rewrite"><span class="command">lemma</span></span> rel_fundefs_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F2_get_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F2_add_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span> <span class="main">=</span> <span class="free">F2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    eq_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> norm_instr <span class="free">instr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F2'_get_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F2_add_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="free">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_get_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F2'_get_x option_rel_Some2
      <span class="keyword1"><span class="command">using</span></span> True rel_fundef_rewrite_body<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2 eq_norm<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">Fubx_get</span> <span class="free">F2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F2_add_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 rel_fundefs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundef_rewrite_both"><span class="command">lemma</span></span> rel_fundef_rewrite_both<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"norm_instr <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="main">(</span>rewrite_fundef_body <span class="free">fd1</span> <span class="free">pc</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fundef.rel_sel<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_rewrite_both"><span class="command">lemma</span></span> rel_fundefs_rewrite_both<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    rel_init<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rel_new<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="main">(</span><span class="free">Finca_add</span> <span class="free">F1</span> <span class="free">f</span> <span class="free">fd1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="free">fd2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="main">(</span><span class="free">Finca_add</span> <span class="free">F1</span> <span class="free">f</span> <span class="free">fd1</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="free">fd2</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_new <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fundefs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_fundefs_generalize"><span class="command">lemma</span></span> rel_fundefs_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F2_get_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F2'_get_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="var">?F2'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>Subx.generalize_fundef <span class="free">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Subx.Fenv.get_add_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="free">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_get_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F2'_get_x option_rel_Some2
      <span class="keyword1"><span class="command">using</span></span> True rel_fundef_generalize
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="var">?F2'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">Fubx_get</span> <span class="free">F2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Subx.Fenv.get_add_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 rel_fundefs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-rel_stacktraces_rewrite_fundef"><span class="command">lemma</span></span> rel_stacktraces_rewrite_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">opt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Σ</span><span class="main">.</span> Subx.sp_instr <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span> <span class="main">(</span>body <span class="free">fd</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="bound">Σ</span> <span class="main">=</span> Subx.sp_instr <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span> <span class="free">instr</span> <span class="bound">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_fun_call <span class="main">(</span>body <span class="free">fd</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces
     <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">opt</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">opt</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_stacktraces.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> rel_stacktraces_Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rel_stacktraces_Cons <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">g</span> <span class="skolem">Σ1</span> <span class="skolem">Σ2</span> <span class="skolem">gd</span> <span class="skolem">n</span> <span class="skolem">opt</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> same_arities<span class="main">:</span> <span class="quoted"><span class="quoted">"all_same_arities <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span>
    <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_same_arities_add<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gd</span> <span class="main">=</span> <span class="free">fd</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rel_stacktraces_Cons.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True rel_stacktraces_Cons
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_fundef_same_arities<span class="main"><span class="main">[</span></span><span class="operator">OF</span> same_arities<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">pc</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundef_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Subx.sp_rewrite_eq_Ok take_rewrite_swap<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
         <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons.hyps<span class="main">(</span>5<span class="main">)</span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">opt</span></span><span class="main">)</span>
         <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">h</span><span class="main">)</span>
         <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rewrite <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span> <span class="free">pc</span> <span class="free">instr</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> Ubx.ICall <span class="skolem">h</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">gd</span> <span class="main">=</span> <span class="free">fd</span>›</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> instr.disc nth_rewrite_neq<span class="main">)</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
           <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted"><span class="quoted">‹<span class="skolem">gd</span> <span class="main">=</span> <span class="free">fd</span>›</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_rewrite_fundef_body assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.inject Subx.Fenv.get_add_eq Subx.Fenv.get_add_neq<span class="main">)</span>
       <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_fundef_same_arities<span class="main"><span class="main">[</span></span><span class="operator">OF</span> same_arities<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">opt</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">h</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Some assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Matching relation›</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-sp_fundefs_get"><span class="command">lemma</span></span> sp_fundefs_get<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="free">F</span> <span class="free">fd</span> <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundefs_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_simulation-sp_fundefs_generalize"><span class="command">lemma</span></span> sp_fundefs_generalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_fundefs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">gd</span>
  <span class="keyword3"><span class="command">assume</span></span> get_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sp_F_eq_sp_F' <span class="main">=</span> all_same_arities_generalize_fundef<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> sp_same_arities<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="free">fd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">gd</span> <span class="main">(</span>body <span class="skolem">gd</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gd</span> <span class="main">=</span> Subx.generalize_fundef <span class="free">fd</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> get_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundefs_def sp_fundef_def sp_F_eq_sp_F' Subx.sp_generalize2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> get_g assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_fundefs_def sp_fundef_def sp_F_eq_sp_F'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-sp_fundefs_add"><span class="command">lemma</span></span> sp_fundefs_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="free">fd</span> <span class="main">(</span>body <span class="free">fd</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"all_same_arities <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_fundefs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">gd</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span><span class="main">)</span> <span class="skolem">gd</span> <span class="main">(</span>body <span class="skolem">gd</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gd</span> <span class="main">=</span> <span class="free">fd</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_fundef_same_arities<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_fundef_same_arities<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="free">F</span> <span class="free">f</span> <span class="free">fd</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">match</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st1</span></span></span> <span class="free"><span class="bound"><span class="entity">st2</span></span></span> None <span class="main">⟹</span>
  <span class="free">match</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">st1</span></span></span><span class="main">)</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">st2</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Backward simulation›</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-traverse_cast_Dyn_to_norm"><span class="command">lemma</span></span> traverse_cast_Dyn_to_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"traverse cast_Dyn <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span> <span class="main">⟹</span> norm_stack <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cast_Dyn.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-traverse_cast_Dyn_to_all_Dyn"><span class="command">lemma</span></span> traverse_cast_Dyn_to_all_Dyn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"traverse cast_Dyn <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span> <span class="main">⟹</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> typeof <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cast_Dyn.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.bind_eq_Some_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-backward_lockstep_simulation"><span class="command">lemma</span></span> backward_lockstep_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subx.step <span class="free">s2</span> <span class="free">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> Sinca.step <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="bound">s1'</span> <span class="main">∼</span> <span class="free">s2'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sp_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">st1</span></span> <span class="quoted"><span class="skolem">st2</span></span> <span class="quoted"><span class="quoted">"None <span class="main">::</span> <span class="tfree">'fun</span> option"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_stacktraces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_stacktraces_Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Subx.step.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rel_stacktraces_Cons <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">f</span> <span class="skolem">Σ1</span> <span class="skolem">Σ2</span> <span class="skolem">fd2</span> <span class="skolem">pc</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> F2_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> rel_st1_st2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="main">(</span>Some <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> sp_fundef_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">fd2</span> <span class="main">(</span>take <span class="skolem">pc</span> <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> Σ1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">note</span></span> sp_fundef_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> sp_prefix <span class="main">=</span> sp_fundef_prefix<span class="main">[</span><span class="operator">unfolded</span> sp_fundef_def<span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> sp_generalized<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span><span class="free">Fubx_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="skolem">fd2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map Subx.generalize_instr <span class="main">(</span>take <span class="skolem">pc</span> <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>arity <span class="skolem">fd2</span><span class="main">)</span> None<span class="main">)</span> <span class="main">=</span>
      Ok <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Subx.sp_generalize<span class="main">[</span><span class="operator">OF</span> sp_prefix<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> all_same_arities_generalize_fundef<span class="main">[</span><span class="operator">OF</span> F2_f<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_same_arities<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> rel_stacktraces_Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s2'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Subx.step.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push <span class="skolem">fd2'</span> <span class="skolem">d</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push fd1_thms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_push <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push_ubx1 <span class="skolem">fd2'</span> <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">box_ubx1</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push_ubx1 fd1_thms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_push <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push_ubx1 rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push_ubx2 <span class="skolem">fd2'</span> <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">box_ubx2</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push_ubx2 fd1_thms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_push <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_push_ubx2 rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_pop <span class="skolem">fd2'</span> <span class="skolem">x</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_pop fd1_thms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_pop <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_pop rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load <span class="skolem">fd2'</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">d</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 step_load<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_load rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2 pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_load<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1_f pc_in_range<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Σ1_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_load refl rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_load<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load_ubx_hit <span class="skolem">fd2'</span> <span class="skolem">τ</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">d</span> <span class="skolem">blob</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 step_load_ubx_hit<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_load_ubx_hit rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2 pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_load<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1_f pc_in_range<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth Σ1_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_load_ubx_hit rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_load_ubx_hit<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load_ubx_miss <span class="skolem">fd2'</span> <span class="skolem">τ</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">d</span> <span class="skolem">F2'</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fd2'_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 step_load_ubx_miss<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_load_ubx_miss F1_f rel_fd1_fd2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_load<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1_f pc_in_range<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth Σ1_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> match.intros<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_load_ubx_miss.hyps<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundefs_generalize<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_load_ubx_miss.hyps<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> sp_fundefs_generalize<span class="main">[</span><span class="operator">OF</span> sp_F2 F2_f<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
            <span class="main">(</span>Subx.box_stack <span class="skolem">f</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_load_ubx_miss sp_fundef_prefix
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces_generalize<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2 F2_f<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cast_inversions<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_store <span class="skolem">fd2'</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="skolem">H'</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H'</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_store fd1_thms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_store <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_store rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_store_ubx <span class="skolem">fd2'</span> <span class="skolem">τ</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">i'</span> <span class="skolem">blob</span> <span class="skolem">d</span> <span class="skolem">H'</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H'</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 step_store_ubx.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">#</span> <span class="skolem">blob</span> <span class="main">#</span> <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ2</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> step_store_ubx pc_in_range
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_store<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1_f<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_fd1_fd2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_store_ubx rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cast_inversions
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op <span class="skolem">fd2'</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">Σ2'</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_op fd1_thms take_norm_stack traverse_cast_Dyn_to_norm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op rel_stacktraces_Cons rel_F1_F2 sp_F2 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth drop_norm_stack Let_def take_map drop_map
                traverse_cast_Dyn_replicate<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl <span class="skolem">fd2'</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">Σ2'</span> <span class="skolem">opinl</span> <span class="skolem">x</span> <span class="skolem">F2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_add</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">(</span>rewrite_fundef_body <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="main">(</span>Inca.IOpInl <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="var">?F1'</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_op_inl F1_f rel_fd1_fd2 take_norm_stack traverse_cast_Dyn_to_norm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="var">?F1'</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl.hyps<span class="main">(</span>9<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundefs_rewrite_both<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundef_rewrite_both<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl.hyps all_same_arities_add sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> Sinca.ℑ𝔫𝔩_invertible
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_fundefs_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sp_F2<span class="main"><span class="main">]</span></span> Subx.sp_rewrite_eq_Ok
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> sp_F2_F2'<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">=</span> Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl.hyps<span class="main">(</span>1<span class="main">,</span>9<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_same_arities all_same_arities_add<span class="main">)</span>
          
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2'</span> <span class="skolem">pc</span> <span class="main">(</span>Ubx.IOpInl <span class="skolem">opinl</span><span class="main">)</span>"</span></span>
          
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_stacktraces.intros<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="main">(</span>Some <span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_op_inl Sinca.ℑ𝔫𝔩_invertible
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces_rewrite_fundef<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span> <span class="var">?fd2'</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>body <span class="var">?fd2'</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span>
              Ok <span class="main">(</span>map typeof <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_op_inl Sinca.ℑ𝔫𝔩_invertible sp_prefix
              <span class="keyword1"><span class="command">using</span></span> traverse_cast_Dyn_to_all_Dyn
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main"><span class="main">]</span></span> sp_F2_F2'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Let_def
                    take_map drop_map traverse_cast_Dyn_replicate<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_norm_stack<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_hit <span class="skolem">fd2'</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">Σ2'</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit fd1_thms take_norm_stack traverse_cast_Dyn_to_norm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl_hit <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit rel_stacktraces_Cons rel_F1_F2 sp_F2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> drop_norm_stack <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def drop_map take_map traverse_cast_Dyn_replicate<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_miss <span class="skolem">fd2'</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">Σ2'</span> <span class="skolem">x</span> <span class="skolem">F2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_add</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">(</span>rewrite_fundef_body <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="main">(</span>Inca.IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="var">?F1'</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss F1_f rel_fd1_fd2 take_norm_stack traverse_cast_Dyn_to_norm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl_miss <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="var">?F1'</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss
            <span class="keyword1"><span class="command">using</span></span> rel_fundefs_rewrite_both<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundef_rewrite_both<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss.hyps all_same_arities_add sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_fundefs_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sp_F2<span class="main"><span class="main">]</span></span> Subx.sp_rewrite_eq_Ok
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> sp_F2_F2'<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">=</span> Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_same_arities all_same_arities_add<span class="main">)</span>

          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2'</span> <span class="skolem">pc</span> <span class="main">(</span>Ubx.IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span>"</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="main">(</span>Some <span class="skolem">f</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss.hyps
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces_rewrite_fundef<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2'</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="var">?fd2'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss Subx.Fenv.get_add_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2'</span><span class="main">)</span> <span class="var">?fd2'</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>body <span class="var">?fd2'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              Ok <span class="main">(</span>map typeof <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2'</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> sp_prefix step_op_inl_miss traverse_cast_Dyn_to_all_Dyn
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main"><span class="main">]</span></span> sp_F2_F2'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                  traverse_cast_Dyn_replicate take_map drop_map<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_norm_stack<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_ubx <span class="skolem">fd2'</span> <span class="skolem">opubx</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fd1_thms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>Subx.norm_unboxed <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="main">(</span>norm_stack <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fd1_thms<span class="main">(</span>2<span class="main">)</span> step_op_ubx.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> nth_fd1<span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> Inca.instr.IOpInl <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> fd1_thms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">fd2'</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> IOpUbx <span class="skolem">opubx</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="main">(</span>map Subx.norm_unboxed <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op_ubx
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.ℑ𝔫𝔩_ℑ𝔰ℑ𝔫𝔩 Subx.𝔘𝔟𝔵𝔒𝔭_to_ℑ𝔫𝔩 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> norm_stack_def Σ1_def
          <span class="keyword1"><span class="command">using</span></span> step_op_ubx fd1_thms<span class="main">(</span>1<span class="main">)</span> nth_fd1 <span class="quoted"><span class="quoted">‹<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> Subx.𝔘𝔟𝔵𝔒𝔭_correct
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl_hit <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op_ubx rel_stacktraces_Cons rel_F1_F2 sp_F2 Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_complete
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth drop_norm_stack Let_def drop_map take_map min.absorb2<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_true <span class="skolem">fd2'</span> <span class="skolem">n</span> <span class="skolem">x</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> F2_f sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">,</span> <span class="operator">unfolded</span> sp_fundef_def<span class="main">,</span> <span class="operator">THEN</span> Subx.sp_no_jump<span class="main">]</span> nth_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_false <span class="skolem">fd2'</span> <span class="skolem">n</span> <span class="skolem">x</span> <span class="skolem">Σ2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> F2_f sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">,</span> <span class="operator">unfolded</span> sp_fundef_def<span class="main">,</span> <span class="operator">THEN</span> Subx.sp_no_jump<span class="main">]</span> nth_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_call <span class="skolem">f'</span> <span class="skolem">fd2'</span> <span class="skolem">pc'</span> <span class="skolem">g</span> <span class="skolem">gd2</span> <span class="skolem">ar</span> <span class="skolem">Σ2'</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span> <span class="main">=</span> <span class="skolem">pc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc'</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2'</span><span class="main">)</span>›</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_stacktraces_Cons.hyps<span class="main">(</span>2<span class="main">)</span> pc_in_range
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_fun_call<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> sp_F2 <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
            <span class="main">(</span><span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_fun_call<span class="main">(</span>9<span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rel_stacktraces.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> <span class="main">(</span>Some <span class="skolem">g</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> rel_st1_st2 F2_f Σ1_def sp_prefix
              <span class="keyword1"><span class="command">using</span></span> step_fun_call
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros
                  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_mono_strong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Σ1_def rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> step_fun_call <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_norm_stack<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_fun_call <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">gd2</span> <span class="main">(</span>take <span class="main">0</span> <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_fun_call
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> replicate_eq_map<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_end <span class="skolem">f'</span> <span class="skolem">fd2'</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">pc'</span> <span class="skolem">Σ2'</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">g</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub>'</span> <span class="skolem">st2'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fd2'</span> <span class="main">=</span> <span class="skolem">fd2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span> <span class="main">=</span> <span class="skolem">pc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd2</span></span> <span class="skolem"><span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span></span> <span class="skolem"><span class="skolem">st1'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        st1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st1</span> <span class="main">=</span> Frame <span class="skolem">g</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">#</span> <span class="skolem">st1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> norm_stack <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_st1'_st2'<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">st1'</span> <span class="skolem">st2'</span> <span class="main">(</span>Some <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        sp_prefix_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>replicate <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> None<span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        pc<span class="hidden">⇩</span><sub>g</sub>_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"body <span class="skolem">gd2</span> <span class="main">!</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> Ubx.ICall <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        prefix_all_dyn_Σ2<span class="hidden">⇩</span><sub>g</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all is_dyn_operand <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">fd2</span><span class="main">)</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_st1_st2 step_fun_end
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> pc_at_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc'</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Σ1</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd1</span><span class="main">)</span> <span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_fun_end.hyps<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> st1_def <span class="quoted"><span class="quoted">‹<span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> norm_stack <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> pc_at_end
          <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_fun_end<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Σ1</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd1</span><span class="main">)</span> <span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1'</span><span class="main">)</span>
            <span class="main">(</span><span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub>'</span> <span class="main">#</span> <span class="skolem">st2'</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_fun_end<span class="main">(</span>6<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> rel_st1'_st2'
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rel_stacktraces.rel_stacktraces_Cons<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd1</span><span class="main">)</span> <span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> norm_stack <span class="main">(</span><span class="skolem">Σ2'</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd2'</span><span class="main">)</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Σ1_def <span class="quoted"><span class="quoted">‹<span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> norm_stack <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_append drop_norm_stack<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">fd2</span> <span class="main">≤</span> length <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step_fun_end.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">fd2</span><span class="main">)</span> <span class="main">(</span>map typeof <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> prefix_all_dyn_Σ2<span class="hidden">⇩</span><sub>g</sub>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_mono_strong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map list.pred_map is_dyn_operand_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map typeof <span class="skolem">Σ2</span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc'</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2'</span><span class="main">)</span>›</span></span> sp_prefix
              <span class="keyword1"><span class="command">using</span></span> sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2 F2_f<span class="main">]</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">gd2</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              Ok <span class="main">(</span>map typeof <span class="main">(</span><span class="skolem">Σ2'</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd2'</span><span class="main">)</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> sp_prefix_gd2
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">gd2</span> <span class="main">!</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> Ubx.ICall <span class="skolem">f</span>›</span></span> F2_f
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pc<span class="hidden">⇩</span><sub>g</sub>_in_range<span class="main"><span class="main">]</span></span> Let_def drop_map<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-match_final_backward"><span class="command">lemma</span></span> match_final_backward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span> <span class="main">⟹</span> Subx.final <span class="free">s2</span> <span class="main">⟹</span> Sinca.final <span class="free">s1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">Σ2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    st2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st2</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Subx.final <span class="main">(</span>State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.final.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Σ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> st1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st1</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> None›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st1_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.final.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_to_ubx_simulation<span class="main">:</span>
  backward_simulation <span class="quoted">Sinca.step</span> <span class="quoted">Subx.step</span> <span class="quoted">Sinca.final</span> <span class="quoted">Subx.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_final_backward backward_lockstep_simulation
   lockstep_to_plus_backward_simulation<span class="main">[</span><span class="operator">of</span> <span class="quoted">match</span> <span class="quoted">Subx.step</span> <span class="quoted">Sinca.step</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Forward simulation›</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-traverse_cast_Dyn_eq_norm_stack"><span class="command">lemma</span></span> traverse_cast_Dyn_eq_norm_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traverse cast_Dyn <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>norm_stack <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span>
    typeof_x<span class="main">:</span> <span class="quoted"><span class="quoted">"typeof <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    typeof_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> OpDyn <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> typeof_unboxed_inversion<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> typeof_x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> typeof_xs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-forward_lockstep_simulation"><span class="command">lemma</span></span> forward_lockstep_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Sinca.step <span class="free">s1</span> <span class="free">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s2'</span><span class="main">.</span> Subx.step <span class="free">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">s1'</span> <span class="main">∼</span> <span class="bound">s2'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sp_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">note</span></span> rel_fundefs_rewrite_both' <span class="main">=</span>
    rel_fundef_rewrite_both<span class="main">[</span><span class="operator">THEN</span> rel_fundefs_rewrite_both<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_F1_F2<span class="main"><span class="main">]</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">st1</span></span> <span class="quoted"><span class="skolem">st2</span></span> <span class="quoted"><span class="quoted">"None <span class="main">::</span> <span class="tfree">'fun</span> option"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_stacktraces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_stacktraces_Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Sinca.step.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rel_stacktraces_Cons <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">f</span> <span class="skolem">Σ1</span> <span class="skolem">Σ2</span> <span class="skolem">fd2</span> <span class="skolem">pc</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> F2_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> rel_st1_st2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="main">(</span>Some <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> sp_fundef_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">fd2</span> <span class="main">(</span>take <span class="skolem">pc</span> <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> Σ1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_stacktraces_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">note</span></span> sp_fundef_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> sp_prefix <span class="main">=</span> sp_fundef_prefix<span class="main">[</span><span class="operator">unfolded</span> sp_fundef_def<span class="main">]</span>

    <span class="keyword1"><span class="command">note</span></span> ex_F1_f <span class="main">=</span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> sp_fundef_full <span class="main">=</span> sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2 <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> sp_full <span class="main">=</span> sp_fundef_full<span class="main">[</span><span class="operator">unfolded</span> sp_fundef_def<span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> sp_sufix<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.sp <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
      <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map typeof <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Cons_nth_drop_Suc<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Subx.sp_eq_bind_take_drop<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_prefix
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> rel_stacktraces_Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s1'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Sinca.step.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push <span class="skolem">fd1</span> <span class="skolem">d</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_push rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_push rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_push norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IPush <span class="skolem">d2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">d2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_push.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">d2</span> <span class="main">#</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IPush step_push d_def F2_f pc_in_range
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_push<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
          <span class="keyword1"><span class="command">using</span></span> IPush d_def sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IPushUbx1 <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="free">box_ubx1</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_push.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpUbx1 <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IPushUbx1 step_push d_def F2_f pc_in_range
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_push_ubx1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
          <span class="keyword1"><span class="command">using</span></span> IPushUbx1 d_def sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IPushUbx2 <span class="skolem">b</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="free">box_ubx2</span> <span class="skolem">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_push.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpUbx2 <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IPushUbx2 step_push d_def F2_f pc_in_range
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_push_ubx2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
          <span class="keyword1"><span class="command">using</span></span> IPushUbx2 d_def sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_pop <span class="skolem">fd1</span> <span class="skolem">x</span> <span class="skolem">Σ1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_pop rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_pop rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">Σ2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Σ2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ2</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">Σ2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1'</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_pop <span class="quoted"><span class="quoted">‹<span class="skolem">Σ1</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2</span>›</span></span> norm_stack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_pop norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> IPop
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ2'</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IPop step_pop F2_f pc_in_range Σ2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_pop<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f <span class="quoted"><span class="quoted">‹<span class="skolem">Σ1'</span> <span class="main">=</span> norm_stack <span class="skolem">Σ2'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> IPop sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span> Σ2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load <span class="skolem">fd1</span> <span class="skolem">var</span> <span class="skolem">i</span> <span class="skolem">d</span> <span class="skolem">Σ1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_load rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_load rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">Σ2'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        Σ2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ2</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">#</span> <span class="skolem">Σ2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> norm_i'<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.norm_unboxed <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_load Σ1_def norm_stack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_load norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ILoad <span class="skolem">var'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">var'</span> <span class="main">=</span> <span class="skolem">var</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_load.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> OpDyn <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> Σ2_def ILoad<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> norm_i'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ILoad step_load F2_f pc_in_range
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_load <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Σ2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
          <span class="keyword1"><span class="command">using</span></span> ILoad sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> OpDyn <span class="skolem">i</span>›</span></span> Σ2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ILoadUbx <span class="skolem">τ</span> <span class="skolem">var'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">var'</span> <span class="main">=</span> <span class="skolem">var</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_load.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> OpDyn <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> Σ2_def ILoadUbx<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> norm_i'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Subx.unbox <span class="skolem">τ</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">(</span>Subx.generalize_fundef <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?frame</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ2'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="var">?F2'</span> <span class="skolem">H</span> <span class="main">(</span>Subx.box_stack <span class="skolem">f</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> None ILoadUbx
            <span class="keyword1"><span class="command">using</span></span> step_load pc_in_range F2_f
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_load_ubx_miss
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ2_def
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Subx.box_stack_Cons<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundefs_generalize<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_f<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> sp_fundefs_generalize<span class="main">[</span><span class="operator">OF</span> sp_F2 F2_f<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> sp_fundef_prefix ILoadUbx
            <span class="keyword1"><span class="command">using</span></span> pc_in_range
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces_generalize<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_st1_st2 F2_f<span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Σ2_def <span class="quoted"><span class="quoted">‹norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">blob</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blob</span> <span class="main">#</span> <span class="skolem">Σ2'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Some ILoadUbx step_load F2_f pc_in_range
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_load_ubx_hit <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Σ2_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
            <span class="keyword1"><span class="command">using</span></span> Some ILoadUbx sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>›</span></span> Σ2_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_store <span class="skolem">fd1</span> <span class="skolem">var</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">H'</span> <span class="skolem">Σ1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_store rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_store rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">Σ2'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        Σ2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ2</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">#</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">Σ2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        norm_i'<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.norm_unboxed <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        norm_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.norm_unboxed <span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_store Σ1_def norm_stack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_store norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IStore <span class="skolem">var'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">var'</span> <span class="main">=</span> <span class="skolem">var</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_store.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> sp_sufix' <span class="main">=</span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> Σ2_def IStore<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> OpDyn <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_i' sp_sufix' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> OpDyn <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_x' sp_sufix' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="main">(</span><span class="free">heap_add</span> <span class="skolem">H</span> <span class="main">(</span><span class="skolem">var</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ2'</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IStore Σ2_def pc_in_range F2_f
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_store<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ2_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_add</span> <span class="skolem">H</span> <span class="main">(</span><span class="skolem">var</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">H'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> IStore sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IStoreUbx <span class="skolem">τ</span> <span class="skolem">var'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">var'</span> <span class="main">=</span> <span class="skolem">var</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_store.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> sp_sufix' <span class="main">=</span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> Σ2_def IStoreUbx<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> OpDyn <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_i' sp_sufix' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> typeof_x'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"typeof <span class="skolem">x'</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sp_sufix' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Result.bind_eq_Ok_conv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.sp_instr.elims<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> result.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="main">(</span><span class="free">heap_add</span> <span class="skolem">H</span> <span class="main">(</span><span class="skolem">var</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ2'</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ2_def
          <span class="keyword1"><span class="command">using</span></span> F2_f pc_in_range IStoreUbx
          <span class="keyword1"><span class="command">using</span></span> Subx.typeof_and_norm_unboxed_imp_cast_and_box<span class="main">[</span><span class="operator">OF</span> typeof_x' norm_x'<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_store_ubx<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ2_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm_stack <span class="skolem">Σ2'</span> <span class="main">=</span> <span class="skolem">Σ1'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">heap_add</span> <span class="skolem">H</span> <span class="main">(</span><span class="skolem">var</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">H'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> IStoreUbx sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op <span class="skolem">fd1</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_op norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOp <span class="skolem">op'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          all_arg_Dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOp step_op sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOp step_op <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> Σ1_def pc_in_range F2_f
          <span class="keyword1"><span class="command">using</span></span> traverse_cast_Dyn_eq_norm_stack<span class="main">[</span><span class="operator">OF</span> all_arg_Dyn<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_norm_stack<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f
          <span class="keyword1"><span class="command">using</span></span> IOp sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> Σ1_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">ar</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> all_arg_Dyn Σ1_def <span class="quoted"><span class="quoted">‹<span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="skolem">op</span> <span class="main">=</span> <span class="skolem">ar</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_norm_stack<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Let_def take_map drop_map<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl <span class="skolem">fd1</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">opinl</span> <span class="skolem">x</span> <span class="skolem">F1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOp <span class="skolem">op'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op_inl.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          all_arg_Dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOp step_op_inl sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="main">(</span>Ubx.IOpInl <span class="skolem">opinl</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="var">?fd2'</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?frame</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="var">?F2'</span> <span class="skolem">H</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOp step_op_inl <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> Σ1_def pc_in_range <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> all_arg_Dyn take_norm_stack traverse_cast_Dyn_eq_norm_stack
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_op_inl<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1'</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl rel_fd1_fd2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_fundefs_rewrite_both'<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">fd2</span> <span class="main">=</span> arity <span class="var">?fd2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"all_same_arities <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> all_same_arities_add<span class="main">[</span><span class="operator">OF</span> F2_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_fundefs_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sp_F2<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Subx.sp_rewrite_eq_Ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pc_in_range _ sp_full<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> IOp
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Subx.sp_instr_op<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Sinca.ℑ𝔫𝔩_invertible <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> step_op_inl.hyps<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
              <span class="keyword1"><span class="command">using</span></span> rel_st1_st2 sp_prefix F2_f
              <span class="keyword1"><span class="command">using</span></span> IOp take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> Σ1_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">ar</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> step_op_inl.hyps<span class="main">(</span>4<span class="main">)</span> all_arg_Dyn
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros
                  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_norm_stack<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Let_def take_map drop_map<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>
          <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> F2_f pc_in_range IOp
            <span class="keyword1"><span class="command">using</span></span> Sinca.ℑ𝔫𝔩_invertible <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> step_op_inl.hyps<span class="main">(</span>6<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces_rewrite_fundef <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_hit <span class="skolem">fd1</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOpInl <span class="skolem">opinl'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op_inl_hit.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          all_arg_Dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOpInl step_op_inl_hit sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOpInl step_op_inl_hit <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> Σ1_def pc_in_range F2_f all_arg_Dyn
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.step_op_inl_hit traverse_cast_Dyn_eq_norm_stack
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_norm_stack<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f
          <span class="keyword1"><span class="command">using</span></span> IOpInl sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> Σ1_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">ar</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span> step_op_inl_hit.hyps<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> all_arg_Dyn
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_norm_stack<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Let_def take_map drop_map<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOpUbx <span class="skolem">opubx</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="skolem">opinl</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op_inl_hit.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> 𝔄𝔯𝔦𝔱𝔶_opubx<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ar</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit.hyps<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> sp_sufix' <span class="main">=</span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> IOpUbx<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dom</span></span> <span class="skolem"><span class="skolem">codom</span></span> <span class="keyword2"><span class="keyword">where</span></span> typeof_opubx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">dom</span><span class="main">,</span> <span class="skolem">codom</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prod.exhaust_sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> dom_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dom</span> <span class="main">=</span> map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 𝔄𝔯𝔦𝔱𝔶_opubx<span class="main">[</span><span class="operator">unfolded</span> Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_𝔄𝔯𝔦𝔱𝔶<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> sp_sufix'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def take_map<span class="main">)</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          eval_op<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="skolem">opubx</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          typeof_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"typeof <span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">codom</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> typeof_opubx<span class="main">[</span><span class="operator">unfolded</span> dom_def<span class="main">,</span> <span class="operator">THEN</span> Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_correct<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Σ1_def step_op_inl_hit eval_op 𝔄𝔯𝔦𝔱𝔶_opubx
          <span class="keyword1"><span class="command">using</span></span> pc_in_range IOpUbx F2_f
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_op_ubx<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Subx.norm_unboxed <span class="skolem">x'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Subx.𝔘𝔟𝔵𝔒𝔭_correct<span class="main">[</span><span class="operator">OF</span> eval_op<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit Σ1_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map norm_stack_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2 rel_st1_st2 F2_f Σ1_def
            <span class="keyword1"><span class="command">using</span></span> sp_prefix take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">,</span> <span class="operator">unfolded</span> IOpUbx<span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit
            <span class="keyword1"><span class="command">using</span></span> typeof_opubx typeof_x'
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def drop_norm_stack Let_def min.absorb2 take_map drop_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_miss <span class="skolem">fd1</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">x</span> <span class="skolem">F1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOpInl <span class="skolem">opinl'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op_inl_miss.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          all_arg_Dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOpInl step_op_inl_miss sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="main">(</span>Ubx.IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="var">?fd2'</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?frame</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span>OpDyn <span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="var">?F2'</span> <span class="skolem">H</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOpInl step_op_inl_miss <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> Σ1_def pc_in_range F2_f
          <span class="keyword1"><span class="command">using</span></span> traverse_cast_Dyn_eq_norm_stack<span class="main">[</span><span class="operator">OF</span> all_arg_Dyn<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_op_inl_miss <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_norm_stack<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1'</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss rel_fd1_fd2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_fundefs_rewrite_both'<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> IOpInl <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span> all_same_arities_add<span class="main">[</span><span class="operator">OF</span> F2_f<span class="main">]</span> sp_full
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sp_fundefs_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sp_F2<span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.sp_instr_op<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Subx.sp_rewrite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pc_in_range<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
              <span class="keyword1"><span class="command">using</span></span> rel_st1_st2 sp_prefix F2_f
              <span class="keyword1"><span class="command">using</span></span> IOpInl Σ1_def take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span> step_op_inl_miss.hyps<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> all_arg_Dyn
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros
                  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_norm_stack Let_def take_map drop_map<span class="main">)</span>
              
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="var">?F2'</span><span class="main">)</span>
            <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> F2_f pc_in_range IOpInl
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_stacktraces_rewrite_fundef
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">opinl'</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span> Let_def Subx.sp_instr_op<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOpUbx <span class="skolem">opubx</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="skolem">opinl</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> norm_instr_nth_body step_op_inl_miss.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> 𝔄𝔯𝔦𝔱𝔶_opubx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">(</span><span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ar</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss.hyps<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dom</span></span> <span class="skolem"><span class="skolem">codom</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">dom</span><span class="main">,</span> <span class="skolem">codom</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prod.exhaust_sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">codom</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 𝔄𝔯𝔦𝔱𝔶_opubx<span class="main">[</span><span class="operator">unfolded</span> Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_𝔄𝔯𝔦𝔱𝔶<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> IOpUbx
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> eval_op<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵𝔒𝔭</span> <span class="skolem">opubx</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ2</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="skolem">opinl</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Σ1_def norm_stack_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">𝔅𝔬𝔵</span> <span class="skolem">opubx</span> <span class="main">=</span> <span class="skolem">opinl</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.ℑ𝔫𝔩_ℑ𝔰ℑ𝔫𝔩 Subx.𝔘𝔟𝔵𝔒𝔭_to_ℑ𝔫𝔩 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_true <span class="skolem">fd1</span> <span class="skolem">n</span> <span class="skolem">Σ1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ICJump <span class="skolem">n'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> F2_f sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">,</span> <span class="operator">unfolded</span> sp_fundef_def<span class="main">,</span> <span class="operator">THEN</span> Subx.sp_no_jump<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> nth_mem pc_in_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_false <span class="skolem">fd1</span> <span class="skolem">n</span> <span class="skolem">Σ1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> norm_instr_nth_body<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false rel_fundef_body_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false norm_instr_nth_body
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ICJump <span class="skolem">n'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> F2_f sp_fundefs_get<span class="main">[</span><span class="operator">OF</span> sp_F2<span class="main">,</span> <span class="operator">unfolded</span> sp_fundef_def<span class="main">,</span> <span class="operator">THEN</span> Subx.sp_no_jump<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> nth_mem pc_in_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_call <span class="skolem">f'</span> <span class="skolem">fd1</span> <span class="skolem">pc'</span> <span class="skolem">g</span> <span class="skolem">gd1</span> <span class="skolem">Σ1'</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span> <span class="main">=</span> <span class="skolem">pc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1'</span> <span class="main">=</span> <span class="skolem">Σ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fd1_fd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> nth_body2<span class="main">:</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> Ubx.ICall <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2 <span class="quoted"><span class="quoted">‹<span class="skolem">pc'</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹body <span class="skolem">fd1</span> <span class="main">!</span> <span class="skolem">pc'</span> <span class="main">=</span> Inca.ICall <span class="skolem">g</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> prefix_Σ2_all_Dyn<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> sp_sufix<span class="main">[</span><span class="operator">OF</span> pc_in_range<span class="main">]</span> nth_body2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def take_map<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> all_dyn_args<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all is_dyn_operand <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map comp_def<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?args</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map OpDyn <span class="main">(</span>norm_stack <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> <span class="skolem">Σ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?frame</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Frame <span class="skolem">g</span> <span class="main">0</span> <span class="var">?args</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd2</span> <span class="main">≤</span> length <span class="skolem">Σ2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity <span class="skolem">gd1</span> <span class="main">≤</span> length <span class="skolem">Σ1'</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span> Σ1_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> pc_in_range nth_body2
            <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> rel_stacktraces_Cons.hyps<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> all_dyn_args
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_fun_call<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">fd2</span></span><span class="main"><span class="main">]</span></span> nth_equalityI
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> typeof_unboxed_eq_const list_all_length norm_stack_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 sp_F2
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>
           <span class="main">(</span><span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span>
           <span class="main">(</span><span class="var">?frame</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span> None"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> step_fun_call<span class="main">(</span>7<span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rel_stacktraces.intros<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span> <span class="main">#</span> <span class="skolem">st1</span><span class="main">)</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span> <span class="main">#</span> <span class="skolem">st2</span><span class="main">)</span>
              <span class="main">(</span>Some <span class="skolem">g</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> pc_in_range nth_body2 rel_stacktraces_Cons
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> all_dyn_args
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ1'</span> <span class="main">=</span> norm_stack <span class="var">?args</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Σ1_def
              <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_stack_map take_norm_stack<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">gd2</span> <span class="main">(</span>take <span class="main">0</span> <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>map typeof <span class="var">?args</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Σ1_def step_fun_call.hyps<span class="main">(</span>5<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_replicate_const<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_end <span class="skolem">f'</span> <span class="skolem">fd1</span> <span class="skolem">Σ1<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">pc'</span> <span class="skolem">Σ1'</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">g</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub>'</span> <span class="skolem">st1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span> <span class="main">=</span> <span class="skolem">pc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ1'</span> <span class="main">=</span> <span class="skolem">Σ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end ex_F1_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">note</span></span> arities_fd1_fd2 <span class="main">=</span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span></span> <span class="skolem"><span class="skolem">st2'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        st2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st2</span> <span class="main">=</span> Frame <span class="skolem">g</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">#</span> <span class="skolem">st2'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end rel_st1_st2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> all_dyn_prefix_Σ2<span class="hidden">⇩</span><sub>g</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>map typeof <span class="main">(</span>take <span class="main">(</span>arity <span class="skolem">fd2</span><span class="main">)</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end rel_st1_st2 F2_f
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> list.pred_mono_strong
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_map is_valid_fun_call_def<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Σ2</span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">fd2</span><span class="main">)</span> <span class="skolem">Σ2<span class="hidden">⇩</span><sub>g</sub></span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st2'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> st2_def
          <span class="keyword1"><span class="command">using</span></span> step_fun_end st2_def rel_st1_st2
          <span class="keyword1"><span class="command">using</span></span> arities_fd1_fd2
          <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Subx.step_fun_end<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map typeof <span class="skolem">Σ2</span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_fun_end st2_def rel_st1_st2
            <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 sp_full sp_prefix
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> step_fun_end st2_def rel_st1_st2
            <span class="keyword1"><span class="command">using</span></span> arities_fd1_fd2 Σ1_def F2_f all_dyn_prefix_Σ2<span class="hidden">⇩</span><sub>g</sub>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_stacktraces.intros
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_F1_F2 sp_F2
                <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth Let_def drop_norm_stack take_map drop_map
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_valid_fun_call_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_simulation-match_final_forward"><span class="command">lemma</span></span> match_final_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span> <span class="main">⟹</span> Sinca.final <span class="free">s1</span> <span class="main">⟹</span> Subx.final <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">st1</span> <span class="skolem">st2</span> <span class="skolem">H</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">Σ1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    st1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st1</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F1_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pc_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Sinca.final <span class="main">(</span>State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="skolem">st1</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Sinca.final.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Σ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> st2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st2</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="skolem">st1</span> <span class="skolem">st2</span> None›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_stacktraces.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> F2_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>›</span></span> F1_f<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_fd1_fd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st2_def pc_def
    <span class="keyword1"><span class="command">using</span></span> F2_f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Subx.final.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_ubx_forward_simulation<span class="main">:</span>
  forward_simulation <span class="quoted">Sinca.step</span> <span class="quoted">Subx.step</span> <span class="quoted">Sinca.final</span> <span class="quoted">Subx.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_final_forward forward_lockstep_simulation
  <span class="keyword1"><span class="command">using</span></span> lockstep_to_plus_forward_simulation<span class="main">[</span><span class="operator">of</span> <span class="quoted">match</span> <span class="quoted">Sinca.step</span> <span class="main">_</span> <span class="quoted">Subx.step</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> inca_ubx_bisimulation<span class="main">:</span>
  bisimulation <span class="quoted">Sinca.step</span> <span class="quoted">Subx.step</span> <span class="quoted">Sinca.final</span> <span class="quoted">Subx.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Inca_to_Ubx_compiler">
<div class="head">
<h1>Theory Inca_to_Ubx_compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Inca_to_Ubx_compiler
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Inca_to_Ubx_simulation">Inca_to_Ubx_simulation</a> <a href="#Result">Result</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Compiler">VeriComp.Compiler</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic program rewriting›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rewrite_instr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'stack</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'err</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'stack</span><span class="main">)</span> result"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rewrite_prog</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'stack</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'err</span><span class="main">,</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'stack</span><span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rewrite_prog</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rewrite_prog</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">Σ'</span><span class="main">)</span> <span class="main">←</span> <span class="free">rewrite_instr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">Σ''</span><span class="main">)</span> <span class="main">←</span> <span class="free">rewrite_prog</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">Σ'</span><span class="main">;</span>
    Ok <span class="main">(</span><span class="bound">x'</span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">,</span> <span class="bound">Σ''</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-rewrite_prog_map_f"><span class="command">lemma</span></span> rewrite_prog_map_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Σ1</span> <span class="bound">n</span> <span class="bound">x'</span> <span class="bound">Σ2</span><span class="main">.</span> <span class="free">rewrite_instr</span> <span class="bound">n</span> <span class="bound">x</span> <span class="bound">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">Σ2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x'</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rewrite_prog <span class="free">n</span> <span class="free">xs</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gen_pop_push</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_pop_push</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">domain</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">codomain</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ar</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">domain</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">ar</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">∧</span> take <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domain</span></span></span> <span class="keyword1">then</span>
      Ok <span class="main">(</span><span class="free"><span class="bound"><span class="entity">instr</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">codomain</span></span></span> <span class="main">#</span> drop <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      Error <span class="main">()</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> inca_to_ubx_simulation <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_rewrite_prog"><span class="command">lemma</span></span> sp_rewrite_prog<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rewrite_prog <span class="free">f</span> <span class="free">n</span> <span class="free">p1</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">p2</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Σ1</span> <span class="bound">n</span> <span class="bound">x'</span> <span class="bound">Σ2</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="bound">x</span> <span class="bound">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">Σ2</span><span class="main">)</span> <span class="main">⟹</span> Subx.sp_instr <span class="free">F</span> <span class="bound">x'</span> <span class="bound">Σ1</span> <span class="main">=</span> Ok <span class="bound">Σ2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F</span> <span class="free">p2</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lifting›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">get_arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fun</span> <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">load_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> type option"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.IPush <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>IPush <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> Inca.IPop <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>IPop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> gen_pop_push <span class="main">(</span>IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span>
    gen_pop_push <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main">(</span>Inca.ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ar</span> <span class="main">←</span> Result.of_option <span class="main">()</span> <span class="main">(</span><span class="free">get_arity</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    gen_pop_push <span class="main">(</span>ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="bound">ar</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>
  <span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Error <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="main">=</span> rewrite_prog <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lift_instr<span class="main">)</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_lift_instr"><span class="command">lemma</span></span> sp_lift_instr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"lift_instr <span class="free">instr</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">instr'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">get_arity</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp_instr <span class="free">F</span> <span class="free">instr'</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">instr</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift_instr.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">Σ</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lift_instr <span class="main">(</span>Inca.ICall <span class="skolem">f</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">instr'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Subx.sp_instr <span class="free">F</span> <span class="free">instr'</span> <span class="skolem">Σ</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_Some1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_lift"><span class="command">lemma</span></span> sp_lift<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"lift <span class="free">n</span> <span class="free">p1</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">p2</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">get_arity</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F</span> <span class="free">p2</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_rewrite_prog sp_lift_instr <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-norm_lift_instr"><span class="command">lemma</span></span> norm_lift_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"lift_instr <span class="free">x</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span> <span class="main">⟹</span> norm_instr <span class="free">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift_instr.induct<span class="main"><span class="keyword3">;</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-norm_lift"><span class="command">lemma</span></span> norm_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">n</span> <span class="free">xs</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map norm_instr <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rewrite_prog_map_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> lift_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_lift_instr<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimization›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">result_alternative</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">&lt;|&gt;</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">result_alternative</span> <span class="main">(</span>Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">result_alternative</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">result_alternative</span> <span class="main">(</span>Error <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Error <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">try_unbox</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">try_unbox</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">unbox</span></span></span> <span class="free"><span class="bound"><span class="entity">mk_instr</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">unbox</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> Ok <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mk_instr</span></span></span> <span class="bound">n</span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> Error <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">optim_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span>
    try_unbox Ubx1 <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">unbox_ubx1</span> IPushUbx1 <span class="main">&lt;|&gt;</span>
    try_unbox Ubx2 <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">unbox_ubx2</span> IPushUbx2 <span class="main">&lt;|&gt;</span>
    Ok <span class="main">(</span>IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
  "</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPushUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>IPushUbx1 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Some Ubx1 <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IPushUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> Ok <span class="main">(</span>IPushUbx2 <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> Some Ubx2 <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> IPop <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>IPop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free">load_oracle</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      Some <span class="bound">τ</span> <span class="main">⇒</span> Ok <span class="main">(</span>ILoadUbx <span class="bound">τ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Some <span class="bound">τ</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">|</span>
      <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Ok <span class="main">(</span>ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>ILoadUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>ILoadUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span>IStoreUbx <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IStoreUbx <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> Some <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">then</span> Ok <span class="main">(</span>IStoreUbx <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Error <span class="main">()</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> gen_pop_push <span class="main">(</span>IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ar</span> <span class="main">=</span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">ar</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">case</span> <span class="free">𝔘𝔟𝔵</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span> <span class="main">(</span>take <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> gen_pop_push <span class="main">(</span>IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="bound">ar</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">|</span>
        Some <span class="bound">opubx</span> <span class="main">⇒</span> Ok <span class="main">(</span>IOpUbx <span class="bound">opubx</span><span class="main">,</span> snd <span class="main">(</span><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="bound">opubx</span><span class="main">)</span> <span class="main">#</span> drop <span class="bound">ar</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      Error <span class="main">()</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>IOpUbx <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> gen_pop_push <span class="main">(</span>IOpUbx <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">opubx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ar</span> <span class="main">←</span> Result.of_option <span class="main">()</span> <span class="main">(</span><span class="free">get_arity</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    gen_pop_push <span class="main">(</span>ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>replicate <span class="bound">ar</span> None<span class="main">,</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span>
  <span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">optim_instr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Error <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">optim</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">optim</span> <span class="main">≡</span> rewrite_prog optim_instr"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"optim <span class="main">0</span> <span class="main">[</span>IPush <span class="free">d<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> IPush <span class="free">d<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> IStore <span class="free">y</span><span class="main">]</span> <span class="main">[]</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">unbox_ubx1</span> <span class="free">d<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">unbox_ubx1</span> <span class="free">d<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="free">unbox_ubx2</span> <span class="free">d<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span>IPushUbx1 <span class="free">x</span><span class="main">,</span> IPush <span class="free">d<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> IStoreUbx Ubx1 <span class="free">y</span><span class="main">]</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms optim_def try_unbox_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-norm_optim_instr"><span class="command">lemma</span></span> norm_optim_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"optim_instr <span class="free">n</span> <span class="free">x</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span> <span class="main">⟹</span> norm_instr <span class="free">x'</span> <span class="main">=</span> norm_instr <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">Σ1</span> <span class="free">n</span> <span class="free">x'</span> <span class="free">Σ2</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> optim_instr.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">Σ1</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"optim_instr <span class="skolem">n</span> <span class="main">(</span>Ubx.IPush <span class="skolem">d</span><span class="main">)</span> <span class="skolem">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm_instr <span class="free">x'</span> <span class="main">=</span> norm_instr <span class="main">(</span>Ubx.instr.IPush <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Subx.box_unbox_inverse
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> result_alternative.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> try_unbox_def option.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">Σ1</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"optim_instr <span class="skolem">n</span> <span class="main">(</span>Ubx.ILoad <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">Σ1</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm_instr <span class="free">x'</span> <span class="main">=</span> norm_instr <span class="main">(</span>Ubx.ILoad <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">load_oracle</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">opinl</span> <span class="skolem">Σ1</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"optim_instr <span class="skolem">n</span> <span class="main">(</span>IOpInl <span class="skolem">opinl</span><span class="main">)</span> <span class="skolem">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> arity_le_Σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">Σ1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm_instr <span class="free">x'</span> <span class="main">=</span> norm_instr <span class="main">(</span>IOpInl <span class="skolem">opinl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵</span> <span class="skolem">opinl</span> <span class="main">(</span>take <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Σ1</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms arity_le_Σ1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">opubx</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms arity_le_Σ1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta Subx.𝔘𝔟𝔵_invertible<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">opubx</span> <span class="skolem">Σ1</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"optim_instr <span class="skolem">n</span> <span class="main">(</span>IOpUbx <span class="skolem">opubx</span><span class="main">)</span> <span class="skolem">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">x'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm_instr <span class="free">x'</span> <span class="main">=</span> norm_instr <span class="main">(</span>IOpUbx <span class="skolem">opubx</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-norm_optim"><span class="command">lemma</span></span> norm_optim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"optim <span class="free">n</span> <span class="free">xs</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map norm_instr <span class="free">ys</span> <span class="main">=</span> map norm_instr <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> optim_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">Σ2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_optim_instr<span class="main">)</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_optim_instr"><span class="command">lemma</span></span> sp_optim_instr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"optim_instr <span class="free">n</span> <span class="free">instr</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">instr'</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">get_arity</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp_instr <span class="free">F</span> <span class="free">instr'</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">instr</span></span> <span class="quoted"><span class="free">Σ1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> optim_instr.induct<span class="main"><span class="keyword3">;</span></span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ d
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> result_alternative.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> try_unbox_def option.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">load_oracle</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ opinl Σ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔘𝔟𝔵</span> <span class="skolem">opinl</span> <span class="main">(</span>take <span class="main">(</span><span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">opinl</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Σ</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all_eq_const_imp_replicate
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_beta Let_def min.absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> opubx
      <span class="keyword1"><span class="command">using</span></span> Subx.𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭_𝔄𝔯𝔦𝔱𝔶<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">opubx</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Subx.𝔘𝔟𝔵_invertible <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Subx.𝔘𝔟𝔵_opubx_type<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ opubx
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝔗𝔶𝔭𝔢𝔒𝔣𝔒𝔭</span> <span class="skolem">opubx</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ f
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_Some1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_optim"><span class="command">lemma</span></span> sp_optim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"optim <span class="free">n</span> <span class="free">p1</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">p2</span><span class="main">,</span> <span class="free">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">get_arity</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Subx.sp <span class="free">F</span> <span class="free">p2</span> <span class="free">Σ1</span> <span class="main">=</span> Ok <span class="free">Σ2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_rewrite_prog sp_optim_instr <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> optim_def<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compilation of function definition›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compile_fundef</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_fundef</span> <span class="main">(</span>Fundef <span class="free"><span class="bound"><span class="entity">instrs</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">Σ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">←</span> lift <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">instrs</span></span></span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">ar</span></span></span> None <span class="main">::</span> type option list<span class="main">)</span><span class="main">;</span>

    <span class="comment1">― ‹Ensure that the function returns a single dynamic result›</span>
    <span class="main">()</span> <span class="main">←</span> <span class="keyword1">if</span> <span class="bound">Σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span> <span class="keyword1">then</span> Ok <span class="main">()</span> <span class="keyword1">else</span> Error <span class="main">()</span><span class="main">;</span>

    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">Σ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">←</span> optim <span class="main">0</span> <span class="bound">xs</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">ar</span></span></span> None<span class="main">)</span><span class="main">;</span>

    Ok <span class="main">(</span>Fundef <span class="main">(</span>
    <span class="keyword1">if</span> <span class="bound">Σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span> <span class="keyword1">then</span>
      <span class="bound">ys</span> <span class="comment1">― ‹use optimization›</span>
    <span class="keyword1">else</span>
      <span class="bound">xs</span> <span class="comment1">― ‹cancel optimization›</span>
    <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-rel_compile_fundef"><span class="command">lemma</span></span> rel_compile_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile_fundef <span class="free">fd1</span> <span class="main">=</span> Ok <span class="free">fd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">Σ2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    lift_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="main">0</span> <span class="skolem">xs</span> <span class="main">(</span>replicate <span class="skolem">ar</span> None <span class="main">::</span> type option list<span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="main">[</span>None<span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    optim_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"optim <span class="main">0</span> <span class="skolem">ys</span> <span class="main">(</span>replicate <span class="skolem">ar</span> None <span class="main">::</span> type option list<span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Σ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    check<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fd2</span> <span class="main">=</span> Fundef <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">Σ2</span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span> <span class="keyword1">then</span> <span class="skolem">zs</span> <span class="keyword1">else</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">ar</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Fundef
    <span class="keyword1"><span class="command">unfolding</span></span> compile_fundef.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nitpick.case_unit_unfold if_then_else_distributive<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map norm_instr <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> norm_lift<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Σ2</span> <span class="main">=</span> <span class="main">[</span>None<span class="main">]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True Fundef
      <span class="keyword1"><span class="command">using</span></span> check norm_lift<span class="main">[</span><span class="operator">OF</span> lift_xs<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> norm_optim<span class="main">[</span><span class="operator">OF</span> optim_ys<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map list.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Fundef check norm_lift<span class="main">[</span><span class="operator">OF</span> lift_xs<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map list.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_compile_fundef"><span class="command">lemma</span></span> sp_compile_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compile_fundef <span class="free">fd1</span> <span class="main">=</span> Ok <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">get_arity</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="free">F</span> <span class="free">fd2</span> <span class="main">(</span>body <span class="free">fd2</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_optim sp_lift <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_fundef_def Nitpick.case_unit_unfold if_eq_const_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> inca_ubx_compiler <span class="main">=</span>
  inca_to_ubx_simulation <span class="quoted"><span class="free">Finca_empty</span></span> <span class="quoted"><span class="free">Finca_get</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">Finca_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Finca_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">_</span> option"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">load_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fun</span> <span class="main">⇒</span> nat <span class="main">⇒</span> type option"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compilation of function environment›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile_env_entry</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_env_entry</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒪</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> map_result id <span class="main">(</span>Pair <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>compile_fundef <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">𝒪</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-rel_compile_env_entry"><span class="command">lemma</span></span> rel_compile_env_entry<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile_env_entry <span class="free">𝒪</span> <span class="free">𝒜</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">fd1</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">fd2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compile_env_entry_def
  <span class="keyword1"><span class="command">using</span></span> rel_compile_fundef
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_compile_env_entry"><span class="command">lemma</span></span> sp_compile_env_entry<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">fd1</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">fd2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="free">F</span> <span class="free">fd2</span> <span class="main">(</span>body <span class="free">fd2</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compile_env_entry_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sp_compile_fundef<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile_env</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_env</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒪</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    map_result id Subx.Fenv.from_list
      <span class="main">(</span>Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒪</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_to_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-list_assoc_those_compile_env_entries"><span class="command">lemma</span></span> list_assoc_those_compile_env_entries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Ok <span class="free">ys</span> <span class="main">⟹</span>
  rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">fd1</span> <span class="bound">fd2</span><span class="main">.</span> compile_fundef <span class="free">𝒜</span> <span class="main">(</span><span class="free">𝒪</span> <span class="free">f</span><span class="main">)</span> <span class="bound">fd1</span> <span class="main">=</span> Ok <span class="bound">fd2</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">ys</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    comp_x<span class="main">:</span> <span class="quoted"><span class="quoted">"compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="skolem">x</span> <span class="main">=</span> Ok <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    comp_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Ok <span class="skolem">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prods<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">fd1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compile_env_entry_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compile_fundef <span class="free">𝒜</span> <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">g</span><span class="main">)</span> <span class="skolem">fd1</span> <span class="main">=</span> Ok <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_x <span class="keyword1"><span class="command">unfolding</span></span> prods compile_env_entry_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prods xs_def
    <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> comp_xs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-compile_env_rel_compile_fundef"><span class="command">lemma</span></span> compile_env_rel_compile_fundef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile_env <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="free">F1</span> <span class="main">=</span> Ok <span class="free">F2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">fd1</span> <span class="bound">fd2</span><span class="main">.</span> compile_fundef <span class="free">𝒜</span> <span class="main">(</span><span class="free">𝒪</span> <span class="free">f</span><span class="main">)</span> <span class="bound">fd1</span> <span class="main">=</span> Ok <span class="bound">fd2</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> those_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_to_list</span> <span class="free">F1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> compile_env_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> F2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="main">=</span> Subx.Fenv.from_list <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> compile_env_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span><span class="free">Finca_to_list</span> <span class="free">F1</span><span class="main">)</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F2_def Subx.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Sinca.Fenv.to_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> list_assoc_those_compile_env_entries<span class="main">[</span><span class="operator">OF</span> those_xs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">fd1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> F2_def Subx.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Sinca.Fenv.to_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> list_assoc_those_compile_env_entries<span class="main">[</span><span class="operator">OF</span> those_xs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-rel_those_compile_env_entries"><span class="command">lemma</span></span> rel_those_compile_env_entries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Ok <span class="free">ys</span> <span class="main">⟹</span>
  rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="main">(</span>Sinca.Fenv.from_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="main">(</span>Subx.Fenv.from_list <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_fundefs_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    comp_x<span class="main">:</span> <span class="quoted"><span class="quoted">"compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="skolem">x</span> <span class="main">=</span> Ok <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    comp_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Ok <span class="skolem">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prods<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">fd1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compile_env_entry_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_compile_env_entry<span class="main">[</span><span class="operator">OF</span> comp_x<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> prods<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prods xs_def
    <span class="keyword1"><span class="command">unfolding</span></span> Sinca.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Subx.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> comp_xs<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sinca.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Subx.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fundefs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-rel_fundefs_compile_env"><span class="command">lemma</span></span> rel_fundefs_compile_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile_env <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="free">e</span> <span class="main">=</span> Ok <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Finca_get</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    FOO<span class="main">:</span> <span class="quoted"><span class="quoted">"Result.those <span class="main">(</span>map <span class="main">(</span>compile_env_entry <span class="free">𝒜</span> <span class="free">𝒪</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_to_list</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Ok <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    BAR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e'</span> <span class="main">=</span> Subx.Fenv.from_list <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compile_env_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rel_those_compile_env_entries<span class="main">[</span><span class="operator">OF</span> FOO<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> BAR
    <span class="keyword1"><span class="command">unfolding</span></span> Sinca.Fenv.get_from_list_to_list
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-sp_fundefs_compile_env"><span class="command">lemma</span></span> sp_fundefs_compile_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compile_env <span class="free">𝒜</span> <span class="free">𝒪</span> <span class="free">F1</span> <span class="main">=</span> Ok <span class="free">F2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_fundefs_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">fd2</span>
    <span class="keyword3"><span class="command">assume</span></span> F2_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      compile_fd1<span class="main">:</span> <span class="quoted"><span class="quoted">"compile_fundef <span class="free">𝒜</span> <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">fd1</span> <span class="main">=</span> Ok <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> compile_env_rel_compile_fundef<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_Some2<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> rel_F1_F2 <span class="main">=</span> rel_fundefs_compile_env<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">ar</span> <span class="bound">fd</span><span class="main">.</span> arity <span class="bound">fd</span> <span class="main">=</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option.rel_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_None1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ar</span> <span class="skolem">fd1</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Fubx_get</span> <span class="free">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> norm_instr <span class="bound">y</span><span class="main">)</span> <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rel_fundefs_Some1<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fundef_arities<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sp_fundef <span class="main">(</span><span class="free">Fubx_get</span> <span class="free">F2</span><span class="main">)</span> <span class="skolem">fd2</span> <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span> <span class="main">=</span> Ok <span class="main">[</span>None<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sp_compile_fundef<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compile_fd1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compilation of program›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compile</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="main">(</span>Prog <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Result.to_option <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">F'</span> <span class="main">←</span> compile_env <span class="main">(</span>map_option arity <span class="main">∘</span> <span class="free">Finca_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="free">load_oracle</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span>
    Ok <span class="main">(</span>Prog <span class="bound">F'</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inca_to_Ubx_compiler-compile_load"><span class="command">lemma</span></span> compile_load<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    compile_p1<span class="main">:</span> <span class="quoted"><span class="quoted">"compile <span class="free">p1</span> <span class="main">=</span> Some <span class="free">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    load<span class="main">:</span> <span class="quoted"><span class="quoted">"Subx.load <span class="free">p2</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span><span class="main">.</span> Sinca.load <span class="free">p1</span> <span class="bound">s1</span> <span class="main">∧</span> match <span class="bound">s1</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F1</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="skolem"><span class="skolem">main</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">=</span> Prog <span class="skolem">F1</span> <span class="skolem">H</span> <span class="skolem">main</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    compile_F1<span class="main">:</span> <span class="quoted"><span class="quoted">"compile_env <span class="main">(</span>map_option arity <span class="main">∘</span> <span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="free">load_oracle</span> <span class="skolem">F1</span> <span class="main">=</span> Ok <span class="skolem">F2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> Prog <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">main</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> compile_p1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">note</span></span> rel_F1_F2 <span class="main">=</span> rel_fundefs_compile_env<span class="main">[</span><span class="operator">OF</span> compile_F1<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> p2_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="main">_</span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Subx.load.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">fd2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">[</span>Frame <span class="skolem">main</span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      Fstd_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F1</span> <span class="skolem">main</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"compile_fundef <span class="main">(</span>map_option arity <span class="main">∘</span> <span class="free">Finca_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">load_oracle</span> <span class="skolem">main</span><span class="main">)</span> <span class="skolem">fd1</span> <span class="main">=</span> Ok <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> compile_env_rel_compile_fundef<span class="main">[</span><span class="operator">OF</span> compile_F1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">main</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_Some2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">fd1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundef.rel_sel rel_compile_fundef <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sinca.load <span class="free">p1</span> <span class="var">?s1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> p1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.load.intros<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Fstd_main<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_fundefs <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sp_fundefs_compile_env<span class="main"><span class="main">[</span></span><span class="operator">OF</span> compile_F1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option.rel_map option.rel_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_stacktraces <span class="main">(</span><span class="free">Fubx_get</span> <span class="skolem">F2</span><span class="main">)</span> <span class="main">[</span>Frame <span class="skolem">main</span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span> <span class="main">[</span>Frame <span class="skolem">main</span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_stacktraces.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_fundef_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 1
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> std_to_inca_compiler<span class="main">:</span>
  compiler <span class="quoted">Sinca.step</span> <span class="quoted">Subx.step</span> <span class="quoted">Sinca.final</span> <span class="quoted">Subx.final</span> <span class="quoted">Sinca.load</span> <span class="quoted">Subx.load</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span> <span class="quoted">compile</span>
<span class="keyword1"><span class="command">using</span></span> compile_load
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Op_example">
<div class="head">
<h1>Theory Op_example</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Op_example
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#OpUbx">OpUbx</a> <a href="#Ubx_type_inference">Ubx_type_inference</a> <a href="#Global">Global</a> <a href="#Unboxed_lemmas">Unboxed_lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Dynamic values›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> dynamic <span class="main">=</span> DNil <span class="main">|</span> DBool <span class="quoted">bool</span> <span class="main">|</span> DNum <span class="quoted">nat</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_true</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_true</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> DBool True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_false</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_false</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> DBool False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">box_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">box_bool</span> <span class="main">=</span> DBool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">box_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">box_num</span> <span class="main">=</span> DNum"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unbox_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">unbox_num</span> <span class="main">(</span>DNum <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">unbox_num</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unbox_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic <span class="main">⇒</span> bool option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">unbox_bool</span> <span class="main">(</span>DBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">unbox_bool</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> unboxed_dynamic<span class="main">:</span>
  unboxedval <span class="quoted">is_true</span> <span class="quoted">is_false</span> <span class="quoted">box_num</span> <span class="quoted">unbox_num</span> <span class="quoted">box_bool</span> <span class="quoted">unbox_bool</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_true_def is_false_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unbox_num <span class="skolem">d</span> <span class="main">=</span> Some <span class="skolem">n</span> <span class="main">⟹</span> box_num <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> box_num_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unbox_bool <span class="skolem">d</span> <span class="main">=</span> Some <span class="skolem">b</span> <span class="main">⟹</span> box_bool <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> box_bool_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Normal operations›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op <span class="main">=</span>
  OpNeg <span class="main">|</span>
  OpAdd <span class="main">|</span>
  OpMul

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ar</span> OpNeg <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ar</span> OpAdd <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ar</span> OpMul <span class="main">=</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_Neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Neg</span> <span class="main">[</span>DBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">=</span> DBool <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Neg</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> DNil"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_Add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Add</span> <span class="main">[</span>DBool <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DBool <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Add</span> <span class="main">[</span>DNum <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DNum <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DNum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Add</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> DNil"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_Mul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Mul</span> <span class="main">[</span>DBool <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DBool <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Mul</span> <span class="main">[</span>DNum <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DNum <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DNum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_Mul</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> DNil"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> OpNeg <span class="main">=</span> eval_Neg"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> OpAdd <span class="main">=</span> eval_Add"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> OpMul <span class="main">=</span> eval_Mul"</span></span>

<span class="keyword1" id="Op_example-eval_arith_domain"><span class="command">lemma</span></span> eval_arith_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> ar <span class="free">op</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> op_Op<span class="main">:</span> nary_operations <span class="quoted">eval</span> <span class="quoted">ar</span>
  <span class="keyword1"><span class="command">using</span></span> eval_arith_domain
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Inlined operations›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> opinl <span class="main">=</span>
  OpAddNum <span class="main">|</span>
  OpMulNum

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> dynamic list <span class="main">⇒</span> opinl option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inl</span> OpAdd <span class="main">[</span>DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> Some OpAddNum"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">inl</span> OpMul <span class="main">[</span>DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> Some OpMulNum"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">inl</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">isinl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opinl <span class="main">⇒</span> dynamic list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isinl</span> OpAddNum <span class="main">[</span>DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">isinl</span> OpMulNum <span class="main">[</span>DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> DNum <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deinl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opinl <span class="main">⇒</span> op"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deinl</span> OpAddNum <span class="main">=</span> OpAdd"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">deinl</span> OpMulNum <span class="main">=</span> OpMul"</span></span>

<span class="keyword1" id="Op_example-inl_inj"><span class="command">lemma</span></span> inl_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj inl"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inl <span class="skolem">x</span> <span class="main">=</span> inl <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> inl.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOL.eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">None</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Op_example-inl_invertible"><span class="command">lemma</span></span> inl_invertible<span class="main">:</span> <span class="quoted"><span class="quoted">"inl <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">opinl</span> <span class="main">⟹</span> deinl <span class="free">opinl</span> <span class="main">=</span> <span class="free">op</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">op</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inl.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_AddNum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_AddNum</span> <span class="main">[</span>DNum <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DNum <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DNum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_AddNum</span> <span class="main">[</span>DBool <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DBool <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_AddNum</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> DNil"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_MulNum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_MulNum</span> <span class="main">[</span>DNum <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DNum <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DNum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_MulNum</span> <span class="main">[</span>DBool <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> DBool <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> DBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_MulNum</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> DNil"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_inl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opinl <span class="main">⇒</span> dynamic list <span class="main">⇒</span> dynamic"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_inl</span> OpAddNum <span class="main">=</span> eval_AddNum"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_inl</span> OpMulNum <span class="main">=</span> eval_MulNum"</span></span>

<span class="keyword1" id="Op_example-eval_AddNum_correct"><span class="command">lemma</span></span> eval_AddNum_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> eval_AddNum <span class="free">xs</span> <span class="main">=</span> eval_Add <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_AddNum.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Op_example-eval_MulNum_correct"><span class="command">lemma</span></span> eval_MulNum_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> eval_MulNum <span class="free">xs</span> <span class="main">=</span> eval_Mul <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_MulNum.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Op_example-eval_inl_correct"><span class="command">lemma</span></span> eval_inl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> ar <span class="main">(</span>deinl <span class="free">opinl</span><span class="main">)</span> <span class="main">⟹</span> eval_inl <span class="free">opinl</span> <span class="free">xs</span> <span class="main">=</span> eval <span class="main">(</span>deinl <span class="free">opinl</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eval_AddNum_correct eval_MulNum_correct
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">opinl</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Op_example-inl_isinl"><span class="command">lemma</span></span> inl_isinl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inl <span class="free">op</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">opinl</span> <span class="main">⟹</span> isinl <span class="free">opinl</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">op</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inl.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> isinl.intros<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> op_OpInl<span class="main">:</span> nary_operations_inl <span class="quoted">eval</span> <span class="quoted">ar</span> <span class="quoted">eval_inl</span> <span class="quoted">inl</span> <span class="quoted">isinl</span> <span class="quoted">deinl</span>
  <span class="keyword1"><span class="command">using</span></span> inl_invertible
  <span class="keyword1"><span class="command">using</span></span> eval_inl_correct
  <span class="keyword1"><span class="command">using</span></span> inl_isinl
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unboxed operations›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> opubx <span class="main">=</span>
  OpAddNumUbx

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ubx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opinl <span class="main">⇒</span> type option list <span class="main">⇒</span> opubx option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ubx</span> OpAddNum <span class="main">[</span>Some Ubx1<span class="main">,</span> Some Ubx1<span class="main">]</span> <span class="main">=</span> Some OpAddNumUbx"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ubx</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deubx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opubx <span class="main">⇒</span> opinl"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deubx</span> OpAddNumUbx <span class="main">=</span> OpAddNum"</span></span>

<span class="keyword1" id="Op_example-ubx_invertible"><span class="command">lemma</span></span> ubx_invertible<span class="main">:</span> <span class="quoted"><span class="quoted">"ubx <span class="free">opinl</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">opubx</span> <span class="main">⟹</span> deubx <span class="free">opubx</span> <span class="main">=</span> <span class="free">opinl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">opinl</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ubx.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_AddNumUbx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dynamic<span class="main">,</span> nat<span class="main">,</span> bool<span class="main">)</span> unboxed list <span class="main">⇒</span> <span class="main">(</span>dynamic<span class="main">,</span> nat<span class="main">,</span> bool<span class="main">)</span> unboxed option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_AddNumUbx</span> <span class="main">[</span>OpUbx1 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> OpUbx1 <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span>OpUbx1 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_AddNumUbx</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_ubx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opubx <span class="main">⇒</span> <span class="main">(</span>dynamic<span class="main">,</span> nat<span class="main">,</span> bool<span class="main">)</span> unboxed list <span class="main">⇒</span> <span class="main">(</span>dynamic<span class="main">,</span> nat<span class="main">,</span> bool<span class="main">)</span> unboxed option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_ubx</span> OpAddNumUbx <span class="main">=</span> eval_AddNumUbx"</span></span>

<span class="keyword1" id="Op_example-eval_ubx_correct"><span class="command">lemma</span></span> eval_ubx_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_ubx <span class="free">opubx</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span>
    eval_inl <span class="main">(</span>deubx <span class="free">opubx</span><span class="main">)</span> <span class="main">(</span>map unboxed_dynamic.norm_unboxed <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> unboxed_dynamic.norm_unboxed <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">opubx</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_AddNumUbx.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> box_num_def<span class="main">)</span>

<span class="keyword1" id="Op_example-eval_ubx_to_inl"><span class="command">lemma</span></span> eval_ubx_to_inl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval_ubx <span class="free">opubx</span> <span class="free">Σ</span> <span class="main">=</span> Some <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inl <span class="main">(</span>deinl <span class="main">(</span>deubx <span class="free">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map unboxed_dynamic.norm_unboxed <span class="free">Σ</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>deubx <span class="free">opubx</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">opubx</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> OpAddNumUbx
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_AddNumUbx <span class="free">Σ</span> <span class="main">=</span> Some <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> OpAddNumUbx
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_AddNumUbx.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> box_num_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract interpretation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">typeof_opubx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opubx <span class="main">⇒</span> type option list <span class="main">×</span> type option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">typeof_opubx</span> OpAddNumUbx <span class="main">=</span> <span class="main">(</span><span class="main">[</span>Some Ubx1<span class="main">,</span> Some Ubx1<span class="main">]</span><span class="main">,</span> Some Ubx1<span class="main">)</span>"</span></span>

<span class="keyword1" id="Op_example-ubx_imp_typeof_opubx"><span class="command">lemma</span></span> ubx_imp_typeof_opubx<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ubx <span class="free">opinl</span> <span class="free">ts</span> <span class="main">=</span> Some <span class="free">opubx</span> <span class="main">⟹</span> fst <span class="main">(</span>typeof_opubx <span class="free">opubx</span><span class="main">)</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">opinl</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ubx.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Op_example-typeof_opubx_correct"><span class="command">lemma</span></span> typeof_opubx_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"typeof_opubx <span class="free">opubx</span> <span class="main">=</span> <span class="main">(</span>map typeof <span class="free">xs</span><span class="main">,</span> <span class="free">codomain</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval_ubx <span class="free">opubx</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> typeof <span class="bound">y</span> <span class="main">=</span> <span class="free">codomain</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">opubx</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> OpAddNumUbx
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span>OpUbx1 <span class="skolem">n1</span><span class="main">,</span> OpUbx1 <span class="skolem">n2</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">codomain</span> <span class="main">=</span> Some Ubx1"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpAddNumUbx<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> typeof_unboxed_inversion<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Op_example-typeof_opubx_complete"><span class="command">lemma</span></span> typeof_opubx_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_ubx <span class="free">opubx</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span>
    typeof_opubx <span class="free">opubx</span> <span class="main">=</span> <span class="main">(</span>map typeof <span class="free">xs</span><span class="main">,</span> typeof <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">opubx</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> OpAddNumUbx
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eval_AddNumUbx.elims<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Op_example-typeof_opubx_ar"><span class="command">lemma</span></span> typeof_opubx_ar<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>typeof_opubx <span class="free">opubx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ar <span class="main">(</span>deinl <span class="main">(</span>deubx <span class="free">opubx</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">opubx</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> op_OpUbx<span class="main">:</span>
  nary_operations_ubx
    <span class="quoted">eval</span> <span class="quoted">ar</span> <span class="quoted">eval_inl</span> <span class="quoted">inl</span> <span class="quoted">isinl</span> <span class="quoted">deinl</span>
    <span class="quoted">is_true</span> <span class="quoted">is_false</span> <span class="quoted">box_num</span> <span class="quoted">unbox_num</span> <span class="quoted">box_bool</span> <span class="quoted">unbox_bool</span>
    <span class="quoted">eval_ubx</span> <span class="quoted">ubx</span> <span class="quoted">deubx</span> <span class="quoted">typeof_opubx</span>
  <span class="keyword1"><span class="command">using</span></span> ubx_invertible
  <span class="keyword1"><span class="command">using</span></span> eval_ubx_correct
  <span class="keyword1"><span class="command">using</span></span> eval_ubx_to_inl
  <span class="keyword1"><span class="command">using</span></span> ubx_imp_typeof_opubx
  <span class="keyword1"><span class="command">using</span></span> typeof_opubx_correct
  <span class="keyword1"><span class="command">using</span></span> typeof_opubx_complete
  <span class="keyword1"><span class="command">using</span></span> typeof_opubx_ar
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Std">
<div class="head">
<h1>Theory Std</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Std
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#List_util">List_util</a> <a href="#Global">Global</a> <a href="#Op">Op</a> <a href="#Env">Env</a> <a href="#Env_list">Env_list</a> <a href="#Dynamic">Dynamic</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Language">VeriComp.Language</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">)</span> instr <span class="main">=</span>
  IPush <span class="tfree"><span class="quoted"><span class="tfree">'dyn</span></span></span> <span class="main">|</span>
  IPop <span class="main">|</span>
  ILoad <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IStore <span class="tfree"><span class="quoted"><span class="tfree">'var</span></span></span> <span class="main">|</span>
  IOp <span class="tfree"><span class="quoted"><span class="tfree">'op</span></span></span> <span class="main">|</span>
  ICJump <span class="quoted">nat</span> <span class="main">|</span>
  ICall <span class="tfree"><span class="quoted"><span class="tfree">'fun</span></span></span>

<span class="keyword1"><span class="command">locale</span></span> std <span class="main">=</span>
  Fenv<span class="main">:</span> env <span class="quoted"><span class="free">F_empty</span></span> <span class="quoted"><span class="free">F_get</span></span> <span class="quoted"><span class="free">F_add</span></span> <span class="quoted"><span class="free">F_to_list</span></span> <span class="main">+</span>
  Henv<span class="main">:</span> env <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span> <span class="main">+</span>
  dynval <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span> <span class="main">+</span>
  nary_operations <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">F_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">)</span> instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">F_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'henv</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> list <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'henv</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'dyn</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">final</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  step_push<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_pop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IPop <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_load<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">heap_get</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_store<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    <span class="free">heap_add</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H'</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_op<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">⟹</span>
    <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free">𝔒𝔭</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> drop <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_true<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">is_true</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_cjump_false<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">is_false</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_call<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">fd</span></span></span><span class="main">)</span> <span class="main">⟹</span> body <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> ICall <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
    <span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  step_fun_end<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> length <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">=</span> Frame <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pc<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">gd</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ<span class="hidden">⇩</span><sub>f</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span>
    State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>g</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">frame<span class="hidden">⇩</span><sub>f</sub>'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Std-step_deterministic"><span class="command">lemma</span></span> step_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">→</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">→</span> <span class="free">s3</span> <span class="main">⟹</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">s3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.cases<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_true_and_is_false_implies_False<span class="main">)</span>

<span class="keyword1" id="Std-final_finished"><span class="command">lemma</span></span> final_finished<span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="free">s</span> <span class="main">⟹</span> finished step <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finished_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"final <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> step <span class="free">s</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"step <span class="free">s</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹final <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.cases final.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> semantics <span class="quoted">step</span> <span class="quoted">final</span>
  <span class="keyword1"><span class="command">using</span></span> final_finished step_deterministic
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">load</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">)</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'fenv</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> frame<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_get</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">⟹</span> arity <span class="free"><span class="bound"><span class="entity">fd</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="free">load</span> <span class="main">(</span>Prog <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span><span class="main">)</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">[</span>Frame <span class="free"><span class="bound"><span class="entity">main</span></span></span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> language <span class="quoted">step</span> <span class="quoted">final</span> <span class="quoted">load</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Std_to_Inca_simulation">
<div class="head">
<h1>Theory Std_to_Inca_simulation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Std_to_Inca_simulation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Global">Global</a> <a href="#List_util">List_util</a> <a href="#Std">Std</a> <a href="#Inca">Inca</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Simulation">VeriComp.Simulation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic definitions›</span></span>

<span class="keyword1"><span class="command">print_locale</span></span> std

<span class="keyword1"><span class="command">locale</span></span> std_inca_simulation <span class="main">=</span>
  Sstd<span class="main">:</span> std
    <span class="quoted"><span class="free">Fstd_empty</span></span> <span class="quoted"><span class="free">Fstd_get</span></span> <span class="quoted"><span class="free">Fstd_add</span></span> <span class="quoted"><span class="free">Fstd_to_list</span></span>
    <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span>
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="main">+</span>
  Sinca<span class="main">:</span> inca
    <span class="quoted"><span class="free">Finca_empty</span></span> <span class="quoted"><span class="free">Finca_get</span></span> <span class="quoted"><span class="free">Finca_add</span></span> <span class="quoted"><span class="free">Finca_to_list</span></span>
    <span class="quoted"><span class="free">heap_empty</span></span> <span class="quoted"><span class="free">heap_get</span></span> <span class="quoted"><span class="free">heap_add</span></span> <span class="quoted"><span class="free">heap_to_list</span></span>
    <span class="quoted"><span class="free">is_true</span></span> <span class="quoted"><span class="free">is_false</span></span>
    <span class="quoted"><span class="free">𝔒𝔭</span></span> <span class="quoted"><span class="free">𝔄𝔯𝔦𝔱𝔶</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩𝔒𝔭</span></span> <span class="quoted"><span class="free">ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">ℑ𝔰ℑ𝔫𝔩</span></span> <span class="quoted"><span class="free">𝔇𝔢ℑ𝔫𝔩</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="comment1">― ‹Functions environments›</span>
    <span class="free">Fstd_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Fstd_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv_std</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">)</span> Std.instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Fstd_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Fstd_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="free">Finca_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Finca_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'fenv_inca</span> <span class="main">⇒</span> <span class="tfree">'fun</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'dyn</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'fun</span><span class="main">,</span> <span class="tfree">'op</span><span class="main">,</span> <span class="tfree">'opinl</span><span class="main">)</span> Inca.instr fundef option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">Finca_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Finca_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>
    
    <span class="comment1">― ‹Memory heap›</span>
    <span class="free">heap_empty</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_get</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'henv</span> <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">×</span> <span class="tfree">'dyn</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_add</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">heap_to_list</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹Dynamic values›</span>
    <span class="free">is_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'dyn</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_false</span> <span class="keyword2"><span class="keyword">and</span></span>

    <span class="comment1">― ‹n-ary operations›</span>
    <span class="free">𝔒𝔭</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'dyn</span> list <span class="main">⇒</span> <span class="tfree">'dyn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔄𝔯𝔦𝔱𝔶</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℑ𝔫𝔩𝔒𝔭</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'opinl</span> <span class="main">⇒</span> <span class="tfree">'op</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> Std.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> Inca.IPop <span class="main">=</span> Std.IPop"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Std.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Std.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> Std.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.IOpInl <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span> <span class="main">=</span> Std.IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="free"><span class="bound"><span class="entity">opinl</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Std.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_instr</span> <span class="main">(</span>Inca.ICall <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Std.ICall <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">norm_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_eq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> norm_instr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_fundefs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_fundefs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> rel_option <span class="main">(</span>rel_fundef <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> norm_instr <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-rel_fundefs_Some1"><span class="command">lemma</span></span> rel_fundefs_Some1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> rel_fundef norm_eq <span class="free">y</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_Some1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-rel_fundefs_Some2"><span class="command">lemma</span></span> rel_fundefs_Some2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> rel_fundef norm_eq <span class="bound">z</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_Some2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-rel_fundef_body_nth"><span class="command">lemma</span></span> rel_fundef_body_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="free">fd1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"body <span class="free">fd1</span> <span class="main">!</span> <span class="free">pc</span> <span class="main">=</span> norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_nthD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fundef.rel_sel<span class="main">)</span>

<span class="keyword1" id="Std_to_Inca_simulation-rel_fundef_rewrite_body"><span class="command">lemma</span></span> rel_fundef_rewrite_body<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> norm_instr <span class="free">instr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd1</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fundef.rel_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar'</span> <span class="skolem">ys</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 norm_eq <span class="skolem">xs</span> <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> list_all2_all_nthI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> norm_instr <span class="main">(</span>rewrite <span class="skolem">ys</span> <span class="free">pc</span> <span class="free">instr</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_nthD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹list_all2 norm_eq <span class="skolem">xs</span> <span class="skolem">ys</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> Fundef<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Fundef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-rel_fundefs_rewrite"><span class="command">lemma</span></span> rel_fundefs_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F2_get_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F2_add_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_add</span> <span class="free">F2</span> <span class="free">f</span> <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span> <span class="main">=</span> <span class="free">F2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    norm_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="free">fd2</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> norm_instr <span class="free">instr</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="free">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_fundef norm_eq<span class="main">)</span> <span class="main">(</span><span class="free">Fstd_get</span> <span class="free">F1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free">F2'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F2'_get_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F2'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>rewrite_fundef_body <span class="free">fd2</span> <span class="free">pc</span> <span class="free">instr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F2_add_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="free">F1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="free">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2 F2_get_f<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F2'_get_x option_rel_Some2
      <span class="keyword1"><span class="command">using</span></span> True rel_fundef_rewrite_body<span class="main">[</span><span class="operator">OF</span> _ norm_eq<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="free">F2'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">Finca_get</span> <span class="free">F2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F2_add_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 rel_fundefs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">match</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main"><span class="free">∼</span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Backward simulation›</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-backward_lockstep_simulation"><span class="command">lemma</span></span> backward_lockstep_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Sinca.step <span class="free">s2</span> <span class="free">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> Sstd.step <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="bound">s1'</span> <span class="main">∼</span> <span class="free">s2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F1</span></span> <span class="skolem"><span class="skolem">F2</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    s1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> match.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s1_def s2_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="quoted"><span class="free">s2'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Sinca.step.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_push <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_push <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_pop <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_pop <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_pop <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_load <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_load <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_store <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="skolem">H'</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H'</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_store <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_store <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">Σ</span> <span class="skolem">x</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">Σ</span> <span class="skolem">opinl</span> <span class="skolem">x</span> <span class="skolem">F2'</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span>  Sinca.ℑ𝔫𝔩𝔒𝔭_correct Sinca.ℑ𝔫𝔩_invertible
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl Sinca.ℑ𝔫𝔩_invertible
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_fundefs_rewrite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_F1_F2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_hit <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">Σ</span> <span class="skolem">x</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_hit <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> Sinca.ℑ𝔫𝔩𝔒𝔭_correct
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op_inl_miss <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">opinl</span> <span class="skolem">ar</span> <span class="skolem">Σ</span> <span class="skolem">x</span> <span class="skolem">F'</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> Sinca.ℑ𝔫𝔩𝔒𝔭_correct
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_op <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_op_inl_miss rel_fundefs_rewrite<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_true <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">n</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">n</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_cjump_true <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_false <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">n</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.step_cjump_false <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_call <span class="skolem">f</span> <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="skolem">g</span> <span class="skolem">gd2</span> <span class="skolem">Σ</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_fd1_fd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>›</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> arity_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd2</span> <span class="main">=</span> arity <span class="skolem">gd1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Σg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">0</span> <span class="var">?Σg</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call pc_in_range
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> rel_fd1_fd2 pc_in_range<span class="main">]</span> arity_gd1_gd2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sstd.step_fun_call<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_F1_F2 arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_end <span class="skolem">g</span> <span class="skolem">gd2</span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">f</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some2<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> arity_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd2</span> <span class="main">=</span> arity <span class="skolem">gd1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>f</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Σ<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">gd1</span><span class="main">)</span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end <span class="quoted"><span class="quoted">‹<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd1</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span> arity_gd1_gd2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sstd.step_fun_end<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end rel_F1_F2 arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-match_final_backward"><span class="command">lemma</span></span> match_final_backward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span> <span class="main">⟹</span> Sinca.final <span class="free">s2</span> <span class="main">⟹</span> Sstd.final <span class="free">s1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">Σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    st_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pc_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Sinca.final.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 rel_fundefs_Some2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st_def
    <span class="keyword1"><span class="command">using</span></span> pc_def rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sstd.final.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> std_inca_simulation<span class="main">:</span>
  backward_simulation <span class="quoted">Sstd.step</span> <span class="quoted">Sinca.step</span> <span class="quoted">Sstd.final</span> <span class="quoted">Sinca.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_final_backward backward_lockstep_simulation
    lockstep_to_plus_backward_simulation<span class="main">[</span><span class="operator">of</span> <span class="quoted">match</span> <span class="quoted">Sinca.step</span> <span class="quoted">Sstd.step</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Forward simulation›</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-forward_lockstep_simulation"><span class="command">lemma</span></span> forward_lockstep_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Sstd.step <span class="free">s1</span> <span class="free">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s2'</span><span class="main">.</span> Sinca.step <span class="free">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">s1'</span> <span class="main">∼</span> <span class="bound">s2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F1</span></span> <span class="skolem"><span class="skolem">F2</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    s1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rel_F1_F2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="skolem">F1</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="skolem">F2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> match.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s1_def s2_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F1</span> <span class="skolem">H</span> <span class="skolem">st</span>"</span></span> <span class="quoted"><span class="free">s1'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Sstd.step.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_push <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_push <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_push <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> norm_instr.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_pop <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_pop <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_pop <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> norm_instr.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_load <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_load <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_load <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> norm_instr.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_store <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">d</span> <span class="skolem">H'</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H'</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_store <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_store <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> norm_instr.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fundef_body_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_op <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">op</span> <span class="skolem">ar</span> <span class="skolem">Σ</span> <span class="skolem">x</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> F2_get_f<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_op <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> rel_fundef_body_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> norm_body2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> Std.IOp <span class="skolem">op</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_op rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOp <span class="skolem">op'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_body2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔫𝔩</span> <span class="skolem">op'</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> None IOp step_op <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_op<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">opinl</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="main">(</span>IOpInl <span class="skolem">opinl</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="main">(</span><span class="free">Finca_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="var">?fd2'</span><span class="main">)</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some IOp step_op <span class="quoted"><span class="quoted">‹<span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> Sinca.ℑ𝔫𝔩𝔒𝔭_correct Sinca.ℑ𝔫𝔩_invertible
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl<span class="main">)</span>  
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some IOp Sinca.ℑ𝔫𝔩_invertible
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_fundefs_rewrite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_F1_F2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IOpInl <span class="skolem">op'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_body2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ℑ𝔰ℑ𝔫𝔩</span> <span class="skolem">op'</span> <span class="main">(</span>take <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True IOpInl step_op <span class="quoted"><span class="quoted">‹<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> Sinca.ℑ𝔫𝔩𝔒𝔭_correct
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl_hit<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fd2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rewrite_fundef_body <span class="skolem">fd2</span> <span class="skolem">pc</span> <span class="main">(</span>IOp <span class="main">(</span><span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">op'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="main">(</span><span class="free">Finca_add</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="var">?fd2'</span><span class="main">)</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> drop <span class="skolem">ar</span> <span class="skolem">Σ</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False IOpInl step_op <span class="quoted"><span class="quoted">‹<span class="free">𝔇𝔢ℑ𝔫𝔩</span> <span class="skolem">op'</span> <span class="main">=</span> <span class="skolem">op</span>›</span></span> Sinca.ℑ𝔫𝔩𝔒𝔭_correct
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sinca.step_op_inl_miss<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IOpInl
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_fundefs_rewrite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_F1_F2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_true <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">n</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> F2_get_f<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> rel_fundef_body_length step_cjump_true.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> norm_body2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> Std.ICJump <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_cjump_true rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="skolem">n</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true norm_body2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_cjump_true <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> norm_instr.elims<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_true rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_cjump_false <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">n</span> <span class="skolem">d</span> <span class="skolem">Σ</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> F2_get_f<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> rel_fundef_body_length step_cjump_false <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> norm_body2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span><span class="main">)</span> <span class="main">=</span> Std.ICJump <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_cjump_false rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc</span><span class="main">)</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false norm_body2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_cjump_false <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> norm_instr.elims<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_cjump_false rel_F1_F2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_call <span class="skolem">f</span> <span class="skolem">fd1</span> <span class="skolem">pc</span> <span class="skolem">g</span> <span class="skolem">gd1</span> <span class="skolem">Σ</span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> length <span class="main">(</span>body <span class="skolem">fd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_fun_call <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span> rel_fundef_body_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> arity_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd1</span> <span class="main">=</span> arity <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Σg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> <span class="skolem">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">g</span> <span class="main">0</span> <span class="var">?Σg</span> <span class="main">#</span> Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s2'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd2</span> <span class="main">≤</span> length <span class="skolem">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity <span class="skolem">gd1</span> <span class="main">≤</span> length <span class="skolem">Σ</span>›</span></span> arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> Inca.ICall <span class="skolem">g</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_fundef_body_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">pc</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> norm_instr.elims<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> step_fun_call
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> pc_in_range <span class="quoted"><span class="quoted">‹body <span class="skolem">fd2</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> Inca.ICall <span class="skolem">g</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_fun_call<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s2'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_call rel_F1_F2 arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_fun_end <span class="skolem">g</span> <span class="skolem">gd1</span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>g</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">f</span> <span class="skolem">pc<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">frame<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="skolem">st'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rel_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">gd1</span> <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_Some1<span class="main">[</span><span class="operator">OF</span> rel_F1_F2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> pc_at_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">gd2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span> step_fun_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> arity_gd1_gd2<span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd1</span> <span class="main">=</span> arity <span class="skolem">gd2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rel_fundef_arities<span class="main">[</span><span class="operator">OF</span> rel_gd1_gd2<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?STEP</span> <span class="bound">x</span> <span class="main">∧</span> <span class="var">?MATCH</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F2</span> <span class="skolem">H</span> <span class="main">(</span>Frame <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">pc<span class="hidden">⇩</span><sub>f</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Σ<span class="hidden">⇩</span><sub>g</sub></span> <span class="main">@</span> drop <span class="main">(</span>arity <span class="skolem">gd2</span><span class="main">)</span> <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span><span class="main">)</span> <span class="main">#</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEP</span> <span class="var">?s1'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">gd2</span> <span class="main">≤</span> length <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity <span class="skolem">gd1</span> <span class="main">≤</span> length <span class="skolem">Σ<span class="hidden">⇩</span><sub>f</sub></span>›</span></span> arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> step_fun_end pc_at_end <span class="quoted"><span class="quoted">‹<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">g</span> <span class="main">=</span> Some <span class="skolem">gd2</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.step_fun_end<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MATCH</span> <span class="var">?s1'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_fun_end rel_F1_F2 arity_gd1_gd2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Std_to_Inca_simulation-forward_match_final"><span class="command">lemma</span></span> forward_match_final<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">∼</span> <span class="free">s2</span> <span class="main">⟹</span> Sstd.final <span class="free">s1</span> <span class="main">⟹</span> Sinca.final <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">F1</span> <span class="skolem">F2</span> <span class="skolem">H</span> <span class="skolem">st</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fd1</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">Σ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    st_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">[</span>Frame <span class="skolem">f</span> <span class="skolem">pc</span> <span class="skolem">Σ</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F1</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pc_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">=</span> length <span class="main">(</span>body <span class="skolem">fd1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Sstd.final.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="skolem">F2</span> <span class="skolem">f</span> <span class="main">=</span> Some <span class="skolem">fd2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 rel_fundefs_Some1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> st_def
    <span class="keyword1"><span class="command">using</span></span> pc_def rel_fundef_body_length<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fundef norm_eq <span class="skolem">fd1</span> <span class="skolem">fd2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sinca.final.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> std_inca_forward_simulation<span class="main">:</span>
  forward_simulation <span class="quoted">Sstd.step</span> <span class="quoted">Sinca.step</span> <span class="quoted">Sstd.final</span> <span class="quoted">Sinca.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">using</span></span> forward_match_final forward_lockstep_simulation
    lockstep_to_plus_forward_simulation<span class="main">[</span><span class="operator">of</span> <span class="quoted">match</span> <span class="quoted">Sstd.step</span> <span class="main">_</span> <span class="quoted">Sinca.step</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> std_inca_bisimulation<span class="main">:</span>
  bisimulation <span class="quoted">Sstd.step</span> <span class="quoted">Sinca.step</span> <span class="quoted">Sstd.final</span> <span class="quoted">Sinca.final</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Std_to_Inca_compiler">
<div class="head">
<h1>Theory Std_to_Inca_compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Std_to_Inca_compiler
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Std_to_Inca_simulation">Std_to_Inca_simulation</a>
    <span class="quoted">"<a href="../../vericomp/theories/#Compiler">VeriComp.Compiler</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compile_instr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IPush <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> Std.IPop <span class="main">=</span> Inca.IPop"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ILoad <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IStore <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.IOp <span class="free"><span class="bound"><span class="entity">op</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ICJump <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_instr</span> <span class="main">(</span>Std.ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Inca.ICall <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compile_fundef</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_fundef</span> <span class="main">(</span>Fundef <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span> Fundef <span class="main">(</span>map compile_instr <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> std_inca_simulation <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Std_to_Inca_compiler-norm_compile_instr"><span class="command">lemma</span></span> norm_compile_instr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"norm_instr <span class="main">(</span>compile_instr <span class="free">instr</span><span class="main">)</span> <span class="main">=</span> <span class="free">instr</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">instr</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Std_to_Inca_compiler-rel_compile_fundef"><span class="command">lemma</span></span> rel_compile_fundef<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundef norm_eq <span class="free">fd</span> <span class="main">(</span>compile_fundef <span class="free">fd</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fd</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fundef <span class="skolem">xs</span> <span class="skolem">ar</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map list.rel_eq norm_compile_instr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile_env</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile_env</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Sinca.Fenv.from_list <span class="main">(</span>map <span class="main">(</span>map_prod id compile_fundef<span class="main">)</span> <span class="main">(</span><span class="free">Fstd_to_list</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Std_to_Inca_compiler-Finca_get_compile"><span class="command">lemma</span></span> Finca_get_compile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Finca_get</span> <span class="main">(</span>compile_env <span class="free">e</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> map_option compile_fundef <span class="main">(</span><span class="free">Fstd_get</span> <span class="free">e</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sinca.Fenv.from_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Sstd.Fenv.to_list_correct
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compile_env_def map_prod_def map_of_map<span class="main">)</span>

<span class="keyword1" id="Std_to_Inca_compiler-rel_fundefs_compile_env"><span class="command">lemma</span></span> rel_fundefs_compile_env<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fundefs <span class="main">(</span><span class="free">Fstd_get</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">Finca_get</span> <span class="main">(</span>compile_env <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fundefs_def
  <span class="keyword1"><span class="command">unfolding</span></span> Finca_get_compile
  <span class="keyword1"><span class="command">unfolding</span></span> option.rel_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> option.rel_refl rel_compile_fundef<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compile</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="main">(</span>Prog <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Prog <span class="main">(</span>compile_env <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">main</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> compile_load<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">p1</span> <span class="main">=</span> Some <span class="free">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Sinca.load <span class="free">p2</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span><span class="main">.</span> Sstd.load <span class="free">p1</span> <span class="bound">s1</span> <span class="main">∧</span> match <span class="bound">s1</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prog <span class="skolem">F</span> <span class="skolem">H</span> <span class="skolem">main</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> Prog <span class="main">(</span>compile_env <span class="skolem">F</span><span class="main">)</span> <span class="skolem">H</span> <span class="skolem">main</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> p2_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="main">_</span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Sinca.load.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">fd'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"State <span class="skolem">F</span> <span class="skolem">H</span> <span class="main">[</span>Frame <span class="skolem">main</span> <span class="main">0</span> <span class="main">[]</span><span class="main">]</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fd</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      Fstd_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Fstd_get</span> <span class="skolem">F</span> <span class="skolem">main</span> <span class="main">=</span> Some <span class="skolem">fd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fd'</span> <span class="main">=</span> compile_fundef <span class="skolem">fd</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Finca_get_compile <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">fd</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fundef.rel_sel rel_compile_fundef<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sstd.load <span class="free">p1</span> <span class="var">?s1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Prog
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sstd.load.intros<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Fstd_main<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">∼</span> <span class="free">s2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1
      <span class="keyword1"><span class="command">using</span></span> rel_fundefs_compile_env
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> std_to_inca_compiler<span class="main">:</span>
  compiler <span class="quoted">Sstd.step</span> <span class="quoted">Sinca.step</span> <span class="quoted">Sstd.final</span> <span class="quoted">Sinca.final</span> <span class="quoted">Sstd.load</span> <span class="quoted">Sinca.load</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> match"</span></span> <span class="quoted">compile</span>
<span class="keyword1"><span class="command">using</span></span> compile_load
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> compile_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Sstd.load <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> compile <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> Sinca.load <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> match <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sstd.load.cases
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> match.intros rel_fundefs_compile_env
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sinca.load.simps Finca_get_compile rel_fundef_arities<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_compile_fundef<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>