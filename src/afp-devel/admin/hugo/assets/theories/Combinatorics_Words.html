<div id="Arithmetical_Hints">
<div class="head">
<h1>Theory Arithmetical_Hints</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/Arithmetical_Hints.thy
    Author:     Štěpán Holub, Charles University
    Author:     Martin Raška, Charles University
    Author:     Štěpán Starosta, CTU in Prague
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Arithmetical_Hints
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Arithmetical hints"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section we give some specific auxiliary lemmas on natural integers.›</span></span>

<span class="keyword1" id="Arithmetical_Hints-zero_diff_eq"><span class="command">lemma</span></span> zero_diff_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>  <span class="main">⟹</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-zero_less_diff'"><span class="command">lemma</span></span> zero_less_diff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-nat_prod_le"><span class="command">lemma</span></span> nat_prod_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">*</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Arithmetical_Hints-get_div"><span class="command">lemma</span></span> get_div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-get_mod"><span class="command">lemma</span></span> get_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-plus_one_between"><span class="command">lemma</span></span> plus_one_between<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Arithmetical_Hints-quotient_smaller"><span class="command">lemma</span></span> quotient_smaller<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-mult_cancel_le"><span class="command">lemma</span></span> mult_cancel_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">≤</span> <span class="free">c</span><span class="main">*</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Arithmetical_Hints-add_lessD2"><span class="command">lemma</span></span> add_lessD2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> add_lessD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Arithmetical_Hints-mod_offset"><span class="command">lemma</span></span> mod_offset<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mod_add_left_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> le_add_diff_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mod_le_divisor<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> neq0_conv<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span> mod_self<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> mod_add_left_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> this add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> add.comm_neutral<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">M</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">M</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> add.assoc<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> gcd <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_le2_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1" id="Arithmetical_Hints-less_mult_one"><span class="command">lemma</span></span> less_mult_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="free">k</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Reverse_Symmetry">
<div class="head">
<h1>Theory Reverse_Symmetry</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/Reverse_Symmetry.thy
    Author:     Martin Raška, Charles University
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Reverse_Symmetry
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Reverse symmetry"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory deals with a mechanism which produces new facts on lists from already known facts
by the reverse symmetry of lists, induced by the mapping <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rev</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
It constructs the rule attribute ``reversed'' which produces the symmetrical fact using so-called
reversal rules, which are rewriting rules that may be applied to obtain the symmetrical fact.
An example of such a reversal rule is the already existing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> rev_append<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main">,</span></span> <span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Some additional reversal rules are given in this theory.

The symmetrical fact 'A[reversed]' is constructed from the fact 'A' in the following manner:
  1. each schematic variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is instantiated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rev <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
  2. constant Nil is substituted by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rev Nil"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
  3. each quantification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋀</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'a</span></span> list<span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is substituted by (logically equivalent) quantification <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋀</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span>rev <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
similarly for $\forall$, $\exists$ and $\exists!$ quantifiers; each bounded quantification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type
variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'a</span></span> list<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is substituted by (logically equivalent)
quantification <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">∈</span></span>rev <span class="main"><span class="main">`</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span>rev <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, similarly for bounded $\exists$ quantifier;
  4. simultaneous rewrites according to a the current list of reversal rules are performed;
  5. final correctional rewrites related to reversion of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "Cons"<span class="antiquote"><span class="antiquote">}</span></span></span></span> are performed.

List of reversal rules is maintained by declaration attribute ``reversal\_rule'' with standard
``add'' and ``del'' options. 

See examples at the end of the file.
›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Quantifications and maps›</span></span>

<span class="keyword1" id="Reverse_Symmetry-all_surj_conv"><span class="command">lemma</span></span> all_surj_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>inv <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_f_inv_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reverse_Symmetry-All_surj_conv"><span class="command">lemma</span></span> All_surj_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>inv <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_f_inv_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Reverse_Symmetry-Ex_surj_conv"><span class="command">lemma</span></span> Ex_surj_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>inv <span class="free">f</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_f_inv_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reverse_Symmetry-Ex1_bij_conv"><span class="command">lemma</span></span> Ex1_bij_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span> <span class="skolem">Q</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ex1E<span class="main">[</span><span class="operator">OF</span> ex1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uniq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>inv <span class="skolem">g</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_f_inv_f<span class="main">[</span><span class="operator">OF</span> bij_is_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> uniq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inv <span class="skolem">g</span> <span class="skolem">y</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_inv_eq_iff<span class="main">[</span><span class="operator">OF</span> bij<span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> ex <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">y</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>inv <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_f_inv_f<span class="main">[</span><span class="operator">OF</span> bij_is_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> imp<span class="main">[</span><span class="operator">OF</span> bij_imp_bij_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reverse_Symmetry-Ball_inj_conv"><span class="command">lemma</span></span> Ball_inj_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>inv <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ball_simps<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>inv <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Reverse_Symmetry-Bex_inj_conv"><span class="command">lemma</span></span> Bex_inj_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>inv <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bex_simps<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>inv <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quantifications and reverse›</span></span>

<span class="keyword1" id="Reverse_Symmetry-rev_involution"><span class="command">lemma</span></span> rev_involution<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">∘</span> rev <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Reverse_Symmetry-rev_bij"><span class="command">lemma</span></span> rev_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij rev"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> o_bij<span class="main">[</span><span class="operator">OF</span> rev_involution rev_involution<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Reverse_Symmetry-rev_inv"><span class="command">lemma</span></span> rev_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv rev <span class="main">=</span> rev"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_unique_comp<span class="main">[</span><span class="operator">OF</span> rev_involution rev_involution<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> all_rev_conv <span class="main">=</span> all_surj_conv<span class="main">[</span><span class="operator">OF</span> bij_is_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_bij<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> All_rev_conv <span class="main">=</span> All_surj_conv<span class="main">[</span><span class="operator">OF</span> bij_is_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_bij<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> Ex_rev_conv <span class="main">=</span> Ex_surj_conv<span class="main">[</span><span class="operator">OF</span> bij_is_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_bij<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> Ex1_rev_conv <span class="main">=</span> Ex1_bij_conv<span class="main">[</span><span class="operator">OF</span> rev_bij<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> Ball_rev_conv <span class="main">=</span> Ball_inj_conv<span class="main">[</span><span class="operator">OF</span> bij_is_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_bij<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> rev_inv<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> Bex_rev_conv <span class="main">=</span> Bex_inj_conv<span class="main">[</span><span class="operator">OF</span> bij_is_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_bij<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> rev_inv<span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Attributes›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitons of reverse wrapers›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rev_Nil_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rev_Nil_wrap</span> <span class="main">=</span> rev Nil"</span></span> 

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> prop<span class="main">)</span> <span class="main">⇒</span> prop"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">All_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">All_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ex_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ex_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ex1_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ex1_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ball_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ball_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Bex_rev_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Bex_rev_wrap</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Initial reversal rules›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-rev_Nil"><span class="command">lemma</span></span> rev_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"rev Nil <span class="main">=</span> Nil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> init_rev_wrap <span class="main">=</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rev_Nil<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rev_Nil_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  transitive<span class="main">[</span><span class="operator">OF</span> all_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> all_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> All_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> All_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free">P</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ex_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Ex_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free">P</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="comment1">(* Ex_rev_wrapI *)</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ex1_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Ex1_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free">P</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ball_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Ball_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free">P</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Bex_rev_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Bex_rev_wrap_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free">P</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-all_rev_unwrap"><span class="command">lemma</span></span> all_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"all_rev_wrap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-All_rev_unwrap"><span class="command">lemma</span></span> All_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"All_rev_wrap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> All_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-Ex_rev_unwrap"><span class="command">lemma</span></span> Ex_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex_rev_wrap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ex_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-Ex1_rev_unwrap"><span class="command">lemma</span></span> Ex1_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex1_rev_wrap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ex1_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-Ball_rev_unwrap"><span class="command">lemma</span></span> Ball_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball_rev_wrap <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ball_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-Bex_rev_unwrap"><span class="command">lemma</span></span> Bex_rev_unwrap<span class="main">:</span> <span class="quoted"><span class="quoted">"Bex_rev_wrap <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Bex_rev_wrap_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> init_rev_unwrap <span class="main">=</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> rev_Nil_wrap_def<span class="main">]</span>
  all_rev_unwrap
  eq_reflection<span class="main">[</span><span class="operator">OF</span> All_rev_unwrap<span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> Ex_rev_unwrap<span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> Ex1_rev_unwrap<span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> Ball_rev_unwrap<span class="main">]</span>
  eq_reflection<span class="main">[</span><span class="operator">OF</span> Bex_rev_unwrap<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cons reversion›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">snocs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">snocs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1" id="Reverse_Symmetry-Cons_rev"><span class="command">lemma</span></span> Cons_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> rev <span class="free">u</span> <span class="main">=</span> rev <span class="main">(</span>snocs <span class="free">u</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> snocs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Reverse_Symmetry-snocs_snocs"><span class="command">lemma</span></span> snocs_snocs<span class="main">:</span> <span class="quoted"><span class="quoted">"snocs <span class="main">(</span>snocs <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> snocs <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> snocs <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> snocs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Final corrections›</span></span>

<span class="keyword1" id="Reverse_Symmetry-snocs_Nil"><span class="command">lemma</span></span> snocs_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"snocs <span class="main">[]</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> snocs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Reverse_Symmetry-snocs_is_append"><span class="command">lemma</span></span> snocs_is_append<span class="main">:</span> <span class="quoted"><span class="quoted">"snocs <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> snocs_def<span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> final_correct1 <span class="main">=</span>
  snocs_Nil

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> final_correct2 <span class="main">=</span>
  snocs_is_append

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Declaration attribute <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>reversal_rule›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Reversal_Rules</span> <span class="main">=</span> 
  <span class="entity">Named_Thms</span><span class="main">(</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "reversal_rule"<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">description</span> <span class="main">=</span> <span class="inner_quoted">"Rules performing reverse-symmetry transformation on theorems on lists"</span>
  <span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> reversal_rule <span class="main">=</span> 
  <span class="quoted">‹<span class="entity">Attrib.add_del</span>
    <span class="main">(</span>Thm.declaration_attribute <span class="entity">Reversal_Rules.add_thm</span><span class="main">)</span>
    <span class="main">(</span>Thm.declaration_attribute <span class="entity">Reversal_Rules.del_thm</span><span class="main">)</span>›</span>
  <span class="quoted">"maintaining a list of reversal rules"</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rule attribute <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>reversed›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_refl</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_reflection<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pure_eq_of</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
    Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹Pure.eq›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span>
      <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">th</span><span class="main">)</span>
  <span class="main">|</span> Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹Trueprop›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹HOL.eq›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">)</span>
      <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">th</span> RS <span class="entity">eq_refl</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init_rev_wrap</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> init_rev_wrap<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init_unwrap</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> init_rev_unwrap<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">final_correct1</span> <span class="main">=</span> map_filter <span class="entity">pure_eq_of</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> final_correct1<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">final_correct2</span> <span class="main">=</span> map_filter <span class="entity">pure_eq_of</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> final_correct2<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">reverse</span> <span class="entity">ths</span> <span class="entity">context</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_of <span class="entity">context</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> map_filter <span class="entity">pure_eq_of</span> <span class="main">(</span><span class="entity">ths</span> @ <span class="entity">Reversal_Rules.get</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.add_vars <span class="main">(</span>Thm.full_prop_of <span class="entity">th</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_inst_vars</span> <span class="main">[</span><span class="main">]</span> <span class="entity">inst_vars</span> <span class="main">=</span> <span class="entity">inst_vars</span>
      <span class="main">|</span> <span class="entity">add_inst_vars</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> :: <span class="entity">vars</span> <span class="main">)</span> <span class="entity">inst_vars</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">T</span> <span class="keyword2"><span class="keyword">of</span></span>
            Type<span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span>‹list›</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="entity">add_inst_vars</span> <span class="entity">vars</span> <span class="main">(</span>
                <span class="main">(</span>
                  <span class="main">(</span><span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">,</span>
                  Thm.cterm_of <span class="entity">ctxt</span> 
                    <span class="main">(</span> Const<span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span>‹rev›</span><span class="main">,</span> Type<span class="main">(</span><span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span>‹fun›</span><span class="main">,</span> <span class="main">[</span><span class="entity">T</span><span class="main">,</span> <span class="entity">T</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> $ Var<span class="main">(</span><span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">)</span>
                <span class="main">)</span> :: <span class="entity">inst_vars</span>
              <span class="main">)</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">add_inst_vars</span> <span class="entity">vars</span> <span class="entity">inst_vars</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">th</span>
    |&gt; Drule.instantiate_normalize
       <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">add_inst_vars</span> <span class="entity">vars</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    |&gt; Simplifier.rewrite_rule <span class="entity">ctxt</span> <span class="entity">init_rev_wrap</span>
    |&gt; Simplifier.rewrite_rule <span class="entity">ctxt</span> <span class="entity">init_unwrap</span>
    |&gt; Simplifier.rewrite_rule <span class="entity">ctxt</span> <span class="entity">rules</span>
    |&gt; Simplifier.rewrite_rule <span class="entity">ctxt</span> <span class="entity">final_correct1</span>
    |&gt; Simplifier.rewrite_rule <span class="entity">ctxt</span> <span class="entity">final_correct2</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reversed</span> <span class="main">=</span> Scan.optional <span class="main">(</span>Scan.lift <span class="main">(</span>Args.add -- Args.colon<span class="main">)</span> |-- <span class="entity">Attrib.thms</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
  &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ths</span> <span class="main">=&gt;</span> Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="entity">reverse</span> <span class="entity">ths</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> reversed <span class="main">=</span>
  <span class="quoted">‹<span class="entity">reversed</span>›</span>
  <span class="quoted">"Transforms the theorem on lists to reverse-symmetric version"</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Declaration of basic reversal rules›</span></span>

<span class="keyword1" id="Reverse_Symmetry-hd_last_Nil"><span class="command">lemma</span></span> hd_last_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">[]</span> <span class="main">=</span> last <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hd_def last_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="Reverse_Symmetry-last_rev_hd"><span class="command">lemma</span></span> last_rev_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"last<span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_last_Nil<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Reverse_Symmetry-hd_rev_last"><span class="command">lemma</span></span> hd_rev_last<span class="main">:</span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_last_Nil<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Reverse_Symmetry-tl_rev"><span class="command">lemma</span></span> tl_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_swap<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> butlast_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> rev_rev_ident<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Reverse_Symmetry-if_rev"><span class="command">lemma</span></span> if_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> rev <span class="free">u</span> <span class="keyword1">else</span> rev <span class="free">v</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">u</span> <span class="keyword1">else</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Reverse_Symmetry-rev_in_conv"><span class="command">lemma</span></span> rev_in_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Reverse_Symmetry-in_lists_rev"><span class="command">lemma</span></span> in_lists_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> rev <span class="free">u</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Reverse_Symmetry-rev_in_lists"><span class="command">lemma</span></span> rev_in_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Reverse_Symmetry-rev_lists_conv"><span class="command">lemma</span></span> rev_lists_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">`</span> lists <span class="free">A</span> <span class="main">=</span> lists <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rev <span class="main">`</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rev_in_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> rev_in_lists<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> rev <span class="main">`</span> lists <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rev_in_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> in_lists_rev<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reverse_Symmetry-coset_rev"><span class="command">lemma</span></span> coset_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"List.coset <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> List.coset <span class="free">xs</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span> <span class="main">=</span>
  Cons_rev
  snocs_snocs
  rev_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  last_rev_hd hd_rev_last
  tl_rev butlast_rev
  rev_is_rev_conv
  length_rev
  take_rev
  drop_rev
  rotate_rev
  if_rev
  rev_in_conv
  rev_lists_conv
  set_rev
  coset_rev

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cons and append›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-example_Cons_append"><span class="command">lemma</span></span> example_Cons_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">b</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span>
  example_Cons_append
  example_Cons_append<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  example_Cons_append<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span>
  not_Cons_self
  not_Cons_self<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span>
  neq_Nil_conv
  neq_Nil_conv<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction rules›</span></span>

<span class="keyword1"><span class="command">thm</span></span>
  list_nonempty_induct
  list_nonempty_induct<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="comment1">(* needs work *)</span>
  list_nonempty_induct<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">unfolded</span> rev_rev_ident<span class="main">]</span> 

<span class="keyword1"><span class="command">thm</span></span>
  list_induct2
  list_induct2<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="comment1">(* needs work *)</span>
  list_induct2<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>rev <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>rev <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">unfolded</span> rev_rev_ident<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹hd, tl, last, butlast›</span></span>

<span class="keyword1"><span class="command">thm</span></span>
  hd_append
  hd_append<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  last_append

<span class="keyword1"><span class="command">thm</span></span>
  length_tl
  length_tl<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  length_butlast

<span class="keyword1"><span class="command">thm</span></span>
  hd_Cons_tl
  hd_Cons_tl<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  append_butlast_last_id
  append_butlast_last_id<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹set›</span></span>

<span class="keyword1"><span class="command">thm</span></span>
  hd_in_set
  hd_in_set<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  last_in_set

<span class="keyword1"><span class="command">thm</span></span>
  set_ConsD
  set_ConsD<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span>
  split_list_first
  split_list_first<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span>
  split_list_first_prop
  split_list_first_prop<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  split_list_first_prop<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">unfolded</span> append_assoc append_Cons append_Nil<span class="main">]</span>
  split_list_last_prop

<span class="keyword1"><span class="command">thm</span></span>
  split_list_first_propE
  split_list_first_propE<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  split_list_first_propE<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">unfolded</span> append_assoc append_Cons append_Nil<span class="main">]</span>
  split_list_last_propE

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹rotate›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Reverse_Symmetry-rotate1_hd_tl'"><span class="command">lemma</span></span> rotate1_hd_tl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rotate <span class="main">1</span> <span class="free">xs</span> <span class="main">=</span> tl <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">thm</span></span>
  rotate1_hd_tl'
  rotate1_hd_tl'<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CoWBasic">
<div class="head">
<h1>Theory CoWBasic</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/CoWBasic.thy
    Author:     Štěpán Holub, Charles University
    Author:     Martin Raška, Charles University
    Author:     Štěpán Starosta, CTU in Prague
*)</span>

<span class="keyword1"><span class="command">theory</span></span> CoWBasic
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span> <a href="#Arithmetical_Hints">Arithmetical_Hints</a> <a href="#Reverse_Symmetry">Reverse_Symmetry</a>
<span class="keyword2"><span class="keyword">begin</span></span>                                                            

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Basics of Combinatorics on Words"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Combinatorics on Words, as the name suggests, studies words, finite or infinite sequences of elements from a, usually finite, alphabet.
The essential operation on finite words is the concatenation of two words, which is associative and noncommutative. 
This operation yields many simply formulated problems, often in terms of \emph{equations on words}, that are mathematically challenging.

See for instance <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> ChoKa97<span class="antiquote"><span class="antiquote">}</span></span></span></span> for an introduction to Combinatorics on Words, and \cite{Lo,Lo2,Lo3} as another reference for Combinatorics on Words.
This theory deals exclusively with finite words and  provides basic facts of the field which can be considered as folklore.

The most natural way to represent finite words is by the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
 From an algebraic viewpoint, lists are free monoids. On the other hand, any free monoid is isomoporphic to a monoid of lists of its generators.
The algebraic point of view and the combinatorial point of view therefore overlap significantly in Combinatorics on Words.
›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Definitions and notations"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, we introduce elementary definitions and notations.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The concatenation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">append</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of two finite lists/words is the very basic operation in Combinatorics on Words, its notation is usually omitted.
In this field, a common notation for this operation is $\cdot$, which we use and add here.›</span></span>


<span class="keyword1"><span class="command">notation</span></span> append <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> rassoc <span class="main">=</span> append_assoc
<span class="keyword1"><span class="command">lemmas</span></span> lassoc <span class="main">=</span> append_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We add a common notation for the length of a given word $|w|$.›</span></span>


<span class="keyword1"><span class="command">notation</span></span>
  length  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>|</b></span>_<span class="keyword1"><span class="hidden">❙</span><b>|</b></span>"</span><span class="main">)</span> <span class="comment1">― ‹note that it's bold |›</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  length  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\ensuremath{\\left| ›</span>_<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\right|}›</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Empty and nonempty word›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As the word of length zero <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Nil</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be used often, we adopt its frequent notation $\varepsilon $ in this formalization.›</span></span>

<span class="keyword1"><span class="command">notation</span></span> Nil <span class="main">(</span><span class="quoted">"<span class="keyword1">ε</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">drop_emp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span> <span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>+</sub></span>"</span> <span class="main">[</span>1000<span class="main">]</span> <span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drop_emp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">ε</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prefix›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The property of being a prefix shall be frequently used, and we give it yet another frequent shorthand notation.
Analogously, we introduce shorthand notations for non-empty prefix and strict prefix, and continue with suffixes and factors.
›</span></span>


<span class="keyword1"><span class="command">notation</span></span> prefix <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤p</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> prefix  <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> prefix_def

<span class="keyword1"><span class="command">lemmas</span></span> prefI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> prefixI

<span class="keyword1" id="CoWBasic-prefI"><span class="command">lemma</span></span> prefI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-prefD"><span class="command">lemma</span></span> prefD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefix_comparable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⨝</span>"</span> 50<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> prefix_comparable_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">prefix_comparable</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="CoWBasic-pref_compIff"><span class="command">lemma</span></span> pref_compIff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">∨</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonempty_prefix</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤np</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> nonempty_prefix_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">≤np</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> nonempty_prefix  <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇘</span><sub>np</sub><span class="hidden">⇙</span></span>"</span> 50<span class="main">)</span>

<span class="keyword1" id="CoWBasic-npI"><span class="command">lemma</span></span> npI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-npI'"><span class="command">lemma</span></span> npI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-npD"><span class="command">lemma</span></span> npD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-npD'"><span class="command">lemma</span></span> npD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">notation</span></span> strict_prefix <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;p</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> strict_prefix  <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> strict_prefix_def

<span class="keyword1" id="CoWBasic-sprefI1"><span class="command">lemma</span></span> sprefI1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-sprefI1'"><span class="command">lemma</span></span> sprefI1'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-sprefI2"><span class="command">lemma</span></span> sprefI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> length <span class="free">u</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_prefix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-sprefD"><span class="command">lemma</span></span> sprefD<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> sprefD1<span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> prefix_order.order.strict_implies_order <span class="keyword2"><span class="keyword">and</span></span>
  sprefD2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> prefix_order.less_imp_neq

<span class="keyword1" id="CoWBasic-sprefE"><span class="command">lemma</span></span> sprefE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Suffix›</span></span>

<span class="keyword1"><span class="command">notation</span></span> suffix <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤s</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> suffix <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>s</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> suffix_def

<span class="keyword1" id="CoWBasic-sufI"><span class="command">lemma</span></span> sufI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">≤s</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-sufD"><span class="command">lemma</span></span> sufD<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">notation</span></span> strict_suffix <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;s</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> strict_suffix  <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>s</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> strict_suffix_def

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> suffix_order.le_neq_trans

<span class="keyword1" id="CoWBasic-ssufI1"><span class="command">lemma</span></span> ssufI1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">&lt;s</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-ssufI2"><span class="command">lemma</span></span> ssufI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">⟹</span> length <span class="free">u</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&lt;s</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-ssufD"><span class="command">lemma</span></span> ssufD<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;s</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> ssufD1<span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> suffix_order.order.strict_implies_order <span class="keyword2"><span class="keyword">and</span></span>
  ssufD2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> suffix_order.less_imp_neq

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">suffix_comparable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⨝<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span> suffix_comparable_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">suffix_comparable</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonempty_suffix</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤ns</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> nonempty_suffix_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">≤ns</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">≤s</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> nonempty_suffix  <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇘</span><sub>ns</sub><span class="hidden">⇙</span></span>"</span> 50<span class="main">)</span>

<span class="keyword1" id="CoWBasic-nsI"><span class="command">lemma</span></span> nsI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤ns</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-nsI'"><span class="command">lemma</span></span> nsI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤ns</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-nsD"><span class="command">lemma</span></span> nsD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤ns</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-nsD'"><span class="command">lemma</span></span> nsD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤ns</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Factor›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sublist</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of some word is in Combinatorics of Words called a factor.
We adopt a common shorthand notation for the property of being a factor, strict factor and nonempty factor (the latter we also define).›</span></span>


<span class="keyword1"><span class="command">notation</span></span> sublist <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤f</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> sublist <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>f</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> factor_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> sublist_def


<span class="keyword1"><span class="command">notation</span></span> strict_sublist <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;f</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> strict_sublist <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇘</span><sub>f</sub><span class="hidden">⇙</span></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> strict_factor_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> strict_sublist_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonempty_factor</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤nf</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> nonempty_factor_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">≤nf</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">p</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> nonempty_factor <span class="main">(</span><span class="quoted">"<span class="keyword1">≤<span class="hidden">⇘</span><sub>nf</sub><span class="hidden">⇙</span></span>"</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-facI"><span class="command">lemma</span></span> facI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">p</span><span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sublist_appendI<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-facI'"><span class="command">lemma</span></span> facI'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">b</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-facE"><span class="command">lemma</span></span> facE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factor_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-facE'"><span class="command">lemma</span></span> facE'<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> factor_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Various elementary lemmas"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> concat_morph <span class="main">=</span> sym<span class="main">[</span><span class="operator">OF</span> concat_append<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> cancel <span class="main">=</span> same_append_eq <span class="keyword2"><span class="keyword">and</span></span>
    cancel_right <span class="main">=</span> append_same_eq

<span class="keyword1" id="CoWBasic-bij_lists"><span class="command">lemma</span></span> bij_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> bij_betw <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">X</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">X</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span>set <span class="bound">x</span> <span class="main">∪</span> set <span class="bound">y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> inj_on <span class="free">f</span> <span class="main">(</span>set <span class="bound">x</span> <span class="main">∪</span> set <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_inj_on<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">X</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> lists <span class="free">X</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> map <span class="free">f</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">x</span>  <span class="main">=</span> <span class="bound">y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_map_eq_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹bij_betw <span class="free">f</span> <span class="free">X</span> <span class="free">Y</span>›</span></span> bij_betw_def lists_image
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-concat_sing'"><span class="command">lemma</span></span> concat_sing'<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-concat_sing"><span class="command">lemma</span></span> concat_sing<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">[</span>hd <span class="free">s</span><span class="main">]</span> <span class="main">⟹</span> concat <span class="free">s</span> <span class="main">=</span> hd <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concat_sing'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-rev_sing"><span class="command">lemma</span></span> rev_sing<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-hd_word"><span class="command">lemma</span></span> hd_word<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">ws</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-hd_word'"><span class="command">lemma</span></span> hd_word'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">[</span>hd <span class="free">w</span><span class="main">]</span> <span class="main">⋅</span> tl <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-hd_pref"><span class="command">lemma</span></span> hd_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">[</span>hd <span class="free">w</span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hd_word'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-add_nth"><span class="command">lemma</span></span> add_nth<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">w</span><span class="main">!</span><span class="free">n</span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> take_is_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> take_Suc_conv_app_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-hd_pref'"><span class="command">lemma</span></span> hd_pref'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">w</span><span class="main">!</span><span class="main">0</span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-sub_lists_mono"><span class="command">lemma</span></span> sub_lists_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lists_hd"><span class="command">lemma</span></span> lists_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="free">Q</span> <span class="main">⟹</span> hd <span class="free">us</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-replicate_in_lists"><span class="command">lemma</span></span> replicate_in_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="free">k</span> <span class="free">z</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-tl_lists"><span class="command">lemma</span></span> tl_lists<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> suffix_lists<span class="main">[</span><span class="operator">OF</span> suffix_tl assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-long_list_tl"><span class="command">lemma</span></span> long_list_tl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="main"><span class="hidden">❙</span><b>|</b></span>tl <span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tl <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-tl_set"><span class="command">lemma</span></span> tl_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list.sel<span class="main">(</span>2<span class="main">)</span> list.set_sel<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-drop_take_inv"><span class="command">lemma</span></span> drop_take_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> drop <span class="free">n</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-split_list_long"><span class="command">lemma</span></span> split_list_long<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">⋅</span><span class="free">ys</span><span class="main">≠</span><span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> set <span class="free">us</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">⋅</span><span class="skolem">ys</span><span class="main">≠</span><span class="keyword1">ε</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">ys</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-flatten_lists"><span class="command">lemma</span></span> flatten_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">G</span> <span class="main">⟹</span> concat <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-concat_map_sing_ident"><span class="command">lemma</span></span> concat_map_sing_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                                           

<span class="keyword1" id="CoWBasic-hd_concat_tl"><span class="command">lemma</span></span> hd_concat_tl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">ws</span> <span class="main">⋅</span> concat <span class="main">(</span>tl <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> concat <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concat.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">ws</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> list.collapse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-concat_butlast_last"><span class="command">lemma</span></span> concat_butlast_last<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>butlast <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> last <span class="free">ws</span> <span class="main">=</span> concat <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"butlast <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>last <span class="free">ws</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> concat_sing' append_butlast_last_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-concat_last_suf"><span class="command">lemma</span></span> concat_last_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> last <span class="free">ws</span> <span class="keyword1">≤s</span> concat <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concat_butlast_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-concat_hd_pref"><span class="command">lemma</span></span> concat_hd_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> hd <span class="free">ws</span> <span class="keyword1">≤p</span> concat <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hd_concat_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-set_nemp_concat_nemp"><span class="command">lemma</span></span> set_nemp_concat_nemp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∉</span> set <span class="free">ws</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ε</span> <span class="main">∉</span> set <span class="free">ws</span>›</span></span> last_in_set<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> concat_butlast_last<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> takedrop <span class="main">=</span> append_take_drop_id

<span class="keyword1" id="CoWBasic-comm_rev_iff"><span class="command">lemma</span></span> comm_rev_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="main">⋅</span> rev <span class="free">v</span> <span class="main">=</span> rev <span class="free">v</span> <span class="main">⋅</span> rev <span class="free">u</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> rev_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rev_is_rev_conv eq_ac<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-rev_induct2"><span class="command">lemma</span></span> rev_induct2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">⋅</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">ys</span><span class="main">⋅</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">⋅</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span><span class="main">⋅</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">ε</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">xs</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_induct snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snoc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Orderings on lists: prefix, suffix, factor›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> self_pref <span class="main">=</span> prefix_order.order.refl
<span class="keyword1"><span class="command">lemmas</span></span> pref_antisym <span class="main">=</span> prefix_order.order.antisym
<span class="keyword1"><span class="command">lemmas</span></span> pref_trans <span class="main">=</span> prefix_order.order.trans
<span class="keyword1"><span class="command">lemmas</span></span> suf_trans <span class="main">=</span> suffix_order.order.trans


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"On the empty word"</span></span>

<span class="keyword1" id="CoWBasic-nemp_elem_setI"><span class="command">lemma</span></span> nemp_elem_setI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">S</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-nel_drop_emp"><span class="command">lemma</span></span> nel_drop_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">S</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-drop_emp_nel"><span class="command">lemma</span></span> drop_emp_nel<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-emp_concat_emp"><span class="command">lemma</span></span> emp_concat_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">S</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> DiffD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-take_nemp"><span class="command">lemma</span></span> take_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> take <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_nemp"><span class="command">lemma</span></span> pref_nemp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> append_is_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-suf_nemp"><span class="command">lemma</span></span> suf_nemp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> append_is_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Length and its properties"</span></span>

<span class="keyword1" id="CoWBasic-lenarg"><span class="command">lemma</span></span> lenarg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-npos_len"><span class="command">lemma</span></span> npos_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-nemp_pos_len"><span class="command">lemma</span></span> nemp_pos_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leI<span class="main">)</span>

<span class="keyword1" id="CoWBasic-swap_len"><span class="command">lemma</span></span> swap_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-len_after_drop"><span class="command">lemma</span></span> len_after_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span>  <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>drop <span class="free">p</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="CoWBasic-short_take_append"><span class="command">lemma</span></span> short_take_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">⟹</span> take <span class="free">n</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-sing_word"><span class="command">lemma</span></span> sing_word<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">[</span>hd <span class="free">us</span><span class="main">]</span> <span class="main">=</span> <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-sing_word_concat"><span class="command">lemma</span></span> sing_word_concat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>concat <span class="free">us</span><span class="main">]</span> <span class="main">=</span> <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms concat_sing sing_word<span class="main">)</span>

<span class="keyword1" id="CoWBasic-nonsing_concat_len"><span class="command">lemma</span></span> nonsing_concat_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_neq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-sing_len"><span class="command">lemma</span></span> sing_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1" id="CoWBasic-pref_len'"><span class="command">lemma</span></span> pref_len'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-suf_len'"><span class="command">lemma</span></span> suf_len'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-fac_len"><span class="command">lemma</span></span> fac_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-fac_len'"><span class="command">lemma</span></span> fac_len'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-fac_len_eq"><span class="command">lemma</span></span> fac_len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> factor_def <span class="keyword1"><span class="command">using</span></span> length_append npos_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-drop_len"><span class="command">lemma</span></span> drop_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-drop_pref"><span class="command">lemma</span></span> drop_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-take_len"><span class="command">lemma</span></span> take_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">p</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> length_take min_absorb2<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-conj_len"><span class="command">lemma</span></span> conj_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> add.commute add_left_imp_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-take_nemp_len"><span class="command">lemma</span></span> take_nemp_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-nemp_len"><span class="command">lemma</span></span> nemp_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-take_self"><span class="command">lemma</span></span> take_self<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> take_all<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> order.refl<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-len_le_concat"><span class="command">lemma</span></span> len_le_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∉</span>  set <span class="free">ws</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ws</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list.set_intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">]</span> nemp_pos_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span>   concat.simps<span class="main">(</span>2<span class="main">)</span>  <span class="keyword1"><span class="command">unfolding</span></span>  length_append hd_word<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">]</span> sing_len 
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-eq_len_iff"><span class="command">lemma</span></span> eq_len_iff<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟷</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lenarg<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> length_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-eq_len_iff_less"><span class="command">lemma</span></span> eq_len_iff_less<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟷</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lenarg<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> length_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Prefix and prefix comparability properties"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pref_emp <span class="main">=</span> prefix_bot.bot.extremum_uniqueI

<span class="keyword1" id="CoWBasic-triv_pref"><span class="command">lemma</span></span> triv_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">OF</span> refl<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-triv_spref"><span class="command">lemma</span></span> triv_spref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_cancel"><span class="command">lemma</span></span> pref_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_cancel'"><span class="command">lemma</span></span> pref_cancel'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> pref_cancel_conv <span class="main">=</span> same_prefix_prefix

<span class="keyword1"><span class="command">lemmas</span></span> pref_ext <span class="main">=</span> prefix_prefix <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1" id="CoWBasic-spref_ext"><span class="command">lemma</span></span> spref_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CoWBasic-pref_ext_nemp"><span class="command">lemma</span></span> pref_ext_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_take"><span class="command">lemma</span></span> pref_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_take_conv"><span class="command">lemma</span></span> pref_take_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟷</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> take_is_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1" id="CoWBasic-le_suf_drop"><span class="command">lemma</span></span> le_suf_drop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">j</span> <span class="free">w</span> <span class="keyword1">≤s</span> drop <span class="free">i</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> suffix_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> drop_drop le_add_diff_inverse2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-spref_take"><span class="command">lemma</span></span> spref_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">&lt;p</span> <span class="free">w</span> <span class="main">⟹</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_same_len"><span class="command">lemma</span></span> pref_same_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    

<span class="keyword1" id="CoWBasic-add_nth_pref"><span class="command">lemma</span></span> add_nth_pref<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">w</span><span class="main">!</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_nth<span class="main">[</span><span class="operator">OF</span> prefix_length_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> spref_take<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-index_pref"><span class="command">lemma</span></span> index_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">.</span>  <span class="free">u</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> take_all<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> nth_take_lemma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> 
    take_is_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_index"><span class="command">lemma</span></span> pref_index<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nth_take<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> pref_take<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_drop"><span class="command">lemma</span></span> pref_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> drop <span class="free">p</span> <span class="free">u</span> <span class="keyword1">≤p</span> drop <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> drop_append<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Prefix comparability"</span></span>

<span class="keyword1" id="CoWBasic-pref_comp_sym"><span class="command">lemma</span></span> pref_comp_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">⨝</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> ruler_le <span class="main">=</span> prefix_length_prefix <span class="keyword2"><span class="keyword">and</span></span>
       ruler <span class="main">=</span> prefix_same_cases <span class="keyword2"><span class="keyword">and</span></span>
       ruler' <span class="main">=</span> prefix_same_cases<span class="main">[</span><span class="operator">folded</span> prefix_comparable_def<span class="main">]</span> 

<span class="keyword1" id="CoWBasic-ruler_equal"><span class="command">lemma</span></span> ruler_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-ruler_comp"><span class="command">lemma</span></span> ruler_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u'</span> <span class="keyword1">≤p</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">⨝</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">u'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
  <span class="keyword1"><span class="command">using</span></span> disjE<span class="main">[</span><span class="operator">OF</span> _ ruler<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pref_trans<span class="main"><span class="main">]</span></span> ruler<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pref_trans<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-ruler_pref"><span class="command">lemma</span></span> ruler_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span><span class="main">⋅</span><span class="free">z</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
  <span class="keyword1"><span class="command">using</span></span> ruler <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_prod_pref_short"><span class="command">lemma</span></span> pref_prod_pref_short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ruler_le<span class="main">[</span><span class="operator">OF</span> _ pref_cancel'<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_prod_pref"><span class="command">lemma</span></span> pref_prod_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span>  <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_pref_short<span class="main">[</span><span class="operator">OF</span> _ _ suf_len'<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_prod_pref'"><span class="command">lemma</span></span> pref_prod_pref'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span><span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span><span class="main">⋅</span><span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_pref<span class="main">[</span><span class="operator">of</span>  <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span><span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span>›</span></span> triv_pref<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_prod_long"><span class="command">lemma</span></span> pref_prod_long<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ruler_le<span class="main">[</span><span class="operator">OF</span> triv_pref<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_keeps_root"><span class="command">lemma</span></span> pref_keeps_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> pref_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">⋅</span><span class="free">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_prolong"><span class="command">lemma</span></span> pref_prolong<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_trans<span class="main">[</span><span class="operator">OF</span> _ pref_cancel'<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_prolong'"><span class="command">lemma</span></span> pref_prolong'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefix_length_prefix<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span>›</span></span> pref_cancel'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span> suf_len'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">⋅</span><span class="free">v</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> rassoc<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_prolong_comp"><span class="command">lemma</span></span> pref_prolong_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prolong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span><span class="main">]</span> pref_prolong'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_prod_short"><span class="command">lemma</span></span> pref_prod_short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  prefI prefix_length_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">⋅</span><span class="free">w</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_prod_short'"><span class="command">lemma</span></span> pref_prod_short'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_short<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span>›</span></span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_prod_cancel"><span class="command">lemma</span></span> pref_prod_cancel<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_prod_long<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">q</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">q</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="skolem">r</span>›</span></span> pref_cancel_conv length_append <span class="keyword1"><span class="command">using</span></span> pref_prod_short<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="skolem">r</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pref_prod_cancel'"><span class="command">lemma</span></span> pref_prod_cancel'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pref_prod_cancel<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">q</span>›</span></span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main">⋅</span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="skolem">r</span>›</span></span> less_not_refl3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">folded</span> self_append_conv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoWBasic-pref_comp_eq"><span class="command">lemma</span></span> pref_comp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-non_comp_parallel"><span class="command">lemma</span></span> non_comp_parallel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∥</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def parallel_def de_Morgan_disj<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="CoWBasic-comp_refl"><span class="command">lemma</span></span> comp_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-incomp_cancel"><span class="command">lemma</span></span> incomp_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⨝</span> <span class="free">p</span><span class="main">⋅</span><span class="free">v</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-comp_cancel"><span class="command">lemma</span></span> comp_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-comm_ruler"><span class="command">lemma</span></span> comm_ruler<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="keyword1">≤p</span> <span class="free">w1</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w2</span> <span class="main">⟹</span> <span class="free">w1</span> <span class="main">⨝</span> <span class="free">w2</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_comp_eq<span class="main">[</span><span class="operator">OF</span> ruler_comp swap_len<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_share_take"><span class="command">lemma</span></span> pref_share_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> take <span class="free">q</span> <span class="free">u</span> <span class="main">=</span> take <span class="free">q</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_prod_longer"><span class="command">lemma</span></span> pref_prod_longer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>  <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ruler_le<span class="main">[</span><span class="operator">OF</span> pref_cancel'<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_comp_not_pref"><span class="command">lemma</span></span> pref_comp_not_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_comp_not_spref"><span class="command">lemma</span></span> pref_comp_not_spref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> contrapos_np<span class="main">[</span><span class="operator">OF</span> _ pref_comp_not_pref<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-hd_prod"><span class="command">lemma</span></span> hd_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">u</span><span class="main">!</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-distinct_first"><span class="command">lemma</span></span> distinct_first<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">!</span><span class="main">0</span> <span class="main">≠</span> <span class="free">z</span><span class="main">!</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⋅</span> <span class="free">w'</span> <span class="main">≠</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hd_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w'</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> hd_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">z'</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span><span class="main">!</span><span class="main">0</span> <span class="main">≠</span> <span class="free">z</span><span class="main">!</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemmas</span></span> last_no_split <span class="main">=</span> prefix_snoc

<span class="keyword1" id="CoWBasic-last_no_split'"><span class="command">lemma</span></span> last_no_split'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> prefix_order.less_le_not_le<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> last_no_split<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1" id="CoWBasic-pcomp_shorter"><span class="command">lemma</span></span> pcomp_shorter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⨝</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_comp_len_trans"><span class="command">lemma</span></span> pref_comp_len_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
  <span class="keyword1"><span class="command">using</span></span> prefix_length_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> prefix_order.order.trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1" id="CoWBasic-comp_ext"><span class="command">lemma</span></span> comp_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w1</span> <span class="main">⨝</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w2</span> <span class="main">⟷</span> <span class="free">w1</span> <span class="main">⨝</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-emp_pref"><span class="command">lemma</span></span> emp_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-emp_spref"><span class="command">lemma</span></span> emp_spref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="keyword1">ε</span> <span class="keyword1">&lt;p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-long_pref"><span class="command">lemma</span></span> long_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-incomp_ext"><span class="command">lemma</span></span> incomp_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">w1</span> <span class="main">⨝</span>  <span class="free">w2</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">w1</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⨝</span> <span class="free">w2</span> <span class="main">⋅</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> contrapos_nn<span class="main">[</span><span class="operator">OF</span> _ ruler_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> triv_pref triv_pref<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-mismatch_incopm"><span class="command">lemma</span></span> mismatch_incopm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-comp_prefs_comp"><span class="command">lemma</span></span> comp_prefs_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ruler_comp<span class="main">[</span><span class="operator">OF</span> prefI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">z</span></span><span class="main"><span class="main">]</span></span> prefI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> refl refl<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-comp_hd_eq"><span class="command">lemma</span></span> comp_hd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> hd <span class="free">u</span> <span class="main">=</span> hd <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="CoWBasic-pref_hd_eq'"><span class="command">lemma</span></span> pref_hd_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span>  hd <span class="free">u</span> <span class="main">=</span> hd <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_hd_eq"><span class="command">lemma</span></span> pref_hd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span>  hd <span class="free">u</span> <span class="main">=</span> hd <span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-suf_last_eq"><span class="command">lemma</span></span> suf_last_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤s</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span>  last <span class="free">u</span> <span class="main">=</span> last <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-comp_hd_eq'"><span class="command">lemma</span></span> comp_hd_eq'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">u</span> <span class="main">=</span> hd <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_prefs_comp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">s</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Suffix and suffix comparability  properties"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_emp <span class="main">=</span> suffix_bot.bot.extremum_uniqueI

<span class="keyword1" id="CoWBasic-triv_suf"><span class="command">lemma</span></span> triv_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-emp_ssuf"><span class="command">lemma</span></span> emp_ssuf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="keyword1">ε</span> <span class="keyword1">&lt;s</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-suf_cancel"><span class="command">lemma</span></span> suf_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="keyword1">≤s</span> <span class="free">w</span><span class="main">⋅</span><span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="CoWBasic-suf_cancel'"><span class="command">lemma</span></span> suf_cancel'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="keyword1">≤s</span> <span class="free">w</span><span class="main">⋅</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">lemmas</span></span> suf_cancel_eq <span class="main">=</span> same_suffix_suffix <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Straightforward relations of suffix and prefix follow.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_rev_pref_iff <span class="main">=</span> suffix_to_prefix <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1"><span class="command">lemmas</span></span> ssuf_rev_pref_iff <span class="main">=</span> strict_suffix_to_prefix <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1" id="CoWBasic-pref_rev_suf_iff"><span class="command">lemma</span></span> pref_rev_suf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟷</span> rev <span class="free">u</span> <span class="keyword1">≤s</span> rev <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> suffix_to_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">v</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rev_rev_ident
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-spref_rev_suf_iff"><span class="command">lemma</span></span> spref_rev_suf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">&lt;p</span> <span class="free">w</span> <span class="main">⟷</span> rev <span class="free">s</span> <span class="keyword1">&lt;s</span> rev <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_suffix_to_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rev_rev_ident<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-nsuf_rev_pref_iff"><span class="command">lemma</span></span> nsuf_rev_pref_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤ns</span> <span class="free">w</span> <span class="main">⟷</span> rev <span class="free">s</span> <span class="keyword1">≤np</span> rev <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nonempty_prefix_def nonempty_suffix_def suffix_to_prefix
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="CoWBasic-npref_rev_suf_iff"><span class="command">lemma</span></span> npref_rev_suf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤np</span> <span class="free">w</span> <span class="main">⟷</span> rev <span class="free">s</span> <span class="keyword1">≤ns</span> rev <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nonempty_prefix_def nonempty_suffix_def pref_rev_suf_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span> <span class="main">=</span> 
  suf_rev_pref_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  pref_rev_suf_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  nsuf_rev_pref_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  npref_rev_suf_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  ssuf_rev_pref_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  spref_rev_suf_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_ext <span class="main">=</span> suffix_appendI <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1"><span class="command">lemmas</span></span> ssuf_ext <span class="main">=</span> spref_ext<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_ext_nem <span class="main">=</span> pref_ext_nemp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_same_len <span class="main">=</span> pref_same_len<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_take <span class="main">=</span> pref_drop<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_share_take <span class="main">=</span> pref_share_take<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  long_suf <span class="main">=</span> long_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Suffix comparability"</span></span>

<span class="keyword1" id="CoWBasic-pref_comp_rev_suf_comp"><span class="command">lemma</span></span> pref_comp_rev_suf_comp<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">w</span><span class="main">)</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>rev <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-suf_comp_rev_pref_comp"><span class="command">lemma</span></span> suf_comp_rev_pref_comp<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">w</span><span class="main">)</span> <span class="main">⨝</span> <span class="main">(</span>rev <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_ruler_le <span class="main">=</span> suffix_length_suffix <span class="comment1">― ‹provided by Sublist.thy, same as ruler\_le[reversed]›</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_ruler <span class="main">=</span> suffix_same_cases <span class="comment1">― ‹provided by Sublist.thy, same as ruler[reversed]›</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_ruler_equal <span class="main">=</span> ruler_equal<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_ruler_comp <span class="main">=</span> ruler_comp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    ruler_suf <span class="main">=</span> ruler_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_short <span class="main">=</span> pref_prod_short<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_short' <span class="main">=</span> pref_prod_short'<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_cancel <span class="main">=</span> pref_prod_cancel<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_cancel' <span class="main">=</span> pref_prod_cancel'<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_suf_short <span class="main">=</span> pref_prod_pref_short<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_suf <span class="main">=</span> pref_prod_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_suf' <span class="main">=</span> pref_prod_pref'<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">unfolded</span> rassoc<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prolong <span class="main">=</span> pref_prolong<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prolong' <span class="main">=</span> pref_prolong'<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">unfolded</span> rassoc<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prolong_comp <span class="main">=</span> pref_prolong_comp<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">unfolded</span> rassoc<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_long <span class="main">=</span> pref_prod_long<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_longer <span class="main">=</span> pref_prod_longer<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_keeps_root <span class="main">=</span> pref_keeps_root<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    comm_suf_ruler <span class="main">=</span> comm_ruler<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_sufs_comp <span class="main">=</span> comp_prefs_comp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_comp_not_suf <span class="main">=</span> pref_comp_not_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_comp_not_ssuf <span class="main">=</span> pref_comp_not_spref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="comment1">(* hd_no_split = last_no_split[reversed] *)</span> <span class="comment1">(* this is suffix_Cons *)</span>
  suf_comp_ext <span class="main">=</span> comp_ext<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_incomp_ext <span class="main">=</span> incomp_ext<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  mismatch_suf_incopm <span class="main">=</span> mismatch_incopm<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_comp_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span> <span class="main">=</span> pref_comp_sym<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-suf_comp_last_eq"><span class="command">lemma</span></span> suf_comp_last_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="free">u</span> <span class="main">=</span> last <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_hd_eq<span class="main">[</span><span class="operator">reversed</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hd_rev<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> hd_rev<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-suf_comp_last_eq'"><span class="command">lemma</span></span> suf_comp_last_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">⨝<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> last <span class="free">u</span> <span class="main">=</span> last <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_sufs_comp suf_comp_last_eq  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Left and Right Quotient"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A useful function of left quotient is given. Note that the function is sometimes undefined.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">left_quotient</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>   <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword1">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="keyword3">)</span><span class="keyword3">(</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>75<span class="main">,</span>74<span class="main">]</span> 74<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> left_quotient_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left_quotient</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> left_quotient  <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\ensuremath{ {›</span>_ <span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹}^{-1} \\cdot {›</span> _ <span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹}}›</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Analogously, we define the right quotient.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">right_quotient</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">(</span><span class="keyword1"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span>_<span class="keyword3">)</span> "</span> <span class="main">[</span>76<span class="main">,</span>77<span class="main">]</span> 76<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> right_quotient_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">right_quotient</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>  <span class="main">=</span> rev <span class="main">(</span><span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> right_quotient <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹\\ensuremath{ {›</span>_ <span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹} \\cdot {›</span> _ <span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">latex</span><span class="hidden">&gt;</span>‹}^{-1}}›</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Priorities of these operations are as follows:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">v</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1" id="CoWBasic-rq_rev_lq"><span class="command">lemma</span></span> rq_rev_lq<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="main">(</span>rev <span class="free">u</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-lq_rev_rq"><span class="command">lemma</span></span> lq_rev_rq<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">v</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span>rev <span class="free">u</span> <span class="main">=</span> rev <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Quotient›</span></span>

<span class="keyword1" id="CoWBasic-lqI"><span class="command">lemma</span></span> lqI<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_triv"><span class="command">lemma</span></span> lq_triv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lqI<span class="main">[</span><span class="operator">OF</span> refl<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-lq_triv'"><span class="command">lemma</span></span> lq_triv'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span><span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-lq_self"><span class="command">lemma</span></span> lq_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>     
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_emp"><span class="command">lemma</span></span> lq_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>       

<span class="keyword1" id="CoWBasic-lq_pref"><span class="command">lemma</span></span> lq_pref<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_the"><span class="command">lemma</span></span> lq_the<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-lq_reassoc"><span class="command">lemma</span></span> lq_reassoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">)</span><span class="main">⋅</span><span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_trans"><span class="command">lemma</span></span> lq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">v</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_rq_reassoc_suf"><span class="command">lemma</span></span> lq_rq_reassoc_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">⋅</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">z</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-lq_ne"><span class="command">lemma</span></span> lq_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main">⋅</span><span class="free">p</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">p</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="CoWBasic-lq_spref"><span class="command">lemma</span></span> lq_spref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_suf_suf"><span class="command">lemma</span></span> lq_suf_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">s</span><span class="main">)</span> <span class="keyword1">≤s</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lq_len"><span class="command">lemma</span></span> lq_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span>  <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_lq"><span class="command">lemma</span></span> pref_lq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-spref_lq"><span class="command">lemma</span></span> spref_lq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">&lt;p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span> <span class="keyword1">&lt;p</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CoWBasic-conjug_lq"><span class="command">lemma</span></span> conjug_lq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-conjug_emp_emp"><span class="command">lemma</span></span> conjug_emp_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-lq_drop"><span class="command">lemma</span></span> lq_drop<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">v</span> <span class="main">=</span> drop <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-lq_code"><span class="command">lemma</span></span> lq_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"left_quotient <span class="keyword1">ε</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
  <span class="quoted"><span class="quoted">"left_quotient <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">u</span><span class="main">)</span> <span class="keyword1">ε</span> <span class="main">=</span> undefined"</span></span>
  <span class="quoted"><span class="quoted">"left_quotient <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">#</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> left_quotient <span class="free">u</span> <span class="free">v</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Right quotient"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rqI <span class="main">=</span> lqI<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_triv <span class="main">=</span> lq_triv<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_triv' <span class="main">=</span> lq_triv'<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_sefl <span class="main">=</span> lq_self<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_emp <span class="main">=</span> lq_emp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_suf <span class="main">=</span> lq_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_ssuf <span class="main">=</span> lq_spref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_reassoc <span class="main">=</span> lq_reassoc<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_len <span class="main">=</span> lq_len<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_trans <span class="main">=</span> lq_trans<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_lq_reassoc_suf <span class="main">=</span> lq_rq_reassoc_suf<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_ne <span class="main">=</span> lq_ne<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_suf_suf <span class="main">=</span> lq_suf_suf<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_rq <span class="main">=</span> pref_lq<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  ssuf_rq <span class="main">=</span> spref_lq<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  conjug_rq <span class="main">=</span> conjug_lq<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  conjug_emp_emp' <span class="main">=</span> conjug_emp_emp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  rq_take <span class="main">=</span> lq_drop<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left and right quotients combined›</span></span>

<span class="keyword1" id="CoWBasic-rev_lq'"><span class="command">lemma</span></span> rev_lq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> rev <span class="main">(</span><span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="main">(</span>rev <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_rq_suf_lq"><span class="command">lemma</span></span> pref_rq_suf_lq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤s</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">≤s</span> <span class="main">(</span><span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_reassoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> rq_suf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> triv_suf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_lq_pref_rq <span class="main">=</span> pref_rq_suf_lq<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rqI<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-lq_rq_assoc"><span class="command">lemma</span></span> lq_rq_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤s</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span> <span class="main">=</span> <span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_reassoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> rq_suf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> rqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1"><span class="command">lemmas</span></span> rq_lq_assoc <span class="main">=</span> lq_rq_assoc<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-lq_prod"><span class="command">lemma</span></span> lq_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span><span class="main">⋅</span><span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span>  <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span><span class="main">⋅</span><span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_reassoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span><span class="main">]</span> lq_rq_reassoc_suf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rq_triv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> rq_prod <span class="main">=</span> lq_prod<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Equidivisibility›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Equidivisibility is the following property: if
\[
xy = uv,
\]
then there exists a word $t$ such that $xt = u$ and $ty = v$, or $ut = x$ and $y = tv$.
For monoids over words, this property is equivalent to the freeness of the monoid.
As the monoid of all words is free, we can prove that it is equidivisible.
Related lemmas based on this property follow.
›</span></span>


<span class="keyword1" id="CoWBasic-eqd"><span class="command">lemma</span></span> eqd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj<span class="main">)</span>

<span class="keyword1" id="CoWBasic-eqdE"><span class="command">lemma</span></span> eqdE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-eqdE'"><span class="command">lemma</span></span> eqdE'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqdE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> lenarg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_append<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="CoWBasic-eqd_pref"><span class="command">lemma</span></span> eqd_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd lq_triv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-eqd_prefE"><span class="command">lemma</span></span> eqd_prefE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_pref assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-eqd_pref1"><span class="command">lemma</span></span> eqd_pref1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-eqd_pref2"><span class="command">lemma</span></span> eqd_pref2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-eqd_equal"><span class="command">lemma</span></span> eqd_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="CoWBasic-pref_equal"><span class="command">lemma</span></span> pref_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-eqd_equal_suf"><span class="command">lemma</span></span> eqd_equal_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="CoWBasic-eqd_comp"><span class="command">lemma</span></span> eqd_comp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_cases<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⨝</span> <span class="free">u</span>"</span></span><span class="main">]</span> 
    eqd_pref1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">,</span> <span class="operator">THEN</span> prefI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span>"</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> 
    eqd_pref1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">,</span> <span class="operator">THEN</span> prefI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹not equal to eqd\_pref1[reversed]›</span>
<span class="keyword1" id="CoWBasic-eqd_suf1"><span class="command">lemma</span></span> eqd_suf1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_pref2 rq_triv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">― ‹not equal to eqd\_pref2[reversed]›</span> 
<span class="keyword1" id="CoWBasic-eqd_suf2"><span class="command">lemma</span></span> eqd_suf2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rq_reassoc<span class="main">[</span><span class="operator">OF</span> sufI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eqd_suf1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>›</span></span> rq_triv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="comment1">― ‹ not equal to eqd\_pref[reversed] ›</span>
<span class="keyword1" id="CoWBasic-eqd_suf"><span class="command">lemma</span></span> eqd_suf<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_suf1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> eqd_suf2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Longest common prefix›</span></span>

<span class="keyword1"><span class="command">notation</span></span> longest_common_prefix  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> _"</span> <span class="main">[</span>61<span class="main">,</span>62<span class="main">]</span> 64<span class="main">)</span> <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1"><span class="command">lemmas</span></span> lcp_simps <span class="main">=</span> longest_common_prefix.simps <span class="comment1">― ‹provided by Sublist.thy›</span>

<span class="keyword1" id="CoWBasic-lcp_sym"><span class="command">lemma</span></span> lcp_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

 <span class="comment1">― ‹provided by Sublist.thy›</span>
<span class="keyword1"><span class="command">lemmas</span></span> lcp_pref <span class="main">=</span> longest_common_prefix_prefix1
<span class="keyword1"><span class="command">lemmas</span></span> lcp_pref' <span class="main">=</span> longest_common_prefix_prefix2
<span class="keyword1"><span class="command">lemmas</span></span> pref_pref_lcp <span class="main">=</span> longest_common_prefix_max_prefix

<span class="keyword1" id="CoWBasic-lcp_take_eq"><span class="command">lemma</span></span> lcp_take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> lcp_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> pref_take<span class="main">[</span><span class="operator">OF</span> lcp_pref'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-lcp_pref_conv"><span class="command">lemma</span></span> lcp_pref_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟷</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_order.eq_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> lcp_pref'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> 
    lcp_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> longest_common_prefix_max_prefix<span class="main">[</span><span class="operator">OF</span> self_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pref_lcp_pref"><span class="command">lemma</span></span> pref_lcp_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_pref pref_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-pref_lcp_pref'"><span class="command">lemma</span></span> pref_lcp_pref'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_lcp_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">,</span> <span class="operator">unfolded</span> lcp_sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-lcp_self"><span class="command">lemma</span></span> lcp_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_pref_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-lcp_eq"><span class="command">lemma</span></span> lcp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  long_pref<span class="main">[</span><span class="operator">OF</span> lcp_pref<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                                       

<span class="keyword1" id="CoWBasic-lcp_len"><span class="command">lemma</span></span> lcp_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> long_pref<span class="main">[</span><span class="operator">OF</span> lcp_pref<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lcp_pref_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1" id="CoWBasic-lcp_len'"><span class="command">lemma</span></span> lcp_len'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_le_imp_less<span class="main">[</span><span class="operator">OF</span> contrapos_nn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ lcp_len<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-incomp_lcp_len"><span class="command">lemma</span></span> incomp_lcp_len<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_less_iff_conj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms lcp_len'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> lcp_len'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">,</span> <span class="operator">folded</span> lcp_sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  
    min_less_iff_conj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-lcp_ext_right"><span class="command">lemma</span></span> lcp_ext_right <span class="main">[</span><span class="operator">case_names</span> comp non_comp<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">obtains</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⨝</span> <span class="free">r'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">)</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">r'</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">r'</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r'</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-lcp_same_len"><span class="command">lemma</span></span> lcp_same_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_ext_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="main">_</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">w'</span></span><span class="main">]</span> pref_comp_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1" id="CoWBasic-lcp_mismatch"><span class="command">lemma</span></span> lcp_mismatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span><span class="main">!</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lcp_mismatch'"><span class="command">lemma</span></span> lcp_mismatch'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">!</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> incomp_lcp_len<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> min_less_iff_conj<span class="main">]</span> lcp_mismatch
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-lcp_ext_left"><span class="command">lemma</span></span> lcp_ext_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">)</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lcp_first_letters"><span class="command">lemma</span></span> lcp_first_letters<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">!</span><span class="main">0</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-lcp_first_mismatch"><span class="command">lemma</span></span> lcp_first_mismatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">v</span>  <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcp_ext_left<span class="main">)</span>

<span class="keyword1" id="CoWBasic-lcp_first_mismatch'"><span class="command">lemma</span></span> lcp_first_mismatch'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_first_mismatch<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-lcp_mismatch_shorter"><span class="command">lemma</span></span> lcp_mismatch_shorter<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main">)</span> 
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcp_self<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span>  lcp_first_mismatch'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">use</span> lcp_same_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">y</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-lcp_rulers"><span class="command">lemma</span></span> lcp_rulers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="keyword1">≤p</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">⨝</span> <span class="free">r'</span> <span class="main">∨</span> <span class="free">r</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r'</span> <span class="main">=</span> <span class="free">s</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_ext_right prefD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> prefD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r'</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-pref_pref_lcp'"><span class="command">lemma</span></span> pref_pref_lcp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">w'</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w'</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_pref_lcp lcp_pref lcp_sym pref_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-lcp_distinct_hd"><span class="command">lemma</span></span> lcp_distinct_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">u</span> <span class="main">≠</span> hd <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">u</span> <span class="main">≠</span> hd <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main">⟹</span> hd <span class="free">u</span> <span class="main">≠</span> hd <span class="free">v</span> <span class="main">⟹</span>  <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcp_first_letters hd_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span>  <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lcp_pref' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="free">u</span> <span class="main">≠</span> hd <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1" id="CoWBasic-lcp_lenI"><span class="command">lemma</span></span> lcp_lenI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">!</span><span class="free">i</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">⋅</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">v</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">⋅</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">from</span></span> lcp_first_mismatch<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main">!</span><span class="free">i</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="free">i</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">v</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> u v<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">u</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-lcp_prefs"><span class="command">lemma</span></span> lcp_prefs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Longest common prefix and prefix comparability"</span></span>

<span class="keyword1" id="CoWBasic-lexord_cancel_right"><span class="command">lemma</span></span> lexord_cancel_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">,</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-lcp_ruler"><span class="command">lemma</span></span> lcp_ruler<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⨝</span> <span class="free">w1</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">w2</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">w1</span> <span class="main">⨝</span> <span class="free">w2</span> <span class="main">⟹</span> <span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w1</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> pref_pref_lcp pref_trans ruler<span class="main">)</span>

<span class="keyword1" id="CoWBasic-comp_monotone"><span class="command">lemma</span></span> comp_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> <span class="free">r</span>  <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> ruler<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-comp_monotone'"><span class="command">lemma</span></span> comp_monotone'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> <span class="free">r</span>  <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w'</span> <span class="main">⨝</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_monotone<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ longest_common_prefix_prefix1<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-double_ruler"><span class="command">lemma</span></span> double_ruler<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="main">⨝</span> <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">r'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">w'</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_monotone'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w'</span> <span class="main">⨝</span> <span class="free">r'</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">unfolding</span></span> lcp_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> lcp_ruler<span class="main">[</span><span class="operator">OF</span> comp_monotone'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">⨝</span> <span class="free">r</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">w'</span></span><span class="main"><span class="main">]</span></span> _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">r</span> <span class="main">⨝</span> <span class="free">r'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_comp_ruler"><span class="command">lemma</span></span> pref_comp_ruler<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> double_ruler<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">⨝</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>›</span></span> mismatch_incopm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lcp_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> lcp_mismatch_shorter<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> pref_lcp_pref pref_lcp_pref' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> suf_comp_ruler <span class="main">=</span> pref_comp_ruler<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Mismatch"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first pair of letters on which two words/lists disagree›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mismatch_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mismatch_pair</span> <span class="keyword1">ε</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ε</span><span class="main">!</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mismatch_pair</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">ε</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">,</span> <span class="keyword1">ε</span><span class="main">!</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mismatch_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">mismatch_pair</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Alternatively, mismatch pair may be defined using the longest common prefix as follows.›</span></span>

<span class="keyword1" id="CoWBasic-mismatch_pair_lcp"><span class="command">lemma</span></span> mismatch_pair_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">!</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">,</span><span class="free">v</span><span class="main">!</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mismatch_pair.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For incomparable words the pair is out of diagonal.›</span></span>

<span class="keyword1" id="CoWBasic-incomp_neq"><span class="command">lemma</span></span> incomp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span>mismatch_pair <span class="free">u</span> <span class="free">v</span><span class="main">)</span> <span class="main">∉</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mismatch_pair_lcp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcp_mismatch'<span class="main">)</span>

<span class="keyword1" id="CoWBasic-mismatch_ext_left"><span class="command">lemma</span></span> mismatch_ext_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> mismatch_pair <span class="main">(</span><span class="free">p</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> mismatch_pair_lcp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcp_ext_left<span class="main">)</span>

<span class="keyword1" id="CoWBasic-mismatch_ext_right"><span class="command">lemma</span></span> mismatch_ext_right<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> mismatch_pair <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> less1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> less2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lcp_len'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> lcp_len'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> mismatch_pair_lcp <span class="keyword1"><span class="command">unfolding</span></span> pref_index<span class="main">[</span><span class="operator">OF</span> triv_pref less1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>  pref_index<span class="main">[</span><span class="operator">OF</span> triv_pref less2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> lcp_sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms lcp_ext_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="main">_</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="CoWBasic-mismatchI"><span class="command">lemma</span></span> mismatchI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> take <span class="free">i</span> <span class="free">u</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">!</span><span class="free">i</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="free">i</span>
   <span class="main">⟹</span> mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">!</span><span class="free">i</span><span class="main">,</span><span class="free">v</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mismatch_pair_lcp <span class="keyword1"><span class="command">using</span></span> lcp_lenI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For incomparable words, the mismatch letters work in a similar way as the lexicographic order›</span></span>

<span class="keyword1" id="CoWBasic-mismatch_lexord"><span class="command">lemma</span></span> mismatch_lexord<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>    
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lexord_take_index_conv mismatch_pair_lcp
  <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">r</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> mismatch_pair_lcp<span class="main">]</span>
    incomp_lcp_len<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> lcp_take_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹However, the equivalence requires r to be irreflexive. 
(Due to the definition of lexord which is designed for irreflexive relations.)›</span></span>

<span class="keyword1" id="CoWBasic-lexord_mismatch"><span class="command">lemma</span></span> lexord_mismatch<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="free">u</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">v</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> lexord_take_index_conv<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>›</span></span> pref_take_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">!</span><span class="skolem">i</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹irrefl <span class="free">r</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> irrefl_def<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">v</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">v</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>›</span></span><span class="main">[</span><span class="operator">folded</span> mismatchI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> min <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="skolem">i</span> <span class="free">u</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="free">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main">!</span><span class="skolem">i</span> <span class="main">≠</span> <span class="free">v</span><span class="main">!</span><span class="skolem">i</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">r</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> mismatch_lexord<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">u</span> <span class="main">⨝</span> <span class="free">v</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Factor properties"</span></span>

<span class="keyword1" id="CoWBasic-rev_fac"><span class="command">lemma</span></span> rev_fac<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="keyword1">≤f</span> rev <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sublist.sublist_rev<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-fac_pref"><span class="command">lemma</span></span> fac_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-fac_pref_suf"><span class="command">lemma</span></span> fac_pref_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sublist_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_suf_fac"><span class="command">lemma</span></span> pref_suf_fac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sublist_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> 
  fac_suf <span class="main">=</span> fac_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  fac_suf_pref <span class="main">=</span> fac_pref_suf<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  suf_pref_fac <span class="main">=</span> pref_suf_fac<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-suf_pref_eq"><span class="command">lemma</span></span> suf_pref_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤s</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sublist_order.eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-fac_triv'"><span class="command">lemma</span></span> fac_triv'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">q</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">q</span>"</span></span><span class="main">]</span> sufI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> suf_ext<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">q</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    suf_pref_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span>"</span></span><span class="main">]</span> self_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> assms append_Nil rassoc 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-fac_triv"><span class="command">lemma</span></span> fac_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">q</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fac_triv' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

<span class="keyword1"><span class="command">lemmas</span></span> 
  suf_fac <span class="main">=</span> suffix_imp_sublist <span class="keyword2"><span class="keyword">and</span></span>
  pref_fac <span class="main">=</span> prefix_imp_sublist

<span class="keyword1" id="CoWBasic-fac_Cons_E"><span class="command">lemma</span></span> fac_Cons_E<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> sublist_Cons_right<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span>
  fac_snoc_E <span class="main">=</span> fac_Cons_E<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Power and its properties"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Word powers are often investigated in Combinatorics on Words.
We thus interpret words as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">monoid_mult</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and adopt a notation for the word power.
›</span></span>


<span class="keyword1"><span class="command">declare</span></span> power.power.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span> 

<span class="keyword1"><span class="command">interpretation</span></span>  monoid_mult <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"append"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">notation</span></span> power <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">⇧</span><sup>@</sup></span>"</span> 80<span class="main">)</span>

<span class="comment1">― ‹inherited power properties›</span>

<span class="keyword1" id="CoWBasic-pow_zero"><span class="command">lemma</span></span> pow_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">0</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power.power_0<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-emp_pow"><span class="command">lemma</span></span> emp_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_one<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_Suc_list"><span class="command">lemma</span></span> pow_Suc_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power.power_Suc<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_commutes_list"><span class="command">lemma</span></span> pow_commutes_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> power_commutes<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_add_list"><span class="command">lemma</span></span> pow_add_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main">⋅</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_add<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_Suc2_list"><span class="command">lemma</span></span> pow_Suc2_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="free">n</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_Suc2<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_eq_if_list"><span class="command">lemma</span></span> pow_eq_if_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">ε</span> <span class="keyword1">else</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">p</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_eq_if<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_one_id"><span class="command">lemma</span></span> pow_one_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">1</span> <span class="main">=</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> power_one_right<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow2_list"><span class="command">lemma</span></span> pow2_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="numeral">2</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power2_eq_square<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-comm_add_exp"><span class="command">lemma</span></span> comm_add_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">n</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_commuting_commutes<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_mult_list"><span class="command">lemma</span></span> pow_mult_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_mult<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pow_rev_emp_conv"><span class="command">lemma</span></span> pow_rev_emp_conv<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"power.power <span class="main">(</span>rev <span class="keyword1">ε</span><span class="main">)</span> <span class="main">(⋅)</span> <span class="main">=</span> <span class="main">(<span class="hidden">⇧</span><sup>@</sup>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">― ‹more power properties›</span>

<span class="keyword1" id="CoWBasic-zero_exp"><span class="command">lemma</span></span> zero_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-nemp_pow"><span class="command">lemma</span></span> nemp_pow<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-nemp_pow'"><span class="command">lemma</span></span> nemp_pow'<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-sing_pow"><span class="command">lemma</span></span> sing_pow<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> diff_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pow_is_concat_replicate"><span class="command">lemma</span></span> pow_is_concat_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">=</span> concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-pow_slide"><span class="command">lemma</span></span> pow_slide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>  <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-pop_pow_one"><span class="command">lemma</span></span> pop_pow_one<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_eq_if_list<span class="main">)</span>

<span class="keyword1" id="CoWBasic-hd_pow"><span class="command">lemma</span></span> hd_pow<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pop_pow_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span>  hd_append2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>   


<span class="keyword1" id="CoWBasic-pop_pow"><span class="command">lemma</span></span> pop_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span>  <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_add_diff_inverse pow_add_list  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1" id="CoWBasic-pop_pow_cancel"><span class="command">lemma</span></span> pop_pow_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  lassoc pop_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> same_append_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="free">m</span><span class="main">)</span><span class="main">⋅</span><span class="free">v</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> lassoc<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span> 

<span class="keyword1" id="CoWBasic-pow_comm"><span class="command">lemma</span></span> pow_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_add_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="CoWBasic-comm_add_exps"><span class="command">lemma</span></span> comm_add_exps<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comm_add_exp<span class="main">[</span><span class="operator">OF</span> comm_add_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-rev_pow"><span class="command">lemma</span></span> rev_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_commutes_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span> <span class="main">=</span> rev_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> pow_eq_if_list' <span class="main">=</span> pow_eq_if_list<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  pop_pow_one' <span class="main">=</span> pop_pow_one<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  pop_pow' <span class="main">=</span> pop_pow<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  pop_pow_cancel' <span class="main">=</span> pop_pow_cancel<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-pow_len"><span class="command">lemma</span></span> pow_len<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-eq_pow_exp"><span class="command">lemma</span></span> eq_pow_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⟷</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> lenarg<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> pow_len mult_cancel2<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">[</span><span class="operator">folded</span> length_0_conv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoWBasic-nemp_emp_power"><span class="command">lemma</span></span> nemp_emp_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span>  eq_pow_exp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-nonzero_pow_emp"><span class="command">lemma</span></span> nonzero_pow_emp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟷</span>  <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms nemp_emp_power nemp_pow'<span class="main">)</span>

<span class="keyword1" id="CoWBasic-pow_eq_eq"><span class="command">lemma</span></span> pow_eq_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lenarg<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> pow_len<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eqd_equal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pop_pow_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_pow_empty"><span class="command">lemma</span></span> sing_pow_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nemp_emp_power<span class="main">)</span>

<span class="keyword1" id="CoWBasic-sing_pow_lists"><span class="command">lemma</span></span> sing_pow_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-long_power"><span class="command">lemma</span></span> long_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> nemp_pos_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-long_power'"><span class="command">lemma</span></span> long_power'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_Suc_list length_append 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> long_power add_strict_increasing<span class="main">)</span>  

<span class="keyword1" id="CoWBasic-long_pow_exp"><span class="command">lemma</span></span> long_pow_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> nemp_pos_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword1" id="CoWBasic-long_pow_ex"><span class="command">lemma</span></span> long_pow_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ex_list_of_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">OF</span> long_power<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pref_pow_ext"><span class="command">lemma</span></span> pref_pow_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_trans<span class="main">[</span><span class="operator">OF</span> _ prefI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pow_Suc2_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_pow_ext'"><span class="command">lemma</span></span> pref_pow_ext'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_pow_ext<span class="main">[</span><span class="operator">unfolded</span> pow_Suc_list<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_pow_root_ext"><span class="command">lemma</span></span> pref_pow_root_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_prod_root"><span class="command">lemma</span></span> pref_prod_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_pow_ext'<span class="main">[</span><span class="operator">THEN</span> pref_prod_pref<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_exps_pow"><span class="command">lemma</span></span> pref_exps_pow<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> leI pop_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-pref_exp_le"><span class="command">lemma</span></span> pref_exp_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_cancel_le<span class="main">[</span><span class="operator">OF</span> nemp_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> 
    prefix_length_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> pow_len<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span> pow_len<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       

<span class="keyword1"><span class="command">lemmas</span></span>
    suf_pow_ext <span class="main">=</span> pref_pow_ext<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_pow_ext'<span class="main">=</span> pref_pow_ext'<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_pow_root_ext <span class="main">=</span> pref_pow_root_ext<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_prod_root <span class="main">=</span> pref_prod_root<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_exps_pow <span class="main">=</span> pref_exps_pow<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
    suf_exp_le <span class="main">=</span> pref_exp_le<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-comm_common_power"><span class="command">lemma</span></span> comm_common_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eqd_equal<span class="main">[</span><span class="operator">OF</span> comm_add_exps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>   

<span class="keyword1" id="CoWBasic-one_generated_list_power"><span class="command">lemma</span></span> one_generated_list_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> concat <span class="free">u</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_is_concat_replicate<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Cons_in_lists_iff concat.simps<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> singletonD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> pow_Suc_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pow_lists"><span class="command">lemma</span></span> pow_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_eq_if_list<span class="main">)</span>

<span class="keyword1" id="CoWBasic-concat_morph_power"><span class="command">lemma</span></span> concat_morph_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ts</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> concat <span class="free">ts</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> concat <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-pref_not_idem"><span class="command">lemma</span></span> pref_not_idem<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fac_triv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-per_exp_pref"><span class="command">lemma</span></span> per_exp_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pow_Suc_list rassoc
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems pref_prolong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span>
  suf_not_idem <span class="main">=</span>  pref_not_idem<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  per_exp_suf <span class="main">=</span> per_exp_pref<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-hd_sing_power"><span class="command">lemma</span></span> hd_sing_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> hd <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-root_pref_cancel"><span class="command">lemma</span></span> root_pref_cancel<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">unfolding</span></span> lqI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span>  nat_le_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> pop_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> diff_is_0_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span>   append.right_neutral<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">]</span> pow_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> 
    pref_antisym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> prefI<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> pref_exps_pow<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemmas</span></span> root_suf_cancel <span class="main">=</span> root_pref_cancel<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-index_pow_mod"><span class="command">lemma</span></span> index_pow_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">r</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span>  <span class="free">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span>  <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> less_diff_conv2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      get_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> le_add_diff_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux sym<span class="main">[</span><span class="operator">OF</span> pow_Suc2_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> nth_append le_mod_geq 
    <span class="keyword1"><span class="command">using</span></span> aux1<span class="main">[</span> <span class="operator">OF</span> _ Suc.prems<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> aux<span class="main"><span class="main">]</span></span><span class="main">]</span>
      Suc.IH pow_Suc2_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Suc.prems<span class="main">[</span><span class="operator">unfolded</span> aux<span class="main">]</span> leI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-sing_pow_len"><span class="command">lemma</span></span> sing_pow_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-concat_take_sing"><span class="command">lemma</span></span> concat_take_sing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> concat <span class="main">(</span>take <span class="free">k</span> <span class="main">(</span><span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">l</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span>
        sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> take_Suc_conv_app_nth<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> sing_pow_len<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> less_eq_Suc_le  
            sing_pow<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> less_eq_Suc_le Suc.prems<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">≤</span> <span class="free">l</span>›</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> 
        concat_sing'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span> 
        Suc.hyps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc_leD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
        pow_Suc2_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-concat_sing_pow"><span class="command">lemma</span></span> concat_sing_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> Suc <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-unique_letter_word"><span class="command">lemma</span></span> unique_letter_word<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">w</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pow_zero<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">w</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">#</span><span class="skolem">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> Cons.prems<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-unique_letter_wordE"><span class="command">lemma</span></span> unique_letter_wordE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">w</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unique_letter_word assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
<span class="keyword1" id="CoWBasic-unique_letter_wordE'"><span class="command">lemma</span></span> unique_letter_wordE'<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms unique_letter_word<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-conjug_pow"><span class="command">lemma</span></span> conjug_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-shift_pow"><span class="command">lemma</span></span> shift_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conjug_pow<span class="main">)</span>

<span class="keyword1" id="CoWBasic-lq_conjug_pow"><span class="command">lemma</span></span> lq_conjug_pow<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lqI<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conjug_pow<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">p</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> sym<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> lq_pref<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span>›</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> rq_conjug_pow <span class="main">=</span> lq_conjug_pow<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Total morphisms"</span></span>

<span class="keyword1"><span class="command">locale</span></span>  morphism <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> morph<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CoWBasic-emp_to_emp"><span class="command">lemma</span></span> emp_to_emp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">ε</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main">]</span> self_append_conv2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">ε</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pow_morph"><span class="command">lemma</span></span> pow_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> morph<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-pop_hd"><span class="command">lemma</span></span> pop_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">f</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hd_word<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> morph<span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1" id="CoWBasic-pop_hd_nemp"><span class="command">lemma</span></span> pop_hd_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[</span>hd <span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">(</span>tl <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list.exhaust_sel pop_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CoWBasic-pop_last_nemp"><span class="command">lemma</span></span> pop_last_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>butlast <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">[</span>last <span class="free">u</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> morph<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> append_butlast_last_id <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="CoWBasic-pref_mono"><span class="command">lemma</span></span> pref_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> morph <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-morph_concat_map"><span class="command">lemma</span></span> morph_concat_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> pop_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> two_morphisms <span class="main">=</span> morphg<span class="main">:</span> morphism <span class="quoted"><span class="free">g</span></span> <span class="main">+</span> morphh<span class="main">:</span> morphism <span class="quoted"><span class="free">h</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">g</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="CoWBasic-def_on_sings"><span class="command">lemma</span></span> def_on_sings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">=</span> <span class="free">h</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">u</span> <span class="main">=</span> <span class="free">h</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> morphg.pop_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> morphh.pop_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">=</span> <span class="free">h</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Reversed morphism and composition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rev_morph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rev_morph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> rev <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> rev"</span></span> 

<span class="keyword1" id="CoWBasic-rev_morph_idemp"><span class="command">lemma</span></span> rev_morph_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev_morph <span class="main">(</span>rev_morph <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_morph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-morph_compose"><span class="command">lemma</span></span> morph_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"morphism <span class="free">f</span> <span class="main">⟹</span> morphism <span class="free">g</span> <span class="main">⟹</span> morphism <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> morphism_def<span class="main">)</span>

<span class="keyword1" id="CoWBasic-rev_morph_arg"><span class="command">lemma</span></span> rev_morph_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"rev_morph <span class="free">f</span> <span class="free">u</span> <span class="main">=</span> rev <span class="main">(</span><span class="free">f</span> <span class="main">(</span>rev <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_morph_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> rev_morph_arg_rev<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span> <span class="main">=</span> rev_morph_arg<span class="main">[</span><span class="operator">reversed</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_rev_ident<span class="main">]</span>

<span class="keyword1" id="CoWBasic-rev_morph_sing"><span class="command">lemma</span></span> rev_morph_sing<span class="main">:</span> <span class="quoted"><span class="quoted">"rev_morph <span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span>  rev <span class="main">(</span><span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_morph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> morphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CoWBasic-rev_morph_morph"><span class="command">lemma</span></span>  rev_morph_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"morphism <span class="main">(</span>rev_morph <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_morph_def morph<span class="main">)</span>

<span class="keyword1" id="CoWBasic-morph_rev_len"><span class="command">lemma</span></span> morph_rev_len<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">f</span> <span class="main">(</span>rev <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">f</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> rev.simps<span class="main">(</span>2<span class="main">)</span> pop_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> morph length_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rev_morph_len"><span class="command">lemma</span></span>  rev_morph_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>rev_morph <span class="free">f</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">f</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_morph_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> morph_rev_len<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rotation›</span></span>

<span class="keyword1" id="CoWBasic-rotate_comp_eq"><span class="command">lemma</span></span> rotate_comp_eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⨝</span> rotate <span class="free">n</span> <span class="free">w</span> <span class="main">⟹</span> rotate <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  pref_same_len<span class="main">[</span><span class="operator">OF</span> _ length_rotate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> pref_same_len<span class="main">[</span><span class="operator">OF</span> _ length_rotate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> mismatch_iff_lexord<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mismatch_pair <span class="free">w</span> <span class="main">(</span>rotate  <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span><span class="main">,</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">w</span> <span class="main">⨝</span> rotate <span class="free">n</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rotate_comp_eq <span class="quoted"><span class="quoted">‹rotate <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lexord_mismatch<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹irrefl <span class="free">r</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rotate_back"><span class="command">lemma</span></span> rotate_back<span class="main">:</span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">m</span> <span class="main">(</span>rotate <span class="free">n</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>   
    <span class="keyword1"><span class="command">unfolding</span></span> rotate_rotate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span>
      le_add_diff_inverse2<span class="main">[</span><span class="operator">OF</span>  
        less_imp_le_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mod_less_divisor<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> nemp_len<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">unfolded</span> neq0_conv<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      arg_cong<span class="main">[</span><span class="operator">OF</span> rotate_conv_mod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"rotate <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rotate_class_rotate'"><span class="command">lemma</span></span> rotate_class_rotate'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> rot_m<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="skolem">m</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rotate_back<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> rot_n<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="skolem">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  exI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> rotate <span class="bound">x</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">+</span><span class="skolem">m</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> 
        rotate_rotate<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">l</span> <span class="free">w</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> rot_m rot_n<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rotate_rotate<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rotate_class_rotate"><span class="command">lemma</span></span> rotate_class_rotate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">u</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rotate <span class="bound">n</span> <span class="main">(</span>rotate <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rotate_class_rotate' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-rotate_pow_self"><span class="command">lemma</span></span> rotate_pow_self<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="main">(</span><span class="free">l</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rotate_rotate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> mult_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Suc.hyps<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> rotate_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> pop_pow_one<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span> pop_pow_one'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rotate_root_self"><span class="command">lemma</span></span> rotate_root_self<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rotate_pow_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-rotate_pow_mod"><span class="command">lemma</span></span> rotate_pow_mod<span class="main">:</span>  <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> rotate <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rotate_rotate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rotate_pow_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-rotate_conj_pow"><span class="command">lemma</span></span> rotate_conj_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rotate_append shift_pow<span class="main">)</span>

<span class="keyword1" id="CoWBasic-rotate_pow_comm"><span class="command">lemma</span></span> rotate_pow_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="main">(</span><span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rotate <span class="free">n</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rotate_drop_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> rotate_pow_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> rotate_conj_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_take_drop_id<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span>  mod_le_divisor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">THEN</span> take_len<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main">≠</span><span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> length_greater_0_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists of words and their concatenation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The helpful lemmas of this section deal with concatenation of a list of words <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">concat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The main objective is to cover elementary facts needed to study factorizations of words.
›</span></span>


<span class="keyword1" id="CoWBasic-append_in_lists"><span class="command">lemma</span></span> append_in_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-concat_take_is_prefix"><span class="command">lemma</span></span> concat_take_is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="free">n</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">≤p</span> concat <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">ws</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_take_drop_id<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> prefI<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1" id="CoWBasic-concat_take_suc"><span class="command">lemma</span></span> concat_take_suc<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="free">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">ws</span><span class="main">!</span><span class="free">j</span> <span class="main">=</span> concat<span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> take_Suc_conv_app_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> sym<span class="main">[</span><span class="operator">OF</span> concat_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ws</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">unfolded</span> concat.simps<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span><span class="main">!</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> concat.simps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> append_Nil2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-pref_mod_list'"><span class="command">lemma</span></span> pref_mod_list'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤np</span> concat <span class="free">ws</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span><span class="main">!</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="free">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">u</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">u</span> <span class="keyword1">≤p</span> concat<span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹largest j such that concat (take j ws) &lt;p u›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> concat<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">l</span>›</span></span><span class="main">]</span>
      LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">l</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sym<span class="main">[</span><span class="operator">OF</span> j_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">&lt;p</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">&lt;p</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_def not_less_Least <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">&lt;p</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pref_comp_not_pref ruler<span class="main">[</span><span class="operator">OF</span> concat_take_is_prefix npD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="var">?r</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">&lt;p</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">≤p</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  pref_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> concat <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> concat_take_suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  npI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span> <span class="keyword1">≤p</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="var">?r</span> <span class="main">=</span> <span class="free">u</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoWBasic-pref_mod_list_suf"><span class="command">lemma</span></span> pref_mod_list_suf<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤np</span> concat <span class="free">ws</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">&lt;s</span> <span class="free">ws</span><span class="main">!</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_mod_list'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">ws</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span> <span class="keyword1">&lt;s</span> <span class="main">(</span><span class="free">ws</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ssufI1<span class="main">[</span><span class="operator">OF</span> _ npD'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  lq_pref<span class="main">[</span><span class="operator">OF</span> npD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="skolem">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">ws</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">OF</span> npD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span>
        same_append_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lassoc
        <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">u</span>›</span></span> concat_take_suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">≤np</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">ws</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span> <span class="keyword1">&lt;s</span> <span class="main">(</span><span class="free">ws</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="CoWBasic-suf_mod_list'"><span class="command">lemma</span></span> suf_mod_list'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤ns</span> concat <span class="free">ws</span> <span class="main">⟹</span> <span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">⋅</span> <span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">≤ns</span> <span class="free">ws</span><span class="main">!</span><span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">≤ns</span> concat <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">s</span> <span class="keyword1">≤np</span> concat <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> rev <span class="bound">u</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="keyword1">≤ns</span> concat <span class="free">ws</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> nsuf_rev_pref_iff<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_concat rev_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"rev <span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> rev <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">≤np</span> rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_mod_list'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> rev <span class="bound">u</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹rev <span class="free">s</span> <span class="keyword1">≤np</span> concat <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> rev <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> length_map nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">ws</span>"</span></span> <span class="quoted">rev</span><span class="main">,</span> <span class="operator">unfolded</span> rev_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">rev</span> <span class="quoted"><span class="free">ws</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>  rev_rev_ident
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> rev_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span><span class="main">!</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">≤np</span> rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> npref_rev_suf_iff<span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">r</span> <span class="keyword1">≤ns</span> <span class="free">ws</span><span class="main">!</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_concat rev_map take_map take_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">⋅</span><span class="skolem">r</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> rev <span class="free">s</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> rev <span class="skolem">r</span> <span class="main">⋅</span> <span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  rev_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> rev_rev_ident<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> rev_rev_ident<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

  <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> Suc <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">=</span> Suc <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  Suc_diff_Suc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="main">(</span>map rev <span class="free">ws</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p0 p1<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> p2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pref_mod_list"><span class="command">lemma</span></span> pref_mod_list<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> concat <span class="free">ws</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">j</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">ws</span><span class="main">!</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="free">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">u</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> concat<span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹smallest j such that concat (take (Suc j) ws) &lt;p u›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> concat<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">l</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sym<span class="main">[</span><span class="operator">OF</span> j_def<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">l</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sym<span class="main">[</span><span class="operator">OF</span> j_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟹</span> concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      ruler<span class="main">[</span><span class="operator">OF</span> concat_take_is_prefix sprefD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="var">?r</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">≤p</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">&lt;p</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> spref_lq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">≤p</span> <span class="free">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">&lt;p</span> concat <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> 
        lq_triv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> concat_take_suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span> <span class="keyword1">&lt;p</span> <span class="free">ws</span><span class="main">!</span><span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹concat<span class="main">(</span>take <span class="skolem">j</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⋅</span> <span class="var">?r</span> <span class="main">=</span> <span class="free">u</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pref_mod_power"><span class="command">lemma</span></span> pref_mod_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_mod_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> sing_pow_len concat_sing_pow<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span> 
    sing_pow<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> concat_take_sing
    less_imp_le_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-get_pow_exp"><span class="command">lemma</span></span> get_pow_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">⋅</span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">,</span> <span class="operator">unfolded</span> pow_len<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span>  get_div<span class="main">[</span><span class="operator">OF</span> prefix_length_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-get_pow_remainder"><span class="command">lemma</span></span> get_pow_remainder<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> drop <span class="main">(</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">⋅</span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">⋅</span><span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  drop_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>  pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> get_pow_exp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_mod_power'"><span class="command">lemma</span></span> pref_mod_power'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤np</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_mod_list'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> sing_pow_len concat_sing_pow<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤np</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>›</span></span><span class="main">]</span> 
    sing_pow<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> concat_take_sing<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    less_imp_le_nat<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-pref_power"><span class="command">lemma</span></span> pref_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span> <span class="main">⋅</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="bound">m</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="bound">m</span> <span class="main">⋅</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">k</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">m</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_mod_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> prefix_order.dual_order.order_iff_strict<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">m</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">m</span> <span class="main">⋅</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1" id="CoWBasic-pref_powerE"><span class="command">lemma</span></span> pref_powerE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤p</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms pref_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-pref_power'"><span class="command">lemma</span></span> pref_power'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span> <span class="keyword1">&lt;p</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span> <span class="main">⋅</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">≤np</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">m</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">u</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> pref_mod_power'<span class="main">[</span><span class="operator">OF</span> npI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1" id="CoWBasic-suf_power"><span class="command">lemma</span></span> suf_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span> <span class="keyword1">≤s</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">u</span> <span class="keyword1">&lt;s</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> suffix_to_prefix rev_pow<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>   
  <span class="keyword1"><span class="command">from</span></span> pref_power<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="keyword1">≤p</span> rev <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> rev <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="keyword1">≤s</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="keyword1">≤p</span> rev <span class="free">u</span>›</span></span><span class="main">[</span><span class="operator">folded</span> suffix_to_prefix rev_pow<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;s</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sprefD1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rev <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> rev <span class="free">t</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> rev_pow  rev_append suffix_to_prefix<span class="main">]</span>
      sprefD2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rev <span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="main">(</span>rev <span class="free">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> rev <span class="free">t</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> rev_pow  rev_append<span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-suf_powerE"><span class="command">lemma</span></span> suf_powerE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤s</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤s</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;s</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms suf_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-del_emp_concat"><span class="command">lemma</span></span> del_emp_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> concat <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-lists_drop_emp"><span class="command">lemma</span></span> lists_drop_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">C</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-lists_drop_emp'"><span class="command">lemma</span></span> lists_drop_emp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">C</span> <span class="main">⟹</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span> <span class="main">∈</span> lists <span class="free">C</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_lists_conv_set<span class="main">)</span>

<span class="keyword1" id="CoWBasic-pref_concat_pref"><span class="command">lemma</span></span> pref_concat_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="keyword1">≤p</span> <span class="free">ws</span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="keyword1">≤p</span> concat <span class="free">ws</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-le_take_is_prefix"><span class="command">lemma</span></span> le_take_is_prefix<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">ws</span> <span class="keyword1">≤p</span> take <span class="free">n</span> <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> take_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">,</span> <span class="operator">unfolded</span> le_add_diff_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CoWBasic-take_pp_less"><span class="command">lemma</span></span> take_pp_less<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">ws</span> <span class="keyword1">&lt;p</span> take <span class="free">n</span> <span class="free">ws</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  conjunct2<span class="main">[</span><span class="operator">OF</span> sprefD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    leI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">THEN</span><span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> le_take_is_prefix<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span><span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> pref_antisym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">ws</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sprefD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-concat_pp_less"><span class="command">lemma</span></span> concat_pp_less<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>take <span class="free">k</span> <span class="free">ws</span><span class="main">)</span> <span class="keyword1">&lt;p</span> concat <span class="main">(</span>take <span class="free">n</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> le_take_is_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">,</span> <span class="operator">THEN</span> pref_concat_pref<span class="main">]</span> conjunct1<span class="main">[</span><span class="operator">OF</span> sprefD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    conjunct2<span class="main">[</span><span class="operator">OF</span> sprefD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> pref_antisym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="free">k</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>take <span class="free">n</span> <span class="free">ws</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Root›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> _<span class="keyword1">*</span>"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 60 <span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">*</span></span> <span class="main">=</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> root <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> _<span class="keyword1"><span class="hidden">⇧</span><sup>*</sup></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Empty word has all roots, including the empty root.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> power_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-rootI"><span class="command">lemma</span></span> rootI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-self_root"><span class="command">lemma</span></span> self_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">u</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-rootE"><span class="command">lemma</span></span> rootE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-empty_all_roots"><span class="command">lemma</span></span> empty_all_roots<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">unfolded</span> pow_zero<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-take_root"><span class="command">lemma</span></span> take_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_eq_if_list<span class="main">)</span>

<span class="keyword1" id="CoWBasic-root_nemp"><span class="command">lemma</span></span> root_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> emp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="CoWBasic-root_shorter"><span class="command">lemma</span></span> root_shorter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> root_def leI take_all take_root pow_zero<span class="main">)</span>

<span class="keyword1" id="CoWBasic-root_shorter_eq"><span class="command">lemma</span></span> root_shorter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_shorter <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-root_trans"><span class="command">lemma</span></span> root_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∈</span> <span class="free">u</span><span class="main">*</span><span class="main">;</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span>                                   
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> root_def pow_mult_list<span class="main">)</span>

<span class="keyword1" id="CoWBasic-root_pow_root"><span class="command">lemma</span></span> root_pow_root<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">u</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">∈</span> <span class="free">u</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rootI root_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-root_len"><span class="command">lemma</span></span> root_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="bound">k</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> pow_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-root_len_dvd"><span class="command">lemma</span></span> root_len_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_len root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="CoWBasic-common_root_len_gcd"><span class="command">lemma</span></span> common_root_len_gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span> gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_len_dvd<span class="main">)</span>

<span class="keyword1" id="CoWBasic-add_root"><span class="command">lemma</span></span> add_root<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> pow_Suc_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> root_def
    <span class="keyword1"><span class="command">using</span></span> root_pref_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> power_one_right<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="CoWBasic-add_roots"><span class="command">lemma</span></span> add_roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">w'</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w'</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> pow_add_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-concat_sing_list_pow"><span class="command">lemma</span></span> concat_sing_list_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> concat <span class="free">ws</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  list.size<span class="main">(</span>3<span class="main">)</span> nat.distinct<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
  <span class="keyword1"><span class="command">from</span></span> hd_Cons_tl<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> hd <span class="skolem">ws</span> <span class="main">#</span> tl <span class="skolem">ws</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>tl <span class="skolem">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  pow_Suc_list hd_concat_tl<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ws</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> tl_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">ws</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u</span><span class="main">}</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>tl <span class="skolem">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">k</span>›</span></span><span class="main">]</span>
          Nitpick.size_list_simp<span class="main">(</span>2<span class="main">)</span> lists_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ws</span> <span class="main">∈</span> lists<span class="main">{</span><span class="free">u</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-concat_sing_list_pow'"><span class="command">lemma</span></span> concat_sing_list_pow'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> lists<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">⟹</span> concat <span class="free">ws</span> <span class="main">=</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">ws</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_sing_list_pow<span class="main">)</span> 

<span class="keyword1" id="CoWBasic-root_pref_cancel'"><span class="command">lemma</span></span> root_pref_cancel'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> root_def<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> root_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> root_pref_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rootI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-root_rev_iff"><span class="command">lemma</span></span> root_rev_iff<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="main">∈</span> rev <span class="free">t</span><span class="main">*</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> root_def<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Commutation</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The solution of the easiest nontrivial word equation, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is in fact already contained in List.thy as the fact <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> comm_append_are_replicate<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> comm<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>  <span class="main">⟷</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">t</span> <span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span>  comm_append_are_replicate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">,</span> <span class="operator">folded</span> pow_is_concat_replicate<span class="main">]</span> pow_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  
<span class="keyword1"><span class="command">corollary</span></span> comm_root<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>   <span class="main">⟷</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">t</span><span class="main">*</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">t</span><span class="main">*</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="CoWBasic-commD"><span class="command">lemma</span></span> commD<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comm_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-commE"><span class="command">lemma</span></span> commE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span>  <span class="free">t</span> <span class="free">m</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> comm<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-comm_rootE"><span class="command">lemma</span></span> comm_rootE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span>  <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span>  <span class="free">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> comm_root<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Periods›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Periodicity is probably the most studied property of words. It captures the fact that a word overlaps with itself.
Another possible point of view is that the periodic word is a prefix of an (infinite) power of some nonempty 
word, which can be called its period word. Both these points of view are expressed by the following definition.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Periodic root"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">period_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≤p</span> _<span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 60 <span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">period_root</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoWBasic-per_rootI"><span class="command">lemma</span></span> per_rootI<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>               

<span class="keyword1" id="CoWBasic-per_rootI'"><span class="command">lemma</span></span> per_rootI'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_rootI<span class="main">[</span><span class="operator">OF</span>  pref_prod_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pref_pow_ext'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span><span class="main">≠</span><span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-per_rootD"><span class="command">lemma</span></span> per_rootD<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-per_rootD'"><span class="command">lemma</span></span> per_rootD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Empty word is not a periodic root but it has all nonempty periodic roots.›</span></span>

<span class="keyword1" id="CoWBasic-emp_any_per"><span class="command">lemma</span></span> emp_any_per<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">ε</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-emp_not_per"><span class="command">lemma</span></span> emp_not_per<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">≤p</span> <span class="keyword1">ε</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any nonempty word is its own periodic root.›</span></span>

<span class="keyword1" id="CoWBasic-root_self"><span class="command">lemma</span></span> root_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹"Short roots are prefixes"›</span></span>

<span class="keyword1" id="CoWBasic-root_is_take"><span class="command">lemma</span></span> root_is_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span>  <span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> period_root_def <span class="keyword1"><span class="command">using</span></span> pref_prod_long<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Periodic words are prefixes of the power of the root, which motivates the notation›</span></span>

<span class="keyword1" id="CoWBasic-pref_pow_ext_take"><span class="command">lemma</span></span> pref_pow_ext_take<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="hidden">❙</span><b>|</b></span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main"><span class="hidden">❙</span><b>|</b></span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="hidden">❙</span><b>|</b></span></span><span class="free"><span class="free">r</span></span><span class="main"><span class="main"><span class="hidden">❙</span><b>|</b></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> pref_prod_long<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pref_pow_ext'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span> pref_pow_ext'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-pref_pow_take"><span class="command">lemma</span></span> pref_pow_take<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"take <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> pref_pow_ext_take <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
                                                                           
<span class="keyword1" id="CoWBasic-per_exp"><span class="command">lemma</span></span> per_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  per_exp_pref<span class="main">[</span><span class="operator">OF</span> per_rootD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-per_root_spref_powE"><span class="command">lemma</span></span> per_root_spref_powE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_prod_short'<span class="main">[</span><span class="operator">OF</span> per_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span> long_power'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> per_rootD'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-period_rootE"><span class="command">lemma</span></span> period_rootE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&lt;p</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> per_root_spref_powE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pref_mod_power<span class="main">[</span><span class="operator">OF</span> this that<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-per_add_exp"><span class="command">lemma</span></span> per_add_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_exp_pref<span class="main">[</span><span class="operator">OF</span> per_rootD<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span>  per_rootD'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">,</span> <span class="operator">folded</span> nonzero_pow_emp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> period_root_def<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="CoWBasic-per_pref_ex"><span class="command">lemma</span></span> per_pref_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pcomp_shorter<span class="main">[</span><span class="operator">OF</span> ruler_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> per_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> long_pow_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> per_rootD'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> per_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_pref_ex period_root_def pref_pow_ext' pref_prod_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-pref_pow_conv"><span class="command">lemma</span></span> pref_pow_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="bound">k</span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_cancel'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">x</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> pow_Suc2_list<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pref_emp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> emp_pow<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> emp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pref_ext_nemp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> pow_Suc2_list<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pref_mod_power<span class="main">[</span><span class="operator">OF</span> pref_ext_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> pow_Suc2_list<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-per_eq"><span class="command">lemma</span></span> per_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span><span class="main">⋅</span><span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">z</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_pref<span class="main">[</span><span class="operator">unfolded</span> pref_pow_conv<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The previous theorem allows to prove some basic relations between powers, periods and commutation›</span></span>

<span class="keyword1" id="CoWBasic-per_drop_exp"><span class="command">lemma</span></span> per_drop_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>  <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> per_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span><span class="main">]</span> pow_mult_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> per_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> nemp_pow'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-per_drop_exp'"><span class="command">lemma</span></span> per_drop_exp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">≤p</span> <span class="free">e</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⟹</span>  <span class="free">p</span> <span class="keyword1">≤p</span>  <span class="free">e</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> period_root_def eq_pow_exp per_drop_exp pow_zero<span class="main">)</span> 

<span class="keyword1" id="CoWBasic-per_drop_exp_rev"><span class="command">lemma</span></span> per_drop_exp_rev<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤s</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">e</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">≤s</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_drop_exp'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">≤s</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">e</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> suffix_to_prefix rev_append rev_pow<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> rev_append suffix_to_prefix<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">corollary</span></span> comm_drop_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main">⋅</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pop_pow_one <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pop_pow_one<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">⋅</span><span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">r</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pref_ext<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="main">⋅</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">u</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main">⋅</span><span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">r</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> per_drop_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> per_drop_exp' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> comm_ruler<span class="main">[</span><span class="operator">OF</span> self_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> pow_comm_comm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">j</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">j</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> zero_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span>  nonzero_pow_emp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comm_drop_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">OF</span>
        comm_drop_exp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">j</span>"</span></span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">j</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">j</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>            

<span class="keyword1"><span class="command">corollary</span></span> comm_pow_roots<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comm_drop_exp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">,</span> <span class="operator">THEN</span> comm_drop_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        comm_add_exps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-pow_comm_comm'"><span class="command">lemma</span></span> pow_comm_comm'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comm pow_comm_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-comm_trans"><span class="command">lemma</span></span> comm_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span>  <span class="free">v</span><span class="main">⋅</span><span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span><span class="main">⋅</span><span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>u_emp<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="main">|</span> <span class="main">(</span>w_emp<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="main">|</span> <span class="main">(</span>nemp'<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> nemp'
      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> power_mult comm_common_power<span class="main">[</span><span class="operator">OF</span> uv<span class="main">]</span> comm_common_power<span class="main">[</span><span class="operator">OF</span> vw<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> pow_mult_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> mult.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nemp nemp' <span class="keyword1"><span class="command">unfolding</span></span> length_0_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> not0_implies_Suc<span class="main">[</span><span class="operator">OF</span> no_zero_divisors<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> pow_comm_comm'<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> k l<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> per_all_exps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span><span class="main">;</span> <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> per_drop_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">THEN</span> per_add_exp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> per_drop_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">THEN</span> per_add_exp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-drop_per_pref"><span class="command">lemma</span></span> drop_per_pref<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_drop<span class="main">[</span><span class="operator">OF</span> per_rootD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> drop_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-per_root_trans"><span class="command">lemma</span></span> per_root_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> per_drop_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span> <span class="keyword1"><span class="keyword1">≤p</span></span> <span class="free"><span class="free">u</span></span><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">u</span></span> <span class="keyword1"><span class="keyword1">≤p</span></span> <span class="free"><span class="free">t</span></span><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">w</span></span> <span class="keyword1"><span class="keyword1">≤p</span></span> <span class="free"><span class="free">t</span></span><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
does not hold.
›</span></span>

<span class="keyword1" id="CoWBasic-per_root_same_prefix"><span class="command">lemma</span></span> per_root_same_prefix<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="free">w'</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span>  <span class="free">w</span> <span class="main">⨝</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-take_after_drop"><span class="command">lemma</span></span> take_after_drop<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> take <span class="free">q</span> <span class="main">(</span>drop <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> take <span class="free">q</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pref_share_take<span class="main">[</span><span class="operator">OF</span> drop_per_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="main">]</span></span> len_after_drop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following lemmas are a weak version of the Periodicity lemma›</span></span>

<span class="keyword1" id="CoWBasic-two_pers'"><span class="command">lemma</span></span> two_pers'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pref_prolong<span class="main">[</span><span class="operator">OF</span> pu pv<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lassoc<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> vu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pref_prolong<span class="main">[</span><span class="operator">OF</span> pv pu<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lassoc<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len pref_prod_long<span class="main">[</span><span class="operator">OF</span> uv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len pref_prod_long<span class="main">[</span><span class="operator">OF</span> vu<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pref_comp_eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> prefix_comparable_def<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ruler swap_len<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-two_pers"><span class="command">lemma</span></span> two_pers<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">v</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">+</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span><span class="main">⋅</span><span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> two_pers'<span class="main">[</span><span class="operator">OF</span> per_rootD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> per_rootD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Period - numeric"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of a period as the length of the periodic root is often offered as the basic one. From our point of view, 
it is secondary, and less convenient for reasoning.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">periodN</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">periodN</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">≤p</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>

<span class="keyword1" id="CoWBasic-periodN_I"><span class="command">lemma</span></span> periodN_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> periodN <span class="free">w</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The numeric definition respects the following convention about empty words and empty periods.›</span></span>

<span class="keyword1" id="CoWBasic-emp_no_periodN"><span class="command">lemma</span></span> emp_no_periodN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="keyword1">ε</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-zero_not_per"><span class="command">lemma</span></span> zero_not_per<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="free">w</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* lemma periodN_I [intro]: assumes "u ≤p r<span class="hidden">⇧</span><sup>@</sup>k" and  "u ≠ ε" shows  "periodN u <span class="hidden">❙</span><b>|</b>r<span class="hidden">❙</span><b>|</b>" *)</span>
  <span class="comment1">(* unfolding periodN_def period_root_def *)</span>
  <span class="comment1">(* using  pref_pow_take[OF ‹u ≤p r<span class="hidden">⇧</span><sup>@</sup>k›] take_nemp_len[OF ‹u ≠ ε›] ‹u ≤p r<span class="hidden">⇧</span><sup>@</sup>k› by force *)</span>

<span class="comment1">(* lemma periodNI' [intro]: "u ≤np r<span class="hidden">⇧</span><sup>@</sup>k ⟹ periodN u <span class="hidden">❙</span><b>|</b>r<span class="hidden">❙</span><b>|</b>" *)</span>
  <span class="comment1">(* unfolding nonempty_prefix_def by blast *)</span>

<span class="keyword1" id="CoWBasic-periodN_D1"><span class="command">lemma</span></span> periodN_D1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟹</span>  <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-periodN_D2"><span class="command">lemma</span></span> periodN_D2<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟹</span>  <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-periodN_D3"><span class="command">lemma</span></span> periodN_D3<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟹</span>  <span class="free">w</span> <span class="keyword1">≤p</span> take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A nonempty word has all "long" periods›</span></span>

<span class="keyword1" id="CoWBasic-all_long_pers"><span class="command">lemma</span></span> all_long_pers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟧</span> <span class="main">⟹</span> periodN <span class="free">w</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> per_nemp <span class="main">=</span> periodN_D1

<span class="keyword1"><span class="command">lemmas</span></span> per_positive <span class="main">=</span> periodN_D2

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The standard numeric definition of a period uses indeces.›</span></span>

<span class="keyword1" id="CoWBasic-periodN_indeces"><span class="command">lemma</span></span> periodN_indeces<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_append_length_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> take_len<span class="main">[</span><span class="operator">OF</span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_lessD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_index<span class="main">[</span><span class="operator">OF</span> periodN_D3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-indeces_periodN"><span class="command">lemma</span></span> indeces_periodN<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  forall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="free">w</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pref_index<span class="main">[</span><span class="operator">OF</span> take_is_prefix <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pref_index<span class="main">[</span><span class="operator">OF</span> triv_pref <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> leI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  leI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> forall <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> nth_append_length_plus<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">-</span><span class="free">n</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> index_pref<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In some cases, the numeric definition is more useful than the definition using the period root.›</span></span>

<span class="keyword1" id="CoWBasic-periodN_rev"><span class="command">lemma</span></span> periodN_rev<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>rev <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> indeces_periodN<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"rev <span class="free"><span class="free">w</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ periodN_D2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> periodN_def period_root_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> length_rev<span class="main">]</span> add_lessD1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="free">p</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>   
  <span class="keyword1"><span class="command">from</span></span> periodN_indeces<span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span> rev_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>  <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">folded</span> e<span class="main">]</span> rev_nth<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> rev <span class="free">w</span> <span class="main">!</span><span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-periodN_rev_conv"><span class="command">lemma</span></span> periodN_rev_conv <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>rev <span class="free">w</span><span class="main">)</span> <span class="free">n</span> <span class="main">⟷</span> periodN <span class="free">w</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> periodN_rev periodN_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rev_rev_ident <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>

<span class="keyword1" id="CoWBasic-periodN_fac"><span class="command">lemma</span></span> periodN_fac<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> indeces_periodN<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> periodN_D2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span> <span class="free">p</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span>  <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> periodN_indeces<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span> <span class="free">p</span>›</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span><span class="main">!</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>   
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="free">p</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> nth_append_length_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">⋅</span><span class="free">v</span>"</span></span> <span class="main">,</span> <span class="operator">unfolded</span> lassoc<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> add_lessD1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>
      nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-periodN_fac'"><span class="command">lemma</span></span> periodN_fac'<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">v</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> periodN <span class="free">u</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> facE<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> periodN_fac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nemp_emp_power<span class="main">)</span>


<span class="keyword1" id="CoWBasic-pow_per"><span class="command">lemma</span></span> pow_per<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> periodN_I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> nemp_emp_power<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> nemp_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> pref_pow_ext_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  



<span class="keyword1" id="CoWBasic-per_fac"><span class="command">lemma</span></span> per_fac<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">v</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nemp_pow suf_nemp<span class="main">[</span><span class="operator">OF</span> pref_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pow_per<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> this<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">w</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> periodN_fac<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">v</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The numeric definition is equivalent to being prefix of a power.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> periodN_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">r</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">≤np</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>short<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="main">|</span>  <span class="main">(</span>long<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> le_add_diff_inverse<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span> <span class="main">⋅</span> <span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> length_append <span class="keyword1"><span class="command">using</span></span> exE<span class="main">[</span><span class="operator">OF</span> Ex_list_of_length<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>     
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
        <span class="keyword1"><span class="command">using</span></span>  pow_one_id npI'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> periodN_def per_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
          <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> take_len<span class="main">[</span><span class="operator">OF</span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤np</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  pref_pow_take<span class="main">[</span><span class="operator">OF</span> npD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤np</span> <span class="skolem">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> length_0_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤np</span> <span class="skolem">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two more characterizations of a period›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> per_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span> <span class="main">⟷</span> drop <span class="free">n</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> drop_per_pref<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> periodN_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  append_take_drop_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_eq_conv_conj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conjI<span class="main">[</span><span class="operator">OF</span> pref_cancel'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹drop <span class="free">n</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span><span class="main"><span class="main">]</span></span> take_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span>  append_take_drop_id period_root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-rotate_per_root"><span class="command">lemma</span></span> rotate_per_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> rotate <span class="free">n</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> all_long_pers<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">OF</span> rotate_drop_take<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> rotate <span class="free">n</span> <span class="free">w</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> per_shift<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">unfolded</span> mod_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> not<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> not_le<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span><span class="keyword1"><span class="command">..</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Various lemmas on periods›</span></span>

<span class="keyword1" id="CoWBasic-periodN_drop"><span class="command">lemma</span></span> periodN_drop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>drop <span class="free">p</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> periodN_fac<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">p</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> append_take_drop_id drop_eq_Nil not_le append_Nil2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1" id="CoWBasic-ext_per_left"><span class="command">lemma</span></span> ext_per_left<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> take <span class="free">p</span> <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> pref_cancel'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span>"</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> f periodN_def period_root_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-ext_per_left_power"><span class="command">lemma</span></span> ext_per_left_power<span class="main">:</span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> periodN <span class="main">(</span><span class="main">(</span>take <span class="free">p</span> <span class="free">w</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> ext_per_left<span class="main">[</span><span class="operator">OF</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pref_share_take<span class="main">[</span><span class="operator">OF</span> per_exp_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> periodN_D3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> 
      lassoc pow_Suc_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-take_several_pers"><span class="command">lemma</span></span> take_several_pers<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="free">w</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> take <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">(</span>take <span class="free">n</span> <span class="free">w</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">m</span><span class="main">*</span><span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pow_len nat_prod_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> take_len<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">n</span> <span class="free">w</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> periodN_def<span class="main">,</span> <span class="operator">THEN</span>  per_exp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> 
      ruler_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> triv_pref<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>                                   
    <span class="keyword1"><span class="command">using</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">n</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-per_mult"><span class="command">lemma</span></span> per_mult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> periodN_D1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_long_pers<span class="main">[</span><span class="operator">of</span>  <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  per_add_exp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def take_several_pers<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-root_periodN"><span class="command">lemma</span></span> root_periodN<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="keyword1"><span class="command">using</span></span>  per_pref_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span> 
  pref_pow_take<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main">]</span> take_nemp_len<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span>  per_rootD'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1"><span class="command">theorem</span></span>  two_periodsN<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">q</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">q</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> two_pers<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> periodN_def<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">q</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> periodN_def<span class="main"><span class="main">]</span></span><span class="main">,</span>
        <span class="operator">unfolded</span> take_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_leD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> take_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_leD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
        <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> comm_root<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">q</span> <span class="free">w</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> periodN_def per_root_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  root_periodN<span class="main">[</span><span class="operator">OF</span>  per_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd_nat.boundedI<span class="main">[</span><span class="operator">OF</span> root_len_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹take <span class="free">p</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span> root_len_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹take <span class="free">q</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_len<span class="main">[</span><span class="operator">OF</span> add_leD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> take_len<span class="main">[</span><span class="operator">OF</span> add_leD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span>  per_mult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="free">q</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dvd_div_mult_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      dvd_div_mult_self<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>›</span></span><span class="main">]</span>
      gcd_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> mult_zero_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> periodN_D2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-index_mod_per_root"><span class="command">lemma</span></span> index_mod_per_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">.</span> <span class="free">w</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">r</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">r</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i mod_if nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span><span class="main">]</span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> period_root_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-index_pref_pow_mod"><span class="command">lemma</span></span> index_pref_pow_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span>  <span class="free">w</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">r</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  index_pow_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> less_le_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> prefix_length_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span><span class="main">]</span> pref_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1" id="CoWBasic-index_per_root_mod"><span class="command">lemma</span></span> index_per_root_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span>  <span class="free">w</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">r</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_pref_pow_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> per_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-root_divisor"><span class="command">lemma</span></span> root_divisor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">w</span><span class="main">)</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">div</span> <span class="free">k</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> 
    take_several_pers<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">k</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">div</span> <span class="free">k</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dvd_div_mult_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span> take_self<span class="main">,</span> <span class="operator">OF</span> <span class="main">,</span> <span class="operator">OF</span> order_refl<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1" id="CoWBasic-per_pref'"><span class="command">lemma</span></span> per_pref'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">v</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">u</span> <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  pref_share_take<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">v</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">u</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> take <span class="free">k</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹periodN <span class="free">v</span> <span class="free">k</span>›</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="quoted"><span class="quoted">‹take <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">u</span>›</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pref_trans<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> take <span class="free">k</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">v</span>›</span></span> pref_prod_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">k</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> periodN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> all_long_pers nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Period: overview"</span></span>
<span class="keyword1"><span class="command">notepad</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="keyword1">ε</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">ε</span> <span class="keyword1">≤p</span> <span class="keyword1">ε</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="keyword1">≤p</span> <span class="skolem">r</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="skolem">w</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="keyword1">ε</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="keyword1">ε</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Singleton and its power›</span></span>

<span class="keyword1" id="CoWBasic-concat_len_one"><span class="command">lemma</span></span> concat_len_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> hd <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> concat_sing<span class="main">[</span><span class="operator">OF</span> sing_word<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>   

<span class="keyword1" id="CoWBasic-sing_pow_hd_tl"><span class="command">lemma</span></span> sing_pow_hd_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">#</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">#</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  hd_word<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span> add_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">#</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">c</span> <span class="main">#</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">c</span> <span class="main">#</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> eqd_equal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> hd_word<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> pop_pow_one<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-pref_sing_power"><span class="command">lemma</span></span> pref_sing_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pop_pow<span class="main">[</span><span class="operator">OF</span> prefix_length_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> sing_pow_len<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span>  conjunct1<span class="main">[</span><span class="operator">OF</span> eqd_equal<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> 
          <span class="operator">unfolded</span> lq_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> sing_pow_len<span class="main"><span class="main">,</span></span> 
          <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>›</span></span> refl<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_pow_palindrom"><span class="command">lemma</span></span> sing_pow_palindrom<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rev_sing<span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pref_sing_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">unfolded</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> root_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> self_pref<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-suf_sing_power"><span class="command">lemma</span></span> suf_sing_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤s</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sing_pow_palindrom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rev_rev_ident<span class="main">]</span>
    pref_sing_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤s</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> suffix_to_prefix rev_pow rev_rev_ident rev_sing<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-sing_fac_pow"><span class="command">lemma</span></span> sing_fac_pow<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≤f</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> root_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≤s</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fac_pref_suf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="free">v</span> <span class="keyword1">≤f</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≤s</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> pref_sing_power<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">from</span></span> suf_sing_power<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_pow_fac'"><span class="command">lemma</span></span> sing_pow_fac'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="keyword1">≤f</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sing_fac_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sing_pow_hd_tl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1" id="CoWBasic-all_set_sing_pow"><span class="command">lemma</span></span> all_set_sing_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">w</span> <span class="main">⟶</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?All</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?All</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sing_pow_hd_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?All</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sing_pow_hd_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_pow_set"><span class="command">lemma</span></span> sing_pow_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> set <span class="free">u</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_set_sing_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> hd_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> is_singletonI'<span class="main">[</span><span class="operator">unfolded</span> is_singleton_the_elem<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="free">u</span>"</span></span><span class="main">]</span>
     singleton_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span>set <span class="free">u</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-takeWhile_sing_root"><span class="command">lemma</span></span> takeWhile_sing_root<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_set_sing_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> set_takeWhileD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-takeWhile_sing_pow"><span class="command">lemma</span></span> takeWhile_sing_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-dropWhile_sing_pow"><span class="command">lemma</span></span> dropWhile_sing_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-distinct_letter_in"><span class="command">lemma</span></span> distinct_letter_in<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="free">b</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">q</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dropWhile_sing_pow <span class="keyword1"><span class="command">using</span></span> assms rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">[</span>hd <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">]</span> <span class="main">⋅</span> tl <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> root<span class="main">:</span><span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_sing_root<span class="main">)</span>   
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"hd <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hd_dropWhile<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dropWhile <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> _  this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq root <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-distinct_letter_in_hd"><span class="command">lemma</span></span> distinct_letter_in_hd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">w</span> <span class="main">∈</span>  <span class="main">[</span>hd <span class="free">w</span><span class="main">]</span><span class="main">*</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="free">b</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[</span>hd <span class="free">w</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">q</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> hd <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>hd <span class="free">w</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> hd <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_letter_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>   
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> power_eq_if<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>hd <span class="free">w</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> list.sel<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">from</span></span> that a1 a2 this 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-distinct_letter_in_suf"><span class="command">lemma</span></span> distinct_letter_in_suf<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">w</span> <span class="main">∈</span>  <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span> <span class="bound">b</span><span class="main">.</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">m</span>  <span class="keyword1">≤s</span> <span class="free">w</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> rev <span class="free">w</span> <span class="main">∈</span>  <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span>  rev_sing <span class="keyword1"><span class="command">using</span></span> assms root_def rev_rev_ident<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">=</span> rev <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_letter_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> rev <span class="free">w</span> <span class="main">∈</span>  <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>›</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_pow<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="keyword1">≤s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">=</span> rev <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> suf_rev_pref_iff eq lassoc 
    <span class="keyword1"><span class="command">using</span></span> prefI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_pow_exp"><span class="command">lemma</span></span> sing_pow_exp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rootE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span>  sing_pow_len<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> this<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> this<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-sing_power'"><span class="command">lemma</span></span> sing_power'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  sing_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">folded</span> sing_pow_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1" id="CoWBasic-rev_sing_power"><span class="command">lemma</span></span> rev_sing_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span> <span class="main">⟹</span> rev <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_def <span class="keyword1"><span class="command">using</span></span> rev_pow rev_singleton_conv  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-lcp_letter_power"><span class="command">lemma</span></span> lcp_letter_power<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span>                     
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> nemp_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">]</span>   
    <span class="keyword1"><span class="command">unfolding</span></span> root_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span>›</span></span> pow_comm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hd_append2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">⋅</span><span class="skolem">z'</span>"</span></span><span class="main">,</span> 
        <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> hd_sing_power<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> lcp_distinct_hd<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq1 eq2 lcp_ext_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">z'</span><span class="main">⋅</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-per_one"><span class="command">lemma</span></span> per_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> pref_sing_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> rootI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> per_pref_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="CoWBasic-per_one'"><span class="command">lemma</span></span> per_one'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 not_Cons_self2 per_pref prefI root_def<span class="main">)</span>

<span class="keyword1" id="CoWBasic-per_sing_one"><span class="command">lemma</span></span> per_sing_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_periodN<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sing_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Border"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A non-empty word  $x \neq w$ is a \emph{border} of a word $w$ if it is both its prefix and suffix. This elementary property captures how much the word $w$ overlaps
with itself, and it is in the obvious way related to a period of $w$. However, in many cases it is much easier to reason about borders than about periods.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">border</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≤b</span> _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 60 <span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">border</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤p</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤s</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bordered</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bordered</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">≤b</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoWBasic-borderI"><span class="command">lemma</span></span> borderI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤s</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-borderD_pref"><span class="command">lemma</span></span> borderD_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-borderD_spref"><span class="command">lemma</span></span> borderD_spref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&lt;p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="CoWBasic-borderD_suf"><span class="command">lemma</span></span> borderD_suf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤s</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-borderD_ssuf"><span class="command">lemma</span></span> borderD_ssuf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&lt;s</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-borderD_nemp"><span class="command">lemma</span></span> borderD_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-borderD_neq"><span class="command">lemma</span></span> borderD_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-border_lq_nemp"><span class="command">lemma</span></span> border_lq_nemp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms borderD_spref lq_spref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-border_rq_nemp"><span class="command">lemma</span></span> border_rq_nemp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms borderD_ssuf rq_ssuf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-border_trans"><span class="command">lemma</span></span> border_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≤b</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> border_def 
  <span class="keyword1"><span class="command">using</span></span> suffix_order.order.antisym pref_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> suf_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="CoWBasic-border_rev_conv"><span class="command">lemma</span></span> border_rev_conv<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">x</span> <span class="keyword1">≤b</span> rev <span class="free">w</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def
  <span class="keyword1"><span class="command">using</span></span> rev_is_Nil_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> rev_swap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> rev_swap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    suf_rev_pref_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> pref_rev_suf_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-border_lq_comp"><span class="command">lemma</span></span> border_lq_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span> <span class="main">⨝</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">using</span></span> rq_suf ruler <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> border_lq_suf_comp <span class="main">=</span> border_lq_comp<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The shortest border"</span></span>

<span class="keyword1" id="CoWBasic-border_len"><span class="command">lemma</span></span> border_len<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prefix_length_less <span class="keyword1"><span class="command">unfolding</span></span> border_def strict_prefix_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> border_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-borders_compare"><span class="command">lemma</span></span> borders_compare<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="keyword1">≤b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ruler_le<span class="main">[</span><span class="operator">OF</span> borderD_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x'</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span> borderD_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span> less_imp_le_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    suf_ruler_le<span class="main">[</span><span class="operator">OF</span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x'</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span> less_imp_le_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    borderD_nemp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x'</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
    borderI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-unbordered_border"><span class="command">lemma</span></span> unbordered_border<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bordered <span class="free">w</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">∧</span> <span class="main">¬</span> bordered <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">≤b</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bordered_def less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bordered <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bordered <span class="skolem">x'</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="keyword1">≤b</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bordered <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> less.hyps<span class="main">[</span><span class="operator">OF</span> border_len<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="keyword1">≤b</span> <span class="skolem">w</span>›</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span>  border_trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="keyword1">≤b</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-unbordered_border_shortest"><span class="command">lemma</span></span> unbordered_border_shortest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">¬</span> bordered <span class="free">x</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bordered_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> borders_compare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> not_le_imp_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-long_border_bordered"><span class="command">lemma</span></span> long_border_bordered<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> long<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> border<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">⋅</span><span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main">⋅</span><span class="skolem">s</span>"</span></span>   
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> rq_suf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p_def long<span class="main">[</span><span class="operator">folded</span> rq_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> border<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">x</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> eqd_pref<span class="main">[</span><span class="operator">OF</span> eq less_imp_le<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> px <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> border_rq_nemp<span class="main">[</span><span class="operator">OF</span> border<span class="main">]</span> p_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> px <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span><span class="main">)</span> <span class="keyword1">≤b</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> border_def 
    <span class="keyword1"><span class="command">using</span></span> eqd_pref<span class="main">[</span><span class="operator">OF</span> eq less_imp_le<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">x</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> p_def<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> long_border_bordered<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>

<span class="keyword1" id="CoWBasic-border_short_dec"><span class="command">lemma</span></span> border_short_dec<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> border<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">⋅</span><span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">OF</span> borderD_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> border<span class="main"><span class="main">]</span></span><span class="main">]</span> rq_suf<span class="main">[</span><span class="operator">OF</span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> border<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> short<span class="main">[</span><span class="operator">folded</span> rq_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> border<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span>  lq_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">OF</span> borderD_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> border<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eqd_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq this<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-bordered_dec"><span class="command">lemma</span></span> bordered_dec<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bordered <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bordered <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unbordered_border<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> long_border_bordered<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> bordered <span class="skolem">u</span>›</span></span> bordered_def leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> border_short_dec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span> this<span class="main">,</span> <span class="operator">THEN</span> that<span class="main">,</span> <span class="operator">OF</span> borderD_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">≤b</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Relation to period and conjugation"</span></span>

<span class="keyword1" id="CoWBasic-border_conjug_eq"><span class="command">lemma</span></span> border_conjug_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lq_rq_reassoc_suf<span class="main">[</span><span class="operator">OF</span> borderD_pref borderD_suf<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-border_per_root"><span class="command">lemma</span></span> border_per_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> border_conjug_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-per_root_border"><span class="command">lemma</span></span> per_root_border<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_imp_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> pref_prod_long<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_lq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lq_triv<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="keyword1">≤s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="keyword1">≤p</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-border_per"><span class="command">lemma</span></span> border_per<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">x</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> rq_suf<span class="main">[</span><span class="operator">OF</span> borderD_suf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">OF</span> borderD_pref<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> take<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> borderD_suf<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> take  lassoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">=</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span>  triv_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="keyword1"><span class="command">using</span></span> nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-per_border"><span class="command">lemma</span></span> per_border<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">w</span>  <span class="keyword1">≤b</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> per_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> periodN_D1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span> per_positive<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_drop<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> take_eq_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  periodN_D2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> take_all_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">using</span></span> take_is_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">-</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> suffix_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">folded</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Primitive words›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a word $w$ is not a non-trivial power of some other word, we say it is primitive.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">primitive</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟶</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoWBasic-primI"><span class="command">lemma</span></span> primI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> primitive <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primitive_def<span class="main">)</span>

<span class="keyword1" id="CoWBasic-prim_nemp"><span class="command">lemma</span></span> prim_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="keyword1">ε</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">0</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primitive_def zero_neq_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_exp_one"><span class="command">lemma</span></span> prim_exp_one<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primitive_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-prim_exp_eq"><span class="command">lemma</span></span> prim_exp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_exp_one power_one_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-prim_triv_root"><span class="command">lemma</span></span> prim_triv_root<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">t</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_exp_eq <span class="keyword1"><span class="command">unfolding</span></span> root_def 
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_def root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-prim_comm_exp"><span class="command">lemma</span></span> prim_comm_exp<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span><span class="main">⋅</span><span class="free">u</span> <span class="main">=</span> <span class="free">u</span><span class="main">⋅</span><span class="free">v</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> comm<span class="main">]</span> prim_exp_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">v</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-pow_non_prim"><span class="command">lemma</span></span> pow_non_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">¬</span> primitive <span class="main">(</span><span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_exp_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-comm_non_prim"><span class="command">lemma</span></span> comm_non_prim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span><span class="main">⋅</span><span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive <span class="main">(</span><span class="free">u</span><span class="main">⋅</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span><span class="main">⋅</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span><span class="main">⋅</span><span class="free">u</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> comm<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pow_non_prim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span>›</span></span> pow_add_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> nemp_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> nemp_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_rotate_conv"><span class="command">lemma</span></span> prim_rotate_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">w</span> <span class="main">⟷</span> primitive <span class="main">(</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">w</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> primI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> rotate <span class="free">n</span> <span class="free">w</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rotate <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rotate_back<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> rotate <span class="free">n</span> <span class="free">w</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> rotate_pow_comm<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> prim_exp_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">w</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span>"</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">w</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> primI<span class="main">)</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
     <span class="keyword1"><span class="command">from</span></span> prim_exp_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="main">(</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> rotate_pow_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> this<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-non_prim"><span class="command">lemma</span></span> non_prim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> primitive <span class="free">w</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> primitive_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>›</span></span> emp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>›</span></span> pow_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>›</span></span><span class="main">[</span><span class="operator">folded</span> eq_pow_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="skolem">r</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> less_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_no_rotate"><span class="command">lemma</span></span> prim_no_rotate<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> drop <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> take <span class="free">n</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rotate_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">w</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> take_len<span class="main">[</span><span class="operator">OF</span> less_imp_le_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> append_take_drop_id <span class="quoted"><span class="quoted">‹rotate <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹primitive <span class="free">w</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> comm_non_prim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹take <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹drop <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> drop <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">w</span> <span class="main">⋅</span> take <span class="free">n</span> <span class="free">w</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_take_drop_id<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-no_rotate_prim"><span class="command">lemma</span></span> no_rotate_prim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟹</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> non_prim<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rotate <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rotate_root_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
     <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> prim_iff_rotate<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> 
   <span class="quoted"><span class="quoted">"primitive <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">⟶</span> rotate <span class="bound">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_rotate_prim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> prim_no_rotate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-prim_sing"><span class="command">lemma</span></span> prim_sing<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> prim_iff_rotate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CoWBasic-prim_rev_iff"><span class="command">lemma</span></span> prim_rev_iff<span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span>rev <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> primitive <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_def<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> primitive_def<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Primitive root›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given a non-empty word $w$ which is not primitive, it is natural to look for the shortest $u$ such that $w = u^k$.
Such a word is primitive, and it is the primitive root of $w$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive_rootP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> _ <span class="keyword1">*</span>"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">primitive_rootP</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">*</span> <span class="main">∧</span> primitive <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="CoWBasic-prim_rootD"><span class="command">lemma</span></span> prim_rootD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>

<span class="keyword1" id="CoWBasic-prim_rootI"><span class="command">lemma</span></span> prim_rootI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span>  <span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span> <span class="main">⟹</span> primitive <span class="free">r</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>

<span class="keyword1" id="CoWBasic-prim_root_rev_conv"><span class="command">lemma</span></span> prim_root_rev_conv <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> rev <span class="free">r</span><span class="main">*</span> <span class="main">⟷</span>  <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> primitive_rootP_def<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">primitive_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ρ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">primitive_root</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span><span class="main">)</span>"</span></span>  

<span class="keyword1" id="CoWBasic-primrootE"><span class="command">lemma</span></span> primrootE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def root_def <span class="keyword1"><span class="command">using</span></span> nemp_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-primroot_of_root"><span class="command">lemma</span></span> primroot_of_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">u</span><span class="main">*</span><span class="main">;</span> <span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def <span class="keyword1"><span class="command">using</span></span> root_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="CoWBasic-comm_prim"><span class="command">lemma</span></span> comm_prim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"primitive <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋅</span><span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋅</span><span class="free">r</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> comm<span class="main">]</span> assms<span class="main">[</span><span class="operator">unfolded</span> primitive_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-primroot_ex"><span class="command">lemma</span></span> primroot_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span>  <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span>  <span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"primitive <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> non_prim<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pr</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">pr</span><span class="main">*</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">pr</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> less.hyps rootI root_shorter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">pr</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> less.prems primroot_of_root rootI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span>  <span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">pr</span><span class="main">*</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> primitive_rootP_def root_def<span class="main">]</span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">pr</span> <span class="main">*</span>›</span></span> nemp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹primitive <span class="skolem">x</span>›</span></span> less.prems prim_rootI self_root<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">k</span><span class="main">.</span>  <span class="skolem">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-primroot_exE"><span class="command">lemma</span></span> primroot_exE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms primitive_rootP_def primroot_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Uniqueness of the primitive root follows from the following lemma›</span></span>

<span class="keyword1" id="CoWBasic-primroot_unique"><span class="command">lemma</span></span> primroot_unique<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kr</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">kr</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primrootE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">s</span><span class="main">*</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">s</span><span class="main">*</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">ks</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> primrootE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">s</span><span class="main">*</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comm_rootE<span class="main">[</span><span class="operator">OF</span> pow_comm_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="skolem">kr</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">ks</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">kr</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">kr</span> <span class="main">=</span> <span class="free">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">ks</span> <span class="main">=</span> <span class="free">u</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"primitive <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span> <span class="main">*</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">s</span> <span class="main">*</span>›</span></span> primitive_rootP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> prim_exp_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">r</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> prim_exp_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="skolem">s</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rootE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="free">r</span>"</span></span><span class="main">]</span> rootE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> the_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">r</span><span class="main">.</span> <span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">r</span><span class="main">*</span>"</span></span><span class="main">,</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">r</span><span class="main">*</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_self_root"><span class="command">lemma</span></span> prim_self_root<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">x</span> <span class="main">⟹</span> <span class="keyword1">ρ</span> <span class="free">x</span>  <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_nemp prim_rootI primroot_unique self_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Existence and uniqueness of the primitive root justifies the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ρ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: it indeed yields the primitive root of a nonempty word.›</span></span>

<span class="keyword1" id="CoWBasic-primroot_is_primroot"><span class="command">lemma</span></span> primroot_is_primroot<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> primroot_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CoWBasic-primroot_is_root"><span class="command">lemma</span></span> primroot_is_root<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_is_primroot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="CoWBasic-primrootI"><span class="command">lemma</span></span> primrootI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> primroot_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> primroot_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms prim_nemp primitive_rootP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-primroot_root"><span class="command">lemma</span></span> primroot_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">q</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_unique<span class="main">[</span><span class="operator">OF</span> primroot_of_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span> primroot_is_primroot<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> root_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-primroot_len_mult"><span class="command">lemma</span></span> primroot_len_mult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">k</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_is_primroot<span class="main">[</span><span class="operator">OF</span> root_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> primroot_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span>
      primitive_rootP_def<span class="main">]</span> root_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>          

<span class="keyword1" id="CoWBasic-primroot_shorter_root"><span class="command">lemma</span></span> primroot_shorter_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> quotient_smaller<span class="main">[</span><span class="operator">OF</span> root_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> length_0_conv<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> 
    primroot_len_mult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">q</span><span class="main">*</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-primroot_shortest_root"><span class="command">lemma</span></span> primroot_shortest_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">*</span><span class="main">)</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  Least_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">*</span><span class="main">)</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">u</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms primitive_rootP_def primroot_is_primroot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">u</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">*</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms primroot_shorter_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-primroot_shorter_eq"><span class="command">lemma</span></span> primroot_shorter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_shorter_root self_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="CoWBasic-primroot_take"><span class="command">lemma</span></span> primroot_take<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primrootE<span class="main">[</span><span class="operator">OF</span> primroot_is_primroot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_root<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">u</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-primroot_take_shortest"><span class="command">lemma</span></span> primroot_take_shortest<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">u</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">*</span><span class="main">)</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_take<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> primroot_shortest_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="CoWBasic-primroot_rotate_comm"><span class="command">lemma</span></span> primroot_rotate_comm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="main">(</span>rotate <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> rotate <span class="free">n</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">w</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow_zero primrootE primroot_is_primroot <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">(</span>rotate <span class="free">n</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rotate_pow_comm root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span>rotate <span class="free">n</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prim_rotate_conv primitive_rootP_def primroot_is_primroot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rotate <span class="free">n</span> <span class="free">w</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>rotate <span class="free">n</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> primroot_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-primrootI1"><span class="command">lemma</span></span> primrootI1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prim<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow prim prim_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow rootI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primroot_unique<span class="main">[</span><span class="operator">OF</span> prim_rootI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">r</span><span class="main">*</span>›</span></span> <span class="quoted"><span class="quoted">‹primitive <span class="free">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_root_power"><span class="command">lemma</span></span> prim_root_power <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_rootD<span class="main">[</span><span class="operator">OF</span> primroot_is_primroot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> root_def<span class="main">]</span> assms pow_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">x</span>"</span></span><span class="main">]</span> not0_implies_Suc
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-prim_root_cases"><span class="command">lemma</span></span> prim_root_cases<span class="main">:</span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> primroot_is_primroot<span class="main">[</span><span class="operator">THEN</span> prim_rootD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  
        primroot_prim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> root_shorter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We also have the standard characterization of commutation for nonempty words.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> comm_primroots<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟷</span> <span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comm_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primroot_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> primroot_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primroot_is_primroot<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">v</span>›</span></span><span class="main">]</span> primroot_is_primroot<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> primitive_rootP_def
    comm_root  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-prim_comm_short_emp"><span class="command">lemma</span></span> prim_comm_short_emp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">p</span><span class="main">=</span><span class="free">p</span><span class="main">⋅</span><span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">u</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comm_primroots<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> prim_nemp<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">p</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prim_self_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">p</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">p</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">p</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">[</span><span class="operator">folded</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> primroot_shorter_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Conjugation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two words $x$ and $y$ are conjugated if one is a rotation of the other.
Or, equivalently, there exists $z$ such that
\[
xz = zy.
\]
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conjugate</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">∼</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⋅</span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1" id="CoWBasic-conjug_rev_conv"><span class="command">lemma</span></span> conjug_rev_conv <span class="main">[</span><span class="operator">reversal_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">u</span> <span class="main">∼</span> rev <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_def<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> conjugate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-conjug_rotate_iff"><span class="command">lemma</span></span> conjug_rotate_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> rotate <span class="bound">n</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_def
  <span class="keyword1"><span class="command">using</span></span> rotate_drop_take<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> takedrop<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> rotate_append
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-conjugI"><span class="command">lemma</span></span> conjugI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>

<span class="keyword1" id="CoWBasic-conjugI'"><span class="command">lemma</span></span> conjugI' <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">∼</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="CoWBasic-conjugE"><span class="command">lemma</span></span> conjugE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> conjugate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>

<span class="keyword1" id="CoWBasic-conjugE1"><span class="command">lemma</span></span> conjugE1 <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> v<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> rassoc<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-conjug_refl"><span class="command">lemma</span></span> conjug_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-conjug_sym"><span class="command">lemma</span></span> conjug_sym <span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∼</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjugE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjugI<span class="main">)</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-conjug_nemp_iff"><span class="command">lemma</span></span> conjug_nemp_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjugE1<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> iffI<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="CoWBasic-conjug_len"><span class="command">lemma</span></span> conjug_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>  <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjugE<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> swap_len<span class="main">)</span>

<span class="keyword1" id="CoWBasic-pow_conjug"><span class="command">lemma</span></span> pow_conjug<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq<span class="main">[</span><span class="operator">unfolded</span> lassoc<span class="main">]</span> lassoc append_same_eq pow_comm<span class="keyword1"><span class="command">..</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>  <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conjug_pow<span class="main">[</span><span class="operator">OF</span> rassoc<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> t<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">i</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> same_append_eq<span class="keyword1"><span class="command">.</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The solution of the equation 
\[
xz = zy
\]
is given by the next lemma.
›</span></span>

<span class="keyword1" id="CoWBasic-conjug_eqE"><span class="command">lemma</span></span> conjug_eqE <span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤p</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤p</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&lt;p</span> <span class="free">x</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">&lt;p</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> z <span class="keyword1"><span class="command">unfolding</span></span> x eq<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lassoc pow_commutes_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> z<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rassoc same_append_eq<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> x y z <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> conjugation<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="bound">u</span>  <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span> <span class="main">⋅</span> <span class="bound">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span> <span class="main">⋅</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-conjug_eq_prim_rootE"><span class="command">lemma</span></span> conjug_eq_prim_rootE <span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">s</span> <span class="free">i</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span>Suc <span class="free">i</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">n</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤p</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> per_drop_exp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">&lt;p</span> <span class="keyword1">ρ</span> <span class="free">x</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">&lt;p</span> <span class="keyword1">ρ</span> <span class="free">x</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">z</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rassoc x z<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pow_comm<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">⋅</span><span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">n</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">s</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rassoc <span class="keyword1"><span class="command">unfolding</span></span> shift_pow<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">⋅</span><span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> z<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rassoc cancel<span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="free">x</span>›</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> that x y z <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-conjug_eq_prim_root"><span class="command">lemma</span></span> conjug_eq_prim_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">i</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span> <span class="main">⋅</span> <span class="bound">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">n</span> <span class="main">⋅</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">z</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> primitive <span class="main">(</span><span class="bound">r</span> <span class="main">⋅</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conjug_eq_prim_rootE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-conjugI1"><span class="command">lemma</span></span> conjugI1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> conjug_refl<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> conjug_eqE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjugI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-conjug_trans"><span class="command">lemma</span></span> conjug_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∼</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">unfolding</span></span> conjug_rotate_iff <span class="keyword1"><span class="command">using</span></span> rotate_rotate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-conjug_trans'"><span class="command">lemma</span></span> conjug_trans'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> uv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vw'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> uv'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rassoc<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vw'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rassoc<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rassoc<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-nconjug_neq"><span class="command">lemma</span></span> nconjug_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-prim_conjug"><span class="command">lemma</span></span> prim_conjug<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prim<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> conjug<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prim_nemp<span class="main">[</span><span class="operator">OF</span> prim<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> conjug_nemp_iff<span class="main">[</span><span class="operator">OF</span> conjug<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> conjug<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⋅</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prim'<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">unfolding</span></span> prim_exp_one<span class="main">[</span><span class="operator">OF</span> prim u<span class="main">]</span> pow_one_id<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prim' <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">v</span>›</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-root_conjug"><span class="command">lemma</span></span> root_conjug<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="main">(</span><span class="free">r</span><span class="main">⋅</span><span class="free">u</span><span class="main">)</span> <span class="main">∼</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conjugI1 conjug_sym lq_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="CoWBasic-conjug_prim_root"><span class="command">lemma</span></span> conjug_prim_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conjug<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> conjug <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prim<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prim prim_conjug u v <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conjugI' <span class="keyword1"><span class="command">unfolding</span></span> rs sr<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-conjug_add_exp"><span class="command">lemma</span></span> conjug_add_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟹</span>  <span class="free">u</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">∼</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjugE1<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjugI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjug_pow<span class="main">)</span>

<span class="keyword1" id="CoWBasic-conjug_prim_root_iff"><span class="command">lemma</span></span> conjug_prim_root_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nemp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span>  <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ρ</span> <span class="free">u</span>  <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conjug_prim_root<span class="main">[</span><span class="operator">OF</span> _ nemp<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> conjug<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">u</span>  <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nemp_len<span class="main">[</span><span class="operator">OF</span> nemp<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> len length_0_conv<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> nemp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ρ</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> prim_root_power<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">(</span><span class="keyword1">ρ</span> <span class="free">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">k</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">(</span><span class="keyword1">ρ</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">l</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">unfolding</span></span> roots<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> primroot_nemp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pow_len conjug_len<span class="main">[</span><span class="operator">OF</span> conjug<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∼</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conjug_add_exp<span class="main">[</span><span class="operator">OF</span> conjug<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> roots<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">k</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">l</span></span>›</span></span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-fac_pow_pref_conjug"><span class="command">lemma</span></span> fac_pow_pref_conjug<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∼</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="free">t'</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> facE'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">i</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_mod_power<span class="main">[</span><span class="operator">OF</span> sprefI1'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq pref_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="keyword1">&lt;p</span> <span class="free">t</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">i</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> lassoc p<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pow_conjug<span class="main">[</span><span class="operator">OF</span> eq' t<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rassoc<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> conjugI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t<span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CoWBasic-fac_pow_len_conjug"><span class="command">lemma</span></span> fac_pow_len_conjug<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">v</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∼</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∼</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fac_pow_pref_conjug assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_equal<span class="main">[</span><span class="operator">OF</span> pref_prod_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> conjug_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∼</span> <span class="skolem">t</span>›</span></span><span class="main"><span class="main">,</span></span><span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∼</span> <span class="skolem">t</span>›</span></span><span class="main">[</span><span class="operator">folded</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∼</span> <span class="free">u</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CoWBasic-border_conjug"><span class="command">lemma</span></span> border_conjug<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤b</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>&lt;</sup>¯</span><span class="free">x</span> <span class="main">∼</span>  <span class="free">x</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> border_conjug_eq conjugI1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> fac_pow_suf_conjug <span class="main">=</span> fac_pow_pref_conjug<span class="main">[</span><span class="operator">reversed</span><span class="main">]</span>
   
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Submonoids">
<div class="head">
<h1>Theory Submonoids</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/Submonoids.thy
    Author:     Štěpán Holub, Charles University
    Author:     Štěpán Starosta, CTU in Prague
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Submonoids
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoWBasic">CoWBasic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Submonoids of a free monoid›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This chapter deals with properties of submonoids of a free monoid, that is, with monoids of words.
See more in Chapter 1 of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> Lo83<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Hull›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, we define the hull of a set of words, that is, the monoid generated by them.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">hull</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">G</span> <span class="keyword2"><span class="keyword">where</span></span>
   emp_in<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="main"><span class="free">⟩</span></span>"</span></span> <span class="main">|</span>
   prod_cl<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="main"><span class="free">⟩</span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="main"><span class="free">⟩</span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> hull.intros

<span class="keyword1" id="Submonoids-hull_closed"><span class="command">lemma</span></span> hull_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w1</span> <span class="main">⋅</span> <span class="free">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hull.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">w1</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">⋅</span></span></span><span class="free"><span class="free"><span class="free">w2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">∈</span></span></span><span class="main"><span class="main"><span class="main">⟨</span></span></span><span class="free"><span class="free"><span class="free">G</span></span></span><span class="main"><span class="main"><span class="main">⟩</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="Submonoids-gen_in"><span class="command">lemma</span></span> gen_in <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hull.prod_cl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Submonoids-hull_induct"><span class="command">lemma</span></span> hull_induct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w</span>"</span></span> 
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="main">⟹</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">w1</span> <span class="main">⋅</span> <span class="bound">w2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hull.induct<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">P</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>  
        assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_in<span class="main">)</span>
  
<span class="keyword1" id="Submonoids-genset_sub"><span class="command">lemma</span></span> genset_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> gen_in <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Submonoids-in_lists_conv_set_subset"><span class="command">lemma</span></span> in_lists_conv_set_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ws</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟷</span> <span class="free">ws</span> <span class="main">∈</span> lists <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-concat_in_hull"><span class="command">lemma</span></span> concat_in_hull <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ws</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"concat <span class="free">ws</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-concat_in_hull'"><span class="command">lemma</span></span> concat_in_hull' <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> lists <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"concat <span class="free">ws</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-hull_concat_lists0"><span class="command">lemma</span></span> hull_concat_lists0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ws</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main">.</span> concat <span class="bound">ws</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> hull.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span><span class="main">∈</span>lists <span class="free">G</span><span class="main">.</span> concat <span class="bound">ws</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> concat.simps<span class="main">(</span>1<span class="main">)</span> lists.Nil<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> exI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> concat <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> concat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ws</span><span class="main">∈</span>lists <span class="free">G</span><span class="main">.</span> concat <span class="bound">ws</span> <span class="main">=</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ws</span><span class="main">∈</span>lists <span class="free">G</span><span class="main">.</span> concat <span class="bound">ws</span> <span class="main">=</span> <span class="bound">w1</span> <span class="main">⋅</span> <span class="bound">w2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_in_lists_iff concat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-hull_concat_lists"><span class="command">lemma</span></span> hull_concat_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> concat <span class="main">`</span> lists <span class="free">G</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> image_iff  <span class="keyword1"><span class="command">using</span></span> hull_concat_lists0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-concat_tl"><span class="command">lemma</span></span> concat_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">G</span> <span class="main">⟹</span> concat <span class="free">xs</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull_concat_lists<span class="main">)</span>

<span class="keyword1" id="Submonoids-nemp_concat_hull"><span class="command">lemma</span></span> nemp_concat_hull<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="Submonoids-hull_mon"><span class="command">lemma</span></span> hull_mon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> image_def hull_concat_lists <span class="keyword1"><span class="command">using</span></span> sub_lists_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-emp_gen_set"><span class="command">lemma</span></span> emp_gen_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">{}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">ε</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Submonoids-hull_drop_one"><span class="command">lemma</span></span> hull_drop_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span><span class="main">⟩</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span>  hull_concat_lists <span class="keyword1"><span class="command">using</span></span> del_emp_concat lists_drop_emp' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  hull_concat_lists image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Submonoids-sing_gen_power"><span class="command">lemma</span></span> sing_gen_power<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="bound">k</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists  <span class="keyword1"><span class="command">using</span></span> one_generated_list_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Submonoids-sing_gen"><span class="command">lemma</span></span> sing_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="free">z</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">z</span><span class="main">*</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rootI sing_gen_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               
<span class="keyword1" id="Submonoids-lists_gen_to_hull"><span class="command">lemma</span></span> lists_gen_to_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lists_mono genset_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Submonoids-rev_hull0"><span class="command">lemma</span></span> rev_hull0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span>rev <span class="main">`</span> <span class="free">G</span><span class="main">⟩</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> rev <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span>rev <span class="main">`</span> <span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_iff hull_concat_lists <span class="keyword1"><span class="command">using</span></span> rev_concat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-rev_hull1"><span class="command">lemma</span></span> rev_hull1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span>  <span class="main">⟨</span>rev <span class="main">`</span> <span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span>  <span class="main">⟨</span>rev <span class="main">`</span> <span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> concat <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span>rev <span class="main">`</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">using</span></span> rev_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rev <span class="main">`</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_in_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-rev_hull"><span class="command">lemma</span></span> rev_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"rev<span class="main">`</span><span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span>rev<span class="main">`</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_hull0 rev_hull1 set_eq_subset subsetI<span class="main">)</span>

<span class="keyword1" id="Submonoids-power_in"><span class="command">lemma</span></span> power_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>  <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull_closed<span class="main">)</span>

<span class="keyword1" id="Submonoids-hull_closed_lists"><span class="command">lemma</span></span> hull_closed_lists<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">us</span><span class="main">.</span> concat <span class="bound">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">us</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">⋅</span> concat <span class="bound">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull_closed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-self_gen"><span class="command">lemma</span></span> self_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_subsetI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="quoted">concat</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> hull_concat_lists<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span>
        <span class="operator">THEN</span> subset_antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ genset_sub<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> hull_closed_lists<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Intersection of hulls is a hull.›</span></span>

<span class="keyword1" id="Submonoids-hulls_inter"><span class="command">lemma</span></span> hulls_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="skolem">G</span><span class="main">⟩</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Inter_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">G</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span><span class="main">]</span> mem_Collect_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">G</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span>"</span></span><span class="main">]</span> 
        hull_mon<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">G</span><span class="main">⟩</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> self_gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="main">⋂</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">G</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">G</span><span class="main">.</span> <span class="bound">G</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_sub<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Factorization into generators"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We define a decomposition (or a factorization) of a into elements of a given generating set. Such a decomposition is well defined only 
if the decomposed word is an element of the hull. Even int that case, however, the decomposition need not be unique.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">decompose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set  <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Dec</span> _ _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 64<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">∈</span> lists <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">us</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Submonoids-dec_ex"><span class="command">lemma</span></span> dec_ex<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">us</span><span class="main">.</span> <span class="main">(</span><span class="bound">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">us</span> <span class="main">=</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> image_def  hull_concat_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> mem_Collect_eq 
  <span class="keyword1"><span class="command">using</span></span> del_emp_concat lists_drop_emp' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1" id="Submonoids-decI'"><span class="command">lemma</span></span> decI'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> decompose.simps <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> dec_ex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-decI"><span class="command">lemma</span></span> decI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> concat <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> decompose.simps <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> dec_ex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-dec_emp"><span class="command">lemma</span></span> dec_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="keyword1">ε</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>                             
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="keyword1">ε</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="skolem">us</span> <span class="main">=</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">us</span>
    <span class="keyword1"><span class="command">using</span></span> emp_concat_emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> decompose.simps
    <span class="keyword1"><span class="command">using</span></span> all<span class="main">[</span><span class="operator">OF</span> someI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ex<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-dec_nemp"><span class="command">lemma</span></span> dec_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span>  <span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  

<span class="keyword1" id="Submonoids-dec_nemp'"><span class="command">lemma</span></span> dec_nemp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dec_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-dec_dom'"><span class="command">lemma</span></span> dec_dom'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span> <span class="main">∈</span> lists <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Submonoids-dec_hd"><span class="command">lemma</span></span> dec_hd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dec_nemp'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> dec_dom'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> lists_hd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-non_gen_dec"><span class="command">lemma</span></span> non_gen_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∉</span> <span class="free">G</span> <span class="main">⟹</span> <span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>  <span class="main">≠</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decI'  Cons_in_lists_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement into a specific decomposition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We extend the decomposition to lists of words. This can be seen as a refinement of a previous decomposition of some word.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">refine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Ref</span> _ _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">refine</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">=</span> concat<span class="main">(</span>map <span class="main">(</span>decompose <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Submonoids-ref_morph"><span class="command">lemma</span></span> ref_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">vs</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> refine <span class="free">G</span> <span class="main">(</span><span class="free">us</span> <span class="main">⋅</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> refine <span class="free">G</span> <span class="free">us</span> <span class="main">⋅</span> refine <span class="free">G</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refine.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Submonoids-ref_morph_plus"><span class="command">lemma</span></span> ref_morph_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> <span class="free">vs</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> refine <span class="free">G</span> <span class="main">(</span><span class="free">us</span> <span class="main">⋅</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> refine <span class="free">G</span> <span class="free">us</span> <span class="main">⋅</span> refine <span class="free">G</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refine.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>     

<span class="keyword1" id="Submonoids-ref_pop_hd"><span class="command">lemma</span></span> ref_pop_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> refine <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> decompose <span class="free">G</span> <span class="main">(</span>hd <span class="free">us</span><span class="main">)</span> <span class="main">⋅</span> refine <span class="free">G</span> <span class="main">(</span>tl <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  refine.simps  <span class="keyword1"><span class="command">using</span></span> list.simps<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"decompose <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword1" id="Submonoids-ref_in"><span class="command">lemma</span></span> ref_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span><span class="main">)</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">us</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems decI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Submonoids-ref"><span class="command">lemma</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> concat <span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> concat <span class="free">us</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems decI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-ref_gen"><span class="command">lemma</span></span> ref_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span>decompose <span class="free">G</span> <span class="main">`</span> <span class="free">B</span><span class="main">⟩</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Submonoids-emp_ref"><span class="command">lemma</span></span> emp_ref<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emp_concat_emp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span><span class="main">]</span>
     ref<span class="main">[</span><span class="operator">OF</span> lists_drop_emp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> <span class="keyword1">ε</span>›</span></span> concat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Submonoids-sing_ref_sing"><span class="command">lemma</span></span> sing_ref_sing<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"refine <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹refine <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list.collapse<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> Cons_in_lists_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="main">(</span>hd <span class="free">us</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> dec_nemp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹hd <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> lists_drop_emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>       
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"refine <span class="free">G</span> <span class="main">(</span>tl <span class="free">us</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ref_pop_hd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">unfolding</span></span>  <span class="quoted"><span class="quoted">‹refine <span class="free">G</span> <span class="free">us</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>›</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">Dec</span> <span class="free">G</span> <span class="main">(</span>hd <span class="free">us</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> Cons_eq_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="main">(</span>hd <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="main">(</span>tl <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      Cons_eq_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="main">(</span>hd <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="main">(</span>tl <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>  append_is_Nil_conv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="main">(</span>tl <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span>  emp_ref<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹tl <span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> this<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">=</span> tl <span class="free">us</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> Nil_tl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="free">us</span> <span class="main">=</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-ref_ex"><span class="command">lemma</span></span> ref_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="keyword1">Ref</span> <span class="free">G</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> concat <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  ref_in<span class="main">[</span><span class="operator">OF</span> sub_lists_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> ref<span class="main">[</span><span class="operator">OF</span> sub_lists_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Basis"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An important property of monoids of words is that they have a unique minimal generating set. Which is the set consisting of indecomposable elements.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The simple element is defined as a word which has only trivial decomposition into generators: a singleton.›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">simple_element</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set  <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">" _ <span class="keyword1">∈B</span> _ "</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_element</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">∈</span> lists <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">us</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟶</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"termination"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Submonoids-simp_el_el"><span class="command">lemma</span></span> simp_el_el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-simp_elD"><span class="command">lemma</span></span> simp_elD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-simp_el_sing"><span class="command">lemma</span></span> simp_el_sing<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simp_elD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="quoted"><span class="quoted">‹concat <span class="free">us</span> <span class="main">=</span> <span class="free">b</span>›</span></span> concat_len_one sing_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  

<span class="keyword1" id="Submonoids-nonsimp"><span class="command">lemma</span></span> nonsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">⟹</span> concat <span class="free">us</span> <span class="keyword1">∈B</span> <span class="free">G</span> <span class="main">⟹</span>  <span class="free">us</span> <span class="main">=</span> <span class="main">[</span>concat <span class="free">us</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simp_el_sing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">us</span></span><span class="main">]</span>   <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-emp_nonsimp"><span class="command">lemma</span></span> emp_nonsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">ε</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps <span class="keyword1"><span class="command">using</span></span> list.size<span class="main">(</span>3<span class="main">)</span> concat.simps<span class="main">(</span>1<span class="main">)</span> lists.Nil<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Submonoids-basis_no_fact"><span class="command">lemma</span></span> basis_no_fact<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span>"</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="keyword1">∈B</span> <span class="free">G</span>›</span></span> nonsimp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> eq1 append_in_lists_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> decI'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> decI'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> append_in_lists_conv<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> butlast_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">unfolding</span></span> eq2 butlast.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">⋅</span><span class="free">v</span>"</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span>   Nil_is_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span>
      concat.simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-simp_elI"><span class="command">lemma</span></span> simp_elI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="bound">v</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">us</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> concat.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> lists_hd  gen_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">us</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> nemp_concat_hull<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"tl <span class="skolem"><span class="skolem">us</span></span>"</span></span></span><span class="main">,</span> <span class="operator">OF</span> this tl_lists<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">us</span></span> <span class="main"><span class="main">∈</span></span> lists <span class="free"><span class="free">G</span></span><span class="main"><span class="main"><span class="hidden">⇩</span><sub>+</sub></span></span>›</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> all <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span>  concat.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">us</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> list.collapse<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">b</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">b</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> long_list_tl nonsing_concat_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-simp_el_indecomp"><span class="command">lemma</span></span> simp_el_indecomp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="bound">v</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms basis_no_fact emp_nonsimp simple_element.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We are ready to define the \emph{basis} as the set of all simple elements.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set  <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔅</span> _"</span> <span class="main">[</span>51<span class="main">]</span> <span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  basisdef<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">basis</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈B</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Submonoids-basisI"><span class="command">lemma</span></span> basisI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈B</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Submonoids-basisD"><span class="command">lemma</span></span> basisD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Submonoids-emp_not_basis"><span class="command">lemma</span></span> emp_not_basis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basisD emp_nonsimp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Submonoids-basis_sub"><span class="command">lemma</span></span> basis_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  basisdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Submonoids-basis_drop_emp"><span class="command">lemma</span></span> basis_drop_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emp_not_basis <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-simp_el_hull'"><span class="command">lemma</span></span> simp_el_hull'<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">us</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟶</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lists_gen_to_hull <span class="keyword1"><span class="command">unfolding</span></span> simple_element.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms simp_elD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">bs</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  dec_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lists_drop_emp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span><span class="main">]</span> 
          lists_gen_to_hull<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> nonsimp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> 
          <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">bs</span> <span class="main">=</span> <span class="free">b</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="keyword1">∈B</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-simp_el_hull"><span class="command">lemma</span></span> simp_el_hull<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈B</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simp_elI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> self_gen 
  <span class="keyword1"><span class="command">using</span></span> assms gen_in simp_el_indecomp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free">b</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">∈B</span></span></span> <span class="free"><span class="free"><span class="free">G</span></span></span>›</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-concat_tl_basis"><span class="command">lemma</span></span> concat_tl_basis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⟹</span> concat <span class="free">xs</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The basis generates the hull›</span></span> 

<span class="keyword1" id="Submonoids-set_concat_len"><span class="command">lemma</span></span> set_concat_len<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list_long<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> set <span class="free">us</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="main">(</span><span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> in_lists_conv_set  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_append <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>concat <span class="main">(</span><span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="Submonoids-non_simp_dec"><span class="command">lemma</span></span> non_simp_dec<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span> nonsing_concat_len  basisI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">,</span> <span class="operator">unfolded</span> simple_element.simps<span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-basis_gen"><span class="command">lemma</span></span> basis_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> non_simp_dec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">G</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">us</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
      <span class="keyword1"><span class="command">using</span></span>  lists_drop_emp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span><span class="main">]</span> 
       set_concat_len<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> less<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
       <span class="keyword1"><span class="command">unfolding</span></span> in_lists_conv_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">from</span></span> subsetI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span>  concat_in_hull<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> self_gen <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> basis_gen_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hull.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="bound">w1</span> <span class="main">⋅</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="free">G</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hull_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span><span class="main">]</span> basis_gen<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-basis_gen_hull'"><span class="command">lemma</span></span> basis_gen_hull'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">𝔅</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basis_gen_hull self_gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> basis_of_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">𝔅</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>  <span class="main">⊆</span>  <span class="keyword1">𝔅</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basisD basisI simp_el_hull <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>  <span class="main">⊆</span>  <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basisD basisI simp_el_hull' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The basis is the smallest generating set.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basis_of_hull basis_sub<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An arbitrary set between basis and the hull is generating...›</span></span>
<span class="keyword1" id="Submonoids-gen_sets"><span class="command">lemma</span></span> gen_sets<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  image_mono<span class="main">[</span><span class="operator">OF</span> lists_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">concat</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span> image_mono<span class="main">[</span><span class="operator">OF</span> lists_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">concat</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym<span class="main">[</span><span class="operator">OF</span> hull_concat_lists<span class="main">]</span>  basis_gen_hull     
  <span class="keyword1"><span class="command">using</span></span>  subset_antisym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="main">]</span> self_gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹... and has the same basis›</span></span>
<span class="keyword1" id="Submonoids-basis_sets"><span class="command">lemma</span></span> basis_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">=</span> <span class="keyword1">𝔅</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basis_of_hull  gen_sets<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any nonempty composed element has a decomposition into basis elements with many useful properties›</span></span>

<span class="keyword1" id="Submonoids-non_simp_fac"><span class="command">lemma</span></span> non_simp_fac<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"hd <span class="free">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"concat<span class="main">(</span>tl <span class="free">us</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>tl <span class="free">us</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> hd <span class="free">us</span> <span class="main">⋅</span> concat<span class="main">(</span>tl <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> dec_dom'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span><span class="main">]</span> decI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> basis_gen_hull
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> concat.simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lists_hd<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> emp_not_basis<span class="main">]</span>
    lists_hd<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> gen_in<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> basis_gen_hull<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span> lists_hd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> 
      concat_len_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="main">]</span>  nonsing_concat_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> nemp_concat_hull<span class="main">[</span><span class="operator">OF</span> long_list_tl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> this<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">𝔅</span></span> <span class="free"><span class="free">G</span></span>"</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> basis_drop_emp basis_gen_hull<span class="main">,</span> <span class="operator">OF</span> tl_lists<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">us</span></span> <span class="main"><span class="main">∈</span></span> lists <span class="keyword1"><span class="keyword1">𝔅</span></span> <span class="free"><span class="free">G</span></span>›</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> hd <span class="skolem">us</span> <span class="main">⋅</span> concat<span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="free">w</span>›</span></span> concat.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="skolem">us</span>"</span></span><span class="main">]</span> list.collapse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="keyword1">𝔅</span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-basis_dec"><span class="command">lemma</span></span> basis_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">∈</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_no_fact<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="Submonoids-non_simp_fac'"><span class="command">lemma</span></span> non_simp_fac'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∉</span> <span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">∈</span> lists <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> concat <span class="bound">us</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basisI concat_len_one decI' dec_dom' decI dec_nemp lists_hd nemp_elem_setI simple_element.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Submonoids-emp_gen_iff"><span class="command">lemma</span></span> emp_gen_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">ε</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">ε</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  hull_drop_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span> emp_gen_set<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">ε</span><span class="main">}</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span><span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-emp_basis_iff"><span class="command">lemma</span></span> emp_basis_iff<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">G</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emp_gen_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">G</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> basis_gen_hull basis_drop_emp<span class="main">,</span> <span class="operator">folded</span> emp_gen_iff<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>  

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Code"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A basis freely generating its hull is called a \emph{code}. By definition, 
this means that generated elements have unique factorizations into the elements of the code.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> code <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒞</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 𝒞_is_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">𝒞</span> <span class="main">⟹</span> concat <span class="free">xs</span> <span class="main">=</span> concat <span class="free">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Submonoids-emp_not_in_code"><span class="command">lemma</span></span> emp_not_in_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∉</span> <span class="free">𝒞</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="keyword1">ε</span><span class="main">]</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">[]</span> <span class="main">=</span> concat <span class="main">[</span><span class="keyword1">ε</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">≠</span> <span class="main">[</span><span class="keyword1">ε</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>  
    <span class="keyword1"><span class="command">using</span></span> 𝒞_is_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-code_simple"><span class="command">lemma</span></span> code_simple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">∈B</span> <span class="free">𝒞</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span>   simple_element.simps 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">𝒞</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="bound">us</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">⟶</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="bound">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">us</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span>"</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="free">𝒞</span>›</span></span> 𝒞_is_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">∈</span> lists <span class="free">𝒞</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span>›</span></span><span class="main">]</span> emp_not_in_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span><span class="main"><span class="hidden">⇩</span><sub>+</sub></span> <span class="main">∧</span> concat <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">⟶</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">us</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sing_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-code_is_basis"><span class="command">lemma</span></span> code_is_basis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔅</span> <span class="free">𝒞</span> <span class="main">=</span> <span class="free">𝒞</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_simple basisdef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝒞</span></span><span class="main">]</span> basis_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-code_unique_dec"><span class="command">lemma</span></span> code_unique_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span> <span class="main">⟹</span> <span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="main">(</span>concat <span class="free">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dec_dom'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span>"</span></span> <span class="quoted"><span class="free">𝒞</span></span><span class="main">,</span> <span class="operator">THEN</span> 𝒞_is_code<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">us</span></span><span class="main">]</span> 
    decI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span>"</span></span> <span class="quoted"><span class="free">𝒞</span></span><span class="main">]</span> hull_concat_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝒞</span></span><span class="main">]</span> image_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span>"</span></span> <span class="quoted">concat</span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="quoted">"lists <span class="free">𝒞</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1" id="Submonoids-code_unique_ref"><span class="command">lemma</span></span> code_unique_ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span> <span class="main">⟹</span> refine <span class="free">𝒞</span> <span class="free">us</span> <span class="main">=</span> decompose <span class="free">𝒞</span> <span class="main">(</span>concat <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>refine <span class="free">𝒞</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> concat <span class="free">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>refine <span class="free">𝒞</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>decompose <span class="free">𝒞</span> <span class="main">(</span>concat <span class="free">us</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  decI<span class="main">[</span><span class="operator">OF</span> hull_closed_lists<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="main">(</span>concat <span class="free">us</span><span class="main">)</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span> dec_dom' hull_closed_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Ref</span> <span class="free">𝒞</span> <span class="free">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lists_drop_emp<span class="main">[</span><span class="operator">OF</span> ref_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">us</span> <span class="main">∈</span> lists <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒞_is_code<span class="main">[</span><span class="operator">OF</span> ref dec eq<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-code_dec_morph"><span class="command">lemma</span></span> code_dec_morph<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="main">(</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="main">(</span>concat <span class="main">(</span><span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_dom'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main">]</span> dec_dom'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main">]</span>
      code.code_unique_dec<span class="main">[</span><span class="operator">OF</span> code_axioms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_in_lists_conv<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>     
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span><span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main">]</span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="main">(</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-code_el_dec"><span class="command">lemma</span></span> code_el_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">𝒞</span> <span class="main">⟹</span> decompose <span class="free">𝒞</span> <span class="free">c</span> <span class="main">=</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_unique_dec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">c</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-code_ref_list"><span class="command">lemma</span></span> code_ref_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="free">𝒞</span> <span class="main">⟹</span> refine <span class="free">𝒞</span> <span class="free">us</span> <span class="main">=</span> <span class="free">us</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> code_el_dec
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Submonoids-code_ref_gen"><span class="command">lemma</span></span> code_ref_gen<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span>decompose <span class="free">𝒞</span> <span class="main">`</span> <span class="free">G</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"refine <span class="free">𝒞</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Dec</span> <span class="free">𝒞</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  dec_dom'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‹<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span> code_unique_ref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> decI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ref_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">G</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">,</span> <span class="operator">OF</span> dec_dom'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">𝒞</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">𝒞</span><span class="main">⟩</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹end context code›</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Binary code›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We pay a special attention to two element codes. 
In particular, we show that two words form a code if and only if they do not commute. This means that two 
words either commute, or do not satisfy any nontrivial relation.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> binary_code <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> 

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Submonoids-bin_fst_nemp"><span class="command">lemma</span></span> bin_fst_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> non_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A crucial property of two element codes is the constant decoding delay given by the word $\alpha$, 
which is a prefix of any generating word (sufficiently long), while the letter 
immediately after this common prefix indicates the first element of the decomposition.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">α</span> <span class="keyword2"><span class="keyword">where</span></span> bin_lcp_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span>  <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword2"><span class="keyword">where</span></span> fst_mismatch_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span>  <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">!</span><span class="main"><span class="hidden">❙</span><b>|</b></span>α<span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> snd_mismatch_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span>  <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">!</span><span class="main"><span class="hidden">❙</span><b>|</b></span>α<span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>

<span class="keyword1" id="Submonoids-bin_mismatch_neq"><span class="command">lemma</span></span> bin_mismatch_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"c<span class="hidden">⇩</span><sub>0</sub> <span class="main">≠</span> c<span class="hidden">⇩</span><sub>1</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fst_mismatch_def snd_mismatch_def bin_lcp_def 
  <span class="keyword1"><span class="command">using</span></span> non_comm lcp_mismatch' pref_comp_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ swap_len<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Submonoids-bin_lcp_pref_fst_snd"><span class="command">lemma</span></span> bin_lcp_pref_fst_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"α <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bin_lcp_pref_snd_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"α <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bin_lcp_def <span class="keyword1"><span class="command">using</span></span> longest_common_prefix_prefix1 longest_common_prefix_prefix2<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Submonoids-bin_lcp_short"><span class="command">lemma</span></span> bin_lcp_short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>α<span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⋅</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comm_ruler non_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lcp_len'<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> bin_lcp_def<span class="main">,</span> <span class="operator">unfolded</span> length_append<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>α<span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-bin_lcp_fst_mismatch_pref"><span class="command">lemma</span></span> bin_lcp_fst_mismatch_pref<span class="main">:</span>  <span class="quoted"><span class="quoted">"α <span class="main">⋅</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> α"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"α <span class="main">⋅</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  append_one_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted">α</span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">,</span> <span class="operator">folded</span> fst_mismatch_def<span class="main">,</span> <span class="operator">OF</span> bin_lcp_pref_fst_snd<span class="main">,</span> <span class="operator">unfolded</span> length_append<span class="main">,</span> <span class="operator">OF</span> bin_lcp_short<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"α <span class="main">⋅</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_prolong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pref_prod_pref_short<span class="main">[</span><span class="operator">OF</span> this bin_lcp_pref_snd_fst<span class="main">,</span> <span class="operator">unfolded</span> length_append sing_len<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"α <span class="main">⋅</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> α"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  nemp_len<span class="main">[</span><span class="operator">OF</span> bin_fst_nemp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-not_fst_snd_pref"><span class="command">lemma</span></span> not_fst_snd_pref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤p</span> α"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> bin_lcp_short<span class="main">[</span><span class="operator">folded</span> length_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>  prefix_order.order.antisym<span class="main">[</span><span class="operator">OF</span> bin_lcp_pref_fst_snd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Submonoids-bin_lcp_fst_mismatch_pref'"><span class="command">lemma</span></span> bin_lcp_fst_mismatch_pref'<span class="main">:</span>  <span class="quoted"><span class="quoted">"α <span class="main">⋅</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_prefixI<span class="main">[</span><span class="operator">OF</span> bin_lcp_pref_fst_snd<span class="main">,</span> <span class="operator">THEN</span> add_nth_pref<span class="main">,</span> <span class="operator">folded</span> fst_mismatch_def<span class="main">]</span> not_fst_snd_pref
  self_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted">α</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">interpretation</span></span> symcode<span class="main">:</span> binary_code <span class="quoted"><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>  <span class="quoted"><span class="quoted">"symcode.c<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> c<span class="hidden">⇩</span><sub>1</sub>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"symcode.c<span class="hidden">⇩</span><sub>1</sub> <span class="main">=</span> c<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"symcode.α <span class="main">=</span> α"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"binary_code <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span>  binary_code_def <span class="keyword1"><span class="command">using</span></span> non_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"binary_code.α <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> α"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹binary_code <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> binary_code.bin_lcp_def lcp_sym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"binary_code.c<span class="hidden">⇩</span><sub>0</sub> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> c<span class="hidden">⇩</span><sub>1</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹binary_code <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹binary_code.α <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> α›</span></span> binary_code.fst_mismatch_def snd_mismatch_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"binary_code.c<span class="hidden">⇩</span><sub>1</sub> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> c<span class="hidden">⇩</span><sub>0</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹binary_code <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹binary_code.α <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> α›</span></span> binary_code.snd_mismatch_def fst_mismatch_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> bin_snd_nemp <span class="main">=</span> symcode.bin_fst_nemp <span class="keyword2"><span class="keyword">and</span></span>
       bin_snd_mismatch <span class="main">=</span> symcode.bin_lcp_fst_mismatch_pref

<span class="keyword1" id="Submonoids-bin_lcp_fst_lcp"><span class="command">lemma</span></span> bin_lcp_fst_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"α <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⋅</span> α"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bin_lcp_snd_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"α <span class="keyword1">≤p</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⋅</span> α"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bin_lcp_fst_mismatch_pref  bin_snd_mismatch <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-bin_all_nemp"><span class="command">lemma</span></span> bin_all_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">⟹</span> concat <span class="free">ws</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="free">ws</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bin_fst_nemp bin_snd_nemp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Submonoids-bin_lcp_all_lcp"><span class="command">lemma</span></span> bin_lcp_all_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">⟹</span> α <span class="keyword1">≤p</span> concat <span class="free">ws</span> <span class="main">⋅</span> α"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x_or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">⋅</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pref_prolong<span class="main">[</span><span class="operator">OF</span> snoc.hyps<span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">⋅</span>α"</span></span><span class="main">,</span> <span class="operator">unfolded</span> lassoc<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bin_lcp_fst_lcp bin_lcp_snd_lcp disjE<span class="main">[</span><span class="operator">OF</span> x_or<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-bin_code_alpha"><span class="command">lemma</span></span> bin_code_alpha<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">us</span>  <span class="main">≠</span> hd <span class="free">vs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">⋅</span> α <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> concat <span class="free">vs</span> <span class="main">⋅</span> α <span class="main">=</span> α"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bin_lcp_all_lcp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> lcp_pref_conv<span class="main">,</span> <span class="operator">unfolded</span> lcp_sym<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">α</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bin_lcp_all_lcp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> lcp_pref_conv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> i<span class="main">:</span> binary_code <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"4.prems"</span><span class="main">(</span>3<span class="main">)</span> non_comm binary_code.intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> alph<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"4.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> disjE<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> doubleton_eq_iff<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> αid<span class="main">:</span> <span class="quoted"><span class="quoted">"i.α <span class="main">=</span> α"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bin_lcp_def i.bin_lcp_def <span class="keyword1"><span class="command">using</span></span> lcp_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"i.α <span class="main">⋅</span> <span class="main">[</span>i.c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="skolem">x</span> <span class="main">⋅</span> concat <span class="skolem">xs</span> <span class="main">⋅</span> i.α"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  i.bin_lcp_all_lcp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> Cons_in_lists_iff alph<span class="main">]</span> 
      pref_prolong<span class="main">[</span><span class="operator">OF</span> i.bin_lcp_fst_mismatch_pref<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"i.α <span class="main">⋅</span> <span class="main">[</span>i.c<span class="hidden">⇩</span><sub>1</sub><span class="main">]</span> <span class="keyword1">≤p</span> <span class="skolem">y</span> <span class="main">⋅</span> concat <span class="skolem">ys</span> <span class="main">⋅</span> i.α"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  i.bin_lcp_all_lcp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> Cons_in_lists_iff alph<span class="main">]</span> 
      pref_prolong<span class="main">[</span><span class="operator">OF</span> i.bin_snd_mismatch<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"i.α<span class="main">⋅</span><span class="main">[</span>i.c<span class="hidden">⇩</span><sub>0</sub><span class="main">]</span> <span class="keyword1">∧<span class="hidden">⇩</span><sub>p</sub></span> i.α<span class="main">⋅</span><span class="main">[</span>i.c<span class="hidden">⇩</span><sub>1</sub><span class="main">]</span> <span class="main">=</span> i.α"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i.bin_mismatch_neq lcp_first_mismatch'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> lcp_rulers<span class="main">[</span><span class="operator">OF</span> c0 c1<span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">,</span> <span class="operator">unfolded</span> αid<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>                               
    <span class="keyword1"><span class="command">unfolding</span></span> concat.simps<span class="main">(</span>2<span class="main">)</span> rassoc pref_cancel_conv  <span class="keyword1"><span class="command">using</span></span> i.bin_mismatch_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> bin_code<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">us</span> <span class="main">=</span> concat <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bin_fst_nemp bin_snd_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> bin_fst_nemp bin_snd_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.hyps"</span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span>  concat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> cancel<span class="main">]</span>  
      <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> Cons_in_lists_iff<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> Cons_in_lists_iff<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bin_code_alpha<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> bin_all_nemp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">{</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> no_comm_bin_code <span class="main">=</span> binary_code.bin_code<span class="main">[</span><span class="operator">unfolded</span> binary_code_def<span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> bin_code_code<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"code <span class="main">{</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> code_def <span class="keyword1"><span class="command">using</span></span> no_comm_bin_code<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Free hull›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹While not every set $G$ of generators is a code, there is a unique minimal free monoid containing it, called the \emph{free hull} of $G$.
It can be defined inductively using the property known as the \emph{stability condition}.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">free_hull</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">G</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span>"</span></span>
  <span class="main">|</span> free_gen_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w1</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">G</span><span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>F</sub></span></span>"</span></span> <span class="comment1">― ‹the stability condition›</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> free_hull.intros

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The defined set indeed is a hull.›</span></span>

<span class="keyword1" id="Submonoids-free_hull_hull"><span class="command">lemma</span></span> free_hull_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">⟩</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hull.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">ε</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span> <span class="bound">w1</span> <span class="main">⋅</span> <span class="bound">w2</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The free hull is always (non-strictly) larger than the hull.›</span></span>

<span class="keyword1" id="Submonoids-hull_in_free_hull"><span class="command">lemma</span></span> hull_in_free_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> free_hull.intros<span class="main">(</span>3<span class="main">)</span> 
      hull_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span>›</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main"><span class="main">]</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹On the other hand, it can be proved that the \emph{free basis}, defined as the basis of the free hull,  has a (non-strictly) smaller cardinality than the ordinary basis.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">free_basis</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> _"</span> <span class="main">[</span>54<span class="main">]</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">free_basis</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">𝔅</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>

<span class="keyword1" id="Submonoids-basis_gen_hull_free"><span class="command">lemma</span></span> basis_gen_hull_free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_basis_def <span class="keyword1"><span class="command">using</span></span> basis_gen_hull free_hull_hull <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Submonoids-genset_sub_free"><span class="command">lemma</span></span> genset_sub_free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.free_gen_in subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹We have developed two points of view on freeness: 
<span class="antiquoted"><span class="antiquoted">▪</span></span> being a free hull, that is, to satisfy the stability condition;
<span class="antiquoted"><span class="antiquoted">▪</span></span> being generated by a code.›</span></span>
 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We now show their equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, basis of a free hull is a code.›</span></span>

<span class="keyword1" id="Submonoids-free_basis_code"><span class="command">lemma</span></span> free_basis_code<span class="main">:</span> <span class="quoted"><span class="quoted">"code <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> concat <span class="skolem">xs</span> <span class="main">=</span> concat <span class="skolem">ys</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> listsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> free_basis_def<span class="main">,</span> <span class="operator">THEN</span> emp_not_basis<span class="main">]</span>    
      concat.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> concat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> append_is_Nil_conv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span>  listsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> free_basis_def<span class="main">,</span> <span class="operator">THEN</span> emp_not_basis<span class="main">]</span>    
      concat.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹concat <span class="keyword1">ε</span> <span class="main">=</span> concat <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> concat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> append_is_Nil_conv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">ys</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> concat <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> concat <span class="skolem">ys</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">⋅</span> concat <span class="skolem">xs</span> <span class="main">=</span> concat <span class="skolem">ys</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> concat <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> append_eq_append_conv2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">ys</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≠</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  listsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span> <span class="main">]</span> listsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>"</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> free_basis_def <span class="keyword1"><span class="command">using</span></span> emp_not_basis <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> basis_sub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> free_basis_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span> 
          <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">ys</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> concat_tl_basis<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> free_basis_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 
              concat_tl_basis<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> free_basis_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> free_hull_hull<span class="keyword1"><span class="command">.</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> or free_hull.intros<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">xs</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="skolem">ys</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> or basis_dec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">unfolded</span> free_hull_hull<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span><span class="main">]</span> 
          basis_dec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">unfolded</span> free_hull_hull<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> free_basis_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Second, a code generates its free hull.›</span></span>

<span class="keyword1" id="Submonoids-code_gen_free_hull"><span class="command">lemma</span></span> code_gen_free_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"code <span class="free">C</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">=</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"code <span class="free">C</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hull_mon<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span><span class="main">]</span> 
          free_hull.free_gen_in<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>  subsetI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> free_hull_hull<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> free_hull.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull.intros hull_closed<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hull_closed<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> code.code_dec_morph<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹code <span class="free">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> lassoc<span class="main">]</span>  
        <span class="keyword1"><span class="command">unfolding</span></span> code.code_dec_morph<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹code <span class="free">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⨝</span>  <span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eqd_comp<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="keyword1">≤p</span>  <span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span> concat_morph decI prefD pref_antisym triv_pref
        <span class="keyword1"><span class="command">unfolding</span></span> prefix_comparable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">ts</span> <span class="main">=</span>  <span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lq_pref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> lists <span class="free">C</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span>  append_in_lists_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> dec_dom'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">ts</span> <span class="main">=</span>  <span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concat <span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  concat_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>                   
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">ts</span> <span class="main">=</span>  <span class="keyword1">Dec</span> <span class="free">C</span> <span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">]</span>  decI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ts</span> <span class="main">∈</span> lists <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹That is, a code is its own free basis›</span></span>

<span class="keyword1" id="Submonoids-code_free_basis"><span class="command">lemma</span></span> code_free_basis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"code <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basis_of_hull<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">,</span> <span class="operator">unfolded</span> code_gen_free_hull<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
      code.code_is_basis<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> free_basis_def<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Moreover, the free hull of G is the smallest code-generated hull containing G. 
In other words, the term free hull is appropriate.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, several intuitive monotonicity and closure results.›</span></span>

<span class="keyword1" id="Submonoids-free_hull_mono"><span class="command">lemma</span></span> free_hull_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span>›</span></span> free_hull.free_gen_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> free_hull.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> el<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">w</span> <span class="main">⋅</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">H</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> free_hull.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-free_hull_idem"><span class="command">lemma</span></span> free_hull_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> free_hull.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">G</span></span><span class="keyword1"><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>›</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  <span class="bound">w</span> <span class="main">⋅</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> free_hull.intros<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> free_hull_hull hull_in_free_hull <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-hull_gen_free_hull"><span class="command">lemma</span></span> hull_gen_free_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">=</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> free_hull_idem free_hull_mono hull_in_free_hull <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">G</span><span class="main">⟩</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_hull_mono genset_sub<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Code is also the free basis of its hull.›</span></span>

<span class="keyword1" id="Submonoids-code_free_basis_hull"><span class="command">lemma</span></span> code_free_basis_hull<span class="main">:</span> <span class="quoted"><span class="quoted">"code <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">=</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_basis_def <span class="keyword1"><span class="command">using</span></span> code_free_basis<span class="main">[</span><span class="operator">unfolded</span> free_basis_def<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span>  hull_gen_free_hull<span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The minimality of the free hull easily follows.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> free_hull_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"code <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> free_hull_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">G</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">C</span><span class="main">⟩</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hull_gen_free_hull 
  <span class="keyword1"><span class="command">unfolding</span></span> code_gen_free_hull<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹code <span class="free">C</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>  

<span class="keyword1"><span class="command">theorem</span></span> free_hull_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">}</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> free_hull_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> Inter_greatest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⊆</span> <span class="main">⋂</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⋂</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="free">G</span> <span class="main">⊆</span> <span class="bound">M</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">⟨</span><span class="bound">M</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span><span class="main">}</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inter_lower free_hull_idem genset_sub_free<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Decomposition into the free basis is a morphism.›</span></span>

<span class="keyword1" id="Submonoids-free_basis_dec_morph"><span class="command">lemma</span></span> free_basis_dec_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">G</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">⟹</span>  
    <span class="keyword1">Dec</span> <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="keyword1">Dec</span> <span class="main">(</span><span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">G</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code.code_dec_morph<span class="main">[</span><span class="operator">OF</span> free_basis_code<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> 
        <span class="operator">unfolded</span>  basis_gen_hull_free<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lists as the free hull of singletons›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A crucial property of free monoids of words is that they can be seen as lists over the free basis, 
instead as lists over the original alphabet.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sings</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sings</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">|</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Submonoids-sings_image"><span class="command">lemma</span></span> sings_image<span class="main">:</span> <span class="quoted"><span class="quoted">"sings <span class="free">B</span> <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Setcompr_eq_image<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Submonoids-lists_sing_map_concat_ident"><span class="command">lemma</span></span> lists_sing_map_concat_ident<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Submonoids-code_sings"><span class="command">lemma</span></span> code_sings<span class="main">:</span> <span class="quoted"><span class="quoted">"code <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span> <span class="main">=</span> concat <span class="skolem">ys</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> lists_sing_map_concat_ident<span class="main">[</span><span class="operator">OF</span> xs<span class="main">,</span> <span class="operator">unfolded</span> eq<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span>  lists_sing_map_concat_ident<span class="main">[</span><span class="operator">OF</span> ys<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Submonoids-sings_gen_lists"><span class="command">lemma</span></span> sings_gen_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>sings <span class="free">B</span><span class="main">⟩</span> <span class="main">=</span> lists <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hull_concat_lists
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> concat <span class="main">`</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> imageI<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">concat</span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> concat <span class="main">`</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> concat_map_sing_ident<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sings <span class="free">B</span> <span class="main">=</span> <span class="keyword1">𝔅<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span>lists <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_free_basis_hull<span class="main">[</span><span class="operator">OF</span> code_sings<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">,</span> <span class="operator">unfolded</span> sings_gen_lists<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Submonoids-map_sings"><span class="command">lemma</span></span> map_sings<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">#</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Submonoids-dec_sings"><span class="command">lemma</span></span> dec_sings<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="keyword1">Dec</span> <span class="main">(</span>sings <span class="free">B</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code.code_unique_dec<span class="main">[</span><span class="operator">OF</span> code_sings<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">,</span> <span class="operator">OF</span> map_sings<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> concat_map_sing_ident<span class="keyword1"><span class="command">.</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Periodicity_Lemma">
<div class="head">
<h1>Theory Periodicity_Lemma</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/Periodicity_Lemma.thy
    Author:     Štěpán Holub, Charles University
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Periodicity_Lemma
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoWBasic">CoWBasic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"The Periodicity Lemma"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The Periodicity Lemma says that if a sufficiently long word has two periods p and q, 
then the period can be refined to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
The consequence is equivalent to the fact that the corresponding periodic roots commute. 
``Sufficiently long'' here means at least <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">-</span></span> gcd <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
It is also known as the Fine and Wilf theorem due to its authors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> FineWilf<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
If we relax the requirement to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the claim becomes easy, and it is proved in theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="CoWBasic.html"></a><a href="CoWBasic.html">Combinatorics_Words.CoWBasic</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">two_pers</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[names_long] two_pers<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> per_lemma_relaxed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">p</span> <span class="free">w</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>take <span class="free">q</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">q</span> <span class="free">w</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>take <span class="free">p</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   two_pers<span class="main">[</span><span class="operator">OF</span>
      <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> periodN_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
      <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">q</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> periodN_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">q</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span>    
      take_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_leD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> 
      take_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_leD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Also in terms of the numeric period:›</span></span>

<span class="keyword1"><span class="command">thm</span></span> two_periodsN

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Main claim›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We first formulate the claim of the Periodicity lemma in terms of commutation of two periodic roots.
For trivial reasons we can also drop the requirement that the roots are nonempty.
›</span></span>
<span class="keyword1" id="Periodicity_Lemma-per_lemma_comm"><span class="command">lemma</span></span> per_lemma_comm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="main">(</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>empty<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="main">|</span> <span class="main">(</span>short<span class="main">)</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="main">|</span> <span class="main">(</span>step<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">∧</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>empty<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>short<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span>  _ <span class="quoted"><span class="quoted">‹ <span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹ <span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> 
      <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="main">(</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> gcd.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> le_add_diff<span class="main">[</span><span class="operator">OF</span> gcd_le2_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> length_0_conv<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> gcd.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="main">(</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> pref_prod_long<span class="main">[</span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">w</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> pref_cancel_conv<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="skolem">s</span><span class="main">⋅</span><span class="skolem">w'</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pref_prod_short<span class="main">[</span><span class="operator">OF</span> prefix_order.order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">w'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span> pref_prod_pref<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="skolem">w</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> ind_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="main">(</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w'</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> <span class="main">(</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span>  _ <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="skolem">s</span><span class="main">¯<span class="hidden">⇧</span><sup>&gt;</sup></span><span class="skolem">r</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">w'</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="keyword1">≤p</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">w'</span>›</span></span> ind_len<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⋅</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">⋅</span> <span class="skolem">s</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="keyword1">≤p</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can now prove the numeric version.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> per_lemma<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> gcd <span class="free">p</span> <span class="free">q</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> takep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> takeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="main">(</span>take <span class="free">q</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">q</span>›</span></span> periodN_D3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> lenp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">p</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd_le2_nat<span class="main">[</span><span class="operator">OF</span> per_positive<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">q</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> len take_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lenq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="free">q</span> <span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd_le1_nat<span class="main">[</span><span class="operator">OF</span> per_positive<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> len take_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"take <span class="free">q</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> comm_rootE<span class="main">[</span><span class="operator">OF</span> per_lemma_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> takeq takep<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> lenp lenq<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> len<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> periodN_def per_root_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  root_periodN<span class="main">[</span><span class="operator">OF</span>  per_nemp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="keyword1">≤p</span> <span class="skolem">t</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  common_root_len_gcd<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹take <span class="free">p</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">q</span> <span class="free">w</span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">*</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span>  lenp lenq<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> dvd_div_mult_self<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="free">q</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> gcd <span class="free">p</span> <span class="free">q</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> dvd_div_eq_0_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  per_mult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="free">q</span> <span class="keyword1">div</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dvd_div_mult_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">t</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimality›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">FW_word</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (where FW stands for  Fine and Wilf) yields a word which show the optimality of the bound in the Periodicity lemma. 
    Moreover, the obtained word has maximum possible letters (each equality of letters is forced by periods). The latter is not proved here.›</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">]</span><span class="main">⋅</span><span class="main">(</span>butlast <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹an auxiliary claim›</span>
<span class="keyword1" id="Periodicity_Lemma-ext_per_sum"><span class="command">lemma</span></span> ext_per_sum<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="main">(</span>take <span class="free">p</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> take <span class="free">q</span> <span class="free">w</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">w</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> take <span class="free">p</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">⋅</span> take <span class="free">q</span> <span class="main">(</span>drop <span class="free">p</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> take <span class="free">q</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> take <span class="free">p</span> <span class="free">w</span> <span class="main">⋅</span> take <span class="free">q</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> nemp
    <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def sum rassoc same_prefix_prefix
    <span class="keyword1"><span class="command">using</span></span> pref_prolong  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fw_p_per</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> butlast <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>gcd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fw_base</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> fw_p_per <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⋅</span> <span class="main">[</span>gcd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span><span class="main">⋅</span> fw_p_per <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">FW_word</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  FW_word_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">FW_word</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>  
<span class="comment1">―‹symmetry›</span>           <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>  <span class="free">FW_word</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> 
<span class="comment1">―‹artificial value›</span>   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">then</span> <span class="keyword1">ε</span> <span class="keyword1">else</span> 
<span class="comment1">―‹base case›</span>          <span class="keyword1">if</span> gcd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> fw_base <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
<span class="comment1">―‹step›</span>               <span class="keyword1">else</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free">FW_word</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">FW_word</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>    <span class="main">)</span>"</span></span>

<span class="keyword1" id="Periodicity_Lemma-FW_sym"><span class="command">lemma</span></span> FW_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"FW_word <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> FW_word <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fw_word'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">⟹</span>
 <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> gcd <span class="free">p</span> <span class="free">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span> <span class="main">∧</span> <span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="free">p</span> <span class="main">+</span> <span class="free">q</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>›</span></span> dvd_0_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> FW_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>             
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dw</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">+</span> <span class="var">?d</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> fw<span class="main">:</span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> fw_base <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> FW_word_def <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

      <span class="keyword1"><span class="command">have</span></span> ppref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="var">?d</span><span class="main">]</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_append <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?dw</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pd</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> ppref' <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> length_append<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> qpref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="var">?d</span><span class="main">]</span><span class="main">⋅</span><span class="var">?dw</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lassoc length_append ppref' <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">+</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="var">?d</span><span class="main">]</span> <span class="keyword1">≤p</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fw <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> takep<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="var">?d</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ppref<span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dw</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="var">?dw</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="var">?d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pd</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> dvd_div_eq_0_iff<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> not0_implies_Suc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>›</span></span> gcd_dvd2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>     
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">e</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dvd_mult_div_cancel<span class="main">[</span><span class="operator">OF</span> gcd_dvd1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">e</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> nonzero_pow_emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> but_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dw</span> <span class="main">⋅</span> butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>›</span></span> pow_Suc_list butlast_append  if_not_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">e</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> but_dec_b<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">e</span> <span class="main">⋅</span> butlast <span class="var">?dw</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>›</span></span> pow_Suc2_list butlast_append if_not_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?dw</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main">⋅</span><span class="main">[</span><span class="var">?d</span><span class="main">]</span><span class="main">⋅</span><span class="var">?dw</span> <span class="keyword1">≤p</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fw but_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> takeq <span class="main">=</span> pref_take<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> qpref<span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="var">?dw</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="var">?d</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?dw</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pd</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>butlast <span class="main">(</span><span class="var">?dw</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="var">?pd</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span>  <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fw <span class="keyword1"><span class="command">unfolding</span></span> length_append
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">+</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>    

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> length_0_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ppref<span class="main">[</span><span class="operator">folded</span> takep<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def  takep <span class="keyword1"><span class="command">unfolding</span></span> fw lassoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def 
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">q</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> length_0_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> qpref<span class="main">[</span><span class="operator">folded</span> takeq<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword1">≤p</span> take <span class="skolem">q</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> takeq 
          <span class="keyword1"><span class="command">unfolding</span></span> fw rassoc pref_cancel_conv but_dec but_dec_b <span class="quoted"><span class="quoted">‹<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>›</span></span> pow_Suc2_list butlast_append pow_Suc_list if_not_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?dw</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> lassoc power_commutes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rassoc pref_cancel_conv
          <span class="keyword1"><span class="command">using</span></span> pref_ext<span class="main">[</span><span class="operator">OF</span> prefixeq_butlast<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?dw</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="var">?d</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> last_a<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?d</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> takep nth_append_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="var">?dw</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="var">?pd</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span>"</span></span> <span class="quoted"><span class="keyword1">ε</span></span><span class="main">]</span>
            last_snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dw</span> <span class="keyword1">≤p</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fw but_dec  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="var">?dw</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="var">?d</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> takegcd<span class="main">:</span>  <span class="quoted"><span class="quoted">"take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> fw_dec_b<span class="main">:</span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">e</span> <span class="main">⋅</span> butlast <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">[</span><span class="var">?d</span><span class="main">]</span> <span class="main">⋅</span> <span class="main">(</span>butlast <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fw but_dec_b  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> gcdepref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span> Suc <span class="skolem">e</span> <span class="keyword1">≤p</span> take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> takegcd  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span> Suc <span class="skolem">e</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> pow_len <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="var">?dw</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="var">?d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?pd</span> <span class="main">=</span> Suc <span class="skolem">e</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span>  
            dvd_div_mult_self<span class="main">[</span><span class="operator">OF</span> gcd_dvd1<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> pref_take<span class="main">[</span><span class="operator">OF</span> gcdepref<span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> takegcdp<span class="main">:</span>  <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">e</span> <span class="main">⋅</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> pow_Suc2_list<span class="keyword1"><span class="command">.</span></span>  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> gcd <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> last_upt<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> last_b<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="skolem">p</span> <span class="main">(</span>take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> takegcdp  last_appendR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">e</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">]</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">≠</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> take <span class="skolem">p</span> <span class="main">(</span>take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> last_b<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> last_a<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">last</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword1">≤p</span> take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span> "</span></span> 
          <span class="keyword1"><span class="command">using</span></span> pref_share_take<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⋅</span> FW_word <span class="skolem">p</span> <span class="skolem">q</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> periodN_def period_root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>          

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>gcd <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> fw<span class="main">:</span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> FW_word_def <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_Suc_eq not_less_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> divhyp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> dvd_minus_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> divhyp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> less_or_eq_imp_le<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gcd_add2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span><span class="main">,</span> <span class="operator">folded</span>  this<span class="main">,</span> <span class="operator">unfolded</span> gcd_nat.absorb2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> lenhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 

<span class="comment1">― ‹induction assumption›</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">-</span> <span class="var">?d'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gcd <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span> _ divhyp1 divhyp2<span class="main">]</span> lenhyp
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 

<span class="comment1">― ‹auxiliary facts›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> divhyp1 dvd_minus_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="var">?d'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  gcd_add2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> le_add_diff_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>›</span></span>  gcd_dvd2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">unfolded</span> gcd.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> nat_neq_iff<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  gr_implies_not0 <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> nat_dvd_not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d'</span> <span class="main">&lt;</span> <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  gcd_le2_nat<span class="main">[</span><span class="operator">OF</span> per_positive<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>  divhyp2<span class="main">[</span><span class="operator">unfolded</span>  gcd_nat.absorb_iff2<span class="main">]</span> nat_less_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">-</span> <span class="var">?d'</span> <span class="main">-</span> <span class="main">1</span>›</span></span>  diff_diff_left discrete <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> length_0_conv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">[</span><span class="operator">folded</span> le_zero_eq<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="comment1">― ‹claim 1›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fw length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">-</span> <span class="var">?d'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">-</span> <span class="var">?d'</span> <span class="main">-</span> <span class="main">1</span>›</span></span> 
            take_len<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span>  <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?d</span> <span class="main">=</span> <span class="var">?d'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Nat.add_diff_assoc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?d</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> less_or_eq_imp_le<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹claim 2›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fw  ext_per_left<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="comment1">― ‹claim 3›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ext_per_sum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">folded</span> fw<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹claim 4›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="var">?d</span>"</span></span>                   
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gcd <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span><span class="main">-</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>›</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?d</span> <span class="main">=</span> <span class="var">?d'</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>  
        <span class="keyword1"><span class="command">using</span></span> periodN_fac<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="skolem">p</span> <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="keyword1">ε</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_Nil2<span class="main">,</span> 
                          <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹FW_word <span class="skolem">p</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">folded</span> fw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="skolem">p</span> <span class="skolem">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span> <span class="main">-</span> <span class="var">?d</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fw_word<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> gcd <span class="free">p</span> <span class="free">q</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> periodN <span class="main">(</span>FW_word <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fw_word'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Calculation examples›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="numeral">3</span> <span class="numeral">7</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="numeral">5</span> <span class="numeral">7</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="numeral">5</span> <span class="numeral">13</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="numeral">4</span> <span class="numeral">6</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"FW_word <span class="numeral">12</span> <span class="numeral">18</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Other variants of the periodicity lemma"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Periodicity lemma is one of the most frequent tools in Combinatorics on words.
   Here are some useful variants.›</span></span>

<span class="keyword1" id="Periodicity_Lemma-fac_two_conjug_prim_root"><span class="command">lemma</span></span> fac_two_conjug_prim_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> facs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nemps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> gcd <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">r</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prefr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">r'</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prefs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">s'</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>   conjugs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∼</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∼</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> facs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> fac_pow_pref_conjug<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rootr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">r'</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> roots'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤p</span> <span class="skolem">s'</span> <span class="main">⋅</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_prod_root<span class="main">[</span><span class="operator">OF</span> prefr'<span class="main">]</span> pref_prod_root<span class="main">[</span><span class="operator">OF</span> prefs'<span class="main">]</span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">have</span></span> nemps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nemps conjugs conjug_nemp_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> gcd <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">r'</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">s'</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len
    <span class="keyword1"><span class="command">unfolding</span></span> conjug_len<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∼</span> <span class="skolem">r'</span>›</span></span><span class="main">]</span> conjug_len<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∼</span> <span class="skolem">s'</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> per_lemma_comm<span class="main">[</span><span class="operator">OF</span> roots' rootr' this<span class="main">]</span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">⋅</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="skolem">s'</span> <span class="main">⋅</span> <span class="skolem">r'</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="keyword1">ρ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> comm_primroots<span class="main">[</span><span class="operator">OF</span> nemps'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">s</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conjug_prim_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∼</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">r</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conjug_prim_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∼</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">r</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">s</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodicity_Lemma-fac_two_conjug_prim_root'"><span class="command">lemma</span></span> fac_two_conjug_prim_root'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> facs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> gcd <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ρ</span> <span class="free">r</span> <span class="main">∼</span> <span class="keyword1">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nemps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> facs <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fac_two_conjug_prim_root<span class="main">[</span><span class="operator">OF</span> facs nemps len<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodicity_Lemma-fac_two_nconj_prim_pow"><span class="command">lemma</span></span> fac_two_nconj_prim_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prims<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">r</span> <span class="main">∼</span> <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> facs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤f</span> <span class="free">s</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">-</span> gcd <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">r</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">s</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">r</span> <span class="main">∼</span> <span class="free">s</span>›</span></span> fac_two_conjug_prim_root<span class="main">[</span><span class="operator">OF</span> facs prim_nemp prim_nemp leI<span class="main">,</span> <span class="operator">OF</span> prims<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> prim_self_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">r</span>›</span></span><span class="main">]</span> prim_self_root<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹primitive <span class="free">s</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_np<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lyndon_Schutzenberger">
<div class="head">
<h1>Theory Lyndon_Schutzenberger</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CoW/Lyndon_Schutzenberger.thy
    Author:     Štěpán Holub, Charles University
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Lyndon_Schutzenberger
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#CoWBasic">CoWBasic</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Lyndon-Schützenberger Equation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The Lyndon-Schützenberger equation is the following equation on words:
\[
x^ay^b = z^c,
\]
in this formalization denoted as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>@</sup></span></span><span class="free"><span class="free">a</span></span><span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>@</sup></span></span><span class="free"><span class="free">b</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">z</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>@</sup></span></span><span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, with $2 \leq a,b,c$.
We formalize here a proof that the equation has periodic solutions only in free monoids, that is, that any three words 
$x$, $y$ and $z$ satisfying the equality pairwise commute.
The result was first proved in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> LySch62<span class="antiquote"><span class="antiquote">}</span></span></span></span> in a more general setting of free groups.
There are several proofs to be found in the literature (for instance <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> Lo83 <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> Dmsi2006<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
The presented proof is the author's proof.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We set up a locale representing the Lyndon-Schützenberger Equation.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> LS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">a</span> <span class="free">y</span> <span class="free">b</span> <span class="free">z</span> <span class="free">c</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>   <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lyndon_Schutzenberger-a0"><span class="command">lemma</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If $x^a$ or $y^b$ is sufficiently long, then the calim follows from the Periodicity Lemma.›</span></span>

<span class="keyword1" id="Lyndon_Schutzenberger-per_lemma_case"><span class="command">lemma</span></span> per_lemma_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">=</span><span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">=</span><span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq assms emp_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> period_root_def <span class="keyword1"><span class="command">using</span></span> 
    pref_ext<span class="main">[</span><span class="operator">OF</span> triv_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> eq<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="free">a</span> <span class="keyword1">≤p</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> a0 root_self<span class="main">[</span><span class="operator">THEN</span> per_drop_exp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> two_pers<span class="main">[</span><span class="operator">OF</span> per_drop_exp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="keyword1">≤p</span> <span class="main">(</span><span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span><span class="main"><span class="main">]</span></span> this assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span><span class="main">⋅</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main">⋅</span><span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_add_exps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> eq<span class="main">,</span> <span class="operator">unfolded</span> rassoc cancel<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> comm_pow_roots<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a0 b0<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The most challenging case is when $c = 3$.›</span></span>

<span class="keyword1" id="Lyndon_Schutzenberger-core_case"><span class="command">lemma</span></span> core_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    lenx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    leny<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">―‹We first show that a = 2›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">+</span><span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="numeral">3</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="numeral">3</span>›</span></span> eq length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_len<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lenx <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> less_trans<span class="main">[</span><span class="operator">OF</span> lenx this<span class="main">,</span> <span class="operator">unfolded</span> mult_less_cancel2<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="free">a</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> b 
      pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>  pow_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> mult_le_less_imp_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> not_le
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a eq <span class="quoted"><span class="quoted">‹<span class="free">c</span><span class="main">=</span><span class="numeral">3</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span><span class="main">=</span><span class="numeral">2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 numeral_3_eq_3<span class="main">)</span> 

<span class="comment1">― ‹Find words u, v, w›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> add.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> ruler_le<span class="main">[</span><span class="operator">THEN</span> prefD<span class="main">,</span> <span class="operator">OF</span> triv_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⋅</span><span class="free">z</span>"</span></span><span class="main"><span class="main">]</span></span> _ less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span><span class="main">⋅</span><span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> prefI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rassoc<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> lenx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ruler_le<span class="main">[</span><span class="operator">THEN</span> prefD<span class="main">,</span> <span class="operator">OF</span> _ _ less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> triv_pref<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span>›</span></span><span class="main">,</span> <span class="operator">OF</span> triv_pref<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">=</span><span class="free">z</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">z</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span><span class="main">⋅</span><span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> add_less_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ruler_le<span class="main">[</span><span class="operator">OF</span> triv_pref<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span>  rassoc <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">z</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> lassoc<span class="main"><span class="main">]</span></span> triv_pref<span class="main">,</span> <span class="operator">OF</span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⋅</span><span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span><span class="main">⋅</span><span class="free">x</span>›</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lq_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> 
   pref_prod_pref'<span class="main">[</span><span class="operator">OF</span> pref_cancel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span><span class="main">⋅</span><span class="skolem">w</span> <span class="keyword1">≤p</span> <span class="free">z</span><span class="main">⋅</span><span class="free">z</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> rassoc<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">)</span>

<span class="comment1">― ‹Express x, y and z in terms of  u, v and w›</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">z</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> this lassoc<span class="main">,</span> <span class="operator">folded</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> this rassoc<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pref_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Double period of uwv›</span>
  <span class="keyword1"><span class="command">from</span></span> periodN_fac<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> rassoc<span class="main">,</span> <span class="operator">folded</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow_per<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> b0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span><span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="keyword1">≤p</span> <span class="skolem">u</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> period_root_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="free">x</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> triv_pref<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="keyword1">≤p</span> <span class="skolem">u</span> <span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹Common period d›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">=</span>gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> length_append <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⋅</span> <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"periodN <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span><span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span><span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span><span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> two_periodsN
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">― ‹Divisibility›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="free">z</span><span class="main">=</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>›</span></span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> add_left_cancel
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gcd_nat.cobounded1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span> gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> gcd <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> gcd  <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="free">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  lenarg<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="free">z</span><span class="main">=</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_append pow_len<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd_add_left_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="main">+</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> this dvd_add_left_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> gcd  <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> dvd_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> lenarg<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">⋅</span> <span class="skolem">u</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_append pow_len<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_add_left_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">v</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="comment1">― ‹x and y commute›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤p</span> <span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span><span class="main">)</span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodN <span class="free">x</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> per_pref'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="keyword1">ε</span>›</span></span>  <span class="quoted"><span class="quoted">‹periodN <span class="main">(</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span><span class="main">)</span> <span class="skolem">d</span> ›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="keyword1">≤p</span> <span class="skolem">u</span> <span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">v</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> root_divisor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"periodN <span class="skolem">u</span> <span class="skolem">d</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> per_pref'
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodN <span class="free">x</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" take <span class="skolem">d</span> <span class="free">x</span> <span class="main">=</span> take <span class="skolem">d</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">≠</span><span class="keyword1">ε</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">⋅</span> <span class="skolem">w</span>›</span></span> pref_share_take
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> gcd  <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> root_divisor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodN <span class="skolem">u</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">folded</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span><span class="keyword1"><span class="command">.</span></span>


  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">=</span><span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>›</span></span> add_roots <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> root_pref_cancel'<span class="main">[</span><span class="operator">OF</span> _ root_pow_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> take <span class="skolem">d</span> <span class="free">x</span><span class="main">*</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> eq<span class="main">,</span> <span class="operator">OF</span> root_pow_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">∈</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="free">x</span><span class="main">)</span><span class="main">*</span>"</span></span><span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">from</span></span>  commD<span class="main">[</span><span class="operator">OF</span> root_pow_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> take <span class="skolem">d</span> <span class="free">x</span><span class="main">*</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> comm_pow_roots<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹locale LS›</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The main proof is by induction on the length of $z$. It also uses the reverse symmetry of the equation which is 
exploited by two interpretations of the locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">LS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note also that the case $|x^a| &lt; |y^b|$ is solved by 
using induction on $|z| + |y^b|$ instead of just on $|z|$.
›</span></span>

<span class="keyword1" id="Lyndon_Schutzenberger-Lyndon_Schutzenberger'"><span class="command">lemma</span></span> Lyndon_Schutzenberger'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span><span class="main">;</span>  <span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span><span class="main">;</span>  <span class="numeral">2</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="free">b</span><span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="free">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less

  <span class="keyword1"><span class="command">interpret</span></span> LS <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹ <span class="numeral">2</span> <span class="main">≤</span><span class="skolem">a</span> ›</span></span> <span class="quoted"><span class="quoted">‹ <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹ <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LS.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> LSrev<span class="main">:</span> LS <span class="quoted"><span class="quoted">"rev <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="skolem">c</span></span> 
        <span class="keyword1"><span class="command">using</span></span>  LS.intro<span class="main">[</span><span class="operator">OF</span> b a c<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">z</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> rev_append rev_pow<span class="main">,</span> <span class="operator">unfolded</span> rev_is_rev_conv<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">c</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> leneq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  eq <span class="keyword1"><span class="command">unfolding</span></span> pow_len<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> length_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span><span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">ε</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">)</span>

<span class="comment1">― ‹WLOG assumption›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">a</span><span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span>rev <span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">b</span><span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_len<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span> this LSrev.eq b a c<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span>  rev_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rev_is_rev_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="comment1">― ‹case solved by the Periodicity lemma›</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>with_Periodicity_lemma<span class="main">)</span>
        <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">∨</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="main">|</span>
        <span class="main">(</span>without_Periodicity_lemma<span class="main">)</span>    
        <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> with_Periodicity_lemma
        <span class="keyword3"><span class="command">assume</span></span> short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">∨</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">∨</span> rev <span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> per_lemma_case LSrev.per_lemma_case short
          <span class="keyword1"><span class="command">unfolding</span></span> length_rev rev_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rev_is_rev_conv rev_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> without_Periodicity_lemma
        <span class="keyword3"><span class="command">assume</span></span> lenx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> leny<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
          <span class="keyword1"><span class="command">using</span></span> nat_le_iff_add that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">+</span> <span class="skolem">b</span><span class="main">*</span><span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">*</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span><span class="main">]</span> ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span><span class="main">]</span> lenx leny <span class="keyword1"><span class="command">unfolding</span></span> pow_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leneq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>c_is_3<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c_is_2<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> <span class="numeral">4</span>›</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> c_is_3 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span>  
              core_case<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="numeral">3</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pow_len<span class="main"><span class="main">]</span></span> _ _ lenx<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pow_len<span class="main"><span class="main">]</span></span> leny<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pow_len<span class="main"><span class="main">]</span></span><span class="main">]</span> 
              <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ε</span>›</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>  
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>  
          <span class="keyword1"><span class="command">hence</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq pow2_list<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span>   dual_order.trans  le_cases<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> eq_len_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">a'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> eq2<span class="main">[</span><span class="operator">folded</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> pow_Suc2_list rassoc<span class="main">]</span>  pow_Suc2_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> eq3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a'</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> aa'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a'</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a</span> "</span></span><span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> lenx pow_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>  
            <span class="keyword1"><span class="command">using</span></span>  mult_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">a'</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> leD<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pow_len  
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a'</span><span class="main">⋅</span><span class="skolem">u</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eqd_prefE<span class="main">[</span><span class="operator">OF</span> eq3<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rassoc<span class="main"><span class="main">]</span></span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a'</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span>
              eqd_prefE<span class="main">[</span><span class="operator">OF</span> eq2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">≤</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a'</span><span class="main">⋅</span><span class="skolem">x</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a'</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span>"</span></span>
           <span class="keyword1"><span class="command">unfolding</span></span> lassoc  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a'</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> aa' cancel eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">=</span><span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> swap_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">― ‹Induction step: new equation with shorter z›</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="numeral">2</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">u</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> pow2_list <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main"><span class="hidden">⇧</span><sup>@</sup></span> <span class="skolem">a'</span> <span class="main">⋅</span> <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">⋅</span><span class="skolem">w</span><span class="main">=</span><span class="skolem">x</span>›</span></span> pow_slide<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"less.hyps"</span><span class="main">[</span><span class="operator">OF</span> _ this _ b a<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">w</span><span class="main">⋅</span><span class="skolem">u</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">⋅</span><span class="skolem">y</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">x</span><span class="main"><span class="hidden">❙</span><b>|</b></span> <span class="main">&lt;</span> <span class="main"><span class="hidden">❙</span><b>|</b></span><span class="skolem">z</span><span class="main"><span class="hidden">❙</span><b>|</b></span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lassoc <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">⋅</span><span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">⋅</span><span class="skolem">y</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_commutes_list<span class="main">)</span>   
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">c</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main">⋅</span><span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">c</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_add_exps<span class="main">)</span> 
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> eq<span class="main">,</span> <span class="operator">unfolded</span> lassoc<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span><span class="main">⋅</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">b</span><span class="main">⋅</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="skolem">a</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cancel_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> comm_pow_roots<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≠</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Lyndon_Schutzenberger<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="free">y</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Lyndon_Schutzenberger'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comm_add_exp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> comm_add_exp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    lassoc power_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">⋅</span><span class="free">z</span> <span class="main">=</span> <span class="free">z</span><span class="main">⋅</span><span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comm_drop_exp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lassoc <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">a</span><span class="main">⋅</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">b</span> <span class="main">=</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>@</sup></span><span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CoWAll">
<div class="head">
<h1>Theory CoWAll</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CoWAll
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#CoWBasic">CoWBasic</a>
    <a href="#Submonoids">Submonoids</a>
    <a href="#Periodicity_Lemma">Periodicity_Lemma</a>           
    <a href="#Lyndon_Schutzenberger">Lyndon_Schutzenberger</a>
<span class="keyword2"><span class="keyword">begin</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>