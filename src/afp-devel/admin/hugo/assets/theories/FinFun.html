<div id="FinFun">
<div class="head">
<h1>Theory FinFun</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler, Uni Karlsruhe *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Almost everywhere constant functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FinFun
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Cardinality.html">HOL-Library.Cardinality</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory defines functions which are constant except for finitely
  many points (FinFun) and introduces a type finfin along with a
  number of operators for them. The code generator is set up such that
  such functions can be represented as data in the generated code and
  all operators are executable.

  For details, see Formalising FinFuns - Generating Code for Functions as Data by A. Lochbihler in TPHOLs 2009.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_default›</span></span></span></span> operation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_default</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> <span class="bound">b'</span>"</span></span>

<span class="keyword1" id="FinFun-map_default_delete"><span class="command">lemma</span></span> map_default_delete <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_default <span class="free">b</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-map_default_insert"><span class="command">lemma</span></span> map_default_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_default <span class="free">b</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-map_default_empty"><span class="command">lemma</span></span> map_default_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> Map.empty <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff map_default_def<span class="main">)</span>

<span class="keyword1" id="FinFun-map_default_inject"><span class="command">lemma</span></span> map_default_inject<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infin_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ran <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">∉</span> ran <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="free">g</span> <span class="main">=</span> map_default <span class="free">b'</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> infin_eq <span class="keyword3"><span class="command">show</span></span> bb'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> infin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> fin fin' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span> <span class="main">∪</span> dom <span class="free">g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> infin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> <span class="main">(</span>dom <span class="free">g</span> <span class="main">∪</span> dom <span class="free">g'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> dom <span class="free">g</span> <span class="main">∪</span> dom <span class="free">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="free">g</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b'</span> <span class="free">g'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bb' eq' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b'</span> <span class="free">g'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">c</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> eq' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b'</span> <span class="free">g'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' bb' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The finfun type›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">finfun</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> finfun  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">⇒f</span> <span class="keyword3">/</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>22<span class="main">,</span> 21<span class="main">]</span> 21<span class="main">)</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"finfun <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> finfun_apply Abs_finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≠</span> undefined<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> undefined<span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> undefined<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_notation</span></span> finfun <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">⇒f</span> <span class="keyword3">/</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>22<span class="main">,</span> 21<span class="main">]</span> 21<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_finfun

<span class="keyword1" id="FinFun-fun_upd_finfun"><span class="command">lemma</span></span> fun_upd_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> finfun <span class="main">⟷</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> finite <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-const_finfun"><span class="command">lemma</span></span> const_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_left_compose"><span class="command">lemma</span></span> finfun_left_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">y</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">F</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="bound">y</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">x</span> <span class="skolem">F</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">OF</span> F<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">≠</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">OF</span> F<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> fst_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snd_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> fst <span class="main">(</span><span class="free">y</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> snd <span class="main">(</span><span class="free">y</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> fst <span class="main">(</span><span class="free">y</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> snd <span class="main">(</span><span class="free">y</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="free">y</span> <span class="main">∈</span> finfun"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-map_of_finfun"><span class="command">lemma</span></span> map_of_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finfun_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_neg_eq Collect_conj_eq Collect_imp_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

<span class="keyword1" id="FinFun-Diag_finfun"><span class="command">lemma</span></span> Diag_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> finfun <span class="main">⟷</span> <span class="free">f</span> <span class="main">∈</span> finfun <span class="main">∧</span> <span class="free">g</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_neg_eq Collect_imp_eq Collect_conj_eq finfun_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_right_compose"><span class="command">lemma</span></span> finfun_right_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> g <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span>  <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> subset_inj_on<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_imageD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_curry"><span class="command">lemma</span></span> finfun_curry<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"curry <span class="free">f</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"curry <span class="free">f</span> <span class="free">a</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> curry <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curry_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> curry <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"curry <span class="free">f</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"curry <span class="free">f</span> <span class="free">a</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">bundle</span></span> finfun
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  fst_finfun snd_finfun Abs_finfun_inverse
  finfun_apply_inverse Abs_finfun_inject finfun_apply_inject
  Diag_finfun finfun_curry
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span>
  const_finfun fun_upd_finfun finfun_apply map_of_finfun
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span>
  finfun_left_compose fst_finfun snd_finfun

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFun-Abs_finfun_inject_finite"><span class="command">lemma</span></span> Abs_finfun_inject_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="free">x</span> <span class="main">=</span> Abs_finfun <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="free">x</span> <span class="main">=</span> Abs_finfun <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FinFun-Abs_finfun_inject_finite_class"><span class="command">lemma</span></span> Abs_finfun_inject_finite_class<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="free">x</span> <span class="main">=</span> Abs_finfun <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_UNIV
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject_finite<span class="main">)</span>

<span class="keyword1" id="FinFun-Abs_finfun_inj_finite"><span class="command">lemma</span></span> Abs_finfun_inj_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>Abs_finfun <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="skolem">x</span> <span class="main">=</span> Abs_finfun <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-Abs_finfun_inverse_finite"><span class="command">lemma</span></span> Abs_finfun_inverse_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_apply <span class="main">(</span>Abs_finfun <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> finfun"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-Abs_finfun_inverse_finite_class"><span class="command">lemma</span></span> Abs_finfun_inverse_finite_class<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_apply <span class="main">(</span>Abs_finfun <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inverse_finite<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_eq_finite_UNIV"><span class="command">lemma</span></span> finfun_eq_finite_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>finfun <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_finite_UNIV_class"><span class="command">lemma</span></span> finfun_finite_UNIV_class<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_eq_finite_UNIV<span class="main">)</span>

<span class="keyword1" id="FinFun-map_default_in_finfun"><span class="command">lemma</span></span> map_default_in_finfun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">b</span> <span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finfun_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> CollectI exI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> map_default <span class="free">b</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def dom_def Collect_conj_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_cases_map_default"><span class="command">lemma</span></span> finfun_cases_map_default<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b</span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ran <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="skolem">y</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff map_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kernel functions for type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> <span class="keyword1"><span class="keyword1">⇒f</span></span> <span class="tfree"><span class="tfree">'b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> finfun_const <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">K$</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>0<span class="main">]</span> 1<span class="main">)</span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> const_finfun<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> finfun_update <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">$:=</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fun_upd"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_finfun<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_update_twist"><span class="command">lemma</span></span> finfun_update_twist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_update_twice"><span class="command">lemma</span></span> finfun_update_twice <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="FinFun-finfun_update_const_same"><span class="command">lemma</span></span> finfun_update_const_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code generator setup›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_update_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_update_code</span> <span class="main">=</span> finfun_update"</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">finfun_const</span> <span class="quoted">finfun_update_code</span>

<span class="keyword1" id="FinFun-finfun_update_const_code"><span class="command">lemma</span></span> finfun_update_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">else</span> finfun_update_code <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">a</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_const_same<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_update_update_code"><span class="command">lemma</span></span> finfun_update_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">then</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="keyword1">else</span> finfun_update_code <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_twist<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup for quickcheck›</span></span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> finfun constructors<span class="main">:</span> <span class="quoted">finfun_update_code</span><span class="main">,</span> <span class="quoted"><span class="quoted">"finfun_const <span class="main">::</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finfun_update›</span></span></span></span> as instance of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>comp_fun_commute›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_update<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">a'</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finfun_apply <span class="skolem">b</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">,</span> <span class="skolem">a'</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_apply <span class="skolem">b</span><span class="main">)</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def fun_upd_twist<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-fold_finfun_update_finite_univ"><span class="command">lemma</span></span> fold_finfun_update_finite_univ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="free">b'</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="free">b'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="keyword1">then</span> <span class="free">b'</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="keyword1">then</span> <span class="free">b'</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def fun_upd_def<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def Abs_finfun_inverse_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span> fun_upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Default value for FinFuns›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_default_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_default_aux</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span> <span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFun-finfun_default_aux_infinite"><span class="command">lemma</span></span> finfun_default_aux_infinite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_default_aux <span class="free">f</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> infin fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="var">?B'</span> <span class="main">∪</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> infin <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FinFun-finite_finfun_default_aux"><span class="command">lemma</span></span> finite_finfun_default_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> finfun_default_aux <span class="free">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fin
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def finfun_default_aux_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_infinite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_default_aux_update_const"><span class="command">lemma</span></span> finfun_default_aux_update_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_default_aux <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> finfun_default_aux <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">b'</span> <span class="main">∧</span> <span class="free">f</span> <span class="free">a</span> <span class="main">≠</span> <span class="skolem">b'</span>"</span></span><span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> False b' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_infinite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> finfun_default <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finfun_default_aux"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="FinFun-finite_finfun_default"><span class="command">lemma</span></span> finite_finfun_default<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> finfun_apply <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> finfun_default <span class="free">f</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">erule</span> finite_finfun_default_aux<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_default_const"><span class="command">lemma</span></span> finfun_default_const<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_infinite finfun_default_aux_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_default_update_const"><span class="command">lemma</span></span> finfun_default_update_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> finfun_default <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_aux_update_const<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_default_const_code"><span class="command">lemma</span></span> finfun_default_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> card_UNIV <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">c</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_const<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_default_update_code"><span class="command">lemma</span></span> finfun_default_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> finfun_default <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_update_const<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Recursion combinator and well-formedness conditions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">finfun_rec</span> <span class="free"><span class="bound"><span class="entity">cnst</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
   <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> finfun_default <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
       <span class="bound">g</span> <span class="main">=</span> <span class="keyword1">THE</span> <span class="bound">g</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="bound">b</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∉</span> ran <span class="bound">g</span>
   <span class="keyword1">in</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="bound">b</span> <span class="bound">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cnst</span></span></span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> finfun_rec_wf_aux <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cnst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> upd_const_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnst</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> upd_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> upd_idemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">b'</span> <span class="main">⟹</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">b''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">b'</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">b''</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="FinFun-upd_left_comm"><span class="command">lemma</span></span> upd_left_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> upd_commute <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-upd_upd_twice"><span class="command">lemma</span></span> upd_upd_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">b''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">b'</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">b''</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">b'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_def upd_const_same upd_idemp<span class="main">)</span>

<span class="keyword1" id="FinFun-map_default_update_const"><span class="command">lemma</span></span> map_default_update_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> anf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">d</span>  <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Finite_Set.fold <span class="var">?upd</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gwf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="var">?upd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> fin anf fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def upd_const_same<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span>  <span class="main">⟦</span> <span class="skolem">A</span> <span class="main">=</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">a</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="bound">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">d</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?fr</span> <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> anf <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> a'nA <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> domf <span class="main">=</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">a'</span> <span class="skolem">A</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> fg <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>›</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> domf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">a'</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">d</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>insert <span class="skolem">a'</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">d</span> <span class="main">(</span><span class="free">upd</span> <span class="skolem">a'</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">(</span><span class="var">?fr</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> gwf.fold_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin a'nA<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> b fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ga'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="free">d</span> <span class="free">g</span> <span class="skolem">a'</span> <span class="main">=</span> map_default <span class="free">d</span> <span class="skolem">f</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> anf domf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> upd_commute<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> domf a'nA anf fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="var">?f'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> dom <span class="var">?f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def map_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> IH<span class="main">[</span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> dom <span class="var">?f'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="skolem">a'</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="skolem">f</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?fr</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> domf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> gwf.fold_insert<span class="main">[</span><span class="operator">OF</span> fin a'nA<span class="main">]</span> ga' <span class="keyword1"><span class="command">unfolding</span></span> A <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a'</span> <span class="main">(</span>dom <span class="var">?f'</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-map_default_update_twice"><span class="command">lemma</span></span> map_default_update_twice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> anf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">d'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span>map_default <span class="free">d</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Finite_Set.fold <span class="var">?upd</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">d</span><span class="main">)</span> <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gwf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="var">?upd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> fin anf fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def finfun_update_def upd_upd_twice<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">A</span> <span class="main">=</span> dom <span class="bound">f</span><span class="main">;</span> <span class="free">a</span> <span class="main">∉</span> dom <span class="bound">f</span><span class="main">;</span> <span class="bound">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">d'</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> anf <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> a'nA <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> domf <span class="main">=</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">a'</span> <span class="skolem">A</span> <span class="main">=</span> dom <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> fg <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>›</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> domf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">a'</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">a'</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">f</span> <span class="skolem">a'</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">d</span> <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> domf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">d'</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a</span> <span class="free">d''</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a</span> <span class="free">d'</span> <span class="main">(</span><span class="var">?fr</span> <span class="main">(</span>insert <span class="skolem">a'</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> gwf.fold_insert<span class="main">[</span><span class="operator">OF</span> fin a'nA<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> b fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ga'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="free">d</span> <span class="free">g</span> <span class="skolem">a'</span> <span class="main">=</span> map_default <span class="free">d</span> <span class="skolem">f</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> anf domf <span class="keyword1"><span class="command">have</span></span> ana'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">note</span></span> upd_commute<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> upd_commute<span class="main">[</span><span class="operator">OF</span> ana'<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> domf a'nA anf fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> dom <span class="var">?f'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> dom <span class="var">?f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def map_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> IH<span class="main">[</span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> dom <span class="var">?f'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> upd_commute<span class="main">[</span><span class="operator">OF</span> ana'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ga'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> gwf.fold_insert<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> fin a'nA<span class="main">]</span> <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> domf
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-map_default_eq_id"><span class="command">lemma</span></span> map_default_eq_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def restrict_map_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finite_rec_cong1"><span class="command">lemma</span></span> finite_rec_cong1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="free">A</span> <span class="main">=</span> Finite_Set.fold <span class="free">g</span> <span class="free">z</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> f<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> g<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="free">g</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> g<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> BsubA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="skolem">B</span> <span class="main">=</span> Finite_Set.fold <span class="free">g</span> <span class="free">z</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">B</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> finB <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> anB <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">note</span></span> sub <span class="main">=</span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">a</span> <span class="skolem">B</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="skolem">B</span> <span class="main">=</span> Finite_Set.fold <span class="free">g</span> <span class="free">z</span> <span class="skolem">B</span>›</span></span>
      <span class="keyword1"><span class="command">from</span></span> sub anB <span class="keyword1"><span class="command">have</span></span> BpsubA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊂</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BsubA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> aA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> BsubA<span class="main">]</span> eq<span class="main">[</span><span class="operator">OF</span> aA<span class="main">]</span> finB anB
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> BsubA <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="skolem">B</span> <span class="main">=</span> Finite_Set.fold <span class="free">g</span> <span class="free">z</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_rec_upd"><span class="command">lemma</span></span> finfun_rec_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_rec <span class="free">cnst</span> <span class="free">upd</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>finfun_rec <span class="free">cnst</span> <span class="free">upd</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> finfun_default <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?the</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">∉</span> ran <span class="bound">g</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> The <span class="main">(</span><span class="var">?the</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f y b <span class="keyword1"><span class="command">have</span></span> bfin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_def finite_finfun_default_aux<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">y</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> bfin <span class="keyword1"><span class="command">have</span></span> fing<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> bran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> yg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> map_default <span class="skolem">b</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> f y bfin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="free">f</span> <span class="var">?g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="free">f</span> <span class="skolem">g'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> fin'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ran'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="skolem">g'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="var">?g</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f yg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fin' fing <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="skolem">g'</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_default_in_finfun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g</span> <span class="main">=</span> map_default <span class="skolem">b</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> fing bran fin' ran' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI2<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">OF</span></span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> b'b <span class="main">=</span> True

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="free">a'</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="free">a'</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> bfin b'b <span class="keyword1"><span class="command">have</span></span> fing'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq Collect_imp_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> brang'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="var">?g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def restrict_map_def<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="var">?g'</span> <span class="bound">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="skolem">b</span> <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> upd_left_comm upd_left_comm fing'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_rec_cong1<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def b'b b map_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">interpret</span></span> gwf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="free">a'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> b'b <span class="keyword1"><span class="command">have</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g'</span> <span class="main">=</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> a'ndomg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">∉</span> dom <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> f b'b b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> g'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_default_update_const<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fing a'ndomg map_le_refl<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> domg<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?g</span> <span class="main">=</span> insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> False b'b <span class="keyword1"><span class="command">have</span></span> a'ndomg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">∉</span> dom <span class="var">?g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="free">upd</span> <span class="free">a'</span> <span class="main">(</span><span class="var">?b</span> <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fing' a'ndomg' <span class="keyword1"><span class="command">unfolding</span></span> b'b <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gwf.fold_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a'</span> <span class="skolem">b</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">upd</span> <span class="free">a'</span> <span class="skolem">b</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a'</span> <span class="main">(</span><span class="var">?b</span> <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> b'b <span class="keyword1"><span class="command">have</span></span> g'leg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def map_le_def<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> map_default_update_twice<span class="main">[</span><span class="operator">OF</span> fing' a'ndomg' this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> map_default_update_const<span class="main">[</span><span class="operator">OF</span> fing' a'ndomg' g'leg<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> b'b domg<span class="main">[</span><span class="operator">unfolded</span> b'b<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"The <span class="main">(</span><span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> f y b b'b brang' fing' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="var">?g'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> fin'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ran'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="skolem">g'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> fin' fing' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="skolem">g'</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g'</span> <span class="main">∈</span> finfun"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_default_in_finfun<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq f b'b b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g'</span> <span class="main">=</span> map_default <span class="skolem">b</span> <span class="skolem">g'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fing' brang' fin' ran' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="var">?g'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI2<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">OF</span></span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_rec_def Let_def b gg<span class="main">[</span><span class="operator">unfolded</span> g b<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> bfin b'b b
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> finfun_default_update_const map_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> b'b <span class="main">=</span> this
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span><span class="main">(</span><span class="free">a'</span> <span class="main">↦</span> <span class="free">b'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> fing <span class="keyword1"><span class="command">have</span></span> fing'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="var">?g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> bran b'b <span class="keyword1"><span class="command">have</span></span> bnrang'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="var">?g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ffmg'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g'</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">(</span><span class="free">a'</span> <span class="main">:=</span> <span class="free">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def restrict_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> f y <span class="keyword1"><span class="command">have</span></span> f_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="var">?g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"The <span class="main">(</span><span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> fing' bnrang' f_Abs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="var">?g'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def restrict_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fin'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> brang'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> fing' fin' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g'</span> <span class="main">∈</span> finfun"</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="skolem">g'</span> <span class="main">∈</span> finfun"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_default_in_finfun<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> f' f_Abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="skolem">g'</span> <span class="main">=</span> map_default <span class="skolem">b</span> <span class="var">?g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> fin' brang' fing' bnrang' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="var">?g'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI2<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">OF</span></span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">y</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">(</span><span class="free">a'</span> <span class="main">↦</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">a'</span> <span class="main">(</span>dom <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">y</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="free">a'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> a'ndomg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">∉</span> dom <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> f y b'b True <span class="keyword1"><span class="command">have</span></span> yff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> map_default <span class="skolem">b</span> <span class="main">(</span><span class="var">?g'</span> <span class="main">|`</span> dom <span class="var">?g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def map_default_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="skolem">b</span> <span class="main">(</span><span class="var">?g'</span> <span class="main">|`</span> dom <span class="var">?g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">interpret</span></span> g'wf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> upd_left_comm upd_left_comm fing
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span> <span class="main">=</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_rec_cong1<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def b'b True map_default_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_rec_def Let_def finfun_default_update_const b<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> g' g<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> gg g'wf.fold_insert<span class="main">[</span><span class="operator">OF</span> fing a'ndomg<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">cnst</span> <span class="skolem">b</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> dom<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">upd</span></span></span> <span class="free"><span class="free"><span class="free">a'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span> <span class="main">=</span> dom <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span><span class="main">(</span><span class="free">a'</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_default <span class="skolem">b</span> <span class="var">?g''</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> domg<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?g</span> <span class="main">=</span> insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> a'ndomg''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">∉</span> dom <span class="var">?g''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> fing''<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fing<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> bnrang''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ran <span class="var">?g''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def restrict_map_def<span class="main">)</span>
        <span class="keyword1"><span class="command">interpret</span></span> gwf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
        <span class="keyword1"><span class="command">interpret</span></span> g'wf<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> upd_left_comm<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span><span class="free">upd</span> <span class="free">a'</span> <span class="main">(</span><span class="var">?b</span> <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> gwf.fold_insert<span class="main">[</span><span class="operator">OF</span> fing'' a'ndomg''<span class="main">]</span> f <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> g''leg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">|`</span> dom <span class="var">?g''</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_le_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="var">?g</span> <span class="main">|`</span> dom <span class="var">?g''</span><span class="main">)</span> <span class="main">=</span> dom <span class="var">?g''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> map_default_update_twice<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">|`</span> dom <span class="var">?g''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="free">a'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d''<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?g</span>"</span></span><span class="main">,</span>
                                     <span class="operator">unfolded</span> this<span class="main">,</span> <span class="operator">OF</span> fing'' a'ndomg'' g''leg<span class="main">]</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="var">?b'</span> <span class="free">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> upd_left_comm upd_left_comm fing''
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span> <span class="main">=</span>
          Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_rec_cong1<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def b'b map_default_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     <span class="free">upd</span> <span class="free">a'</span> <span class="main">(</span><span class="var">?b'</span> <span class="free">a'</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> g'wf.fold_insert<span class="main">[</span><span class="operator">OF</span> fing'' a'ndomg''<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> domg <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b'</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">a'</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                    <span class="free">upd</span> <span class="free">a'</span> <span class="free">b'</span> <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="main">(</span><span class="var">?b</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>dom <span class="var">?g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_rec_def Let_def finfun_default_update_const b<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> g<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> g' dom<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> b'b gg <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> finfun_rec_wf <span class="main">=</span> finfun_rec_wf_aux <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> const_update_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⟹</span> Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">a</span> <span class="free">b'</span><span class="main">)</span> <span class="main">(</span><span class="free">cnst</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="free">cnst</span> <span class="free">b'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="FinFun-finfun_rec_const"><span class="command">lemma</span></span> finfun_rec_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_rec <span class="free">cnst</span> <span class="free">upd</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnst</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_const<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">g</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="free">c</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∉</span> ran <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="free">c</span> Map.empty<span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom Map.empty<span class="main">)</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∉</span> ran Map.empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="free">c</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom <span class="skolem">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∉</span> ran <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default <span class="free">c</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> ran <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> g map_default_in_finfun<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">c</span> <span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default <span class="free">c</span> Map.empty <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI2<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">OF</span></span> refl<span class="main"><span class="main">]</span></span> fin ran<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_rec_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> default<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_default <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_const<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?the</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default undefined <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> undefined <span class="main">∉</span> ran <span class="bound">g</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> undefined"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> the<span class="main">:</span> <span class="quoted"><span class="quoted">"The <span class="var">?the</span> <span class="main">=</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="skolem">g'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default undefined <span class="skolem">g'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"undefined <span class="main">∉</span> ran <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default undefined <span class="skolem">g'</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_default_in_finfun<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default undefined <span class="skolem">g'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> Map.empty"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin g<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_rec_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite UNIV›</span></span> True
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def the default <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> the<span class="main">:</span> <span class="quoted"><span class="quoted">"The <span class="var">?the</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> Some <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> Some <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_default_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> finfun_const_def dom_def ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?the</span> <span class="skolem">g'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span>map_default undefined <span class="skolem">g'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"undefined <span class="main">∉</span> ran <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default undefined <span class="skolem">g'</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_default_in_finfun<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_default undefined <span class="skolem">g'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True False <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> Some <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> map_default_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin g<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def ran_def map_default_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_rec_def <span class="keyword1"><span class="command">using</span></span> True False
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def the default <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def map_default_def const_update_all<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak induction rule and case analysis for FinFuns›</span></span>

<span class="keyword1" id="FinFun-finfun_weak_induct"><span class="command">lemma</span></span> finfun_weak_induct <span class="main">[</span><span class="operator">consumes</span> 0<span class="main">,</span> <span class="operator">case_names</span> const update<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Abs_finfun_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs_finfun <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> finfun›</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="skolem">y</span> <span class="main">=</span> finfun_const <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> finfun  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Abs_finfun <span class="bound">y</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> y <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> finfun›</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹insert <span class="skolem">a</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">y</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">a'</span> <span class="main">≠</span> <span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>finfun_update <span class="main">(</span>Abs_finfun <span class="main">(</span><span class="skolem">y</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">y</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> update<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">unfolding</span></span> finfun_update_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_exhaust_disj"><span class="command">lemma</span></span> finfun_exhaust_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> finfun_const <span class="bound">b</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> finfun_update <span class="bound">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="FinFun-finfun_exhaust"><span class="command">lemma</span></span> finfun_exhaust<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> finfun_exhaust_disj<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_rec_unique"><span class="command">lemma</span></span> finfun_rec_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnst</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">g</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="bound">g</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">(</span><span class="free">f</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">f'</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnst</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f'</span> <span class="main">(</span><span class="bound">g</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">upd</span> <span class="bound">g</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">g</span> <span class="main">=</span> <span class="free">f'</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c u c' u'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function application›</span></span>

<span class="keyword1"><span class="command">notation</span></span> finfun_apply <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 999<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_apply_aux<span class="main">:</span> finfun_rec_wf_aux <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_apply<span class="main">:</span> finfun_rec_wf <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span> <span class="skolem">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> If <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finfun_apply_aux.upd_left_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> If <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">b'</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="skolem">b'</span> <span class="keyword1">else</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> If <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">b'</span><span class="main">)</span> <span class="skolem">b</span> UNIV <span class="main">=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_apply_def"><span class="command">lemma</span></span> finfun_apply_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">a</span><span class="main">.</span> finfun_rec <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finfun_rec_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">then</span> <span class="skolem">b</span> <span class="keyword1">else</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def fun_upd_finfun Abs_finfun_inverse finfun_apply<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FinFun-finfun_upd_apply"><span class="command">lemma</span></span> finfun_upd_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="free">a'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">$</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_upd_apply_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="free">a'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">$</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_apply_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_const_apply"><span class="command">lemma</span></span> finfun_const_apply <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_apply_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_upd_apply_same"><span class="command">lemma</span></span> finfun_upd_apply_same <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_upd_apply_other"><span class="command">lemma</span></span> finfun_upd_apply_other <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="free">a'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_ext"><span class="command">lemma</span></span> finfun_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_apply_inject<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="FinFun-expand_finfun_eq"><span class="command">lemma</span></span> expand_finfun_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">($)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">($)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finfun_ext<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_upd_triv"><span class="command">lemma</span></span> finfun_upd_triv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">$:=</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_const_inject"><span class="command">lemma</span></span> finfun_const_inject <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b'</span><span class="main">)</span> <span class="main">≡</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_const_eq_update"><span class="command">lemma</span></span> finfun_const_eq_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">=</span> <span class="free">b'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a'</span><span class="main">.</span> <span class="free">a</span> <span class="main">≠</span> <span class="bound">a'</span> <span class="main">⟶</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function composition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="keyword1">⇒f</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∘$</span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">∘$</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>  <span class="main">=</span> finfun_rec <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  finfun_comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">o$</span>"</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_comp_aux<span class="main">:</span> finfun_rec_wf_aux <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finfun_ext<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_comp<span class="main">:</span> finfun_rec_wf <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span> <span class="skolem">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'c</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set"</span></span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'c</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span>
      Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="skolem">b'</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def Abs_finfun_inverse_finite fun_upd_def Abs_finfun_inject_finite fun_eq_iff fin<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'c</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_comp_const"><span class="command">lemma</span></span> finfun_comp_const <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘$</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp_update"><span class="command">lemma</span></span> finfun_comp_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘$</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘$</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_comp_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘$</span> <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> finfun_update_code <span class="main">(</span><span class="free">g</span> <span class="main">∘$</span> <span class="free">f</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">g</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp_apply"><span class="command">lemma</span></span> finfun_comp_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘$</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp_comp_collapse"><span class="command">lemma</span></span> finfun_comp_comp_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘$</span> <span class="free">g</span> <span class="main">∘$</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="FinFun-finfun_comp_const1"><span class="command">lemma</span></span> finfun_comp_const1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finfun_ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp_id1"><span class="command">lemma</span></span> finfun_comp_id1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"id <span class="main">∘$</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FinFun-finfun_comp_conv_comp"><span class="command">lemma</span></span> finfun_comp_conv_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘$</span> <span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">g</span> <span class="main">∘$</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Abs_finfun <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finfun_rec_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">g</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp_def o_def<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="skolem">g'</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Abs_finfun <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="skolem">g'</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> Abs_finfun <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> g' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">($)</span> <span class="skolem">g'</span><span class="main">)</span> <span class="main">∈</span> finfun"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_left_compose<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∘</span> <span class="skolem">y</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="skolem">y</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="free">g</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp_def finfun_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_comp2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$∘</span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">$∘</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">($)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  finfun_comp2  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$o</span>"</span> 55<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp2_const"><span class="command">lemma</span></span> finfun_comp2_const <span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_comp2 <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp2_def finfun_const_def comp_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_comp2_update"><span class="command">lemma</span></span> finfun_comp2_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_comp2 <span class="main">(</span><span class="free">g</span><span class="main">(</span><span class="free">b</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">∈</span> range <span class="free">f</span> <span class="keyword1">then</span> <span class="main">(</span>finfun_comp2 <span class="free">g</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span>inv <span class="free">f</span> <span class="free">b</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">else</span> finfun_comp2 <span class="free">g</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> range <span class="free">f</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">($)</span> <span class="free">g</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">($)</span> <span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inj True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp2_def finfun_update_def finfun_right_compose<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">($)</span> <span class="free">g</span><span class="main">)</span><span class="main">(</span><span class="free">b</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">($)</span> <span class="free">g</span> <span class="main">∘</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp2_def finfun_update_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Universal quantification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_All_except</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> bool <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_All_except</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">$</span> <span class="bound">a</span>"</span></span>

<span class="keyword1" id="FinFun-finfun_All_except_const"><span class="command">lemma</span></span> finfun_All_except_const<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_All_except <span class="free">A</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∨</span> set <span class="free">A</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_except_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_All_except_const_finfun_UNIV_code"><span class="command">lemma</span></span> finfun_All_except_const_finfun_UNIV_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_All_except <span class="free">A</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">∨</span> is_list_UNIV <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_except_const is_list_UNIV_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_All_except_update"><span class="command">lemma</span></span> finfun_All_except_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_All_except <span class="free">A</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">∈</span> set <span class="free">A</span> <span class="main">∨</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> finfun_All_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_except_def finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_All_except_update_code"><span class="command">lemma</span></span> finfun_All_except_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> card_UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_All_except <span class="free">A</span> <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">∈</span> set <span class="free">A</span> <span class="main">∨</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> finfun_All_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_except_update<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_All</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> bool <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finfun_All</span> <span class="main">=</span> finfun_All_except <span class="main">[]</span>"</span></span>

<span class="keyword1" id="FinFun-finfun_All_const"><span class="command">lemma</span></span> finfun_All_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_All <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_def finfun_All_except_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_All_update"><span class="command">lemma</span></span> finfun_All_update<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_All <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">∧</span> finfun_All_except <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_def finfun_All_except_update<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_All_All"><span class="command">lemma</span></span> finfun_All_All<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_All <span class="free">P</span> <span class="main">=</span> All <span class="main">(</span><span class="main">($)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_All_def finfun_All_except_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> bool <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finfun_Ex</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Not <span class="main">(</span>finfun_All <span class="main">(</span>Not <span class="main">∘$</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFun-finfun_Ex_Ex"><span class="command">lemma</span></span> finfun_Ex_Ex<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_Ex <span class="free">P</span> <span class="main">=</span> Ex <span class="main">(</span><span class="main">($)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finfun_Ex_def finfun_All_All <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FinFun-finfun_Ex_const"><span class="command">lemma</span></span> finfun_Ex_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_Ex <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ex_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A diagonal operator for FinFuns›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Diag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">'($</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">$')</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">($</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main"><span class="free">$)</span></span> <span class="main">=</span> finfun_rec <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pair <span class="bound">b</span> <span class="main">∘$</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_Diag_aux<span class="main">:</span> finfun_rec_wf_aux <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pair <span class="bound">b</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_Diag<span class="main">:</span> finfun_rec_wf <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Pair <span class="bound">b</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span> <span class="skolem">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'c</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finfun_Diag_aux.upd_left_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pair <span class="skolem">b</span> <span class="main">∘$</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span>
      Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="skolem">b'</span> <span class="keyword1">else</span> <span class="skolem">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def finfun_comp_conv_comp o_def<span class="main"><span class="keyword3">,</span></span>
                 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def Abs_finfun_inverse_finite fun_upd_def Abs_finfun_inject_finite fun_eq_iff fin<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pair <span class="skolem">b</span> <span class="main">∘$</span> <span class="free">g</span><span class="main">)</span> UNIV <span class="main">=</span> Pair <span class="skolem">b'</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def finfun_comp_conv_comp o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_Diag_const1"><span class="command">lemma</span></span> finfun_Diag_const1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> Pair <span class="free">b</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Do not use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> finfun_Diag_const1<span class="antiquote"><span class="antiquote">}</span></span></span></span> for the code generator because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Pair <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is injective, i.e. if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is free of redundant updates, there is no need to check for redundant updates as is done for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(∘$)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="FinFun-finfun_Diag_const_code"><span class="command">lemma</span></span> finfun_Diag_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">$)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> finfun_update_code <span class="free">g</span> <span class="free">a</span> <span class="free">c</span><span class="main">$)</span> <span class="main">=</span> finfun_update_code <span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="free">a</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_update1"><span class="command">lemma</span></span> finfun_Diag_update1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_Diag_update1_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_const2"><span class="command">lemma</span></span> finfun_Diag_const2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">$)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finfun_ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply finfun_Diag_const1 finfun_Diag_update1<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_update2"><span class="command">lemma</span></span> finfun_Diag_update2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finfun_ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply finfun_Diag_const1 finfun_Diag_update1<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_const_const"><span class="command">lemma</span></span> finfun_Diag_const_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">$)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_const_update"><span class="command">lemma</span></span> finfun_Diag_const_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_update_const"><span class="command">lemma</span></span> finfun_Diag_update_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_update_update"><span class="command">lemma</span></span> finfun_Diag_update_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">$)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">then</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">a'</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="free">a'</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_update1 finfun_Diag_update2<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_apply"><span class="command">lemma</span></span> finfun_Diag_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1 finfun_Diag_update1 finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_conv_Abs_finfun"><span class="command">lemma</span></span> finfun_Diag_conv_Abs_finfun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">.</span> <span class="main">($</span><span class="bound">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Abs_finfun <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finfun_rec_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pair <span class="skolem">c</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_comp_conv_comp o_def finfun_const_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g'</span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g'</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g'</span> <span class="main">$</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="free">g</span> <span class="main">$</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def fun_eq_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1 finfun_Diag_update1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_Diag_eq"><span class="command">lemma</span></span> finfun_Diag_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="main">($</span><span class="free">f'</span><span class="main">,</span> <span class="free">g'</span><span class="main">$)</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_fst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fst <span class="main">∘$</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="FinFun-finfun_fst_const"><span class="command">lemma</span></span> finfun_fst_const<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">(</span><span class="keyword1">K$</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> fst <span class="free">bc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_fst_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_fst_update"><span class="command">lemma</span></span> finfun_fst_update<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">bc</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_fst <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> fst <span class="free">bc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_fst_update_code<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_fst <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> fst <span class="free">bc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_fst_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_fst_comp_conv"><span class="command">lemma</span></span> finfun_fst_comp_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">(</span><span class="free">f</span> <span class="main">∘$</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_fst_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_fst_conv"><span class="command">lemma</span></span> finfun_fst_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1 finfun_fst_comp_conv o_def finfun_Diag_update1 finfun_fst_update<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_fst_conv_Abs_finfun"><span class="command">lemma</span></span> finfun_fst_conv_Abs_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_fst <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Abs_finfun <span class="main">(</span>fst <span class="main">∘</span> <span class="main">($)</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_fst_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> finfun_comp_conv_comp<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_snd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_snd</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> snd <span class="main">∘$</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="FinFun-finfun_snd_const"><span class="command">lemma</span></span> finfun_snd_const<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">(</span><span class="keyword1">K$</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> snd <span class="free">bc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_snd_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_snd_update"><span class="command">lemma</span></span> finfun_snd_update<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">bc</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_snd <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> snd <span class="free">bc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_snd_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_snd <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> snd <span class="free">bc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_snd_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_snd_comp_conv"><span class="command">lemma</span></span> finfun_snd_comp_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">(</span><span class="free">f</span> <span class="main">∘$</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘$</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_snd_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_snd_conv"><span class="command">lemma</span></span> finfun_snd_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Diag_const1 finfun_snd_comp_conv o_def finfun_Diag_update1 finfun_snd_update finfun_upd_apply <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finfun_ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FinFun-finfun_snd_conv_Abs_finfun"><span class="command">lemma</span></span> finfun_snd_conv_Abs_finfun<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_snd <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Abs_finfun <span class="main">(</span>snd <span class="main">∘</span> <span class="main">($)</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_snd_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> finfun_comp_conv_comp<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Diag_collapse"><span class="command">lemma</span></span> finfun_Diag_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($</span>finfun_fst <span class="free">f</span><span class="main">,</span> finfun_snd <span class="free">f</span><span class="main">$)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_fst_const finfun_snd_const finfun_fst_update finfun_snd_update finfun_Diag_update_update<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Currying for FinFuns›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_curry</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_curry</span> <span class="main">=</span> finfun_rec <span class="main">(</span>finfun_const <span class="main">∘</span> finfun_const<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_curry_aux<span class="main">:</span> finfun_rec_wf_aux <span class="quoted"><span class="quoted">"finfun_const <span class="main">∘</span> finfun_const"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def finfun_update_twist finfun_upd_apply split_paired_all finfun_update_const_same<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> finfun_curry<span class="main">:</span> finfun_rec_wf <span class="quoted"><span class="quoted">"finfun_const <span class="main">∘</span> finfun_const"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span> <span class="skolem">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> fin1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'c</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> UNIV_Times_UNIV<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_cartesian_productD1 finite_cartesian_productD2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Abs_finfun_inverse_finite<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> Abs_finfun_inverse_finite<span class="main">[</span><span class="operator">OF</span> fin1<span class="main">]</span> Abs_finfun_inverse_finite<span class="main">[</span><span class="operator">OF</span> fin2<span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finfun_curry_aux.upd_left_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>finfun_const <span class="main">∘</span> finfun_const<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">b''</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b''</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="skolem">b'</span> <span class="keyword1">else</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_update_def finfun_const_def split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs_finfun"</span></span><span class="main"><span class="main">]</span></span> ext<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">a</span><span class="main">)</span><span class="main">(</span><span class="bound">b</span> <span class="main">$:=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>finfun_const <span class="main">∘</span> finfun_const<span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">(</span>finfun_const <span class="main">∘</span> finfun_const<span class="main">)</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_curry_const"><span class="command">lemma</span></span> finfun_curry_const <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_curry <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_curry_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_curry_update"><span class="command">lemma</span></span> finfun_curry_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_curry <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_curry <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span>finfun_curry <span class="free">f</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">(</span><span class="free">b</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finfun_curry_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_curry <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_curry <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span>finfun_curry <span class="free">f</span> <span class="main">$</span> <span class="free">a</span><span class="main">)</span><span class="main">(</span><span class="free">b</span> <span class="main">$:=</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_curry_def<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_Abs_finfun_curry"><span class="command">lemma</span></span> finfun_Abs_finfun_curry<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> finfun"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> curry <span class="free">f</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound">ab</span><span class="main">.</span> <span class="free">f</span> <span class="bound">ab</span> <span class="main">≠</span> <span class="skolem">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curry_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fin c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span>  Abs_finfun <span class="main">(</span>curry <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def finfun_curry<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> finfun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_curry_conv_curry"><span class="command">lemma</span></span> finfun_curry_conv_curry<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_curry <span class="free">f</span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span>finfun_apply <span class="free">f</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> finfun
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_curry <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'c</span><span class="main">.</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span>finfun_apply <span class="bound">f</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finfun_rec_unique<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finfun_curry <span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finfun_curry <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_curry <span class="skolem">f</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">a</span> <span class="main">$:=</span> <span class="main">(</span>finfun_curry <span class="skolem">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>snd <span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span>finfun_apply <span class="main">(</span><span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="keyword1">K$</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_curry_def finfun_const_def curry_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">aa</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span><span class="main">($)</span> <span class="skolem">g</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="bound">aa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span><span class="main">($)</span> <span class="skolem">g</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>
      fst <span class="skolem">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="main">(</span>Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Abs_finfun <span class="main">(</span>curry <span class="main">(</span><span class="main">($)</span> <span class="skolem">g</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>snd <span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Abs_finfun</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_curry_def finfun_update_def finfun_Abs_finfun_curry<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable equality for FinFuns›</span></span>

<span class="keyword1" id="FinFun-eq_finfun_All_ext"><span class="command">lemma</span></span> eq_finfun_All_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> finfun_All <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_All_All o_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> finfun <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>card_UNIV<span class="main">,</span>equal<span class="main">}</span>"</span></span><span class="main">,</span><span class="quoted">equal</span><span class="main">)</span> <span class="quoted">equal</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> eq_finfun_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.equal <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> finfun_All <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">$)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_finfun_All_ext eq_finfun_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">nbe</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOL.equal <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">_</span> <span class="keyword1">⇒f</span> <span class="main">_</span><span class="main">)</span> <span class="free">f</span> <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> equal_refl<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An operator that explicitly removes all redundant updates in the generated representations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_clearjunk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_clearjunk</span> <span class="main">=</span> id"</span></span>

<span class="keyword1" id="FinFun-finfun_clearjunk_const"><span class="command">lemma</span></span> finfun_clearjunk_const <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_clearjunk <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FinFun-finfun_clearjunk_update"><span class="command">lemma</span></span> finfun_clearjunk_update <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finfun_clearjunk <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The domain of a FinFun as a FinFun›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> bool<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_dom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Abs_finfun <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="bound">a</span> <span class="main">≠</span> finfun_default <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFun-finfun_dom_const"><span class="command">lemma</span></span> finfun_dom_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_dom <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">K$</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> undefined<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finfun_dom_def finfun_default_const
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_const_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"finfun_dom"</span></span> <span class="antiquote"><span class="antiquote">}</span></span></span></span> raises an exception when called on a FinFun whose domain is a finite type. 
  For such FinFuns, the default value (and as such the domain) is undefined.
›</span></span>

<span class="keyword1" id="FinFun-finfun_dom_const_code"><span class="command">lemma</span></span> finfun_dom_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_dom <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> card_UNIV<span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">K$</span> False<span class="main">)</span> <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_dom called on finite type''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> finfun_dom <span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_dom_const card_UNIV card_eq_0_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_dom_finfunI"><span class="command">lemma</span></span> finfun_dom_finfunI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">≠</span> finfun_default <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> finfun"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_finfun_default<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">False</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_dom_update"><span class="command">lemma</span></span> finfun_dom_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finfun_dom <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="main">(</span><span class="free">b</span> <span class="main">≠</span> finfun_default <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> finfun <span class="keyword1"><span class="command">unfolding</span></span> finfun_dom_def finfun_update_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_default_update_const finfun_dom_finfunI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> finfun_update.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply fun_eq_iff fun_upd_def finfun_default_update_const<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="FinFun-finfun_dom_update_code"><span class="command">lemma</span></span> finfun_dom_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_dom <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> finfun_update_code <span class="main">(</span>finfun_dom <span class="free">f</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">≠</span> finfun_default <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="FinFun-finite_finfun_dom"><span class="command">lemma</span></span> finite_finfun_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≠</span> undefined"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_dom_const UNIV_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Set.empty_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>update <span class="skolem">f</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="skolem">f</span><span class="main">(</span><span class="skolem">a</span> <span class="main">$:=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="main">=</span> finfun_default <span class="skolem">f</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="skolem">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="keyword1">else</span> insert <span class="skolem">a</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="skolem">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> update <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The domain of a FinFun as a sorted list›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_to_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finfun_to_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFun-set_finfun_to_list"><span class="command">lemma</span></span> set_finfun_to_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> sorted_finfun_to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct_finfun_to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis3</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span> <span class="main">∧</span> <span class="var">?thesis2</span> <span class="main">∧</span> <span class="var">?thesis3</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finfun_to_list_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> finite_sorted_distinct_unique finite_finfun_dom<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finfun_const_False_conv_bot"><span class="command">lemma</span></span> finfun_const_False_conv_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="keyword1">K$</span> False<span class="main">)</span> <span class="main">=</span> bot"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FinFun-finfun_const_True_conv_top"><span class="command">lemma</span></span> finfun_const_True_conv_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="keyword1">K$</span> True<span class="main">)</span> <span class="main">=</span> top"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="FinFun-finfun_to_list_const"><span class="command">lemma</span></span> finfun_to_list_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_to_list <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linorder<span class="main">}</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> undefined <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">THE</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> UNIV <span class="main">∧</span> sorted <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_to_list_def finfun_const_False_conv_bot finfun_const_True_conv_top finfun_dom_const<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_to_list_const_code"><span class="command">lemma</span></span> finfun_to_list_const_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_to_list <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linorder<span class="main">,</span> card_UNIV<span class="main">}</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_to_list called on finite type''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> finfun_to_list <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="free">c</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_to_list_const card_UNIV card_eq_0_iff<span class="main">)</span>

<span class="keyword1" id="FinFun-remove1_insort_insert_same"><span class="command">lemma</span></span> remove1_insort_insert_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> remove1 <span class="free">x</span> <span class="main">(</span>insort_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insort_insert_insort remove1_insort<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_dom_conv"><span class="command">lemma</span></span> finfun_dom_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">$</span> <span class="free">x</span> <span class="main">≠</span> finfun_default <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finfun_weak_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_dom_const finfun_default_const finfun_default_update_const finfun_upd_apply<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_to_list_update"><span class="command">lemma</span></span> finfun_to_list_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_to_list <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> finfun_default <span class="free">f</span> <span class="keyword1">then</span> List.remove1 <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> List.insort_insert <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> finfun_to_list_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> the_equality<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="skolem">xs</span> <span class="main">∧</span> distinct <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> finfun_default <span class="free">f</span> <span class="keyword1">then</span> remove1 <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> insort_insert <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> finfun_default <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_to_list <span class="free">f</span> <span class="main">=</span> insort_insert <span class="free">a</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finfun_to_list_def
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insort_insert <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_insort_insert<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="keyword1"><span class="command">also</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>insort_insert <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="main">(</span>insort_insert <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>insort_insert <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_insort_insert distinct_insort_insert<span class="main">)</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="skolem">xs'</span> <span class="main">∧</span> distinct <span class="skolem">xs'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> insort_insert <span class="free">a</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_insort_insert_same<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_dom_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_upd_apply<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_to_list <span class="free">f</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f finfun_to_list_def
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> the_equality<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> eq False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_idem<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_to_list <span class="free">f</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finfun_to_list_def
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_dom <span class="free">f</span> <span class="main">=</span> finfun_dom <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False True
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff finfun_upd_apply<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="skolem">xs</span> <span class="main">∧</span> distinct <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> finfun_dom_update<span class="main">)</span>
        
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="skolem">xs'</span> <span class="main">∧</span> distinct <span class="skolem">xs'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False True eq <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_insert_triv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finfun_to_list <span class="free">f</span> <span class="main">=</span> remove1 <span class="free">a</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finfun_to_list_def
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> the_equality<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="keyword1"><span class="command">also</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_upd_apply <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove1 <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="main">(</span>remove1 <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>remove1 <span class="free">a</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_remove1<span class="main">)</span>
        
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> finfun_dom <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> sorted <span class="skolem">xs'</span> <span class="main">∧</span> distinct <span class="skolem">xs'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> remove1 <span class="free">a</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False eq <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> finfun_default <span class="free">f</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_insert_insort insort_remove1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_finfun_to_list sorted_finfun_to_list sorted_remove1 set_insort_insert sorted_insort_insert distinct_insort_insert finfun_upd_apply <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="FinFun-finfun_to_list_update_code"><span class="command">lemma</span></span> finfun_to_list_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_to_list <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> finfun_default <span class="free">f</span> <span class="keyword1">then</span> List.remove1 <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span> <span class="keyword1">else</span> List.insort_insert <span class="free">a</span> <span class="main">(</span>finfun_to_list <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_to_list_update<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More type class instantiations›</span></span>

<span class="keyword1" id="FinFun-card_eq_1_iff"><span class="command">lemma</span></span> card_eq_1_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_ge_0_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> neq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">=</span> card <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> theI the_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-card_UNIV_finfun"><span class="command">lemma</span></span> card_UNIV_finfun<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">==</span> finfun <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">^</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">∨</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> undefined"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_eq_1_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def F_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">undefined</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_def card_gt_0_iff F_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> card <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> type_definition.Abs_image<span class="main">[</span><span class="operator">OF</span> type_definition_finfun<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_image inj_onI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject F_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_fun<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> infinite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> b <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">≠</span> <span class="skolem">b2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_eq_1_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">a'</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span> <span class="keyword1">then</span> <span class="skolem">b1</span> <span class="keyword1">else</span> <span class="skolem">b2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> infinite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_nn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ conjI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> type_definition.Abs_image<span class="main">[</span><span class="operator">OF</span> type_definition_finfun<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> F_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_finfun_inject<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="var">?f</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def finfun_def <span class="quoted"><span class="quoted">‹<span class="skolem">b1</span> <span class="main">≠</span> <span class="skolem">b2</span>›</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quoted"><span class="quoted">‹<span class="skolem">b1</span> <span class="main">≠</span> <span class="skolem">b2</span>›</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">K$</span> <span class="bound">b</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FinFun-finite_UNIV_finfun"><span class="command">lemma</span></span> finite_UNIV_finfun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> set<span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span>finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">∨</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_UNIV_finfun<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> finfun <span class="main">::</span> <span class="main">(</span><span class="quoted">finite_UNIV</span><span class="main">,</span> <span class="quoted">card_UNIV</span><span class="main">)</span> <span class="quoted">finite_UNIV</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"finite_UNIV <span class="main">=</span> <span class="keyword1">Phantom</span><span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">cb</span> <span class="main">=</span> of_phantom <span class="main">(</span>card_UNIV <span class="main">::</span> <span class="tfree">'b</span> card_UNIV<span class="main">)</span>
   <span class="keyword1">in</span> <span class="bound">cb</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> of_phantom <span class="main">(</span>finite_UNIV <span class="main">::</span> <span class="tfree">'a</span> finite_UNIV<span class="main">)</span> <span class="main">∧</span> <span class="bound">cb</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_UNIV_finfun_def Let_def card_UNIV finite_UNIV finite_UNIV_finfun card_gt_0_iff<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> finfun <span class="main">::</span> <span class="main">(</span><span class="quoted">card_UNIV</span><span class="main">,</span> <span class="quoted">card_UNIV</span><span class="main">)</span> <span class="quoted">card_UNIV</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"card_UNIV <span class="main">=</span> <span class="keyword1">Phantom</span><span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ca</span> <span class="main">=</span> of_phantom <span class="main">(</span>card_UNIV <span class="main">::</span> <span class="tfree">'a</span> card_UNIV<span class="main">)</span><span class="main">;</span>
       <span class="bound">cb</span> <span class="main">=</span> of_phantom <span class="main">(</span>card_UNIV <span class="main">::</span> <span class="tfree">'b</span> card_UNIV<span class="main">)</span>
   <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">ca</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">cb</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">cb</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="bound">cb</span> <span class="main">^</span> <span class="bound">ca</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_UNIV_finfun_def card_UNIV Let_def card_UNIV_finfun<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bundles for concrete syntax›</span></span>

<span class="keyword1"><span class="command">bundle</span></span> finfun_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_notation</span></span> finfun <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">⇒f</span> <span class="keyword3">/</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>22<span class="main">,</span> 21<span class="main">]</span> 21<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span>
  finfun_const <span class="main">(</span><span class="quoted">"<span class="keyword1">K$</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>0<span class="main">]</span> 1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_update <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">$:=</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_apply <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 999<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∘$</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp2 <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$∘</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_Diag <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">'($</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">$')</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  finfun_comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">o$</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp2 <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$o</span>"</span> 55<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">bundle</span></span> no_finfun_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_type_notation</span></span>
  finfun <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">⇒f</span> <span class="keyword3">/</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>22<span class="main">,</span> 21<span class="main">]</span> 21<span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span>
  finfun_const <span class="main">(</span><span class="quoted">"<span class="keyword1">K$</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>0<span class="main">]</span> 1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_update <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">$:=</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_apply <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 999<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∘$</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp2 <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$∘</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_Diag <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">'($</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">$')</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span> 
  finfun_comp <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">o$</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  finfun_comp2 <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$o</span>"</span> 55<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> no_finfun_syntax

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FinFunPred">
<div class="head">
<h1>Theory FinFunPred</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:     Andreas Lochbihler *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Predicates modelled as FinFuns›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FinFunPred
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#FinFun">FinFun</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> finfun_syntax

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instantiate FinFun predicates just like predicates›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="keyword1">⇒f</span> bool"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">ord</span><span class="main">)</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> le_finfun_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="FinFunPred-le_finfun_code"><span class="command">lemma</span></span> le_finfun_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟷</span> finfun_All <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">$)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_finfun_def finfun_All_All o_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">preorder</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_finfun_def le_finfun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">order</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_finfun_def order_antisym_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finfun_ext<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">order_bot</span><span class="main">)</span> <span class="quoted">order_bot</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"bot <span class="main">=</span> finfun_const bot"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_finfun_def le_finfun_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-bot_finfun_apply"><span class="command">lemma</span></span> bot_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> bot <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> bot<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_finfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">order_top</span><span class="main">)</span> <span class="quoted">order_top</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"top <span class="main">=</span> finfun_const top"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_finfun_def le_finfun_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-top_finfun_apply"><span class="command">lemma</span></span> top_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> top <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> top<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_finfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">inf</span><span class="main">)</span> <span class="quoted">inf</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inf <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inf <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">$)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-inf_finfun_apply"><span class="command">lemma</span></span> inf_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span>inf <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> inf <span class="main">(</span><span class="main">($)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">($)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_finfun_def o_def inf_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">sup</span><span class="main">)</span> <span class="quoted">sup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sup <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> sup <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">$)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-sup_finfun_apply"><span class="command">lemma</span></span> sup_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span>sup <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span><span class="main">($)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">($)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_finfun_def o_def sup_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">semilattice_inf</span><span class="main">)</span> <span class="quoted">semilattice_inf</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_finfun_def le_finfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">semilattice_sup</span><span class="main">)</span> <span class="quoted">semilattice_sup</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_finfun_def le_finfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">lattice</span><span class="main">)</span> <span class="quoted">lattice</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">bounded_lattice</span><span class="main">)</span> <span class="quoted">bounded_lattice</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">distrib_lattice</span><span class="main">)</span> <span class="quoted">distrib_lattice</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_finfun_def inf_finfun_def expand_finfun_eq o_def sup_inf_distrib1<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">minus</span><span class="main">)</span> <span class="quoted">minus</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> case_prod <span class="main">(-)</span> <span class="main">∘$</span> <span class="main">($</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">$)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-minus_finfun_apply"><span class="command">lemma</span></span> minus_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> <span class="free">f</span> <span class="main">-</span> <span class="main">($)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_finfun_def o_def fun_diff_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">uminus</span><span class="main">)</span> <span class="quoted">uminus</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> uminus <span class="main">∘$</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="FinFunPred-uminus_finfun_apply"><span class="command">lemma</span></span> uminus_finfun_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="main">(</span><span class="main">-</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">($)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_finfun_def o_def fun_Compl_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"finfun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">boolean_algebra</span><span class="main">)</span> <span class="quoted">boolean_algebra</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_finfun_def inf_finfun_def expand_finfun_eq sup_fun_def inf_fun_def fun_Compl_def o_def inf_compl_bot sup_compl_top diff_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Replicate predicate operations for FinFuns
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">finfun_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{}<span class="hidden">⇩</span><sub>f</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">{}<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">≡</span> bot"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">finfun_UNIV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">finfun_UNIV</span> <span class="main">≡</span> top"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_single</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> finfun_empty<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$:=</span> True<span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFunPred-finfun_single_apply"><span class="command">lemma</span></span> finfun_single_apply <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_single <span class="free">x</span> <span class="main">$</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_single_def finfun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> finfun_single_neq_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_single <span class="free">x</span> <span class="main">≠</span> bot"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> bot_neq_finfun_single<span class="main">:</span> <span class="quoted"><span class="quoted">"bot <span class="main">≠</span> finfun_single <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_finfun_eq fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_leI"><span class="command">lemma</span></span> finfun_leI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_finfun_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_leD"><span class="command">lemma</span></span> finfun_leD <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span><span class="main">;</span> <span class="free">A</span> <span class="main">$</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">$</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_finfun_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bounded quantification.
  Warning: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finfun_Ball›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>finfun_Ex›</span></span></span></span> may raise an exception, they should not be used for quickcheck
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Ball_except</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_Ball_except</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFunPred-finfun_Ball_except_const"><span class="command">lemma</span></span> finfun_Ball_except_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_Ball_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">∨</span> set <span class="free">xs</span> <span class="main">=</span> UNIV <span class="main">∨</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_ball_except''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> finfun_Ball_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_except_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Ball_except_const_finfun_UNIV_code"><span class="command">lemma</span></span> finfun_Ball_except_const_finfun_UNIV_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_Ball_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">∨</span> is_list_UNIV <span class="free">xs</span> <span class="main">∨</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_ball_except''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> finfun_Ball_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_except_def is_list_UNIV_iff<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Ball_except_update"><span class="command">lemma</span></span> finfun_Ball_except_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_Ball_except <span class="free">xs</span> <span class="main">(</span><span class="free">A</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> finfun_Ball_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_except_def finfun_upd_apply <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Ball_except_update_code"><span class="command">lemma</span></span> finfun_Ball_except_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> card_UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_Ball_except <span class="free">xs</span> <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∨</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> finfun_Ball_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">f</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_except_update<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Ball</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_Ball</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Ball <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="FinFunPred-finfun_Ball_code"><span class="command">lemma</span></span> finfun_Ball_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_Ball <span class="main">=</span> finfun_Ball_except <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_except_def finfun_Ball_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Bex_except</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_Bex_except</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="FinFunPred-finfun_Bex_except_const"><span class="command">lemma</span></span> finfun_Bex_except_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_Bex_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">≠</span> UNIV <span class="main">∧</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_Bex_except''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> finfun_Bex_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_except_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Bex_except_const_finfun_UNIV_code"><span class="command">lemma</span></span> finfun_Bex_except_const_finfun_UNIV_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finfun_Bex_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∧</span> <span class="main">¬</span> is_list_UNIV <span class="free">xs</span> <span class="main">∧</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''finfun_Bex_except''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> finfun_Bex_except <span class="free">xs</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_except_def is_list_UNIV_iff<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Bex_except_update"><span class="command">lemma</span></span> finfun_Bex_except_update<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finfun_Bex_except <span class="free">xs</span> <span class="main">(</span><span class="free">A</span><span class="main">(</span><span class="free">a</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> finfun_Bex_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_except_def finfun_upd_apply <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="FinFunPred-finfun_Bex_except_update_code"><span class="command">lemma</span></span> finfun_Bex_except_update_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> card_UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finfun_Bex_except <span class="free">xs</span> <span class="main">(</span>finfun_update_code <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> finfun_Bex_except <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">f</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_except_update<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_Bex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">finfun_Bex</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Bex <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="FinFunPred-finfun_Bex_code"><span class="command">lemma</span></span> finfun_Bex_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finfun_Bex <span class="main">=</span> finfun_Bex_except <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_except_def finfun_Bex_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Automatically replace predicate operations by finfun predicate operations where possible›</span></span>

<span class="keyword1" id="FinFunPred-iso_finfun_le"><span class="command">lemma</span></span> iso_finfun_le <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">A</span> <span class="main">≤</span> <span class="main">($)</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_finfun_def le_funD le_funI<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_less"><span class="command">lemma</span></span> iso_finfun_less <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="main">($)</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iso_finfun_le less_finfun_def less_fun_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_eq"><span class="command">lemma</span></span> iso_finfun_eq <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">($)</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> expand_finfun_eq<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_sup"><span class="command">lemma</span></span> iso_finfun_sup <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sup <span class="main">(</span><span class="main">($)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">($)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span>sup <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_disj"><span class="command">lemma</span></span> iso_finfun_disj <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">$</span> <span class="free">x</span> <span class="main">⟷</span> sup <span class="free">A</span> <span class="free">B</span> <span class="main">$</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_fun_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_inf"><span class="command">lemma</span></span> iso_finfun_inf <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inf <span class="main">(</span><span class="main">($)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">($)</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span>inf <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_conj"><span class="command">lemma</span></span> iso_finfun_conj <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">$</span> <span class="free">x</span> <span class="main">⟷</span> inf <span class="free">A</span> <span class="free">B</span> <span class="main">$</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_fun_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_empty_conv"><span class="command">lemma</span></span> iso_finfun_empty_conv <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FinFunPred-iso_finfun_UNIV_conv"><span class="command">lemma</span></span> iso_finfun_UNIV_conv <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> finfun_UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="FinFunPred-iso_finfun_upd"><span class="command">lemma</span></span> iso_finfun_upd <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">($)</span> <span class="free">A</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span><span class="free">A</span><span class="main">(</span><span class="free">x</span> <span class="main">$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_uminus"><span class="command">lemma</span></span> iso_finfun_uminus <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">($)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_minus"><span class="command">lemma</span></span> iso_finfun_minus <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred<span class="hidden">⇩</span><sub>f</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">A</span> <span class="main">-</span> <span class="main">($)</span> <span class="free">B</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Do not declare the following two theorems as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[code_unfold]›</span></span></span></span>,
  because this causes quickcheck to fail frequently when bounded quantification is used which raises an exception.
  For code generation, the same problems occur, but then, no randomly generated FinFun is usually around.
›</span></span>

<span class="keyword1" id="FinFunPred-iso_finfun_Ball_Ball"><span class="command">lemma</span></span> iso_finfun_Ball_Ball<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> finfun_Ball <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Ball_def<span class="main">)</span>

<span class="keyword1" id="FinFunPred-iso_finfun_Bex_Bex"><span class="command">lemma</span></span> iso_finfun_Bex_Bex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> finfun_Bex <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finfun_Bex_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Test code setup›</span></span>

<span class="keyword1"><span class="command">notepad</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> nat<span class="main">.</span> False<span class="main">)</span><span class="main">(</span><span class="main">1</span> <span class="main">:=</span> True<span class="main">,</span> <span class="numeral">2</span> <span class="main">:=</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">(</span><span class="numeral">3</span> <span class="main">:=</span> False<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> 
      sup <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span><span class="main">(</span><span class="main">1</span> <span class="main">:=</span> True<span class="main">,</span> <span class="numeral">5</span> <span class="main">:=</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">(</span><span class="numeral">2</span> <span class="main">:=</span> False<span class="main">,</span> <span class="numeral">3</span> <span class="main">:=</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> iso_finfun_Ball_Ball<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>
<span class="keyword1"><span class="command">notepad</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> nat<span class="main">.</span> False<span class="main">)</span><span class="main">(</span><span class="main">1</span> <span class="main">:=</span> True<span class="main">,</span> <span class="numeral">2</span> <span class="main">:=</span> True<span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">declare</span></span> iso_finfun_Ball_Ball<span class="main">[</span><span class="operator">code_unfold</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>