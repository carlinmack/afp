<div id="Efficient_Sort">
<div class="head">
<h1>Theory Efficient_Sort</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:      Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Efficient_Sort
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπGHC Version of Mergesort‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  In the following we show that the mergesort implementation
  used in GHC (see <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">üåê</span></span>‚Äπhttp://hackage.haskell.org/package/base-4.11.1.0/docs/src/Data.OldList.html#sort‚Ä∫</span></span>)
  is a correct and stable sorting algorithm. Furthermore, experimental
  data suggests that generated code for this implementation is much more
  efficient than for the implementation provided by <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">theory</span><span class="hidden">&gt;</span></span></span>‚Äπ<a href="../../HOL/HOL-Library/Multiset.html"></a><a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>‚Ä∫</span></span>.

  A high-level overview of an older version of this formalization as well as some experimental data
  is to be found in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Sternagel2012"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπDefinition of Natural Mergesort‚Ä∫</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'k</span><span class="main">::</span>linorder"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  Split a list into chunks of ascending and descending parts, where
  descending parts are reversed on the fly.
  Thus, the result is a list of sorted lists.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sequences</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">asc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">desc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">(#)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sequences</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sequences</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">‚â§</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">Œª</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">#</span> <span class="free">sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free">merge_pairs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Efficient_Sort-length_merge"><span class="command">lemma</span></span> length_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-length_merge_pairs"><span class="command">lemma</span></span> length_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge_pairs <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> length <span class="free">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">merge_all</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_all</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_all</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free">merge_all</span> <span class="main">(</span>merge_pairs <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msort_key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">msort_key</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge_all <span class="main">(</span>sequences <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe Functional Argument of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> asc<span class="antiquote"><span class="antiquote">}</span></span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‚Äπ</span></span>f‚Ä∫</span></span></span></span> is a function that only adds some prefix to a given list.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ascP</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Efficient_Sort-ascP_Cons"><span class="command">lemma</span></span> ascP_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="main">(</span><span class="main">(#)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ascP_def<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-ascP_comp_append_Cons"><span class="command">lemma</span></span> ascP_comp_append_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ascP <span class="main">(</span><span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">[]</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascP_def<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-ascP_f_Cons"><span class="command">lemma</span></span> ascP_f_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[]</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚ÄπascP <span class="free">f</span>‚Ä∫</span></span> <span class="main">[</span><span class="operator">unfolded</span> ascP_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Efficient_Sort-ascP_comp_Cons"><span class="command">lemma</span></span> ascP_comp_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ascP <span class="main">(</span><span class="main">Œª</span><span class="bound">ys</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> ascP_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ascP_f_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Efficient_Sort-ascP_f_singleton"><span class="command">lemma</span></span> ascP_f_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ascP_f_Cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFacts about Lengths‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> length_sequences<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sequences <span class="free">xs</span><span class="main">)</span> <span class="main">‚â§</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> length <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Efficient_Sort-length_concat_merge_pairs"><span class="command">lemma</span></span> length_concat_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>merge_pairs <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFunctional Correctness‚Ä∫</span></span>

<span class="keyword1" id="Efficient_Sort-mset_merge"><span class="command">lemma</span></span> mset_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-set_merge"><span class="command">lemma</span></span> set_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">‚à™</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> set_mset_mset<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-mset_concat_merge_pairs"><span class="command">lemma</span></span> mset_concat_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="main">(</span>merge_pairs <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Efficient_Sort-set_concat_merge_pairs"><span class="command">lemma</span></span> set_concat_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat <span class="main">(</span>merge_pairs <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> set_mset_mset<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-mset_merge_all"><span class="command">lemma</span></span> mset_merge_all <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>merge_all <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_all.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-set_merge_all"><span class="command">lemma</span></span> set_merge_all <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge_all <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> set_mset_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> mset_seqeuences <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="main">(</span>sequences <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mset_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> mset <span class="main">(</span>concat <span class="main">(</span>asc <span class="free">x</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mset_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="main">(</span>desc <span class="free">x</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascP_f_singleton<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-mset_msort_key"><span class="command">lemma</span></span> mset_msort_key<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>msort_key <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-sorted_merge"><span class="command">lemma</span></span> sorted_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-sorted_merge_pairs"><span class="command">lemma</span></span> sorted_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">xs</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>merge_pairs <span class="free">xs</span><span class="main">)</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-sorted_merge_all"><span class="command">lemma</span></span> sorted_merge_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">xs</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>merge_all <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_all.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> sorted_sequences<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> set <span class="main">(</span>sequences <span class="free">xs</span><span class="main">)</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sorted_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">‚â§</span> <span class="free">key</span> <span class="free">a</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sorted_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="free">a</span> <span class="main">‚â§</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascP_f_singleton sorted_append not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-sorted_msort_key"><span class="command">lemma</span></span> sorted_msort_key<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>msort_key <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> msort_key.simps<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> sorted_merge_all sorted_sequences<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπStability‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> filter_by_key_sequences <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="main">(</span>sequences <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> filter_by_key_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> filter_by_key_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="free">xs</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="free">a</span> <span class="main">‚â§</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">a</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def ascP_f_Cons <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="main">(</span>desc <span class="skolem">b</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="skolem">b</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> 6
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">b</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_False<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
 
<span class="keyword1" id="Efficient_Sort-filter_by_key_merge_is_append"><span class="command">lemma</span></span> filter_by_key_merge_is_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span><span class="free">ys</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv leD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_False<span class="main">)</span>

<span class="keyword1" id="Efficient_Sort-filter_by_key_merge_pairs"><span class="command">lemma</span></span> filter_by_key_merge_pairs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">xs</span><span class="main">‚àà</span>set <span class="free">xss</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="main">(</span>merge_pairs <span class="free">xss</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="free">xss</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-filter_by_key_merge_all"><span class="command">lemma</span></span> filter_by_key_merge_all <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">xs</span><span class="main">‚àà</span>set <span class="free">xss</span><span class="main">.</span> sorted <span class="main">(</span>map <span class="free">key</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>merge_all <span class="free">xss</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">‚Üê</span>concat <span class="free">xss</span><span class="main">.</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_all.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Efficient_Sort-filter_by_key_merge_all_sequences"><span class="command">lemma</span></span> filter_by_key_merge_all_sequences <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">‚Üê</span>merge_all <span class="main">(</span>sequences <span class="free">xs</span><span class="main">)</span> <span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">‚Üê</span><span class="free">xs</span> <span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_sequences <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Efficient_Sort-msort_key_stable"><span class="command">lemma</span></span> msort_key_stable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">‚Üê</span>msort_key <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">‚Üê</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Efficient_Sort-sort_key_msort_key_conv"><span class="command">lemma</span></span> sort_key_msort_key_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sort_key <span class="free">key</span> <span class="main">=</span> msort_key"</span></span>
  <span class="keyword1"><span class="command">using</span></span> msort_key_stable <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext properties_for_sort_key mset_msort_key sorted_msort_key<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_cong<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  Replace existing code equations for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span>‚Äπsort_key‚Ä∫</span></span> by <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span>‚Äπmsort_key‚Ä∫</span></span>.
‚Ä∫</span></span>
<span class="keyword1"><span class="command">declare</span></span> sort_key_by_quicksort_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> sort_key_msort_key_conv <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mergesort_Complexity">
<div class="head">
<h1>Theory Mergesort_Complexity</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:      Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Mergesort_Complexity
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Efficient_Sort">Efficient_Sort</a>
    <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*TODO: move?*)</span>
<span class="keyword1" id="Mergesort_Complexity-log2_mono"><span class="command">lemma</span></span> log2_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚â§</span> <span class="free">y</span> <span class="main">‚üπ</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">‚â§</span> log <span class="numeral">2</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπCounting the Number of Comparisons‚Ä∫</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'k</span><span class="main">::</span>linorder"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">c_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c_merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">c_merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free">c_merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">c_merge_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c_merge_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zss</span></span></span><span class="main">)</span> <span class="main">=</span> c_merge <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">+</span> <span class="free">c_merge_pairs</span> <span class="free"><span class="bound"><span class="entity">zss</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge_pairs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge_pairs</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">c_merge_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c_merge_all</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge_all</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_merge_all</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> c_merge_pairs <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">+</span> <span class="free">c_merge_all</span> <span class="main">(</span>merge_pairs <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">c_sequences</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">c_asc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">c_desc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c_sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">c_desc</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="keyword1">else</span> <span class="free">c_asc</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_sequences</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_sequences</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_asc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬¨</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">c_asc</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free">c_sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_asc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_desc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">c_desc</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free">c_sequences</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">c_desc</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">c_msort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c_msort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> c_sequences <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> c_merge_all <span class="main">(</span>sequences <span class="free">key</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Mergesort_Complexity-c_merge"><span class="command">lemma</span></span> c_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"c_merge <span class="free">xs</span> <span class="free">ys</span> <span class="main">‚â§</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> c_merge.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Mergesort_Complexity-c_merge_pairs"><span class="command">lemma</span></span> c_merge_pairs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"c_merge_pairs <span class="free">xss</span> <span class="main">‚â§</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> c_merge_pairs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> c_merge <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Mergesort_Complexity-c_merge_all"><span class="command">lemma</span></span> c_merge_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"c_merge_all <span class="free">xss</span> <span class="main">‚â§</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="free">xss</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> c_merge_all.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?clen</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">Œª</span><span class="bound">xs</span><span class="main">.</span> length <span class="main">(</span>concat <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">zss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xss2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"merge_pairs <span class="free">key</span> <span class="var">?xss</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">‚åâ</span> <span class="main">=</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">‚åâ</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> ceiling_log2_div2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_merge_all <span class="var">?xss</span> <span class="main">=</span> c_merge_pairs <span class="var">?xss</span> <span class="main">+</span> c_merge_all <span class="var">?xss2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?clen</span> <span class="var">?xss</span> <span class="main">+</span> c_merge_all <span class="var">?xss2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_merge <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> c_merge_pairs <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?clen</span> <span class="var">?xss</span> <span class="main">+</span> <span class="var">?clen</span> <span class="var">?xss2</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="var">?xss2</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?clen</span> <span class="var">?xss</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="var">?xss</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> c_sequences<span class="main">:</span> <span class="quoted"><span class="quoted">"c_sequences <span class="free">xs</span> <span class="main">‚â§</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"c_asc <span class="free">x</span> <span class="free">ys</span> <span class="main">‚â§</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"c_desc <span class="free">x</span> <span class="free">ys</span> <span class="main">‚â§</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> c_sequences_c_asc_c_desc.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> length_concat_sequences <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>sequences <span class="free">key</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_concat_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> length <span class="main">(</span>concat <span class="main">(</span>asc <span class="free">key</span> <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_concat_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>desc <span class="free">key</span> <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascP_f_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> sequences_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> sequences <span class="free">key</span> <span class="free">xs</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asc_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> asc <span class="free">key</span> <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> desc_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"desc <span class="free">key</span> <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sequences_asc_desc.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Mergesort_Complexity-c_msort"><span class="command">lemma</span></span> c_msort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_msort <span class="free">xs</span> <span class="main">‚â§</span> <span class="free">n</span> <span class="main">+</span> <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">‚ü∑</span> length <span class="free">xs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>c_merge_all <span class="main">(</span>sequences <span class="free">key</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="main">(</span>sequences <span class="free">key</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c_merge_all <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sequences <span class="free">key</span> <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_sequences <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sequences_ne mult_mono ceiling_mono log2_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>c_merge_all <span class="main">(</span>sequences <span class="free">key</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sequences <span class="free">xs</span> <span class="main">‚â§</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_sequences <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Natural_Mergesort">
<div class="head">
<h1>Theory Natural_Mergesort</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Christian Sternagel *)</span>

<span class="keyword1"><span class="command">theory</span></span> Natural_Mergesort
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Sorting.html">HOL-Data_Structures.Sorting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπAuxiliary Results‚Ä∫</span></span>

<span class="keyword1" id="Natural_Mergesort-C_merge_adj'"><span class="command">lemma</span></span> C_merge_adj'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"C_merge_adj <span class="free">xss</span> <span class="main">‚â§</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> C_merge_adj.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> C_merge_ub <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Natural_Mergesort-length_concat_merge_adj"><span class="command">lemma</span></span> length_concat_merge_adj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>merge_adj <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_adj.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_merge<span class="main">)</span>

<span class="keyword1" id="Natural_Mergesort-C_merge_all'"><span class="command">lemma</span></span> C_merge_all'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"C_merge_all <span class="free">xss</span> <span class="main">‚â§</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="free">xss</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> C_merge_all.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">#</span> <span class="skolem">zss</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="var">?xss</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">‚åâ</span> <span class="main">=</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">‚åâ</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> ceiling_log2_div2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"C_merge_all <span class="var">?xss</span> <span class="main">=</span> C_merge_adj <span class="var">?xss</span> <span class="main">+</span> C_merge_all <span class="main">(</span>merge_adj <span class="var">?xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?m</span> <span class="main">+</span> C_merge_all <span class="main">(</span>merge_adj <span class="var">?xss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_merge_adj' <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?m</span> <span class="main">+</span> length <span class="main">(</span>concat <span class="main">(</span>merge_adj <span class="var">?xss</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="main">(</span>merge_adj <span class="var">?xss</span><span class="main">)</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">=</span> <span class="var">?m</span> <span class="main">+</span> <span class="var">?m</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="main">(</span>merge_adj <span class="var">?xss</span><span class="main">)</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_concat_merge_adj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> <span class="var">?m</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="var">?xss</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπDefinition of Natural Mergesort‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
  Partition input into ascending and descending subsequences.
  (The latter are reverted on the fly.)
‚Ä∫</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">asc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">desc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">(#)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">runs</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">runs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬¨</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">‚àò</span> <span class="main">(#)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">#</span> <span class="free">runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nmsort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nmsort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> merge_all <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπFunctional Correctness‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ascP</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Natural_Mergesort-ascP_Cons"><span class="command">lemma</span></span> ascP_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="main">(</span><span class="main">(#)</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ascP_def<span class="main">)</span>

<span class="keyword1" id="Natural_Mergesort-ascP_comp_Cons"><span class="command">lemma</span></span> ascP_comp_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> ascP <span class="main">(</span><span class="free">f</span> <span class="main">‚àò</span> <span class="main">(#)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ascP_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> append_Cons<span class="main">)</span>

<span class="keyword1" id="Natural_Mergesort-ascP_simp"><span class="command">lemma</span></span> ascP_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="operator">unfolded</span> ascP_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> mset_runs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àë<span class="hidden">‚á©</span><sub>#</sub></span> <span class="main">(</span>image_mset mset <span class="main">(</span>mset <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mset_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">‚àë<span class="hidden">‚á©</span><sub>#</sub></span> <span class="main">(</span>image_mset mset <span class="main">(</span>mset <span class="main">(</span>asc <span class="free">x</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> mset <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mset_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àë<span class="hidden">‚á©</span><sub>#</sub></span> <span class="main">(</span>image_mset mset <span class="main">(</span>mset <span class="main">(</span>desc <span class="free">x</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> runs_asc_desc.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Natural_Mergesort-mset_nmsort"><span class="command">lemma</span></span> mset_nmsort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>nmsort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_merge_all nmsort_def mset_runs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> sorted_runs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">.</span> sorted <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sorted_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> sorted <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚â§</span> <span class="free">a</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> sorted <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sorted_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">a</span> <span class="main">‚â§</span> <span class="bound">x</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span><span class="main">‚àà</span>set <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> sorted <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> runs_asc_desc.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1" id="Natural_Mergesort-sorted_nmsort"><span class="command">lemma</span></span> sorted_nmsort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>nmsort <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_merge_all <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nmsort_def sorted_runs<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπRunning Time Analysis‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">C_runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">‚áí</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">C_asc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">C_desc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">C_runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">C_desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="free">C_asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C_runs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C_asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬¨</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">C_asc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free">C_runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C_asc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C_desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">C_desc</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free">C_runs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C_desc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">C_nmsort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">C_nmsort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> C_runs <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> C_merge_all <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> C_runs<span class="main">:</span> <span class="quoted"><span class="quoted">"C_runs <span class="free">xs</span> <span class="main">‚â§</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"C_asc <span class="free">a</span> <span class="free">ys</span> <span class="main">‚â§</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"C_desc <span class="free">a</span> <span class="free">ys</span> <span class="main">‚â§</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> C_runs_C_asc_C_desc.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> length_runs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span> <span class="main">‚â§</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> length <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> runs_asc_desc.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> length_concat_runs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_concat_asc<span class="main">:</span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> length <span class="main">(</span>concat <span class="main">(</span>asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span><span class="free">f</span> <span class="main">[]</span><span class="main">)</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_concat_desc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> runs_asc_desc.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Natural_Mergesort-log2_mono"><span class="command">lemma</span></span> log2_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚â§</span> <span class="free">y</span> <span class="main">‚üπ</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">‚â§</span> log <span class="numeral">2</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> runs_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> runs <span class="free">xs</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ascP <span class="free">f</span> <span class="main">‚üπ</span> asc <span class="free">a</span> <span class="free">f</span> <span class="free">ys</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"desc <span class="free">a</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> runs_asc_desc.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Natural_Mergesort-C_nmsort"><span class="command">lemma</span></span> C_nmsort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"C_nmsort <span class="free">xs</span> <span class="main">‚â§</span> <span class="free">n</span> <span class="main">+</span> <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">‚ü∑</span> length <span class="free">xs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>C_merge_all <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="main">(</span>length <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_merge_all' <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"runs <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚Ä¶</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_runs <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> runs_ne mult_mono ceiling_mono log2_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>C_merge_all <span class="main">(</span>runs <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> int <span class="free">n</span> <span class="main">*</span> <span class="main">‚åà</span>log <span class="numeral">2</span> <span class="free">n</span><span class="main">‚åâ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"C_runs <span class="free">xs</span> <span class="main">‚â§</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C_runs <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>