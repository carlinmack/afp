<div id="RTS_safe">
<div class="head">
<h1>Theory RTS_safe</h1>
</div>
<pre class="source"><span class="comment1">(* Title: RTS/Common/RTS_safe.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Regression Test Selection algorithm model"</span></span>

<span class="keyword1"><span class="command">theory</span></span> RTS_safe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This describes an \emph{existence safe} RTS algorithm: if a test
 is deselected based on an output, there is SOME equivalent output
 under the changed program. ›</span></span>
<span class="keyword1"><span class="command">locale</span></span> RTS_safe <span class="main">=</span>
 <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'test</span> <span class="main">⇒</span> <span class="tfree">'prog_out</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">equiv_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog_out</span> <span class="main">⇒</span> <span class="tfree">'prog_out</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">deselect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'prog_out</span> <span class="main">⇒</span> <span class="tfree">'prog</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">progs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">tests</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'test</span> set"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
  existence_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">progs</span><span class="main">;</span> <span class="free">P'</span> <span class="main">∈</span> <span class="free">progs</span><span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">tests</span><span class="main">;</span> <span class="free">o1</span> <span class="main">∈</span> <span class="free">out</span> <span class="free">P</span> <span class="free">t</span><span class="main">;</span> <span class="free">deselect</span> <span class="free">P</span> <span class="free">o1</span> <span class="free">P'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">o2</span> <span class="main">∈</span> <span class="free">out</span> <span class="free">P'</span> <span class="free">t</span><span class="main">.</span> <span class="free">equiv_out</span> <span class="free">o1</span> <span class="bound">o2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  equiv_out_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">equiv_out</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  equiv_out_deselect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">equiv_out</span> <span class="free">o1</span> <span class="free">o2</span><span class="main">;</span> <span class="free">deselect</span> <span class="free">P</span> <span class="free">o1</span> <span class="free">P'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">deselect</span> <span class="free">P</span> <span class="free">o2</span> <span class="free">P'</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> RTS_safe <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="RTS_safe-equiv_out_refl"><span class="command">lemma</span></span> equiv_out_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">equiv_out</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> equiv_class_eq_iff equiv_out_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="RTS_safe-equiv_out_trans"><span class="command">lemma</span></span> equiv_out_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">equiv_out</span> <span class="free">a</span> <span class="free">b</span><span class="main">;</span> <span class="free">equiv_out</span> <span class="free">b</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">equiv_out</span> <span class="free">a</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> equiv_class_eq_iff equiv_out_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"This shows that it is safe to continue deselecting a test based
 on its output under a previous program, to an arbitrary number of
 program changes, as long as the test is continually deselected. This
 is useful because it means changed programs don't need to generate new
 outputs for deselected tests to ensure safety of future deselections."</span></span>
<span class="keyword1" id="RTS_safe-existence_safe_trans"><span class="command">lemma</span></span> existence_safe_trans<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> Pst_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Ps</span> <span class="main">⊆</span> <span class="free">progs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">tests</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
 o0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
 des<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">Ps</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">deselect</span> <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">Ps</span><span class="main">!</span><span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">o<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span>last <span class="free">Ps</span><span class="main">)</span> <span class="free">t</span><span class="main">.</span> <span class="free">equiv_out</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">o<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> Pst_in <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> z<span class="main">:</span> 0
    <span class="keyword1"><span class="command">from</span></span> z.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">Ps</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> last <span class="skolem">Ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> equiv_out_refl z.prems<span class="main">(</span>2<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc'<span class="main">:</span><span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x'</span> <span class="main">=</span> length <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc'.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> nmt'<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> sub'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">progs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order_trans set_take_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">tests</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Pst_in<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>length <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
     <span class="free">deselect</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>5<span class="main">)</span> len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">o'</span><span class="main">∈</span><span class="free">out</span> <span class="main">(</span>last <span class="var">?Ps</span><span class="main">)</span> <span class="free">t</span><span class="main">.</span> <span class="free">equiv_out</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">o'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Suc'.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Ps</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">o'</span></span> <span class="keyword2"><span class="keyword">where</span></span> o'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">o'</span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span>last <span class="var">?Ps</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">equiv_out</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">o'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc'.prems<span class="main">(</span>2<span class="main">)</span> len' nmt'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span><span class="main">!</span><span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">Ps</span> <span class="main">=</span> <span class="skolem">Ps</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 last_conv_nth lessI nth_take<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">&lt;</span> length <span class="skolem">Ps</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc'.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> des'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">deselect</span> <span class="main">(</span>last <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>last <span class="skolem">Ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> sub' nmt' last_in_set
    <span class="keyword1"><span class="command">have</span></span> Ps_in<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span> <span class="main">∈</span> <span class="free">progs</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">Ps</span> <span class="main">∈</span> <span class="free">progs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">o<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span>last <span class="skolem">Ps</span><span class="main">)</span> <span class="free">t</span><span class="main">.</span> <span class="free">equiv_out</span> <span class="skolem">o'</span> <span class="bound">o<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> existence_safe<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"last <span class="main"><span class="main"><span class="main">(</span></span></span>take <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="skolem"><span class="skolem"><span class="skolem">x'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Ps</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> P'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"last <span class="skolem"><span class="skolem"><span class="skolem">Ps</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">,</span></span>
                    <span class="operator">OF</span> Ps_in Pst_in<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> o' equiv_out_deselect<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eo des'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">o<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> oN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">o<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">∈</span> <span class="free">out</span> <span class="main">(</span>last <span class="skolem">Ps</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eo'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">equiv_out</span> <span class="skolem">o'</span> <span class="skolem">o<span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eo eo' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">equiv_out</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">o<span class="hidden">⇩</span><sub>n</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> equiv_out_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">RTS_safe</span><span class="antiquote">}</span></span> ›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Semantics">
<div class="head">
<h1>Theory Semantics</h1>
</div>
<pre class="source"><span class="comment1">(* Title: RTS/Common/Semantics.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Semantics model"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"General model for small-step semantics:"</span></span>
<span class="keyword1"><span class="command">locale</span></span> Semantics <span class="main">=</span>
 <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">small</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">endset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
  endset_final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> <span class="free">endset</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="free">small</span> <span class="bound">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Semantics <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Extending <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">small</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to multiple steps"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">small_nstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
small_nstep_base<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">small_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
small_nstep_Rec<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">small_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span> <span class="bound">σ2</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">σ2</span> <span class="main">∈</span> <span class="free">small</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ1</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Semantics-small_nstep_Rec2"><span class="command">lemma</span></span> small_nstep_Rec2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span> <span class="bound">σ2</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">∧</span> <span class="bound">σ2</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span><span class="main">.</span> <span class="bound">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sucnstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ12</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ12</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="skolem">σ1</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ12</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Sucnstep<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Sucnstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ'</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sucnstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ12</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ12</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ12</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Sucnstep<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc Sucnstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> right left <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Semantics-small_nstep_SucD"><span class="command">lemma</span></span> small_nstep_SucD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> small_nstep_Rec2 case_prodD assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semantics-small_nstep_Suc_nend"><span class="command">lemma</span></span> small_nstep_Suc_nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> endset_final small_nstep_SucD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Extending <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">small</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to a big-step semantics"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">big</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">big</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">σ'</span> <span class="main">∈</span> small_nstep <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">endset</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Semantics-bigI"><span class="command">lemma</span></span> bigI<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span><span class="main">;</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> big_def<span class="main">)</span>

<span class="keyword1" id="Semantics-bigD"><span class="command">lemma</span></span> bigD<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> big_def<span class="main">)</span>

<span class="keyword1" id="Semantics-big_def2"><span class="command">lemma</span></span> big_def2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bigD big_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> big_def big_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semantics-big_stepD"><span class="command">lemma</span></span> big_stepD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> big<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span><span class="main">.</span> <span class="bound">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="bound">σ1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> big_def2 big <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> small_nstep_SucD nend big_def2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(***)</span>

<span class="keyword1" id="Semantics-small_nstep_det_last_eq"><span class="command">lemma</span></span> small_nstep_det_last_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span><span class="main">;</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span><span class="main">;</span> <span class="free">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> small_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> bigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>3<span class="main">)</span> small_nstep_SucD endset_final<span class="main">[</span><span class="operator">OF</span> endset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> bigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> small_nstep_Suc_nend<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">≠</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> small_nstep_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> big<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> neq Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> small_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc'<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n1'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1'</span> <span class="main">∈</span> <span class="free">small</span> <span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> small_nstep <span class="free">P</span> <span class="skolem">σ1'</span> <span class="skolem">n1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> small_nstep_SucD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n1'</span></span><span class="main">]</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span><span class="main">=</span><span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>1<span class="main">)</span> det <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> big σ1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> σ1'<span class="main">(</span>2<span class="main">)</span> Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹ Semantics ›</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CollectionSemantics">
<div class="head">
<h1>Theory CollectionSemantics</h1>
</div>
<pre class="source"><span class="comment1">(* Title: RTS/Common/CollectionSemantics.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Collection Semantics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CollectionSemantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Semantics">Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"General model for small step semantics instrumented
 with an information collection mechanism:"</span></span>
<span class="keyword1"><span class="command">locale</span></span> CollectionSemantics <span class="main">=</span> Semantics <span class="main">+</span>
 <span class="keyword2"><span class="keyword">constrains</span></span>
  small <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  endset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span>
 <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">collect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'coll</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'coll</span> <span class="main">⇒</span> <span class="tfree">'coll</span> <span class="main">⇒</span> <span class="tfree">'coll</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">collect_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'coll</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
  combine_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span><span class="free">combine</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="free">c3</span> <span class="main">=</span> <span class="free">combine</span> <span class="free">c1</span> <span class="main">(</span><span class="free">combine</span> <span class="free">c2</span> <span class="free">c3</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  collect_idl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free">collect_id</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  collect_idr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free">c</span> <span class="free">collect_id</span> <span class="main">=</span> <span class="free">c</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> CollectionSemantics <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Small-Step Collection Semantics"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">csmall</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'coll</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">csmall</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span><span class="main">.</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∧</span> <span class="free">collect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">σ'</span> <span class="main">=</span> <span class="bound">coll</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="CollectionSemantics-small_det_csmall_det"><span class="command">lemma</span></span> small_det_csmall_det<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> csmall <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">o'</span><span class="main">.</span> csmall <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">o'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csmall_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Extending <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">csmall</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to multiple steps"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">csmall_nstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'coll</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
csmall_nstep_base<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">csmall_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free">collect_id</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
csmall_nstep_Rec<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">csmall_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span> <span class="main">(</span><span class="bound">σ2</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">csmall_nstep</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
                      <span class="main">∧</span> <span class="main">(</span><span class="bound">σ2</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ1</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="bound">coll</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="CollectionSemantics-small_nstep_csmall_nstep_equiv"><span class="command">lemma</span></span> small_nstep_csmall_nstep_equiv<span class="main">:</span>
 <span class="quoted"><span class="quoted">"small_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span>
       <span class="main">=</span> <span class="main">{</span> <span class="bound">σ'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> csmall_def<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_nstep_exists"><span class="command">lemma</span></span> csmall_nstep_exists<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span> <span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">drule</span> bigD<span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> small_nstep_csmall_nstep_equiv<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_det_csmall_nstep_det"><span class="command">lemma</span></span> csmall_det_csmall_nstep_det<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> csmall <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">o'</span><span class="main">.</span> csmall <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">o'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> csmall_nstep <span class="free">P</span> <span class="bound">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">o'</span><span class="main">.</span> csmall_nstep <span class="free">P</span> <span class="bound">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="bound">o'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_nstep_Rec2"><span class="command">lemma</span></span> csmall_nstep_Rec2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span> <span class="main">(</span><span class="bound">σ2</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="free">σ</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="bound">σ2</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="bound">coll</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span> <span class="bound">coll'</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="bound">coll'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ'</span> <span class="skolem">coll'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sucnstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
                        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll2</span> <span class="main">=</span> <span class="skolem">coll'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ12</span></span> <span class="skolem"><span class="skolem">coll12</span></span> <span class="skolem"><span class="skolem">coll22</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ12</span><span class="main">,</span> <span class="skolem">coll12</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll22</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ12</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">combine</span> <span class="skolem">coll12</span> <span class="skolem">coll22</span> <span class="main">=</span> <span class="skolem">coll1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Sucnstep<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="skolem">coll'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> combine_assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">coll12</span></span> <span class="quoted"><span class="skolem">coll22</span></span> <span class="quoted"><span class="skolem">coll2</span></span><span class="main">]</span> Sucnstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span> <span class="bound">coll'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="bound">coll'</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ'</span> <span class="skolem">coll'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span> <span class="main">=</span> <span class="skolem">coll'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="keyword2"><span class="keyword">where</span></span> Sucnstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span>
                      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll2</span> <span class="main">=</span> <span class="skolem">coll'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ12</span></span> <span class="skolem"><span class="skolem">coll12</span></span> <span class="skolem"><span class="skolem">coll22</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ12</span><span class="main">,</span> <span class="skolem">coll12</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll22</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ12</span> <span class="main">∧</span> <span class="free">combine</span> <span class="skolem">coll12</span> <span class="skolem">coll22</span> <span class="main">=</span> <span class="skolem">coll2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Sucnstep<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">coll1</span></span> <span class="quoted"><span class="skolem">coll12</span></span> <span class="quoted"><span class="skolem">coll22</span></span><span class="main">]</span> Suc Sucnstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> right left <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_nstep_SucD"><span class="command">lemma</span></span> csmall_nstep_SucD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="free">σ</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="free">coll'</span> <span class="main">=</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll</span> <span class="main">∧</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="bound">σ1</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> csmall_nstep_Rec2 CollectionSemantics_axioms case_prodD assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CollectionSemantics-csmall_nstep_Suc_nend"><span class="command">lemma</span></span> csmall_nstep_Suc_nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o'</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">n1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> endset_final csmall_nstep_SucD CollectionSemantics.csmall_def CollectionSemantics_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="CollectionSemantics-small_to_csmall_nstep_pres"><span class="command">lemma</span></span> small_to_csmall_nstep_pres<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> Qpres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">P</span> <span class="free">σ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">coll</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="skolem">n</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ1</span> <span class="main">∧</span> <span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll2</span> <span class="main">=</span> <span class="skolem">coll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc Qpres<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csmall_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_to_csmall_nstep_prop"><span class="command">lemma</span></span> csmall_to_csmall_nstep_prop<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Rcomb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="bound">P</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Qpres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Rtrans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ1</span> <span class="bound">σ'</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span>
                        <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ1</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ1</span> <span class="bound">σ'</span> <span class="bound">coll2</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">R'</span> <span class="free">P</span> <span class="bound">σ</span> <span class="bound">σ</span> <span class="free">collect_id</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">P</span> <span class="free">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="free">P</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">coll</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">coll</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="skolem">n</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ1</span> <span class="main">∧</span> <span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll2</span> <span class="main">=</span> <span class="skolem">coll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> small_to_csmall_nstep_pres<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Q</span></span><span class="main">]</span> Qpres Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nstep assms Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> base<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_to_csmall_nstep_prop2"><span class="command">lemma</span></span> csmall_to_csmall_nstep_prop2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">P'</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P</span> <span class="bound">σ</span>
             <span class="main">⟹</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P'</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Rcomb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Qpres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">σ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P'</span> <span class="free">σ</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">coll</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ</span> <span class="skolem">n</span>
                      <span class="main">∧</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ1</span> <span class="main">∧</span> <span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll2</span> <span class="main">=</span> <span class="skolem">coll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> small_to_csmall_nstep_pres<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="free">Q</span>"</span></span><span class="main">]</span> Qpres Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nstep assms Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Extending <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">csmall</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to a big-step semantics"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cbig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'coll</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cbig</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
  <span class="main">{</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">endset</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="CollectionSemantics-cbigD"><span class="command">lemma</span></span> cbigD<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cbig_def<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-cbigD'"><span class="command">lemma</span></span> cbigD'<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">o'</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">o'</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> fst <span class="free">o'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">o'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cbig_def<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-cbig_def2"><span class="command">lemma</span></span> cbig_def2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bigD cbig_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> big_def cbig_def small_nstep_csmall_nstep_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CollectionSemantics-cbig_big_equiv"><span class="command">lemma</span></span> cbig_big_equiv<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_def cbig_def small_nstep_csmall_nstep_equiv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbig_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> csmall_nstep_exists<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CollectionSemantics-cbig_big_implies"><span class="command">lemma</span></span> cbig_big_implies<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">σ'</span> <span class="main">∈</span> big <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cbig_big_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="CollectionSemantics-csmall_to_cbig_prop"><span class="command">lemma</span></span> csmall_to_cbig_prop<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="bound">P</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">P</span> <span class="bound">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ1</span> <span class="bound">σ'</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span>
                        <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ1</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ1</span> <span class="bound">σ'</span> <span class="bound">coll2</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">R'</span> <span class="free">P</span> <span class="bound">σ</span> <span class="bound">σ</span> <span class="free">collect_id</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">P</span> <span class="free">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="free">P</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">coll</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms csmall_to_csmall_nstep_prop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbig_def2<span class="main">)</span>

<span class="keyword1" id="CollectionSemantics-csmall_to_cbig_prop2"><span class="command">lemma</span></span> csmall_to_cbig_prop2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">P'</span> <span class="bound">σ</span> <span class="bound">σ'</span> <span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span> <span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="bound">P'</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">.</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="main">(</span><span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll1</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">P</span> <span class="bound">P'</span> <span class="bound">coll2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Qpres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ'</span> <span class="main">∈</span> <span class="free">small</span> <span class="bound">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">σ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">coll</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P'</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms csmall_to_csmall_nstep_prop2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbig_def2<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="CollectionSemantics-cbig_stepD"><span class="command">lemma</span></span> cbig_stepD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">coll1</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ1</span><span class="main">,</span> <span class="bound">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="free">σ</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="free">coll'</span> <span class="main">=</span> <span class="free">combine</span> <span class="bound">coll1</span> <span class="bound">coll</span> <span class="main">∧</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="bound">σ1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cbig_def2 cbig <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> csmall_nstep_SucD nend cbig_def2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(****)</span>

<span class="keyword1" id="CollectionSemantics-csmall_nstep_det_last_eq"><span class="command">lemma</span></span> csmall_nstep_det_last_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="free">small</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="free">σ</span><span class="main">;</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll'</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span><span class="main">;</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">coll''</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n'</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">coll'</span></span> <span class="quoted"><span class="free">coll''</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> csmall_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> cbigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>3<span class="main">)</span> csmall_nstep_Suc_nend endset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> cbigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∉</span> <span class="free">endset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> csmall_nstep_Suc_nend<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">≠</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">coll'</span> <span class="main">=</span> <span class="free">combine</span> <span class="skolem">coll1</span> <span class="skolem">coll</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">coll</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> csmall_nstep_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbig_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> neq Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> csmall_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc'<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n1'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="skolem"><span class="skolem">coll1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1'</span><span class="main">,</span><span class="skolem">coll1'</span><span class="main">)</span> <span class="main">∈</span> csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">coll''</span> <span class="main">=</span> <span class="free">combine</span> <span class="skolem">coll1'</span> <span class="skolem">coll2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> csmall_nstep <span class="free">P</span> <span class="skolem">σ1'</span> <span class="skolem">n1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> csmall_nstep_SucD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> coll'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">coll''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n1'</span></span><span class="main">]</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span><span class="main">=</span><span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1 det csmall_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cbig σ1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> σ1'<span class="main">(</span>3<span class="main">)</span> Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹ CollectionSemantics ›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CollectionBasedRTS">
<div class="head">
<h1>Theory CollectionBasedRTS</h1>
</div>
<pre class="source"><span class="comment1">(* Title: RTS/Common/CollectionBasedRTS.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Collection-based RTS"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CollectionBasedRTS
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#RTS_safe">RTS_safe</a> <a href="#CollectionSemantics">CollectionSemantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> CollectionBasedRTS_base <span class="main">=</span> RTS_safe <span class="main">+</span> CollectionSemantics

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"General model for Regression Test Selection based on
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">CollectionSemantics</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:"</span></span>
<span class="keyword1"><span class="command">locale</span></span> CollectionBasedRTS <span class="main">=</span> CollectionBasedRTS_base <span class="keyword2"><span class="keyword">where</span></span>
  small <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">small</span> <span class="main">::</span> <span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  collect <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">collect</span> <span class="main">::</span> <span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'coll</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  out <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">::</span> <span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'test</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'coll</span><span class="main">)</span> set"</span></span>
 <span class="keyword2"><span class="keyword">for</span></span> <span class="free">small</span> <span class="free">collect</span> <span class="free">out</span>
<span class="main">+</span>
 <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">make_test_prog</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'test</span> <span class="main">⇒</span> <span class="tfree">'prog</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">collect_start</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'coll</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span>
  out_cbig<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">out</span> <span class="free">P</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">coll'</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> cbig <span class="main">(</span><span class="free">make_test_prog</span> <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="bound">i</span>
                                                  <span class="main">∧</span> <span class="bound">coll'</span> <span class="main">=</span> <span class="free">combine</span> <span class="bound">coll</span> <span class="main">(</span><span class="free">collect_start</span> <span class="free">P</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> CollectionBasedRTS <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹ CollectionBasedRTS ›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="JVMSemantics">
<div class="head">
<h1>Theory JVMSemantics</h1>
</div>
<pre class="source"><span class="comment1">(* Title: RTS/JVM_RTS/JVMSemantics.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instantiating <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Semantics</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with Jinja JVM"</span></span>

<span class="keyword1"><span class="command">theory</span></span> JVMSemantics
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Semantics">../Common/Semantics</a>"</span> <a href="../../jinjadci/theories/#JVMExec">JinjaDCI.JVMExec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMsmall</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_state <span class="main">⇒</span> jvm_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMsmall</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">σ'</span><span class="main">.</span> exec <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">σ'</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="JVMSemantics-JVMsmall_prealloc_pres"><span class="command">lemma</span></span> JVMsmall_prealloc_pres<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="main">(</span>fst<span class="main">(</span>snd <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preallocated <span class="main">(</span>fst<span class="main">(</span>snd <span class="free">σ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> exec_prealloc_pres<span class="main">[</span><span class="operator">OF</span> pre<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">σ'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="JVMSemantics-JVMsmall_det"><span class="command">lemma</span></span> JVMsmall_det<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMsmall <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> JVMsmall <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">JVMendset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMendset</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">xp</span><span class="main">,</span><span class="bound">h</span><span class="main">,</span><span class="bound">frs</span><span class="main">,</span><span class="bound">sh</span><span class="main">)</span><span class="main">.</span> <span class="bound">frs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">xp</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="JVMSemantics-JVMendset_final"><span class="command">lemma</span></span> JVMendset_final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> JVMendset <span class="main">⟹</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> JVMsmall <span class="bound">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>

<span class="keyword1" id="JVMSemantics-start_state_nend"><span class="command">lemma</span></span> start_state_nend<span class="main">:</span>
 <span class="quoted"><span class="quoted">"start_state <span class="free">P</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def JVMendset_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> JVMSemantics<span class="main">:</span> Semantics <span class="quoted">JVMsmall</span> <span class="quoted">JVMendset</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> JVMendset_final<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="ClassesChanged">
<div class="head">
<h1>Theory ClassesChanged</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      RTS/JinjaSuppl/ClassesChanged.thy
    Author:    Susannah Mansky, UIUC 2020
    Description: Theory around the classes changed from one program to another
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">classes_changed</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> theory"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ClassesChanged
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../jinjadci/theories/#Decl">JinjaDCI.Decl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"A class is considered changed if it exists only in one program or the other,
  or exists in both but is different."</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">classes_changed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> <span class="tfree">'m</span> prog <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">classes_changed</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">cn</span><span class="main">.</span> class <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="bound">cn</span> <span class="main">≠</span> class <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="bound">cn</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">class_changed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> <span class="tfree">'m</span> prog <span class="main">⇒</span> cname <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">class_changed</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span>class <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">≠</span> class <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="ClassesChanged-classes_changed_class_changed"><span class="command">lemma</span></span> classes_changed_class_changed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cn</span> <span class="main">∈</span> classes_changed <span class="free">P1</span> <span class="free">P2</span> <span class="main">=</span> class_changed <span class="free">P1</span> <span class="free">P2</span> <span class="free">cn</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> classes_changed_def class_changed_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-classes_changed_self"><span class="command">lemma</span></span> classes_changed_self<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"classes_changed <span class="free">P</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_changed_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-classes_changed_sym"><span class="command">lemma</span></span> classes_changed_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> classes_changed <span class="free">P'</span> <span class="free">P</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_changed_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-classes_changed_class"><span class="command">lemma</span></span> classes_changed_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">cn</span> <span class="main">∉</span> classes_changed <span class="free">P</span> <span class="free">P'</span><span class="main">⟧</span> <span class="main">⟹</span> class <span class="free">P</span> <span class="free">cn</span> <span class="main">=</span> class <span class="free">P'</span> <span class="free">cn</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_changed_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-classes_changed_class_set"><span class="command">lemma</span></span> classes_changed_class_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_iff_not_equal <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_changed_class<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We now relate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">classes_changed</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over two programs to those
 over programs with an added class (such as a test class)."</span></span>

<span class="keyword1" id="ClassesChanged-classes_changed_cons_eq"><span class="command">lemma</span></span> classes_changed_cons_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"classes_changed <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">(</span>classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">-</span> <span class="main">{</span>fst <span class="free">t</span><span class="main">}</span><span class="main">)</span>
                     <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> class_changed <span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="free">P'</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span>fst <span class="free">t</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> classes_changed_def class_changed_def class_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-class_changed_cons"><span class="command">lemma</span></span> class_changed_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"fst <span class="free">t</span> <span class="main">∉</span> classes_changed <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> class_changed_def class_def<span class="main">)</span>

<span class="keyword1" id="ClassesChanged-classes_changed_cons"><span class="command">lemma</span></span> classes_changed_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"classes_changed <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P'</span><span class="main">)</span> <span class="main">=</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">-</span> <span class="main">{</span>fst <span class="free">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">t</span> <span class="main">∈</span> classes_changed <span class="free">P</span> <span class="free">P'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> class_changed_cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span><span class="main">]</span>
    classes_changed_cons_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_changed_def class_cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> class_changed_cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> class_changed_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> class_cons<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesChanged-classes_changed_int_Cons"><span class="command">lemma</span></span> classes_changed_int_Cons<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">coll</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">coll</span> <span class="main">∩</span> classes_changed <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">t</span> <span class="main">∈</span> classes_changed <span class="free">P</span> <span class="free">P'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> classes_changed <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>fst <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> classes_changed_cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> classes_changed <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> classes_changed_cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Subcls">
<div class="head">
<h1>Theory Subcls</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      RTS/JinjaSuppl/Subcls.thy
    Author:    Susannah Mansky, UIUC 2020
    Description:  Theory for the subcls relation
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subcls</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> theory"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Subcls
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../jinjadci/theories/#TypeRel">JinjaDCI.TypeRel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Subcls-subcls_class_ex"><span class="command">lemma</span></span> subcls_class_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span><span class="main">;</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">C'</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D'</span> <span class="bound">fs</span> <span class="bound">ms</span><span class="main">.</span> class <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">D'</span><span class="main">,</span> <span class="bound">fs</span><span class="main">,</span> <span class="bound">ms</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subcls1D<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Subcls-class_subcls1"><span class="command">lemma</span></span> class_subcls1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> class <span class="free">P</span> <span class="free">y</span> <span class="main">=</span> class <span class="free">P'</span> <span class="free">y</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">z</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subcls1D <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subcls1I <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>


<span class="keyword1" id="Subcls-subcls1_single_valued"><span class="command">lemma</span></span> subcls1_single_valued<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>subcls1 <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def subcls1.simps<span class="main">)</span>

<span class="keyword1" id="Subcls-subcls_confluent"><span class="command">lemma</span></span> subcls_confluent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C''</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C''</span> <span class="main">∨</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C''</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> single_valued_confluent subcls1_single_valued<span class="main">)</span>

<span class="keyword1" id="Subcls-subcls1_confluent"><span class="command">lemma</span></span> subcls1_confluent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">a</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">b</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">a</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span><span class="main">;</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">b</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subcls1_single_valued
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converse_rtranclE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def<span class="main">)</span>


<span class="keyword1" id="Subcls-subcls_self_superclass"><span class="command">lemma</span></span> subcls_self_superclass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">C</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subcls1_single_valued
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">D</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_valued_def<span class="main">)</span>

<span class="keyword1" id="Subcls-subcls_of_Obj_acyclic"><span class="command">lemma</span></span> subcls_of_Obj_acyclic<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object<span class="main">;</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">D</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">D</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> False step.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> neq<span class="main">:</span> False
      <span class="keyword1"><span class="command">with</span></span> step.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="main">⊢</span> <span class="skolem">z</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> step.hyps<span class="main">(</span>1<span class="main">)</span> step.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">z</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subcls1_confluent<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Subcls-subcls_of_Obj"><span class="command">lemma</span></span> subcls_of_Obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object<span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subcls_confluent<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="ClassesAbove">
<div class="head">
<h1>Theory ClassesAbove</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      RTS/JinjaSuppl/ClassesAbove.thy
    Author:    Susannah Mansky, UIUC 2020
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">classes_above</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> theory"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"This section contains theory around the classes above
 (superclasses of) a class in the class structure, in particular
 noting that if their contents have not changed, then much of what
 that class sees (methods, fields) stays the same."</span></span>

<span class="keyword1"><span class="command">theory</span></span> ClassesAbove
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#ClassesChanged">ClassesChanged</a> <a href="#Subcls">Subcls</a> <a href="../../jinjadci/theories/#Exceptions">JinjaDCI.Exceptions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">classes_above</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> cname <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">classes_above</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">cn</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">cn</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">classes_between</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> cname <span class="main">⇒</span> cname <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">classes_between</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">cn</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">cn</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="bound">cn</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">classes_above_xcpts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">classes_above_xcpts</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>sys_xcpts<span class="main">.</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span>"</span></span>

<span class="comment1">(******************************************************************************)</span>

<span class="keyword1" id="ClassesAbove-classes_above_def2"><span class="command">lemma</span></span> classes_above_def2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">D</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="main">∪</span> classes_above <span class="free">P</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subcls1_confluent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClassesAbove-classes_above_class"><span class="command">lemma</span></span> classes_above_class<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> class <span class="free">P</span> <span class="free">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> classes_changed_class_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_subset"><span class="command">lemma</span></span> classes_above_subset<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> classes_above <span class="free">P'</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">y</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> class_subcls1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> classes_above_class<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> classes_changed_class_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_subcls"><span class="command">lemma</span></span> classes_above_subcls<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_subset<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_subset2"><span class="command">lemma</span></span> classes_above_subset2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P'</span> <span class="free">C</span> <span class="main">⊆</span> classes_above <span class="free">P</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> class_subcls1 classes_above_class<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> rtrancl_into_rtrancl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> classes_changed_class_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_subcls2"><span class="command">lemma</span></span> classes_above_subcls2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_subset2<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_set"><span class="command">lemma</span></span> classes_above_set<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_subset classes_above_subset2<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_classes_changed_sym"><span class="command">lemma</span></span> classes_above_classes_changed_sym<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P'</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P'</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_above_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> classes_changed_sym<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">]</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_sub_classes_between_eq"><span class="command">lemma</span></span> classes_above_sub_classes_between_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">D</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span>classes_between <span class="free">P</span> <span class="free">C</span> <span class="free">D</span> <span class="main">-</span> <span class="main">{</span><span class="free">D</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> classes_above <span class="free">P</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subcls_confluent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ClassesAbove-classes_above_subcls_subset"><span class="command">lemma</span></span> classes_above_subcls_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C'</span> <span class="main">⟧</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="free">C'</span> <span class="main">⊆</span> classes_above <span class="free">P</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Methods"</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_sees_methods"><span class="command">lemma</span></span> classes_above_sees_methods<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees_methods</span> <span class="free">Mm</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees_methods</span> <span class="free">Mm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> cls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="free">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_changed_class_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> int<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">Mm</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="keyword1">sees_methods</span> <span class="bound">Mm</span> <span class="main">⟹</span>
               <span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="bound">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="keyword1">sees_methods</span> <span class="bound">Mm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">Mm</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">sees_methods</span> <span class="skolem">Mm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="skolem">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">sees_methods</span> <span class="skolem">Mm</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Methods.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Obj<span class="main">:</span> <span class="main">(</span>sees_methods_Object <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">ms</span> <span class="skolem">Mm</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cls <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"class <span class="free">P'</span> Object <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">,</span> <span class="skolem">ms</span><span class="main">)</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Obj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sees_methods_Object<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> rec<span class="main">:</span> <span class="main">(</span>sees_methods_rec <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">ms</span> <span class="skolem">Mm</span> <span class="skolem">Mm'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subcls1I<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> converse_rtrancl_into_rtrancl <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rec.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="skolem">D</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sees_methods_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> ms cls <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_sees_method"><span class="command">lemma</span></span> classes_above_sees_method<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
     <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="free">b</span><span class="main">:</span> <span class="free">Ts</span><span class="main">→</span><span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="free">b</span><span class="main">:</span> <span class="free">Ts</span><span class="main">→</span><span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_sees_methods <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Method_def<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_sees_method2"><span class="command">lemma</span></span> classes_above_sees_method2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
     <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="free">b</span><span class="main">:</span> <span class="free">Ts</span><span class="main">→</span><span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="free">b</span><span class="main">:</span> <span class="free">Ts</span><span class="main">→</span><span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_classes_changed_sym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> classes_above_sees_method<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_method"><span class="command">lemma</span></span> classes_above_method<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> method <span class="free">P'</span> <span class="free">C</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="bound">b</span> <span class="main">:</span>  <span class="bound">Ts</span><span class="main">→</span><span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_sees_method<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="bound">b</span> <span class="main">:</span>  <span class="bound">Ts</span><span class="main">→</span><span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_sees_method2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> method_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*********************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Fields"</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_has_fields"><span class="command">lemma</span></span> classes_above_has_fields<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> cls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="free">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_changed_class_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> int<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">Mm</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span> <span class="main">⟹</span>
               <span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="bound">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">Mm</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">∈</span>classes_above <span class="free">P</span> <span class="skolem">C</span><span class="main">.</span> class <span class="free">P</span> <span class="bound">C'</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">C'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">has_fields</span> <span class="free">FDTs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Fields.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Obj<span class="main">:</span> <span class="main">(</span>has_fields_Object <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">ms</span> <span class="skolem">FDTs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cls <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"class <span class="free">P'</span> Object <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">,</span> <span class="skolem">ms</span><span class="main">)</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Obj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_fields_Object<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> rec<span class="main">:</span> <span class="main">(</span>has_fields_rec <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">ms</span> <span class="skolem">FDTs</span> <span class="skolem">FDTs'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subcls1I<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> converse_rtrancl_into_rtrancl <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rec.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟶</span> class <span class="free">P</span> <span class="bound">x</span> <span class="main">=</span> class <span class="free">P'</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_fields_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> fs cls <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_has_fields_dne"><span class="command">lemma</span></span> classes_above_has_fields_dne<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms classes_changed_sym<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">]</span> classes_above_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
   <span class="keyword1"><span class="command">have</span></span> int'<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P'</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P'</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> asm classes_above_has_fields<span class="main">[</span><span class="operator">OF</span> int'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">FDTs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_has_fields<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_has_field"><span class="command">lemma</span></span> classes_above_has_field<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
    <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_has_fields <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_def<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_has_field2"><span class="command">lemma</span></span> classes_above_has_field2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
     <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> classes_above_has_field <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_classes_changed_sym<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_sees_field"><span class="command">lemma</span></span> classes_above_sees_field<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
    <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_has_fields <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sees_field_def<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_sees_field2"><span class="command">lemma</span></span> classes_above_sees_field2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
     <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="free">b</span><span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">C'</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> classes_above_sees_field <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_classes_changed_sym<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_field"><span class="command">lemma</span></span> classes_above_field<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="free">C</span> <span class="free">F</span> <span class="main">=</span> field <span class="free">P'</span> <span class="free">C</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="bound">b</span> <span class="main">:</span> <span class="bound">T</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_sees_field<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">T</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">F</span><span class="main">,</span><span class="bound">b</span> <span class="main">:</span> <span class="bound">T</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_sees_field2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> field_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_fields"><span class="command">lemma</span></span> classes_above_fields<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fields <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> fields <span class="free">P'</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">FDTs</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has_fields</span> <span class="bound">FDTs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_has_fields<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> classes_above_has_fields_dne <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fields_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_ifields"><span class="command">lemma</span></span> classes_above_ifields<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span>
  ifields <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> ifields <span class="free">P'</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifields_def classes_above_fields<span class="main">)</span>


<span class="keyword1" id="ClassesAbove-classes_above_blank"><span class="command">lemma</span></span> classes_above_blank<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span>
  blank <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> blank <span class="free">P'</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blank_def classes_above_ifields<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_isfields"><span class="command">lemma</span></span> classes_above_isfields<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span>
  isfields <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> isfields <span class="free">P'</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isfields_def classes_above_fields<span class="main">)</span>

<span class="keyword1" id="ClassesAbove-classes_above_sblank"><span class="command">lemma</span></span> classes_above_sblank<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span>
  sblank <span class="free">P</span> <span class="free">C</span> <span class="main">=</span> sblank <span class="free">P'</span> <span class="free">C</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sblank_def classes_above_isfields<span class="main">)</span>

<span class="comment1">(******************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Other"</span></span>

<span class="keyword1" id="ClassesAbove-classes_above_start_heap"><span class="command">lemma</span></span> classes_above_start_heap<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"start_heap <span class="free">P</span> <span class="main">=</span> start_heap <span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C</span> <span class="main">∈</span> sys_xcpts<span class="main">.</span> blank <span class="free">P</span> <span class="bound">C</span> <span class="main">=</span> blank <span class="free">P'</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> classes_above_blank<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_heap_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="JVMCollectionSemantics">
<div class="head">
<h1>Theory JVMCollectionSemantics</h1>
</div>
<pre class="source"><span class="comment1">(* File: RTS/JVM_RTS/JVMCollectionSemantics.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instantiating <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">CollectionSemantics</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with Jinja JVM"</span></span>

<span class="keyword1"><span class="command">theory</span></span> JVMCollectionSemantics
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#CollectionSemantics">../Common/CollectionSemantics</a>"</span> <a href="#JVMSemantics">JVMSemantics</a> <span class="quoted">"<a href="#ClassesAbove">../JinjaSuppl/ClassesAbove</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JVMcombine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cname set <span class="main">⇒</span> cname set <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMcombine</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">JVMcollect_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMcollect_id</span> <span class="main">≡</span> <span class="main">{}</span>"</span></span>

<span class="comment1">(*******************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ JVM-specific <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"classes_above"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> theory ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">classes_above_frames</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> frame list <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">classes_above_frames</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">)</span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∪</span> <span class="free">classes_above_frames</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">classes_above_frames</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="JVMCollectionSemantics-classes_above_start_state"><span class="command">lemma</span></span> classes_above_start_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> above_xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"start_state <span class="free">P</span> <span class="main">=</span> start_state <span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms classes_above_start_heap <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-classes_above_matches_ex_entry"><span class="command">lemma</span></span> classes_above_matches_ex_entry<span class="main">:</span>
 <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⟹</span> matches_ex_entry <span class="free">P</span> <span class="free">C</span> <span class="free">pc</span> <span class="free">xcp</span> <span class="main">=</span> matches_ex_entry <span class="free">P'</span> <span class="free">C</span> <span class="free">pc</span> <span class="free">xcp</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> classes_above_subcls classes_above_subcls2
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matches_ex_entry_def<span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-classes_above_match_ex_table"><span class="command">lemma</span></span> classes_above_match_ex_table<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match_ex_table <span class="free">P</span> <span class="free">C</span> <span class="free">pc</span> <span class="free">es</span> <span class="main">=</span> match_ex_table <span class="free">P'</span> <span class="free">C</span> <span class="free">pc</span> <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> classes_above_matches_ex_entry<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-classes_above_find_handler"><span class="command">lemma</span></span> classes_above_find_handler<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>cname_of <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⟹</span> find_handler <span class="free">P</span> <span class="free">a</span> <span class="free">h</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> find_handler <span class="free">P'</span> <span class="free">a</span> <span class="free">h</span> <span class="free">frs</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">frs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">fr'</span> <span class="skolem">frs'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> fr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fr'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">fr'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span>
       intC<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="skolem">frs'</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons fr' int classes_above_method<span class="main">[</span><span class="operator">OF</span> intC<span class="main">]</span>
    classes_above_match_ex_table<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-find_handler_classes_above_frames"><span class="command">lemma</span></span> find_handler_classes_above_frames<span class="main">:</span>
 <span class="quoted"><span class="quoted">"find_handler <span class="free">P</span> <span class="free">a</span> <span class="free">h</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span><span class="free">h'</span><span class="main">,</span><span class="free">frs'</span><span class="main">,</span><span class="free">sh'</span><span class="main">)</span>
 <span class="main">⟹</span> classes_above_frames <span class="free">P</span> <span class="free">frs'</span> <span class="main">⊆</span> classes_above_frames <span class="free">P</span> <span class="free">frs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">frs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f1</span> <span class="skolem">frs1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match_ex_table <span class="free">P</span> <span class="main">(</span>cname_of <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">pc</span> <span class="main">(</span>ex_table_of <span class="free">P</span> <span class="skolem">C</span> <span class="skolem">M</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 None Cons
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits list.splits init_call_status.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 Some Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-find_handler_pieces"><span class="command">lemma</span></span> find_handler_pieces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"find_handler <span class="free">P</span> <span class="free">a</span> <span class="free">h</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span><span class="free">h'</span><span class="main">,</span><span class="free">frs'</span><span class="main">,</span><span class="free">sh'</span><span class="main">)</span>
 <span class="main">⟹</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h'</span> <span class="main">∧</span> <span class="free">sh</span> <span class="main">=</span> <span class="free">sh'</span> <span class="main">∧</span> classes_above_frames <span class="free">P</span> <span class="free">frs'</span> <span class="main">⊆</span> classes_above_frames <span class="free">P</span> <span class="free">frs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> find_handler_classes_above_frames <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> find_handler_heap find_handler_sheap<span class="main">)</span>

<span class="comment1">(**************************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Naive RTS algorithm"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMinstr_ncollect</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>jvm_prog<span class="main">,</span> instr<span class="main">,</span> heap<span class="main">,</span> val list<span class="main">]</span> <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">=</span> Null <span class="keyword1">then</span> <span class="main">{}</span>
   <span class="keyword1">else</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Null <span class="keyword1">then</span> <span class="main">{}</span>
   <span class="keyword1">else</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Checkcast <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">=</span> Null <span class="keyword1">then</span> <span class="main">{}</span>
   <span class="keyword1">else</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Null <span class="keyword1">then</span> <span class="main">{}</span>
   <span class="keyword1">else</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>the_Addr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Throw <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">=</span> Null <span class="keyword1">then</span> <span class="main">{}</span>
   <span class="keyword1">else</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMstep_ncollect</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>jvm_prog<span class="main">,</span> heap<span class="main">,</span> val list<span class="main">,</span> cname<span class="main">,</span> mname<span class="main">,</span> pc<span class="main">,</span> init_call_status<span class="main">]</span> <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Calling <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span>
 <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="main">∪</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C'</span></span></span> clinit<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Throwing <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>cname_of <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">=</span> JVMinstr_ncollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>instrs_of <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span>"</span></span>

<span class="comment1">― ‹ naive collection function ›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMexec_ncollect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_state <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMexec_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>JVMstep_ncollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span>
       <span class="main">∪</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∪</span> classes_above_frames <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="main">∪</span> classes_above_xcpts <span class="free"><span class="bound"><span class="entity">P</span></span></span>
   <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">JVMexec_ncollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="comment1">(****)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMNaiveCollect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_state <span class="main">⇒</span> jvm_state <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMNaiveCollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">=</span> JVMexec_ncollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> JVMNaiveCollectionSemantics<span class="main">:</span>
  CollectionSemantics <span class="quoted">JVMsmall</span> <span class="quoted">JVMendset</span> <span class="quoted">JVMNaiveCollect</span> <span class="quoted">JVMcombine</span> <span class="quoted">JVMcollect_id</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="comment1">(**************************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Smarter RTS algorithm"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMinstr_scollect</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>jvm_prog<span class="main">,</span> instr<span class="main">]</span> <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="keyword1">then</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>
    <span class="keyword1">else</span> classes_between <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="keyword1">then</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>
    <span class="keyword1">else</span> classes_between <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span> <span class="keyword1">then</span> classes_above <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>
    <span class="keyword1">else</span> classes_between <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>fst<span class="main">(</span>method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMinstr_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMstep_scollect</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span>jvm_prog<span class="main">,</span> instr<span class="main">,</span> init_call_status<span class="main">]</span> <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Calling <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Called <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Throwing <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">JVMstep_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">=</span> JVMinstr_scollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="comment1">― ‹ smarter collection function ›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMexec_scollect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_state <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMexec_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span>
   JVMstep_scollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>instrs_of <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">JVMexec_scollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="comment1">(****)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">JVMSmartCollect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_state <span class="main">⇒</span> jvm_state <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">JVMSmartCollect</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">=</span> JVMexec_scollect <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> JVMSmartCollectionSemantics<span class="main">:</span>
  CollectionSemantics <span class="quoted">JVMsmall</span> <span class="quoted">JVMendset</span> <span class="quoted">JVMSmartCollect</span> <span class="quoted">JVMcombine</span> <span class="quoted">JVMcollect_id</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="comment1">(***********************************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"A few lemmas using the instantiations"</span></span>

<span class="keyword1" id="JVMCollectionSemantics-JVMnaive_csmallD"><span class="command">lemma</span></span> JVMnaive_csmallD<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>
 <span class="main">⟹</span> JVMexec_ncollect <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">cset</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>

<span class="keyword1" id="JVMCollectionSemantics-JVMsmart_csmallD"><span class="command">lemma</span></span> JVMsmart_csmallD<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>
 <span class="main">⟹</span> JVMexec_scollect <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">cset</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>


<span class="keyword1" id="JVMCollectionSemantics-jvm_naive_to_smart_csmall_nstep_last_eq"><span class="command">lemma</span></span> jvm_naive_to_smart_csmall_nstep_last_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span><span class="main">;</span>
    <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span><span class="main">;</span>
    <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> JVMNaiveCollectionSemantics.csmall_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> JVMNaiveCollectionSemantics.cbigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>3<span class="main">)</span> JVMSmartCollectionSemantics.csmall_nstep_Suc_nend
      endset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> endset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> JVMNaiveCollectionSemantics.cbigD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∉</span> JVMendset"</span></span>
   <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_Suc_nend<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">≠</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> endset <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.cbig_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> neq Suc.prems<span class="main">(</span>3<span class="main">)</span> JVMSmartCollectionSemantics.csmall_nstep_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc'<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n1'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">cset2</span></span> <span class="skolem"><span class="skolem">cset1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1'</span><span class="main">,</span><span class="skolem">cset1'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> <span class="skolem">cset1'</span> <span class="main">∪</span> <span class="skolem">cset2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset2</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1'</span> <span class="skolem">n1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> coll'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span></span>
               <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n1'</span></span><span class="main">]</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span><span class="main">=</span><span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1 JVMNaiveCollectionSemantics.csmall_def
      JVMSmartCollectionSemantics.csmall_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cbig σ1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> σ1'<span class="main">(</span>3<span class="main">)</span> Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="JVMExecStepInductive">
<div class="head">
<h1>Theory JVMExecStepInductive</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      RTS/JinjaSuppl/JVMExecStepInductive.thy
    Author:     Susannah Mansky
    2020, UIUC

    Program Execution in the JVM as an inductive
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Inductive JVM execution"</span></span>

<span class="keyword1"><span class="command">theory</span></span> JVMExecStepInductive
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../jinjadci/theories/#JVMExec">JinjaDCI.JVMExec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> step_input <span class="main">=</span> StepI <span class="quoted">instr</span> <span class="main">|</span>
                      StepC <span class="quoted">cname</span> <span class="quoted"><span class="quoted">"cname list"</span></span> <span class="main">|</span> StepC2 <span class="quoted">cname</span> <span class="quoted"><span class="quoted">"cname list"</span></span> <span class="main">|</span>
                      StepT <span class="quoted"><span class="quoted">"cname list"</span></span> <span class="quoted">addr</span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">exec_step_ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>step_input<span class="main">,</span> jvm_prog<span class="main">,</span> heap<span class="main">,</span> val list<span class="main">,</span> val list<span class="main">,</span>
                  cname<span class="main">,</span> mname<span class="main">,</span> pc<span class="main">,</span> init_call_status<span class="main">,</span> frame list<span class="main">,</span> sheap<span class="main">,</span>jvm_state<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  exec_step_ind_Load<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Load <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Store<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">:=</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Push<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Push <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>  exec_step_ind_NewOOM_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"new_Addr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> None
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt OutOfMemory<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>  exec_step_ind_NewOOM_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span> new_Addr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> None<span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt OutOfMemory<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>  exec_step_ind_New_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"new_Addr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">↦</span>blank <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Addr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>  exec_step_ind_New_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span> new_Addr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">↦</span>blank <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Addr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>  exec_step_ind_New_Init<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">obj</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">obj</span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getfield_Null<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> Null
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NullPointer<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getfield_NoField<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> Null<span class="main">;</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchFieldError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getfield_Static<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> Null<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getfield<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> Null<span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getstatic_NoField<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchFieldError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getstatic_NonStatic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getstatic_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> the <span class="main">(</span><span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getstatic_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span>Done<span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Getstatic_Init<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span>Done<span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putfield_Null<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd<span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">=</span> Null
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NullPointer<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putfield_NoField<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> hd<span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchFieldError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putfield_Static<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> hd<span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putfield<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> hd<span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putstatic_NoField<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchFieldError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putstatic_NonStatic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putstatic_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">:=</span>Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">↦</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putstatic_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Done<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">:=</span>Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">↦</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Putstatic_Init<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> field <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">D'</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Checkcast<span class="main">:</span>
<span class="quoted"><span class="quoted">"cast_ok <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Checkcast <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Checkcast_Error<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">¬</span>cast_ok <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Checkcast <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt ClassCast<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invoke_Null<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Null
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NullPointer<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invoke_NoMethod<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span>
   <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchMethodError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invoke_Static<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span><span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invoke<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span>the_Addr <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span><span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Null<span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">]</span><span class="main">@</span><span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span> undefined<span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">,</span>No_ics<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invokestatic_NoMethod<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span><span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NoSuchMethodError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invokestatic_NonStatic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span><span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>NonStatic<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt IncompatibleClassChangeError<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invokestatic_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>  <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">f'</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span> undefined<span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">,</span>No_ics<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invokestatic_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>  <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">f'</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span> undefined<span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">,</span>No_ics<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Invokestatic_Init<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mxl<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">xt</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">sees</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
   <span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">≠</span> Called <span class="bound">Cs</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Return_Last_Init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">loc<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> clinit <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">:=</span>Some<span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Return_Last<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≠</span> clinit
   <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">loc<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Return_Init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> clinit <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">loc<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> clinit <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
     <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">:=</span>Some<span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Return_NonStatic<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span>NonStatic<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≠</span> clinit <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">loc<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
     <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span>Suc <span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Return_Static<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span>Static<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> method <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≠</span> clinit <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">loc<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
     <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stk'</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span>Suc <span class="free"><span class="bound"><span class="entity">pc'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ics'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Pop<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI Pop<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_IAdd<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI IAdd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
  <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>Intg <span class="main">(</span>the_Intg <span class="main">(</span>hd <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> the_Intg <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>tl <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_IfFalse_False<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> Bool False
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>IfFalse <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> nat<span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_IfFalse_nFalse<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">≠</span> Bool False
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>IfFalse <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_CmpEq<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI CmpEq<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span>Bool <span class="main">(</span>hd <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span> <span class="main">#</span> tl <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Goto<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepI <span class="main">(</span>Goto <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
   <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> nat<span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Throw<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">≠</span> Null
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Throw<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>the_Addr <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Throw_Null<span class="main">:</span>
<span class="quoted"><span class="quoted">"hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> Null
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepI Throw<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span>addr_of_sys_xcpt NullPointer<span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_None_Called<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> None <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">:=</span> Some <span class="main">(</span>sblank <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> Prepared<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_Done<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Done<span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_Processing<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Processing<span class="main">)</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_Error<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Error<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Throwing <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">(</span>addr_of_sys_xcpt NoClassDefFoundError<span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_Prepared_Object<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Prepared<span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">:=</span>Some<span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Processing<span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Object <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Called <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init_Prepared_nObject<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sfs</span></span></span><span class="main">,</span> Prepared<span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">sh'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">:=</span>Some<span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Processing<span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> Object<span class="main">;</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> fst<span class="main">(</span>the<span class="main">(</span>class <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">exec_step_ind</span> <span class="main">(</span>StepC <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Calling <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh'</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_Init<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepC2 <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> create_init_frame <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span> Called <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_InitThrow<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span>Throwing <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">↦</span> <span class="main">(</span>fst<span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Error<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> exec_step_ind_InitThrow_End<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_ind</span> <span class="main">(</span>StepT <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="free"><span class="bound"><span class="entity">frs</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span>
    <span class="main">(</span><span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⌋</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span>No_ics<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">frs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(** ******* **)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> exec_step_ind_cases <span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Load <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Store <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Push <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>New <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Getfield <span class="free">F</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Getstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Putfield <span class="free">F</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Putstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Checkcast <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Invoke <span class="free">M</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Invokestatic <span class="free">C</span> <span class="free">M</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI Return<span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI Pop<span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI IAdd<span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>IfFalse <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI CmpEq<span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI <span class="main">(</span>Goto <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepI Throw<span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepC <span class="free">C'</span> <span class="free">Cs</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepC2 <span class="free">C'</span> <span class="free">Cs</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>
 <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>StepT <span class="free">Cs</span> <span class="free">a</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="free">σ</span>"</span></span>


<span class="comment1">― ‹ Deriving <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">step_input</span></span><span class="antiquote">}</span></span> for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step_ind</span><span class="antiquote">}</span></span> from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step</span><span class="antiquote">}</span></span> arguments ›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec_step_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>jvm_prog<span class="main">,</span> cname<span class="main">,</span> mname<span class="main">,</span> pc<span class="main">,</span> init_call_status<span class="main">]</span> <span class="main">⇒</span> step_input"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_input</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Calling <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span> StepC <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_input</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Called <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> StepC2 <span class="free"><span class="bound"><span class="entity">C'</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_input</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>Throwing <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> StepT <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec_step_input</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">=</span> StepI <span class="main">(</span>instrs_of <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_input_StepTD"><span class="command">lemma</span></span> exec_step_input_StepTD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> StepT <span class="free">Cs</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Throwing <span class="free">Cs</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_input_StepCD"><span class="command">lemma</span></span> exec_step_input_StepCD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> StepC <span class="free">C'</span> <span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Calling <span class="free">C'</span> <span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_input_StepC2D"><span class="command">lemma</span></span> exec_step_input_StepC2D<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> StepC2 <span class="free">C'</span> <span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="free">C'</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_input_StepID"><span class="command">lemma</span></span> exec_step_input_StepID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> StepI <span class="free">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics<span class="main">)</span> <span class="main">∧</span> instrs_of <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Equivalence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">exec_step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">exec_step_input</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_imp_exec_step_ind"><span class="command">lemma</span></span> exec_step_imp_exec_step_ind<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exec_step_ind <span class="main">(</span>exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StepT <span class="skolem">Cs</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Throwing <span class="skolem">Cs</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_InitThrow exec_step_ind_InitThrow_End StepT es
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StepC <span class="skolem">C1</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Calling <span class="skolem">C1</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="skolem">C1</span> clinit <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="skolem">C1</span> clinit"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">C1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_None_Called ics assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Done exec_step_ind_Init_Processing
      exec_step_ind_Init_Error m lets Some ics assms
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Prepared
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Prepared_Object<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">]</span> exec_step_ind_Init_Prepared_nObject
       sfsi m lets Prepared Some ics assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StepC2 <span class="skolem">C1</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="skolem">C1</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StepI <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    exec_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_instr <span class="skolem">i</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Load <span class="skolem">x1</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr exec_step_ind_Load StepI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Store <span class="skolem">x2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr exec_step_ind_Store StepI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Push <span class="skolem">x3</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr exec_step_ind_Push StepI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>New <span class="skolem">C1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">sh</span> <span class="skolem">C1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">sh</span> <span class="skolem">C1</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_New_Called exec_step_ind_NewOOM_Called
       exec_step_ind_New_Done exec_step_ind_NewOOM_Done
       exec_step_ind_New_Init sfsi New StepI exec_instr ics <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getfield <span class="skolem">F1</span> <span class="skolem">C1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">h</span><span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">h</span><span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b'</span><span class="main">:</span><span class="bound">t'</span> <span class="keyword1">in</span> <span class="skolem">C1</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C1</span><span class="main">,</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getfield_Null exec_step_ind_Getfield_NoField
       exec_step_ind_Getfield_Static exec_step_ind_Getfield lets Getfield StepI exec_instr
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm staticb.splits<span class="main">)</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">D1</span> <span class="skolem">F1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b'</span><span class="main">:</span><span class="bound">t'</span> <span class="keyword1">in</span> <span class="skolem">D1</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D1</span><span class="main">,</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> NonStatic <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField exec_step_ind_Getstatic_NonStatic
        field lets Getstatic exec_instr StepI <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
          exec_step_ind_Getstatic_Called exec_step_ind_Getstatic_Init
          Static field lets Getstatic exec_instr StepI ics
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nCalled<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free">ics</span> <span class="main">≠</span> Called <span class="bound">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">D1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D1</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
            exec_step_ind_Getstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
            field lets None False Static Getstatic exec_instr StepI ics
           <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
            exec_step_ind_Getstatic_Init sfsi False Static Some field lets Getstatic exec_instr
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
              exec_step_ind_Getstatic_Done<span class="main">[</span><span class="operator">OF</span> _ _ nCalled<span class="main">]</span> exec_step_ind_Getstatic_Init
              sfsi False Static Some field lets Getstatic exec_instr StepI ics
             <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> nD<span class="main">:</span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D1</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sfsi Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nD
            <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Processing <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
                exec_step_ind_Getstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Getstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Prepared <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
                exec_step_ind_Getstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Getstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Error <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField
                exec_step_ind_Getstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Getstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putfield <span class="skolem">F1</span> <span class="skolem">C1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">h</span><span class="main">(</span>the_Addr <span class="main">(</span>hd<span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">h</span><span class="main">(</span>the_Addr <span class="main">(</span>hd<span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b'</span><span class="main">:</span><span class="bound">t'</span> <span class="keyword1">in</span> <span class="skolem">C1</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C1</span><span class="main">,</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield_Null exec_step_ind_Putfield_NoField
       exec_step_ind_Putfield_Static exec_step_ind_Putfield lets Putfield exec_instr StepI
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm staticb.splits<span class="main">)</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">D1</span> <span class="skolem">F1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b'</span><span class="main">:</span><span class="bound">t'</span> <span class="keyword1">in</span> <span class="skolem">D1</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D1</span><span class="main">,</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> NonStatic <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField exec_step_ind_Putstatic_NonStatic
        field lets Putstatic exec_instr StepI <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
          exec_step_ind_Putstatic_Called exec_step_ind_Putstatic_Init
          Static field lets Putstatic exec_instr StepI ics
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the<span class="main">(</span><span class="free">sh</span> <span class="skolem">D1</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nCalled<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free">ics</span> <span class="main">≠</span> Called <span class="bound">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">D1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D1</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
            exec_step_ind_Putstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
            field lets None False Static Putstatic exec_instr StepI ics
           <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
            exec_step_ind_Putstatic_Init sfsi False Static Some field lets Putstatic exec_instr
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
              exec_step_ind_Putstatic_Done<span class="main">[</span><span class="operator">OF</span> _ _ nCalled<span class="main">]</span> exec_step_ind_Putstatic_Init
              sfsi False Static Some field lets Putstatic exec_instr StepI ics
             <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> nD<span class="main">:</span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D1</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sfsi Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nD
            <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Processing <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
                exec_step_ind_Putstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Putstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Prepared <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
                exec_step_ind_Putstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Putstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Error <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField
                exec_step_ind_Putstatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some field lets Putstatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Checkcast <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Checkcast exec_step_ind_Checkcast_Error exec_instr StepI
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">M1</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span><span class="main">!</span><span class="skolem">n</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke_Null Invoke exec_instr StepI
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span><span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> method<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="var">?C</span> <span class="skolem">M1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="var">?C</span> <span class="skolem">M1</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke_NoMethod
        exec_step_ind_Invoke_Static exec_step_ind_Invoke method False Invoke exec_instr StepI
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm staticb.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invokestatic <span class="skolem">C1</span> <span class="skolem">M1</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> lets<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">M1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">M1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> method<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">Ts'</span> <span class="bound">t'</span> <span class="bound">m'</span> <span class="bound">D'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">sees</span> <span class="skolem">M1</span><span class="main">,</span><span class="bound">b'</span><span class="main">:</span><span class="bound">Ts'</span> <span class="main">→</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">m'</span> <span class="keyword1">in</span> <span class="bound">D'</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">D'</span><span class="main">,</span><span class="bound">b'</span><span class="main">,</span><span class="bound">Ts'</span><span class="main">,</span><span class="bound">t'</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> NonStatic <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod exec_step_ind_Invokestatic_NonStatic
        m method lets Invokestatic exec_instr StepI  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
          exec_step_ind_Invokestatic_Called exec_step_ind_Invokestatic_Init
          Static m method lets Invokestatic exec_instr StepI ics
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nCalled<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free">ics</span> <span class="main">≠</span> Called <span class="bound">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
            exec_step_ind_Invokestatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
            method m lets None False Static Invokestatic exec_instr StepI ics
           <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
            exec_step_ind_Invokestatic_Init sfsi False Static Some method lets Invokestatic exec_instr
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
              exec_step_ind_Invokestatic_Done<span class="main">[</span><span class="operator">OF</span> _ _ _ nCalled<span class="main">]</span> exec_step_ind_Invokestatic_Init
              sfsi False Static Some m method lets Invokestatic exec_instr StepI ics
             <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> nD<span class="main">:</span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">D</span> <span class="main">≠</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sfsi Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nD
            <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Processing <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
                exec_step_ind_Invokestatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some m method lets Invokestatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Prepared <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
                exec_step_ind_Invokestatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some m method lets Invokestatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Error <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod
                exec_step_ind_Invokestatic_Init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ nDone nCalled<span class="main">]</span>
                sfsi False Static Some m method lets Invokestatic exec_instr StepI ics
               <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Return
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> method<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> <span class="free">M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_Last_Init exec_step_ind_Return_Last
      exec_step_ind_Return_Init exec_step_ind_Return_NonStatic exec_step_ind_Return_Static
       method Return exec_instr StepI ics
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm staticb.splits bool.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Pop <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_Pop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> IAdd <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_IAdd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Goto <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_Goto <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> CmpEq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_CmpEq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfFalse <span class="skolem">x17</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_IfFalse_nFalse exec_step_ind_IfFalse_False
       exec_instr StepI <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.splits staticb.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Throw <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> exec_instr StepI exec_step_ind_Throw exec_step_ind_Throw_Null
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> val.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMExecStepInductive-exec_step_ind_imp_exec_step"><span class="command">lemma</span></span> exec_step_ind_imp_exec_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> esi<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step_ind <span class="free">si</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> <span class="free">si</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> StepI<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="bound">Cs</span> <span class="bound">i</span> <span class="main">.</span> exec_step_input <span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="main">(</span>Called <span class="bound">Cs</span><span class="main">)</span> <span class="main">=</span> StepI <span class="bound">i</span>
           <span class="main">⟹</span> instrs_of <span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="main">!</span> <span class="bound">pc</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">Cs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">Cs</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exec_step_input <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="main">=</span> StepI <span class="skolem">i</span>
           <span class="main">⟹</span> instrs_of <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="main">!</span> <span class="skolem">pc</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">Cs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> StepC<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="bound">ics</span> <span class="bound">C'</span> <span class="bound">Cs</span><span class="main">.</span> exec_step_input <span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="bound">ics</span> <span class="main">=</span> StepC <span class="bound">C'</span> <span class="bound">Cs</span> <span class="main">⟹</span> <span class="bound">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> StepT<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="bound">ics</span> <span class="bound">Cs</span> <span class="bound">a</span><span class="main">.</span> exec_step_input <span class="bound">P</span> <span class="bound">C</span> <span class="bound">M</span> <span class="bound">pc</span> <span class="bound">ics</span> <span class="main">=</span> StepT <span class="bound">Cs</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">ics</span> <span class="main">=</span> Throwing <span class="bound">Cs</span> <span class="bound">a</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_step_ind.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_NewOOM_Done <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">obj</span> <span class="skolem">h</span> <span class="skolem">ics</span> <span class="skolem">P</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_New_Done <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">obj</span> <span class="skolem">h</span> <span class="skolem">a</span> <span class="skolem">ics</span> <span class="skolem">P</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_New_Init <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">ics</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getfield_NoField <span class="skolem">v</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getfield_Static <span class="skolem">v</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">t</span> <span class="skolem">C</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>snd<span class="main">(</span>field <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getfield <span class="skolem">v</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getstatic_NonStatic <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">t</span> <span class="skolem">D</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits
                             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_Called
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI
                                 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getstatic_Done <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">D</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">ics</span> <span class="skolem">sh</span> <span class="skolem">sfs</span> <span class="skolem">v</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits
                                       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getstatic_Init <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">D</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">sh</span> <span class="skolem">ics</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits staticb.splits
                          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putfield_NoField <span class="skolem">r</span> <span class="skolem">stk</span> <span class="skolem">a</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd<span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putfield_Static <span class="skolem">r</span> <span class="skolem">stk</span> <span class="skolem">a</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">P</span> <span class="skolem">F</span> <span class="skolem">t</span> <span class="skolem">C</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd<span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>snd<span class="main">(</span>field <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putfield <span class="skolem">v</span> <span class="skolem">stk</span> <span class="skolem">r</span> <span class="skolem">a</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd<span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putstatic_NonStatic <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">t</span> <span class="skolem">D</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits
                             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putstatic_Called
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI
                                 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putstatic_Done <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">D</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">ics</span> <span class="skolem">sh</span> <span class="skolem">sfs</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits
                                       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putstatic_Init <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">D</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">sh</span> <span class="skolem">ics</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> staticb.splits init_state.splits
                        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invoke <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">r</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">f'</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_Called <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">ics</span> <span class="skolem">ics'</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_Done <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">ics</span> <span class="skolem">sh</span> <span class="skolem">sfs</span> <span class="skolem">f'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_Init <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">sh</span> <span class="skolem">ics</span> <span class="skolem">n</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Return_NonStatic <span class="skolem">D</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h</span> <span class="skolem">stk<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">loc<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">stk'</span> <span class="skolem">loc'</span> <span class="skolem">C'</span> <span class="skolem">m'</span> <span class="skolem">pc'</span> <span class="skolem">ics'</span> <span class="skolem">frs'</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="skolem">P</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Return_Static <span class="skolem">D</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h</span> <span class="skolem">stk<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">loc<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">stk'</span> <span class="skolem">loc'</span> <span class="skolem">C'</span> <span class="skolem">m'</span> <span class="skolem">pc'</span> <span class="skolem">ics'</span> <span class="skolem">frs'</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="skolem">P</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_IfFalse_nFalse <span class="skolem">stk</span> <span class="skolem">i</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">stk</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Throw_Null <span class="skolem">stk</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">stk</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init <span class="skolem">C</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(***)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Load <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Store <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Push <span class="skolem">v</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_NewOOM_Called <span class="skolem">h</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span> <span class="skolem">sh</span> <span class="skolem">ics'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_New_Called <span class="skolem">h</span> <span class="skolem">a</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">frs</span> <span class="skolem">sh</span> <span class="skolem">ics'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getfield_Null <span class="skolem">stk</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Getstatic_NoField <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">D</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putfield_Null <span class="skolem">stk</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putstatic_NoField <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">D</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Checkcast <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Checkcast_Error <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invoke_Null <span class="skolem">stk</span> <span class="skolem">n</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invoke_NoMethod <span class="skolem">r</span> <span class="skolem">stk</span> <span class="skolem">n</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">P</span> <span class="skolem">M</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invoke_Static <span class="skolem">r</span> <span class="skolem">stk</span> <span class="skolem">n</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_NoMethod <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">n</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_NonStatic <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Return_Last_Init <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">loc<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Return_Last <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">loc<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Return_Init <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">m</span> <span class="skolem">P</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h</span> <span class="skolem">stk<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">loc<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">stk'</span> <span class="skolem">loc'</span> <span class="skolem">C'</span> <span class="skolem">m'</span> <span class="skolem">pc'</span> <span class="skolem">ics'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Pop <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_IAdd <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_IfFalse_False <span class="skolem">stk</span> <span class="skolem">i</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_CmpEq <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Goto <span class="skolem">i</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Throw <span class="skolem">stk</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_None_Called <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_Done <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">sfs</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_Processing <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">sfs</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_Error <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">sfs</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_Prepared_Object <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">sfs</span> <span class="skolem">sh'</span> <span class="skolem">Cs</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_Prepared_nObject <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">sfs</span> <span class="skolem">sh'</span> <span class="skolem">D</span> <span class="skolem">P</span> <span class="skolem">Cs</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepC<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_InitThrow <span class="skolem">C</span> <span class="skolem">Cs</span> <span class="skolem">a</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepT<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_InitThrow_End <span class="skolem">a</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> StepT<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step_ind</span><span class="antiquote">}</span></span> reach the same result given equivalent input ›</span>
<span class="keyword1" id="JVMExecStepInductive-exec_step_ind_equiv"><span class="command">lemma</span></span> exec_step_ind_equiv<span class="main">:</span>
 <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>
   <span class="main">=</span> exec_step_ind <span class="main">(</span>exec_step_input <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span><span class="main">)</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">(</span><span class="free">xp'</span><span class="main">,</span> <span class="free">h'</span><span class="main">,</span> <span class="free">frs'</span><span class="main">,</span> <span class="free">sh'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> exec_step_imp_exec_step_ind exec_step_ind_imp_exec_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="JVMCollectionBasedRTS">
<div class="head">
<h1>Theory JVMCollectionBasedRTS</h1>
</div>
<pre class="source"><span class="comment1">(* File: RTS/JVM_RTS/JVMCollectionBasedRTS.thy *)</span>
<span class="comment1">(* Author: Susannah Mansky, UIUC 2020 *)</span>
<span class="comment1">(* Proof of safety of certain collection based RTS algorithms for Jinja JVM *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instantiating <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">CollectionBasedRTS</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with Jinja JVM"</span></span>

<span class="keyword1"><span class="command">theory</span></span> JVMCollectionBasedRTS
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#CollectionBasedRTS">../Common/CollectionBasedRTS</a>"</span> <a href="#JVMCollectionSemantics">JVMCollectionSemantics</a>
   <a href="../../jinjadci/theories/#BVSpecTypeSafe">JinjaDCI.BVSpecTypeSafe</a> <span class="quoted">"<a href="#JVMExecStepInductive">../JinjaSuppl/JVMExecStepInductive</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-eq_equiv"><span class="command">lemma</span></span> eq_equiv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def refl_on_def sym_def trans_def<span class="main">)</span>

<span class="comment1">(**********************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Some <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"classes_above"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> lemmas ›</span></span>
<span class="comment1">(* here because they require ClassAdd/StartProg *)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-start_prog_classes_above_Start"><span class="command">lemma</span></span> start_prog_classes_above_Start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"classes_above <span class="main">(</span>start_prog <span class="free">P</span> <span class="free">C</span> <span class="free">M</span><span class="main">)</span> Start <span class="main">=</span> <span class="main">{</span>Object<span class="main">,</span>Start<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> start_prog_Start_super<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> subcls1_confluent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JVMCollectionBasedRTS-class_add_classes_above"><span class="command">lemma</span></span> class_add_classes_above<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_class <span class="free">P</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="main">(</span>class_add <span class="free">P</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">cdec</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> classes_above <span class="free">P</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> class_add_subcls class_add_subcls_rev<span class="main">)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-class_add_classes_above_xcpts"><span class="command">lemma</span></span> class_add_classes_above_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_class <span class="free">P</span> <span class="free">C</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ncp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> <span class="main">¬</span><span class="free">P</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span>class_add <span class="free">P</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span> <span class="free">cdec</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> classes_above_xcpts <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms class_add_classes_above <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*********)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"JVM next-step lemmas for initialization calling"</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-JVM_New_next_step"><span class="command">lemma</span></span> JVM_New_next_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> New <span class="free">C</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="main">[]</span> <span class="main">∧</span> sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="free">σ'</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∉</span> JVMendset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span><span class="main">=</span><span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M'</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> σ nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="skolem"><span class="skolem">sh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp'</span><span class="main">,</span><span class="skolem">h'</span><span class="main">,</span><span class="skolem">frs'</span><span class="main">,</span><span class="skolem">sh'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="skolem">frs'</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">sh'</span> <span class="main">∧</span> <span class="skolem">frs'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xp'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> nDone Some f1 frs σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a Some σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics σ σ' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-JVM_Getstatic_next_step"><span class="command">lemma</span></span> JVM_Getstatic_next_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Getstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span>Static<span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="free">σ'</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∉</span> JVMendset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span><span class="main">=</span><span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M'</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> σ nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="skolem"><span class="skolem">sh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp'</span><span class="main">,</span><span class="skolem">h'</span><span class="main">,</span><span class="skolem">frs'</span><span class="main">,</span><span class="skolem">sh'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ex'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> field <span class="free">P</span> <span class="free">D</span> <span class="free">F</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span><span class="main">,</span>Static<span class="main">,</span><span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fC field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nCalled'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Cs</span><span class="main">.</span> <span class="skolem">ics</span> <span class="main">≠</span> Called <span class="bound">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics f1 frs σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="skolem">frs'</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">sh'</span> <span class="main">∧</span> <span class="skolem">frs'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xp'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> field ex' σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> field ex' a Some σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics σ σ' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-JVM_Putstatic_next_step"><span class="command">lemma</span></span> JVM_Putstatic_next_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Putstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span>Static<span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="free">σ'</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∉</span> JVMendset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span><span class="main">=</span><span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M'</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> σ nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="skolem"><span class="skolem">sh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp'</span><span class="main">,</span><span class="skolem">h'</span><span class="main">,</span><span class="skolem">frs'</span><span class="main">,</span><span class="skolem">sh'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ex'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> field<span class="main">:</span> <span class="quoted"><span class="quoted">"field <span class="free">P</span> <span class="free">D</span> <span class="free">F</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span><span class="main">,</span>Static<span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fC field_def2 has_field_idemp has_field_sees <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ics'<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="skolem">frs'</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">sh'</span> <span class="main">∧</span> <span class="skolem">frs'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xp'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> field ex' σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> field ex' a Some σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics σ σ' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-JVM_Invokestatic_next_step"><span class="command">lemma</span></span> JVM_Invokestatic_next_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Invokestatic <span class="free">C</span> <span class="free">M</span> <span class="free">n</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> mC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span>Static<span class="main">:</span><span class="free">Ts</span> <span class="main">→</span> <span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nDone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="free">σ'</span> <span class="main">∧</span> <span class="free">σ'</span> <span class="main">∉</span> JVMendset"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span><span class="main">=</span><span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f1</span><span class="main">=</span><span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M'</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> σ nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="skolem"><span class="skolem">sh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp'</span><span class="main">,</span><span class="skolem">h'</span><span class="main">,</span><span class="skolem">frs'</span><span class="main">,</span><span class="skolem">sh'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ex'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mC <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> method<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> method <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span><span class="main">,</span>Static<span class="main">,</span><span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mC <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ics'<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="skolem">frs'</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">sh'</span> <span class="main">∧</span> <span class="skolem">frs'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xp'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> method ex' σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nDone'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> nDone Some f1 frs σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> method ex' a Some σ' xp f1 frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics σ σ' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(***********************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">main</span> <span class="main">=</span> <span class="inner_quoted">''main''</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Test</span> <span class="main">=</span> <span class="inner_quoted">''Test''</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_oracle</span> <span class="main">=</span> <span class="inner_quoted">''oracle''</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> jvm_class <span class="main">=</span> <span class="quoted"><span class="quoted">"jvm_method cdecl"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> jvm_prog_out <span class="main">=</span> <span class="quoted"><span class="quoted">"jvm_state <span class="main">×</span> cname set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"A deselection algorithm based on classes that have changed from
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">P1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">P2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">jvm_deselect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_prog_out <span class="main">⇒</span> jvm_prog <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_deselect</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">cset</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cset</span></span></span> <span class="main">∩</span> <span class="main">(</span>classes_changed <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">jvm_progs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_progs</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> wf_jvm_prog <span class="bound">P</span> <span class="main">∧</span> <span class="main">¬</span>is_class <span class="bound">P</span> Start <span class="main">∧</span> <span class="main">¬</span>is_class <span class="bound">P</span> Test
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">b'</span> <span class="bound">Ts'</span> <span class="bound">T'</span> <span class="bound">m'</span> <span class="bound">D'</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⊢</span> Object <span class="keyword1">sees</span> start_m<span class="main">,</span> <span class="bound">b'</span> <span class="main">:</span>  <span class="bound">Ts'</span><span class="main">→</span><span class="bound">T'</span> <span class="main">=</span> <span class="bound">m'</span> <span class="keyword1">in</span> <span class="bound">D'</span>
                                            <span class="main">⟶</span> <span class="bound">b'</span> <span class="main">=</span> Static <span class="main">∧</span> <span class="bound">Ts'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">T'</span> <span class="main">=</span> Void<span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">jvm_tests</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_class set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_tests</span> <span class="main">=</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> fst <span class="bound">t</span> <span class="main">=</span> Test
 <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> jvm_progs<span class="main">.</span> wf_jvm_prog <span class="main">(</span><span class="bound">t</span><span class="main">#</span><span class="bound">P</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">t</span><span class="main">#</span><span class="bound">P</span> <span class="main">⊢</span> Test <span class="keyword1">sees</span> main<span class="main">,</span>Static<span class="main">:</span> <span class="main">[]</span> <span class="main">→</span> Void <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> Test<span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jvm_make_test_prog</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_class <span class="main">⇒</span> jvm_prog"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_make_test_prog</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> start_prog <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> main"</span></span>

<span class="keyword1"><span class="command">declare</span></span> jvm_progs_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> jvm_tests_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">(*****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definition lemmas"</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_progs_tests_nStart"><span class="command">lemma</span></span> jvm_progs_tests_nStart<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_class <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> Start"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_class_def class_def Start_def Test_def<span class="main">)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_make_test_prog_classes_above_xcpts"><span class="command">lemma</span></span> jvm_make_test_prog_classes_above_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> classes_above_xcpts <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_class <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> Start"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> jvm_progs_tests_nStart<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P t<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> nT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_class <span class="free">P</span> Test"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_syscls <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">∧</span> wf_syscls <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def wf_jvm_prog_phi_def wf_prog_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> is_class <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="bound">D</span> <span class="main">∧</span> is_class <span class="free">P</span> <span class="bound">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_syscls_def is_class_def class_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> weak_map_of_SomeI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf_nclass_nsub<span class="main">[</span><span class="operator">OF</span> _ _ nS<span class="main">]</span> P t <span class="keyword1"><span class="command">have</span></span> nspS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Start"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def wf_jvm_prog_phi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wf_nclass_nsub<span class="main">[</span><span class="operator">OF</span> _ _ nT<span class="main">]</span> P <span class="keyword1"><span class="command">have</span></span> nspT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> <span class="main">¬</span><span class="free">P</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Test"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def wf_jvm_prog_phi_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> class_add_classes_above_xcpts<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted">Start</span><span class="main">,</span> <span class="operator">OF</span> nS nspS<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> classes_above_xcpts <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> class_add_classes_above_xcpts<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted">Test</span><span class="main">,</span> <span class="operator">OF</span> nT nspT<span class="main">]</span> t
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> classes_above_xcpts <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_make_test_prog_sees_Test_main"><span class="command">lemma</span></span> jvm_make_test_prog_sees_Test_main<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> jvm_make_test_prog <span class="free">P</span> <span class="free">t</span> <span class="main">⊢</span> Test <span class="keyword1">sees</span> main<span class="main">,</span> Static <span class="main">:</span>  <span class="main">[]</span><span class="main">→</span>Void <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> Test"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"jvm_make_test_prog <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    meth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="free">P</span> <span class="main">⊢</span> Test <span class="keyword1">sees</span> main<span class="main">,</span>Static<span class="main">:</span><span class="main">[]</span> <span class="main">→</span> Void <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">in</span> Test"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    nstart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_class <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> Start"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_class_def class_def Start_def Test_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> class_add_sees_method<span class="main">[</span><span class="operator">OF</span> meth nstart<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Naive RTS algorithm"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">jvm_naive_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_class <span class="main">⇒</span> jvm_prog_out set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_naive_out</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> JVMNaiveCollectionSemantics.cbig <span class="main">(</span>jvm_make_test_prog <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>start_state <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jvm_naive_collect_start</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_naive_collect_start</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_out_xcpts_collected"><span class="command">lemma</span></span> jvm_naive_out_xcpts_collected<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span>start_prog <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> main<span class="main">)</span> <span class="main">⊆</span> snd <span class="free">o1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">coll'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">coll'</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="main">(</span>start_prog <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> main<span class="main">)</span> <span class="main">(</span>start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">o1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> JVMNaiveCollectionSemantics.cbig_stepD<span class="main">[</span><span class="operator">OF</span> cbig start_state_nend<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def start_state_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(***********************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Naive algorithm correctness"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We start with correctness over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">exec_instr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then all the
 functions/pieces that are used by naive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">csmall</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (that is, pieces
 used by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">exec</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> - such as which frames are used based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ics</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 - and all functions used by the collection function). We then prove that
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">csmall</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is existence safe, extend this result to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cbig</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and
 finally prove the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">existence_safe</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> statement over the locale pieces."</span></span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_instr</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_exec_instr"><span class="command">lemma</span></span> ncollect_exec_instr<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMinstr_ncollect <span class="free">P</span> <span class="free">i</span> <span class="free">h</span> <span class="free">stk</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> instrs_of <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exec_instr <span class="free">i</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> exec_instr <span class="free">i</span> <span class="free">P'</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>New <span class="skolem">C1</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_blank<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> init_state.splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getfield <span class="skolem">F1</span> <span class="skolem">C1</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b1</span><span class="main">:</span><span class="skolem">t1</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> has<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b1</span><span class="main">:</span><span class="skolem">t1</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Getfield assms classes_above_has_field<span class="main">[</span><span class="operator">OF</span> D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_decl_above True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">⊆</span> classes_above <span class="free">P</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_above_subcls_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> has True Getfield assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> nex<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False Getfield assms
         classes_above_has_field2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?D</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">C1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nex Getfield assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> meth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> has_field_decl_above<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">D1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C1 rtrancl_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> meth Getstatic assms classes_above_has_field<span class="main">[</span><span class="operator">OF</span> C1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True D1 Getstatic assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Getstatic assms
       classes_above_has_field2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">C1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">D1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False Getstatic assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putfield <span class="skolem">F1</span> <span class="skolem">C1</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b1</span><span class="main">:</span><span class="skolem">t1</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> has<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b1</span><span class="main">:</span><span class="skolem">t1</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Putfield assms classes_above_has_field<span class="main">[</span><span class="operator">OF</span> D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_decl_above True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">⊆</span> classes_above <span class="free">P</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_above_subcls_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> has True Putfield assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> nex<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">C1</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False Putfield assms
         classes_above_has_field2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?D</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">C1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nex Putfield assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Putstatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> meth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> has_field_decl_above<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">D1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C1 rtrancl_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> meth Putstatic assms classes_above_has_field<span class="main">[</span><span class="operator">OF</span> C1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True D1 Putstatic assms classes_above_field<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="skolem">F1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">b</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Putstatic assms classes_above_has_field2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">C1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">D1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False Putstatic assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"field <span class="free">P'</span> <span class="skolem">D1</span> <span class="skolem">F1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Checkcast <span class="skolem">C1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> Checkcast assms classes_above_subcls classes_above_subcls2
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cast_ok_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cast_ok_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span><span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invoke assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Invoke assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl</span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> meth<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P'</span> <span class="var">?C</span> <span class="skolem">M</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl</span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P'</span> <span class="var">?C</span> <span class="skolem">M</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> meq<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="var">?C</span> <span class="skolem">M</span> <span class="main">=</span> method <span class="free">P'</span> <span class="var">?C</span> <span class="skolem">M</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> classes_above_method<span class="main">[</span><span class="operator">OF</span> above<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="var">?C</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> nex<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="var">?C</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> classes_above_sees_method2<span class="main">[</span><span class="operator">OF</span> above<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nex False Invoke <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="var">?C</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> classes_above_sees_method<span class="main"><span class="main">[</span></span><span class="operator">OF</span> above<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> meq meth True Invoke <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invokestatic <span class="skolem">C1</span> <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl</span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span> meth<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">M</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">Ts</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl</span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">M</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> meq<span class="main">:</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="skolem">C1</span> <span class="skolem">M</span> <span class="main">=</span> method <span class="free">P'</span> <span class="skolem">C1</span> <span class="skolem">M</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> classes_above_method<span class="main">[</span><span class="operator">OF</span> above<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> classes_above_sees_method2<span class="main">[</span><span class="operator">OF</span> above<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False Invokestatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span><span class="bound">b</span><span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> classes_above_sees_method<span class="main"><span class="main">[</span></span><span class="operator">OF</span> above<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> meq meth True Invokestatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Return <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Load <span class="skolem">x1</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Store <span class="skolem">x2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Push <span class="skolem">x3</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Goto <span class="skolem">x15</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfFalse <span class="skolem">x17</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">― ‹ if collected classes unchanged, instruction collection unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_JVMinstr_ncollect"><span class="command">lemma</span></span> ncollect_JVMinstr_ncollect<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMinstr_ncollect <span class="free">P</span> <span class="free">i</span> <span class="free">h</span> <span class="free">stk</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"JVMinstr_ncollect <span class="free">P</span> <span class="free">i</span> <span class="free">h</span> <span class="free">stk</span> <span class="main">=</span> JVMinstr_ncollect <span class="free">P'</span> <span class="free">i</span> <span class="free">h</span> <span class="free">stk</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>New <span class="skolem">C1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getfield <span class="skolem">F</span> <span class="skolem">C1</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="var">?D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> classes_above_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Getfield <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getstatic <span class="skolem">C1</span> <span class="skolem">P1</span> <span class="skolem">D1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="skolem">C1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> classes_above_set assms Getstatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Getstatic  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putfield <span class="skolem">F</span> <span class="skolem">C1</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="var">?D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> classes_above_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Putfield <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putstatic <span class="skolem">C1</span> <span class="skolem">F</span> <span class="skolem">D1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">=</span> classes_above <span class="free">P'</span> <span class="skolem">C1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> classes_above_set assms Putstatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Putstatic  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Checkcast <span class="skolem">C1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
   classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
   classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span><span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invokestatic <span class="skolem">C1</span> <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Return
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Throw
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
   classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_exec_step"><span class="command">lemma</span></span> ncollect_exec_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span> <span class="main">=</span> exec_step <span class="free">P'</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> No_ics <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> ncollect_exec_instr assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Calling <span class="skolem">C1</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">C1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Calling assms classes_above_sblank<span class="main">[</span><span class="operator">OF</span> above_C1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Calling Some assms
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Prepared <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> above_C1 sfsi Calling Some assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C1<span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta classes_above_class classes_changed_class<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">C1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Error <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> above_C1 sfsi Calling Some assms classes_above_method<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C1</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta classes_above_class classes_changed_class<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">C1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ncollect_exec_instr assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> Called
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C1</span> <span class="skolem">Cs1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C'<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Called <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C'<span class="main">]</span> Cons Called <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Throwing <span class="skolem">Cs</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step</span><span class="antiquote">}</span></span> collection unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_JVMstep_ncollect"><span class="command">lemma</span></span> ncollect_JVMstep_ncollect<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> JVMstep_ncollect <span class="free">P'</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> No_ics <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ncollect_JVMinstr_ncollect classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Calling <span class="skolem">C1</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst<span class="main">(</span>method <span class="free">P</span> <span class="skolem">C1</span> clinit<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Calling assms classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span>
   classes_above_set<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ncollect_JVMinstr_ncollect classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span> Called
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C1</span> <span class="skolem">Cs1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> above_C'<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>fst <span class="main">(</span>method <span class="free">P</span> <span class="skolem">C1</span> clinit<span class="main">)</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms Called <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Cons Called classes_above_set<span class="main">[</span><span class="operator">OF</span> above_C1<span class="main">]</span>
     classes_above_set<span class="main">[</span><span class="operator">OF</span> above_C'<span class="main">]</span> classes_above_method<span class="main">[</span><span class="operator">OF</span> above_C1<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Throwing <span class="skolem">Cs</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms classes_above_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">classes_above_frames</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_classes_above_frames"><span class="command">lemma</span></span> ncollect_classes_above_frames<span class="main">:</span>
 <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="main">(</span>None<span class="main">,</span> <span class="free">h</span><span class="main">,</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="free">frs</span><span class="main">,</span> <span class="free">sh</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>
 <span class="main">⟹</span> classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">=</span> classes_above_frames <span class="free">P'</span> <span class="free">frs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">frs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">frs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> f Cons classes_above_subcls<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span>
   classes_above_subcls2<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">classes_above_xcpts</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_classes_above_xcpts"><span class="command">lemma</span></span> ncollect_classes_above_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="main">(</span>None<span class="main">,</span> <span class="free">h</span><span class="main">,</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="free">frs</span><span class="main">,</span> <span class="free">sh</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">=</span> classes_above_xcpts <span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">x'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>sys_xcpts<span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="bound">xa</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
    <span class="keyword3"><span class="command">assume</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> sys_xcpts"</span></span> <span class="keyword2"><span class="keyword">and</span></span> above<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">x'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>sys_xcpts<span class="main">.</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="bound">xa</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_subcls<span class="main">[</span><span class="operator">OF</span> _ above<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> sys_xcpts <span class="main">⟹</span> <span class="free">P'</span> <span class="main">⊢</span> <span class="bound">x'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>sys_xcpts<span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">xa</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
    <span class="keyword3"><span class="command">assume</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> sys_xcpts"</span></span> <span class="keyword2"><span class="keyword">and</span></span> above<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊢</span> <span class="skolem">x'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>sys_xcpts<span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">xa</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms classes_above_subcls2<span class="main">[</span><span class="operator">OF</span> _ above<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec</span><span class="antiquote">}</span></span> collection unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_JVMexec_ncollect"><span class="command">lemma</span></span> ncollect_JVMexec_ncollect<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="free">σ</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> JVMexec_ncollect <span class="free">P'</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xp</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">frs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False σ frs assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False σ frs assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="skolem">frs'</span> <span class="main">=</span> classes_above_frames <span class="free">P'</span> <span class="skolem">frs'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> ncollect_classes_above_frames frs σ False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">=</span> classes_above_xcpts <span class="free">P'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> ncollect_classes_above_xcpts frs σ False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False xcpts frames frs σ ncollect_JVMstep_ncollect<span class="main">[</span><span class="operator">OF</span> step above_C<span class="main">]</span>
        classes_above_subcls<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span> classes_above_subcls2<span class="main">[</span><span class="operator">OF</span> above_C<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, classes above an exception returned
 by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_instr</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_exec_instr_xcpts"><span class="command">lemma</span></span> ncollect_exec_instr_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMinstr_ncollect <span class="free">P</span> <span class="free">i</span> <span class="free">h</span> <span class="free">stk</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xpcollect<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> prealloc<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> exec_instr <span class="free">i</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics'</span> <span class="free">frs</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">σ'</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> instrs_of <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>cname_of <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms exec_instr_xcpts<span class="main">[</span><span class="operator">OF</span> σ' xp<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Throw <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="comment1">― ‹ if collected classes unchanged, classes above an exception returned
 by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_step</span><span class="antiquote">}</span></span> unchanged ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_exec_step_xcpts"><span class="command">lemma</span></span> ncollect_exec_step_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xpcollect<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> prealloc<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C</span> <span class="free">M</span> <span class="free">pc</span> <span class="free">ics</span> <span class="free">frs</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">σ'</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>cname_of <span class="free">h</span> <span class="free">a</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ics</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> No_ics <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms ncollect_exec_instr_xcpts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Calling <span class="skolem">x21</span> <span class="skolem">x22</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits init_state.splits if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms ncollect_exec_instr_xcpts <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Throwing <span class="skolem">Cs</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, if <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">csmall</span></span><span class="antiquote">}</span></span> returned a result
 under <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">P</span></span><span class="antiquote">}</span></span>, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">P'</span></span><span class="antiquote">}</span></span> returns the same ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_JVMsmall"><span class="command">lemma</span></span> ncollect_JVMsmall<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> prealloc<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="main">(</span>fst<span class="main">(</span>snd <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P'</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prealloc'<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prealloc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xp</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">frs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="skolem"><span class="skolem">frs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMstep_ncollect <span class="free">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False σ frs assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False σ frs assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp1</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="skolem"><span class="skolem">sh1</span></span> <span class="keyword2"><span class="keyword">where</span></span> exec<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P'</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs'</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">frs1</span><span class="main">,</span><span class="skolem">sh1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P'</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs'</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> JVMexec_ncollect <span class="free">P'</span> <span class="free">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms ncollect_JVMexec_ncollect <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> exec_instr<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs'</span> <span class="skolem">sh</span>
      <span class="main">=</span> exec_step <span class="free">P'</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs'</span> <span class="skolem">sh</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ncollect_exec_step<span class="main">[</span><span class="operator">OF</span> step above_C<span class="main">]</span> σ frs False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xp1</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> None σ frs step False assms ncollect_exec_step<span class="main">[</span><span class="operator">OF</span> step above_C<span class="main">]</span> collect exec
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ assms
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xp</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">have</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> None Some frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> frsi<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="skolem">frs</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ frames <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> xpcollect<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> None Some frs σ assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>cname_of <span class="skolem">h</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> ncollect_exec_step_xcpts<span class="main">[</span><span class="operator">OF</span> step xpcollect prealloc'<span class="main">,</span>
             <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">frs1</span><span class="main">,</span><span class="skolem">sh1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> frs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">frs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> loc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">loc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sh</span></span><span class="main">]</span>
           exec exec_instr Some assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some exec σ frs False assms exec_instr collect
             classes_above_find_handler<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sh</span></span><span class="main">,</span> <span class="operator">OF</span> xp frsi<span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ if collected classes unchanged, if <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">cbig</span></span><span class="antiquote">}</span></span> returned a result
 under <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">P</span></span><span class="antiquote">}</span></span>, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">P'</span></span><span class="antiquote">}</span></span> returns the same ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-ncollect_JVMbig"><span class="command">lemma</span></span> ncollect_JVMbig<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> prealloc<span class="main">:</span> <span class="quoted"><span class="quoted">"preallocated <span class="main">(</span>fst<span class="main">(</span>snd <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P'</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_to_cbig_prop2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="bound">P'</span> <span class="bound">cset</span><span class="main">.</span> <span class="bound">cset</span> <span class="main">∩</span> classes_changed <span class="bound">P</span> <span class="bound">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> preallocated <span class="main">(</span>fst<span class="main">(</span>snd <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> coll<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">cset</span></span><span class="main">]</span>
   ncollect_JVMsmall JVMsmall_prealloc_pres assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹ and finally, RTS algorithm based on <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">ncollect</span></span><span class="antiquote">}</span></span> is existence safe ›</span>
<span class="keyword1"><span class="command">theorem</span></span> jvm_naive_existence_safe<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"jvm_deselect <span class="free">P</span> <span class="free">o1</span> <span class="free">P'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">o2</span> <span class="main">∈</span> jvm_naive_out <span class="free">P'</span> <span class="free">t</span><span class="main">.</span> <span class="free">o1</span> <span class="main">=</span> <span class="bound">o2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_prog <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> main"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_prog <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P'</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> main"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wf_md</span></span> <span class="keyword2"><span class="keyword">where</span></span> wf'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_prog <span class="skolem">wf_md</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p t
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def wf_jvm_prog_phi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_class <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> Start"</span></span> <span class="keyword1"><span class="command">using</span></span> p t
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_class_def class_def Start_def Test_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="keyword2"><span class="keyword">where</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">o1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="var">?P</span> <span class="main">(</span>start_state <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">coll1</span> <span class="main">∩</span> classes_changed <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cbig o1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> changed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">coll1</span> <span class="main">∩</span> classes_changed <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_changed_int_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> changed'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">coll1</span> <span class="main">∩</span> classes_changed <span class="var">?P</span> <span class="var">?P'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> classes_changed_int_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="var">?P</span> <span class="main">=</span> classes_above_xcpts <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> class_add_classes_above<span class="main">[</span><span class="operator">OF</span> ns wf_sys_xcpt_nsub_Start<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf' ns<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">∩</span> classes_changed <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> jvm_naive_out_xcpts_collected<span class="main">[</span><span class="operator">OF</span> out<span class="main">]</span> o1 changed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ss_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> classes_above_start_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ncollect_JVMbig<span class="main">[</span><span class="operator">OF</span> cbig changed'<span class="main">]</span>
    preallocated_start_state changed' ss_eq o1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ ...thus <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">JVMNaiveCollection</span></span><span class="antiquote">}</span></span> is an instance of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">CollectionBasedRTS</span><span class="antiquote">}</span></span> ›</span>
<span class="keyword1"><span class="command">interpretation</span></span> JVMNaiveCollectionRTS <span class="main">:</span>
  CollectionBasedRTS <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted">jvm_deselect</span> <span class="quoted">jvm_progs</span> <span class="quoted">jvm_tests</span>
     <span class="quoted">JVMendset</span> <span class="quoted">JVMcombine</span> <span class="quoted">JVMcollect_id</span> <span class="quoted">JVMsmall</span> <span class="quoted">JVMNaiveCollect</span> <span class="quoted">jvm_naive_out</span>
     <span class="quoted">jvm_make_test_prog</span> <span class="quoted">jvm_naive_collect_start</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> jvm_naive_existence_safe<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>

<span class="comment1">(***********************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Smarter RTS algorithm"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Definitions and helper lemmas"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">jvm_smart_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> jvm_class <span class="main">⇒</span> jvm_prog_out set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_smart_out</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
 <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">coll'</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">coll</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">coll</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig
                                       <span class="main">(</span>jvm_make_test_prog <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>start_state <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>
                            <span class="main">∧</span> <span class="bound">coll'</span> <span class="main">=</span> <span class="bound">coll</span> <span class="main">∪</span> classes_above_xcpts <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span>Object<span class="main">,</span>Start<span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">jvm_smart_collect_start</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"jvm_prog <span class="main">⇒</span> cname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jvm_smart_collect_start</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> classes_above_xcpts <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">{</span>Object<span class="main">,</span>Start<span class="main">}</span>"</span></span>


<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_iff_smart"><span class="command">lemma</span></span> jvm_naive_iff_smart<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.cbig_big_equiv
               JVMSmartCollectionSemantics.cbig_big_equiv<span class="main">)</span>

<span class="comment1">(**************************************************)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_out_classes_above_xcpts"><span class="command">lemma</span></span> jvm_smart_out_classes_above_xcpts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> jvm_make_test_prog_classes_above_xcpts<span class="main">[</span><span class="operator">OF</span> P t<span class="main">]</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_collect_start_make_test_prog"><span class="command">lemma</span></span> jvm_smart_collect_start_make_test_prog<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∈</span> jvm_progs<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> jvm_tests <span class="main">⟧</span>
  <span class="main">⟹</span> jvm_smart_collect_start <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> jvm_smart_collect_start <span class="free">P</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> jvm_make_test_prog_classes_above_xcpts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_out_classes_above_start_heap"><span class="command">lemma</span></span> jvm_smart_out_classes_above_start_heap<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"start_heap <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> start_heap_classes<span class="main">[</span><span class="operator">OF</span> h<span class="main">]</span> jvm_smart_out_classes_above_xcpts<span class="main">[</span><span class="operator">OF</span> s P t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_out_classes_above_start_sheap"><span class="command">lemma</span></span> jvm_smart_out_classes_above_start_sheap<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"start_sheap <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">sfs</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms start_prog_classes_above_Start <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_out_classes_above_frames"><span class="command">lemma</span></span> jvm_smart_out_classes_above_frames<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>
   <span class="main">⟹</span> classes_above_frames <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>frames_of <span class="main">(</span>start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> start_prog_classes_above_Start <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>

<span class="comment1">(**************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Additional well-formedness conditions"</span></span>

<span class="comment1">― ‹ returns class to be initialized by given instruction, if applicable ›</span>
<span class="comment1">(* NOTE: similar to exp-taking init_class from J/EConform - but requires field existence checks *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">coll_init_class</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> prog <span class="main">⇒</span> instr <span class="main">⇒</span> cname option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">coll_init_class</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">coll_init_class</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Getstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>
                                       <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">coll_init_class</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Putstatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">has</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>
                                       <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">coll_init_class</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Invokestatic <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> seeing_class <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">coll_init_class</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="comment1">― ‹ checks whether the given value is a pointer; if it's an address,
 checks whether it points to an object in the given heap ›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_ptr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_ptr</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> Null <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_ptr</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Addr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Cfs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Some <span class="bound">Cfs</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_ptr</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-is_ptrD"><span class="command">lemma</span></span> is_ptrD<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> Addr <span class="bound">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Cfs</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">Cfs</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹ shorthand for: given stack has entries required by given instr,
 including pointer where necessary ›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stack_safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr <span class="main">⇒</span> heap <span class="main">⇒</span> val list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> <span class="main">(</span>Getfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_ptr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> <span class="main">(</span>Putfield <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> is_ptr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> <span class="main">(</span>Checkcast <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_ptr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> <span class="main">(</span>Invoke <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> is_ptr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> JVMInstructions.Throw <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_ptr <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">stack_safe</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">stk</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-well_formed_stack_safe"><span class="command">lemma</span></span> well_formed_stack_safe<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stack_safe <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="free">h</span> <span class="free">stk</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    mC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">Ts</span><span class="main">→</span><span class="skolem">T</span><span class="main">=</span><span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span> <span class="keyword1">in</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="skolem">ins</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">from</span></span> sees_wf_mdecl<span class="main">[</span><span class="operator">OF</span> _ mC<span class="main">]</span> wtp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wt_method <span class="free">P</span> <span class="free">C</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="main">(</span><span class="free">Φ</span> <span class="free">C</span> <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def wf_mdecl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> pc <span class="keyword1"><span class="command">have</span></span> wt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">mxs</span><span class="main">,</span>length <span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span> <span class="main">⊢</span> <span class="skolem">ins</span> <span class="main">!</span> <span class="free">pc</span><span class="main">,</span><span class="free">pc</span> <span class="main">::</span> <span class="free">Φ</span> <span class="free">C</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wt_method_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mC correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ST</span></span> <span class="skolem"><span class="skolem">LT</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    Φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ST</span><span class="main">,</span><span class="skolem">LT</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    stk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">stk</span> <span class="main">[:≤]</span> <span class="skolem">ST</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"instrs_of <span class="free">P</span> <span class="free">C</span> <span class="free">M</span> <span class="main">!</span> <span class="free">pc</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getfield <span class="skolem">F</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mC Φ wt stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oT</span></span> <span class="skolem"><span class="skolem">ST'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      oT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">oT</span> <span class="main">≤</span> Class <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ST</span> <span class="main">=</span> <span class="skolem">oT</span> <span class="main">#</span> <span class="skolem">ST'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="skolem"><span class="skolem">stk'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      stk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">=</span> <span class="skolem">ref</span><span class="main">#</span><span class="skolem">stk'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> <span class="skolem">oT</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ref oT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="skolem">ref</span> <span class="main">≠</span> Null <span class="main">∧</span> <span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> Class <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Getfield mC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="skolem">ref</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> non_npD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk' Getfield <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putfield <span class="skolem">F</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mC Φ wt stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vT</span></span> <span class="skolem"><span class="skolem">oT</span></span> <span class="skolem"><span class="skolem">ST'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      oT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">oT</span> <span class="main">≤</span> Class <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ST</span> <span class="main">=</span> <span class="skolem">vT</span> <span class="main">#</span> <span class="skolem">oT</span> <span class="main">#</span> <span class="skolem">ST'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="skolem"><span class="skolem">stk'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      stk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">#</span><span class="skolem">ref</span><span class="main">#</span><span class="skolem">stk'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> <span class="skolem">oT</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ref oT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="skolem">ref</span> <span class="main">≠</span> Null <span class="main">∧</span> <span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> Class <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Putfield mC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="skolem">ref</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> non_npD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk' Putfield <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Checkcast <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mC Φ wt stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oT</span></span> <span class="skolem"><span class="skolem">ST'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      oT<span class="main">:</span> <span class="quoted"><span class="quoted">"is_refT <span class="skolem">oT</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ST</span> <span class="main">=</span> <span class="skolem">oT</span> <span class="main">#</span> <span class="skolem">ST'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="skolem"><span class="skolem">stk'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      stk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">=</span> <span class="skolem">ref</span><span class="main">#</span><span class="skolem">stk'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> <span class="skolem">oT</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ref oT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="skolem">ref</span> <span class="main">≠</span> Null <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D'</span><span class="main">.</span> <span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> Class <span class="bound">D'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_refT_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Checkcast mC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="skolem">ref</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> non_npD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk' Checkcast <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">M1</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mC Φ wt stk <span class="keyword1"><span class="command">have</span></span>
      ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> size <span class="skolem">ST</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      oT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ST</span><span class="main">!</span><span class="skolem">n</span> <span class="main">=</span> NT <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="skolem">ST</span><span class="main">!</span><span class="skolem">n</span> <span class="main">=</span> Class <span class="bound">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> stk <span class="keyword1"><span class="command">have</span></span> stk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> size <span class="free">stk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk ST oT list_all2_nthD2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">stk</span><span class="main">!</span><span class="skolem">n</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="free">stk</span><span class="main">!</span><span class="skolem">n</span> <span class="main">≠</span> Null <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="free">stk</span><span class="main">!</span><span class="skolem">n</span> <span class="main">:≤</span> Class <span class="bound">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> Invoke mC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="main">(</span><span class="free">stk</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> non_npD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk' Invoke <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Throw
    <span class="keyword1"><span class="command">with</span></span> mC Φ wt stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">oT</span></span> <span class="skolem"><span class="skolem">ST'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      oT<span class="main">:</span> <span class="quoted"><span class="quoted">"is_refT <span class="skolem">oT</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ST</span> <span class="main">=</span> <span class="skolem">oT</span> <span class="main">#</span> <span class="skolem">ST'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> stk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ref</span></span> <span class="skolem"><span class="skolem">stk'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      stk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">=</span> <span class="skolem">ref</span><span class="main">#</span><span class="skolem">stk'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ref<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> <span class="skolem">oT</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ref oT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ref</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span><span class="skolem">ref</span> <span class="main">≠</span> Null <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D'</span><span class="main">.</span> <span class="free">P</span><span class="main">,</span><span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ref</span> <span class="main">:≤</span> Class <span class="bound">D'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_refT_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Throw mC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ptr <span class="free">h</span> <span class="skolem">ref</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> non_npD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> stk' Throw <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(******************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Proving naive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⊆"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> smart ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove that, given well-formedness of the program and state, and "promises"
 about what has or will be collected in previous or future steps, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">jvm_smart</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 collects everything <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">jvm_naive</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does. We prove that promises about previously-
 collected classes ("backward promises") are maintained by execution, and promises
 about to-be-collected classes ("forward promises") are met by the end of execution.
 We then show that the required initial conditions (well-formedness and backward
 promises) are met by the defined start states, and thus that a run test will
 collect at least those classes collected by the naive algorithm. ›</span></span>

<span class="comment1">― ‹ Backward promises (classes that should already be collected) ›</span>
  <span class="comment1">― ‹ - Classes of objects in the heap are collected ›</span>
  <span class="comment1">― ‹ - Non-<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">None</span><span class="antiquote">}</span></span> classes on the static heap are collected ›</span>
  <span class="comment1">― ‹ - Current classes from the frame stack are collected ›</span>
  <span class="comment1">― ‹ - Classes of system exceptions are collected ›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"If backward promises have been kept, a single step preserves this property;
 i.e., any classes that have been added to this set (new heap objects, newly prepared
 sheap classes, new frames) are collected by the smart collection algorithm in that
 step or by forward promises:"</span></span>
<span class="keyword1" id="JVMCollectionBasedRTS-backward_coll_promises_kept"><span class="command">lemma</span></span> backward_coll_promises_kept<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="comment1">― ‹ well-formedness ›</span>
      wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
<span class="comment1">― ‹ defs ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">frs</span> <span class="main">=</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹ backward promises - will be collected prior ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ forward promises - will be collected after if not already ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> init_class_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics
       <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Calling_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ collection and step ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMexec_scollect <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xp'</span><span class="main">,</span><span class="free">h'</span><span class="main">,</span><span class="free">frs'</span><span class="main">,</span><span class="free">sh'</span><span class="main">)</span> <span class="main">∈</span> JVMsmall <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h'</span> <span class="free">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free">sh'</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">sfs'</span><span class="main">,</span><span class="free">i'</span><span class="main">)</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span>classes_above_frames <span class="free">P</span> <span class="free">frs'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">frs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f1</span> <span class="skolem">frs1</span><span class="main">)</span>
<span class="comment1">(****)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs1</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> correct f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> well_formed_stack_safe<span class="main">[</span><span class="operator">OF</span> wtp cr'<span class="main">]</span> correct_state_Throwing_ex<span class="main">[</span><span class="operator">OF</span> cr'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span>
    stack_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"stack_safe <span class="var">?i</span> <span class="free">h</span> <span class="free">stk</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Throwing_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span> <span class="bound">a</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Throwing <span class="bound">Cs</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">obj</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">obj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> confc<span class="main">:</span> <span class="quoted"><span class="quoted">"conf_clinit <span class="free">P</span> <span class="free">sh</span> <span class="free">frs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> correct Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> Called_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="bound">C'</span><span class="main">#</span><span class="bound">Cs'</span><span class="main">)</span>
           <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∧</span> classes_above <span class="free">P</span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free">P</span> <span class="bound">C'</span> clinit<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C'</span> <span class="skolem">Cs'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="skolem">C'</span><span class="main">#</span><span class="skolem">Cs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∈</span> set<span class="main">(</span>clinit_classes <span class="free">frs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f' Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="keyword2"><span class="keyword">where</span></span> shC'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span> Processing<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> confc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf_clinit_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C'eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> fst<span class="main">(</span>method <span class="free">P</span> <span class="skolem">C'</span> clinit<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_sees_clinit wtp
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_class_def wf_jvm_prog_phi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∧</span> classes_above <span class="free">P</span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free">P</span> <span class="skolem">C'</span> clinit<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sheap shC' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> Called_prom2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="bound">Cs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C1</span> <span class="bound">sobj</span><span class="main">.</span> Called_context <span class="free">P</span> <span class="bound">C1</span> <span class="var">?i</span> <span class="main">∧</span> <span class="free">sh</span> <span class="bound">C1</span> <span class="main">=</span> Some <span class="bound">sobj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cr' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf_f_def2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Throwing_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs</span> <span class="bound">a</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Throwing <span class="main">(</span><span class="bound">C'</span><span class="main">#</span><span class="bound">Cs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Processing<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C'</span> <span class="skolem">Cs</span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Throwing <span class="main">(</span><span class="skolem">C'</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∈</span> set<span class="main">(</span>clinit_classes <span class="free">frs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f' Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span><span class="main">.</span> <span class="free">sh</span> <span class="skolem">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Processing<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> confc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf_clinit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(****)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xp</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> exec<span class="main">:</span> <span class="quoted"><span class="quoted">"exec <span class="main">(</span><span class="free">P</span><span class="main">,</span> None<span class="main">,</span> <span class="free">h</span><span class="main">,</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs1</span><span class="main">,</span> <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">xp'</span><span class="main">,</span><span class="free">h'</span><span class="main">,</span><span class="free">frs'</span><span class="main">,</span><span class="free">sh'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> small f' Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step_input <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="free">pc</span> <span class="free">ics</span> <span class="main">=</span> <span class="skolem">si</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">frs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">sh<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
     exec_step<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C'</span> <span class="free">M'</span> <span class="free">pc</span> <span class="free">ics</span> <span class="skolem">frs1</span> <span class="free">sh</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">frs<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">sh<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"exec_step <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C'</span> <span class="free">M'</span> <span class="free">pc</span> <span class="free">ics</span> <span class="skolem">frs1</span> <span class="free">sh</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"exec_step_ind <span class="skolem">si</span> <span class="free">P</span> <span class="free">h</span> <span class="free">stk</span> <span class="free">loc</span> <span class="free">C'</span> <span class="free">M'</span> <span class="free">pc</span> <span class="free">ics</span> <span class="skolem">frs1</span> <span class="free">sh</span>
                       <span class="main">(</span><span class="skolem">xp<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">frs<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">sh<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_equiv si <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> heap sheap frames exec exec_step f' Cons
      si init_class_prom stack_safe Calling_prom Called_prom Called_prom2 Throwing_prom
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_step_ind.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Load <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Load.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Store <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Store.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Push <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Push.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_NewOOM_Called <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_NewOOM_Called.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_NewOOM_Done <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_NewOOM_Done.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_New_Called <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_New_Called.hyps exec_step_ind_New_Called.prems<span class="main">(</span>1-9<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> blank_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_New_Done <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_New_Done.hyps exec_step_ind_New_Done.prems<span class="main">(</span>1-9<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> blank_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_New_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_New_Init.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getfield_Null <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getfield_Null.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getfield_NoField <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getfield_NoField.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getfield_Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getfield_Static.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getfield <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getfield.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_NoField <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NoField.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_NonStatic <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_NonStatic.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_Called <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_Called.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_Done <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_Done.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Getstatic_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Getstatic_Init.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putfield_Null <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield_Null.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putfield_NoField <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield_NoField.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putfield_Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield_Static.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putfield <span class="skolem">v</span> <span class="skolem">stk</span> <span class="skolem">r</span> <span class="skolem">a</span> <span class="skolem">D</span> <span class="skolem">fs</span> <span class="skolem">h</span> <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">C1</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> addr<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span> <span class="main">=</span> Null <span class="main">∨</span> <span class="main">(</span>hd <span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span> <span class="main">=</span> Addr <span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">h</span> <span class="skolem">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">C1</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield.prems<span class="main">(</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID is_ptrD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> hd<span class="main">(</span>tl <span class="skolem">stk</span><span class="main">)</span> <span class="main">=</span> Addr <span class="bound">a</span> <span class="main">⟹</span> classes_above <span class="skolem">P</span> <span class="skolem">C1</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield.prems<span class="main">(</span>1<span class="main">)</span> addr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putfield.hyps exec_step_ind_Putfield.prems<span class="main">(</span>1-7<span class="main">)</span> addr
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putstatic_NoField <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NoField.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putstatic_NonStatic <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_NonStatic.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Putstatic_Called <span class="skolem">D'</span> <span class="skolem">b</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">D</span> <span class="skolem">F</span> <span class="skolem">C</span> <span class="skolem">sh</span> <span class="skolem">sfs</span> <span class="skolem">i</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">Cs</span> <span class="skolem">frs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="keyword1">sees</span> <span class="skolem">F</span><span class="main">,</span>Static<span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_field_sees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_field_idemp<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D'eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_Called.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sobj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="skolem">D</span> <span class="main">=</span> Some <span class="skolem">sobj</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_Called.hyps<span class="main">(</span>2<span class="main">)</span> exec_step_ind_Putstatic_Called.prems<span class="main">(</span>8<span class="main">,</span>13<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_Called.hyps
                         exec_step_ind_Putstatic_Called.prems<span class="main">(</span>1-7<span class="main">)</span> D'eq
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putstatic_Done <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_Done.hyps exec_step_ind_Putstatic_Done.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Putstatic_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Putstatic_Init.hyps exec_step_ind_Putstatic_Init.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Checkcast <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Checkcast.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Checkcast_Error <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Checkcast_Error.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invoke_Null <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke_Null.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invoke_NoMethod <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke_NoMethod.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invoke_Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke_Static.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invoke <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">r</span> <span class="skolem">C</span> <span class="skolem">h</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="skolem">P</span> <span class="skolem">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke.hyps<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> exec_step_ind_Invoke.prems<span class="main">(</span>1<span class="main">,</span>8<span class="main">,</span>10<span class="main">,</span>13<span class="main">)</span>
        rtrancl_trans<span class="main">[</span><span class="operator">OF</span> sees_method_decl_above<span class="main"><span class="main">[</span></span><span class="operator">OF</span> exec_step_ind_Invoke.hyps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID is_ptrD<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invoke.hyps<span class="main">(</span>7<span class="main">)</span> exec_step_ind_Invoke.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invokestatic_NoMethod
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NoMethod.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invokestatic_NonStatic
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_NonStatic.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_Called <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seeing_class <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="main">=</span> Some <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Called.hyps<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="skolem">P</span> <span class="skolem">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Called.prems<span class="main">(</span>8-9<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Called.hyps exec_step_ind_Invokestatic_Called.prems<span class="main">(</span>1-7<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Invokestatic_Done <span class="skolem">ps</span> <span class="skolem">n</span> <span class="skolem">stk</span> <span class="skolem">D</span> <span class="skolem">b</span> <span class="skolem">Ts</span> <span class="skolem">T</span> <span class="skolem">mxs</span> <span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ins</span> <span class="skolem">xt</span> <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seeing_class <span class="skolem">P</span> <span class="skolem">C</span> <span class="skolem">M</span> <span class="main">=</span> Some <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Done.hyps<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="skolem">P</span> <span class="skolem">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Done.prems<span class="main">(</span>8-9<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepID<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Done.hyps exec_step_ind_Invokestatic_Done.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Invokestatic_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Invokestatic_Init.hyps exec_step_ind_Invokestatic_Init.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Return_Last_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_Last_Init.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Return_Last <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_Last.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Return_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_Init.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Return_NonStatic <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_NonStatic.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Return_Static <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Return_Static.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Pop <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Pop.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_IAdd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_IAdd.prems<span class="main">(</span>1-7<span class="main">)</span><span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_IfFalse_False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_IfFalse_False.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_IfFalse_nFalse <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_IfFalse_nFalse.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_CmpEq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_CmpEq.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Goto <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Goto.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Throw <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Throw.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Throw_Null <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Throw_Null.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_Init_None_Called <span class="skolem">sh</span> <span class="skolem">C</span> <span class="skolem">Cs</span> <span class="skolem">P</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="skolem">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_None_Called.prems<span class="main">(</span>8<span class="main">,</span>11<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepCD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_None_Called.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init_Done <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Done.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init_Processing <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Processing.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init_Error <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Error.prems<span class="main">(</span>1-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init_Prepared_Object <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Prepared_Object.hyps
             exec_step_ind_Init_Prepared_Object.prems<span class="main">(</span>1-7<span class="main">,</span>10<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepCD<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init_Prepared_nObject <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init_Prepared_nObject.hyps exec_step_ind_Init_Prepared_nObject.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_Init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> exec_step_ind_Init.prems<span class="main">(</span>1-7<span class="main">,</span>8<span class="main">,</span>12<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepC2D<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>exec_step_ind_InitThrow <span class="skolem">C</span> <span class="skolem">Cs</span> <span class="skolem">a</span> <span class="skolem">P</span> <span class="skolem">h</span> <span class="skolem">stk</span> <span class="skolem">loc</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">M<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">pc</span> <span class="skolem">ics</span> <span class="skolem">frs</span> <span class="skolem">sh</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="skolem">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span>Processing<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exec_step_ind_InitThrow.prems<span class="main">(</span>8<span class="main">,</span>14<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_step_input_StepTD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_InitThrow.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> exec_step_ind_InitThrow_End <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> exec_step_ind_InitThrow_End.prems<span class="main">(</span>1-7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> find_handler.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> find_handler_pieces<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ Forward promises (classes that will be collected by the end of execution) ›</span>
  <span class="comment1">― ‹ - Classes that the current instruction will check initialization for will be collected ›</span>
  <span class="comment1">― ‹ - Class whose initialization is actively being called by the current frame will be collected ›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ We prove that an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ics</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Calling C Cs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (meaning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">C</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s
 initialization procedure is actively being called) means that classes above <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">C</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 will be collected by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cbig</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (i.e., by the end of execution) using proof by
 induction, proving the base and IH separately. ›</span></span>

<span class="comment1">― ‹ base case: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Object</span><span class="antiquote">}</span></span> ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-Calling_collects_base"><span class="command">lemma</span></span> Calling_collects_base<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> big<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling Object <span class="free">Cs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> Object <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="free">cset'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f1</span> <span class="skolem">frs1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_stepD<span class="main">[</span><span class="operator">OF</span> big nend<span class="main">]</span> nend ics Cons
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ IH case where <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">C</span><span class="antiquote">}</span></span> has not been prepared yet ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-Calling_None_next_state"><span class="command">lemma</span></span> Calling_None_next_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> none<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> None"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∉</span> JVMendset <span class="main">∧</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span><span class="main">.</span> sheap <span class="free">σ'</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span>Prepared<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="free">C</span> <span class="main">≠</span> <span class="bound">C'</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ'</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> fst <span class="free">σ</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span> <span class="main">=</span> <span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 frs False assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> clinit"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ IH case where <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">C</span><span class="antiquote">}</span></span> has been prepared (and has a direct superclass
 - i.e., is not <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Object</span><span class="antiquote">}</span></span>) ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-Calling_Prepared_next_state"><span class="command">lemma</span></span> Calling_Prepared_next_state<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> prep<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">sfs</span><span class="main">,</span>Prepared<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="free">C</span> <span class="main">≠</span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∉</span> JVMendset <span class="main">∧</span> ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="free">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ'</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
         <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span>Object"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> nobj<span class="main">:</span>False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> fst <span class="free">σ</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span> <span class="main">=</span> <span class="skolem">f1</span><span class="main">#</span><span class="skolem">frs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub obj subcls_self_superclass <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span>  <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">≠</span> <span class="bound">C'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sub subcls_of_Obj_acyclic<span class="main">[</span><span class="operator">OF</span> obj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="free">C</span> <span class="main">≠</span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ'</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> f1 frs False nobj assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> clinit"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ'</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
         <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub dimp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f1 frs False nobj assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"method <span class="free">P</span> <span class="free">C</span> clinit"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>subcls1D <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ completed IH case: non-<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Object</span><span class="antiquote">}</span></span> (pulls together above IH cases) ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-Calling_collects_IH"><span class="command">lemma</span></span> Calling_collects_IH<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
           <span class="main">⟹</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="bound">Cs</span>
           <span class="main">⟹</span> <span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>
           <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="bound">cset'</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> big<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="free">cset'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="free">σ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nend <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f1</span> <span class="skolem">frs1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sub
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C'</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">coll1</span></span> <span class="skolem"><span class="skolem">coll</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">coll1</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">=</span> <span class="skolem">coll1</span> <span class="main">∪</span> <span class="skolem">coll</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">coll</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_stepD<span class="main">[</span><span class="operator">OF</span> big nend<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span>Prepared<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfs<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span>Prepared<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">have</span></span> set'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="free">C</span><span class="main">≠</span><span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset <span class="main">∧</span> ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Calling_Prepared_next_state<span class="main">[</span><span class="operator">OF</span> sub obj curr sfs set' σ1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">coll</span></span> <span class="quoted"><span class="skolem">σ1</span></span><span class="main">]</span> classes_above_def2<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> σ1 f1 Cons nend curr
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> none<span class="main">:</span> False <span class="comment1">― ‹ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Calling C Cs"</span><span class="antiquote">}</span></span> is the next <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">ics</span><span class="antiquote">}</span></span>, but after that is <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Calling D (C#Cs)"</span><span class="antiquote">}</span></span> ›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sNone<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="free">C</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> curr1<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> prep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="free">C</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> Prepared<span class="main">)</span><span class="main">⌋</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> set1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="free">C</span> <span class="main">≠</span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Calling_None_next_state<span class="main">[</span><span class="operator">OF</span> curr sNone set σ1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="skolem"><span class="skolem">frs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> frs2<span class="main">:</span> <span class="quoted"><span class="quoted">"frames_of <span class="skolem">σ1</span> <span class="main">=</span> <span class="skolem">f2</span><span class="main">#</span><span class="skolem">frs2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">σ1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"frames_of <span class="skolem">σ1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMendset_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> sfs1<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="skolem">σ1</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">sfs1</span><span class="main">,</span>Prepared<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prep <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk2</span></span> <span class="skolem"><span class="skolem">loc2</span></span> <span class="skolem"><span class="skolem">C2</span></span> <span class="skolem"><span class="skolem">M2</span></span> <span class="skolem"><span class="skolem">pc2</span></span> <span class="skolem"><span class="skolem">ics2</span></span> <span class="keyword2"><span class="keyword">where</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk2</span><span class="main">,</span><span class="skolem">loc2</span><span class="main">,</span><span class="skolem">C2</span><span class="main">,</span><span class="skolem">M2</span><span class="main">,</span><span class="skolem">pc2</span><span class="main">,</span><span class="skolem">ics2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f2</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ2</span></span> <span class="skolem"><span class="skolem">coll2</span></span> <span class="skolem"><span class="skolem">coll'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ2</span><span class="main">,</span> <span class="skolem">coll2</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">coll</span> <span class="main">=</span> <span class="skolem">coll2</span> <span class="main">∪</span> <span class="skolem">coll'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">coll'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_stepD<span class="main">[</span><span class="operator">OF</span> σ1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nend1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2</span> <span class="main">∉</span> JVMendset <span class="main">∧</span> ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ2</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Calling_Prepared_next_state<span class="main">[</span><span class="operator">OF</span> sub obj curr1 sfs1 set1 σ2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">coll'</span></span> <span class="quoted"><span class="skolem">σ2</span></span><span class="main">]</span> classes_above_def2<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> σ2 σ1 f2 frs2 f1 Cons
        nend1 nend curr1 curr
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def JVMendset_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹pulls together above base and IH cases ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-Calling_collects"><span class="command">lemma</span></span> Calling_collects<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="free">Cs</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span>
       <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
       <span class="main">⟶</span> ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling Object <span class="bound">Cs</span>
       <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> Object <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
             <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
       <span class="main">⟶</span> classes_above <span class="free">P</span> Object <span class="main">⊆</span> JVMcombine <span class="free">cset</span> <span class="bound">cset'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Calling_collects_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">y</span> <span class="main">≺<span class="hidden">⇧</span><sup>1</sup></span> <span class="bound">z</span> <span class="main">⟹</span>
        <span class="free">P</span> <span class="main">⊢</span> <span class="bound">z</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object <span class="main">⟹</span>
        <span class="main">∀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
           <span class="main">⟶</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="bound">z</span> <span class="bound">Cs</span>
           <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">z</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">z</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="bound">cset'</span> <span class="main">⟹</span>
        <span class="main">∀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
           <span class="main">⟶</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="bound">y</span> <span class="bound">Cs</span>
           <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">y</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="bound">cset'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Calling_collects_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span>
       <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
       <span class="main">⟶</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="bound">Cs</span>
       <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
       <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="bound">cset'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> converse_rtrancl_induct<span class="main">[</span><span class="operator">OF</span> sub<span class="main">,</span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span> <span class="bound">cset'</span> <span class="bound">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="bound">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="bound">σ</span> <span class="main">∉</span> JVMendset
                    <span class="main">⟶</span> ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="bound">C</span> <span class="bound">Cs</span>
                    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="bound">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">)</span>
                    <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∪</span> <span class="bound">cset'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> base IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*******************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Instructions that call the initialization procedure will collect classes above
  the class initialized by the end of execution (using the above <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Calling_collects</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)."</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-New_collects"><span class="command">lemma</span></span> New_collects<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> New <span class="free">C</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend cbig JVMSmartCollectionSemantics.cbig_def2
   JVMSmartCollectionSemantics.csmall_nstep_base  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset0</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD nstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ics1<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">C</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sheap'<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="skolem">σ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span>
     <span class="keyword1"><span class="command">using</span></span> JVM_New_next_step<span class="main">[</span><span class="operator">OF</span> _ nend curr<span class="main">]</span> σ1<span class="main">(</span>1<span class="main">)</span> False ics
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> cbig JVMSmartCollectionSemantics.cbig_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 σ1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> sheap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
     <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap' sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset0</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Calling_collects<span class="main">[</span><span class="operator">OF</span> sub cbig1 nend1 ics1 sheap1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-Getstatic_collects"><span class="command">lemma</span></span> Getstatic_collects<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Getstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span>Static<span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>
           <span class="main">∨</span> <span class="main">(</span>ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend cbig JVMSmartCollectionSemantics.cbig_def2
   JVMSmartCollectionSemantics.csmall_nstep_base  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset0</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD nstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> curr1<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sheap'<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="skolem">σ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span>
     <span class="keyword1"><span class="command">using</span></span> JVM_Getstatic_next_step<span class="main">[</span><span class="operator">OF</span> _ nend curr fC<span class="main">]</span> σ1<span class="main">(</span>1<span class="main">)</span> False ics
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> cbig JVMSmartCollectionSemantics.cbig_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 σ1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> sheap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
     <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap' sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset0</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Calling_collects<span class="main">[</span><span class="operator">OF</span> sub cbig1 nend1 curr1 sheap1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-Putstatic_collects"><span class="command">lemma</span></span> Putstatic_collects<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Putstatic <span class="free">C</span> <span class="free">F</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">has</span> <span class="free">F</span><span class="main">,</span>Static<span class="main">:</span><span class="free">t</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>
           <span class="main">∨</span> <span class="main">(</span>ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend cbig JVMSmartCollectionSemantics.cbig_def2
   JVMSmartCollectionSemantics.csmall_nstep_base  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset0</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD nstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> curr1<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sheap'<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="skolem">σ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span>
     <span class="keyword1"><span class="command">using</span></span> JVM_Putstatic_next_step<span class="main">[</span><span class="operator">OF</span> _ nend curr fC<span class="main">]</span> σ1<span class="main">(</span>1<span class="main">)</span> False ics
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> cbig JVMSmartCollectionSemantics.cbig_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 σ1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> sheap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
     <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap' sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset0</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Calling_collects<span class="main">[</span><span class="operator">OF</span> sub cbig1 nend1 curr1 sheap1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-Invokestatic_collects"><span class="command">lemma</span></span> Invokestatic_collects<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∉</span> JVMendset"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Invokestatic <span class="free">C</span> <span class="free">M</span> <span class="free">n</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> No_ics"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> mC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="free">C</span> <span class="keyword1">sees</span> <span class="free">M</span><span class="main">,</span>Static<span class="main">:</span><span class="free">Ts</span> <span class="main">→</span> <span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">in</span> <span class="free">D</span>"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
           <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done<span class="main">)</span>
           <span class="main">∨</span> <span class="main">(</span>ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="free">σ</span> <span class="free">D</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> Done"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ics_of<span class="main">(</span>hd<span class="main">(</span>frames_of <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nend cbig JVMSmartCollectionSemantics.cbig_def2
   JVMSmartCollectionSemantics.csmall_nstep_base  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset0</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">cset'</span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD nstep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> curr1<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Calling <span class="free">D</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sheap'<span class="main">:</span> <span class="quoted"><span class="quoted">"sheap <span class="free">σ</span> <span class="main">=</span> sheap <span class="skolem">σ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span>
     <span class="keyword1"><span class="command">using</span></span> JVM_Invokestatic_next_step<span class="main">[</span><span class="operator">OF</span> _ nend curr mC<span class="main">]</span> σ1<span class="main">(</span>1<span class="main">)</span> False ics
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMSmartCollectionSemantics.csmall_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> cbig JVMSmartCollectionSemantics.cbig_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cbig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset0</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 σ1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> sheap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
     <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap' sheap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset0</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Calling_collects<span class="main">[</span><span class="operator">OF</span> sub cbig1 nend1 curr1 sheap1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> smart <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*********)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">smart_out</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> execution function keeps the promise to
 collect above the initial class (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Test</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>):"</span></span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_out_classes_above_Test"><span class="command">lemma</span></span> jvm_smart_out_classes_above_Test<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> Test <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="var">?P</span> <span class="var">?D</span> <span class="main">⊆</span> <span class="var">?cset</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted">main</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ics</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="var">?σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> called<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">⟹</span> classes_above <span class="var">?P</span> <span class="var">?D</span> <span class="main">⊆</span> <span class="var">?cset</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ics</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> called <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wf_md</span></span> <span class="keyword2"><span class="keyword">where</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_prog <span class="skolem">wf_md</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def wf_jvm_prog_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> jvm_make_test_prog_sees_Test_main<span class="main">[</span><span class="operator">OF</span> P t<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     mC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="keyword1">sees</span> <span class="var">?M</span><span class="main">,</span>Static<span class="main">:</span><span class="main">[]</span> <span class="main">→</span> Void <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">in</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="comment1">(****)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sees_method_sub_Obj<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cset'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      cbig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="var">?P</span> <span class="var">?σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset'</span> <span class="main">⊆</span> <span class="var">?cset</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">∉</span> JVMendset"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> start_state_nend<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> start_prog_start_m_instrs<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> t
    <span class="keyword1"><span class="command">have</span></span> curr<span class="main">:</span> <span class="quoted"><span class="quoted">"curr_instr <span class="var">?P</span> <span class="main">(</span>hd<span class="main">(</span>frames_of <span class="var">?σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Invokestatic <span class="var">?D</span> <span class="var">?M</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ics</span> <span class="main">=</span> No_ics"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> mC
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_start_sheap<span class="main">[</span><span class="operator">OF</span> s<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">⊢</span> <span class="var">?D</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="var">?σ</span> <span class="bound">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>
              <span class="main">⟶</span> classes_above <span class="var">?P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="var">?cset</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Invokestatic_collects<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(**********************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Using lemmas proving preservation of backward promises and keeping
 of forward promises, we prove that the smart algorithm collects at least
 the classes as the naive algorithm does."</span></span>

<span class="comment1">― ‹ first over a single execution step (assumes promises) ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_to_smart_exec_collect"><span class="command">lemma</span></span> jvm_naive_to_smart_exec_collect<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="comment1">― ‹ well-formedness ›</span>
      wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
<span class="comment1">― ‹ defs ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">frs</span> <span class="main">=</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹ backward promises - will be collected prior ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ forward promises - will be collected after if not already ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> init_class_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics
       <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Calling_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ collection ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"JVMexec_scollect <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">frs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f'</span> <span class="skolem">frs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="free">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> frames f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs'</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> correct f' Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed_stack_safe<span class="main">[</span><span class="operator">OF</span> wtp cr'<span class="main">]</span> correct_state_Throwing_ex<span class="main">[</span><span class="operator">OF</span> cr'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span>
    stack_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"stack_safe <span class="var">?i</span> <span class="free">h</span> <span class="free">stk</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Throwing_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span> <span class="bound">a</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Throwing <span class="bound">Cs</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">obj</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">obj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> confc<span class="main">:</span> <span class="quoted"><span class="quoted">"conf_clinit <span class="free">P</span> <span class="free">sh</span> <span class="free">frs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> correct Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> Called_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="bound">C'</span><span class="main">#</span><span class="bound">Cs'</span><span class="main">)</span>
           <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∧</span> classes_above <span class="free">P</span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free">P</span> <span class="bound">C'</span> clinit<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C'</span> <span class="skolem">Cs'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="skolem">C'</span><span class="main">#</span><span class="skolem">Cs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">∈</span> set<span class="main">(</span>clinit_classes <span class="free">frs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f' Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sfs</span></span> <span class="keyword2"><span class="keyword">where</span></span> shC'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="skolem">C'</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">sfs</span><span class="main">,</span> Processing<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> confc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf_clinit_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C'eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> fst<span class="main">(</span>method <span class="free">P</span> <span class="skolem">C'</span> clinit<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_sees_clinit wtp
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_class_def wf_jvm_prog_phi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">cset</span> <span class="main">∧</span> classes_above <span class="free">P</span> <span class="main">(</span>fst<span class="main">(</span>method <span class="free">P</span> <span class="skolem">C'</span> clinit<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sheap shC' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xp</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"JVMexec_ncollect <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>
         <span class="main">=</span> JVMinstr_ncollect <span class="free">P</span> <span class="var">?i</span> <span class="free">h</span> <span class="free">stk</span> <span class="main">∪</span> classes_above <span class="free">P</span> <span class="free">C'</span>
             <span class="main">∪</span> classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">∪</span> classes_above_xcpts <span class="free">P</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"JVMexec_scollect <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="main">=</span> JVMinstr_scollect <span class="free">P</span> <span class="var">?i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f' None Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>New <span class="skolem">C</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics New assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> New xcpts frames smart f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getfield <span class="skolem">F</span> <span class="skolem">C</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stack_safe heap f' False Cons Getfield <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_ptrD<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getstatic <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">D</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">has</span> <span class="skolem">F</span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_D<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics init_class_prom Getstatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_decl_above True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_between <span class="free">P</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">D</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True Getstatic above_D smart f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> classes_above_sub_classes_between_eq<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> above_D above_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getstatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getstatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putfield <span class="skolem">F</span> <span class="skolem">C</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd<span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="main">(</span>tl <span class="free">stk</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stack_safe heap f' False Cons Putfield <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_ptrD<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putfield assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putstatic <span class="skolem">C</span> <span class="skolem">F</span> <span class="skolem">D</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">has</span> <span class="skolem">F</span><span class="main">,</span>Static<span class="main">:</span><span class="bound">t</span> <span class="keyword1">in</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_D<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics init_class_prom Putstatic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_decl_above True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_between <span class="free">P</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">D</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True Putstatic above_D smart f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> classes_above_sub_classes_between_eq<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> above_D above_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putstatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putstatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Checkcast <span class="skolem">C</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Checkcast assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stack_safe heap False Cons f' Checkcast <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_ptrD<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> above_stk Checkcast assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invoke assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span><span class="free">stk</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stack_safe heap False Cons f' Invoke
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_ptrD<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invoke assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invokestatic <span class="skolem">C</span> <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>method <span class="free">P</span> <span class="skolem">C</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">m</span> <span class="bound">D</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="keyword1">sees</span> <span class="skolem">M</span><span class="main">,</span>Static<span class="main">:</span><span class="bound">Ts</span> <span class="main">→</span> <span class="bound">T</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">in</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_D<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?D</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ics init_class_prom Invokestatic
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> seeing_class_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> method_def2 sees_method_decl_above True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="var">?D</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> Invokestatic above_D xcpts frames smart f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_C<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_between <span class="free">P</span> <span class="skolem">C</span> <span class="var">?D</span> <span class="main">-</span> <span class="main">{</span><span class="var">?D</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True Invokestatic above_D smart f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> classes_above_sub_classes_between_eq<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> above_D above_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invokestatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invokestatic assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Throw <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">stk</span> <span class="main">=</span> Null"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Throw assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cname_of <span class="free">h</span> <span class="main">(</span>the_Addr <span class="main">(</span>hd <span class="free">stk</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="var">?C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stack_safe heap False Cons f' Throw <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_ptrD<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> above_stk Throw assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Load <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Store <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Push <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Goto <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> IfFalse <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C1</span> <span class="skolem">Cs1</span> <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Called <span class="main">(</span><span class="skolem">C1</span><span class="main">#</span><span class="skolem">Cs1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None Cons Called_prom<span class="main">[</span><span class="operator">OF</span> ics<span class="main">]</span> xcpts frames f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs1</span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Throwing <span class="skolem">Cs1</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Throwing_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> above_stk<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="main">(</span>cname_of <span class="free">h</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> heap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ics None Cons xcpts frames f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C1</span> <span class="skolem">Cs1</span> <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ics</span> <span class="main">=</span> Calling <span class="skolem">C1</span> <span class="skolem">Cs1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None Cons Calling_prom<span class="main">[</span><span class="operator">OF</span> ics<span class="main">]</span> xcpts frames f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ics_classes.cases list.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹ ... which is the same as <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">csmall</span></span><span class="antiquote">}</span></span> ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_to_smart_csmall"><span class="command">lemma</span></span> jvm_naive_to_smart_csmall<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="comment1">― ‹ well-formedness ›</span>
      wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
<span class="comment1">― ‹ defs ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">frs</span> <span class="main">=</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹ backward promises - will be collected prior ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ forward promises - will be collected after if not already ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> init_class_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics
    <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Calling_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ collections ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> smart_coll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> naive_coll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_exec_collect<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sh</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-9<span class="main"><span class="main">)</span></span><span class="main">]</span>
      smart smart_coll naive_coll
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def
                      JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>

<span class="comment1">― ‹ ...which means over <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">csmall_nstep</span></span><span class="antiquote">}</span></span>, stepping from the end state
 (the point by which future promises will have been fulfilled) (uses backward
 and forward promise lemmas) ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_to_smart_csmall_nstep"><span class="command">lemma</span></span> jvm_naive_to_smart_csmall_nstep<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span><span class="main">;</span>
   <span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span><span class="main">;</span>
   hd <span class="free">frs</span> <span class="main">=</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics
      <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   <span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
  <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="free">n</span><span class="main">;</span>
  <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span> <span class="free">n</span><span class="main">;</span>
   <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset</span><span class="main">;</span>
   <span class="free">σ'</span> <span class="main">∈</span> JVMendset <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xp</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">frs</span></span> <span class="quoted"><span class="free">sh</span></span> <span class="quoted"><span class="free">stk</span></span> <span class="quoted"><span class="free">loc</span></span> <span class="quoted"><span class="free">C'</span></span> <span class="quoted"><span class="free">M'</span></span> <span class="quoted"><span class="free">pc</span></span> <span class="quoted"><span class="free">ics</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="free">cset</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_base subsetI old.prod.inject singletonD
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> equals0D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="skolem"><span class="skolem">cset'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="var">?σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">cset1'</span></span> <span class="skolem"><span class="skolem">cset''</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1'</span><span class="main">,</span> <span class="skolem">cset1'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="var">?σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> <span class="skolem">cset1'</span> <span class="main">∪</span> <span class="skolem">cset''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset''</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1'</span> <span class="skolem">n1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> σ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">=</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>1<span class="main">)</span> σ1'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def
                                                        JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sub1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset1'</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sub''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset''</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>12<span class="main">)</span> σ1'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset1</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_csmall<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">σ1</span></span><span class="main">,</span> <span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1-9<span class="main"><span class="main">)</span></span> _ _ sub1'<span class="main">]</span>
      Suc.prems<span class="main">(</span>11<span class="main">,</span>12<span class="main">)</span> σ1<span class="main">(</span>1<span class="main">)</span> σ1'<span class="main">(</span>1<span class="main">)</span> σ_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> sub1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc2<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∉</span> JVMendset"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_Suc_nend σ1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp1</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">frs1</span></span> <span class="skolem"><span class="skolem">sh1</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1_case <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">frs1</span><span class="main">,</span><span class="skolem">sh1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">σ1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk1</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">C1'</span></span> <span class="skolem"><span class="skolem">M1'</span></span> <span class="skolem"><span class="skolem">pc1</span></span> <span class="skolem"><span class="skolem">ics1</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">frs1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk1</span><span class="main">,</span><span class="skolem">loc1</span><span class="main">,</span><span class="skolem">C1'</span><span class="main">,</span><span class="skolem">M1'</span><span class="main">,</span><span class="skolem">pc1</span><span class="main">,</span><span class="skolem">ics1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">frs1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">frs1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">stk1</span><span class="main">,</span><span class="skolem">loc1</span><span class="main">,</span><span class="skolem">C1'</span><span class="main">,</span><span class="skolem">M1'</span><span class="main">,</span><span class="skolem">pc1</span><span class="main">,</span><span class="skolem">ics1</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs1'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> JVMendset_def nend1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">frs1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cbig1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset''</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>3<span class="main">)</span> σ1'<span class="main">(</span>3<span class="main">)</span> Suc.prems<span class="main">(</span>13<span class="main">)</span> σ_eq
      <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.cbig_def2
            JVMSmartCollectionSemantics.cbig_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ2'</span></span> <span class="skolem"><span class="skolem">cset2'</span></span> <span class="skolem"><span class="skolem">cset2''</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ2'</span><span class="main">,</span> <span class="skolem">cset2'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">cset''</span> <span class="main">=</span> <span class="skolem">cset2'</span> <span class="main">∪</span> <span class="skolem">cset2''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset2''</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ2'</span> <span class="skolem">n2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD σ1'<span class="main">(</span>3<span class="main">)</span> Suc2 σ_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="comment1">(*****)</span>
    <span class="keyword1"><span class="command">have</span></span> wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"instrs_of <span class="free">P</span> <span class="skolem">C1'</span> <span class="skolem">M1'</span> <span class="main">!</span> <span class="skolem">pc1</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ics1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span> <span class="keyword1">-jvm→</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">frs1</span><span class="main">,</span><span class="skolem">sh1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exec <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="var">?σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">σ1'</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JVMsmart_csmallD<span class="main">[</span><span class="operator">OF</span> σ1'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="var">?σ</span> <span class="keyword1">-jvm→</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jvm_one_step1<span class="main">[</span><span class="operator">OF</span> exec_1.exec_1I<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>12<span class="main">)</span> σ_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> correct1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">frs1</span><span class="main">,</span><span class="skolem">sh1</span><span class="main">)</span><span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> BV_correct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wtp step Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(**)</span>
    <span class="keyword1"><span class="command">have</span></span> vics1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">sh1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="skolem">C1'</span><span class="main">,</span> <span class="skolem">M1'</span><span class="main">,</span> <span class="skolem">pc1</span><span class="main">,</span> <span class="skolem">ics1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> correct1 Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf_f_def2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> correct1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">mxs</span></span> <span class="skolem"><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">ins</span></span> <span class="skolem"><span class="skolem">xt</span></span> <span class="skolem"><span class="skolem">ST</span></span> <span class="skolem"><span class="skolem">LT</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      meth1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1'</span> <span class="keyword1">sees</span> <span class="skolem">M1'</span><span class="main">,</span><span class="skolem">b</span><span class="main">:</span><span class="skolem">Ts</span><span class="main">→</span><span class="skolem">T</span><span class="main">=</span><span class="main">(</span><span class="skolem">mxs</span><span class="main">,</span><span class="skolem">mxl<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span><span class="main">)</span> <span class="keyword1">in</span> <span class="skolem">C1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      pc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc1</span> <span class="main">&lt;</span> length <span class="skolem">ins</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      Φ_pc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="skolem">C1'</span> <span class="skolem">M1'</span><span class="main">!</span><span class="skolem">pc1</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ST</span><span class="main">,</span><span class="skolem">LT</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sees_method_fun<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">mxs</span><span class="main">,</span>size <span class="skolem">ins</span><span class="main">,</span><span class="skolem">xt</span> <span class="main">⊢</span> <span class="skolem">ins</span><span class="main">!</span><span class="skolem">pc1</span><span class="main">,</span><span class="skolem">pc1</span> <span class="main">::</span> <span class="free">Φ</span> <span class="skolem">C1'</span> <span class="skolem">M1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wt_jvm_prog_impl_wt_instr<span class="main">[</span><span class="operator">OF</span> wtp meth1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="comment1">(**)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">C</span> <span class="bound">fs</span> <span class="bound">sfs'</span> <span class="bound">i'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">h1</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span><span class="main">⌋</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">sh1</span> <span class="bound">C</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs'</span><span class="main">,</span> <span class="bound">i'</span><span class="main">)</span><span class="main">⌋</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span><span class="main">)</span> <span class="main">∧</span>
      classes_above_frames <span class="free">P</span> <span class="skolem">frs1</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">C</span> <span class="skolem">fs</span> <span class="skolem">sfs'</span> <span class="skolem">i'</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h1</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">⌋</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="skolem">cset</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">sh1</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="skolem">sfs'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">⌋</span> <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="skolem">cset</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>classes_above_frames <span class="free">P</span> <span class="skolem">frs1</span> <span class="main">⊆</span> <span class="skolem">cset</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>11-12<span class="main">)</span> σ1' σ_eq<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> JVMsmart_csmallD<span class="main">[</span><span class="operator">OF</span> σ1'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        backward_coll_promises_kept<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xp<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xp</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> frs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">frs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> frs'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">frs1</span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xp'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xp1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">h1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sh'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sh1</span></span><span class="main">,</span> <span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1-9<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> heap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">h1</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sheap1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">sh1</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> frames1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="skolem">frs1</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> xcpts1<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">― ‹ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">init_class</span><span class="antiquote">}</span></span> promise ›</span>
    <span class="keyword1"><span class="command">have</span></span> sheap2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> coll_init_class <span class="free">P</span> <span class="var">?i1</span> <span class="main">=</span> Some <span class="bound">C</span>
      <span class="main">⟹</span> <span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C'</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
       <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> called<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> coll_init_class <span class="free">P</span> <span class="var">?i1</span> <span class="main">=</span> Some <span class="bound">C</span>
      <span class="main">⟹</span> ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> cic<span class="main">:</span> <span class="quoted"><span class="quoted">"coll_init_class <span class="free">P</span> <span class="var">?i1</span> <span class="main">=</span> Some <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                   ics<span class="main">:</span> <span class="quoted"><span class="quoted">"ics_of <span class="main">(</span>hd <span class="main">(</span>frames_of <span class="skolem">σ1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sobj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh1</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="skolem">sobj</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vics1 f1'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?i1</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sobj</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> init_class_prom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="skolem">ics1</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">ics1</span> <span class="main">=</span> No_ics
      <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="var">?i1</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ics1</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">ics1</span> <span class="main">=</span> No_ics"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cic<span class="main">:</span> <span class="quoted"><span class="quoted">"coll_init_class <span class="free">P</span> <span class="var">?i1</span> <span class="main">=</span> Some <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ics1</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="var">?ics1</span> <span class="main">=</span> No_ics"</span></span> <span class="keyword1"><span class="command">using</span></span> f1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cic
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ics1</span> <span class="main">=</span> Called <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cic called <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ics'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ics1</span> <span class="main">=</span> No_ics"</span></span> <span class="keyword1"><span class="command">using</span></span> ics <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cic
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?i1</span></span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>New <span class="skolem">C1</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Φ_pc1 wt1 meth1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">using</span></span> wtp is_class_is_subcls
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> New_collects<span class="main">[</span><span class="operator">OF</span> _ cbig1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nend1 _ ics' sheap2 sub''<span class="main">]</span>
           f1' ics cic New <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Getstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> mC1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span>Static<span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">D1</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> cic <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coll_init_class.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.inject option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_is_class'<span class="main">[</span><span class="operator">OF</span> mC1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">using</span></span> wtp is_class_is_subcls
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Getstatic_collects<span class="main">[</span><span class="operator">OF</span> _ cbig1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nend1 _ ics' _ sheap2 sub''<span class="main">]</span>
            eq f1' Getstatic ics cic <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Putstatic <span class="skolem">C1</span> <span class="skolem">F1</span> <span class="skolem">D1</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> mC1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">has</span> <span class="skolem">F1</span><span class="main">,</span>Static<span class="main">:</span><span class="skolem">t</span> <span class="keyword1">in</span> <span class="skolem">D1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">D1</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> cic <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coll_init_class.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.inject option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_field_is_class'<span class="main">[</span><span class="operator">OF</span> mC1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">using</span></span> wtp is_class_is_subcls
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Putstatic_collects<span class="main">[</span><span class="operator">OF</span> _ cbig1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nend1 _ ics' _ sheap2 sub''<span class="main">]</span>
            eq f1' Putstatic ics cic <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invokestatic <span class="skolem">C1</span> <span class="skolem">M1</span> <span class="skolem">n'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> mC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="keyword1">sees</span> <span class="skolem">M1</span><span class="main">,</span> Static <span class="main">:</span>  <span class="skolem">Ts</span><span class="main">→</span><span class="skolem">T</span> <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">in</span> <span class="skolem">C</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cic <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sees_method_is_class'<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">using</span></span> wtp is_class_is_subcls
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invokestatic_collects<span class="main">[</span><span class="operator">OF</span> _ cbig1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sub'' nend1 _ ics' mC sheap2<span class="main">]</span>
            Obj mC f1' Invokestatic ics cic <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">― ‹ Calling promise ›</span>
    <span class="keyword1"><span class="command">have</span></span> Calling_prom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="skolem">ics1</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C'</span> <span class="skolem">Cs'</span> <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ics1</span> <span class="main">=</span> Calling <span class="skolem">C'</span> <span class="skolem">Cs'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_class <span class="free">P</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vics1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> obj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Object"</span></span> <span class="keyword1"><span class="command">using</span></span> wtp is_class_is_subcls
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_phi_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> sheap3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">C1</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">C1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> sheap <span class="skolem">σ1</span> <span class="bound">C1</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="bound">sfs</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>
        <span class="main">⟶</span> classes_above <span class="free">P</span> <span class="bound">C1</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sheap1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"classes_above <span class="free">P</span> <span class="skolem">C'</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Calling_collects<span class="main">[</span><span class="operator">OF</span> obj cbig1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nend1 _ sheap3 sub''<span class="main">]</span> ics f1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> in_naive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span> <span class="skolem">h1</span><span class="main">,</span> <span class="skolem">frs1</span><span class="main">,</span> <span class="skolem">sh1</span><span class="main">)</span> <span class="skolem">n1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> in_smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset''</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="main">(</span><span class="skolem">xp1</span><span class="main">,</span> <span class="skolem">h1</span><span class="main">,</span> <span class="skolem">frs1</span><span class="main">,</span> <span class="skolem">sh1</span><span class="main">)</span> <span class="skolem">n1</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>3<span class="main">)</span> σ1'<span class="main">(</span>3<span class="main">)</span> σ_eq<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset'</span> <span class="main">⊆</span> <span class="skolem">cset</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Suc.hyps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wtp correct1 f1' heap1 sheap1 xcpts1 frames1 init_class_prom1
                         Calling_prom1 in_naive in_smart sub'' Suc.prems<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> σ1'<span class="main">(</span>2<span class="main">)</span> sub1 sub2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ ...which means over <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">cbig</span></span><span class="antiquote">}</span></span> ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_to_smart_cbig"><span class="command">lemma</span></span> jvm_naive_to_smart_cbig<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="comment1">― ‹ well-formedness ›</span>
      wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="free">Φ</span></sub><span class="hidden">⇙</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
<span class="comment1">― ‹ defs ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">frs</span> <span class="main">=</span> <span class="main">(</span><span class="free">stk</span><span class="main">,</span><span class="free">loc</span><span class="main">,</span><span class="free">C'</span><span class="main">,</span><span class="free">M'</span><span class="main">,</span><span class="free">pc</span><span class="main">,</span><span class="free">ics</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹ backward promises - will be collected/maintained prior ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="free">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="free">P</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="free">P</span> <span class="free">frs</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ forward promises - will be collected after if not already ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> init_class_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="free">ics</span> <span class="main">=</span> No_ics
    <span class="main">⟹</span> coll_init_class <span class="free">P</span> <span class="main">(</span>instrs_of <span class="free">P</span> <span class="free">C'</span> <span class="free">M'</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Calling_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="free">ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="free">P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="comment1">― ‹ collections ›</span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⊆</span> <span class="free">cset</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xp</span><span class="main">,</span><span class="free">h</span><span class="main">,</span><span class="free">frs</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.cbig_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="var">?σ</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.cbig_def2 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="var">?σ</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_csmall_nstep_last_eq<span class="main">[</span><span class="operator">OF</span> n n'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="var">?σ</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_csmall_nstep<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-9<span class="main"><span class="main">)</span></span> n'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sn assms<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span> nend<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹...thus naive <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"⊆"</span><span class="antiquote">}</span></span> smart over the out function, since all conditions will be met - and promises
 kept - by the defined starting point ›</span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_to_smart_collection"><span class="command">lemma</span></span> jvm_naive_to_smart_collection<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> naive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>                      
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"jvm_make_test_prog <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"instrs_of <span class="var">?P</span> Start start_m <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ics</span></span></span> <span class="main">=</span> <span class="quoted">No_ics</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> start_heap <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> Start<span class="main">,</span> start_m<span class="main">,</span> <span class="main">0</span><span class="main">,</span> No_ics<span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">=</span> start_sheap"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword1"><span class="command">have</span></span> nS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_class <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">P</span><span class="main">)</span> Start"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_class_def class_def Start_def Test_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> nT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_class <span class="free">P</span> Test"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> tPm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">#</span> <span class="free">P</span> <span class="main">⊢</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> <span class="keyword1">sees</span> main<span class="main">,</span> Static <span class="main">:</span>  <span class="main">[]</span><span class="main">→</span>Void <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">in</span> <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nclinit<span class="main">:</span> <span class="quoted"><span class="quoted">"main <span class="main">≠</span> clinit"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> main_def clinit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Objp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b'</span> <span class="bound">Ts'</span> <span class="bound">T'</span> <span class="bound">m'</span> <span class="bound">D'</span><span class="main">.</span>
      <span class="free">t</span><span class="main">#</span><span class="free">P</span> <span class="main">⊢</span> Object <span class="keyword1">sees</span> start_m<span class="main">,</span> <span class="bound">b'</span> <span class="main">:</span>  <span class="bound">Ts'</span><span class="main">→</span><span class="bound">T'</span> <span class="main">=</span> <span class="bound">m'</span> <span class="keyword1">in</span> <span class="bound">D'</span> <span class="main">⟹</span> <span class="bound">b'</span> <span class="main">=</span> Static <span class="main">∧</span> <span class="bound">Ts'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">T'</span> <span class="main">=</span> Void"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span> <span class="skolem">Ts'</span> <span class="skolem">T'</span> <span class="skolem">m'</span> <span class="skolem">D'</span>
    <span class="keyword3"><span class="command">assume</span></span> mObj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="free">P</span> <span class="main">⊢</span> Object <span class="keyword1">sees</span> start_m<span class="main">,</span> <span class="skolem">b'</span> <span class="main">:</span>  <span class="skolem">Ts'</span><span class="main">→</span><span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="keyword1">in</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> ot_nsub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">⊢</span> Object <span class="main">≼<span class="hidden">⇧</span><sup>*</sup></span> Test"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def wf_jvm_prog_phi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> class_add_sees_method_rev<span class="main">[</span><span class="operator">OF</span> _ ot_nsub<span class="main">]</span> mObj t
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊢</span> Object <span class="keyword1">sees</span> start_m<span class="main">,</span> <span class="skolem">b'</span> <span class="main">:</span>  <span class="skolem">Ts'</span><span class="main">→</span><span class="skolem">T'</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="keyword1">in</span> <span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> P jvm_progs_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> Static <span class="main">∧</span> <span class="skolem">Ts'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">T'</span> <span class="main">=</span> Void"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> P t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> wtp0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="skolem">Φ</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_jvm_prog_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Φ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span> <span class="bound">f</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">C</span> <span class="main">=</span> Start <span class="main">∧</span> <span class="main">(</span><span class="bound">f</span> <span class="main">=</span> start_m <span class="main">∨</span> <span class="bound">f</span> <span class="main">=</span> clinit<span class="main">)</span> <span class="keyword1">then</span> start_φ<span class="hidden">⇩</span><sub>m</sub> <span class="keyword1">else</span> <span class="skolem">Φ</span> <span class="bound">C</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wtp0 <span class="keyword1"><span class="command">have</span></span> wtp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_jvm_prog<span class="hidden">⇘</span><sub><span class="var">?Φ'</span></sub><span class="hidden">⇙</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> wtp0 nS tPm nclinit
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">≠</span> Start <span class="main">⟹</span> <span class="var">?Φ'</span> <span class="bound">C</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Φ'</span> Start start_m <span class="main">=</span> start_φ<span class="hidden">⇩</span><sub>m</sub>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?Φ'</span> Start clinit <span class="main">=</span> start_φ<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> Objp
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> start_prog_wf_jvm_prog_phi<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> cic<span class="main">:</span> <span class="quoted"><span class="quoted">"coll_init_class <span class="var">?P</span> <span class="var">?i</span> <span class="main">=</span> Some Test"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> wtp0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wf_md</span></span> <span class="keyword2"><span class="keyword">where</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_prog <span class="skolem">wf_md</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wt_jvm_progD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> start_prog_start_m_instrs t <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> Invokestatic Test main <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> jvm_make_test_prog_sees_Test_main<span class="main">[</span><span class="operator">OF</span> P t<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⊢</span> Test <span class="keyword1">sees</span> main<span class="main">,</span> Static <span class="main">:</span>  <span class="main">[]</span><span class="main">→</span>Void <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">in</span> Test"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seeing_class <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> Test main <span class="main">=</span> <span class="main">⌊</span>Test<span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seeing_class_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">― ‹ well-formedness ›</span>
  <span class="keyword1"><span class="command">note</span></span> wtp
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span><span class="main">,</span><span class="var">?Φ'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span><span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> wtp0 nS tPm nclinit
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Φ'</span> Start start_m <span class="main">=</span> start_φ<span class="hidden">⇩</span><sub>m</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span><span class="main">,</span><span class="var">?Φ'</span> <span class="main">⊢</span> <span class="var">?σ</span><span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> BV_correct_initial<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">― ‹ defs ›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">frs</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> Start<span class="main">,</span> start_m<span class="main">,</span> <span class="main">0</span><span class="main">,</span> No_ics<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">― ‹ backward promises ›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_start_heap<span class="main">[</span><span class="operator">OF</span> smart _ P t<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> heap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">a</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="var">?P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_start_sheap<span class="main">[</span><span class="operator">OF</span> smart<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sheap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">sfs</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">sh</span> <span class="bound">C</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">sfs</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> classes_above <span class="var">?P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_xcpts<span class="main">[</span><span class="operator">OF</span> smart P t<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> xcpts<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_xcpts <span class="var">?P</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_frames<span class="main">[</span><span class="operator">OF</span> smart<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> frames<span class="main">:</span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="var">?P</span> <span class="skolem">frs</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">― ‹ forward promises - will be collected after if not already ›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> jvm_smart_out_classes_above_Test<span class="main">[</span><span class="operator">OF</span> smart P t<span class="main">]</span> cic
  <span class="keyword1"><span class="command">have</span></span> init_class_prom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="var">?ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="var">?ics</span> <span class="main">=</span> No_ics
    <span class="main">⟹</span> coll_init_class <span class="var">?P</span> <span class="var">?i</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> classes_above <span class="var">?P</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span> <span class="bound">Cs'</span><span class="main">.</span> <span class="var">?ics</span> <span class="main">=</span> Calling <span class="bound">C'</span> <span class="bound">Cs'</span> <span class="main">⟹</span> classes_above <span class="var">?P</span> <span class="bound">C'</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">― ‹ collections ›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> naive
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="var">?P</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> smart <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="var">?P</span> <span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> jvm_naive_to_smart_cbig<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(******************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Proving smart <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⊆"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> naive ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"We prove that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">jvm_naive</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> collects everything <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">jvm_smart</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 does. Combined with the other direction, this shows that the naive and smart
 algorithms collect the same set of classes."</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_to_naive_exec_collect"><span class="command">lemma</span></span> jvm_smart_to_naive_exec_collect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"JVMexec_scollect <span class="free">P</span> <span class="free">σ</span> <span class="main">⊆</span> JVMexec_ncollect <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xp</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">frs</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="main">(</span><span class="skolem">xp</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">frs</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xp</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">frs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">stk</span></span> <span class="skolem"><span class="skolem">loc</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="skolem"><span class="skolem">ics</span></span> <span class="skolem"><span class="skolem">frs'</span></span>
     <span class="keyword2"><span class="keyword">where</span></span> none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> frs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">frs</span><span class="main">=</span><span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span><span class="main">#</span><span class="skolem">frs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xp</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">frs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> instr_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">ics</span> <span class="main">=</span> No_ics <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> ics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ics</span> <span class="main">=</span> Called <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">ics</span> <span class="main">=</span> No_ics"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ none frs
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"curr_instr <span class="free">P</span> <span class="main">(</span><span class="skolem">stk</span><span class="main">,</span><span class="skolem">loc</span><span class="main">,</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">ics</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ none frs
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Called <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> instr_case σ none frs <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_to_naive_csmall"><span class="command">lemma</span></span> jvm_smart_to_naive_csmall<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> jvm_smart_to_naive_exec_collect assms
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def
                 JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_to_naive_csmall_nstep"><span class="command">lemma</span></span> jvm_smart_to_naive_csmall_nstep<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span><span class="main">;</span>
   <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="quoted"><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">cset1</span></span> <span class="skolem"><span class="skolem">cset'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1</span><span class="main">,</span> <span class="skolem">cset1</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="skolem">cset1</span> <span class="main">∪</span> <span class="skolem">cset'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset'</span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.csmall_nstep_SucD <span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">cset1'</span></span> <span class="skolem"><span class="skolem">cset''</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ1'</span><span class="main">,</span> <span class="skolem">cset1'</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall <span class="free">P</span> <span class="skolem">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> <span class="skolem">cset1'</span> <span class="main">∪</span> <span class="skolem">cset''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset''</span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="skolem">σ1'</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.csmall_nstep_SucD <span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> σ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">=</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>1<span class="main">)</span> σ1'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_def
                                                        JVMSmartCollectionSemantics.csmall_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset1'</span> <span class="main">⊆</span> <span class="skolem">cset1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>1<span class="main">)</span> σ1'<span class="main">(</span>1<span class="main">)</span> jvm_smart_to_naive_csmall <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset''</span> <span class="main">⊆</span> <span class="skolem">cset'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>3<span class="main">)</span> σ1'<span class="main">(</span>3<span class="main">)</span> σ_eq Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ1<span class="main">(</span>2<span class="main">)</span> σ1'<span class="main">(</span>2<span class="main">)</span> sub1 sub2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_to_naive_cbig"><span class="command">lemma</span></span> jvm_smart_to_naive_cbig<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.cbig <span class="free">P</span> <span class="free">σ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMNaiveCollectionSemantics.cbig_def2 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> JVMSmartCollectionSemantics.csmall_nstep <span class="free">P</span> <span class="free">σ</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> JVMendset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> JVMSmartCollectionSemantics.cbig_def2 s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_csmall_nstep_last_eq<span class="main">[</span><span class="operator">OF</span> n n'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> jvm_smart_to_naive_csmall_nstep n'<span class="main">(</span>1<span class="main">)</span> s'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="JVMCollectionBasedRTS-jvm_smart_to_naive_collection"><span class="command">lemma</span></span> jvm_smart_to_naive_collection<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> naive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nend<span class="main">:</span> <span class="quoted"><span class="quoted">"start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span> <span class="main">∉</span> JVMendset"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMendset_def start_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> naive <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    nstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> JVMNaiveCollectionSemantics.csmall_nstep
                                     <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.cbigD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nend naive <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.cbig_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> start_prog_classes_above_Start
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"classes_above_frames <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>frames_of <span class="main">(</span>start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Object<span class="main">,</span>Start<span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nstep n'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jvm_smart_collect_start <span class="main">(</span>jvm_make_test_prog <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> start_state_def JVMNaiveCollectionSemantics.csmall_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_nstep_SucD
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> JVMNaiveCollectionSemantics.csmall_nstep_Rec<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> jvm_smart_to_naive_cbig<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"jvm_make_test_prog <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"start_state <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> σ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ'</span></span><span class="main">]</span>
       jvm_smart_collect_start_make_test_prog assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(**************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Safety of the smart algorithm"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Having proved containment in both directions, we get naive = smart:"</span></span>
<span class="keyword1" id="JVMCollectionBasedRTS-jvm_naive_eq_smart_collection"><span class="command">lemma</span></span> jvm_naive_eq_smart_collection<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> naive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="free">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> jvm_naive_to_smart_collection<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> jvm_smart_to_naive_collection<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Thus, since the RTS algorithm based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ncollect</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is existence safe,
 the algorithm based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">scollect</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is as well."</span></span>
<span class="keyword1"><span class="command">theorem</span></span> jvm_smart_existence_safe<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">∈</span> jvm_progs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> jvm_tests"</span></span>
 <span class="keyword2"><span class="keyword">and</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">∈</span> jvm_smart_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dss<span class="main">:</span> <span class="quoted"><span class="quoted">"jvm_deselect <span class="free">P</span> <span class="free">o1</span> <span class="free">P'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">o2</span> <span class="main">∈</span> jvm_smart_out <span class="free">P'</span> <span class="free">t</span><span class="main">.</span> <span class="free">o1</span> <span class="main">=</span> <span class="bound">o2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> o1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">o1</span><span class="main">=</span><span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">o1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> jvm_naive_iff_smart out <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> jvm_naive_eq_smart_collection<span class="main">[</span><span class="operator">OF</span> n _ P t<span class="main">]</span> out <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> jvm_naive_existence_safe<span class="main">[</span><span class="operator">OF</span> P P' t n<span class="main">]</span> dss <span class="keyword1"><span class="command">have</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">cset<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">∈</span> jvm_naive_out <span class="free">P'</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> jvm_naive_iff_smart <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span><span class="main">)</span> <span class="main">∈</span> jvm_smart_out <span class="free">P'</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> jvm_naive_eq_smart_collection<span class="main">[</span><span class="operator">OF</span> n' s' P' t<span class="main">]</span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> <span class="skolem">cset<span class="hidden">⇩</span><sub>s</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"...thus <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">JVMSmartCollection</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an instance of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">CollectionBasedRTS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:"</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> JVMSmartCollectionRTS <span class="main">:</span>
  CollectionBasedRTS <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted">jvm_deselect</span> <span class="quoted">jvm_progs</span> <span class="quoted">jvm_tests</span>
     <span class="quoted">JVMendset</span> <span class="quoted">JVMcombine</span> <span class="quoted">JVMcollect_id</span> <span class="quoted">JVMsmall</span> <span class="quoted">JVMSmartCollect</span> <span class="quoted">jvm_smart_out</span>
     <span class="quoted">jvm_make_test_prog</span> <span class="quoted">jvm_smart_collect_start</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> jvm_smart_existence_safe<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> start_state_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="RTS">
<div class="head">
<h1>Theory RTS</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> RTS
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#JVMCollectionBasedRTS">JVM_RTS/JVMCollectionBasedRTS</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>